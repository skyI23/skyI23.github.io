<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2022/09/28/windows å†…æ ¸å›è°ƒ/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            windows å†…æ ¸å›è°ƒ | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["ä¹¦æœ‰æœªæ›¾ç»æˆ‘è¯»ï¼Œäº‹æ— ä¸å¯å¯¹äººè¨€"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.2","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"åˆ†ç±»":{"icon":"fa-solid fa-folder","path":"/categories/"},"æ ‡ç­¾":{"icon":"fa-solid fa-tags","path":"/tags/"},"ä¹¦ç­¾":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    åˆ†ç±»
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    æ ‡ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    ä¹¦ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                åˆ†ç±»
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                æ ‡ç­¾
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                ä¹¦ç­¾
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">11</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">40</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">windows å†…æ ¸å›è°ƒ</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-09-28 11:45:14</span>
        <span class="mobile">2022-09-28 11:45:14</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-07-07 01:17:38</span>
            <span class="mobile">2025-07-07 01:17:38</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/reverse/">reverse</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/reverse/windows-kernel/">windows kernel</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/windows-kernel-reverse/">windows kernel reverse</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>12.4k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>50 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p><a class="link"   target="_blank" rel="noopener" href="https://www.vergiliusproject.com/" >https://www.vergiliusproject.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<h1 id="ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒï¼ˆNotify-Callbacksï¼‰"><a href="#ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒï¼ˆNotify-Callbacksï¼‰" class="headerlink" title="ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒï¼ˆNotify Callbacksï¼‰"></a>ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒï¼ˆNotify Callbacksï¼‰</h1><p><strong>ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒ</strong>æ˜¯ Windows å†…æ ¸æä¾›çš„ä¸€ç±»æœºåˆ¶ï¼Œå…è®¸å†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œä»¥ä¾¿åœ¨<strong>ç³»ç»Ÿå…³é”®äº‹ä»¶</strong>ï¼ˆå¦‚è¿›ç¨‹&#x2F;çº¿ç¨‹åˆ›å»ºã€æ¨¡å—åŠ è½½ã€å¥æŸ„æ“ä½œã€æ³¨å†Œè¡¨ä¿®æ”¹ç­‰ï¼‰å‘ç”Ÿæ—¶æ”¶åˆ°é€šçŸ¥ã€‚</p>
<p>å¸¸è§çš„<strong>ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒ</strong>æœ‰ä¸‹é¢å‡ ç§ç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>æ³¨å†Œå‡½æ•°</th>
<th>å›è°ƒå‡½æ•°ç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td>è¿›ç¨‹åˆ›å»º&#x2F;é€€å‡º</td>
<td><code>PsSetCreateProcessNotifyRoutine(Ex)</code></td>
<td><code>PCREATE_PROCESS_NOTIFY_ROUTINE(_EX)</code></td>
</tr>
<tr>
<td>çº¿ç¨‹åˆ›å»º&#x2F;é€€å‡º</td>
<td><code>PsSetCreateThreadNotifyRoutine(Ex)</code></td>
<td><code>PCREATE_THREAD_NOTIFY_ROUTINE</code></td>
</tr>
<tr>
<td>æ¨¡å—åŠ è½½ï¼ˆDLLã€EXEã€SYSï¼‰</td>
<td><code>PsSetLoadImageNotifyRoutine(Ex)</code></td>
<td><code>PLOAD_IMAGE_NOTIFY_ROUTINE</code></td>
</tr>
<tr>
<td>æ³¨å†Œè¡¨ä¿®æ”¹</td>
<td><code>CmRegisterCallbackEx</code></td>
<td><code>PEX_CALLBACK_FUNCTION</code></td>
</tr>
<tr>
<td>å¯¹è±¡å¥æŸ„æ“ä½œ</td>
<td><code>ObRegisterCallbacks</code></td>
<td><code>POB_PRE_OPERATION_CALLBACK</code></td>
</tr>
<tr>
<td>æ–‡ä»¶ç³»ç»Ÿæ“ä½œ</td>
<td><code>FltRegisterFilter</code> + <code>FltStartFiltering</code></td>
<td><code>FLT_PREOP_CALLBACK_ROUTINE</code> ç­‰</td>
</tr>
<tr>
<td>æ³¨å†Œè¡¨é…ç½®å•å…ƒåŠ è½½ï¼ˆHiveï¼‰</td>
<td><code>CmRegisterCallbackEx</code></td>
<td><code>PEX_CALLBACK_FUNCTION</code></td>
</tr>
</tbody></table>
<h2 id="è¿›ç¨‹å›è°ƒ"><a href="#è¿›ç¨‹å›è°ƒ" class="headerlink" title="è¿›ç¨‹å›è°ƒ"></a>è¿›ç¨‹å›è°ƒ</h2><p>è¿›ç¨‹å›è°ƒæ˜¯ Windows å†…æ ¸ä¸ºé©±åŠ¨æä¾›çš„é‡è¦æœºåˆ¶ä¹‹ä¸€ï¼Œå®ƒå…è®¸é©±åŠ¨<strong>åœ¨è¿›ç¨‹åˆ›å»ºå’Œé€€å‡ºæ—¶æ”¶åˆ°ç³»ç»Ÿé€šçŸ¥</strong>ï¼Œä»¥å®ç°è¡Œä¸ºç›‘æ§ã€æ—¥å¿—è®°å½•ã€å®‰å…¨æ£€æµ‹å’Œæ§åˆ¶ç­‰åŠŸèƒ½ã€‚</p>
<p>Windows æä¾›ä¸¤ç§è¿›ç¨‹å›è°ƒæœºåˆ¶ï¼š</p>
<ul>
<li><code>PCREATE_PROCESS_NOTIFY_ROUTINE</code>ï¼ˆåŸºç¡€ç‰ˆï¼‰</li>
<li><code>PCREATE_PROCESS_NOTIFY_ROUTINE_EX</code>ï¼ˆæ‰©å±•ç‰ˆï¼Œæ¨èï¼‰</li>
</ul>
<h3 id="åŸºç¡€å›è°ƒæ³¨å†Œ"><a href="#åŸºç¡€å›è°ƒæ³¨å†Œ" class="headerlink" title="åŸºç¡€å›è°ƒæ³¨å†Œ"></a>åŸºç¡€å›è°ƒæ³¨å†Œ</h3><p><code>PCREATE_PROCESS_NOTIFY_ROUTINE</code> æ˜¯ Windows æ—©æœŸç‰ˆæœ¬æä¾›çš„è¿›ç¨‹å›è°ƒå‡½æ•°ç±»å‹ï¼ŒåŠŸèƒ½ç›¸å¯¹æœ‰é™ï¼Œä»…æä¾›è¿›ç¨‹çš„ PIDã€çˆ¶è¿›ç¨‹ ID å’Œåˆ›å»º&#x2F;é”€æ¯äº‹ä»¶æ ‡å¿—ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span> <span class="params">(*PCREATE_PROCESS_NOTIFY_ROUTINE)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE ParentId,   <span class="comment">// çˆ¶è¿›ç¨‹ PID</span></span></span><br><span class="line"><span class="params">    _In_ HANDLE ProcessId,  <span class="comment">// å½“å‰è¿›ç¨‹ PID</span></span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Create     <span class="comment">// TRUE è¡¨ç¤ºåˆ›å»ºè¿›ç¨‹ï¼ŒFALSE è¡¨ç¤ºé€€å‡ºè¿›ç¨‹</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p><code>PCREATE_PROCESS_NOTIFY_ROUTINE</code> ç±»å‹çš„å›è°ƒéœ€è¦é€šè¿‡ <code>PsSetCreateProcessNotifyRoutine</code> å‡½æ•°<strong>æ³¨å†Œ</strong>å’Œ<strong>ç§»é™¤</strong>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateProcessNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_PROCESS_NOTIFY_ROUTINE NotifyRoutine,  <span class="comment">// å›è°ƒå‡½æ•°ï¼Œå½“è¿›ç¨‹åˆ›å»ºæˆ–é”€æ¯æ—¶ä¼šè¢«è°ƒç”¨</span></span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove                                    <span class="comment">// å¸ƒå°”å€¼ï¼ŒTRUE è¡¨ç¤ºç§»é™¤å›è°ƒå‡½æ•°ï¼ŒFALSE è¡¨ç¤ºæ³¨å†Œå›è°ƒ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">BasicProcessNotify</span><span class="params">(HANDLE ParentId, HANDLE ProcessId, BOOLEAN Create)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Create) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;åˆ›å»ºè¿›ç¨‹ï¼šPID=%pï¼Œçˆ¶PID=%p\n&quot;</span>, ProcessId, ParentId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;é€€å‡ºè¿›ç¨‹ï¼šPID=%p\n&quot;</span>, ProcessId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PsSetCreateProcessNotifyRoutine(BasicProcessNotify, FALSE);  <span class="comment">// æ³¨å†Œ</span></span><br><span class="line">PsSetCreateProcessNotifyRoutine(BasicProcessNotify, TRUE);   <span class="comment">// å¸è½½æ—¶ç§»é™¤</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content">
      <p>å¦‚æœæˆ‘ä»¬æ³¨å†Œäº†å›è°ƒå‡½æ•°ï¼Œä½†æ˜¯åœ¨é©±åŠ¨å¸è½½çš„æ—¶å€™æ²¡æœ‰ç§»é™¤å›è°ƒå‡½æ•°ï¼Œåˆ™ç”±äºå®ç°å›è°ƒå‡½æ•°çš„é©±åŠ¨è¢«å¸è½½äº†ï¼Œå› æ­¤ä¼šå¯¼è‡´å†…æ ¸è®¿é—®æ— æ•ˆå†…å­˜åœ°å€ï¼ˆ<code>PAGE_FAULT_IN_NONPAGED_AREA</code>ï¼‰ï¼Œå¼•å‘è“å±å´©æºƒã€‚</p>
<p>å› æ­¤æˆ‘ä»¬é€šå¸¸åœ¨é©±åŠ¨å¸è½½å‡½æ•°ä¸­ç§»é™¤å›è°ƒå‡½æ•°ã€‚è€Œ <code>PsSetCreateProcessNotifyRoutine</code> æœ¬èº«æ”¯æŒæ³¨å†Œä¸ç§»é™¤ï¼ˆé€šè¿‡ <code>Remove=TRUE</code>ï¼‰ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é©±åŠ¨å¸è½½å‡½æ•° DriverUnload</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span> &#123;</span><br><span class="line">    <span class="comment">// å…³é”®ï¼šç§»é™¤å›è°ƒï¼ˆç¬¬äºŒä¸ªå‚æ•°TRUEè¡¨ç¤ºç§»é™¤ï¼‰</span></span><br><span class="line">    NTSTATUS status = PsSetCreateProcessNotifyRoutineEx(MyProcessCallback, TRUE);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        KdPrint((<span class="string">&quot;ç§»é™¤å›è°ƒå¤±è´¥: 0x%X\n&quot;</span>, status));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="æ‰©å±•å›è°ƒæ³¨å†Œ"><a href="#æ‰©å±•å›è°ƒæ³¨å†Œ" class="headerlink" title="æ‰©å±•å›è°ƒæ³¨å†Œ"></a>æ‰©å±•å›è°ƒæ³¨å†Œ</h3><p><code>PCREATE_PROCESS_NOTIFY_ROUTINE_EX</code> æ˜¯å¯¹åŸºç¡€å›è°ƒçš„æ‰©å±•ï¼Œæä¾›æ›´ä¸°å¯Œçš„è¿›ç¨‹åˆ›å»ºä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ <code>EPROCESS</code> æŒ‡é’ˆã€æ˜ åƒè·¯å¾„ã€å‘½ä»¤è¡Œã€æ˜ åƒå¯¹è±¡ç­‰ã€‚è¯¥å›è°ƒå‡½æ•°ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span> <span class="params">(*PCREATE_PROCESS_NOTIFY_ROUTINE_EX)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Inout_ PEPROCESS Process,             <span class="comment">// è¿›ç¨‹å¯¹è±¡çš„æŒ‡é’ˆï¼ŒåŒ…å«è¯¦ç»†çš„è¿›ç¨‹ä¿¡æ¯</span></span></span><br><span class="line"><span class="params">    _In_ HANDLE ProcessId,                 <span class="comment">// ç›®æ ‡è¿›ç¨‹çš„ ID</span></span></span><br><span class="line"><span class="params">    _Inout_opt_ PPS_CREATE_NOTIFY_INFO CreateInfo <span class="comment">// é¢å¤–çš„åˆ›å»ºé€šçŸ¥ä¿¡æ¯ï¼ˆå¦‚å‘½ä»¤è¡Œç­‰ï¼‰</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p><code>PCREATE_PROCESS_NOTIFY_ROUTINE_EX</code> å‡½æ•°æ²¡æœ‰ä¸“é—¨çš„å‚æ•°æ¥è¡¨ç¤ºè¿›ç¨‹æ˜¯è¢«åˆ›å»ºï¼Œä½†æ˜¯ <code>CreateInfo</code> å‚æ•°åªæœ‰è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™æ‰éç©ºï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CreateInfo</code> æ˜¯å¦ä¸º <code>NULL</code> æ¥ç¡®å®šè¿›ç¨‹æ˜¯é”€æ¯è¿˜æ˜¯åˆ›å»ºã€‚</p>
<ul>
<li>å½“è¿›ç¨‹<strong>æ­£åœ¨åˆ›å»º</strong>æ—¶ï¼Œ<code>CreateInfo != NULL</code>ï¼›</li>
<li>å½“è¿›ç¨‹<strong>æ­£åœ¨é€€å‡º</strong>æ—¶ï¼Œ<code>CreateInfo == NULL</code>ã€‚</li>
</ul>

    </div>
  </div>

<p><code>PCREATE_PROCESS_NOTIFY_ROUTINE_EX</code> ä¸ä»…æä¾›äº†è¿›ç¨‹ IDï¼Œè¿˜æä¾›äº†è¿›ç¨‹çš„ <code>EPROCESS</code> ç»“æ„ä»¥åŠå­˜æ”¾é¢å¤–çš„ä¿¡æ¯çš„ç»“æ„ä½“ <code>PPS_CREATE_NOTIFY_INFO</code>ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PS_CREATE_NOTIFY_INFO</span> &#123;</span></span><br><span class="line">    _In_ SIZE_T Size;                                     <span class="comment">// 0x00: ç»“æ„ä½“å¤§å°ï¼Œå¿…é¡»åˆå§‹åŒ–ä¸º sizeof(PS_CREATE_NOTIFY_INFO)</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        _In_ ULONG Flags;                                 <span class="comment">// 0x04: è¿›ç¨‹åˆ›å»ºç‰¹æ€§æ ‡å¿—ä½é›†åˆ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            _In_ ULONG FileOpenNameAvailable : <span class="number">1</span>;         <span class="comment">// bit0: å½“è®¾ç½®ä¸º1æ—¶è¡¨ç¤ºImageFileNameå­—æ®µåŒ…å«æœ‰æ•ˆçš„æ˜ åƒæ–‡ä»¶å</span></span><br><span class="line">            _In_ ULONG IsSubsystemProcess : <span class="number">1</span>;            <span class="comment">// bit1: å½“è®¾ç½®ä¸º1æ—¶è¡¨ç¤ºè¯¥è¿›ç¨‹æ˜¯å­ç³»ç»Ÿè¿›ç¨‹ï¼ˆå¦‚Win32å­ç³»ç»Ÿè¿›ç¨‹ï¼‰</span></span><br><span class="line">            _In_ ULONG Reserved : <span class="number">30</span>;                     <span class="comment">// bit2-31: ä¿ç•™ä½ï¼Œå¿…é¡»è®¾ç½®ä¸º0ï¼Œä¾›ç³»ç»Ÿå°†æ¥ä½¿ç”¨</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    _In_ HANDLE ParentProcessId;                          <span class="comment">// 0x08: çˆ¶è¿›ç¨‹çš„è¿›ç¨‹IDï¼ˆPIDï¼‰ï¼Œæ ‡è¯†åˆ›å»ºæ­¤è¿›ç¨‹çš„çˆ¶è¿›ç¨‹</span></span><br><span class="line">    _In_ CLIENT_ID CreatingThreadId;                      <span class="comment">// 0x0C: åˆ›å»ºæ­¤è¿›ç¨‹çš„çº¿ç¨‹IDï¼ˆåŒ…å«è¿›ç¨‹IDå’Œçº¿ç¨‹IDçš„ç»“æ„ä½“ï¼‰</span></span><br><span class="line">    _Inout_ <span class="class"><span class="keyword">struct</span> _<span class="title">FILE_OBJECT</span> *<span class="title">FileObject</span>;</span>              <span class="comment">// 0x14: æŒ‡å‘è¿›ç¨‹æ˜ åƒæ–‡ä»¶å¯¹è±¡çš„æŒ‡é’ˆï¼Œå¯ç”¨äºæ–‡ä»¶é‡å®šå‘</span></span><br><span class="line">    _In_ PCUNICODE_STRING ImageFileName;                  <span class="comment">// 0x18: æŒ‡å‘è¿›ç¨‹æ˜ åƒæ–‡ä»¶å®Œæ•´è·¯å¾„çš„æŒ‡é’ˆï¼ˆNTè·¯å¾„æ ¼å¼ï¼‰</span></span><br><span class="line">    _In_opt_ PCUNICODE_STRING CommandLine;                <span class="comment">// 0x1C: æŒ‡å‘è¿›ç¨‹å‘½ä»¤è¡Œå‚æ•°çš„æŒ‡é’ˆï¼ˆå¯é€‰å­—æ®µï¼Œåœ¨è¾ƒæ–°ç‰ˆæœ¬çš„ Windows 10/11 ä¸Šæ‰å­˜åœ¨ï¼Œä½ç‰ˆæœ¬ç³»ç»Ÿæˆ–æŸäº›å­ç³»ç»Ÿè¿›ç¨‹ï¼ˆå¦‚ csrss.exeï¼‰ä¸­ä¼šä¸º NULLï¼‰</span></span><br><span class="line">    _Inout_ NTSTATUS CreationStatus;                      <span class="comment">// 0x20: è¿›ç¨‹åˆ›å»ºçŠ¶æ€ç ï¼Œé©±åŠ¨ç¨‹åºå¯ä¿®æ”¹æ­¤å€¼æ¥é˜»æ­¢è¿›ç¨‹åˆ›å»º</span></span><br><span class="line">&#125; PS_CREATE_NOTIFY_INFO, *PPS_CREATE_NOTIFY_INFO;</span><br></pre></td></tr></table></figure></div>

<p><code>PCREATE_PROCESS_NOTIFY_ROUTINE_EX</code> å›è°ƒå‡½æ•°æ˜¯é€šè¿‡ <code>PsSetCreateProcessNotifyRoutineEx</code> å‡½æ•°æ³¨å†Œæˆ–åˆ é™¤çš„ï¼Œæ³¨æ„ä¸è¦ä¸ <code>PsSetCreateProcessNotifyRoutine</code> æ··ç”¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI </span><br><span class="line">NTSTATUS </span><br><span class="line"><span class="title function_">PsSetCreateProcessNotifyRoutineEx</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_PROCESS_NOTIFY_ROUTINE_EX NotifyRoutine,  <span class="comment">// æ‰©å±•å›è°ƒå‡½æ•°ï¼Œæä¾›æ›´å¤šçš„è¿›ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove                                        <span class="comment">// å¸ƒå°”å€¼ï¼ŒTRUE è¡¨ç¤ºç§»é™¤å›è°ƒï¼ŒFALSE è¡¨ç¤ºæ³¨å†Œå›è°ƒ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p><code>PsSetCreateProcessNotifyRoutineEx</code> å¯èƒ½å› æœªç­¾åé©±åŠ¨è¢«æ‹’ç»æ³¨å†Œå›è°ƒï¼Œè¿”å›é”™è¯¯ç ï¼š<code>STATUS_ACCESS_DENIED (0xC0000022)</code>ã€‚</p>
<p>é€šè¿‡åˆ†æå‘ç°æ˜¯ <code>MmVerifyCallbackFunction</code> å‡½æ•°æœªé€šè¿‡å›è°ƒå‡½æ•°çš„æ ¡éªŒè¿”å› <code>FALSE</code> å¯¼è‡´çš„ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateProcessNotifyRoutineEx</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_PROCESS_NOTIFY_ROUTINE_EX NotifyRoutine,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> PspSetCreateProcessNotifyRoutine(NotifyRoutine, Remove, TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PspSetCreateProcessNotifyRoutine</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PVOID NotifyRoutine,</span></span><br><span class="line"><span class="params">    BOOLEAN Remove,</span></span><br><span class="line"><span class="params">    BOOLEAN IsExtended</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">if</span> (IsExtended &amp;&amp; !MmVerifyCallbackFunction(NotifyRoutine)) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_ACCESS_DENIED;  <span class="comment">// ğŸ‘ˆ è¿”å› 0xC0000022 é”™è¯¯ç </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>MmVerifyCallbackFunction</code> å‡½æ•°ä¼šè°ƒç”¨ <code>MiLookupDataTableEntry</code> è·å–å›è°ƒå‡½æ•° <code>NotifyRoutine</code> å¯¹åº”çš„ <code>PKLDR_DATA_TABLE_ENTRY</code> ç»“æ„ï¼Œç„¶åæ ¹æ®å…¶ä¸­çš„ <code>Flags</code> å­—æ®µæ˜¯å¦è®¾ç½®äº† 0x20 æ ‡å¿—ä½ç¡®å®šæ˜¯å¦è¿”å› <code>TRUE</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">BOOLEAN</span><br><span class="line"><span class="title function_">MmVerifyCallbackFunction</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PVOID NotifyRoutine</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    DataTableEntry = MiLookupDataTableEntry(NotifyRoutine, TRUE);</span><br><span class="line">    <span class="keyword">if</span> (DataTableEntry) &#123;</span><br><span class="line">        IsValidCallback = (DataTableEntry-&gt;Flags &amp; <span class="number">0x20</span>) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">return</span> IsValidCallback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>MiLookupDataTableEntry</code> ä¼šéå†æ‰€æœ‰å·²åŠ è½½æ¨¡å—ï¼Œåˆ¤æ–­ä¼ å…¥çš„å›è°ƒå‡½æ•°åœ¨å“ªä¸ªæ¨¡å—çš„åœ°å€èŒƒå›´å†…ï¼Œè¿”å›è¯¥æ¨¡å—å¯¹åº”çš„ <code>KLDR_DATA_TABLE_ENTRY</code> ç»“æ„ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">PKLDR_DATA_TABLE_ENTRY</span><br><span class="line"><span class="title function_">MiLookupDataTableEntry</span> <span class="params">(</span></span><br><span class="line"><span class="params">    IN PVOID AddressWithinSection,  <span class="comment">// è¾“å…¥å‚æ•°ï¼šè¦åœ¨æ¨¡å—ä¸­æŸ¥æ‰¾çš„å†…å­˜åœ°å€</span></span></span><br><span class="line"><span class="params">    IN ULONG ResourceHeld           <span class="comment">// è¾“å…¥å‚æ•°ï¼šæŒ‡ç¤ºæ˜¯å¦å·²æŒæœ‰PsLoadedModuleResourceèµ„æºé”</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‡½æ•°è¯´æ˜:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    æœ¬å‡½æ•°æŸ¥æ‰¾åŒ…å«æŒ‡å®šåœ°å€çš„å·²åŠ è½½æ¨¡å—å¯¹åº”çš„æ•°æ®è¡¨æ¡ç›®ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‚æ•°è¯´æ˜:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    AddressWithinSection - æä¾›è¦æŸ¥æ‰¾çš„åœ°å€ï¼Œè¯¥åœ°å€åº”åŒ…å«åœ¨ç›®æ ‡æ¨¡å—çš„ä»£ç æ®µæˆ–æ•°æ®æ®µä¸­</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ResourceHeld - æŒ‡ç¤ºè°ƒç”¨è€…æ˜¯å¦å·²æŒæœ‰å·²åŠ è½½æ¨¡å—èµ„æºé”ï¼š</span></span><br><span class="line"><span class="comment">                   TRUE  = è°ƒç”¨è€…å·²æŒæœ‰é”ï¼Œä¸éœ€è¦é‡å¤è·å–</span></span><br><span class="line"><span class="comment">                   FALSE = è°ƒç”¨è€…æœªæŒæœ‰é”ï¼Œå‡½æ•°å†…éƒ¨éœ€è¦è·å–é”</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿”å›å€¼:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    è¿”å›æ˜ å°„åˆ°å‚æ•°åœ°å€çš„å·²åŠ è½½æ¨¡å—åˆ—è¡¨æ•°æ®è¡¨æ¡ç›®çš„åœ°å€ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›NULL</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line">&#123;</span><br><span class="line">    PKTHREAD CurrentThread;         <span class="comment">// å½“å‰çº¿ç¨‹æŒ‡é’ˆ</span></span><br><span class="line">    PKLDR_DATA_TABLE_ENTRY DataTableEntry;  <span class="comment">// éå†ä¸­çš„å½“å‰æ•°æ®è¡¨æ¡ç›®</span></span><br><span class="line">    PKLDR_DATA_TABLE_ENTRY FoundEntry;      <span class="comment">// æ‰¾åˆ°çš„ç›®æ ‡æ¡ç›®</span></span><br><span class="line">    PLIST_ENTRY NextEntry;          <span class="comment">// æŒ‡å‘åŠ è½½æ¨¡å—åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªæ¡ç›®</span></span><br><span class="line"></span><br><span class="line">    PAGED_CODE();  <span class="comment">// å£°æ˜æ­¤å‡½æ•°å¯åˆ†é¡µï¼Œä½†ä»…åœ¨å®‰å…¨ç¯å¢ƒä¸‹è°ƒç”¨</span></span><br><span class="line"></span><br><span class="line">    FoundEntry = <span class="literal">NULL</span>;  <span class="comment">// åˆå§‹åŒ–æŸ¥æ‰¾ç»“æœä¸ºæœªæ‰¾åˆ°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// éå†å·²åŠ è½½æ¨¡å—åˆ—è¡¨ï¼ŒæŸ¥æ‰¾åŒ…å«æŒ‡å®šåœ°å€çš„æ¨¡å—</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šå¦‚æœæ¨¡å—æ­£åœ¨å¸è½½è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æš‚æ—¶ä¸åœ¨åˆ—è¡¨ä¸­</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè°ƒç”¨è€…æœªæŒæœ‰èµ„æºé”ï¼Œåˆ™åœ¨æ­¤å¤„è·å–é”</span></span><br><span class="line">    <span class="keyword">if</span> (!ResourceHeld) &#123;</span><br><span class="line">        CurrentThread = KeGetCurrentThread();</span><br><span class="line">        <span class="comment">// è¿›å…¥å…³é”®åŒºåŸŸå¹¶ç¦ç”¨APC</span></span><br><span class="line">        KeEnterCriticalRegionThread(CurrentThread);</span><br><span class="line">        <span class="comment">// ä»¥å…±äº«æ¨¡å¼è·å–å·²åŠ è½½æ¨¡å—èµ„æºé”</span></span><br><span class="line">        ExAcquireResourceSharedLite(&amp;PsLoadedModuleResource, TRUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨è€…å·²æŒæœ‰é”ï¼Œä¸éœ€è¦é¢å¤–è·å–</span></span><br><span class="line">        CurrentThread = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»å·²åŠ è½½æ¨¡å—åˆ—è¡¨å¤´éƒ¨å¼€å§‹éå†</span></span><br><span class="line">    NextEntry = PsLoadedModuleList.Flink;</span><br><span class="line">    ASSERT(NextEntry != <span class="literal">NULL</span>);  <span class="comment">// ç¡®ä¿åˆ—è¡¨å·²åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†æ•´ä¸ªæ¨¡å—é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡é“¾è¡¨æŒ‡é’ˆè·å–å½“å‰æ¨¡å—çš„æ•°æ®è¡¨æ¡ç›®</span></span><br><span class="line">        DataTableEntry = CONTAINING_RECORD(NextEntry,</span><br><span class="line">                                           KLDR_DATA_TABLE_ENTRY,</span><br><span class="line">                                           InLoadOrderLinks);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// ğŸ“Œæ£€æŸ¥å½“å‰æ¨¡å—çš„å†…å­˜èŒƒå›´æ˜¯å¦åŒ…å«ç›®æ ‡åœ°å€</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (AddressWithinSection &gt;= DataTableEntry-&gt;DllBase &amp;&amp;  <span class="comment">// åœ°å€ &gt;= æ¨¡å—åŸºå€</span></span><br><span class="line">            AddressWithinSection &lt; (PVOID)((PUCHAR)DataTableEntry-&gt;DllBase + </span><br><span class="line">                                          DataTableEntry-&gt;SizeOfImage))  <span class="comment">// åœ°å€ &lt; æ¨¡å—ç»“æŸåœ°å€</span></span><br><span class="line">        &#123;</span><br><span class="line">            FoundEntry = DataTableEntry;  <span class="comment">// æ‰¾åˆ°åŒ¹é…æ¨¡å—</span></span><br><span class="line">            <span class="keyword">break</span>;  <span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ¨¡å—</span></span><br><span class="line">        NextEntry = NextEntry-&gt;Flink;</span><br><span class="line">    &#125; <span class="keyword">while</span> (NextEntry != &amp;PsLoadedModuleList);  <span class="comment">// ç›´åˆ°å›åˆ°åˆ—è¡¨å¤´éƒ¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ­¤å‡½æ•°è·å–äº†é”ï¼Œéœ€è¦é‡Šæ”¾å®ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (CurrentThread != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ExReleaseResourceLite(&amp;PsLoadedModuleResource);  <span class="comment">// é‡Šæ”¾èµ„æºé”</span></span><br><span class="line">        KeLeaveCriticalRegionThread(CurrentThread);      <span class="comment">// é€€å‡ºå…³é”®åŒºåŸŸ</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> FoundEntry;  <span class="comment">// è¿”å›æŸ¥æ‰¾åˆ°çš„æ¨¡å—æ¡ç›®æˆ–NULL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å®é™…ä¸Šä¸Šè¿°æ£€æŸ¥åªæ˜¯åˆ¤æ–­é©±åŠ¨æ˜¯å¦ç»è¿‡å¾®è½¯å®˜æ–¹ç­¾åã€‚è€Œç»•è¿‡æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹é©±åŠ¨å¯¹åº”çš„ <code>KLDR_DATA_TABLE_ENTRY</code> ç»“æ„çš„ <code>Flags</code> å­—æ®µï¼Œä½¿å…¶ 0x20 ç½®ä½å³å¯ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">    ULONG __Undefined1;</span><br><span class="line">    ULONG __Undefined2;</span><br><span class="line">    ULONG __Undefined3;</span><br><span class="line">    ULONG NonPagedDebugInfo;</span><br><span class="line">    ULONG DllBase;</span><br><span class="line">    ULONG EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;</span><br><span class="line">    UNICODE_STRING BaseDllName;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="comment">// ...(åç»­å­—æ®µçœç•¥)</span></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span><br><span class="line">&#123;</span><br><span class="line">    PKLDR_DATA_TABLE_ENTRY DataTableEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»•è¿‡é©±åŠ¨ç­¾åæ£€æµ‹</span></span><br><span class="line">    DataTableEntry = (PKLDR_DATA_TABLE_ENTRY)DriverObject-&gt;DriverSection;</span><br><span class="line">    DataTableEntry-&gt;Flags |= <span class="number">0x20</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åç»­ PsSetCreateProcessNotifyRoutineEx æ³¨å†Œè¿›ç¨‹å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    </span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="è¿›ç¨‹å›è°ƒåˆ†æ"><a href="#è¿›ç¨‹å›è°ƒåˆ†æ" class="headerlink" title="è¿›ç¨‹å›è°ƒåˆ†æ"></a>è¿›ç¨‹å›è°ƒåˆ†æ</h3><h4 id="å›è°ƒæ³¨å†Œ"><a href="#å›è°ƒæ³¨å†Œ" class="headerlink" title="å›è°ƒæ³¨å†Œ"></a>å›è°ƒæ³¨å†Œ</h4><p>æ— è®ºæ˜¯å¦æ˜¯æ‰©å±•å›è°ƒï¼Œè¿›ç¨‹å›è°ƒæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ <code>PspSetCreateProcessNotifyRoutine</code> å‡½æ•°æ³¨å†Œçš„ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥è¡¨ç¤ºæ˜¯å¦æ˜¯æ‰©å±•å›è°ƒã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateProcessNotifyRoutineEx</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_PROCESS_NOTIFY_ROUTINE_EX NotifyRoutine,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> PspSetCreateProcessNotifyRoutine(NotifyRoutine, Remove, TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateProcessNotifyRoutine</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_PROCESS_NOTIFY_ROUTINE NotifyRoutine,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> PspSetCreateProcessNotifyRoutine(NotifyRoutine, Remove, TRUE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PspSetCreateProcessNotifyRoutine</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PVOID NotifyRoutine,</span></span><br><span class="line"><span class="params">    BOOLEAN Remove,</span></span><br><span class="line"><span class="params">    BOOLEAN IsExtended</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p><code>PspSetCreateProcessNotifyRoutine</code> å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PspSetCreateProcessNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID NotifyRoutine,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Remove,</span></span><br><span class="line"><span class="params">    _In_ BOOLEAN IsExtended</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK CallbackBlock;</span><br><span class="line">    PPSP_NOTIFY_ENTRY NotifyEntry;</span><br><span class="line">    ULONG i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ³¨é”€è·¯å¾„ï¼šç§»é™¤å·²æ³¨å†Œçš„å›è°ƒ</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (Remove)</span><br><span class="line">    &#123;</span><br><span class="line">        PKTHREAD CurrentThread = KeGetCurrentThread();</span><br><span class="line">        KeEnterCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PSP_MAX_CREATE_PROCESS_NOTIFY; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            NotifyEntry-&gt;CallbackBlock = &amp;PspCreateProcessNotifyRoutine[i];</span><br><span class="line">            CallbackBlock = ExReferenceCallBackBlock(NotifyEntry);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (CallbackBlock == <span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// æ£€æŸ¥å›è°ƒå‡½æ•°æ˜¯å¦åŒ¹é…</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> ((PVOID)ExGetCallBackBlockRoutine(CallbackBlock) == NotifyRoutine)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// âš ï¸ç±»å‹å¿…é¡»åŒ¹é…ï¼šä¸èƒ½ç”¨ EX æ³¨é”€æ™®é€šå›è°ƒï¼Œåä¹‹äº¦ç„¶</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> ((IsExtended &amp;&amp; !NotifyEntry-&gt;IsExtended) ||</span><br><span class="line">                    (!IsExtended &amp;&amp; NotifyEntry-&gt;IsExtended))</span><br><span class="line">                &#123;</span><br><span class="line">                    ExDereferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock, CallbackBlock);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// åŸå­æ¸…é™¤è¯¥å›è°ƒæ§½</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span> (ExCompareExchangeCallBack(</span><br><span class="line">                        (PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock,</span><br><span class="line">                        <span class="literal">NULL</span>,</span><br><span class="line">                        CallbackBlock))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// æ›´æ–°å›è°ƒè®¡æ•°</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="keyword">if</span> (IsExtended)</span><br><span class="line">                        InterlockedDecrement(&amp;PspCreateProcessNotifyRoutineExCount);</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        InterlockedDecrement(&amp;PspCreateProcessNotifyRoutineCount);</span><br><span class="line"></span><br><span class="line">                    ExDereferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock, CallbackBlock);</span><br><span class="line"></span><br><span class="line">                    KeLeaveCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    <span class="comment">// ç­‰å¾…æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„å›è°ƒå®Œæˆå¹¶é‡Šæ”¾èµ„æº</span></span><br><span class="line">                    <span class="comment">//</span></span><br><span class="line">                    ExWaitForCallBacks(CallbackBlock);</span><br><span class="line">                    ExFreeCallBack(CallbackBlock);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// åŒ¹é…å¤±è´¥ï¼Œé‡Šæ”¾å¼•ç”¨</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            ExDereferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock, CallbackBlock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KeLeaveCriticalRegionThread(CurrentThread);</span><br><span class="line">        <span class="keyword">return</span> STATUS_PROCEDURE_NOT_FOUND;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// âš ï¸EX å›è°ƒéœ€éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆå¯å›è°ƒåœ°å€ï¼ˆä¸€èˆ¬è¦æ±‚é©±åŠ¨ç­¾åï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (IsExtended &amp;&amp; !MmVerifyCallbackFunction(NotifyRoutine))</span><br><span class="line">        <span class="keyword">return</span> STATUS_ACCESS_DENIED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆ†é…æ–°çš„å›è°ƒå—</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    CallbackBlock = ExAllocateCallBack((PEX_CALLBACK_FUNCTION)NotifyRoutine, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!CallbackBlock)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ’å…¥åˆ°ç©ºé—²æ§½</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PSP_MAX_CREATE_PROCESS_NOTIFY; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        NotifyEntry-&gt;CallbackBlock = &amp;PspCreateProcessNotifyRoutine[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ExCompareExchangeCallBack(</span><br><span class="line">                NotifyEntry-&gt;CallbackBlock,</span><br><span class="line">                CallbackBlock,</span><br><span class="line">                <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// è®¾ç½® EX æ ‡å¿—</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            NotifyEntry-&gt;IsExtended = IsExtended;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IsExtended)</span><br><span class="line">            &#123;</span><br><span class="line">                InterlockedIncrement(&amp;PspCreateProcessNotifyRoutineExCount);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!(PspNotifyEnableMask &amp; PSP_NOTIFY_PROCESS_EX))</span><br><span class="line">                &#123;</span><br><span class="line">                    InterlockedBitTestAndSet(&amp;PspNotifyEnableMask, PSP_NOTIFY_PROCESS_EX_BIT); <span class="comment">// è®¾ç½® bit2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                InterlockedIncrement(&amp;PspCreateProcessNotifyRoutineCount);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!(PspNotifyEnableMask &amp; PSP_NOTIFY_PROCESS))</span><br><span class="line">                &#123;</span><br><span class="line">                    InterlockedBitTestAndSet(&amp;PspNotifyEnableMask, PSP_NOTIFY_PROCESS_BIT); <span class="comment">// è®¾ç½® bit1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰ç©ºä½ï¼Œé‡Šæ”¾å›è°ƒå—</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ExFreeCallBack(CallbackBlock);</span><br><span class="line">    <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äº<strong>æ³¨é”€æµç¨‹</strong>ï¼Œè¯¥å‡½æ•°çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol>
<li>è¿›å…¥çº¿ç¨‹ä¸´ç•ŒåŒºï¼Œé˜²æ­¢å›è°ƒæ•°ç»„ç«äº‰ï¼›</li>
<li>éå†å›è°ƒæ§½ <code>PspCreateProcessNotifyRoutine[i]</code>ï¼š<ul>
<li>å¦‚æœ <code>NotifyRoutine</code> åŒ¹é…ï¼Œå¹¶ä¸”å›è°ƒç±»å‹ä¹ŸåŒ¹é…ï¼ˆEX&#x2F;æ™®é€šï¼‰ï¼š<ul>
<li>ä½¿ç”¨ <code>ExCompareExchangeCallBack()</code> åŸå­æ›¿æ¢ä¸º <code>NULL</code>ï¼›</li>
<li>æ›´æ–°è®¡æ•°ï¼ˆ<code>PspCreateProcessNotifyRoutineCount</code> æˆ– <code>ExCount</code>ï¼‰ï¼›</li>
<li>ç­‰å¾…æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„å›è°ƒè¿”å›ï¼›</li>
<li>è°ƒç”¨ <code>ExFreeCallBack()</code> é‡Šæ”¾å›è°ƒèµ„æºï¼›</li>
<li>è¿”å› <code>STATUS_SUCCESS</code>ã€‚</li>
</ul>
</li>
<li>å¦åˆ™ï¼Œé‡Šæ”¾å¼•ç”¨ï¼Œç»§ç»­æŸ¥æ‰¾ï¼›</li>
</ul>
</li>
<li>å¦‚æœæœªæ‰¾åˆ°åŒ¹é…å›è°ƒï¼Œè¿”å› <code>STATUS_PROCEDURE_NOT_FOUND</code>ã€‚</li>
</ol>
<p>å¯¹äº<strong>æ³¨å†Œæµç¨‹</strong>ï¼Œè¯¥å‡½æ•°çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol>
<li>è°ƒç”¨ <code>MmVerifyCallbackFunction</code> æ ¡éªŒå‡½æ•°åœ°å€å®‰å…¨æ€§ï¼ˆå¦‚ç­¾åï¼‰ï¼›<ul>
<li>å¤±è´¥åˆ™è¿”å› <code>STATUS_ACCESS_DENIED</code>ã€‚</li>
</ul>
</li>
<li>ä½¿ç”¨ <code>ExAllocateCallBack()</code> åˆ›å»º <code>CallbackBlock</code>ï¼›<ul>
<li>å¤±è´¥è¿”å› <code>STATUS_INSUFFICIENT_RESOURCES</code>ã€‚</li>
</ul>
</li>
<li>éå†å›è°ƒæ§½ï¼Œå°è¯•åŸå­æ’å…¥ï¼š<ul>
<li>æ’å…¥æˆåŠŸåˆ™ï¼š<ul>
<li>è®¾ç½® <code>IsExtended</code> æ ‡å¿—ï¼›</li>
<li>æ›´æ–°å¯¹åº”è®¡æ•°ï¼›</li>
<li>è®¾ç½® <code>PspNotifyEnableMask</code> ä¸­å¯¹åº” bitï¼ˆæ™®é€š&#x2F;EXï¼‰ï¼›</li>
<li>è¿”å› <code>STATUS_SUCCESS</code>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>æ‰€æœ‰æ§½éƒ½è¢«å ç”¨æ—¶ï¼Œé‡Šæ”¾åˆ†é…çš„å›è°ƒï¼Œè¿”å› <code>STATUS_INVALID_PARAMETER</code>ã€‚</li>
</ol>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <ul>
<li>å›è°ƒæ§½ <code>PspCreateProcessNotifyRoutine</code> å¤§å°ä¸º <code>PSP_MAX_CREATE_PROCESS_NOTIFY(64)</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æœ€å¤šæ³¨å†Œ 64 ä¸ªè¿›ç¨‹å›è°ƒå‡½æ•°ï¼ˆåŒ…æ‹¬æ‰©å±•å›è°ƒå’Œéæ‰©å±•å›è°ƒï¼‰ã€‚</li>
<li>å›è°ƒå‡½æ•°ä¼šæŒ‰ç…§å…ˆåå¾ªåºæ”¾å…¥å›è°ƒæ§½ï¼Œè¶Šæ—©æ³¨å†Œçš„å‡½æ•°è¶Šé å‰ï¼Œåç»­ä¹Ÿä¼šè¶Šæ—©è°ƒç”¨ï¼Œæ–¹ä¾¿æ‹¦æˆªåç»­çš„å›è°ƒå‡½æ•°ã€‚</li>
</ul>

    </div>
  </div>

<h4 id="å›è°ƒè°ƒç”¨"><a href="#å›è°ƒè°ƒç”¨" class="headerlink" title="å›è°ƒè°ƒç”¨"></a>å›è°ƒè°ƒç”¨</h4><p>å¯¹äº<strong>è¿›ç¨‹åˆ›å»ºäº‹ä»¶</strong>ï¼Œè¿›ç¨‹å›è°ƒå‡½æ•°ä¼šåœ¨ <code>PspInsertThread</code> å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸ºç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºçš„æ—¶å€™ä¸€å®šæ˜¯è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Process-&gt;ActiveThreads == <span class="number">1</span>)  <span class="comment">// åˆ›å»ºä¸»çº¿ç¨‹åé¦–æ¬¡è§¦å‘è¿›ç¨‹é€šçŸ¥</span></span><br><span class="line">&#123;</span><br><span class="line">    EtwTraceProcess(Process, ETW_EVENT_PROCESS_CREATE);  <span class="comment">// ETW è·Ÿè¸ªï¼šåˆ›å»ºè¿›ç¨‹äº‹ä»¶ï¼ˆä¾‹å¦‚ PID æ˜ å°„ï¼‰</span></span><br><span class="line"></span><br><span class="line">    NTSTATUS CreationStatus = STATUS_SUCCESS;</span><br><span class="line">    BOOLEAN HasExNotify = (PspNotifyEnableMask &amp; PSP_NOTIFY_PROCESS_EX) != <span class="number">0</span>;  <span class="comment">// æ˜¯å¦å¯ç”¨æ‰©å±•è¿›ç¨‹é€šçŸ¥ï¼ˆExï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ç”¨äº†ä»»ä½•è¿›ç¨‹é€šçŸ¥æœºåˆ¶ï¼ˆæ™®é€šæˆ–æ‰©å±•ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (PspNotifyEnableMask &amp; (PSP_NOTIFY_PROCESS | PSP_NOTIFY_PROCESS_EX))</span><br><span class="line">    &#123;</span><br><span class="line">        PFILE_OBJECT FileObject = <span class="literal">NULL</span>;</span><br><span class="line">        BOOLEAN NeedDereference = FALSE;</span><br><span class="line">        PS_CREATE_NOTIFY_INFO NotifyInfo;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -------------------------------</span></span><br><span class="line">        <span class="comment">// æ„å»ºæ‰©å±•é€šçŸ¥ç»“æ„ï¼ˆEX å›è°ƒä½¿ç”¨ï¼‰</span></span><br><span class="line">        <span class="comment">// -------------------------------</span></span><br><span class="line">        <span class="keyword">if</span> (HasExNotify)</span><br><span class="line">        &#123;</span><br><span class="line">            NotifyInfo.Size = <span class="keyword">sizeof</span>(NotifyInfo);</span><br><span class="line">            NotifyInfo.Flags = <span class="number">0</span>;</span><br><span class="line">            NotifyInfo.ParentProcessId = Process-&gt;InheritedFromUniqueProcessId;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–å½“å‰çº¿ç¨‹ CIDï¼ˆCreatorï¼‰</span></span><br><span class="line">            NotifyInfo.CreatingThreadId = CONTAINING_RECORD(</span><br><span class="line">                KeGetCurrentThread(), _ETHREAD, Tcb)-&gt;Cid;</span><br><span class="line"></span><br><span class="line">            NotifyInfo.CreationStatus = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–è¿›ç¨‹å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡ï¼ˆé•œåƒå¥æŸ„ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (CreateProcessContext &amp;&amp; CreateProcessContext-&gt;FileObject)</span><br><span class="line">            &#123;</span><br><span class="line">                FileObject = CreateProcessContext-&gt;FileObject;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                NeedDereference = TRUE;</span><br><span class="line">                PsReferenceProcessFilePointer(Process, &amp;FileObject);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            NotifyInfo.FileObject = FileObject;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦æä¾›äº†æ˜ åƒæ–‡ä»¶å</span></span><br><span class="line">            <span class="keyword">if</span> (CreateProcessContext &amp;&amp; (CreateProcessContext-&gt;Flags &amp; <span class="number">0x20</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                NotifyInfo.ImageFileName = &amp;CreateProcessContext-&gt;ImageFileName;</span><br><span class="line">                NotifyInfo.FileOpenNameAvailable = TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                NotifyInfo.ImageFileName = &amp;FileObject-&gt;FileName;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–å‘½ä»¤è¡Œå‚æ•°ï¼ˆä»¥ UNICODE_STRING å½¢å¼ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (CreateProcessContext &amp;&amp; CreateProcessContext-&gt;CommandLine)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// é€šå¸¸ä¸º RTL_USER_PROCESS_PARAMETERS çš„åç§»</span></span><br><span class="line">                NotifyInfo.CommandLine = CreateProcessContext-&gt;CommandLine + <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                NotifyInfo.CommandLine = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// -------------------------------</span></span><br><span class="line">        <span class="comment">// éå†æ³¨å†Œçš„è¿›ç¨‹å›è°ƒå‡½æ•°è¡¨</span></span><br><span class="line">        <span class="comment">// -------------------------------</span></span><br><span class="line">        EX_CALLBACK_ROUTINE_BLOCK* CallbackBlock;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_CREATE_PROCESS_NOTIFY; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            CallbackBlock = ExReferenceCallBackBlock(&amp;PspCreateProcessNotifyRoutine[i]);</span><br><span class="line">            <span class="keyword">if</span> (!CallbackBlock)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–æ³¨å†Œçš„å›è°ƒå‡½æ•°åœ°å€</span></span><br><span class="line">            PVOID NotifyRoutine = ExGetCallBackBlockRoutine(CallbackBlock);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (CallbackBlock-&gt;Context)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// æ‰©å±•å›è°ƒï¼ˆå¸¦ç»“æ„ä½“ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (HasExNotify)</span><br><span class="line">                &#123;</span><br><span class="line">                    ((PCREATE_PROCESS_NOTIFY_ROUTINE_EX)NotifyRoutine)(</span><br><span class="line">                        Process,</span><br><span class="line">                        Process-&gt;UniqueProcessId,</span><br><span class="line">                        &amp;NotifyInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// æ™®é€šå›è°ƒï¼ˆæ—§å¼ä¸‰å‚æ•°ï¼‰</span></span><br><span class="line">                ((PCREATE_PROCESS_NOTIFY_ROUTINE)NotifyRoutine)(</span><br><span class="line">                    Process-&gt;InheritedFromUniqueProcessId,</span><br><span class="line">                    Process-&gt;UniqueProcessId,</span><br><span class="line">                    TRUE);  <span class="comment">// TRUE è¡¨ç¤ºåˆ›å»º</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ExDereferenceCallBackBlock(CallbackBlock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// -------------------------------</span></span><br><span class="line">            <span class="comment">// å›è°ƒè¯·æ±‚ä¸­æ­¢è¿›ç¨‹åˆ›å»º</span></span><br><span class="line">            <span class="comment">// -------------------------------</span></span><br><span class="line">            <span class="keyword">if</span> (HasExNotify &amp;&amp; !NT_SUCCESS(NotifyInfo.CreationStatus))</span><br><span class="line">            &#123;</span><br><span class="line">                PsTerminateProcess(Process, NotifyInfo.CreationStatus);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨å¼•ç”¨äº†æ–‡ä»¶å¯¹è±¡ï¼Œéœ€è¦é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (NeedDereference)</span><br><span class="line">            ObfDereferenceObject(FileObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <ul>
<li><p><code>PspNotifyEnableMask</code> æ˜¯ä¸€ä¸ª<strong>å…¨å±€çš„ä½æ©ç å˜é‡</strong>ï¼Œç”¨äºæ§åˆ¶<strong>ç³»ç»Ÿé€šçŸ¥ç±»å›è°ƒï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€é•œåƒåŠ è½½ç­‰ï¼‰</strong>çš„å¯ç”¨çŠ¶æ€ã€‚å®ƒçš„æ¯ä¸€ä½åˆ†åˆ«è¡¨ç¤ºæŸä¸€ç±»å›è°ƒæ˜¯å¦å¯ç”¨ã€‚</p>
<p>  å¯¹äºè¿›ç¨‹å›è°ƒï¼š</p>
<ul>
<li><strong>bit 1</strong>ï¼šå³ä»£ç ä¸­çš„ <code>PSP_NOTIFY_PROCESS_BIT</code>ï¼Œç”¨äºæ§åˆ¶æ™®é€šçš„ <code>PsSetCreateProcessNotifyRoutine</code> å›è°ƒæ˜¯å¦å¯ç”¨ã€‚</li>
<li><strong>bit 2</strong>ï¼šå³ä»£ç ä¸­çš„ <code>PSP_NOTIFY_PROCESS_EX_BIT</code>ï¼Œç”¨äºæ§åˆ¶æ‰©å±•çš„ <code>PsSetCreateProcessNotifyRoutineEx</code> å›è°ƒæ˜¯å¦å¯ç”¨ã€‚</li>
</ul>
<p>  å› æ­¤æˆ‘ä»¬å¯ä»¥çŸ­æš‚æ¸…ç©ºç›¸å…³æ ‡å¿—ä½æ¥è§„é¿ä¸€äº›æ•æ„Ÿè¡Œä¸ºçš„ç›‘æ§ã€‚
  </p>
</li>
<li><p>å¦‚æœæ˜¯<strong>æ‰©å±•å›è°ƒ</strong>ï¼Œåˆ™è®¾ç½®æ‰©å±•å›è°ƒçš„ç»“æ„ä½“ä¸­ <code>PS_CREATE_NOTIFY_INFO</code> ä¸­çš„ <code>CreationStatus</code> å¯ä»¥é˜»æ­¢è¿›ç¨‹åˆ›å»ºã€‚</p>
</li>
<li><p><code>NotifyInfo</code> åœ¨è°ƒç”¨æ‰©å±•å›è°ƒå‡½æ•°çš„è¿‡ç¨‹ä¸­æ˜¯å…±ç”¨çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ <code>NotifyInfo</code> ç»“æ„ä½“ä¸­çš„å†…å®¹ä»è€Œå½±å“åˆ°åç»­æ‰©å±•å›è°ƒå‡½æ•°çš„åˆ¤æ–­ï¼›åŒç†ï¼Œ<code>Process</code> ç»“æ„ä½“ä¹Ÿå¯ä»¥è¢«ä¿®æ”¹ã€‚</p>
</li>
</ul>

    </div>
  </div>

<p>å¯¹äº<strong>è¿›ç¨‹é€€å‡ºäº‹ä»¶</strong>åˆ™æ˜¯åœ¨ <code>PspExitProcess</code> å‡½æ•°ä¸­è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœå¯ç”¨äº†è¿›ç¨‹å›è°ƒé€šçŸ¥ï¼ˆæ™®é€šæˆ–æ‰©å±•ï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (PspNotifyEnableMask &amp; (PSP_NOTIFY_PROCESS | PSP_NOTIFY_PROCESS_EX))</span><br><span class="line">&#123;</span><br><span class="line">    ULONG i;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK CallbackBlock;</span><br><span class="line">    PCREATE_PROCESS_NOTIFY_ROUTINE CallbackFunction;</span><br><span class="line">    PPSP_NOTIFY_ENTRY NotifyEntry = PspCreateProcessNotifyRoutine;</span><br><span class="line">    BOOLEAN ExtendedEnabled = (PspNotifyEnableMask &amp; PSP_NOTIFY_PROCESS_EX) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PSP_MAX_CREATE_PROCESS_NOTIFY; i++, NotifyEntry++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å°è¯•å¼•ç”¨è¯¥å›è°ƒæ§½çš„å›è°ƒå—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        CallbackBlock = ExReferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock);</span><br><span class="line">        <span class="keyword">if</span> (CallbackBlock == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å¦‚æœç±»å‹ä¸åŒ¹é…åˆ™è·³è¿‡ï¼ˆæ™®é€šå›è°ƒä¸è°ƒç”¨æ‰©å±•ï¼Œåä¹‹äº¦ç„¶ï¼‰</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (NotifyEntry-&gt;IsExtended &amp;&amp; !ExtendedEnabled)</span><br><span class="line">        &#123;</span><br><span class="line">            ExDereferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock, CallbackBlock);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// æå–å›è°ƒå‡½æ•°æŒ‡é’ˆå¹¶è°ƒç”¨ï¼ˆCreate=FALSE è¡¨ç¤ºè¿›ç¨‹é€€å‡ºï¼‰</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        CallbackFunction = (PCREATE_PROCESS_NOTIFY_ROUTINE)ExGetCallBackBlockRoutine(CallbackBlock);</span><br><span class="line">        CallbackFunction(</span><br><span class="line">            NotifyEntry-&gt;IsExtended ? Process-&gt;InheritedFromUniqueProcessId : Process-&gt;UniqueProcessId,</span><br><span class="line">            Process-&gt;UniqueProcessId,</span><br><span class="line">            FALSE</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// é‡Šæ”¾å¼•ç”¨</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ExDereferenceCallBackBlock((PEX_CALLBACK)&amp;NotifyEntry-&gt;CallbackBlock, CallbackBlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="çº¿ç¨‹å›è°ƒ"><a href="#çº¿ç¨‹å›è°ƒ" class="headerlink" title="çº¿ç¨‹å›è°ƒ"></a>çº¿ç¨‹å›è°ƒ</h2><p>çº¿ç¨‹å›è°ƒæ˜¯ Windows å†…æ ¸æä¾›çš„é‡è¦æœºåˆ¶ä¹‹ä¸€ï¼Œå…è®¸é©±åŠ¨åœ¨<strong>çº¿ç¨‹åˆ›å»ºä¸é”€æ¯äº‹ä»¶å‘ç”Ÿæ—¶æ¥æ”¶é€šçŸ¥</strong>ï¼Œä»¥å®ç°ç›‘æ§ã€æ—¥å¿—è®°å½•ã€å®‰å…¨æ£€æµ‹ç­‰åŠŸèƒ½ã€‚Windows æä¾›äº†çº¿ç¨‹å›è°ƒå‡½æ•° <code>PCREATE_THREAD_NOTIFY_ROUTINE</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span> <span class="params">(*PCREATE_THREAD_NOTIFY_ROUTINE)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE ProcessId,   <span class="comment">// æ‰€å±è¿›ç¨‹çš„ PID</span></span></span><br><span class="line"><span class="params">    _In_ HANDLE ThreadId,    <span class="comment">// çº¿ç¨‹ ID</span></span></span><br><span class="line"><span class="params">    _In_ BOOLEAN Create      <span class="comment">// TRUE è¡¨ç¤ºçº¿ç¨‹åˆ›å»ºï¼ŒFALSE è¡¨ç¤ºçº¿ç¨‹é”€æ¯</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸºç¡€å›è°ƒæ³¨å†Œ-1"><a href="#åŸºç¡€å›è°ƒæ³¨å†Œ-1" class="headerlink" title="åŸºç¡€å›è°ƒæ³¨å†Œ"></a>åŸºç¡€å›è°ƒæ³¨å†Œ</h3><p>ä¸è¿›ç¨‹å›è°ƒä¸åŒï¼Œçº¿ç¨‹å›è°ƒå‡½æ•° <code>PCREATE_THREAD_NOTIFY_ROUTINE</code> çš„æ³¨å†Œå’Œç§»é™¤å‡½æ•°æ˜¯ä¸¤ä¸ªä¸åŒçš„å‡½æ•°ï¼š</p>
<ul>
<li><p><strong>æ³¨å†Œçº¿ç¨‹å›è°ƒ</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateThreadNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>ç§»é™¤çº¿ç¨‹å›è°ƒ</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsRemoveCreateThreadNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">MyThreadNotifyCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    HANDLE ProcessId,</span></span><br><span class="line"><span class="params">    HANDLE ThreadId,</span></span><br><span class="line"><span class="params">    BOOLEAN Create</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (Create) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;çº¿ç¨‹åˆ›å»º: PID=%p, TID=%p\n&quot;</span>, ProcessId, ThreadId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;çº¿ç¨‹é”€æ¯: PID=%p, TID=%p\n&quot;</span>, ProcessId, ThreadId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span><br><span class="line">&#123;</span><br><span class="line">    PsSetCreateThreadNotifyRoutine(MyThreadNotifyCallback);</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">    PsRemoveCreateThreadNotifyRoutine(MyThreadNotifyCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="æ‰©å±•å›è°ƒæ³¨å†Œ-1"><a href="#æ‰©å±•å›è°ƒæ³¨å†Œ-1" class="headerlink" title="æ‰©å±•å›è°ƒæ³¨å†Œ"></a>æ‰©å±•å›è°ƒæ³¨å†Œ</h3><p><code>PsSetCreateThreadNotifyRoutineEx</code> æ˜¯ Windows 10 å¼•å…¥çš„å¢å¼ºçº¿ç¨‹å›è°ƒæ¥å£ï¼Œå…è®¸é©±åŠ¨ç¨‹åºæ³¨å†Œç”¨äºç›‘å¬ç³»ç»ŸèŒƒå›´å†…<strong>çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯äº‹ä»¶</strong>çš„å›è°ƒå‡½æ•°ã€‚</p>
<p>è¯¥å‡½æ•°æ¯”æ—§çš„ <code>PsSetCreateThreadNotifyRoutine</code> æ›´çµæ´»ï¼Œæ”¯æŒæ§åˆ¶å›è°ƒç±»å‹ï¼ˆå¦‚æ˜¯å¦åœ¨è¢«åˆ›å»ºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼‰ï¼Œå¹¶å…è®¸ç‰¹æƒé©±åŠ¨åœ¨ç³»ç»ŸèŒƒå›´å†…å¯¹çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç²¾ç»†ç›‘æ§ã€‚</p>
<p><code>PsSetCreateThreadNotifyRoutineEx</code> å‡½æ•°å£°æ˜å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateThreadNotifyRoutineEx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PSCREATETHREADNOTIFYTYPE NotifyType,    <span class="comment">// æšä¸¾ç±»å‹ï¼Œè¡¨ç¤ºè¦æ³¨å†Œå“ªç§ç±»å‹çš„çº¿ç¨‹é€šçŸ¥æœºåˆ¶</span></span></span><br><span class="line"><span class="params">    _In_ PVOID NotifyInformation                 <span class="comment">// å®é™…ä¸Šæ˜¯ PCREATE_THREAD_NOTIFY_ROUTINE çš„å‡½æ•°æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p><code>PsSetCreateThreadNotifyRoutineEx</code> æ³¨å†Œçš„å›è°ƒå‡½æ•°ä¾æ—§ä½¿ç”¨ <code>PsRemoveCreateThreadNotifyRoutine</code> å¸è½½ã€‚</p>

    </div>
  </div>

<p>å…¶ä¸­ <code>PSCREATETHREADNOTIFYTYPE</code> ç›®å‰æ”¯æŒä¸‹é¢ä¸¤ç§å€¼ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">PSCREATETHREADNOTIFYTYPE</span> &#123;</span></span><br><span class="line">    PsCreateThreadNotifyNonSystem = <span class="number">0</span>,  <span class="comment">// å›è°ƒåœ¨æ–°çº¿ç¨‹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">    PsCreateThreadNotifySubsystems = <span class="number">1</span>  <span class="comment">// å›è°ƒä¸ºæ‰€æœ‰å­ç³»ç»Ÿçº¿ç¨‹è°ƒç”¨</span></span><br><span class="line">&#125; PSCREATETHREADNOTIFYTYPE;</span><br></pre></td></tr></table></figure></div>

<h3 id="çº¿ç¨‹å›è°ƒåˆ†æ"><a href="#çº¿ç¨‹å›è°ƒåˆ†æ" class="headerlink" title="çº¿ç¨‹å›è°ƒåˆ†æ"></a>çº¿ç¨‹å›è°ƒåˆ†æ</h3><h4 id="å›è°ƒæ³¨å†Œ-1"><a href="#å›è°ƒæ³¨å†Œ-1" class="headerlink" title="å›è°ƒæ³¨å†Œ"></a>å›è°ƒæ³¨å†Œ</h4><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ³¨å†Œçº¿ç¨‹åˆ›å»º/é€€å‡ºé€šçŸ¥å›è°ƒï¼ˆæ™®é€šå›è°ƒï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetCreateThreadNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK CallbackBlock;</span><br><span class="line">    PEX_CALLBACK CallbackSlot;</span><br><span class="line">    ULONG Index;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªå›è°ƒå—ï¼Œç”¨äºå°è£…å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    CallbackBlock = ExAllocateCallBack((PEX_CALLBACK_FUNCTION)NotifyRoutine, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (CallbackBlock == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åœ¨å›è°ƒè¡¨ä¸­æŸ¥æ‰¾ç©ºæ§½æ’å…¥å›è°ƒã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; PSP_MAX_CREATE_THREAD_NOTIFY; Index++)</span><br><span class="line">    &#123;</span><br><span class="line">        CallbackSlot = &amp;PspCreateThreadNotifyRoutine[Index];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ExCompareExchangeCallBack(</span><br><span class="line">                CallbackSlot,</span><br><span class="line">                CallbackBlock,</span><br><span class="line">                <span class="literal">NULL</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// æˆåŠŸæ³¨å†Œï¼Œæ›´æ–°å›è°ƒè®¡æ•°ã€‚</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            InterlockedIncrement(&amp;PspCreateThreadNotifyRoutineCount);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// å¦‚æœå°šæœªå¯ç”¨çº¿ç¨‹é€šçŸ¥ï¼Œè®¾ç½®å¯¹åº”çš„å¯ç”¨æ©ç ä½ã€‚</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (!(PspNotifyEnableMask &amp; PSP_NOTIFY_THREAD))</span><br><span class="line">            &#123;</span><br><span class="line">                InterlockedBitTestAndSet(&amp;PspNotifyEnableMask, PSP_NOTIFY_THREAD_BIT); <span class="comment">// è®¾ç½® bit3</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æœªæ‰¾åˆ°ç©ºæ§½ï¼Œé‡Šæ”¾åˆ†é…çš„å›è°ƒå—ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ExFreeCallBack(CallbackBlock);</span><br><span class="line">    <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="å›è°ƒç§»é™¤"><a href="#å›è°ƒç§»é™¤" class="headerlink" title="å›è°ƒç§»é™¤"></a>å›è°ƒç§»é™¤</h4><div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsRemoveCreateThreadNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    PKTHREAD CurrentThread;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK CallbackBlock;</span><br><span class="line">    ULONG i;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç¦ç”¨ APC äº¤ä»˜ï¼ˆè¿›å…¥å…³é”®åŒºåŸŸï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    CurrentThread = KeGetCurrentThread();</span><br><span class="line">    KeEnterCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; PSP_MAX_CREATE_THREAD_NOTIFY; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è·å–å›è°ƒå—å¼•ç”¨ï¼Œä»¥ä¾¿æ£€æŸ¥å…¶å®é™…å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        CallbackBlock = ExReferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[i]);</span><br><span class="line">        <span class="keyword">if</span> (CallbackBlock == <span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// æ¯”è¾ƒæ˜¯å¦ä¸ºç›®æ ‡å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> ((PCREATE_THREAD_NOTIFY_ROUTINE)ExGetCallBackBlockRoutine(CallbackBlock) == NotifyRoutine)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// åŸå­ç§»é™¤è¯¥å›è°ƒå—</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (ExCompareExchangeCallBack(</span><br><span class="line">                    &amp;PspCreateThreadNotifyRoutine[i],</span><br><span class="line">                    <span class="literal">NULL</span>,</span><br><span class="line">                    CallbackBlock))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// å‡å°‘æ³¨å†Œè®¡æ•°</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                InterlockedDecrement(&amp;PspCreateThreadNotifyRoutineCount);</span><br><span class="line"></span><br><span class="line">                ExDereferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[i], CallbackBlock);</span><br><span class="line"></span><br><span class="line">                KeLeaveCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">// ç­‰å¾…æ‰€æœ‰æ‰§è¡Œä¸­çš„å›è°ƒå®Œæˆå¹¶é‡Šæ”¾èµ„æº</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                ExWaitForCallBacks(CallbackBlock);</span><br><span class="line">                ExFreeCallBack(CallbackBlock);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// éåŒ¹é…æˆ–äº¤æ¢å¤±è´¥ï¼Œé‡Šæ”¾å¼•ç”¨</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ExDereferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[i], CallbackBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰å›è°ƒæ§½éƒ½æœªæ‰¾åˆ°åŒ¹é…é¡¹</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    KeLeaveCriticalRegionThread(CurrentThread);</span><br><span class="line">    <span class="keyword">return</span> STATUS_PROCEDURE_NOT_FOUND;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="å›è°ƒè°ƒç”¨-1"><a href="#å›è°ƒè°ƒç”¨-1" class="headerlink" title="å›è°ƒè°ƒç”¨"></a>å›è°ƒè°ƒç”¨</h4><p>å¯¹äº<strong>çº¿ç¨‹åˆ›å»ºäº‹ä»¶</strong>ï¼Œçº¿ç¨‹å›è°ƒå‡½æ•°åœ¨ <code>PspInsertThread</code> å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// çº¿ç¨‹åˆ›å»ºé€šçŸ¥ï¼ˆæ— è®ºæ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹ï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (PspCreateThreadNotifyRoutineCount != <span class="number">0</span>) &#123;</span><br><span class="line">    ULONG Index;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK Callback;</span><br><span class="line">    PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; PSP_MAX_CREATE_THREAD_NOTIFY; Index++) &#123;</span><br><span class="line">        Callback = ExReferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[Index]);</span><br><span class="line">        <span class="keyword">if</span> (Callback != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            NotifyRoutine = (PCREATE_THREAD_NOTIFY_ROUTINE)ExGetCallBackBlockRoutine(Callback);</span><br><span class="line"></span><br><span class="line">            NotifyRoutine(CONTAINING_RECORD(Object-&gt;Tcb.Process, _EPROCESS, Pcb)-&gt;UniqueProcessId,</span><br><span class="line">                          Thread-&gt;Cid.UniqueThread,</span><br><span class="line">                          TRUE);</span><br><span class="line"></span><br><span class="line">            ExDereferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[Index], Callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äº<strong>çº¿ç¨‹é€€å‡ºäº‹ä»¶</strong>ï¼Œçº¿ç¨‹å›è°ƒå‡½æ•°åœ¨ <code>PspExitThread</code> å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¦‚æœå¯ç”¨äº†çº¿ç¨‹å›è°ƒï¼ˆå¯¹åº” bit 3ï¼‰ï¼Œåˆ™éå†å¹¶è°ƒç”¨å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">if</span> (PspNotifyEnableMask &amp; PSP_NOTIFY_THREAD)</span><br><span class="line">&#123;</span><br><span class="line">    PEX_CALLBACK_ROUTINE_BLOCK CallbackBlock;</span><br><span class="line">    PCREATE_THREAD_NOTIFY_ROUTINE NotifyRoutine;</span><br><span class="line">    ULONG Index;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Index = <span class="number">0</span>; Index &lt; PSP_MAX_CREATE_THREAD_NOTIFY; Index++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å°è¯•å¼•ç”¨å›è°ƒå—ï¼Œé˜²æ­¢å¹¶å‘é‡Šæ”¾</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        CallbackBlock = ExReferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[Index]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CallbackBlock)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// è·å–å›è°ƒå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            NotifyRoutine = (PCREATE_THREAD_NOTIFY_ROUTINE)ExGetCallBackBlockRoutine(CallbackBlock);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// æ‰§è¡Œå›è°ƒï¼šé€šçŸ¥çº¿ç¨‹å³å°†é€€å‡ºï¼ˆç¬¬ä¸‰ä¸ªå‚æ•°ä¸º FALSEï¼‰</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            NotifyRoutine(</span><br><span class="line">                CONTAINING_RECORD(CurThread-&gt;Tcb.Process, _EPROCESS, Pcb)-&gt;UniqueProcessId,   <span class="comment">// è¿›ç¨‹ ID</span></span><br><span class="line">                CurThread-&gt;Cid.UniqueThread,    <span class="comment">// çº¿ç¨‹ ID</span></span><br><span class="line">                FALSE                      <span class="comment">// FALSE è¡¨ç¤ºçº¿ç¨‹é€€å‡º</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// è§£é™¤å›è°ƒå—çš„å¼•ç”¨</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            ExDereferenceCallBackBlock(&amp;PspCreateThreadNotifyRoutine[Index], CallbackBlock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="æ¨¡å—å›è°ƒ"><a href="#æ¨¡å—å›è°ƒ" class="headerlink" title="æ¨¡å—å›è°ƒ"></a>æ¨¡å—å›è°ƒ</h2><p>æ¨¡å—å›è°ƒæ˜¯ Windows å†…æ ¸æä¾›çš„é€šçŸ¥æœºåˆ¶ä¹‹ä¸€ï¼Œå…è®¸é©±åŠ¨ç¨‹åºåœ¨<strong>ä»»ä½•æ¨¡å—ï¼ˆåŒ…æ‹¬ EXEã€DLLã€SYSï¼‰åŠ è½½åˆ°è¿›ç¨‹åœ°å€ç©ºé—´æ—¶æ”¶åˆ°é€šçŸ¥</strong>ï¼Œä»¥ä¾¿å®ç°ç›‘æ§ã€æ—¥å¿—è®°å½•ã€DLL æ³¨å…¥æ£€æµ‹ã€ç­¾åéªŒè¯ç­‰åŠŸèƒ½ã€‚</p>
<p>Windows æä¾›çš„æ¨¡å—å›è°ƒå‡½æ•°ç±»å‹ä¸ºï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span> <span class="params">(*PLOAD_IMAGE_NOTIFY_ROUTINE)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_opt_ PUNICODE_STRING FullImageName, <span class="comment">// æ˜ åƒå®Œæ•´è·¯å¾„ï¼ˆå¯èƒ½ä¸º NULLï¼‰</span></span></span><br><span class="line"><span class="params">    _In_ HANDLE ProcessId,                  <span class="comment">// æ˜ åƒåŠ è½½ç›®æ ‡è¿›ç¨‹ IDï¼ˆ0 è¡¨ç¤ºç³»ç»Ÿè¿›ç¨‹ï¼‰</span></span></span><br><span class="line"><span class="params">    _In_ PIMAGE_INFO ImageInfo              <span class="comment">// æ˜ åƒåŠ è½½ä¿¡æ¯ç»“æ„ä½“æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>PIMAGE_INFO</code> ç»“æ„ä½“æè¿°äº†åŠ è½½çš„æ˜ åƒçš„åœ°å€ã€å¤§å°å’ŒåŠ è½½ç±»å‹ç­‰ä¿¡æ¯ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_INFO</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        ULONG Properties;                                         <span class="comment">// 0x00: å±æ€§æ ‡å¿—ä½é›†åˆï¼ˆç”¨äºå¿«é€Ÿåˆ¤æ–­åŠ è½½ç±»å‹ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            ULONG ImageAddressingMode  : <span class="number">8</span>;  <span class="comment">// [bit 0â€“7]  æ˜ åƒå¯»å€æ¨¡å¼ï¼š0 = 32ä½ï¼Œ1 = 64ä½ï¼Œå…¶ä»–å€¼ä¸ºä¿ç•™</span></span><br><span class="line">            ULONG SystemModeImage      : <span class="number">1</span>;  <span class="comment">// [bit 8]    ğŸ“Œæ˜ åƒæ˜¯å¦åœ¨å†…æ ¸æ¨¡å¼ä¸‹åŠ è½½ï¼ˆä¾‹å¦‚å†…æ ¸é©±åŠ¨ï¼‰</span></span><br><span class="line">            ULONG ImageMappedToAllPids : <span class="number">1</span>;  <span class="comment">// [bit 9]    æ˜¯å¦æ˜ å°„åˆ°æ‰€æœ‰è¿›ç¨‹ï¼ˆä¾‹å¦‚å…±äº«æ¨¡å—ï¼‰</span></span><br><span class="line">            ULONG ExtendedInfoPresent  : <span class="number">1</span>;  <span class="comment">// [bit 10]   æ˜¯å¦å­˜åœ¨æ‰©å±•æ˜ åƒä¿¡æ¯ï¼ˆIMAGE_INFO_EX ç»“æ„ï¼‰</span></span><br><span class="line">            ULONG MachineTypeMismatch  : <span class="number">1</span>;  <span class="comment">// [bit 11]   æ¶æ„ä¸åŒ¹é…æ ‡å¿—ï¼ˆå¦‚åŠ è½½ x86 æ¨¡å—åˆ° x64ï¼‰</span></span><br><span class="line">            ULONG ImageSignatureLevel  : <span class="number">4</span>;  <span class="comment">// [bit 12â€“15]æ˜ åƒç­¾åçº§åˆ«ï¼ˆWindows Defender é©±åŠ¨æ‰§è¡Œæ§åˆ¶çº§åˆ«ï¼‰</span></span><br><span class="line">            ULONG ImageSignatureType   : <span class="number">3</span>;  <span class="comment">// [bit 16â€“18]æ˜ åƒç­¾åç±»å‹ï¼ˆPE ç­¾åã€Catalog ç­‰ï¼‰</span></span><br><span class="line">            ULONG ImagePartialMap      : <span class="number">1</span>;  <span class="comment">// [bit 19]   å¦‚æœæ•´ä¸ªæ˜ åƒæœªå®Œå…¨æ˜ å°„åˆ™ä¸º 1ï¼ˆé€šå¸¸ç”¨äºç‰¹æ®ŠåŠ è½½æ–¹å¼ï¼‰</span></span><br><span class="line">            ULONG Reserved             : <span class="number">12</span>; <span class="comment">// [bit 20â€“31]ä¿ç•™å­—æ®µï¼ˆå¿…é¡»ä¸º 0ï¼Œä¾›ç³»ç»Ÿæœªæ¥ä½¿ç”¨ï¼‰</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    PVOID ImageBase;                        <span class="comment">// 0x04 / 0x08: æ˜ åƒæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„åŸºåœ°å€</span></span><br><span class="line">    ULONG ImageSelector;                    <span class="comment">// 0x08 / 0x10: ä¿ç•™å­—æ®µï¼Œä»…ç”¨äº x86ï¼ˆæ®µé€‰æ‹©å™¨ï¼Œç°ä»£ç³»ç»ŸåŸºæœ¬æ— ç”¨ï¼‰</span></span><br><span class="line">    SIZE_T ImageSize;                       <span class="comment">// 0x0C / 0x18: æ˜ åƒçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</span></span><br><span class="line">    ULONG ImageSectionNumber;              <span class="comment">// 0x10 / 0x20: æ‰€åŠ è½½æ˜ åƒåœ¨ PE æ–‡ä»¶ä¸­çš„èŠ‚ç´¢å¼•ï¼ˆå¯ç”¨äºè°ƒè¯•æˆ–å®šä½ç¬¦å·ï¼‰</span></span><br><span class="line"></span><br><span class="line">&#125; IMAGE_INFO, *PIMAGE_INFO;</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸºç¡€å›è°ƒæ³¨å†Œ-2"><a href="#åŸºç¡€å›è°ƒæ³¨å†Œ-2" class="headerlink" title="åŸºç¡€å›è°ƒæ³¨å†Œ"></a>åŸºç¡€å›è°ƒæ³¨å†Œ</h3><p>æ¨¡å—å›è°ƒå‡½æ•° <code>PLOAD_IMAGE_NOTIFY_ROUTINE</code> çš„æ³¨å†Œå’Œç§»é™¤å‡½æ•°æ˜¯ä¸¤ä¸ªä¸åŒçš„å‡½æ•°ï¼š</p>
<ul>
<li><p><strong>æ³¨å†Œæ¨¡å—å›è°ƒ</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsSetLoadImageNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PLOAD_IMAGE_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>ç§»é™¤æ¨¡å—å›è°ƒ</strong>ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">PsRemoveLoadImageNotifyRoutine</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PLOAD_IMAGE_NOTIFY_ROUTINE NotifyRoutine</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">VOID <span class="title function_">ImageLoadCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    PUNICODE_STRING FullImageName,</span></span><br><span class="line"><span class="params">    HANDLE ProcessId,</span></span><br><span class="line"><span class="params">    PIMAGE_INFO ImageInfo</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (FullImageName &amp;&amp; ProcessId != <span class="number">0</span>) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;è¿›ç¨‹ %p åŠ è½½æ˜ åƒï¼š%wZï¼ŒåŸºå€=%pï¼Œå¤§å°=0x%Ix\n&quot;</span>,</span><br><span class="line">                 ProcessId,</span><br><span class="line">                 FullImageName,</span><br><span class="line">                 ImageInfo-&gt;ImageBase,</span><br><span class="line">                 ImageInfo-&gt;ImageSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span><br><span class="line">&#123;</span><br><span class="line">    PsSetLoadImageNotifyRoutine(ImageLoadCallback);</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">    PsRemoveLoadImageNotifyRoutine(ImageLoadCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p>æ¨¡å—å›è°ƒçš„å¼€å…³ä½äº <code>PspNotifyEnableMask</code> çš„æœ€ä½ä½ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define PSP_NOTIFY_IMAGE 1</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="æ‰©å±•å›è°ƒæ³¨å†Œ-2"><a href="#æ‰©å±•å›è°ƒæ³¨å†Œ-2" class="headerlink" title="æ‰©å±•å›è°ƒæ³¨å†Œ"></a>æ‰©å±•å›è°ƒæ³¨å†Œ</h3><p><code>PsSetLoadImageNotifyRoutineEx</code> æ˜¯ Win10 å¼•å…¥çš„æ¨¡å—å›è°ƒæ³¨å†Œå‡½æ•°ï¼Œç›¸æ¯”äºæ—§çš„ <code>PsSetLoadImageNotifyRoutine</code>ï¼Œæ­¤ç‰ˆæœ¬æ”¯æŒä¼ å…¥ <strong>Flags å‚æ•°</strong>ï¼Œä»¥ä¾¿æ§åˆ¶å›è°ƒè¡Œä¸ºï¼Œå¦‚æ˜¯å¦é€šçŸ¥è·¨æ¶æ„ï¼ˆx86&#x2F;x64ï¼‰æ˜ åƒç­‰ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">PsSetLoadImageNotifyRoutineEx</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PLOAD_IMAGE_NOTIFY_ROUTINE NotifyRoutine,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR Flags</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>Flags</code> ç›®å‰å®˜æ–¹ä»…å®šä¹‰æ”¯æŒ <code>PS_IMAGE_NOTIFY_CONFLICTING_ARCHITECTURE(0x1)</code>ï¼Œè¡¨ç¤ºå¯ç”¨è·¨æ¶æ„é€šçŸ¥ï¼ˆä¾‹å¦‚ï¼šåœ¨ x64 ç³»ç»Ÿä¸Šä¹Ÿé€šçŸ¥åŠ è½½ x86 æ¨¡å—ï¼‰ã€‚</p>
<h1 id="å¯¹è±¡å›è°ƒï¼ˆObject-Callbacksï¼‰"><a href="#å¯¹è±¡å›è°ƒï¼ˆObject-Callbacksï¼‰" class="headerlink" title="å¯¹è±¡å›è°ƒï¼ˆObject Callbacksï¼‰"></a>å¯¹è±¡å›è°ƒï¼ˆObject Callbacksï¼‰</h1><p>æ—©æœŸé˜²æŠ¤è½¯ä»¶ä¸ºäº†æ‹¦æˆªå¯¹è¿›ç¨‹ã€çº¿ç¨‹ç­‰æ•æ„Ÿå¯¹è±¡çš„å¥æŸ„åˆ›å»º&#x2F;å¤åˆ¶ï¼Œæ™®éä½¿ç”¨ SSDT&#x2F;å†…æ ¸é’©å­ç­‰ä¾µå…¥å¼æŠ€æœ¯ï¼Œææ˜“å¼•å‘ç³»ç»Ÿä¸ç¨³å®šã€‚è‡ª <strong>Windows Vista SP1 &#x2F; Windows Server 2008</strong> èµ·ï¼Œå¾®è½¯åœ¨ Object Manager ä¸Šæä¾›äº† å¯¹<strong>è±¡å›è°ƒæœºåˆ¶ï¼ˆObject Callbacksï¼‰</strong>ã€‚</p>
<p>åœ¨Windowså†…æ ¸ä¸­ï¼Œ<strong>å¯¹è±¡å›è°ƒæœºåˆ¶ï¼ˆObject Callbacksï¼‰</strong>æ˜¯ä¸€ç§å®‰å…¨å’Œç›‘æ§æœºåˆ¶ï¼Œå…è®¸å†…æ ¸æ¨¡å¼é©±åŠ¨ç¨‹åºæ³¨å†Œç‰¹å®šçš„å›è°ƒå‡½æ•°ï¼Œä»¥ç›‘è§†æˆ–æ‹¦æˆªå¯¹æŸäº›å†…æ ¸å¯¹è±¡ï¼ˆä¾‹å¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ–‡ä»¶ç­‰ï¼‰çš„æ“ä½œã€‚</p>
<h2 id="å¯¹è±¡å›è°ƒä½¿ç”¨"><a href="#å¯¹è±¡å›è°ƒä½¿ç”¨" class="headerlink" title="å¯¹è±¡å›è°ƒä½¿ç”¨"></a>å¯¹è±¡å›è°ƒä½¿ç”¨</h2><h3 id="å›è°ƒæ³¨å†Œå¸è½½"><a href="#å›è°ƒæ³¨å†Œå¸è½½" class="headerlink" title="å›è°ƒæ³¨å†Œå¸è½½"></a>å›è°ƒæ³¨å†Œå¸è½½</h3><p>å¯¹è±¡å›è°ƒæœºåˆ¶æä¾›äº†ä¸“é—¨çš„å†…æ ¸å‡½æ•°ï¼Œç”¨äºé©±åŠ¨ç¨‹åºæ³¨å†Œå’Œå¸è½½å›è°ƒï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ³¨å†Œå¯¹è±¡è®¿é—®å›è°ƒï¼ˆä¾‹å¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨é”®ç­‰çš„å¥æŸ„åˆ›å»º/å¤åˆ¶æ“ä½œï¼‰</span></span><br><span class="line"><span class="comment">// å…è®¸é©±åŠ¨æ‹¦æˆªå¹¶ä¿®æ”¹è®¿é—®æƒé™ï¼Œæˆ–è¿›è¡Œå®‰å…¨æ£€æŸ¥ä¸æ—¥å¿—è®°å½•</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">NTKERNELAPI</span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">ObRegisterCallbacks</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ POB_CALLBACK_REGISTRATION CallbackRegistration,  <span class="comment">// æŒ‡å‘ OB_CALLBACK_REGISTRATION ç»“æ„ä½“ï¼š</span></span></span><br><span class="line"><span class="params">                                                          <span class="comment">// - æŒ‡å®šç›‘æ§çš„å¯¹è±¡ç±»å‹ï¼ˆå¦‚ PsProcessTypeï¼‰</span></span></span><br><span class="line"><span class="params">                                                          <span class="comment">// - æŒ‡å®šå›è°ƒå‡½æ•°ï¼ˆPreOperation / PostOperationï¼‰</span></span></span><br><span class="line"><span class="params">                                                          <span class="comment">// - æŒ‡å®šç›‘æ§çš„æ“ä½œç±»å‹ï¼ˆåˆ›å»ºå¥æŸ„ / å¤åˆ¶å¥æŸ„ï¼‰</span></span></span><br><span class="line"><span class="params">                                                          <span class="comment">// - Altitudeï¼šå›è°ƒä¼˜å…ˆçº§å­—ç¬¦ä¸²ï¼ˆå¿…é¡»å”¯ä¸€ï¼‰</span></span></span><br><span class="line"><span class="params">    _Outptr_ PVOID *RegistrationHandle                     <span class="comment">// [è¾“å‡º] è¿”å›æ³¨å†Œåçš„å¥æŸ„ï¼ˆä¿å­˜é©±åŠ¨å†…éƒ¨å˜é‡ä¸­ï¼‰ï¼Œ</span></span></span><br><span class="line"><span class="params">                                                          <span class="comment">// å¯ç”¨äºåç»­é€šè¿‡ ObUnRegisterCallbacks å–æ¶ˆå›è°ƒ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ³¨é”€å›è°ƒå‡½æ•°ï¼Œé‡Šæ”¾å…ˆå‰æ³¨å†Œçš„ç›‘æ§è¡Œä¸º</span></span><br><span class="line"><span class="comment">// è‹¥é©±åŠ¨å¸è½½å‰æœªæ³¨é”€ï¼Œå°†å¯¼è‡´ BSODï¼ˆæŒ‚æ‰ï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">NTKERNELAPI</span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">ObUnRegisterCallbacks</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID RegistrationHandle                         <span class="comment">// é€šè¿‡ ObRegisterCallbacks è¿”å›çš„æ³¨å†Œå¥æŸ„</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p><code>ObRegisterCallbacks</code> åŒæ ·è¦æ±‚é©±åŠ¨ç­¾åï¼Œå› æ­¤ä¾æ—§éœ€è¦è¿›ç¨‹æ‰©å±•å›è°ƒçš„ç»•è¿‡æ–¹æ³•ã€‚</p>

    </div>
  </div>

<p>å…¶ä¸­ <code>OB_CALLBACK_REGISTRATION</code> ç»“æ„ç”¨äºæè¿°ä¸€æ¬¡å¯¹è±¡è®¿é—®å›è°ƒæ³¨å†Œè¯·æ±‚ï¼ŒåŒ…å«å›è°ƒçš„å…ƒä¿¡æ¯ã€ç›®æ ‡å¯¹è±¡ç±»å‹ã€å›è°ƒå‡½æ•°æ•°ç»„ç­‰ã€‚è¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç»“æ„ä½“: OB_CALLBACK_REGISTRATION</span></span><br><span class="line"><span class="comment">// ç”¨é€”: ç”¨äºæè¿°ä¸€æ¬¡å¯¹è±¡è®¿é—®å›è°ƒæ³¨å†Œè¯·æ±‚ï¼ŒåŒ…å«å›è°ƒçš„å…ƒä¿¡æ¯ã€ç›®æ ‡å¯¹è±¡ç±»å‹ã€å›è°ƒå‡½æ•°æ•°ç»„ç­‰ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¸¸ç”¨äºè°ƒç”¨ ObRegisterCallbacks æ—¶å¡«å†™ï¼Œæ³¨å†Œç”¨äºç›‘æ§è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨ç­‰å¯¹è±¡è®¿é—®è¡Œä¸ºã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_CALLBACK_REGISTRATION</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç»“æ„ä½“ç‰ˆæœ¬å·ï¼Œå¿…é¡»è®¾ç½®ä¸º OB_FLT_REGISTRATION_VERSIONï¼ˆå½“å‰ä¸º 0x100ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    USHORT Version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// OperationRegistration æ•°ç»„çš„å…ƒç´ æ•°é‡ï¼Œå³è¦æ³¨å†Œçš„å¯¹è±¡ç±»å‹æ•°é‡ï¼ˆé€šå¸¸ä¸º 1~3ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    USHORT OperationRegistrationCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å›è°ƒé«˜åº¦å­—ç¬¦ä¸²ï¼Œç”¨äºæ’åºæ‰§è¡Œé¡ºåºã€‚</span></span><br><span class="line">    <span class="comment">// Altitude å¿…é¡»æ˜¯å…¨ç³»ç»Ÿå”¯ä¸€çš„å­—ç¬¦ä¸²ï¼Œå¦åˆ™æ³¨å†Œå¤±è´¥ï¼ˆå»ºè®®æ ¼å¼ï¼š&lt;æ•°å­—&gt;.&lt;é©±åŠ¨/äº§å“æ ‡è¯†ç¬¦&gt;ï¼‰</span></span><br><span class="line">    <span class="comment">// è¶Šä½çš„å€¼è¶Šæ—©æ‰§è¡Œï¼ˆå®‰å…¨è½¯ä»¶å¸¸æ³¨å†Œè¾ƒä½å€¼ä»¥ä¼˜å…ˆæ‹¦æˆªï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    UNICODE_STRING Altitude;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œåœ¨ PreOperation/PostOperation å›è°ƒä¸­å¯é€šè¿‡ RegistrationContext å‚æ•°è·å–</span></span><br><span class="line">    <span class="comment">// å¯ç”¨äºä¼ é€’é©±åŠ¨è‡ªå·±çš„çŠ¶æ€ç»“æ„ç­‰ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    PVOID RegistrationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘ OB_OPERATION_REGISTRATION æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡ç±»å‹åŠå…¶æ“ä½œå›è°ƒé…ç½®</span></span><br><span class="line">    <span class="comment">// é€šå¸¸è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªé¡¹ï¼Œä¾‹å¦‚è¿›ç¨‹å¯¹è±¡ã€çº¿ç¨‹å¯¹è±¡ç­‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    OB_OPERATION_REGISTRATION* OperationRegistration;</span><br><span class="line">&#125; OB_CALLBACK_REGISTRATION, *POB_CALLBACK_REGISTRATION;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <ul>
<li><code>Version</code>ï¼š ç»“æ„ä½“ç‰ˆæœ¬å·ï¼Œå¿…é¡»è®¾ç½®ä¸º <code>OB_FLT_REGISTRATION_VERSION(0x100)</code>ï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢æœªæ¥çš„å…¼å®¹æ€§é—®é¢˜ï¼Œ<strong>å»ºè®®ä½¿ç”¨ <code>ObGetFilterVersion</code> å‡½æ•°åŠ¨æ€è·å–</strong>ã€‚</li>
<li><code>Altitude</code>ï¼šå¾®è½¯åœ¨å†…æ ¸å›è°ƒæœºåˆ¶ï¼ˆå°¤å…¶æ˜¯<strong>å¯¹è±¡ç®¡ç†å™¨å›è°ƒ</strong>å’Œ<strong>æ–‡ä»¶è¿‡æ»¤é©±åŠ¨</strong>ï¼‰ä¸­ç”¨äº<strong>æ’åºæ‰§è¡Œä¼˜å…ˆçº§</strong>çš„æœºåˆ¶ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å…¨å±€å”¯ä¸€çš„å­—ç¬¦ä¸²è¡¨ç¤ºçš„â€œé«˜åº¦å€¼â€</strong>ã€‚ä¸ºäº†åŒæ—¶æ”¯æŒ<strong>ä¼˜å…ˆçº§æ’åº</strong>å’Œ<strong>é˜…è¯»ä¸åŒºåˆ†</strong>ï¼Œè¦æ±‚æ ¼å¼ä¸º <code>&lt;æ•°å­—&gt;.&lt;é©±åŠ¨/äº§å“æ ‡è¯†ç¬¦&gt;</code>ï¼Œä¾‹å¦‚ <code>320000.MyDriverName</code>ã€‚</li>
<li><code>RegistrationContext</code>ï¼šå®šä¹‰ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œä¼šä½œä¸ºå‚æ•° <code>RegistrationContext</code> ä¼ é€’ç»™æ¯æ¬¡è§¦å‘çš„ <code>PreOperation</code> &#x2F; <code>PostOperation</code> å›è°ƒå‡½æ•°ã€‚</li>
</ul>

    </div>
  </div>

<p>æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°ä½äº <code>OperationRegistration</code> æŒ‡å‘çš„ <code>OB_OPERATION_REGISTRATION</code> ç»“æ„ä½“æ•°ç»„ï¼Œå…¶ä¸­ <code>OperationRegistrationCount</code> è¡¨ç¤ºæ•°ç»„ä¸­å…ƒç´ çš„æ•°é‡ã€‚<code>OB_OPERATION_REGISTRATION</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç»“æ„ä½“: OB_OPERATION_REGISTRATION</span></span><br><span class="line"><span class="comment">// ç”¨é€”: æè¿°é©±åŠ¨å¸Œæœ›æ‹¦æˆªçš„å¯¹è±¡ç±»å‹ã€æ“ä½œç±»å‹ä»¥åŠå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">//       æ¯ä¸ª OB_OPERATION_REGISTRATION é¡¹è¡¨ç¤ºä¸€ç±»å¯¹è±¡ï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ï¼‰çš„è®¿é—®è¡Œä¸ºæ‹¦æˆªé…ç½®ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ­¤ç»“æ„ä½“æ˜¯ OB_CALLBACK_REGISTRATION ä¸­çš„ OperationRegistration æˆå‘˜çš„å…ƒç´ ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_OPERATION_REGISTRATION</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æŒ‡å‘è¦ç›‘æ§çš„å¯¹è±¡ç±»å‹çš„å…¨å±€æŒ‡é’ˆï¼Œä¾‹å¦‚ï¼š</span></span><br><span class="line">    <span class="comment">//   - PsProcessType è¡¨ç¤ºè¿›ç¨‹å¯¹è±¡ï¼ˆ&quot;Process&quot;ï¼‰</span></span><br><span class="line">    <span class="comment">//   - PsThreadType  è¡¨ç¤ºçº¿ç¨‹å¯¹è±¡ï¼ˆ&quot;Thread&quot;ï¼‰</span></span><br><span class="line">    <span class="comment">//   - ExEventObjectType è¡¨ç¤ºäº‹ä»¶å¯¹è±¡</span></span><br><span class="line">    <span class="comment">//   - CmKeyObjectType è¡¨ç¤ºæ³¨å†Œè¡¨é”®ï¼ˆéœ€åŒ…å« ntddk.h å¹¶å¼€å¯ç‰¹å®šç‰ˆæœ¬æ”¯æŒï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ³¨ï¼šè¿™äº›å¯¹è±¡ç±»å‹ç”±ç³»ç»Ÿå¯¼å‡ºï¼Œä¸èƒ½è‡ªå·±æ„é€ ï¼›ä¹Ÿä¸èƒ½æ¯”è¾ƒå­—ç¬¦ä¸²åç§°ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ POBJECT_TYPE *ObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¦æ‹¦æˆªçš„æ“ä½œç±»å‹ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€æˆ–ç»„åˆï¼š</span></span><br><span class="line">    <span class="comment">//   - OB_OPERATION_HANDLE_CREATEï¼šè¡¨ç¤ºç”¨æˆ·åˆ›å»ºå¯¹è±¡å¥æŸ„ï¼ˆå¦‚ ZwOpenProcessï¼‰</span></span><br><span class="line">    <span class="comment">//   - OB_OPERATION_HANDLE_DUPLICATEï¼šè¡¨ç¤ºå¤åˆ¶å·²æœ‰å¯¹è±¡å¥æŸ„ï¼ˆå¦‚ DuplicateHandleï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç¤ºä¾‹ï¼šæ‹¦æˆªåˆ›å»ºå’Œå¤åˆ¶æ“ä½œ</span></span><br><span class="line">    <span class="comment">//   Operations = OB_OPERATION_HANDLE_CREATE | OB_OPERATION_HANDLE_DUPLICATE;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ OB_OPERATION Operations;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// é¢„æ“ä½œå›è°ƒå‡½æ•°ï¼Œåœ¨å¯¹è±¡å¥æŸ„åˆ›å»ºæˆ–å¤åˆ¶ä¹‹å‰è¢«è°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="comment">// å¯ä»¥æ£€æŸ¥è®¿é—®æƒé™ã€å¯¹è±¡å±æ€§ç­‰ï¼Œç”šè‡³æ‹’ç»è®¿é—®ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å›è°ƒå‡½æ•°ç±»å‹ä¸ºï¼š</span></span><br><span class="line">    <span class="comment">// OB_PREOP_CALLBACK_STATUS</span></span><br><span class="line">    <span class="comment">// (*POB_PRE_OPERATION_CALLBACK)(_Inout_ POB_PRE_OPERATION_INFORMATION OperationInformation);</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¿”å› OB_PREOP_SUCCESS è¡¨ç¤ºç»§ç»­ï¼›</span></span><br><span class="line">    <span class="comment">// è¿”å› OB_PREOP_COMPLETE è¡¨ç¤ºå–æ¶ˆï¼Œå¹¶è·³è¿‡åç»­æ“ä½œã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ POB_PRE_OPERATION_CALLBACK PreOperation;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åæ“ä½œå›è°ƒå‡½æ•°ï¼Œåœ¨å¥æŸ„åˆ›å»º/å¤åˆ¶å®Œæˆåè°ƒç”¨ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="comment">// ä¸€èˆ¬ç”¨äºè®°å½•æ—¥å¿—æˆ–æ‰§è¡Œæ”¶å°¾æ“ä½œï¼Œä¸èƒ½ä¿®æ”¹è®¿é—®æƒé™ã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å›è°ƒå‡½æ•°ç±»å‹ä¸ºï¼š</span></span><br><span class="line">    <span class="comment">// VOID (*POB_POST_OPERATION_CALLBACK)(_In_ POB_POST_OPERATION_INFORMATION OperationInformation);</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è‹¥ä¸éœ€è¦åå¤„ç†ï¼Œå¯è®¾ä¸º NULLã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ POB_POST_OPERATION_CALLBACK PostOperation;</span><br><span class="line"></span><br><span class="line">&#125; OB_OPERATION_REGISTRATION, *POB_OPERATION_REGISTRATION;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªç»“æ„ä½“æè¿°äº†æˆ‘ä»¬è¦æ³¨å†Œçš„<strong>å›è°ƒå‡½æ•°</strong>ï¼Œä»¥åŠå›è°ƒå‡½æ•°ç›‘æ§çš„<strong>å¯¹è±¡</strong>å’Œ<strong>äº‹ä»¶</strong>ã€‚</p>
<ul>
<li><p>é¦–å…ˆç›‘æ§<strong>å¯¹è±¡</strong>é€šè¿‡ <code>ObjectType</code> å­—æ®µæè¿°ï¼Œè¿™ä¸ªå­—æ®µæè¿°è¦æ‹¦æˆªçš„<strong>å¯¹è±¡ç§ç±»</strong>ï¼Œå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨é¡¹ç­‰ã€‚æˆ‘ä»¬éœ€è¦å°†å…¶å¡«å……ä¸ºä¸€ä¸ªç³»ç»Ÿå¯¼å‡ºçš„å…¨å±€çš„å¯¹è±¡ç±»å‹æè¿°ç¬¦æŒ‡é’ˆã€‚</p>
<table>
<thead>
<tr>
<th>å¯¹è±¡åç§°</th>
<th>ç¬¦å·</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>è¿›ç¨‹</td>
<td><code>PsProcessType</code></td>
<td>æ‰€æœ‰ <code>EPROCESS</code> å¯¹è±¡</td>
</tr>
<tr>
<td>çº¿ç¨‹</td>
<td><code>PsThreadType</code></td>
<td>æ‰€æœ‰ <code>ETHREAD</code> å¯¹è±¡</td>
</tr>
<tr>
<td>æ³¨å†Œè¡¨é”®</td>
<td><code>CmKeyObjectType</code></td>
<td>æ‰€æœ‰æ³¨å†Œè¡¨é¡¹å¯¹è±¡ï¼ˆ<code>KEY_OBJECT</code>ï¼‰</td>
</tr>
<tr>
<td>äº‹ä»¶</td>
<td><code>ExEventObjectType</code></td>
<td>äº‹ä»¶å¯¹è±¡ï¼ˆéç”¨æˆ·äº‹ä»¶ï¼‰</td>
</tr>
<tr>
<td>ä¿¡å·é‡ç­‰</td>
<td><code>ExSemaphoreObjectType</code></td>
<td>åŒæ­¥å¯¹è±¡ï¼ˆéƒ¨åˆ†å¯è§ï¼‰</td>
</tr>
</tbody></table>
</li>
<li><p>ç›‘æ§<strong>äº‹ä»¶</strong>é€šè¿‡ <code>Operations</code> å­—æ®µæè¿°ï¼Œç”¨äºæŒ‡å®šæ‹¦æˆªçš„<strong>æ“ä½œç±»å‹</strong>ï¼ˆæ˜¯å¥æŸ„çš„åˆ›å»ºï¼Œè¿˜æ˜¯å¥æŸ„çš„å¤åˆ¶ï¼‰ã€‚è¯¥å­—æ®µæ˜¯ä¸€ä¸ªä½æ ‡å¿—ï¼ˆflagsï¼‰ï¼Œå€¼å¯ä»¥ä¸ºä»¥ä¸‹ä¹‹ä¸€æˆ–ç»„åˆï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OB_OPERATION_HANDLE_CREATE     0x00000001  <span class="comment">// ä¾‹å¦‚ ZwOpenProcess</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OB_OPERATION_HANDLE_DUPLICATE  0x00000002  <span class="comment">// ä¾‹å¦‚ DuplicateHandle</span></span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>OB_OPERATION_HANDLE_CREATE</code>ï¼šå½“ç³»ç»Ÿæ‰§è¡Œ<strong>åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡å¥æŸ„ï¼ˆhandleï¼‰</strong>æ—¶è§¦å‘æ­¤äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯<strong>ä»ç”¨æˆ·æ€è¯·æ±‚è®¿é—®æŸä¸ªå¯¹è±¡</strong>ï¼Œæ¯”å¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨é¡¹ç­‰ï¼Œè¿›å…¥å†…æ ¸åå‡†å¤‡è¿”å›ä¸€ä¸ªå¥æŸ„ã€‚</li>
<li><code>OB_OPERATION_HANDLE_DUPLICATE</code>ï¼šå½“ç³»ç»Ÿæ‰§è¡Œ<strong>å¤åˆ¶ä¸€ä¸ªå·²å­˜åœ¨çš„å¯¹è±¡å¥æŸ„</strong>æ—¶è§¦å‘æ­¤äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹å¸Œæœ›å°†å·²æœ‰å¥æŸ„å¤åˆ¶åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„å¥æŸ„è¡¨ä¸­ã€‚å¯¹åº”çš„ API ä¸º <code>ZwDuplicateObject</code>ã€‚</li>
</ul>
</li>
<li><p><code>OB_OPERATION_REGISTRATION</code> ä¸­æä¾›ä¸¤ç§ç±»å‹çš„<strong>å›è°ƒå‡½æ•°</strong> <code>PreOperation</code> å’Œ <code>PostOperation</code>ã€‚å…¶ä¸­ï¼š</p>
<ul>
<li><code>PreOperation</code>ï¼šåœ¨<strong>å¥æŸ„åˆ›å»º&#x2F;å¤åˆ¶å‘ç”Ÿä¹‹å‰</strong>è°ƒç”¨ï¼Œå…è®¸å›è°ƒå‡½æ•°ä¿®æ”¹è®¿é—®æƒé™ï¼Œç›´æ¥é˜»æ­¢è®¿é—®è¡Œä¸ºã€‚</li>
<li><code>PostOperation</code>ï¼šåœ¨<strong>å¥æŸ„åˆ›å»º&#x2F;å¤åˆ¶å®Œæˆä¹‹å</strong>è°ƒç”¨ï¼Œä¸å†å…è®¸ä¿®æ”¹è®¿é—®æƒé™ã€‚</li>
</ul>
<p>æ³¨æ„è¿™ä¸¤ä¸ªå›è°ƒå‡½æ•°è‡³å°‘éœ€è¦å¡«å†™ä¸€ä¸ªã€‚</p>
</li>
</ul>
<p>å›è°ƒå‡½æ•°æ³¨å†Œçš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstrsafe.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KLDR_DATA_TABLE_ENTRY</span> &#123;</span></span><br><span class="line">    LIST_ENTRY InLoadOrderLinks;</span><br><span class="line">    ULONG __Undefined1;</span><br><span class="line">    ULONG __Undefined2;</span><br><span class="line">    ULONG __Undefined3;</span><br><span class="line">    ULONG NonPagedDebugInfo;</span><br><span class="line">    ULONG DllBase;</span><br><span class="line">    ULONG EntryPoint;</span><br><span class="line">    ULONG SizeOfImage;</span><br><span class="line">    UNICODE_STRING FullDllName;</span><br><span class="line">    UNICODE_STRING BaseDllName;</span><br><span class="line">    ULONG Flags;</span><br><span class="line">    <span class="comment">// ...(åç»­å­—æ®µçœç•¥)</span></span><br><span class="line">&#125; KLDR_DATA_TABLE_ENTRY, *PKLDR_DATA_TABLE_ENTRY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›è°ƒå¥æŸ„ï¼Œå…¨å±€ä¿å­˜ç”¨äºå¸è½½æ—¶æ³¨é”€</span></span><br><span class="line"><span class="type">static</span> PVOID g_ObCallbackHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// é©±åŠ¨å¸è½½å‡½æ•°ï¼šæ³¨é”€å›è°ƒ</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">VOID <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(DriverObject);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_ObCallbackHandle) &#123;</span><br><span class="line">        ObUnRegisterCallbacks(g_ObCallbackHandle);</span><br><span class="line">        g_ObCallbackHandle = <span class="literal">NULL</span>;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Ob callback unregistered.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;Driver unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// é©±åŠ¨å…¥å£ï¼šæ³¨å†Œå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span><br><span class="line">&#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(RegistryPath);</span><br><span class="line"></span><br><span class="line">    PKLDR_DATA_TABLE_ENTRY DataTableEntry;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»•è¿‡é©±åŠ¨ç­¾åæ£€æµ‹</span></span><br><span class="line">    DataTableEntry = (PKLDR_DATA_TABLE_ENTRY)DriverObject-&gt;DriverSection;</span><br><span class="line">    DataTableEntry-&gt;Flags |= <span class="number">0x20</span>;</span><br><span class="line"></span><br><span class="line">    OB_CALLBACK_REGISTRATION callbackReg = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    OB_OPERATION_REGISTRATION opReg = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    UNICODE_STRING altitude = RTL_CONSTANT_STRING(<span class="string">L&quot;320000.MyProcessProtector&quot;</span>);</span><br><span class="line"></span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¡«å†™æ“ä½œæ³¨å†Œç»“æ„ï¼ˆè¿›ç¨‹å¯¹è±¡ + åˆ›å»ºå¥æŸ„æ“ä½œï¼‰</span></span><br><span class="line">    opReg.ObjectType = *PsProcessType;</span><br><span class="line">    opReg.Operations = OB_OPERATION_HANDLE_CREATE;</span><br><span class="line">    opReg.PreOperation = PreProcessHandleCreateCallback;</span><br><span class="line">    opReg.PostOperation = PostProcessHandleCreateCallback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¡«å†™å›è°ƒæ³¨å†Œç»“æ„</span></span><br><span class="line">    callbackReg.Version = ObGetFilterVersion();  <span class="comment">// æ¨èä½¿ç”¨åŠ¨æ€ç‰ˆæœ¬</span></span><br><span class="line">    callbackReg.OperationRegistrationCount = <span class="number">1</span>;</span><br><span class="line">    callbackReg.Altitude = altitude;</span><br><span class="line">    callbackReg.RegistrationContext = <span class="literal">NULL</span>;</span><br><span class="line">    callbackReg.OperationRegistration = &amp;opReg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œå›è°ƒ</span></span><br><span class="line">    NTSTATUS status = ObRegisterCallbacks(&amp;callbackReg, &amp;g_ObCallbackHandle);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;ObRegisterCallbacks failed: 0x%08X\n&quot;</span>, status);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;Ob callback registered successfully.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="é¢„æ“ä½œå›è°ƒå‡½æ•°"><a href="#é¢„æ“ä½œå›è°ƒå‡½æ•°" class="headerlink" title="é¢„æ“ä½œå›è°ƒå‡½æ•°"></a>é¢„æ“ä½œå›è°ƒå‡½æ•°</h3><p><strong>é¢„æ“ä½œå›è°ƒå‡½æ•°</strong>æ˜¯ Windows å†…æ ¸åœ¨æ‰§è¡ŒæŸäº›å¯¹è±¡è®¿é—®æ“ä½œï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨é”®çš„å¥æŸ„åˆ›å»ºæˆ–å¤åˆ¶ï¼‰ä¹‹å‰ï¼Œè°ƒç”¨é©±åŠ¨æä¾›çš„<strong>æ‹¦æˆªå¤„ç†å‡½æ•°</strong>ã€‚é¢„æ“ä½œå›è°ƒå‡½æ•°ç±»å‹å£°æ˜å¦‚ä¸‹ï¼Œè¯¥å‡½æ•°ä¼šåœ¨ï¼Œ<strong>åœ¨å¯¹è±¡çš„å¥æŸ„å°šæœªåˆ›å»ºä¹‹å‰</strong>è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// å‡½æ•°ç±»å‹: POB_PRE_OPERATION_CALLBACK</span></span><br><span class="line"><span class="comment">// ç”¨é€”: å®šä¹‰é¢„æ“ä½œå›è°ƒå‡½æ•°çš„å‡½æ•°æŒ‡é’ˆç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">//       å½“è¿›ç¨‹å°è¯•åˆ›å»ºæˆ–å¤åˆ¶å¯¹è±¡å¥æŸ„æ—¶ï¼ˆå¦‚ ZwOpenProcessï¼‰ï¼Œç³»ç»Ÿå°†åœ¨å¥æŸ„åˆ›å»ºå‰è°ƒç”¨æ­¤å‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">//       é©±åŠ¨å¯æ ¹æ®è®¿é—®ç›®æ ‡ã€æƒé™è¯·æ±‚å†³å®šæ˜¯å¦ä¿®æ”¹æƒé™æˆ–æ‹’ç»è®¿é—®ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">OB_PREOP_CALLBACK_STATUS</span></span><br><span class="line"><span class="params">(*POB_PRE_OPERATION_CALLBACK)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_    PVOID RegistrationContext,                          <span class="comment">// æ³¨å†Œæ—¶æä¾›çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œé©±åŠ¨å¯ç”¨äºä¼ é€’çŠ¶æ€æˆ–é…ç½®</span></span></span><br><span class="line"><span class="params">    _Inout_ POB_PRE_OPERATION_INFORMATION OperationInformation  <span class="comment">// åŒ…å«æ­¤æ¬¡å¯¹è±¡è®¿é—®æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ä¸‹ç»“æ„ï¼‰</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content">
      <p>é¢„æ“ä½œå›è°ƒå‡½æ•°åªèƒ½è¿”å› <code>OB_PREOP_SUCCESS</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">OB_PREOP_CALLBACK_STATUS</span> &#123;</span></span><br><span class="line">    OB_PREOP_SUCCESS</span><br><span class="line">&#125; OB_PREOP_CALLBACK_STATUS, *POB_PREOP_CALLBACK_STATUS;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>å…¶ä¸­ <code>RegistrationContext</code> å‚æ•°æ¥è‡ªäºæ³¨å†Œå›è°ƒå‡½æ•°æ—¶ <code>OB_CALLBACK_REGISTRATION</code> ç»“æ„ä½“çš„ <code>RegistrationContext</code> æˆå‘˜ï¼Œç”¨äºä¼ é€’ç”¨æˆ·è‡ªå®šä¹‰çš„å‚æ•°ã€‚</p>
<p>å¦å¤– <code>OperationInformation</code> å‚æ•°å­˜æ”¾äº†å‘ç”Ÿå›è°ƒæ—¶ä¿å­˜çš„ä¿¡æ¯ï¼Œè¯¥å‚æ•°å¯¹åº”çš„ <code>OB_PRE_OPERATION_INFORMATION</code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç»“æ„ä½“: OB_PRE_OPERATION_INFORMATION</span></span><br><span class="line"><span class="comment">// ç”¨é€”: æè¿°ä¸€æ¬¡â€œé¢„æ“ä½œâ€å›è°ƒä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”¨äºåˆ†æå½“å‰å¯¹è±¡è®¿é—®è¡Œä¸ºã€‚</span></span><br><span class="line"><span class="comment">//       æä¾›å¯¹è±¡ç±»å‹ã€ç›®æ ‡å¯¹è±¡ã€è®¿é—®æƒé™ç­‰å…³é”®å‚æ•°ï¼Œä¾›é©±åŠ¨è¿›è¡Œæ§åˆ¶ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_PRE_OPERATION_INFORMATION</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å½“å‰æ“ä½œç±»å‹ï¼š</span></span><br><span class="line">    <span class="comment">//   - OB_OPERATION_HANDLE_CREATEï¼ˆ0x1ï¼‰ï¼šè¯·æ±‚åˆ›å»ºå¯¹è±¡å¥æŸ„</span></span><br><span class="line">    <span class="comment">//   - OB_OPERATION_HANDLE_DUPLICATEï¼ˆ0x2ï¼‰ï¼šè¯·æ±‚å¤åˆ¶å¯¹è±¡å¥æŸ„</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ OB_OPERATION Operation;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        _In_ ULONG Flags;         <span class="comment">// ä½æ ‡å¿—å­—æ®µï¼Œå½“å‰ä»…å®šä¹‰äº† KernelHandle ä½</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            _In_ ULONG KernelHandle : <span class="number">1</span>; <span class="comment">// è‹¥ä¸º 1ï¼Œè¡¨ç¤ºæ­¤æ“ä½œä¸ºå†…æ ¸å¥æŸ„æ“ä½œï¼Œé©±åŠ¨ä¸å¯å¹²é¢„</span></span><br><span class="line">            _In_ ULONG Reserved     : <span class="number">31</span>;<span class="comment">// ä¿ç•™ï¼Œå¿…é¡»å¿½ç•¥</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¢«è®¿é—®çš„å¯¹è±¡æŒ‡é’ˆï¼Œä¾‹å¦‚ PEPROCESSï¼ˆè¿›ç¨‹ï¼‰ã€PETHREADï¼ˆçº¿ç¨‹ï¼‰ã€PCM_KEY_BODYï¼ˆæ³¨å†Œè¡¨é”®ï¼‰ç­‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ PVOID Object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¢«è®¿é—®å¯¹è±¡çš„ç±»å‹æŒ‡é’ˆï¼Œç”¨äºåˆ¤æ–­å½“å‰å¯¹è±¡å±äºå“ªç±»ï¼ˆå¦‚ PsProcessTypeï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ POBJECT_TYPE ObjectType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç”¨æˆ·å¯è¯»å†™å­—æ®µï¼Œç”¨äºé©±åŠ¨åœ¨ PreOperation ä¸­è®¾ç½®è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼Œ</span></span><br><span class="line">    <span class="comment">// åç»­å¯åœ¨ PostOperation ä¸­é€šè¿‡è¯¥å­—æ®µè·å–ï¼ˆç”¨äºè·¨é˜¶æ®µå…±äº«çŠ¶æ€ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _Out_ PVOID CallContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åŒ…å«è®¿é—®æ“ä½œçš„å‚æ•°ä¿¡æ¯ï¼ˆè”åˆä½“ï¼Œä¾æ“ä½œç±»å‹ä¸åŒè€Œå¼‚ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    _In_ POB_PRE_OPERATION_PARAMETERS Parameters;</span><br><span class="line"></span><br><span class="line">&#125; OB_PRE_OPERATION_INFORMATION, *POB_PRE_OPERATION_INFORMATION;</span><br></pre></td></tr></table></figure></div>

<p><code>OB_PRE_OPERATION_INFORMATION</code> ç»“æ„ä½“ä¸»è¦æè¿°äº†<strong>äº‹ä»¶ç±»å‹</strong>å’Œ<strong>å†…æ ¸å¯¹è±¡</strong>ç›¸å…³ä¿¡æ¯ã€‚</p>
<p>ç”±äºäº‹ä»¶åˆ†ä¸º <code>CREATE</code> å’Œ <code>DUPLICATE</code> ä¸¤ç§ï¼Œå› æ­¤äº‹ä»¶å‚æ•°å­—æ®µ <code>Parameters</code> æ˜¯ä¸€ä¸ªè”åˆä½“ <code>OB_PRE_OPERATION_PARAMETERS</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// è”åˆä½“: OB_PRE_OPERATION_PARAMETERS</span></span><br><span class="line"><span class="comment">// ç”¨é€”: æ ¹æ®å½“å‰æ“ä½œç±»å‹ï¼ˆCREATE / DUPLICATEï¼‰æä¾›ä¸åŒçš„è®¿é—®å‚æ•°ç»“æ„ã€‚</span></span><br><span class="line"><span class="comment">//       é©±åŠ¨åœ¨å›è°ƒä¸­é€šè¿‡ Operation å­—æ®µåˆ¤æ–­åé€‰æ‹©è®¿é—®å¯¹åº”æˆå‘˜ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">OB_PRE_OPERATION_PARAMETERS</span> &#123;</span></span><br><span class="line">    OB_PRE_CREATE_HANDLE_INFORMATION      CreateHandleInformation;     <span class="comment">// ç”¨äº OB_OPERATION_HANDLE_CREATE</span></span><br><span class="line">    OB_PRE_DUPLICATE_HANDLE_INFORMATION   DuplicateHandleInformation;  <span class="comment">// ç”¨äº OB_OPERATION_HANDLE_DUPLICATE</span></span><br><span class="line">&#125; OB_PRE_OPERATION_PARAMETERS, *POB_PRE_OPERATION_PARAMETERS;</span><br></pre></td></tr></table></figure></div>

<p><strong><code>CREATE</code> äº‹ä»¶</strong>çš„å‚æ•°æ˜¯é€šè¿‡ <code>OB_PRE_CREATE_HANDLE_INFORMATION</code> ç»“æ„ä½“æè¿°ï¼Œè¯¥ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç»“æ„ä½“: OB_PRE_CREATE_HANDLE_INFORMATION</span></span><br><span class="line"><span class="comment">// ç”¨é€”: å½“è¿›ç¨‹è¯·æ±‚åˆ›å»ºæŸå¯¹è±¡ï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€æ³¨å†Œè¡¨ï¼‰çš„å¥æŸ„æ—¶ï¼Œæ­¤ç»“æ„æä¾›è®¿é—®æƒé™ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">//       é©±åŠ¨å¯é€šè¿‡ä¿®æ”¹ DesiredAccess å­—æ®µæ¥æ§åˆ¶æœ€ç»ˆè®¿é—®æƒé™ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_PRE_CREATE_HANDLE_INFORMATION</span> &#123;</span></span><br><span class="line">    _Inout_ ACCESS_MASK DesiredAccess;          <span class="comment">// å¯ä¿®æ”¹ï¼šæœ€ç»ˆæˆäºˆç”¨æˆ·çš„è®¿é—®æƒé™</span></span><br><span class="line">    _In_    ACCESS_MASK OriginalDesiredAccess;  <span class="comment">// åªè¯»ï¼šç”¨æˆ·åŸå§‹è¯·æ±‚çš„è®¿é—®æƒé™</span></span><br><span class="line">&#125; OB_PRE_CREATE_HANDLE_INFORMATION, *POB_PRE_CREATE_HANDLE_INFORMATION;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæ˜¯åœ¨åˆ›å»ºå¥æŸ„å‰çš„å›è°ƒï¼Œå› æ­¤æ­¤æ—¶å¥æŸ„è¿˜æœªåˆ›å»ºï¼Œä¹Ÿå°±ä¸ä¼šåœ¨å‚æ•°ä¸­ä¼ å…¥ã€‚</p>
<p>è¿™é‡Œå‚æ•°ä¸»è¦ä¼ å…¥çš„æ˜¯ç”¨æˆ·æ‰“å¼€å¥æŸ„æ—¶çš„è¯·æ±‚æƒé™ï¼Œ <strong><code>DesiredAccess</code> å’Œ <code>OriginalDesiredAccess</code> çš„å€¼ä¼ å…¥çš„æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æˆ‘ä»¬åªèƒ½é€šè¿‡ä¿®æ”¹ <code>DesiredAccess</code> æ¥è®¾ç½®æœ€ç»ˆæˆäºˆç”¨æˆ·çš„è®¿é—®æƒé™</strong>ã€‚</p>
<blockquote>
<p>Windows å†…æ ¸ä¹‹æ‰€ä»¥åœ¨ <code>OB_PRE_CREATE_HANDLE_INFORMATION</code> ä¸­åŒæ—¶æä¾› <code>OriginalDesiredAccess</code>ï¼ˆåªè¯»ï¼‰å’Œ <code>DesiredAccess</code>ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼Œæ˜¯ä¸ºäº† <strong>â€œä¿æŠ¤è¯·æ±‚æ„å›¾â€ ä¸ â€œå…è®¸å¹²é¢„æˆæƒâ€ åˆ†ç¦»</strong> â€”â€” è¿™æ˜¯ä¸€ç§å®‰å…¨å®¡è®¡ + æ§åˆ¶åˆ†å±‚è®¾è®¡ç†å¿µã€‚</p>
</blockquote>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ä»£ç å¯ä»¥ç»™æŒ‡å®šçš„è¿›ç¨‹å¥æŸ„é™æƒï¼Œä»è€Œè¾¾åˆ°äº†ä¿æŠ¤è¿›ç¨‹çš„ç›®çš„ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¦ä¿æŠ¤çš„ç›®æ ‡è¿›ç¨‹ PIDï¼ˆå¯ä¿®æ”¹ï¼‰</span></span><br><span class="line"><span class="type">static</span> HANDLE g_ProtectedPid = (HANDLE)<span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// PreOperation å›è°ƒå‡½æ•°ï¼šç”¨äºæ£€æŸ¥å¹¶ä¿®æ”¹è®¿é—®æƒé™</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line">OB_PREOP_CALLBACK_STATUS</span><br><span class="line"><span class="title function_">PreProcessHandleCreateCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Inout_ POB_PRE_OPERATION_INFORMATION OperationInformation</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// åªå¤„ç†å¥æŸ„åˆ›å»ºæ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (OperationInformation-&gt;Operation != OB_OPERATION_HANDLE_CREATE)</span><br><span class="line">        <span class="keyword">return</span> OB_PREOP_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®ä¿æ˜¯è¿›ç¨‹å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (OperationInformation-&gt;ObjectType != *PsProcessType)</span><br><span class="line">        <span class="keyword">return</span> OB_PREOP_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç›®æ ‡è¿›ç¨‹ PID</span></span><br><span class="line">    PEPROCESS targetProcess = (PEPROCESS)OperationInformation-&gt;Object;</span><br><span class="line">    HANDLE pid = PsGetProcessId(targetProcess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == g_ProtectedPid) &#123;</span><br><span class="line">        ACCESS_MASK* pAccess = &amp;OperationInformation-&gt;Parameters</span><br><span class="line">            -&gt;CreateHandleInformation.DesiredAccess;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰¥é™¤æ•æ„Ÿæƒé™</span></span><br><span class="line">        *pAccess &amp;= ~(PROCESS_TERMINATE | PROCESS_VM_WRITE | PROCESS_VM_READ);</span><br><span class="line"></span><br><span class="line">        DbgPrint(<span class="string">&quot;Protected PID %u: access 0x%08X denied sensitive permissions\n&quot;</span>,</span><br><span class="line">            (ULONG)(ULONG_PTR)pid, *pAccess);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> OB_PREOP_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è°ƒæ•´ <code>Altitude</code> è®©æˆ‘ä»¬çš„å¯¹è±¡å›è°ƒå‡½æ•°æ³¨å†Œåˆ°è¿›ç¨‹ä¿æŠ¤æ¨¡å—çš„å¯¹è±¡å›è°ƒå‡½æ•°ä¹‹åï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ¢å¤è¢«é™æƒå¥æŸ„çš„æƒé™ã€‚</p>
<p><strong><code>DUPLICATE</code> äº‹ä»¶</strong>ç”±äºæ˜¯è¿›è¡Œ<strong>å¥æŸ„å¤åˆ¶</strong>ï¼Œå› æ­¤ä¼šåŒæ—¶ä¼ é€’<strong>å¥æŸ„æƒé™</strong>ï¼Œ<strong>æºè¿›ç¨‹</strong>å’Œ<strong>ç›®æ ‡è¿›ç¨‹</strong>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç»“æ„ä½“: OB_PRE_DUPLICATE_HANDLE_INFORMATION</span></span><br><span class="line"><span class="comment">// ç”¨é€”: å½“è¿›ç¨‹è¯·æ±‚å¤åˆ¶æŸå¯¹è±¡å¥æŸ„åˆ°ç›®æ ‡è¿›ç¨‹æ—¶ï¼ˆå¦‚ DuplicateHandleï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">//       æ­¤ç»“æ„æä¾›æƒé™ä¸è¿›ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œé©±åŠ¨å¯è¿›è¡Œå®¡æŸ¥æˆ–é™åˆ¶ã€‚</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_PRE_DUPLICATE_HANDLE_INFORMATION</span> &#123;</span></span><br><span class="line">    _Inout_ ACCESS_MASK DesiredAccess;          <span class="comment">// å¯ä¿®æ”¹ï¼šç›®æ ‡è¿›ç¨‹æœ€ç»ˆè·å¾—çš„è®¿é—®æƒé™</span></span><br><span class="line">    _In_    ACCESS_MASK OriginalDesiredAccess;  <span class="comment">// åªè¯»ï¼šåŸå§‹å¤åˆ¶è¯·æ±‚çš„æƒé™</span></span><br><span class="line">    _In_    PVOID SourceProcess;                <span class="comment">// æºè¿›ç¨‹çš„ EPROCESS æŒ‡é’ˆï¼ˆåŸå§‹å¥æŸ„æ‰€æœ‰è€…ï¼‰</span></span><br><span class="line">    _In_    PVOID TargetProcess;                <span class="comment">// ç›®æ ‡è¿›ç¨‹çš„ EPROCESS æŒ‡é’ˆï¼ˆæ¥æ”¶è€…ï¼‰</span></span><br><span class="line">&#125; OB_PRE_DUPLICATE_HANDLE_INFORMATION, *POB_PRE_DUPLICATE_HANDLE_INFORMATION;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œå¥æŸ„æƒé™åŒæ ·åˆ†ä¸º <code>DesiredAccess</code> å’Œ <code>OriginalDesiredAccess</code> ä¸¤ç§ã€‚</p>
<h3 id="åæ“ä½œå›è°ƒå‡½æ•°"><a href="#åæ“ä½œå›è°ƒå‡½æ•°" class="headerlink" title="åæ“ä½œå›è°ƒå‡½æ•°"></a>åæ“ä½œå›è°ƒå‡½æ•°</h3><p>åæ“ä½œå›è°ƒå‡½æ•°ï¼Œæ˜¯åœ¨<strong>å¯¹è±¡è®¿é—®æ“ä½œï¼ˆå¦‚åˆ›å»ºæˆ–å¤åˆ¶å¥æŸ„ï¼‰å®Œæˆä¹‹å</strong>ï¼Œç”± Windows å†…æ ¸è‡ªåŠ¨è°ƒç”¨çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé€šçŸ¥é©±åŠ¨â€œè¿™æ¬¡è®¿é—®æ“ä½œå·²ç»å®Œæˆâ€ï¼Œä¾›é©±åŠ¨æ‰§è¡Œ<strong>è§‚å¯Ÿã€è®°å½•ã€æ”¶å°¾å¤„ç†</strong>ç­‰ä»»åŠ¡ã€‚è¯¥å‡½æ•°ç±»å‹ <code>POB_POST_OPERATION_CALLBACK</code> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// ç±»å‹å®šä¹‰: POB_POST_OPERATION_CALLBACK</span></span><br><span class="line"><span class="comment">// ç”¨é€”: å®šä¹‰ Ob å¯¹è±¡å›è°ƒæœºåˆ¶ä¸­çš„â€œåæ“ä½œå›è°ƒå‡½æ•°â€ç±»å‹ï¼ˆPostOperation Callbackï¼‰ã€‚</span></span><br><span class="line"><span class="comment">//       å½“å¯¹è±¡å¥æŸ„åˆ›å»ºæˆ–å¤åˆ¶æ“ä½œå®Œæˆåï¼Œç³»ç»Ÿè°ƒç”¨è¯¥å‡½æ•°ä»¥é€šçŸ¥é©±åŠ¨æ‰§è¡Œåç»­å¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ç‰¹ç‚¹:</span></span><br><span class="line"><span class="comment">//   - å›è°ƒåœ¨å¯¹è±¡å¥æŸ„æ“ä½œå®Œæˆåè¢«è°ƒç”¨ï¼ˆå¥æŸ„å·²æˆåŠŸæˆ–å¤±è´¥åˆ›å»º/å¤åˆ¶ï¼‰</span></span><br><span class="line"><span class="comment">//   - ä¸å…è®¸ä¿®æ”¹è®¿é—®æƒé™ã€è®¿é—®æ§åˆ¶ç­‰æ ¸å¿ƒå‚æ•°</span></span><br><span class="line"><span class="comment">//   - é€šå¸¸ç”¨äºè®°å½•æ—¥å¿—ã€è¡Œä¸ºå®¡è®¡ã€æ¸…ç†ä¸Šä¸‹æ–‡æˆ–æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ç­‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ³¨å†Œæ–¹å¼:</span></span><br><span class="line"><span class="comment">//   åœ¨ OB_OPERATION_REGISTRATION ä¸­è®¾ç½® PostOperation æˆå‘˜æŒ‡å‘æ­¤å‡½æ•°</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ³¨æ„:</span></span><br><span class="line"><span class="comment">//   - æ­¤å‡½æ•°æ— æ³•é˜»æ­¢è®¿é—®æ“ä½œï¼ˆå¦‚æ‹’ç»å¥æŸ„åˆ›å»ºï¼‰ï¼Œä»…ç”¨äºè§‚å¯Ÿç»“æœ</span></span><br><span class="line"><span class="comment">//   - å‚æ•°ä¸­çš„ RegistrationContext æ¥æºäº OB_CALLBACK_REGISTRATION ä¸­æ³¨å†Œæ—¶æä¾›çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">//   - å‚æ•° OperationInformation åŒ…å«æ“ä½œç±»å‹ã€å¯¹è±¡ç±»å‹ã€è¿”å›çŠ¶æ€ã€ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment">///////////////////////////////////////////////////////////////////////////////</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">VOID</span></span><br><span class="line"><span class="params">(*POB_POST_OPERATION_CALLBACK)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PVOID RegistrationContext,                             <span class="comment">// é©±åŠ¨æ³¨å†Œæ—¶æä¾›çš„ä¸Šä¸‹æ–‡æŒ‡é’ˆï¼Œç”¨äºä¼ é€’çŠ¶æ€æˆ–ç­–ç•¥é…ç½®</span></span></span><br><span class="line"><span class="params">    _In_ POB_POST_OPERATION_INFORMATION OperationInformation    <span class="comment">// æœ¬æ¬¡å¯¹è±¡è®¿é—®æ“ä½œçš„ç»“æœä¿¡æ¯ç»“æ„ä½“ï¼ˆè§å¯¹åº”ç»“æ„å®šä¹‰ï¼‰</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>OB_POST_OPERATION_INFORMATION</code> ä¸å‰é¢çš„ <code>OB_PRE_OPERATION_INFORMATION</code> ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªä¸è¿‡ <code>Parameters</code> çš„ç±»å‹ç”± <code>POB_PRE_OPERATION_PARAMETERS</code> å˜æˆäº† <code>POB_POST_OPERATION_PARAMETERS</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_POST_OPERATION_INFORMATION</span> &#123;</span></span><br><span class="line">    _In_ OB_OPERATION  Operation;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        _In_ ULONG Flags;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            _In_ ULONG KernelHandle:<span class="number">1</span>;</span><br><span class="line">            _In_ ULONG Reserved:<span class="number">31</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    _In_ PVOID                          Object;</span><br><span class="line">    _In_ POBJECT_TYPE                   ObjectType;</span><br><span class="line">    _In_ PVOID                          CallContext;</span><br><span class="line">    _In_ NTSTATUS                       ReturnStatus;</span><br><span class="line">    _In_ POB_POST_OPERATION_PARAMETERS  Parameters;</span><br><span class="line">&#125; OB_POST_OPERATION_INFORMATION,*POB_POST_OPERATION_INFORMATION;</span><br></pre></td></tr></table></figure></div>

<p>è€Œç”±äºåæ“ä½œå›è°ƒå‡½æ•°ä¸ä¿®æ”¹æƒé™ï¼Œå› æ­¤ <code>OB_POST_OPERATION_PARAMETERS</code> ä¸­åªæœ‰ <code>GrantedAccess</code>ï¼Œå¹¶ä¸”å¯¹äº <code>DUPLICATE</code> äº‹ä»¶ä¹Ÿä¸æä¾›åŒæ–¹çš„è¿›ç¨‹å¯¹è±¡åœ°å€ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_POST_CREATE_HANDLE_INFORMATION</span> &#123;</span></span><br><span class="line">    _In_ ACCESS_MASK            GrantedAccess;</span><br><span class="line">&#125; OB_POST_CREATE_HANDLE_INFORMATION, *POB_POST_CREATE_HANDLE_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_POST_DUPLICATE_HANDLE_INFORMATION</span> &#123;</span></span><br><span class="line">    _In_ ACCESS_MASK            GrantedAccess;</span><br><span class="line">&#125; OB_POST_DUPLICATE_HANDLE_INFORMATION, * POB_POST_DUPLICATE_HANDLE_INFORMATION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">OB_POST_OPERATION_PARAMETERS</span> &#123;</span></span><br><span class="line">    _In_ OB_POST_CREATE_HANDLE_INFORMATION       CreateHandleInformation;</span><br><span class="line">    _In_ OB_POST_DUPLICATE_HANDLE_INFORMATION    DuplicateHandleInformation;</span><br><span class="line">&#125; OB_POST_OPERATION_PARAMETERS, *POB_POST_OPERATION_PARAMETERS;</span><br></pre></td></tr></table></figure></div>

<h2 id="å›è°ƒç›¸å…³ç»“æ„"><a href="#å›è°ƒç›¸å…³ç»“æ„" class="headerlink" title="å›è°ƒç›¸å…³ç»“æ„"></a>å›è°ƒç›¸å…³ç»“æ„</h2><p>å¯¹è±¡å›è°ƒçš„æ ¸å¿ƒåŸç†æ˜¯åœ¨ç³»ç»Ÿå†…æ ¸ä¸­ç»´æŠ¤ä¸€ä¸ªâ€œ<strong>å›è°ƒæ³¨å†Œé“¾è¡¨</strong>â€ï¼Œé©±åŠ¨ç¨‹åºé€šè¿‡æä¾›çš„å†…æ ¸APIæ³¨å†Œè‡ªèº«çš„å›è°ƒå‡½æ•°ï¼Œå¹¶å°†å…¶æ’å…¥åˆ°å¯¹åº”å¯¹è±¡ç±»å‹ï¼ˆå¦‚è¿›ç¨‹æˆ–çº¿ç¨‹ï¼‰çš„å›è°ƒé“¾è¡¨ä¸­ã€‚</p>
<p>æ¯å½“å†…æ ¸æ‰§è¡Œå¯¹è±¡æ“ä½œï¼ˆå¦‚æ‰“å¼€å¥æŸ„ã€å¤åˆ¶å¥æŸ„ï¼‰æ—¶ï¼Œéƒ½ä¼šä¸»åŠ¨éå†å¹¶è°ƒç”¨è¿™äº›æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œæ‹¦æˆªå’Œæ§åˆ¶ã€‚</p>
<h3 id="OBJECT-TYPE"><a href="#OBJECT-TYPE" class="headerlink" title="OBJECT_TYPE"></a>OBJECT_TYPE</h3><p><code>_OBJECT_TYPE</code> ç»“æ„ä½“æè¿°äº† <strong>æŸä¸€ç§å¯¹è±¡ç±»å‹çš„æ•´ä½“ç‰¹å¾</strong>ï¼Œä¾‹å¦‚è¿›ç¨‹ï¼ˆ<code>PsProcessType</code>ï¼‰ã€çº¿ç¨‹ï¼ˆ<code>PsThreadType</code>ï¼‰ã€æ–‡ä»¶ï¼ˆ<code>IoFileObjectType</code>ï¼‰ç­‰ã€‚æ¯ä¸ªç±»å‹åœ¨å†…æ ¸ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ <code>_OBJECT_TYPE</code> å®ä¾‹ï¼Œä¾›è¯¥ç±»å‹çš„æ‰€æœ‰å¯¹è±¡å…±äº«ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»“æ„å¤§å°ï¼š0x88 å­—èŠ‚</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TypeList</span>;</span>            <span class="comment">// 0x00: å¯¹è±¡ç±»å‹é“¾è¡¨ï¼Œç”¨äºé“¾æ¥æ‰€æœ‰ OBJECT_TYPE å®ä¾‹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">Name</span>;</span>            <span class="comment">// 0x08: å¯¹è±¡ç±»å‹åç§°ï¼ˆå¦‚ &quot;Process&quot;ã€&quot;Thread&quot; ç­‰ï¼‰</span></span><br><span class="line">    VOID* DefaultObject;                    <span class="comment">// 0x10: é»˜è®¤å¯¹è±¡å®ä¾‹ï¼ˆæœ‰äº›ç±»å‹æä¾›é»˜è®¤å¯¹è±¡ï¼Œä¾‹å¦‚ Tokenï¼‰</span></span><br><span class="line">    UCHAR Index;                            <span class="comment">// 0x14: å¯¹è±¡ç±»å‹ç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿæ ‡è¯†ç±»å‹ï¼‰</span></span><br><span class="line">    ULONG TotalNumberOfObjects;             <span class="comment">// 0x18: å½“å‰ç³»ç»Ÿä¸­è¯¥ç±»å‹å¯¹è±¡çš„æ€»æ•°é‡</span></span><br><span class="line">    ULONG TotalNumberOfHandles;             <span class="comment">// 0x1C: å½“å‰ç³»ç»Ÿä¸­æŒ‡å‘è¯¥ç±»å‹å¯¹è±¡çš„æ€»å¥æŸ„æ•°</span></span><br><span class="line">    ULONG HighWaterNumberOfObjects;         <span class="comment">// 0x20: å†å²æœ€é«˜åŒæ—¶å­˜åœ¨çš„è¯¥ç±»å‹å¯¹è±¡æ•°é‡</span></span><br><span class="line">    ULONG HighWaterNumberOfHandles;         <span class="comment">// 0x24: å†å²æœ€é«˜åŒæ—¶å­˜åœ¨çš„è¯¥ç±»å‹å¯¹è±¡å¥æŸ„æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE_INITIALIZER</span> <span class="title">TypeInfo</span>;</span> <span class="comment">// 0x28: ç±»å‹åˆå§‹åŒ–ç»“æ„ï¼Œå®šä¹‰è¯¥ç±»å‹å¯¹è±¡çš„è¡Œä¸ºï¼ˆå¦‚å›è°ƒã€æ± åˆ†é…æ–¹å¼ç­‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">TypeLock</span>;</span>          <span class="comment">// 0x78: ç”¨äºä¿æŠ¤è¯¥ç±»å‹å¯¹è±¡çš„åŒæ­¥é”</span></span><br><span class="line">    ULONG Key;                              <span class="comment">// 0x7C: ç±»å‹æ ¡éªŒç æˆ–å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆæŸäº›ç‰ˆæœ¬ä¸­ä¸ºä¿ç•™å­—æ®µï¼‰</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">CallbackList</span>;</span>        <span class="comment">// 0x80: ğŸ“Œå¯¹è±¡å›è°ƒé“¾è¡¨ï¼Œç”¨äºæ”¯æŒæ³¨å†Œçš„ ObRegisterCallbacks å›è°ƒ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>CallbackList</code> æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå­˜æ”¾æˆ‘ä»¬æ³¨å†Œçš„å¯¹è±¡å›è°ƒå‡½æ•°çš„å­˜å‚¨ç»“æ„ <code>OB_CALLBACK_ENTRY</code>ã€‚</p>
<h3 id="OBJECT-TYPE-INITIALIZER"><a href="#OBJECT-TYPE-INITIALIZER" class="headerlink" title="OBJECT_TYPE_INITIALIZER"></a>OBJECT_TYPE_INITIALIZER</h3><p><code>_OBJECT_TYPE_INITIALIZER</code> å®šä¹‰äº†åˆ›å»ºä¸€ä¸ªå¯¹è±¡ç±»å‹æ—¶éœ€è¦æä¾›çš„ä¸€ç»„ <strong>åˆå§‹åŒ–å±æ€§ä¸è¡Œä¸ºæ¥å£</strong>ã€‚å®ƒæ˜¯ <code>_OBJECT_TYPE</code> ä¸­ <code>TypeInfo</code> å­—æ®µçš„ç±»å‹ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x50 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE_INITIALIZER</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    USHORT Length;                                          <span class="comment">// 0x00: ç»“æ„ä½“å¤§å°ï¼ˆç”¨äºç‰ˆæœ¬å…¼å®¹ä¸æ ¡éªŒï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        UCHAR ObjectTypeFlags;                              <span class="comment">// 0x02: å¯¹è±¡ç±»å‹æ ‡å¿—ä½å­—æ®µï¼ˆå‹ç¼©ä½ï¼‰</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            UCHAR CaseInsensitive         : <span class="number">1</span>;              <span class="comment">// [bit 0] æ˜¯å¦å¤§å°å†™ä¸æ•æ„Ÿï¼ˆå¦‚ç¬¦å·é“¾æ¥å¯¹è±¡ï¼‰</span></span><br><span class="line">            UCHAR UnnamedObjectsOnly      : <span class="number">1</span>;              <span class="comment">// [bit 1] æ˜¯å¦åªå…è®¸åŒ¿åå¯¹è±¡ï¼ˆå¦‚äº‹ä»¶ã€ä¿¡å·é‡ç­‰ï¼‰</span></span><br><span class="line">            UCHAR UseDefaultObject        : <span class="number">1</span>;              <span class="comment">// [bit 2] æ˜¯å¦ä½¿ç”¨ DefaultObject æä¾›é»˜è®¤å®ä¾‹</span></span><br><span class="line">            UCHAR SecurityRequired        : <span class="number">1</span>;              <span class="comment">// [bit 3] åˆ›å»ºæ—¶æ˜¯å¦å¿…é¡»æä¾›å®‰å…¨æè¿°ç¬¦</span></span><br><span class="line">            UCHAR MaintainHandleCount     : <span class="number">1</span>;              <span class="comment">// [bit 4] æ˜¯å¦ç»´æŠ¤å¥æŸ„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">            UCHAR MaintainTypeList        : <span class="number">1</span>;              <span class="comment">// [bit 5] æ˜¯å¦åŠ å…¥å…¨å±€å¯¹è±¡ç±»å‹é“¾è¡¨</span></span><br><span class="line">            UCHAR SupportsObjectCallbacks : <span class="number">1</span>;              <span class="comment">// [bit 6] ğŸ“Œæ˜¯å¦æ”¯æŒå¯¹è±¡å›è°ƒï¼ˆå¦‚ ObRegisterCallbacksï¼‰</span></span><br><span class="line">            UCHAR Reserved                : <span class="number">1</span>;              <span class="comment">// [bit 7] ä¿ç•™ä½</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ULONG ObjectTypeCode;                                   <span class="comment">// 0x04: å¯¹è±¡ç±»å‹ä»£ç ï¼ˆä»…ä¾›å†…æ ¸è¯†åˆ«ï¼‰</span></span><br><span class="line">    ULONG InvalidAttributes;                                <span class="comment">// 0x08: æ— æ•ˆçš„å±æ€§æ©ç ï¼ˆç”¨äºå‚æ•°æ ¡éªŒï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">GENERIC_MAPPING</span> <span class="title">GenericMapping</span>;</span>                 <span class="comment">// 0x0C: ç”¨äºæƒé™è½¬æ¢çš„é€šç”¨æ˜ å°„ï¼ˆGENERIC_READ ç­‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">    ULONG ValidAccessMask;                                  <span class="comment">// 0x1C: ğŸ“Œå¯ç”¨çš„è®¿é—®æƒé™ä½ï¼ˆObCheckObjectAccess ç”¨ï¼‰</span></span><br><span class="line">    ULONG RetainAccess;                                     <span class="comment">// 0x20: å¿…é¡»ä¿ç•™çš„è®¿é—®æƒé™ä½ï¼ˆä¸ä¼šè¢«å‰¥å¤ºï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> _<span class="title">POOL_TYPE</span> <span class="title">PoolType</span>;</span>                               <span class="comment">// 0x24: å¯¹è±¡é»˜è®¤ä½¿ç”¨çš„å†…å­˜æ± ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    ULONG DefaultPagedPoolCharge;                           <span class="comment">// 0x28: åˆ†é…åˆ†é¡µæ± å¯¹è±¡æ—¶çš„é»˜è®¤é…é¢</span></span><br><span class="line">    ULONG DefaultNonPagedPoolCharge;                        <span class="comment">// 0x2C: åˆ†é…éåˆ†é¡µæ± å¯¹è±¡æ—¶çš„é»˜è®¤é…é¢</span></span><br><span class="line"></span><br><span class="line">    VOID (*DumpProcedure)(                                   <span class="comment">// 0x30: è°ƒè¯•å™¨ !object è°ƒç”¨çš„å¯¹è±¡è½¬å‚¨å›è°ƒ</span></span><br><span class="line">        VOID* Object,</span><br><span class="line">        <span class="keyword">struct</span> _OBJECT_DUMP_CONTROL* DumpControl</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    LONG (*OpenProcedure)(                                   <span class="comment">// 0x34: å¯¹è±¡è¢«æ‰“å¼€ï¼ˆNtOpenXXXï¼‰æ—¶çš„è®¿é—®æ§åˆ¶å›è°ƒ</span></span><br><span class="line">        <span class="keyword">enum</span> _OB_OPEN_REASON OpenReason,</span><br><span class="line">        CHAR PreviousMode,</span><br><span class="line">        <span class="keyword">struct</span> _EPROCESS* Process,</span><br><span class="line">        VOID* Object,</span><br><span class="line">        ULONG* GrantedAccess,</span><br><span class="line">        ULONG HandleCount</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    VOID (*CloseProcedure)(                                  <span class="comment">// 0x38: å¯¹è±¡å¥æŸ„å…³é—­ï¼ˆNtCloseï¼‰æ—¶è°ƒç”¨çš„å›è°ƒ</span></span><br><span class="line">        <span class="keyword">struct</span> _EPROCESS* Process,</span><br><span class="line">        VOID* Object,</span><br><span class="line">        ULONG GrantedAccess,</span><br><span class="line">        ULONG HandleCount</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    VOID (*DeleteProcedure)(                                 <span class="comment">// 0x3C: å¯¹è±¡å¼•ç”¨å½’é›¶è¢«åˆ é™¤æ—¶è§¦å‘çš„æ¸…ç†å›è°ƒ</span></span><br><span class="line">        VOID* Object</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    LONG (*ParseProcedure)(                                  <span class="comment">// 0x40: å¯¹è±¡è·¯å¾„è§£æï¼ˆå¦‚ NtOpenFile è§£æè·¯å¾„ï¼‰</span></span><br><span class="line">        VOID* ParsedObject,</span><br><span class="line">        VOID* RemainingPath,</span><br><span class="line">        <span class="keyword">struct</span> _ACCESS_STATE* AccessState,</span><br><span class="line">        CHAR AccessMode,</span><br><span class="line">        ULONG Attributes,</span><br><span class="line">        <span class="keyword">struct</span> _UNICODE_STRING* CompleteName,</span><br><span class="line">        <span class="keyword">struct</span> _UNICODE_STRING* RemainingName,</span><br><span class="line">        VOID* Context,</span><br><span class="line">        <span class="keyword">struct</span> _SECURITY_QUALITY_OF_SERVICE* SecurityQos,</span><br><span class="line">        VOID** NewObject</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    LONG (*SecurityProcedure)(                               <span class="comment">// 0x44: å®‰å…¨æè¿°ç¬¦è¯»å–/ä¿®æ”¹æ“ä½œå›è°ƒ</span></span><br><span class="line">        VOID* Object,</span><br><span class="line">        <span class="keyword">enum</span> _SECURITY_OPERATION_CODE OperationCode,</span><br><span class="line">        ULONG* SecurityInformation,</span><br><span class="line">        VOID* SecurityDescriptor,</span><br><span class="line">        ULONG* BufferLength,</span><br><span class="line">        VOID** NewSecurityDescriptor,</span><br><span class="line">        <span class="keyword">enum</span> _POOL_TYPE PoolType,</span><br><span class="line">        <span class="keyword">struct</span> _GENERIC_MAPPING* Mapping,</span><br><span class="line">        CHAR AccessMode</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    LONG (*QueryNameProcedure)(                              <span class="comment">// 0x48: æŸ¥è¯¢å¯¹è±¡åç§°ä¿¡æ¯çš„å›è°ƒï¼ˆå¦‚ NtQueryObjectï¼‰</span></span><br><span class="line">        VOID* Object,</span><br><span class="line">        UCHAR HasAccess,</span><br><span class="line">        <span class="keyword">struct</span> _OBJECT_NAME_INFORMATION* NameInfo,</span><br><span class="line">        ULONG NameInfoLength,</span><br><span class="line">        ULONG* ReturnLength,</span><br><span class="line">        CHAR AccessMode</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    UCHAR (*OkayToCloseProcedure)(                           <span class="comment">// 0x4C: åˆ¤æ–­æ˜¯å¦å…è®¸å…³é—­å¯¹è±¡å¥æŸ„ï¼ˆå¯ç”¨äºä¿æŠ¤ç‰¹å®šå¥æŸ„ï¼‰</span></span><br><span class="line">        <span class="keyword">struct</span> _EPROCESS* Process,</span><br><span class="line">        VOID* Object,</span><br><span class="line">        VOID* Handle,</span><br><span class="line">        CHAR PreviousMode</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>SupportsObjectCallbacks</code> å†³å®šå¯¹è±¡å›è°ƒæ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå°†è¿™ä¸ªä½ç½® 0 åˆ™å¯¹è±¡å›è°ƒä¼šå¤±æ•ˆã€‚ä¸è¿‡è¿™ä¸ªä½è¢« PG ç›‘æ§ï¼Œä¸èƒ½é•¿æœŸä¿®æ”¹ã€‚</p>
<p>å¦å¤– <code>ValidAccessMask</code> è¡¨ç¤ºçš„æ˜¯å¯ç”¨çš„è®¿é—®æƒé™ï¼Œå¦‚æœè¿™ä¸ªä½ç½® 0 åˆ™è¯¥å¯¹è±¡æ— æ³•æ‰“å¼€ã€‚ä¾‹å¦‚å†…æ ¸ä¸­çš„ <code>DbgkDebugObjectType</code> æŒ‡å‘ <code>DebugObject</code> çš„å¯¹è±¡ç±»å‹ï¼Œå¦‚æœæŠŠè¯¥ç±»å‹çš„ <code>ValidAccessMask</code> ç½® 0 åˆ™ä¼šå¯¼è‡´å…¨å±€è°ƒè¯•ç¦ç”¨ã€‚</p>
<p><code>OBJECT_TYPE_INITIALIZER</code> ä¸­è¿˜æœ‰ä¸€äº›åˆ—çš„å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°ä¼šé’ˆå¯¹ä¸åŒå†…æ ¸å¯¹è±¡çš„ä¸åŒç‰¹æ€§è€ŒæŒ‡å‘ä¸åŒçš„å‡½æ•°ã€‚</p>
<ul>
<li><strong><code>DumpProcedure</code></strong> ï¼šä¾›è°ƒè¯•å·¥å…·ï¼ˆå¦‚ WinDbg çš„ <code>!object</code> æ‰©å±•ï¼‰ç”¨äºæ‰“å°å¯¹è±¡å†…éƒ¨çŠ¶æ€ï¼ŒåŒ…æ‹¬ç±»å‹ã€å¼•ç”¨è®¡æ•°ã€å±æ€§ç­‰ã€‚</li>
<li><strong><code>OpenProcedure</code></strong> ï¼šå½“å¯¹è±¡å¥æŸ„æ‰“å¼€æ—¶å›è°ƒï¼Œå…è®¸æ‹¦æˆªæˆ–ä¿®æ”¹è®¿é—®è¯·æ±‚ã€‚æ¯”å¦‚å®‰å…¨è½¯ä»¶ä¼šåœ¨æ­¤å¤„æ£€æŸ¥æƒé™æˆ–æ‹’ç»æ‰“å¼€ã€‚è¿™ä¸ªå‡½æ•°ä¼šåœ¨ <code>ObpCreateHandle</code> å†…éƒ¨å¤„ç†æ—¶è°ƒç”¨é‚£ä¸ªé¢„æ“ä½œï¼ˆPreOperationï¼‰å›è°ƒï¼Œä»¥ä¾¿å¯¹è®¿é—®è¿›è¡Œç®¡ç†ã€‚</li>
<li><strong><code>CloseProcedure</code></strong> ï¼šå¥æŸ„å…³é—­æ—¶æ‰§è¡Œï¼Œå¸¸ç”¨äºèµ„æºé‡Šæ”¾ã€æ—¥å¿—è®°å½•æˆ–å®ç°å¼•ç”¨è®¡æ•°æ¸…ç†æœºåˆ¶ã€‚åœ¨ç”¨æˆ·è°ƒç”¨ <code>NtClose</code>ã€<code>CloseHandle</code> æˆ–å¥æŸ„è¢«å›æ”¶æ—¶è§¦å‘ã€‚</li>
<li><strong><code>DeleteProcedure</code></strong> ï¼šå½“å¯¹è±¡æœªå†è¢«å¼•ç”¨ä¸”è¦é”€æ¯å‰è°ƒç”¨ï¼Œå…è®¸é‡Šæ”¾åˆ†é…çš„ç»“æ„ä½“ã€å†…å­˜æˆ–æ‰§è¡Œå…¶ä»–æœ€ç»ˆæ¸…ç†å·¥ä½œã€‚é€šå¸¸åœ¨ <code>ObDereferenceObject</code> å¯¼è‡´å¼•ç”¨è®¡æ•°ä¸ºé›¶ï¼Œå†…æ ¸å‡†å¤‡é‡Šæ”¾è¯¥å¯¹è±¡æ—¶è°ƒç”¨ã€‚</li>
<li><strong><code>ParseProcedure</code></strong> ï¼šè´Ÿè´£è§£æç‰¹å®šå‘½åç©ºé—´è·¯å¾„ï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€è®¾å¤‡è·¯å¾„ç­‰ï¼‰ï¼Œå¹¶åˆ›å»ºæˆ–å¼•ç”¨å¯¹åº”å¯¹è±¡ã€‚å¦‚ä» <code>\Device\...</code> è·¯å¾„è¿›è¡Œ <code>NtOpenFile</code> æ—¶ï¼Œå†…æ ¸éå†å‘½åç©ºé—´ï¼Œå¹¶åœ¨æ¯ä¸ªç»„ä»¶è°ƒç”¨è¯¥å›è°ƒå‡½æ•°ã€‚</li>
<li><strong><code>SecurityProcedure</code></strong> ï¼šä¾‹å¦‚åœ¨ <code>NtQuerySecurityObject</code>ã€<code>NtSetSecurityObject</code> ç­‰æ“ä½œä¸­ï¼Œè¢«è°ƒç”¨ä»¥è¯»å–ã€å®‰å…¨éªŒè¯ã€è®¾ç½®æˆ–é‡æ–°ç¼–ç å®‰å…¨æè¿°ç¬¦ã€‚é€šå¸¸åœ¨å¯¹è±¡éœ€è¦è¯»å–ã€è®¾ç½®æˆ–æšä¸¾å®‰å…¨ä¿¡æ¯æ—¶ï¼Œåœ¨ <code>ObpCreateHandle</code> æˆ– <code>ObQuerySecurityObject</code> ç­‰è·¯å¾„ä¸­è§¦å‘ã€‚</li>
<li><strong><code>QueryNameProcedure</code></strong> ï¼šå½“ç”¨æˆ·é€šè¿‡ API æŸ¥è¯¢å¯¹è±¡åç§°ï¼ˆå¦‚æ–‡ä»¶åã€è¿›ç¨‹åã€è®¾å¤‡è·¯å¾„ï¼‰æ—¶ï¼Œè´Ÿè´£å¡«å……è¾“å‡ºç¼“å†²åŒºã€‚åœ¨ <code>NtQueryObject(..., ObjectNameInformation)</code> æ—¶è°ƒç”¨ï¼Œç”¨äºæä¾›å‡†ç¡®åç§°ä¿¡æ¯ã€‚</li>
<li><strong><code>OkayToCloseProcedure</code></strong> ï¼šåœ¨æŸäº›å®‰å…¨æ•æ„Ÿæˆ–å…³é”®å¯¹è±¡ä¸Šä½¿ç”¨ï¼Œå¯æ‹’ç»æŸè¿›ç¨‹å…³é—­å¥æŸ„çš„è¯·æ±‚ï¼Œä»è€Œé˜²æ­¢è¢«ç¯¡æ”¹æˆ–æŒä¹…åŒ–æ§åˆ¶ã€‚åœ¨ <code>NtClose</code> å¤„ç†é˜¶æ®µï¼Œå¦‚æœæ­¤å›è°ƒè¿”å› <code>FALSE</code>ï¼Œç³»ç»Ÿå°†æ‹’ç»å…³é—­å¥æŸ„ã€‚</li>
</ul>
<p>ä¾‹å¦‚æˆ‘ä»¬åœ¨è°ƒç”¨ <code>NtClose(hObject)</code> æœ‰å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">NtClose(hObject)</span><br><span class="line">â”‚</span><br><span class="line">â”œâ”€ ObpCloseHandle</span><br><span class="line">â”‚   â”‚</span><br><span class="line">â”‚   â”œâ”€ ğŸ¯ è°ƒç”¨ ObpCloseHandleTableEntry</span><br><span class="line">â”‚   â”‚   â”‚</span><br><span class="line">â”‚   â”‚   â”œâ”€ ğŸ” è°ƒç”¨ OkayToCloseProcedureï¼ˆå¯æ‹’ç»å¥æŸ„å…³é—­ï¼‰</span><br><span class="line">â”‚   â”‚   â”‚     â”œâ”€ è¿”å› TRUE â†’ ç»§ç»­</span><br><span class="line">â”‚   â”‚   â”‚     â””â”€ è¿”å› FALSE â†’ âŒ STATUS_HANDLE_NOT_CLOSABLE</span><br><span class="line">â”‚   â”‚   â”‚</span><br><span class="line">â”‚   â”‚   â””â”€ ğŸ”¢ è°ƒç”¨ ObpDecrementHandleCountï¼ˆé€’å‡å¥æŸ„è®¡æ•°ï¼‰</span><br><span class="line">â”‚   â”‚         â”‚</span><br><span class="line">â”‚   â”‚         â””â”€ ğŸ”” è°ƒç”¨ CloseProcedureï¼ˆä¸å¯æ‹’ç»ï¼Œä»…é€šçŸ¥è¡Œä¸ºï¼‰</span><br><span class="line">â”‚   â”‚              â””â”€ é€‚ç”¨äºæ—¥å¿—ã€èµ„æºåŒæ­¥ã€Handle DB æ¸…ç†ç­‰</span><br><span class="line">â”‚   â”‚</span><br><span class="line">â”‚   â””â”€ ObDereferenceObject</span><br><span class="line">â”‚       â”‚</span><br><span class="line">â”‚       â””â”€ ObfDereferenceObjectWithTag</span><br><span class="line">â”‚           â”‚</span><br><span class="line">â”‚           â””â”€ ObpRemoveObjectRoutineï¼ˆå¯¹è±¡å¼•ç”¨ä¸º 0 æ—¶è§¦å‘ï¼‰</span><br><span class="line">â”‚               â”‚</span><br><span class="line">â”‚               â”œâ”€ ğŸ” è°ƒç”¨ SecurityProcedureï¼ˆè‹¥æ³¨å†Œï¼‰</span><br><span class="line">â”‚               â”‚     â””â”€ å¯æ ¡éªŒã€æ›´æ–°ã€é‡Šæ”¾å®‰å…¨æè¿°ç¬¦</span><br><span class="line">â”‚               â”‚</span><br><span class="line">â”‚               â””â”€ ğŸ’£ è°ƒç”¨ DeleteProcedureï¼ˆè‹¥æ³¨å†Œï¼‰</span><br><span class="line">â”‚                     â””â”€ æœ€ç»ˆé‡Šæ”¾èµ„æºã€é”€æ¯å¯¹è±¡</span><br></pre></td></tr></table></figure></div>

<h3 id="OB-CALLBACK-HANDLE"><a href="#OB-CALLBACK-HANDLE" class="headerlink" title="OB_CALLBACK_HANDLE"></a>OB_CALLBACK_HANDLE</h3><p>å½“æˆ‘ä»¬è°ƒç”¨ <code>ObRegisterCallbacks</code> æ³¨å†Œå›è°ƒå‡½æ•°æˆåŠŸåä¼šè¿”å›ä¸€ä¸ª <code>RegistrationHandle</code> å¥æŸ„ã€‚å®é™…ä¸Š <code>RegistrationHandle</code> æŒ‡å‘çš„æ˜¯ <code>OB_CALLBACK_HANDLE</code>ï¼ˆæœªå…¬å¼€ï¼‰ç»“æ„ä½“ã€‚</p>
<p>è¿™ä¸ªç»“æ„ä½“ä¸­ä¿å­˜äº†æˆ‘ä»¬æ³¨å†Œå†…æ ¸å¯¹è±¡å›è°ƒæ—¶çš„ <code>OB_CALLBACK_REGISTRATION</code> ç»“æ„ä½“ä¼ é€’çš„ä¿¡æ¯ï¼Œå¹¶ä¸”ç»“æ„ä¸ <code>OB_CALLBACK_REGISTRATION</code> ä¹Ÿéå¸¸ç›¸ä¼¼ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å¯¹è±¡å›è°ƒæ³¨å†Œç»“æ„ä½“ï¼ˆå³ ObRegisterCallbacks è¿”å›çš„ RegistrationHandle æ‰€æŒ‡å‘çš„ç»“æ„ï¼‰</span></span><br><span class="line"><span class="comment">// ç”¨äºè¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„æ³¨å†Œä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬æ³¨å†Œçš„å›è°ƒé¡¹ã€Altitude ç­‰ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_CALLBACK_HANDLE</span> &#123;</span></span><br><span class="line">    USHORT Version;                          <span class="comment">// æ³¨å†Œç»“æ„ç‰ˆæœ¬å·ï¼Œå¿…é¡»ä¸º OB_FLT_REGISTRATION_VERSION</span></span><br><span class="line">    USHORT OperationRegistrationCount;       <span class="comment">// å®é™…æˆåŠŸæ³¨å†Œçš„å›è°ƒé¡¹æ•°é‡ï¼ˆCallbackEntryArray ä¸­çš„é¡¹æ•°ï¼‰</span></span><br><span class="line">    PVOID RegistrationContext;               <span class="comment">// è°ƒç”¨è€…å®šä¹‰çš„ä¸Šä¸‹æ–‡ï¼Œå¯åœ¨å›è°ƒä¸­è®¿é—®</span></span><br><span class="line">    UNICODE_STRING Altitude;                 <span class="comment">// æ³¨å†Œé«˜åº¦ï¼ˆAltitudeï¼‰ï¼Œç”¨äºæ’åºå›è°ƒä¼˜å…ˆçº§ï¼ˆè¶Šé«˜è¶Šå…ˆæ‰§è¡Œï¼‰</span></span><br><span class="line">    OB_CALLBACK_ENTRY CallbackEntryArray[<span class="number">1</span>]; <span class="comment">// å˜é•¿æ•°ç»„ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰å›è°ƒé¡¹ï¼ˆæŒ‰éœ€åˆ†é…å†…å­˜ï¼‰</span></span><br><span class="line">&#125; OB_CALLBACK_HANDLE, *POB_CALLBACK_HANDLE;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content">
      <p><code>ObRegisterCallbacks</code> åœ¨ç”³è¯· <code>OB_CALLBACK_HANDLE</code> ç»“æ„ä½“æ‰€éœ€å†…å­˜æ—¶ï¼Œä¼šåœ¨ <code>OB_CALLBACK_HANDLE</code> çš„æœ€åé¢å¤–å¤šç”³è¯·ä¸€éƒ¨åˆ†å†…å­˜ï¼Œç”¨äºå­˜æ”¾ <code>Altitude</code> ä¸­çš„å­—ç¬¦ä¸²ã€‚</p>

    </div>
  </div>

<p>å…¶ä¸­ <code>CallbackEntryArray</code> æ˜¯ä¸€ä¸ª <code>OB_CALLBACK_ENTRY</code> æ•°ç»„ï¼Œå¯¹åº”ç€ <code>OB_CALLBACK_REGISTRATION</code> çš„ <code>OperationRegistration</code> å­—æ®µã€‚é‡Œé¢ä¿å­˜åœ¨æˆ‘ä»¬æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å•ä¸ªå¯¹è±¡æ“ä½œå›è°ƒé¡¹ï¼ŒæŒ‚å…¥æŒ‡å®šå¯¹è±¡ç±»å‹çš„ CallbackList ä¸­</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">OB_CALLBACK_ENTRY</span> &#123;</span></span><br><span class="line">    LIST_ENTRY CallbackList;               <span class="comment">// é“¾è¡¨èŠ‚ç‚¹ï¼ŒæŒ‚å…¥ ObjectType-&gt;CallbackList é“¾è¡¨</span></span><br><span class="line">    ULONG Operations;                      <span class="comment">// è§¦å‘æ“ä½œæ ‡å¿—ï¼šå¦‚ OB_OPERATION_HANDLE_CREATE / DUPLICATE</span></span><br><span class="line">    ULONG Flags;                           <span class="comment">// çŠ¶æ€æ ‡å¿—ï¼šå¦‚ OB_CALLBACK_ACTIVE_FLAG</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">OB_CALLBACK_HANDLE</span>* <span class="title">CallbackHandle</span>;</span>  <span class="comment">// æ‰€å±å›è°ƒå¥æŸ„ï¼ˆOB_CALLBACK_HANDLEï¼‰ï¼Œç”¨äºå›æº¯æ¸…ç†</span></span><br><span class="line">    POBJECT_TYPE ObjectType;              <span class="comment">// æ³¨å†Œç›®æ ‡å¯¹è±¡ç±»å‹ï¼ˆå¦‚ PsProcessTypeã€PsThreadTypeï¼‰</span></span><br><span class="line">    POB_PRE_OPERATION_CALLBACK PreOperation;   <span class="comment">// åˆ›å»ºæˆ–å¤åˆ¶å‰çš„é¢„å›è°ƒå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    POB_POST_OPERATION_CALLBACK PostOperation; <span class="comment">// åˆ›å»ºæˆ–å¤åˆ¶åçš„åå›è°ƒå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">    EX_RUNDOWN_REF RundownRef;            <span class="comment">// Rundown ä¿æŠ¤ï¼Œç”¨äºå»¶è¿Ÿé‡Šæ”¾ CallbackEntry</span></span><br><span class="line">&#125; OB_CALLBACK_ENTRY, *POB_CALLBACK_ENTRY;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªç»“æ„é€šè¿‡ <code>CallbackList</code> å­—æ®µæŒ‚åˆ° <code>OBJECT_TYPE</code> çš„ <code>CallbackList</code> é“¾è¡¨ä¸Šã€‚</p>
<h2 id="å¯¹è±¡å›è°ƒåˆ†æ"><a href="#å¯¹è±¡å›è°ƒåˆ†æ" class="headerlink" title="å¯¹è±¡å›è°ƒåˆ†æ"></a>å¯¹è±¡å›è°ƒåˆ†æ</h2><h3 id="å¯¹è±¡å›è°ƒæ³¨å†Œ"><a href="#å¯¹è±¡å›è°ƒæ³¨å†Œ" class="headerlink" title="å¯¹è±¡å›è°ƒæ³¨å†Œ"></a>å¯¹è±¡å›è°ƒæ³¨å†Œ</h3><p><code>ObRegisterCallbacks</code> æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ <code>CallbackRegistration</code> ç»“æ„æ„é€ å¡«å……ä¸€ä¸ª <code>POB_CALLBACK_HANDLE</code> ç»“æ„ï¼Œå¹¶è°ƒç”¨ <code>ObpInsertCallbackByAltitude</code> å‡½æ•°å°†å…¶ä¸­ <code>CallbackEntryArray</code> æ•°ç»„ä¸­çš„æ‰€æœ‰çš„ <code>POB_CALLBACK_ENTRY</code> æŒ‰ç…§ <code>Altitude</code> é¡ºåºæŒ‚åˆ° <code>OBJECT_TYPE</code> çš„ <code>CallbackList</code> é“¾è¡¨ä¸Šã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS NTAPI <span class="title function_">ObRegisterCallbacks</span><span class="params">(</span></span><br><span class="line"><span class="params">    POB_CALLBACK_REGISTRATION CallbackRegistration,</span></span><br><span class="line"><span class="params">    PVOID* RegistrationHandle</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    USHORT RegistrationCount;</span><br><span class="line">    SIZE_T AllocationSize;</span><br><span class="line">    POB_CALLBACK_HANDLE CallbackHandle;</span><br><span class="line">    POB_CALLBACK_ENTRY CallbackEntry;</span><br><span class="line">    UNICODE_STRING* Altitude;</span><br><span class="line">    WCHAR* AltitudeBuffer;</span><br><span class="line">    NTSTATUS Status = STATUS_SUCCESS;</span><br><span class="line">    ULONG i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [éªŒè¯ç»“æ„ç‰ˆæœ¬]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> ((CallbackRegistration-&gt;Version &amp; <span class="number">0xFF00</span>) != OB_FLT_REGISTRATION_VERSION)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line"></span><br><span class="line">    RegistrationCount = CallbackRegistration-&gt;OperationRegistrationCount;</span><br><span class="line">    <span class="keyword">if</span> (RegistrationCount == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INVALID_PARAMETER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [è®¡ç®—æ‰€éœ€å†…å­˜å¤§å°å¹¶åˆ†é…]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    AllocationSize =</span><br><span class="line">        FIELD_OFFSET(OB_CALLBACK_HANDLE, CallbackEntryArray) +      <span class="comment">// å›ºå®šéƒ¨åˆ†</span></span><br><span class="line">        RegistrationCount * <span class="keyword">sizeof</span>(OB_CALLBACK_ENTRY) +             <span class="comment">// å…¨éƒ¨å›è°ƒé¡¹</span></span><br><span class="line">        CallbackRegistration-&gt;Altitude.Length;                      <span class="comment">// Altitude å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">    CallbackHandle = (POB_CALLBACK_HANDLE)ExAllocatePoolWithTag(PagedPool, AllocationSize, <span class="string">&#x27;ObCl&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!CallbackHandle)</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line"></span><br><span class="line">    RtlZeroMemory(CallbackHandle, AllocationSize);</span><br><span class="line"></span><br><span class="line">    CallbackHandle-&gt;Version = OB_FLT_REGISTRATION_VERSION;</span><br><span class="line">    CallbackHandle-&gt;RegistrationContext = CallbackRegistration-&gt;RegistrationContext;</span><br><span class="line">    CallbackHandle-&gt;OperationRegistrationCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [æ‹·è´ Altitude å­—ç¬¦ä¸²è‡³ç»“æ„å°¾éƒ¨]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    AltitudeBuffer = (WCHAR*)((PUCHAR)CallbackHandle + AllocationSize - CallbackRegistration-&gt;Altitude.Length);</span><br><span class="line">    RtlCopyMemory(AltitudeBuffer, CallbackRegistration-&gt;Altitude.Buffer, CallbackRegistration-&gt;Altitude.Length);</span><br><span class="line"></span><br><span class="line">    Altitude = &amp;CallbackHandle-&gt;Altitude;</span><br><span class="line">    Altitude-&gt;Length = CallbackRegistration-&gt;Altitude.Length;</span><br><span class="line">    Altitude-&gt;MaximumLength = Altitude-&gt;Length;</span><br><span class="line">    Altitude-&gt;Buffer = AltitudeBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [é€é¡¹æ³¨å†Œå›è°ƒ]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; RegistrationCount; ++i) &#123;</span><br><span class="line">        <span class="type">const</span> OB_OPERATION_REGISTRATION* OperationRegistration = &amp;CallbackRegistration-&gt;OperationRegistration[i];</span><br><span class="line">        POBJECT_TYPE ObjectType = *OperationRegistration-&gt;ObjectType;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éªŒè¯å¯¹è±¡ç±»å‹æ”¯æŒå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (!OperationRegistration-&gt;Operations || !ObjectType-&gt;TypeInfo.SupportsObjectCallbacks) &#123;</span><br><span class="line">            Status = STATUS_INVALID_PARAMETER;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éªŒè¯å›è°ƒå‡½æ•°åˆæ³•æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (OperationRegistration-&gt;PreOperation &amp;&amp;</span><br><span class="line">            !MmVerifyCallbackFunction((PVOID)OperationRegistration-&gt;PreOperation)) &#123;</span><br><span class="line">            Status = STATUS_ACCESS_DENIED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (OperationRegistration-&gt;PostOperation &amp;&amp;</span><br><span class="line">            !MmVerifyCallbackFunction((PVOID)OperationRegistration-&gt;PostOperation)) &#123;</span><br><span class="line">            Status = STATUS_ACCESS_DENIED;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¡«å……å½“å‰å›è°ƒé¡¹</span></span><br><span class="line">        CallbackEntry = &amp;CallbackHandle-&gt;CallbackEntryArray[i];</span><br><span class="line">        CallbackEntry-&gt;Operations = OperationRegistration-&gt;Operations;</span><br><span class="line">        CallbackEntry-&gt;CallbackHandle = CallbackHandle;</span><br><span class="line">        CallbackEntry-&gt;ObjectType = ObjectType;</span><br><span class="line">        CallbackEntry-&gt;PreOperation = OperationRegistration-&gt;PreOperation;</span><br><span class="line">        CallbackEntry-&gt;PostOperation = OperationRegistration-&gt;PostOperation;</span><br><span class="line">        CallbackEntry-&gt;Reserved = <span class="number">0</span>;</span><br><span class="line">        InitializeListHead(&amp;CallbackEntry-&gt;CallbackList);</span><br><span class="line"></span><br><span class="line">        Status = ObpInsertCallbackByAltitude(CallbackEntry, ObjectType);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(Status))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        CallbackHandle-&gt;OperationRegistrationCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [å¤±è´¥æ—¶æ¸…ç†å·²æ’å…¥å›è°ƒ]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(Status)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CallbackHandle-&gt;OperationRegistrationCount; ++i) &#123;</span><br><span class="line">            POB_CALLBACK_ENTRY Entry = &amp;CallbackHandle-&gt;CallbackEntryArray[i];</span><br><span class="line">            POBJECT_TYPE ObjectType = Entry-&gt;ObjectType;</span><br><span class="line">            EX_PUSH_LOCK* Lock = &amp;ObjectType-&gt;TypeLock;</span><br><span class="line"></span><br><span class="line">            KeEnterCriticalRegion();</span><br><span class="line">            ExAcquirePushLockExclusive(Lock);</span><br><span class="line">            RemoveEntryList(&amp;Entry-&gt;CallbackList);</span><br><span class="line">            ExReleasePushLockExclusive(Lock);</span><br><span class="line">            KeLeaveCriticalRegion();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ExFreePoolWithTag(CallbackHandle, <span class="string">&#x27;ObCl&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">        <span class="comment">// [æˆåŠŸï¼šæ ‡è®°æ‰€æœ‰å›è°ƒä¸ºæ¿€æ´»çŠ¶æ€]</span></span><br><span class="line">        <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CallbackHandle-&gt;OperationRegistrationCount; ++i) &#123;</span><br><span class="line">            CallbackHandle-&gt;CallbackEntryArray[i].Flags |= OB_CALLBACK_ACTIVE_FLAG;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *RegistrationHandle = CallbackHandle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>ObpInsertCallbackByAltitude</code> å‡½æ•°åˆ™ä¼šæ ¹æ® <code>Altitude</code> æ‰¾åˆ°åˆé€‚çš„ä½ç½®æ’å…¥é“¾è¡¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">ObpInsertCallbackByAltitude</span><span class="params">(</span></span><br><span class="line"><span class="params">    POB_CALLBACK_ENTRY CallbackEntry,</span></span><br><span class="line"><span class="params">    POBJECT_TYPE ObjectType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    PLIST_ENTRY CallbackListHead;</span><br><span class="line">    PLIST_ENTRY Current;</span><br><span class="line">    UNICODE_STRING* Altitude;</span><br><span class="line">    NTSTATUS Status = STATUS_SUCCESS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [è¿›å…¥å…³é”®åŒºï¼Œè·å–å¯¹è±¡ç±»å‹çš„å›è°ƒé”ï¼ˆPushLock æ’ä»–æ¨¡å¼ï¼‰]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    KeEnterCriticalRegion();</span><br><span class="line">    ExAcquirePushLockExclusive(&amp;ObjectType-&gt;TypeLock);</span><br><span class="line"></span><br><span class="line">    CallbackListHead = &amp;ObjectType-&gt;CallbackList;</span><br><span class="line">    Current = CallbackListHead-&gt;Flink;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ’å…¥é¡¹çš„ Altitudeï¼ˆä¼˜å…ˆçº§å­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">    Altitude = &amp;CallbackEntry-&gt;CallbackHandle-&gt;Altitude;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [éå†å¯¹è±¡ç±»å‹çš„å›è°ƒé“¾è¡¨ï¼ŒæŒ‰ Altitude é™åºæŸ¥æ‰¾æ’å…¥ä½ç½®]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">while</span> (Current != CallbackListHead) &#123;</span><br><span class="line">        POB_CALLBACK_ENTRY Entry =</span><br><span class="line">            CONTAINING_RECORD(Current, OB_CALLBACK_ENTRY, CallbackList);</span><br><span class="line"></span><br><span class="line">        POB_CALLBACK_HANDLE Registration = Entry-&gt;CallbackHandle;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> CompareResult = RtlCompareAltitudes(</span><br><span class="line">            &amp;Registration-&gt;Altitude,</span><br><span class="line">            Altitude</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (CompareResult &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Altitude ç›¸åŒè¡¨ç¤ºå†²çª</span></span><br><span class="line">            <span class="keyword">if</span> (CompareResult == <span class="number">0</span>) &#123;</span><br><span class="line">                Status = STATUS_FLT_INSTANCE_ALTITUDE_COLLISION;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Current = Current-&gt;Flink;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [æ‰§è¡Œæ’å…¥æˆ–å› å†²çªè¿”å›é”™è¯¯]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="keyword">if</span> (NT_SUCCESS(Status)) &#123;</span><br><span class="line">        InsertTailList(Current-&gt;Blink, &amp;CallbackEntry-&gt;CallbackList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">// [é‡Šæ”¾é”å¹¶æ¢å¤ APC çŠ¶æ€]</span></span><br><span class="line">    <span class="comment">// ------------------------------------------------------------</span></span><br><span class="line">    ExReleasePushLockExclusive(&amp;ObjectType-&gt;TypeLock);</span><br><span class="line">    KeLeaveCriticalRegion();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> windows å†…æ ¸å›è°ƒ</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2022-09-28 11:45:14</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-07-07 01:17:38
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2022/09/28/windows å†…æ ¸å›è°ƒ/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/windows-kernel-reverse/">#windows kernel reverse</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2022/09/28/windows%20%E5%8F%A5%E6%9F%84%E8%A1%A8/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">windows å¥æŸ„è¡¨</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2022/09/28/windows%20%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item">windows ç³»ç»Ÿè°ƒç”¨</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">windows å†…æ ¸å›è°ƒ</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E5%9E%8B%E5%9B%9E%E8%B0%83%EF%BC%88Notify-Callbacks%EF%BC%89"><span class="nav-text">ç³»ç»Ÿé€šçŸ¥å‹å›è°ƒï¼ˆNotify Callbacksï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%9B%9E%E8%B0%83"><span class="nav-text">è¿›ç¨‹å›è°ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C"><span class="nav-text">åŸºç¡€å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C"><span class="nav-text">æ‰©å±•å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%9B%9E%E8%B0%83%E5%88%86%E6%9E%90"><span class="nav-text">è¿›ç¨‹å›è°ƒåˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C"><span class="nav-text">å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E8%B0%83%E7%94%A8"><span class="nav-text">å›è°ƒè°ƒç”¨</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%9B%9E%E8%B0%83"><span class="nav-text">çº¿ç¨‹å›è°ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-1"><span class="nav-text">åŸºç¡€å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-1"><span class="nav-text">æ‰©å±•å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%9B%9E%E8%B0%83%E5%88%86%E6%9E%90"><span class="nav-text">çº¿ç¨‹å›è°ƒåˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-1"><span class="nav-text">å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E7%A7%BB%E9%99%A4"><span class="nav-text">å›è°ƒç§»é™¤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E8%B0%83%E7%94%A8-1"><span class="nav-text">å›è°ƒè°ƒç”¨</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%9B%9E%E8%B0%83"><span class="nav-text">æ¨¡å—å›è°ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-2"><span class="nav-text">åŸºç¡€å›è°ƒæ³¨å†Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C-2"><span class="nav-text">æ‰©å±•å›è°ƒæ³¨å†Œ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9B%9E%E8%B0%83%EF%BC%88Object-Callbacks%EF%BC%89"><span class="nav-text">å¯¹è±¡å›è°ƒï¼ˆObject Callbacksï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9B%9E%E8%B0%83%E4%BD%BF%E7%94%A8"><span class="nav-text">å¯¹è±¡å›è°ƒä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C%E5%8D%B8%E8%BD%BD"><span class="nav-text">å›è°ƒæ³¨å†Œå¸è½½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A2%84%E6%93%8D%E4%BD%9C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-text">é¢„æ“ä½œå›è°ƒå‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E6%93%8D%E4%BD%9C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="nav-text">åæ“ä½œå›è°ƒå‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9E%E8%B0%83%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="nav-text">å›è°ƒç›¸å…³ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OBJECT-TYPE"><span class="nav-text">OBJECT_TYPE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OBJECT-TYPE-INITIALIZER"><span class="nav-text">OBJECT_TYPE_INITIALIZER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OB-CALLBACK-HANDLE"><span class="nav-text">OB_CALLBACK_HANDLE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9B%9E%E8%B0%83%E5%88%86%E6%9E%90"><span class="nav-text">å¯¹è±¡å›è°ƒåˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9B%9E%E8%B0%83%E6%B3%A8%E5%86%8C"><span class="nav-text">å¯¹è±¡å›è°ƒæ³¨å†Œ</span></a></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        40 posts in total
                    </span>
                    
                        <span>
                            646.6k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.2</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>