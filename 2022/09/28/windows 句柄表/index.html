<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2022/09/28/windows å¥æŸ„è¡¨/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            windows å¥æŸ„è¡¨ | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["ä¹¦æœ‰æœªæ›¾ç»æˆ‘è¯»ï¼Œäº‹æ— ä¸å¯å¯¹äººè¨€"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"åˆ†ç±»":{"icon":"fa-solid fa-folder","path":"/categories/"},"æ ‡ç­¾":{"icon":"fa-solid fa-tags","path":"/tags/"},"ä¹¦ç­¾":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    åˆ†ç±»
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    æ ‡ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    ä¹¦ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                åˆ†ç±»
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                æ ‡ç­¾
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                ä¹¦ç­¾
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">13</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">16</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">51</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">windows å¥æŸ„è¡¨</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-09-28 11:45:14</span>
        <span class="mobile">2022-09-28 11:45:14</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-08-19 01:14:16</span>
            <span class="mobile">2025-08-19 01:14:16</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/reverse/">reverse</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/reverse/windows-kernel/">windows kernel</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/windows-kernel-reverse/">windows kernel reverse</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>12.6k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>50 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p><a class="link"   target="_blank" rel="noopener" href="https://www.vergiliusproject.com/" >https://www.vergiliusproject.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<p>åœ¨ Windows æ“ä½œç³»ç»Ÿä¸­ï¼Œ<strong>å¥æŸ„ï¼ˆHandleï¼‰</strong> æ˜¯ä¸€ç§ <strong>ç”¨äºæ ‡è¯†å’Œç®¡ç†ç³»ç»Ÿå¯¹è±¡çš„æŠ½è±¡å¼•ç”¨</strong>ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª <strong>ç´¢å¼•å€¼æˆ–å°æ•´æ•°</strong>ï¼Œç”±å†…æ ¸åˆ†é…ç»™ç”¨æˆ·æ€ç¨‹åºï¼Œç”¨æˆ·é€šè¿‡å®ƒé—´æ¥è®¿é—®å’Œæ“ä½œå†…æ ¸å¯¹è±¡ã€‚</p>
<p>åœ¨å†…æ ¸ä¸­ï¼Œå¥æŸ„æ˜¯é€šè¿‡<strong>å¥æŸ„è¡¨ï¼ˆHandle Tableï¼‰</strong>ç®¡ç†çš„ï¼š</p>
<ul>
<li>ç”¨æˆ·å¾—åˆ°çš„æ˜¯ä¸€ä¸ª <strong>æ•´æ•°å¥æŸ„å€¼ï¼ˆHANDLEï¼‰</strong>ã€‚</li>
<li>è¯¥å€¼æ˜¯å¥æŸ„è¡¨çš„ä¸€ä¸ªç´¢å¼•ï¼Œé€šè¿‡ <code>TableCode</code> åˆ†å±‚ç»“æ„å®šä½åˆ° <code>HANDLE_TABLE_ENTRY</code>ã€‚</li>
<li>æ¯ä¸ªè¡¨é¡¹æŒ‡å‘ä¸€ä¸ªçœŸæ­£çš„ <strong>å†…æ ¸å¯¹è±¡ï¼ˆå¦‚ EPROCESSã€ETHREAD ç­‰ï¼‰</strong>ã€‚</li>
</ul>
<p>é€šå¸¸æˆ‘ä»¬ç ”ç©¶çš„ Windows çš„å¥æŸ„è¡¨åŒ…æ‹¬<strong>ç§æœ‰å¥æŸ„è¡¨</strong>å’Œ<strong>å…¨å±€å¥æŸ„è¡¨</strong>ï¼š</p>
<ul>
<li><p><strong>ç§æœ‰å¥æŸ„è¡¨</strong> ï¼šè¿›ç¨‹å¯¹è±¡çš„ <code>EPROCESS-&gt;ObjectTable</code> æŒ‡å‘ç§æœ‰å¥æŸ„è¡¨ï¼Œå®ƒä¿å­˜è¯¥<strong>è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰å¯¹è±¡å¥æŸ„</strong>ï¼ˆè¿›ç¨‹ã€çº¿ç¨‹ã€åŒæ­¥å¯¹è±¡ç­‰ï¼‰ã€‚</p>
</li>
<li><p><strong>å…¨å±€å¥æŸ„è¡¨</strong> ï¼šå†…æ ¸çš„å…¨å±€å˜é‡ <code>PspCidTable</code> æŒ‡å‘å…¨å±€å¥æŸ„è¡¨ï¼Œä¿å­˜ç³»ç»Ÿæ‰€æœ‰çš„<strong>è¿›ç¨‹&#x2F;çº¿ç¨‹å¯¹è±¡å¥æŸ„</strong>ã€‚</p>
</li>
</ul>
<p>å¦å¤– <strong>Windows ç³»ç»Ÿä¸­å­˜åœ¨ä¸€äº›ç‰¹æ®Šå¥æŸ„ï¼ˆpseudo handlesï¼‰</strong>ï¼Œå®ƒä»¬ä¸æ˜¯ä»å¥æŸ„è¡¨ä¸­åˆ†é…æ¥çš„ï¼Œä½†å¯ä»¥åœ¨å¤§å¤šæ•° API ä¸­å½“ä½œå¸¸è§„å¥æŸ„ä½¿ç”¨ã€‚æœ€å¸¸è§çš„åŒ…æ‹¬ï¼š</p>
<table>
<thead>
<tr>
<th>å¥æŸ„å€¼</th>
<th>å«ä¹‰</th>
<th>ç­‰ä»·å‡½æ•°è°ƒç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>-1</code> æˆ– <code>((HANDLE)-1)</code></td>
<td>å½“å‰è¿›ç¨‹å¥æŸ„ï¼ˆCurrent Processï¼‰</td>
<td><code>GetCurrentProcess()</code></td>
</tr>
<tr>
<td><code>-2</code> æˆ– <code>((HANDLE)-2)</code></td>
<td>å½“å‰çº¿ç¨‹å¥æŸ„ï¼ˆCurrent Threadï¼‰</td>
<td><code>GetCurrentThread()</code></td>
</tr>
<tr>
<td><code>-3</code> æˆ– <code>((HANDLE)-3)</code></td>
<td>å½“å‰è¿›ç¨‹çš„è°ƒè¯•å¯¹è±¡ï¼ˆCurrent Debug Objectï¼‰</td>
<td><code>NtQueryInformationProcess</code> å¯ç”¨</td>
</tr>
<tr>
<td><code>-4</code> æˆ– <code>((HANDLE)-4)</code></td>
<td>å½“å‰è¿›ç¨‹çš„ç›®å½•å¥æŸ„ï¼ˆCurrent Directory Handleï¼‰</td>
<td>å†…éƒ¨ç”¨ï¼ˆéƒ¨åˆ† API æ”¯æŒï¼‰</td>
</tr>
</tbody></table>
<h1 id="å¥æŸ„è¡¨ç›¸å…³ç»“æ„"><a href="#å¥æŸ„è¡¨ç›¸å…³ç»“æ„" class="headerlink" title="å¥æŸ„è¡¨ç›¸å…³ç»“æ„"></a>å¥æŸ„è¡¨ç›¸å…³ç»“æ„</h1><h2 id="EXHANDLE"><a href="#EXHANDLE" class="headerlink" title="EXHANDLE"></a>EXHANDLE</h2><p>å¥æŸ„ <code>HANDLE</code> çš„å®é™…ç»“æ„æ˜¯ <code>EXHANDLE</code>ï¼Œè¯¥ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Ex/Ob å¥æŸ„è¡¨æ¥å£åŒ…ï¼ˆå®šä¹‰äº handle.cï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Ex/Ob ä½¿ç”¨ç»Ÿä¸€çš„å¥æŸ„å®šä¹‰æ ¼å¼ã€‚</span></span><br><span class="line"><span class="comment">// è™½ç„¶å¥æŸ„åœ¨ SDK ä¸­è¢«å®šä¹‰ä¸º PVOIDï¼ˆvoid æŒ‡é’ˆï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½†æœ¬æ¨¡å—åªä½¿ç”¨è¯¥æŒ‡é’ˆçš„ä½ 32 ä½ï¼ˆå³ DWORDï¼‰ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// ä¸ºç®€åŒ–æ“ä½œï¼Œè¿™é‡Œé‡æ–°å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ç±»å‹ï¼šEXHANDLEï¼Œ</span></span><br><span class="line"><span class="comment">// ç”¨äºè§£æ„å¥æŸ„å†…éƒ¨çš„ä½å­—æ®µã€‚</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// EXHANDLE çš„æœ€ä½ 2 ä½ï¼ˆTagBitsï¼‰ä¿ç•™ç»™ç”¨æˆ·ç¨‹åºä½¿ç”¨ï¼Œ</span></span><br><span class="line"><span class="comment">// ç³»ç»Ÿåœ¨å¥æŸ„è§£ææ—¶ä¼šå¿½ç•¥å®ƒä»¬ï¼›</span></span><br><span class="line"><span class="comment">// æ¥ä¸‹æ¥çš„ 30 ä½ï¼ˆIndexï¼‰ç”¨äºå®šä½å¥æŸ„è¡¨ä¸­çš„è¡¨é¡¹ç´¢å¼•ã€‚</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// âš  æ³¨æ„ï¼šè¿™ç§å¥æŸ„ç¼–ç æ ¼å¼æ˜¯ä¸å¯æ›´æ”¹çš„ï¼Œ</span></span><br><span class="line"><span class="comment">// å› ä¸ºä¸€äº›å¤–éƒ¨ç¨‹åºå·²å‡è®¾å¥æŸ„å…·æœ‰è¿™ç§å›ºå®šæ ¼å¼ã€‚</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EXHANDLE</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// ç”¨æˆ·ç¨‹åºå¯ä½¿ç”¨çš„æ ‡ç­¾ä½ï¼ˆbit0~1ï¼‰ï¼š</span></span><br><span class="line">            <span class="comment">// - è¿™ä¸¤ä½å¯¹ç³»ç»Ÿæ— æ„ä¹‰ï¼Œä¸å‚ä¸å¥æŸ„æŸ¥æ‰¾ï¼›</span></span><br><span class="line">            <span class="comment">// - ç”¨æˆ·å¯ç”¨ä½œå¥æŸ„ç±»å‹åŒºåˆ†ã€è°ƒè¯•æ ‡è®°ç­‰ï¼›</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG TagBits : <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// å¥æŸ„ç´¢å¼•å­—æ®µï¼ˆbit2~31ï¼‰ï¼š</span></span><br><span class="line">            <span class="comment">// - æ€»å…± 30 ä½ï¼›</span></span><br><span class="line">            <span class="comment">// - æŒ‡å‘å¥æŸ„è¡¨ä¸­çš„ HANDLE_TABLE_ENTRY é¡¹ï¼›</span></span><br><span class="line">            <span class="comment">// - å®é™…å¥æŸ„å€¼ / 4 å³ä¸ºè¯¥ç´¢å¼•ï¼ˆå› ä¸ºå¥æŸ„æ­¥é•¿ä¸º 4ï¼‰ï¼›</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            ULONG Index : <span class="number">30</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// åŸå§‹å¥æŸ„å€¼ï¼ˆPVOID å¼ºè½¬ï¼‰ï¼Œå¯¹åº”ç”¨æˆ·å±‚çœ‹åˆ°çš„ HANDLE å€¼</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        HANDLE GenericHandleOverlay;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_VALUE_INC 4  <span class="comment">// å¥æŸ„æ­¥é•¿ä¸º 4ï¼Œæ¯ä¸ªå¥æŸ„ä¹‹é—´é—´éš” 4 å­—èŠ‚ï¼ˆä¸ Index ç¼–ç ä¸€è‡´ï¼‰</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å¥æŸ„çš„æ•´å‹è¡¨ç¤ºï¼Œå¯ç”¨äºä½è¿ç®—å¤„ç†</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        ULONG_PTR Value;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125; EXHANDLE, *PEXHANDLE;</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå¥æŸ„çš„ä½ 2 ä½æ˜¯ä¿ç•™ä½ï¼ˆé€šå¸¸ç½® 0ï¼‰ï¼ŒçœŸæ­£æœ‰æ•ˆçš„æ˜¯é«˜ 30 ä½ï¼Œæ˜¯å¥æŸ„å¯¹åº”åœ¨å¥æŸ„è¡¨ä¸­çš„ç´¢å¼•ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>æˆ‘ä»¬å¸¸è¯´çš„è¿›ç¨‹ IDï¼ˆ<code>pid</code>ï¼‰ å®é™…ä¸Šä¹Ÿæ˜¯å¥æŸ„ï¼Œç”±äºå¥æŸ„ä½ 2 ä½æ˜¯ä¿ç•™ä½ï¼Œå› æ­¤æˆ‘ä»¬çœ‹åˆ°çš„ <code>pid</code> éƒ½æ˜¯ 4 çš„å€æ•°ã€‚</p>

    </div>
  </div>

<h2 id="HANDLE-TABLE"><a href="#HANDLE-TABLE" class="headerlink" title="HANDLE_TABLE"></a>HANDLE_TABLE</h2><p>Windows çš„å¥æŸ„è¡¨çš„æ˜¯ä¸€ä¸ª <code>HANDLE_TABLE</code> ç±»å‹çš„ç»“æ„ä½“ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x3C bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG TableCode;                                      <span class="comment">// 0x00: ğŸ“Œç¼–ç åçš„å¥æŸ„è¡¨å…¥å£ç´¢å¼•ï¼ˆå«ç±»å‹ä¿¡æ¯ä¸åç§»ï¼‰ï¼Œç”¨äºè§£æå¥æŸ„ç´¢å¼•å®šä½è¡¨é¡¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EPROCESS</span>* <span class="title">QuotaProcess</span>;</span>                       <span class="comment">// 0x04: æ‰€å±è¿›ç¨‹çš„ EPROCESS æŒ‡é’ˆï¼Œæ§åˆ¶å¥æŸ„åˆ›å»ºæ—¶çš„é…é¢é™åˆ¶ä¸èµ„æºè®¡è´¹</span></span><br><span class="line">    VOID* UniqueProcessId;                                <span class="comment">// 0x08: æ‹¥æœ‰è¯¥å¥æŸ„è¡¨çš„è¿›ç¨‹ IDï¼ˆPIDï¼‰ï¼Œè¾…åŠ©èº«ä»½ç»‘å®šä¸è°ƒè¯•åˆ†æ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">HandleLock</span>;</span>                      <span class="comment">// 0x0C: æ§åˆ¶æ•´ä¸ªå¥æŸ„è¡¨è®¿é—®çš„æ¨é”ï¼ˆè¯»å†™å…±äº«ï¼‰ï¼Œç”¨äºå¤šæ ¸å¹¶å‘ä¿æŠ¤</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">HandleTableList</span>;</span>                   <span class="comment">// 0x10: ğŸ“Œæ‰€æœ‰å¥æŸ„è¡¨çš„å…¨å±€é“¾è¡¨ï¼ˆæ¯ä¸ªè¿›ç¨‹çš„ç§æœ‰å¥æŸ„è¡¨éƒ½ä¼šæŒ‚åœ¨æ­¤é“¾ä¸­ï¼‰ï¼Œä¾¿äºæšä¸¾ä¸è°ƒè¯•</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">HandleContentionEvent</span>;</span>           <span class="comment">// 0x18: ç”¨äºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„äº‰ç”¨é€šçŸ¥æœºåˆ¶ï¼Œè¾…åŠ©è°ƒä¼˜ä¸é”ç­‰å¾…å”¤é†’</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TRACE_DEBUG_INFO</span>* <span class="title">DebugInfo</span>;</span>           <span class="comment">// 0x1C: å¯é€‰çš„è°ƒè¯•ç»“æ„ä½“æŒ‡é’ˆï¼Œå¯ç”¨å¥æŸ„åˆ›å»º/å…³é—­è®°å½•ç”¨äºæ³„æ¼åˆ†æ</span></span><br><span class="line">    LONG ExtraInfoPages;                                  <span class="comment">// 0x20: åˆ†é…ç»™å¥æŸ„é™„åŠ ä¿¡æ¯çš„é¡µæ•°ï¼Œé€šå¸¸ç”¨äºå¯¹è±¡å±æ€§æˆ–è°ƒè¯•æ•°æ®æ‰©å±•</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG Flags;                                      <span class="comment">// 0x24: æ§åˆ¶å¥æŸ„è¡¨è¡Œä¸ºçš„æ ‡å¿—å­—æ®µï¼ˆç»„åˆä½æ ‡å¿—ï¼‰</span></span><br><span class="line">        UCHAR StrictFIFO:<span class="number">1</span>;                               <span class="comment">// bit 0: æ˜¯å¦å¯ç”¨ä¸¥æ ¼çš„ FIFO ç­–ç•¥ç®¡ç†å¥æŸ„é‡Šæ”¾ï¼ˆç”¨äºè°ƒè¯•å’Œèµ„æºå›æ”¶é¡ºåºï¼‰</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG FirstFreeHandle;                                <span class="comment">// 0x28: å½“å‰å¯ç”¨çš„ç¬¬ä¸€ä¸ªç©ºé—²å¥æŸ„ç´¢å¼•ï¼ŒåŠ é€Ÿåˆ†é…æ—¶çš„æœç´¢è·¯å¾„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE_ENTRY</span>* <span class="title">LastFreeHandleEntry</span>;</span>      <span class="comment">// 0x2C: æŒ‡å‘æœ€åä¸€ä¸ªç©ºé—²å¥æŸ„é¡¹çš„æŒ‡é’ˆï¼ˆé…åˆç©ºé—²é“¾è¡¨å®ç°å¥æŸ„å¤ç”¨ï¼‰</span></span><br><span class="line">    ULONG HandleCount;                                    <span class="comment">// 0x30: å½“å‰æ­£åœ¨ä½¿ç”¨çš„å¥æŸ„æ•°é‡ï¼ˆä¸å«ç©ºé—²ï¼‰ï¼Œç”¨äºèµ„æºé…é¢ä¸è°ƒè¯•ç»Ÿè®¡</span></span><br><span class="line">    ULONG NextHandleNeedingPool;                          <span class="comment">// 0x34: ä¸‹ä¸€æ¬¡åˆ†é…å¥æŸ„æ—¶å¯èƒ½è§¦å‘æ± å†…å­˜æ‰©å±•çš„ä½ç½®ï¼ˆé¢„è­¦/å¢é•¿ç­–ç•¥ï¼‰</span></span><br><span class="line">    ULONG HandleCountHighWatermark;                       <span class="comment">// 0x38: æ›¾ç»è¾¾åˆ°çš„æœ€å¤§å¥æŸ„æ•°é‡ï¼ˆé«˜æ°´ä½çº¿ï¼‰ï¼Œç”¨äºæ€§èƒ½è¯„ä¼°ä¸èµ„æºè·Ÿè¸ª</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºéœ€è¦æ”¯æŒå¥æŸ„çš„é«˜æ•ˆç®¡ç†ï¼ŒWindows å†…æ ¸é‡‡ç”¨äº†<strong>åˆ†å±‚å¥æŸ„è¡¨æœºåˆ¶</strong>ï¼ˆLayered Handle Tableï¼‰ï¼Œç±»ä¼¼äºå¤šçº§é¡µè¡¨ã€‚å…¶æ ¸å¿ƒç»“æ„æ˜¯ <code>_HANDLE_TABLE</code>ï¼Œå…¶å­—æ®µ <code>TableCode</code> å†³å®šäº†æ•´ä¸ªè¡¨çš„å±‚çº§ç»“æ„å’Œå…¥å£åœ°å€ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2022/09/28/windows%20%E5%8F%A5%E6%9F%84%E8%A1%A8/images/HandleTable.svg"
                      alt="HandleTable"
                ></p>
<p><code>TableCode</code> æ˜¯ä¸€ä¸ªç¼–ç æŒ‡é’ˆï¼ˆEncoded Pointerï¼‰ï¼š</p>
<ul>
<li><strong>ä½ 2 ä½</strong>ï¼ˆbit0 å’Œ bit1ï¼‰ï¼šè¡¨ç¤ºå¥æŸ„è¡¨çš„<strong>å±‚çº§æ•°</strong>ï¼Œå–å€¼èŒƒå›´ä¸º 0~2ã€‚</li>
<li><strong>æ¸…é™¤ä½ 2 ä½å</strong> ï¼šæ˜¯å¥æŸ„è¡¨æ ¹èŠ‚ç‚¹çš„å®é™…åœ°å€ï¼ˆå³æŒ‡å‘ç¬¬ 1 å±‚çš„ç›®å½•é¡µï¼‰ã€‚</li>
</ul>
<p>å¥æŸ„è¡¨çš„æ¯ä¸€å±‚ç»“æ„å•ä½æ˜¯ä¸€ä¸ªå†…å­˜é¡µï¼ˆé€šå¸¸ä¸º 4KBï¼‰ï¼Œå…¶å…·ä½“å†…å®¹å–å†³äºè¯¥å±‚çš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>å¦‚æœè¯¥å±‚ç”¨äºç›®å½•ç´¢å¼•ï¼ˆå³å­˜æ”¾æŒ‡é’ˆï¼‰</strong>ï¼Œé‚£ä¹ˆè¿™ä¸ªå†…å­˜é¡µä¸­ä¼šåŒ…å« <strong>1024 ä¸ªæŒ‡é’ˆé¡¹</strong>ï¼ˆæ¯ä¸ªæŒ‡é’ˆå¤§å°ä¸º 4 å­—èŠ‚ â†’ 4 Ã— 1024 &#x3D; 4096 å­—èŠ‚ï¼‰ï¼Œ<strong>64ä½ç³»ç»Ÿåˆ™æ˜¯ 512 ä¸ªæŒ‡é’ˆé¡¹</strong>ã€‚</li>
<li><strong>å¦‚æœæ˜¯æœ€åº•å±‚çš„å¥æŸ„é¡¹é¡µ</strong>ï¼Œåˆ™è¯¥é¡µç”¨äºå­˜æ”¾å®é™…çš„ <code>HANDLE_TABLE_ENTRY</code> æ•°ç»„ã€‚æ¯ä¸ªå¥æŸ„é¡¹å¤§å°ä¸º 8 å­—èŠ‚ï¼ˆ32 ä½ç³»ç»Ÿï¼‰ï¼Œä¸€é¡µå¯å®¹çº³ <strong>512 ä¸ªå¥æŸ„é¡¹</strong>ï¼ˆ512 Ã— 8 &#x3D; 4096 å­—èŠ‚ï¼‰ï¼Œ<strong>64ä½ç³»ç»Ÿåˆ™æ˜¯ 256 ä¸ªæŒ‡é’ˆé¡¹</strong>ã€‚</li>
</ul>
<p>2 å±‚ç»“æ„å¯¹äº 32 ä½ç³»ç»Ÿå¯æ”¯æŒ 1024 Ã— 1024 Ã— 512 &#x3D; è¶…è¿‡ 5 äº¿ä¸ªå¥æŸ„é¡¹ï¼›å¯¹äº 64 ä½ç³»ç»Ÿå¯æ”¯æŒ 512 Ã— 512 Ã— 256 &#x3D; è¶…è¿‡ 6 åƒä¸‡ä¸ªå¥æŸ„é¡¹ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿™é‡Œæåˆ°çš„å†…å­˜é¡µæŒ‡çš„æ˜¯<strong>å¥æŸ„è¡¨çš„æ¯ä¸€å±‚ç»“æ„å•ä½çš„å¤§å°æ˜¯ 4KB</strong>ï¼Œç›¸å½“äºå†…å­˜é¡µçš„å¤§å°ï¼Œä½†å®é™…ä¸Šå¹¶ä¸æ˜¯çœŸæ­£å¯¹åº”ä¸€ä¸ªå†…å­˜é¡µï¼Œæœ‰äº›æƒ…å†µä¸‹å¥æŸ„è¡¨çš„ç»“æ„å•ä½åœ°å€å¹¶ä¸å…³äº 0x1000 å¯¹é½ã€‚</p>

    </div>
  </div>

<h2 id="HANDLE-TABLE-ENTRY"><a href="#HANDLE-TABLE-ENTRY" class="headerlink" title="HANDLE_TABLE_ENTRY"></a>HANDLE_TABLE_ENTRY</h2><p>å¥æŸ„é¡¹æ˜¯ä¸€ä¸ª <code>HANDLE_TABLE_ENTRY</code> ç±»å‹çš„ç»“æ„ä½“ï¼Œè¯¥ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x8 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        VOID* Object;                                      <span class="comment">// 0x00: æŒ‡å‘å®é™…å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆï¼ˆå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€äº‹ä»¶ç­‰ï¼‰ï¼Œæ˜¯å¥æŸ„çš„æ ¸å¿ƒç»‘å®šç›®æ ‡</span></span><br><span class="line">        ULONG ObAttributes;                                <span class="comment">// 0x00: å¯¹è±¡å±æ€§å­—æ®µï¼ŒåŒ…å«ä¿æŠ¤æ ‡å¿—ã€ç»§æ‰¿æ§åˆ¶ç­‰</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE_ENTRY_INFO</span>* <span class="title">InfoTable</span>;</span>        <span class="comment">// 0x00: æŒ‡å‘é™„åŠ ä¿¡æ¯è¡¨ï¼ˆæ‰©å±•è®¿é—®æƒé™ã€å®¡è®¡ç­‰ï¼‰ï¼Œç”±å†…æ ¸åœ¨å¿…è¦æ—¶ä½¿ç”¨</span></span><br><span class="line">        ULONG Value;                                       <span class="comment">// 0x00: åŸå§‹å€¼è¡¨ç¤ºï¼Œç”¨äºå¿«é€Ÿæ¸…é›¶ã€æ ‡å¿—æ§åˆ¶æˆ–è°ƒè¯•ç”¨é€”ï¼ˆä½å­—æ®µï¼‰</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONG GrantedAccess;                               <span class="comment">// 0x04: åˆ†é…ç»™å¥æŸ„çš„è®¿é—®æƒé™æ©ç ï¼ˆå¦‚è¯»å†™ã€åŒæ­¥ã€æ§åˆ¶ç­‰ï¼‰</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">        &#123;</span></span><br><span class="line">            USHORT GrantedAccessIndex;                     <span class="comment">// 0x04: æƒé™è¡¨ä¸­çš„è®¿é—®ç´¢å¼•ï¼Œé—´æ¥æ˜ å°„å…·ä½“æƒé™å€¼ï¼ŒèŠ‚çœç©ºé—´</span></span><br><span class="line">            USHORT CreatorBackTraceIndex;                  <span class="comment">// 0x06: åˆ›å»ºè¯¥å¥æŸ„çš„è°ƒç”¨æ ˆç´¢å¼•ï¼Œç”¨äºè°ƒè¯•å¥æŸ„æ³„æ¼ï¼ˆä»…å¼€å¯è¿½è¸ªæ—¶æœ‰æ•ˆï¼‰</span></span><br><span class="line">        &#125;;</span><br><span class="line">        ULONG NextFreeTableEntry;                          <span class="comment">// 0x04: è‹¥è¯¥é¡¹ç©ºé—²ï¼Œåˆ™ä½œä¸ºç©ºé—²é“¾è¡¨çš„ä¸€éƒ¨åˆ†ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å¥æŸ„ç´¢å¼•</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>Object</code>ï¼šæŒ‡å‘å®é™…å†…æ ¸å¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<ul>
<li>å¯¹äº<strong>å…¨å±€å¥æŸ„è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘<strong>è¿›ç¨‹æˆ–çº¿ç¨‹å¯¹è±¡</strong>ã€‚</li>
<li>å¯¹äº<strong>ç§æœ‰å¥æŸ„è¡¨</strong>ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘<strong>å†…æ ¸å¯¹è±¡å‰é¢çš„ <code>OBJECT_HEADER</code></strong> ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Š <code>sizeof(_OBJECT_HEADER)</code> åç§»æ‰èƒ½æ‰¾åˆ°å¥æŸ„è¡¨é¡¹å®é™…å¯¹åº”çš„å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><p><code>ObAttributes</code>ï¼š<strong>å†…æ ¸å¯¹è±¡</strong>çš„<strong>å¥æŸ„å±æ€§</strong>ï¼Œä¸ <code>Object</code> å…¬ç”¨åŒä¸€å—å†…å­˜ï¼Œå ç”¨æœ€ä½ 3 ä½ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_PROTECT_CLOSE       0x00000001L</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_INHERIT             0x00000002L</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_AUDIT_OBJECT_CLOSE  0x00000004L</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_HANDLE_ATTRIBUTES (OBJ_PROTECT_CLOSE | OBJ_INHERIT | OBJ_AUDIT_OBJECT_CLOSE)</span></span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤è·å–å†…æ ¸å¯¹è±¡çš„æ—¶å€™éœ€è¦å»é™¤è¿™ä¸‰ä¸ªæ ‡å¿—ä½ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(ULONG_PTR)(HandleTableEntry-&gt;Object) &amp; ~OBJ_HANDLE_ATTRIBUTES</span><br></pre></td></tr></table></figure></div>

<p>è¿™ 3 ä¸ªæ ‡å¿—ä½çš„åŠŸèƒ½æ˜¯ï¼š</p>
<ul>
<li><p><code>OBJ_PROTECT_CLOSE</code>ï¼šå³ <code>EXHANDLE_TABLE_ENTRY_LOCK_BIT</code>ï¼Œæ˜¯<strong>å¥æŸ„è¡¨é¡¹çš„é”</strong>ã€‚å½“<strong>è¿™ä¸ªä½ä¸º 0 çš„æ—¶å€™è¡¨ç¤ºå¥æŸ„è¡¨é¡¹è¢«åŠ é”</strong>ã€‚</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å¯¹äº<strong>ç§æœ‰å¥æŸ„è¡¨</strong>å¦‚æœæˆ‘ä»¬æ¸…ç©ºäº†å¥æŸ„è¡¨è¡¨é¡¹çš„ <code>Object</code> çš„è¿™ä¸ªä½å°±è¡¨ç¤ºè¿™ä¸ªå¥æŸ„è¢«åŠ é”äº†ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬é€€å‡ºè¿›ç¨‹æˆ–è€…å…³é—­è¿™ä¸ªå¥æŸ„éƒ½è¦ç­‰å¾…è¿™ä¸ªå¥æŸ„çš„é”ï¼Œä¹Ÿå°±ä¼šæŠŠè¿›ç¨‹å¡æ­»ã€‚</p>

    </div>
  </div>
</li>
<li><p><code>OBJ_INHERIT</code>ï¼šåœ¨<strong>ç§æœ‰å¥æŸ„è¡¨</strong>çš„è¡¨é¡¹ä¸­ä½¿ç”¨ï¼Œè¡¨ç¤º<strong>å¥æŸ„æ˜¯å¦è¢«ç»§æ‰¿</strong>ã€‚å½“è¿™ä¸ªä½ä¸º 1 çš„æ—¶å€™è¡¨ç¤ºå¥æŸ„å¯ä»¥è¢«å­è¿›ç¨‹ç»§æ‰¿ï¼Œè¿™ä¸ªå¥æŸ„è¡¨é¡¹ä¼šåœ¨è¯¥è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™å¤åˆ¶åˆ°å­è¿›ç¨‹çš„ç§æœ‰è¡¨çš„<strong>ç›¸åŒä½ç½®</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>å¥æŸ„å€¼ç›¸åŒ</strong>ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>OpenProcess</code> çš„ç¬¬äºŒä¸ªå‚æ•° <code>bInheritHandle</code> å¯¹åº”çš„æ˜¯ <code>OBJ_INHERIT</code>ã€‚æˆ‘ä»¬å¯ä»¥å‘ç™½åå•è¿›ç¨‹æ³¨å…¥ä»£ç ï¼Œé€šè¿‡ <code>OpenProcess</code> æ‰“å¼€å—ä¿æŠ¤è¿›ç¨‹è·å–å¯ç»§æ‰¿çš„å¥æŸ„ï¼Œç„¶åå†åˆ›å»ºè‡ªå·±çš„è¿›ç¨‹ï¼Œå°†è¯¥å¥æŸ„ç»§æ‰¿åˆ°è‡ªå·±çš„è¿›ç¨‹ä¸­å»ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">DWORD WINAPI <span class="title function_">InjectedMain</span><span class="params">(LPVOID lpParam)</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD targetPid = *(DWORD *)lpParam;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€ç›®æ ‡å—ä¿æŠ¤è¿›ç¨‹ï¼ˆå¿…é¡»å¯è®¿é—®ï¼‰</span></span><br><span class="line">    HANDLE hTarget = OpenProcess(PROCESS_ALL_ACCESS, TRUE, targetPid);</span><br><span class="line">    <span class="keyword">if</span> (!hTarget) &#123;</span><br><span class="line">        <span class="keyword">return</span> GetLastError(); <span class="comment">// æ‰“å¼€å¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªç»§æ‰¿å¥æŸ„çš„æ–°å­è¿›ç¨‹ï¼ˆæ³¨æ„ bInheritHandles = TRUEï¼‰</span></span><br><span class="line">    STARTUPINFOW si = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    PROCESS_INFORMATION pi = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    si.cb = <span class="keyword">sizeof</span>(si);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘½ä»¤è¡ŒæŒ‡å‘ä½ æ§åˆ¶çš„ç¨‹åº</span></span><br><span class="line">    WCHAR cmdLine[] = <span class="string">L&quot;C:\\Windows\\System32\\notepad.exe&quot;</span>;</span><br><span class="line"></span><br><span class="line">    BOOL success = CreateProcessW(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        cmdLine,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">        TRUE,                      <span class="comment">// bInheritHandles: å…è®¸ç»§æ‰¿å¥æŸ„</span></span><br><span class="line">        CREATE_NEW_CONSOLE,</span><br><span class="line">        <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">        &amp;si, &amp;pi</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        CloseHandle(hTarget);</span><br><span class="line">        <span class="keyword">return</span> GetLastError(); <span class="comment">// åˆ›å»ºå¤±è´¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯é€‰ï¼šå…³é—­ç›®æ ‡å¥æŸ„ï¼ˆæ­¤æ—¶å®ƒå·²è¢«å­è¿›ç¨‹ç»§æ‰¿ï¼‰</span></span><br><span class="line">    CloseHandle(hTarget);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    WaitForSingleObject(pi.hProcess, INFINITE);</span><br><span class="line"></span><br><span class="line">    CloseHandle(pi.hProcess);</span><br><span class="line">    CloseHandle(pi.hThread);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>
</li>
<li><p><code>OBJ_AUDIT_OBJECT_CLOSE</code>ï¼šåŒæ ·æ˜¯åœ¨<strong>ç§æœ‰å¥æŸ„è¡¨</strong>çš„è¡¨é¡¹ä¸­ä½¿ç”¨ï¼Œè¡¨ç¤ºå½“å…³é—­è¿™ä¸ªå¥æŸ„æ—¶è¿›è¡Œ<strong>å®¡è®¡è®°å½•</strong>ï¼ˆAuditï¼‰ï¼Œå³ç»“åˆå¯¹è±¡çš„ SACLï¼ˆç³»ç»Ÿè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰æ¥è®°å½•è°ä»€ä¹ˆæ—¶å€™å…³é—­äº†å¥æŸ„ã€‚åªæœ‰åœ¨å¯¹è±¡å…·æœ‰å®‰å…¨æè¿°ç¬¦å¹¶å¯ç”¨å®¡è®¡ç­–ç•¥æ—¶ï¼Œæ‰æœ‰æ„ä¹‰ã€‚</p>
</li>
</ul>
</li>
<li><p><code>GrantedAccess</code>ï¼šå¥æŸ„æƒé™ï¼Œ<strong>ä¸€èˆ¬åœ¨ç§æœ‰å¥æŸ„è¡¨ä¸­ä½¿ç”¨</strong>ï¼Œå…¨å±€å¥æŸ„è¡¨ä¸ä½¿ç”¨è¯¥å­—æ®µã€‚</p>
</li>
</ul>
<p>å¯¹äº Windows 10 å¼€å§‹çš„ 64 ä½ç³»ç»Ÿï¼Œåœ¨è·å–åˆ° <code>HANDLE_TABLE_ENTRY</code> çš„å‰ 16 ä½æ˜¯ <code>RefCnt</code> æ˜¯å¥æŸ„çš„å¼•ç”¨è®¡æ•°å€¼ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x10 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">union</span> _<span class="title">HANDLE_TABLE_ENTRY</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> LONGLONG VolatileLowValue;                          <span class="comment">// 0x00: åŸå­è®¿é—®çš„ä½ 64 ä½å€¼ï¼Œç”¨äºå¹¶å‘åœºæ™¯ä¸‹çš„è¡¨é¡¹åŒæ­¥æ“ä½œ</span></span><br><span class="line">    LONGLONG LowValue;                                           <span class="comment">// 0x00: è¡¨é¡¹çš„æ™®é€šä½ä½è¡¨ç¤ºï¼ŒåŒ…å«å¥æŸ„æŒ‡å‘çš„å¯¹è±¡æˆ–é™„åŠ ä¿¡æ¯æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE_ENTRY_INFO</span>* <span class="title">volatile</span> <span class="title">InfoTable</span>;</span>     <span class="comment">// 0x00: æŒ‡å‘å¥æŸ„é™„åŠ ä¿¡æ¯ç»“æ„çš„æŒ‡é’ˆï¼ˆå¯èƒ½åŒ…å«å®¡è®¡ã€å±æ€§ç­‰æ‰©å±•ï¼‰</span></span><br><span class="line">        LONGLONG HighValue;                                      <span class="comment">// 0x08: é«˜ä½ä¿¡æ¯ï¼Œé€šå¸¸ä¸ä½ä½ç»„åˆè¡¨ç¤ºå®Œæ•´å¥æŸ„ä¿¡æ¯å—</span></span><br><span class="line">        <span class="class"><span class="keyword">union</span> _<span class="title">HANDLE_TABLE_ENTRY</span>* <span class="title">NextFreeHandleEntry</span>;</span>          <span class="comment">// 0x08: è‹¥ä¸ºç©ºé—²é¡¹æ—¶ï¼Œç”¨ä½œç©ºé—²é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå¯ç”¨å¥æŸ„æŒ‡é’ˆ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">EXHANDLE</span> <span class="title">LeafHandleValue</span>;</span>                        <span class="comment">// 0x08: è¡¨ç¤ºå¥æŸ„å¶èŠ‚ç‚¹å€¼çš„ç»“æ„ä½“ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ä¸å‹ç¼©è¡¨ç¤ºï¼‰</span></span><br><span class="line">    &#125;;</span><br><span class="line">    LONGLONG RefCountField;                                      <span class="comment">// 0x00: å¼•ç”¨è®¡æ•°å­—æ®µï¼ˆå«æ ‡å¿—ä½ï¼‰ï¼Œç”¨äºå†…æ ¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ§åˆ¶</span></span><br><span class="line">    ULONGLONG Unlocked:<span class="number">1</span>;                                        <span class="comment">// 0x00: ä½ 0ï¼šæ˜¯å¦æœªåŠ é”ï¼ˆ1 è¡¨ç¤ºç©ºé—²æˆ–æœªæŒæœ‰é”ï¼‰</span></span><br><span class="line">    ULONGLONG RefCnt:<span class="number">16</span>;                                         <span class="comment">// 0x00: ä½ 1â€“16ï¼šå¥æŸ„çš„å¼•ç”¨è®¡æ•°å€¼ï¼ˆæœ€å¤š 65535 æ¬¡å¼•ç”¨ï¼‰</span></span><br><span class="line">    ULONGLONG Attributes:<span class="number">3</span>;                                      <span class="comment">// 0x00: ä½ 17â€“19ï¼šå¥æŸ„å±æ€§æ ‡å¿—ï¼ˆå¦‚æ˜¯å¦ç»§æ‰¿ã€ä¿æŠ¤ç­‰ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        ULONGLONG ObjectPointerBits:<span class="number">44</span>;                          <span class="comment">// 0x00: ä½ 20â€“63ï¼šå®é™…å¯¹è±¡æŒ‡é’ˆçš„é«˜æ•ˆç¼–ç ï¼ˆåœ°å€ä½éƒ¨åˆ†ï¼‰</span></span><br><span class="line">        ULONG GrantedAccessBits:<span class="number">25</span>;                              <span class="comment">// 0x08: æˆäºˆè¯¥å¥æŸ„çš„è®¿é—®æƒé™æ©ç ï¼ˆå‹ç¼©è¡¨ç¤ºï¼‰</span></span><br><span class="line">        ULONG NoRightsUpgrade:<span class="number">1</span>;                                 <span class="comment">// 0x08: æ˜¯å¦ç¦æ­¢æƒé™è‡ªåŠ¨å‡çº§ï¼ˆå¦‚ DuplicateHandle é™åˆ¶ï¼‰</span></span><br><span class="line">        ULONG Spare1:<span class="number">6</span>;                                          <span class="comment">// 0x08: ä¿ç•™å­—æ®µï¼Œå½“å‰æœªä½¿ç”¨ï¼ˆç”¨äºå¯¹é½æˆ–æœªæ¥æ‰©å±•ï¼‰</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ULONG Spare2;                                                <span class="comment">// 0x0C: é¢„ç•™å­—æ®µï¼Œç”¨äºè°ƒè¯•æˆ–ç»“æ„å¯¹é½è¡¥å……ç©ºé—´</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ <code>ExGetHandlePointer</code> å‡½æ•°å°† <code>HANDLE_TABLE_ENTRY</code> çš„å‰ 8 å­—èŠ‚<strong>å¸¦ç¬¦å·å³ç§» 16 ä½</strong>å¾—åˆ°å¯¹è±¡çš„åœ°å€ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PVOID <span class="title function_">ExGetHandlePointer</span><span class="params">(PLONGLONG EncodedHandle)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (PVOID)((*EncodedHandle &gt;&gt; <span class="number">16</span>) &amp; ~<span class="number">0xF</span>uLL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHANDLE_TABLE_ENTRY CidEntry = ExMapHandleToPointer(PspCidTable, ProcessId);</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line">PEOROCESS lProcess = ExGetHandlePointer(&amp;CidEntry-&gt;LowValue)</span><br></pre></td></tr></table></figure></div>

<h1 id="å¥æŸ„è¡¨ç›¸å…³ä»£ç åˆ†æ"><a href="#å¥æŸ„è¡¨ç›¸å…³ä»£ç åˆ†æ" class="headerlink" title="å¥æŸ„è¡¨ç›¸å…³ä»£ç åˆ†æ"></a>å¥æŸ„è¡¨ç›¸å…³ä»£ç åˆ†æ</h1><h2 id="å¥æŸ„æŸ¥æ‰¾è¿‡ç¨‹"><a href="#å¥æŸ„æŸ¥æ‰¾è¿‡ç¨‹" class="headerlink" title="å¥æŸ„æŸ¥æ‰¾è¿‡ç¨‹"></a>å¥æŸ„æŸ¥æ‰¾è¿‡ç¨‹</h2><h3 id="ExMapHandleToPointer"><a href="#ExMapHandleToPointer" class="headerlink" title="ExMapHandleToPointer"></a>ExMapHandleToPointer</h3><p><code>ExMapHandleToPointer</code> å‡½æ•°å¯ä»¥ä»æŒ‡å®š<strong>å¥æŸ„è¡¨</strong>ä¸­æ ¹æ®<strong>å¥æŸ„</strong>æŸ¥æ‰¾åˆ°å¯¹åº”çš„<strong>å¥æŸ„è¡¨é¡¹</strong>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å†…æ ¸å¯¼å‡ºå‡½æ•°ï¼šå°†å¥æŸ„æ˜ å°„ä¸ºå¯¹åº”çš„å¥æŸ„è¡¨é¡¹æŒ‡é’ˆï¼ˆå·²åŠ é”ï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">NTKERNELAPI</span><br><span class="line">PHANDLE_TABLE_ENTRY</span><br><span class="line"><span class="title function_">ExMapHandleToPointer</span> <span class="params">(</span></span><br><span class="line"><span class="params">    __in PHANDLE_TABLE HandleTable,    <span class="comment">// æŒ‡å‘ç›®æ ‡å¥æŸ„è¡¨ï¼ˆå¦‚è¿›ç¨‹å¥æŸ„è¡¨æˆ– PspCidTableï¼‰</span></span></span><br><span class="line"><span class="params">    __in HANDLE Handle                 <span class="comment">// è¾“å…¥çš„å¥æŸ„å€¼ï¼ˆç”¨æˆ·ä¼ å…¥çš„å¥æŸ„ï¼‰</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‡½æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å°†ä¸€ä¸ªå¥æŸ„å€¼è§£æä¸ºå…¶å¯¹åº”çš„å¥æŸ„è¡¨é¡¹æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">    è‹¥æ˜ å°„æˆåŠŸï¼Œåˆ™è¿”å›æ—¶è¯¥è¡¨é¡¹å¤„äºåŠ é”çŠ¶æ€ï¼Œç¡®ä¿åç»­è®¿é—®å®‰å…¨ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    HandleTable - å¥æŸ„è¡¨æŒ‡é’ˆï¼Œæä¾›å¥æŸ„æ‰€å±è¡¨ï¼ˆé€šå¸¸ä¸ºå½“å‰è¿›ç¨‹çš„ ObjectTable æˆ–ç³»ç»Ÿå…¨å±€è¡¨ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Handle - è¦æ˜ å°„çš„å¥æŸ„ï¼ˆå¥æŸ„å€¼æœ¬è´¨æ˜¯ `_EXHANDLE` ç»“æ„ï¼ŒåŒ…å«ç´¢å¼•ä¸æ ‡ç­¾ä½ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    è‹¥æ˜ å°„æˆåŠŸï¼Œåˆ™è¿”å›å·²åŠ é”çš„å¥æŸ„è¡¨é¡¹åœ°å€ï¼›</span></span><br><span class="line"><span class="comment">    è‹¥å¥æŸ„éæ³•æˆ–å·²å¤±æ•ˆï¼Œåˆ™è¿”å› NULLã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    EXHANDLE LocalHandle;</span><br><span class="line">    PHANDLE_TABLE_ENTRY HandleTableEntry;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();  <span class="comment">// è¯¥å‡½æ•°åªèƒ½åœ¨å¯åˆ†é¡µå†…å­˜ä¸­æ‰§è¡Œï¼ŒIRQL &lt;= APC_LEVEL</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†åŸå§‹ HANDLE å¼ºåˆ¶è½¬æ¢ä¸ºå†…éƒ¨ç»“æ„ EXHANDLE</span></span><br><span class="line">    <span class="comment">// EXHANDLE ä¸­ Index å­—æ®µç”¨äºæ ‡è¯†å¥æŸ„è¡¨é¡¹ç´¢å¼•</span></span><br><span class="line">    LocalHandle.GenericHandleOverlay = Handle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®‰å…¨æ£€æŸ¥ï¼šå¥æŸ„ç´¢å¼•ä¸èƒ½æ˜¯ LOWLEVEL_COUNTï¼ˆ512ï¼‰ çš„å€æ•°</span></span><br><span class="line">    <span class="comment">// å› ä¸ºè¿™äº›ç´¢å¼•é€šå¸¸è¡¨ç¤ºé¡µè¾¹ç•Œæˆ–æ— æ•ˆé¡¹ï¼ˆå¦‚ç©ºã€ä¿ç•™ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((LocalHandle.Index &amp; (LOWLEVEL_COUNT - <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ ¹æ®å¥æŸ„ç´¢å¼•åœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¥æŸ„è¡¨é¡¹åœ°å€</span></span><br><span class="line">    <span class="comment">// è‹¥å¥æŸ„æ— æ•ˆæˆ–å¯¹åº”é¡¹æœªåˆå§‹åŒ–ï¼Œåˆ™è¿”å› NULL</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    HandleTableEntry = ExpLookupHandleTableEntry(HandleTable, LocalHandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ£€æŸ¥å¥æŸ„é¡¹æ˜¯å¦å­˜åœ¨ï¼Œä¸”èƒ½å¦æˆåŠŸåŠ é”ï¼ˆé˜²æ­¢å¹¶å‘è®¿é—®ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((HandleTableEntry == <span class="literal">NULL</span>) ||</span><br><span class="line">        !ExpLockHandleTableEntry(HandleTable, HandleTableEntry)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‹¥å¼€å¯äº†å¥æŸ„è°ƒè¯•ï¼ˆå¦‚æ³„æ¼è¿½è¸ªï¼‰ï¼Œåˆ™è®°å½•è¯¥æ¬¡å¤±è´¥å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (HandleTable-&gt;DebugInfo != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ExpUpdateDebugInfo(</span><br><span class="line">                HandleTable,</span><br><span class="line">                PsGetCurrentThread(),         <span class="comment">// å½“å‰è®¿é—®è¯¥å¥æŸ„çš„çº¿ç¨‹</span></span><br><span class="line">                Handle,                       <span class="comment">// å‡ºé—®é¢˜çš„å¥æŸ„</span></span><br><span class="line">                HANDLE_TRACE_DB_BADREF        <span class="comment">// é”™è¯¯ç±»å‹ï¼šéæ³•å¼•ç”¨</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¿”å›æˆåŠŸåŠ é”çš„å¥æŸ„è¡¨é¡¹æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> HandleTableEntry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>ExMapHandleToPointer</code> ä¸»è¦æ˜¯å¯¹ç”¨æˆ·ä¼ å…¥çš„å¥æŸ„åšäº†ä¸€äº›ç±»å‹è½¬æ¢å’Œæ£€æŸ¥ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›åŠ é”çš„æ“ä½œã€‚</p>
<p><code>ExMapHandleToPointer</code> é¦–å…ˆä¼šå¯¹å¥æŸ„ç´¢å¼•è¿›è¡Œæ£€æŸ¥ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TABLE_PAGE_SIZE PAGE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOWLEVEL_COUNT (TABLE_PAGE_SIZE / sizeof(HANDLE_TABLE_ENTRY))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((LocalHandle.Index &amp; (LOWLEVEL_COUNT - <span class="number">1</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªåˆ¤æ–­è¦æ±‚<strong>å¥æŸ„çš„ç´¢å¼•å€¼ä¸èƒ½æ˜¯ã€Œä¸€ä¸ªå†…å­˜é¡µä¸­ <code>HANDLE_TABLE_ENTRY</code> çš„æ•°é‡ã€çš„å€æ•°</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>æ¯ä¸ªå­˜æ”¾ <code>HANDLE_TABLE_ENTRY</code> çš„å†…å­˜é¡µä¸­çš„ç¬¬ä¸€ä¸ª <code>HANDLE_TABLE_ENTRY</code> æ˜¯è¢«è§†ä¸ºä¿ç•™æˆ–ç‰¹æ®Šç”¨é€”ï¼Œç³»ç»Ÿæ‹’ç»ä½¿ç”¨è¿™äº›ç‰¹å®šä½ç½®çš„å¥æŸ„é¡¹</strong>ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>ä¿®æ”¹ <code>EPROCESS</code> çš„ <code>UniqueProcessId</code> å­—æ®µä¸º <code>LOWLEVEL_COUNT&lt;&lt;2</code> çš„æ•´æ•°å€</strong>ï¼Œä½¿å¾—ç³»ç»Ÿæ— æ³•é€šè¿‡ <code>ExMapHandleToPointer</code> æŸ¥è¯¢åˆ°æˆ‘ä»¬çš„è¿›ç¨‹ã€‚</p>

    </div>
  </div>

<p>ä¹‹åä¼šè°ƒç”¨ <code>ExpLookupHandleTableEntry</code> å‡½æ•°è¿›è¡ŒçœŸæ­£çš„å¥æŸ„è¡¨æŸ¥è¯¢æ“ä½œã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„<strong>å¥æŸ„è¡¨</strong>å’Œ<strong>å¥æŸ„è¡¨ç´¢å¼•</strong>æ‰¾åˆ°å¯¹åº”çš„<strong>å¥æŸ„è¡¨é¡¹</strong>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ ¹æ®å¥æŸ„ç´¢å¼•åœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¥æŸ„è¡¨é¡¹åœ°å€</span></span><br><span class="line"><span class="comment">// è‹¥å¥æŸ„æ— æ•ˆæˆ–å¯¹åº”é¡¹æœªåˆå§‹åŒ–ï¼Œåˆ™è¿”å› NULL</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">HandleTableEntry = ExpLookupHandleTableEntry(HandleTable, LocalHandle);</span><br></pre></td></tr></table></figure></div>

<p>åœ¨è·å–åˆ°å¥æŸ„è¡¨é¡¹çš„åéœ€è¦é€šè¿‡ <code>ExpLockHandleTableEntry</code> å‡½æ•°ç»™å¥æŸ„è¡¨é¡¹åŠ é”ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  å°†æŒ‡å®šå¥æŸ„è¡¨é¡¹è®¾ç½®ä¸ºåŠ é”çŠ¶æ€</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">BOOLEAN</span><br><span class="line">FORCEINLINE</span><br><span class="line"><span class="title function_">ExpLockHandleTableEntry</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PHANDLE_TABLE HandleTable,</span></span><br><span class="line"><span class="params">    PHANDLE_TABLE_ENTRY HandleTableEntry</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    LONG_PTR NewValue;</span><br><span class="line">    LONG_PTR CurrentValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å³å°†è·å–ä¸€ä¸ªè‡ªæ—‹é”ï¼Œç¡®ä¿å½“å‰çº¿ç¨‹å·²ç¦æ­¢ APC æˆ–æå‡åˆ° APC_LEVEL</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ASSERT((KeGetCurrentThread()-&gt;CombinedApcDisable != <span class="number">0</span>) || (KeGetCurrentIrql() == APC_LEVEL));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å°è¯•å¾ªç¯è·å–åŠ é”æ ‡å¿—ï¼š</span></span><br><span class="line">    <span class="comment">//  - å¦‚æœå¯¹è±¡æŒ‡é’ˆä¸º 0ï¼Œè¯´æ˜è¯¥è¡¨é¡¹æœªä½¿ç”¨ï¼Œç›´æ¥è¿”å› FALSE</span></span><br><span class="line">    <span class="comment">//  - å¦åˆ™ï¼Œå¦‚æœæœ€ä½ä½ä¸º 1ï¼ˆå·²åŠ é”ï¼‰ï¼Œå°è¯•ä½¿ç”¨åŸå­æ“ä½œï¼ˆCASï¼‰æ¸…é™¤æœ€ä½ä½ï¼Œå®ç°åŠ é”</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">while</span> (TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        CurrentValue = ReadForWriteAccess((<span class="keyword">volatile</span> LONG_PTR *)&amp;HandleTableEntry-&gt;Object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å¦‚æœæœ€ä½ä½ä¸º 1ï¼Œè¡¨ç¤ºè¯¥è¡¨é¡¹å°šæœªåŠ é”ï¼Œå¯ä»¥å°è¯•åŠ é”</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (CurrentValue &amp; EXHANDLE_TABLE_ENTRY_LOCK_BIT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// æ„é€ åŠ é”åçš„å€¼ï¼šæ¸…é™¤æœ€ä½ä½ï¼ˆåŠ é”æ ‡å¿—ä½ï¼‰</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            NewValue = CurrentValue - EXHANDLE_TABLE_ENTRY_LOCK_BIT;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// ä½¿ç”¨ CAS å°è¯•åŸå­æ›¿æ¢å¯¹è±¡æŒ‡é’ˆï¼ˆå¸¦é”ï¼‰</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> ((LONG_PTR)(InterlockedCompareExchangePointer(</span><br><span class="line">                    &amp;HandleTableEntry-&gt;Object,</span><br><span class="line">                    (PVOID)NewValue,</span><br><span class="line">                    (PVOID)CurrentValue)) == CurrentValue)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> TRUE;  <span class="comment">// åŠ é”æˆåŠŸ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// è‹¥è¡¨é¡¹å€¼ä¸º 0ï¼Œåˆ™è¯¥é¡¹æœªä½¿ç”¨ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (CurrentValue == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è¡¨é¡¹å·²è¢«å…¶ä»–çº¿ç¨‹åŠ é”ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ExpBlockOnLockedHandleEntry(HandleTable, HandleTableEntry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°çš„å…·ä½“æ“ä½œæ˜¯ç»™ <code>HandleTableEntry-&gt;Object</code> çš„æœ€ä½ä½ç½® 0ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™æ˜¯ç”¨äºåŠ é”å¥æŸ„è¡¨é¡¹çš„â€œæœ€ä½ä½â€æ ‡å¿—ï¼ˆä½åœ°å€ä½ï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXHANDLE_TABLE_ENTRY_LOCK_BIT    1</span></span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤å¯¹äº<strong>ç§æœ‰å¥æŸ„è¡¨</strong>å¦‚æœæˆ‘ä»¬æ¸…ç©ºäº†å¥æŸ„è¡¨è¡¨é¡¹çš„ <code>Object</code> çš„ <code>EXHANDLE_TABLE_ENTRY_LOCK_BIT</code> ä½é‚£ä¹ˆå°±è¡¨ç¤ºè¿™ä¸ªå¥æŸ„è¢«åŠ é”äº†ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬é€€å‡ºè¿›ç¨‹æˆ–è€…å…³é—­è¿™ä¸ªå¥æŸ„éƒ½è¦ç­‰å¾…è¿™ä¸ªå¥æŸ„çš„é”ï¼Œä¹Ÿå°±ä¼šæŠŠè¿›ç¨‹å¡æ­»ã€‚</p>
<h3 id="ExpLookupHandleTableEntry"><a href="#ExpLookupHandleTableEntry" class="headerlink" title="ExpLookupHandleTableEntry"></a>ExpLookupHandleTableEntry</h3><p>å®é™…è¿›è¡Œå¥æŸ„æŸ¥æ‰¾çš„æ ¸å¿ƒå‡½æ•°æ˜¯ <code>ExpLookupHandleTableEntry</code>ã€‚</p>
<p><code>ExpLookupHandleTableEntry</code> ä¼šå°†å¥æŸ„å€¼çš„é«˜ 30 ä½ä½œä¸ºä¸‹æ ‡åœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¥æŸ„è¡¨é¡¹ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹ç±»ä¼¼é¡µè¡¨çš„åœ°å€è½¬æ¢ï¼Œåªä¸è¿‡æˆ‘ä»¬è¦æ ¹æ®å¥æŸ„è¡¨æŒ‡é’ˆçš„ä½ 2 ä½ç¡®å®šå¥æŸ„è¡¨å±‚æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// å†…éƒ¨æ”¯æŒå‡½æ•°ï¼šåœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾æŒ‡å®šå¥æŸ„å€¼å¯¹åº”çš„å¥æŸ„è¡¨é¡¹</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">PHANDLE_TABLE_ENTRY</span><br><span class="line"><span class="title function_">ExpLookupHandleTableEntry</span> <span class="params">(</span></span><br><span class="line"><span class="params">    IN PHANDLE_TABLE HandleTable,   <span class="comment">// ç›®æ ‡å¥æŸ„è¡¨æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">    IN EXHANDLE tHandle             <span class="comment">// è¦æŸ¥æ‰¾çš„å¥æŸ„ï¼ˆç»“æ„åŒ–å½¢å¼ï¼‰</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‡½æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    æ ¹æ®ä¼ å…¥çš„å¥æŸ„å€¼ï¼Œåœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å…¶å¯¹åº”çš„å¥æŸ„è¡¨é¡¹åœ°å€ã€‚</span></span><br><span class="line"><span class="comment">    æ”¯æŒ 1ï½3 å±‚å¥æŸ„è¡¨ç»“æ„ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    HandleTable - æŒ‡å‘å¥æŸ„è¡¨ç»“æ„ï¼ˆå¦‚è¿›ç¨‹çš„ ObjectTable æˆ–å…¨å±€å¥æŸ„è¡¨ PspCidTableï¼‰</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    tHandle - è¦æŸ¥æ‰¾çš„å¥æŸ„ï¼ˆå°è£…ä¸º EXHANDLEï¼Œä¾¿äºè®¿é—® Index å­—æ®µï¼‰</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    è‹¥å¥æŸ„æœ‰æ•ˆï¼Œè¿”å›å…¶å¯¹åº”çš„å¥æŸ„è¡¨é¡¹æŒ‡é’ˆï¼›</span></span><br><span class="line"><span class="comment">    è‹¥å¥æŸ„è¶…å‡ºå¥æŸ„è¡¨å½“å‰åˆ†é…èŒƒå›´ï¼Œæˆ–ç»“æ„å¼‚å¸¸ï¼Œåˆ™è¿”å› NULLã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    ULONG_PTR i, j, k;</span><br><span class="line">    ULONG_PTR CapturedTable;</span><br><span class="line">    ULONG TableLevel;</span><br><span class="line">    PHANDLE_TABLE_ENTRY Entry = <span class="literal">NULL</span>;</span><br><span class="line">    EXHANDLE Handle;</span><br><span class="line"></span><br><span class="line">    PUCHAR TableLevel1;</span><br><span class="line">    PUCHAR TableLevel2;</span><br><span class="line">    PUCHAR TableLevel3;</span><br><span class="line"></span><br><span class="line">    ULONG_PTR MaxHandle;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();  <span class="comment">// å‡½æ•°ä»…å¯åœ¨å¯åˆ†é¡µå†…å­˜ä¸­è¿è¡Œï¼ˆIRQL &lt;= APC_LEVELï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// å–å‡ºå¥æŸ„å€¼ç´¢å¼•ï¼ˆIndexï¼‰ï¼Œå¹¶æ¸…é™¤ TagBitsï¼ˆä½2ä½ç”¨æˆ·æ ‡ç­¾ä½ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Handle = tHandle;</span><br><span class="line">    Handle.TagBits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è·å–å½“å‰å¥æŸ„è¡¨å·²åˆ†é…çš„æœ€å¤§å¥æŸ„å€¼ï¼ˆè¾¹ç•Œæ£€æŸ¥ç”¨ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    MaxHandle = *(<span class="keyword">volatile</span> ULONG *) &amp;HandleTable-&gt;NextHandleNeedingPool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è‹¥å¥æŸ„å€¼å¤§äºå½“å‰å¥æŸ„è¡¨æœ€å¤§å¥æŸ„æ•°ï¼Œåˆ™è¯´æ˜éæ³•</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (Handle.Value &gt;= MaxHandle) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ•è· TableCode å€¼ï¼Œå¹¶æå–å±‚çº§ä¿¡æ¯ï¼ˆä½2ä½å­˜å‚¨ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    CapturedTable = *(<span class="keyword">volatile</span> ULONG_PTR *) &amp;HandleTable-&gt;TableCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå–å¥æŸ„è¡¨å±‚çº§æ•°ï¼ˆ0ã€1ã€2ï¼‰</span></span><br><span class="line">    TableLevel = (ULONG)(CapturedTable &amp; LEVEL_CODE_MASK);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤å±‚çº§ä½ï¼Œå¾—åˆ°å®é™…çš„æ ¹ç›®å½•åœ°å€</span></span><br><span class="line">    CapturedTable = CapturedTable - TableLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// æ ¹æ®å¥æŸ„è¡¨çš„å±‚æ•°æ‰§è¡Œä¸åŒçš„ç´¢å¼•é€»è¾‘</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">switch</span> (TableLevel) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:  <span class="comment">// å•å±‚å¥æŸ„è¡¨</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// TableLevel1 æŒ‡å‘å¥æŸ„é¡µï¼ˆå¥æŸ„é¡¹æ•°ç»„ï¼‰</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            TableLevel1 = (PUCHAR) CapturedTable;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// å¥æŸ„å€¼å·²æŒ‰ 4 å­—èŠ‚å¯¹é½ï¼Œä¹˜ä»¥ (ENTRY_SIZE / 4) å³ä¸ºåç§»é¡¹</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            Entry = (PHANDLE_TABLE_ENTRY) &amp;TableLevel1[</span><br><span class="line">                Handle.Value * (<span class="keyword">sizeof</span>(HANDLE_TABLE_ENTRY) / HANDLE_VALUE_INC)</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:  <span class="comment">// ä¸¤å±‚ç»“æ„</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// ä¸€çº§ç›®å½•é¡µï¼Œå« 1024 ä¸ªæŒ‡é’ˆï¼ˆæ¯é¡µ 4KBï¼‰</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            TableLevel2 = (PUCHAR) CapturedTable;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// i = å¥æŸ„å€¼åœ¨å¥æŸ„é¡µä¸­çš„åç§»ï¼ˆé¡µå†…åç§»ï¼‰</span></span><br><span class="line">            i = Handle.Value % (LOWLEVEL_COUNT * HANDLE_VALUE_INC);  <span class="comment">// 512 * 4 = 2048</span></span><br><span class="line"></span><br><span class="line">            Handle.Value -= i;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// j = ä¸€çº§ç›®å½•ä¸­çš„ç´¢å¼•é¡¹</span></span><br><span class="line">            j = Handle.Value / ((LOWLEVEL_COUNT * HANDLE_VALUE_INC) / <span class="keyword">sizeof</span>(PHANDLE_TABLE_ENTRY));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä½å¥æŸ„é¡µåœ°å€</span></span><br><span class="line">            TableLevel1 = (PUCHAR) *(PHANDLE_TABLE_ENTRY *) &amp;TableLevel2[j];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€ç»ˆå–å‡ºå¥æŸ„è¡¨é¡¹æŒ‡é’ˆ</span></span><br><span class="line">            Entry = (PHANDLE_TABLE_ENTRY) &amp;TableLevel1[</span><br><span class="line">                i * (<span class="keyword">sizeof</span>(HANDLE_TABLE_ENTRY) / HANDLE_VALUE_INC)</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:  <span class="comment">// ä¸‰å±‚ç»“æ„ï¼ˆå¤§è§„æ¨¡å¥æŸ„è¡¨ï¼‰</span></span><br><span class="line"></span><br><span class="line">            TableLevel3 = (PUCHAR) CapturedTable;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// i = é¡µå†…åç§»</span></span><br><span class="line">            i = Handle.Value % (LOWLEVEL_COUNT * HANDLE_VALUE_INC);</span><br><span class="line"></span><br><span class="line">            Handle.Value -= i;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// k = äºŒçº§ç›®å½•æ•´ä½“åç§»ç´¢å¼•</span></span><br><span class="line">            k = Handle.Value / ((LOWLEVEL_COUNT * HANDLE_VALUE_INC) / <span class="keyword">sizeof</span>(PHANDLE_TABLE_ENTRY));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// j = ä¸€çº§ç›®å½•é¡µå†…åç§»</span></span><br><span class="line">            j = k % (MIDLEVEL_COUNT * <span class="keyword">sizeof</span>(PHANDLE_TABLE_ENTRY));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// k = é¡¶çº§ç›®å½•ç´¢å¼•</span></span><br><span class="line">            k -= j;</span><br><span class="line">            k /= MIDLEVEL_COUNT;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¸‰çº§è·³è½¬ï¼šæ ¹ â†’ äºŒçº§é¡µ â†’ å¥æŸ„é¡µ</span></span><br><span class="line">            TableLevel2 = (PUCHAR) *(PHANDLE_TABLE_ENTRY *) &amp;TableLevel3[k];</span><br><span class="line">            TableLevel1 = (PUCHAR) *(PHANDLE_TABLE_ENTRY *) &amp;TableLevel2[j];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æœ€ç»ˆå®šä½å¥æŸ„è¡¨é¡¹</span></span><br><span class="line">            Entry = (PHANDLE_TABLE_ENTRY) &amp;TableLevel1[</span><br><span class="line">                i * (<span class="keyword">sizeof</span>(HANDLE_TABLE_ENTRY) / HANDLE_VALUE_INC)</span><br><span class="line">            ];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            _assume(<span class="number">0</span>);  <span class="comment">// æ°¸è¿œä¸åº”è§¦å‘æ­¤è·¯å¾„</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="å¥æŸ„è¡¨éå†"><a href="#å¥æŸ„è¡¨éå†" class="headerlink" title="å¥æŸ„è¡¨éå†"></a>å¥æŸ„è¡¨éå†</h2><p>Windows å¯¼å‡ºäº†ä¸€ä¸ª <code>ExEnumHandleTable</code> å‡½æ•°ç”¨äºéå†å¥æŸ„è¡¨ã€‚è¿™ä¸ªå‡½æ•°æœ¬è´¨ä¸Šå°±æ˜¯æšä¸¾å¥æŸ„å€¼ï¼Œç„¶åè°ƒç”¨ <code>ExpLookupHandleTableEntry</code> åœ¨å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å¥æŸ„è¡¨é¡¹ï¼Œç„¶åè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œç›´åˆ° <code>ExpLookupHandleTableEntry</code> è¿”å›ä¸º NULLã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">BOOLEAN</span><br><span class="line"><span class="title function_">ExEnumHandleTable</span> <span class="params">(</span></span><br><span class="line"><span class="params">    __in PHANDLE_TABLE HandleTable,                <span class="comment">// å¥æŸ„è¡¨çš„æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">    __in EX_ENUMERATE_HANDLE_ROUTINE EnumHandleProcedure,  <span class="comment">// æ¯ä¸ªæœ‰æ•ˆå¥æŸ„çš„å›è°ƒå‡½æ•°</span></span></span><br><span class="line"><span class="params">    __in PVOID EnumParameter,                       <span class="comment">// æ¯æ¬¡è°ƒç”¨å›è°ƒå‡½æ•°æ—¶ä¼ é€’çš„æœªè§£é‡Šçš„ 32 ä½å‚æ•°</span></span></span><br><span class="line"><span class="params">    __out_opt PHANDLE Handle                        <span class="comment">// å¯é€‰çš„æŒ‡é’ˆï¼Œæ¥æ”¶æšä¸¾ä¸­åœæ­¢çš„å¥æŸ„</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*++</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ä¾‹ç¨‹è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    æ­¤å‡½æ•°ç”¨äºéå†å¥æŸ„è¡¨ä¸­çš„æ‰€æœ‰æœ‰æ•ˆå¥æŸ„ï¼Œå¹¶è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°å¯¹æ¯ä¸ªæœ‰æ•ˆå¥æŸ„è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line"><span class="comment">    å¦‚æœå›è°ƒå‡½æ•°è¿”å› `TRUE`ï¼Œåˆ™è¡¨ç¤ºåœæ­¢æšä¸¾ï¼Œå½“å‰çš„å¥æŸ„ä¼šé€šè¿‡å¯é€‰çš„ `Handle` å‚æ•°è¿”å›ç»™è°ƒç”¨è€…ï¼Œ</span></span><br><span class="line"><span class="comment">    å¹¶ä¸”è¯¥å‡½æ•°ä¼šè¿”å› `TRUE`ï¼Œè¡¨ç¤ºæšä¸¾åœ¨ç‰¹å®šçš„å¥æŸ„å¤„åœæ­¢ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    HandleTable - ä¼ å…¥å¥æŸ„è¡¨çš„æŒ‡é’ˆã€‚å¥æŸ„è¡¨åŒ…å«äº†æ‰€æœ‰æœ‰æ•ˆçš„å¥æŸ„æ¡ç›®ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    EnumHandleProcedure - ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æ¯ä¸ªæœ‰æ•ˆå¥æŸ„ä¸Šè°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment">        å›è°ƒå‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¿”å› `TRUE` è¡¨ç¤ºåœæ­¢æšä¸¾ï¼Œè¿”å› `FALSE` è¡¨ç¤ºç»§ç»­æšä¸¾ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    EnumParameter - ä¼ å…¥çš„ä¸€ä¸ª 32 ä½å‚æ•°ï¼Œä½œä¸ºä¸Šä¸‹æ–‡æ•°æ®ä¼ é€’ç»™å›è°ƒå‡½æ•°ã€‚å›è°ƒå‡½æ•°ä¼šä½¿ç”¨è¿™ä¸ªå‚æ•°æ¥è·å–é™„åŠ çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Handle - å¯é€‰çš„å‚æ•°ï¼Œä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œæ¥æ”¶æšä¸¾åœæ­¢æ—¶çš„å¥æŸ„å€¼ã€‚åªæœ‰å½“å›è°ƒå‡½æ•°è¿”å› `TRUE` æ—¶ï¼Œè¯¥å¥æŸ„æ‰ä¼šè¢«è®¾ç½®ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    å¦‚æœæšä¸¾åœ¨æŸä¸ªç‰¹å®šå¥æŸ„å¤„åœæ­¢ï¼Œåˆ™è¿”å› `TRUE`ï¼Œå¹¶é€šè¿‡ `Handle` å‚æ•°è¿”å›è¯¥å¥æŸ„çš„å€¼ã€‚</span></span><br><span class="line"><span class="comment">    å¦‚æœæšä¸¾æ²¡æœ‰åœ¨æŸä¸ªç‰¹å®šå¥æŸ„å¤„åœæ­¢ï¼Œåˆ™è¿”å› `FALSE`ï¼Œè¡¨ç¤ºéå†äº†æ•´ä¸ªå¥æŸ„è¡¨ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--*/</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    PKTHREAD CurrentThread;</span><br><span class="line">    BOOLEAN ResultValue;</span><br><span class="line">    EXHANDLE LocalHandle;</span><br><span class="line">    PHANDLE_TABLE_ENTRY HandleTableEntry;</span><br><span class="line"></span><br><span class="line">    PAGED_CODE();  <span class="comment">// æ­¤å‡½æ•°åªèƒ½åœ¨åˆ†é¡µæ¨¡å¼ä¸‹æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line">    CurrentThread = KeGetCurrentThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹è¿”å›å€¼è®¾ä¸º FALSEï¼Œè¡¨ç¤ºæšä¸¾å°†ç»§ç»­è¿›è¡Œï¼Œç›´åˆ°å›è°ƒå‡½æ•°è¿”å› TRUE æ‰ä¼šåœæ­¢</span></span><br><span class="line">    ResultValue = FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›å…¥ä¸´ç•ŒåŒºï¼Œé˜²æ­¢å½“å‰çº¿ç¨‹åœ¨éå†å¥æŸ„è¡¨æœŸé—´è¢«ä¸­æ–­</span></span><br><span class="line">    KeEnterCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå†å¥æŸ„è¡¨ä¸­çš„æ¯ä¸€ä¸ªå¥æŸ„æ¡ç›®</span></span><br><span class="line">    <span class="keyword">for</span> (LocalHandle.Value = <span class="number">0</span>; </span><br><span class="line">         (HandleTableEntry = ExpLookupHandleTableEntry(HandleTable, LocalHandle)) != <span class="literal">NULL</span>; </span><br><span class="line">         LocalHandle.Value += HANDLE_VALUE_INC) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå¥æŸ„æ¡ç›®æœ‰æ•ˆï¼Œåˆ™è°ƒç”¨å›è°ƒå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (ExpIsValidObjectEntry(HandleTableEntry)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é”å®šå½“å‰å¥æŸ„æ¡ç›®ï¼Œç¡®ä¿å›è°ƒæœŸé—´ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¯¥æ¡ç›®</span></span><br><span class="line">            <span class="keyword">if</span> (ExpLockHandleTableEntry(HandleTable, HandleTableEntry)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†å½“å‰å¥æŸ„</span></span><br><span class="line">                <span class="comment">// å¦‚æœå›è°ƒå‡½æ•°è¿”å› TRUEï¼Œè¡¨ç¤ºæšä¸¾åœæ­¢</span></span><br><span class="line">                ResultValue = (*EnumHandleProcedure)(HandleTableEntry, LocalHandle.GenericHandleOverlay, EnumParameter);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è§£é”å¥æŸ„æ¡ç›®</span></span><br><span class="line">                ExUnlockHandleTableEntry(HandleTable, HandleTableEntry);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœå›è°ƒå‡½æ•°è¿”å› TRUEï¼Œè¡¨ç¤ºæšä¸¾åœæ­¢</span></span><br><span class="line">                <span class="keyword">if</span> (ResultValue) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæä¾›äº† Handle å‚æ•°ï¼Œåˆ™å°†å½“å‰å¥æŸ„èµ‹å€¼ç»™ Handle</span></span><br><span class="line">                    <span class="keyword">if</span> (ARGUMENT_PRESENT(Handle)) &#123;</span><br><span class="line">                        *Handle = LocalHandle.GenericHandleOverlay;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;  <span class="comment">// é€€å‡ºéå†ï¼Œåœæ­¢æšä¸¾</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€€å‡ºä¸´ç•ŒåŒºï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è®¿é—®å¥æŸ„è¡¨</span></span><br><span class="line">    KeLeaveCriticalRegionThread(CurrentThread);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ˜¯å¦åœ¨ç‰¹å®šå¥æŸ„å¤„åœæ­¢äº†æšä¸¾</span></span><br><span class="line">    <span class="keyword">return</span> ResultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>ExpIsValidObjectEntry</code> å®ç”¨äºæ£€æŸ¥å¥æŸ„æ¡ç›®æ˜¯å¦æœ‰æ•ˆã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EX_ADDITIONAL_INFO_SIGNATURE (-2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ExpIsValidObjectEntry(Entry) \</span></span><br><span class="line"><span class="meta">    ( (Entry != NULL) &amp;&amp; (Entry-&gt;Object != NULL) &amp;&amp; (Entry-&gt;NextFreeTableEntry != EX_ADDITIONAL_INFO_SIGNATURE) )</span></span><br></pre></td></tr></table></figure></div>

<p>å®ƒæ£€æŸ¥ä»¥ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼Œå½“è¿™ä¸‰ä¸ªæ¡ä»¶éƒ½æˆç«‹æ—¶ï¼Œå¥æŸ„æ¡ç›®æ‰è¢«è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„ã€‚</p>
<ul>
<li><code>Entry != NULL</code>ï¼šæ£€æŸ¥å¥æŸ„æ¡ç›®æ˜¯å¦ä¸ºç©ºã€‚</li>
<li><code>Entry-&gt;Object != NULL</code>ï¼šæ£€æŸ¥å¥æŸ„æ¡ç›®æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¯¹è±¡ã€‚</li>
<li><code>Entry-&gt;NextFreeTableEntry != EX_ADDITIONAL_INFO_SIGNATURE</code>ï¼šæ£€æŸ¥å¥æŸ„æ¡ç›®çš„ <code>NextFreeTableEntry</code> æ˜¯å¦ä¸ç­‰äº <code>EX_ADDITIONAL_INFO_SIGNATURE(-2)</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ ‡è¯†ç¬¦ï¼Œç”¨äºè¡¨ç¤ºå·²é‡Šæ”¾çš„å¥æŸ„æ¡ç›®ã€‚</li>
</ul>
<p>å¦‚æœå¥æŸ„æœ‰æ•ˆåˆ™å…ˆé”å®šå¥æŸ„è¡¨é¡¹ï¼Œç„¶åè°ƒç”¨ç”¨æˆ·ä¼ å…¥çš„å›è°ƒå‡½æ•° <code>EnumHandleProcedure</code>ï¼Œè§£é”å¥æŸ„è¡¨é¡¹ï¼Œæœ€åæ ¹æ®å›è°ƒå‡½æ•°çš„è¿”å›å€¼</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é”å®šå½“å‰å¥æŸ„æ¡ç›®ï¼Œç¡®ä¿å›è°ƒæœŸé—´ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¯¥æ¡ç›®</span></span><br><span class="line"><span class="keyword">if</span> (ExpLockHandleTableEntry(HandleTable, HandleTableEntry)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å›è°ƒå‡½æ•°å¤„ç†å½“å‰å¥æŸ„</span></span><br><span class="line">    <span class="comment">// å¦‚æœå›è°ƒå‡½æ•°è¿”å› TRUEï¼Œè¡¨ç¤ºæšä¸¾åœæ­¢</span></span><br><span class="line">    ResultValue = (*EnumHandleProcedure)(HandleTableEntry, LocalHandle.GenericHandleOverlay, EnumParameter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£é”å¥æŸ„æ¡ç›®</span></span><br><span class="line">    ExUnlockHandleTableEntry(HandleTable, HandleTableEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå›è°ƒå‡½æ•°è¿”å› TRUEï¼Œè¡¨ç¤ºæšä¸¾åœæ­¢</span></span><br><span class="line">    <span class="keyword">if</span> (ResultValue) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæä¾›äº† Handle å‚æ•°ï¼Œåˆ™å°†å½“å‰å¥æŸ„èµ‹å€¼ç»™ Handle</span></span><br><span class="line">        <span class="keyword">if</span> (ARGUMENT_PRESENT(Handle)) &#123;</span><br><span class="line">            *Handle = LocalHandle.GenericHandleOverlay;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;  <span class="comment">// é€€å‡ºéå†ï¼Œåœæ­¢æšä¸¾</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ç”¨æˆ·ä¼ å…¥çš„å›è°ƒå‡½æ•°çš„ç±»å‹ <code>EX_ENUMERATE_HANDLE_ROUTINE</code> å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">BOOLEAN</span> <span class="params">(*EX_ENUMERATE_HANDLE_ROUTINE)</span><span class="params">(</span></span><br><span class="line"><span class="params">    IN PHANDLE_TABLE_ENTRY HandleTableEntry,  <span class="comment">// å¥æŸ„è¡¨æ¡ç›®çš„æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">    IN HANDLE Handle,  <span class="comment">// å½“å‰å¥æŸ„çš„å€¼</span></span></span><br><span class="line"><span class="params">    IN PVOID EnumParameter  <span class="comment">// æšä¸¾æ—¶ä¼ é€’çš„é¢å¤–å‚æ•°</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure></div>

<p>å›è°ƒå‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚å¦‚æœè¿”å› <code>TRUE</code>ï¼Œåˆ™è¡¨ç¤ºæšä¸¾åœæ­¢ï¼›å¦‚æœè¿”å› <code>FALSE</code>ï¼Œåˆ™ç»§ç»­æšä¸¾ä¸‹ä¸€ä¸ªå¥æŸ„ã€‚</p>
<h1 id="å…¨å±€å¥æŸ„è¡¨"><a href="#å…¨å±€å¥æŸ„è¡¨" class="headerlink" title="å…¨å±€å¥æŸ„è¡¨"></a>å…¨å±€å¥æŸ„è¡¨</h1><p>å…¨å±€å¥æŸ„è¡¨ <code>PspCidTable</code> æ˜¯ä¸€ä¸ª <code>HANDLE_TABLE</code> ç±»å‹çš„å…¨å±€æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå¥æŸ„è¡¨ç®¡ç†ç»“æ„ã€‚è¿™ä¸ªè¡¨ä¸­å­˜å‚¨ç€æ‰€æœ‰<strong>è¿›ç¨‹</strong>å’Œ<strong>çº¿ç¨‹</strong>å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHANDLE_TABLE PspCidTable;</span><br></pre></td></tr></table></figure></div>

<h2 id="å¥æŸ„è¡¨é¡¹æ·»åŠ "><a href="#å¥æŸ„è¡¨é¡¹æ·»åŠ " class="headerlink" title="å¥æŸ„è¡¨é¡¹æ·»åŠ "></a>å¥æŸ„è¡¨é¡¹æ·»åŠ </h2><p>Windows åœ¨åˆ›å»º<strong>è¿›ç¨‹</strong>ï¼ˆ<code>PspAllocateProcess</code>ï¼‰å’Œ<strong>çº¿ç¨‹</strong>ï¼ˆ<code>PspAllocateThread</code>ï¼‰çš„æ—¶å€™éƒ½ä¼šæŠŠ<strong>è¿›ç¨‹å¯¹è±¡</strong>å’Œ<strong>çº¿ç¨‹å¯¹è±¡</strong>åŠ å…¥åˆ°è¿™ä¸ª<strong>å…¨å±€å¥æŸ„è¡¨</strong>ä¸­ï¼Œå¹¶å¾—åˆ°<strong>è¿›ç¨‹ ID</strong> å’Œ<strong>çº¿ç¨‹ ID</strong>ã€‚</p>
<p>ä»¥ <code>PspAllocateProcess</code> ä¸ºä¾‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// åˆ›å»ºè¿›ç¨‹ IDï¼ˆå³ä¸ºè¿›ç¨‹åˆ†é…å”¯ä¸€çš„å¥æŸ„ï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">CidEntry.Object = Process;             <span class="comment">// è®¾ç½®å¥æŸ„è¡¨é¡¹çš„å¯¹è±¡å­—æ®µï¼ŒæŒ‡å‘å½“å‰è¿›ç¨‹å¯¹è±¡ï¼ˆEPROCESSï¼‰</span></span><br><span class="line">CidEntry.GrantedAccess = <span class="number">0</span>;           <span class="comment">// ä¸ä½¿ç”¨è®¿é—®æ©ç ï¼Œæ­¤å¥æŸ„ä»…ç”¨äºå†…éƒ¨æ ‡è¯†è¿›ç¨‹ ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ ExCreateHandle å‘ PspCidTableï¼ˆç³»ç»Ÿå…¨å±€ CID å¥æŸ„è¡¨ï¼‰æ’å…¥æ¡ç›®</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ä¸ºä¸€ä¸ªå”¯ä¸€å¥æŸ„ï¼ˆHANDLEï¼‰ï¼Œå³è¿›ç¨‹çš„ UniqueProcessId</span></span><br><span class="line">Process-&gt;UniqueProcessId = ExCreateHandle(PspCidTable, &amp;CidEntry);</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li>å…¨å±€å¥æŸ„è¡¨çš„è¡¨é¡¹çš„ <code>Object</code> æŒ‡å‘çš„æ˜¯è¿›ç¨‹æˆ–çº¿ç¨‹å¯¹è±¡ï¼Œä¸æŒ‡å‘å‰é¢çš„ <code>OBJECT_HEADER</code>ã€‚</li>
<li>å…¨å±€å¥æŸ„è¡¨çš„è¡¨é¡¹çš„çš„ <code>GrantedAccess</code> ä¸º 0ï¼Œå³å…¨å±€å¥æŸ„è¡¨çš„è¡¨é¡¹æ²¡æœ‰å¥æŸ„å±æ€§ã€‚</li>
</ul>

    </div>
  </div>

<p><code>ExCreateHandle</code> ä¼šæ ¹æ®ä¼ å…¥çš„ <code>HandleTableEntry</code> åœ¨å¥æŸ„è¡¨ä¸­åˆ†é…ä¸€ä¸ªç©ºé—²çš„å¥æŸ„è¡¨é¡¹ <code>NewHandleTableEntry</code>ã€‚ä¹‹åä¼šè°ƒç”¨ <code>ExUnlockHandleTableEntry</code> è§£é”å¥æŸ„è¡¨é¡¹ï¼Œè¿™é‡Œä¼š<strong>å°†å¥æŸ„è¡¨é¡¹çš„ <code>Object</code> çš„æœ€ä½ä½ç½® 1</strong>ã€‚å› æ­¤<strong>å…¨å±€å¥æŸ„è¡¨é¡¹çš„ <code>Object</code> å»æ‰æœ€ä½ä½æ‰æ˜¯è¿›ç¨‹æˆ–çº¿ç¨‹å¯¹è±¡çš„åœ°å€</strong>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">NTKERNELAPI</span><br><span class="line">HANDLE</span><br><span class="line"><span class="title function_">ExCreateHandle</span> <span class="params">(</span></span><br><span class="line"><span class="params">    __inout PHANDLE_TABLE HandleTable,             <span class="comment">// ç›®æ ‡å¥æŸ„è¡¨ï¼ˆå¦‚è¿›ç¨‹çš„ ObjectTable æˆ– PspCidTableï¼‰</span></span></span><br><span class="line"><span class="params">    __in PHANDLE_TABLE_ENTRY HandleTableEntry      <span class="comment">// è¾“å…¥çš„æ¨¡æ¿å¥æŸ„è¡¨é¡¹å†…å®¹ï¼ˆå°†å¤åˆ¶åˆ°æ–°åˆ†é…è¡¨é¡¹ä¸­ï¼‰</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    EXHANDLE Handle;                               <span class="comment">// EXHANDLE ç»“æ„ï¼ˆåŒ…å«ç´¢å¼• + å±æ€§ä½ï¼‰</span></span><br><span class="line">    PETHREAD CurrentThread;                        <span class="comment">// å½“å‰çº¿ç¨‹</span></span><br><span class="line">    PHANDLE_TABLE_ENTRY NewHandleTableEntry;       <span class="comment">// æ–°åˆ†é…çš„å¥æŸ„è¡¨é¡¹æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    PAGED_CODE();                                  <span class="comment">// é™å®šæ­¤å‡½æ•°åªèƒ½åœ¨ IRQL &lt;= APC_LEVEL æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¥æŸ„å€¼ä¸º 0ï¼ˆè¡¨ç¤ºå¥æŸ„åˆ›å»ºå¤±è´¥çš„é»˜è®¤è¿”å›å€¼ï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    Handle.GenericHandleOverlay = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ªç©ºé—²çš„å¥æŸ„è¡¨é¡¹ï¼Œå¹¶å¡«å……å¥æŸ„ç´¢å¼•ï¼ˆHandle.Indexï¼‰</span></span><br><span class="line">    <span class="comment">// åˆ†é…é€»è¾‘ä¸­ä¼šåŠ é”è¯¥è¡¨é¡¹ï¼Œç¡®ä¿æ¥ä¸‹æ¥çš„å†™å…¥æ˜¯å®‰å…¨çš„</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    NewHandleTableEntry = ExpAllocateHandleTableEntry(HandleTable, &amp;Handle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆ†é…æˆåŠŸåˆ™è¿›å…¥æ­£å¼åˆ›å»ºæµç¨‹</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (NewHandleTableEntry != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹ï¼ˆç”¨äºè¿›å…¥ä¸´ç•ŒåŒºå’Œè®°å½•è°ƒè¯•ä¿¡æ¯ï¼‰</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        CurrentThread = PsGetCurrentThread();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è¿›å…¥çº¿ç¨‹ä¸´ç•ŒåŒºï¼Œé˜²æ­¢è¢«æŒ‚èµ·ï¼Œä¿æŠ¤æ¥ä¸‹æ¥çš„å¥æŸ„å†™å…¥è¿‡ç¨‹</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        KeEnterCriticalRegionThread(&amp;CurrentThread-&gt;Tcb);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å°†ä¼ å…¥çš„æ¨¡æ¿å¥æŸ„è¡¨é¡¹å†…å®¹å¤åˆ¶åˆ°æ–°åˆ†é…çš„è¡¨é¡¹ä¸­</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶è¯¥è¡¨é¡¹ä»å¤„äºâ€œåŠ é”â€çŠ¶æ€ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å¹¶å‘è®¿é—®</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        *NewHandleTableEntry = *HandleTableEntry;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è‹¥å¥æŸ„è¡¨å¯ç”¨äº†è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚å¥æŸ„æ³„éœ²è¿½è¸ªï¼‰ï¼Œåˆ™è®°å½•æ­¤æ¬¡åˆ›å»ºäº‹ä»¶</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (HandleTable-&gt;DebugInfo != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ExpUpdateDebugInfo(</span><br><span class="line">                HandleTable,</span><br><span class="line">                CurrentThread,</span><br><span class="line">                Handle.GenericHandleOverlay,     <span class="comment">// è®°å½•çš„æ˜¯å¥æŸ„å€¼</span></span><br><span class="line">                HANDLE_TRACE_DB_OPEN             <span class="comment">// æ“ä½œç±»å‹ï¼šåˆ›å»º</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// è§£é”å¥æŸ„è¡¨é¡¹ï¼Œä½¿å…¶å¯è¢«åç»­ä½¿ç”¨</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ExUnlockHandleTableEntry(HandleTable, NewHandleTableEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// ç¦»å¼€çº¿ç¨‹ä¸´ç•ŒåŒºï¼Œæ¢å¤çº¿ç¨‹å¯æŒ‚èµ·çŠ¶æ€</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        KeLeaveCriticalRegionThread(&amp;CurrentThread-&gt;Tcb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è¿”å›å¥æŸ„å€¼ï¼ˆè‹¥å¤±è´¥åˆ™ä¸º NULLï¼‰</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> Handle.GenericHandleOverlay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢"><a href="#å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢" class="headerlink" title="å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢"></a>å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢</h2><h3 id="è·å–-PspCidTable"><a href="#è·å–-PspCidTable" class="headerlink" title="è·å– PspCidTable"></a>è·å– PspCidTable</h3><p><code>GetPspCidTable</code> å‡½æ•°é€šè¿‡ä¾‹å¦‚ <code>PsLookupProcessByProcessId</code> çš„ç‰¹å¾ç æ¥å®šä½ <code>PspCidTable</code> çš„åœ°å€ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GetPspCidTable - è·å–å†…æ ¸ä¸­çš„å…¨å±€å¥æŸ„è¡¨ PspCidTable çš„çœŸå®åœ°å€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"> *   æˆåŠŸï¼šè¿”å› PspCidTable çš„çœŸå®æŒ‡é’ˆï¼ˆç±»å‹ä¸º PHANDLE_TABLEï¼‰</span></span><br><span class="line"><span class="comment"> *   å¤±è´¥ï¼šè¿”å› NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PVOID</span><br><span class="line"><span class="title function_">GetPspCidTable</span><span class="params">(</span></span><br><span class="line"><span class="params">    VOID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> PVOID g_PspCidTable = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥å·²ç¼“å­˜ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (g_PspCidTable)</span><br><span class="line">        <span class="keyword">return</span> g_PspCidTable;</span><br><span class="line"></span><br><span class="line">    MEMORY_REGION region = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– ntoskrnl.exe çš„åŠ è½½åœ°å€èŒƒå›´</span></span><br><span class="line">    <span class="keyword">if</span> (!GetKernelModuleRegion(<span class="string">&quot;ntoskrnl.exe&quot;</span>, &amp;region)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•è·å– ntoskrnl.exe èŒƒå›´\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– PspCidTable ç‰¹å¾ç ï¼š</span></span><br><span class="line">    <span class="comment">// ç›®æ ‡å­—èŠ‚åºåˆ—ï¼ˆæ¥è‡ªå®é™… IDA åæ±‡ç¼–ï¼‰å¦‚ä¸‹ï¼š</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//   8B 3D XX XX XX XX    mov     edi, _PspCidTable       ; è¯»å…¨å±€æŒ‡é’ˆ [imm32]</span></span><br><span class="line">    <span class="comment">//   E8 ?? ?? ?? ??       call    ExMapHandleToPointer</span></span><br><span class="line">    <span class="comment">//   8B F8                mov     edi, eax</span></span><br><span class="line">    <span class="comment">//   85 FF                test    edi, edi</span></span><br><span class="line">    <span class="comment">//   74 ??                jz      ...</span></span><br><span class="line">    <span class="comment">//   8B 1F                mov     ebx, [edi]</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç‰¹å¾ç å­—ç¬¦ä¸²å¦‚ä¸‹ï¼Œä½¿ç”¨ * è¡¨ç¤ºé€šé…ï¼ˆ1 å­—èŠ‚ï¼‰ï¼š</span></span><br><span class="line">    <span class="comment">//   &quot;8B*****E8****8BF885FF74*8B1F&quot;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Offset = 2 è¡¨ç¤ºæˆ‘ä»¬ä»åŒ¹é…åœ°å€å‘ååç§» 2 å­—èŠ‚ï¼ˆå³ MOV æŒ‡ä»¤çš„ imm32 ç«‹å³æ•°éƒ¨åˆ†ï¼‰ï¼Œ</span></span><br><span class="line">    <span class="comment">// å†å¯¹è¯¥åœ°å€è¿›è¡Œ **ä¸¤æ¬¡è§£å¼•ç”¨**ï¼Œè·å¾— PspCidTable çš„çœŸå®æŒ‡é’ˆã€‚</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    SIGNATURE_PATTERN sig = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!InitSignaturePattern(&amp;sig, <span class="string">&quot;8B*****E8****8BF885FF74*8B1F&quot;</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] InitSignaturePattern å¤±è´¥\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœç´¢ç‰¹å¾ç åœ¨ ntoskrnl.exe èŒƒå›´å†…çš„åŒ¹é…ä½ç½®</span></span><br><span class="line">    PUCHAR addr = FindMultiplePatternsInRange(</span><br><span class="line">        region.BaseAddress,</span><br><span class="line">        region.RegionSize,</span><br><span class="line">        &amp;sig,</span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!addr) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æœªèƒ½å®šä½åˆ° PspCidTable ç‰¹å¾ç ä½ç½®\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äºŒçº§è§£å¼•ç”¨ï¼šä» MOV æŒ‡ä»¤ä¸­è·å–ç«‹å³åœ°å€ [imm32] -&gt; è§£å¼•ç”¨è·å– PspCidTable å€¼</span></span><br><span class="line">    g_PspCidTable = **(PVOID**)addr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒæŒ‡é’ˆæœ‰æ•ˆæ€§</span></span><br><span class="line">    <span class="keyword">if</span> (!MmIsAddressValid(g_PspCidTable)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] è§£å¼•ç”¨ PspCidTable å€¼æ— æ•ˆ: %p\n&quot;</span>, g_PspCidTable);</span><br><span class="line">        g_PspCidTable = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] æˆåŠŸè·å– PspCidTable = %p (from æŒ‡ä»¤åœ°å€ = %p)\n&quot;</span>, g_PspCidTable, addr);</span><br><span class="line">    <span class="keyword">return</span> g_PspCidTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–-ExpLookupHandleTableEntry"><a href="#è·å–-ExpLookupHandleTableEntry" class="headerlink" title="è·å– ExpLookupHandleTableEntry"></a>è·å– ExpLookupHandleTableEntry</h3><p>ç”±äºå¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•° <code>ExpLookupHandleTableEntry</code> åœ¨ä¸åŒç‰ˆæœ¬æ“ä½œç³»ç»Ÿçš„å®ç°ä¸å¤ªä¸€æ ·ï¼Œå› æ­¤æˆ‘ä»¬æ—¢ä¸æ–¹ä¾¿è‡ªå·±å®ç°ä¸€ä¸ªå¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°ï¼Œä¹Ÿä¸æ–¹ä¾¿ç›´æ¥é€šè¿‡æœç´¢ <code>ExpLookupHandleTableEntry</code> çš„ç‰¹å¾ç å®šä½è¯¥å‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ExEnumHandleTable</code> å‡½æ•°æ¥é—´æ¥å®šä½  <code>ExpLookupHandleTableEntry</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GetExpLookupHandleTableEntry - è·å– ExpLookupHandleTableEntry å‡½æ•°åœ°å€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æœ¬å‡½æ•°é€šè¿‡ç‰¹å¾ç ä» ExEnumHandleTable å‡½æ•°ä½“å†…åæ¨å‡ºå…¶è°ƒç”¨çš„ ExpLookupHandleTableEntry å‡½æ•°åœ°å€ã€‚</span></span><br><span class="line"><span class="comment"> * åŸå› æ˜¯ ExpLookupHandleTableEntry æœªå¯¼å‡ºï¼Œæ— æ³•ç›´æ¥è·å–ï¼Œåªèƒ½ä¾èµ–ä¸Šä¸‹æ–‡å®šä½ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"> *   æˆåŠŸï¼šè¿”å› ExpLookupHandleTableEntry çš„åœ°å€</span></span><br><span class="line"><span class="comment"> *   å¤±è´¥ï¼šè¿”å› NULL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PVOID</span><br><span class="line"><span class="title function_">GetExpLookupHandleTableEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    VOID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> PVOID g_ExpLookupHandleTableEntry = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»ç¼“å­˜æˆåŠŸï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (g_ExpLookupHandleTableEntry)</span><br><span class="line">        <span class="keyword">return</span> g_ExpLookupHandleTableEntry;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ MmGetSystemRoutineAddress è·å– ExEnumHandleTable å‡½æ•°åœ°å€</span></span><br><span class="line">    UNICODE_STRING uName = RTL_CONSTANT_STRING(<span class="string">L&quot;ExEnumHandleTable&quot;</span>);</span><br><span class="line">    PVOID pExEnum = MmGetSystemRoutineAddress(&amp;uName);</span><br><span class="line">    <span class="keyword">if</span> (!pExEnum) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•è·å– ExEnumHandleTable åœ°å€\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– ExpLookupHandleTableEntry ç‰¹å¾ç ï¼š</span></span><br><span class="line">    <span class="comment">// ç›®æ ‡å­—èŠ‚åºåˆ—å¦‚ä¸‹ï¼ˆå–è‡ª IDA åˆ†æï¼‰ï¼š</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//     FF 75 F8                push    [ebp+var_8]</span></span><br><span class="line">    <span class="comment">//     8B 4D 08                mov     ecx, [ebp+arg_0]</span></span><br><span class="line">    <span class="comment">//     E8 ?? ?? ?? ??          call    ExpLookupHandleTableEntry</span></span><br><span class="line">    <span class="comment">//     8B F0                   mov     esi, eax</span></span><br><span class="line">    <span class="comment">//     85 F6                   test    esi, esi</span></span><br><span class="line">    <span class="comment">//     75 ??                   jnz     ...</span></span><br><span class="line">    <span class="comment">//     EB ??                   jmp     ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// ç‰¹å¾ç å­—ç¬¦ä¸²å¦‚ä¸‹ï¼ˆ* è¡¨ç¤ºé€šé…ä»»æ„ 1 å­—èŠ‚ï¼‰ï¼š</span></span><br><span class="line">    <span class="comment">//     &quot;FF75*8B4D*E8****8BF085F675*EB*&quot;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// è®¾ç½® Offset = -7ï¼Œè¡¨ç¤ºæœ€ç»ˆç»“æœæŒ‡å‘ E8 åçš„ç›¸å¯¹åç§»å­—æ®µï¼Œå³ï¼š</span></span><br><span class="line">    <span class="comment">//     match - (-7) = match + 7 = CALL çš„ç«‹å³æ•°èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    SIGNATURE_PATTERN sig = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!InitSignaturePattern(&amp;sig, <span class="string">&quot;FF75*8B4D*E8****8BF085F675*EB*&quot;</span>, <span class="number">-7</span>)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] InitSignaturePattern åˆå§‹åŒ–å¤±è´¥\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ ExEnumHandleTable é™„è¿‘æŸ¥æ‰¾ç‰¹å¾ç ï¼ˆé€šå¸¸å‡½æ•°å¤§å°ä¸ä¼šè¶…è¿‡ 0x100 å­—èŠ‚ï¼‰</span></span><br><span class="line">    PUCHAR base = (PUCHAR)pExEnum;</span><br><span class="line">    SIZE_T searchRange = <span class="number">0x100</span>;</span><br><span class="line"></span><br><span class="line">    PUCHAR match = FindMultiplePatternsInRange(base, searchRange, &amp;sig, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æœªæ‰¾åˆ° ExpLookupHandleTableEntry ç‰¹å¾ç åŒ¹é…ä½ç½®\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå– call æŒ‡ä»¤ä¸­çš„ç›¸å¯¹åç§»</span></span><br><span class="line">    PUCHAR relAddr = match;  <span class="comment">// Offset = -7, åˆšå¥½æŒ‡å‘ call çš„ç«‹å³æ•°éƒ¨åˆ†</span></span><br><span class="line">    INT32 rel = *(INT32*)relAddr;</span><br><span class="line"></span><br><span class="line">    PUCHAR target = relAddr + <span class="number">4</span> + rel;  <span class="comment">// CALL æŒ‡ä»¤ç›®æ ‡ = å½“å‰åœ°å€ + 5 + ç›¸å¯¹åç§»</span></span><br><span class="line">    g_ExpLookupHandleTableEntry = (PVOID)target;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] æˆåŠŸå®šä½ ExpLookupHandleTableEntry = %p\n&quot;</span>, g_ExpLookupHandleTableEntry);</span><br><span class="line">    <span class="keyword">return</span> g_ExpLookupHandleTableEntry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°å®ç°"><a href="#å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°å®ç°" class="headerlink" title="å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°å®ç°"></a>å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°å®ç°</h3><p>åŸºäºå‰é¢è·å–çš„ <code>PspCidTable</code> å’Œ <code>ExpLookupHandleTableEntry</code> æˆ‘ä»¬å¯ä»¥å®ç°å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢ã€‚</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>åœ¨ 32 ä½ä¸‹ <code>ExpLookupHandleTableEntry</code> çš„è°ƒç”¨çº¦å®šæ˜¯ <code>thiscall</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€ä¸ªå‚æ•°æ”¾åœ¨ <code>ECX</code> ä¸­ï¼Œå‰©ä½™å‚æ•°æ”¾åœ¨å †æ ˆä¸Šã€‚</p>
<p>ç”±äº C è¯­è¨€ä¸æ”¯æŒ <code>thiscall</code> è°ƒç”¨çº¦å®šï¼Œé™¤éå†…è”æ±‡ç¼–è¿›è¡Œæ¨¡æ‹Ÿï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨ <code>fastcall</code> æ¥æ¨¡æ‹Ÿ <code>thiscall</code> è°ƒç”¨çº¦å®šã€‚è€Œ <code>fastcall</code> çš„å‰ä¸¤ä¸ªå‚æ•°æ”¾åœ¨ <code>ECX</code> å’Œ <code>EDX</code> ä¸­ï¼Œå‰©ä½™å‚æ•°æ”¾åœ¨å †æ ˆä¸Šï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¤šä¼ å…¥ä¸€ä¸ªå‚æ•°å ä½ <code>EDX</code>ã€‚</p>

    </div>
  </div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * QueryCidHandleEntry - æŸ¥è¯¢æŒ‡å®š PID/TID å¯¹åº”çš„å¥æŸ„è¡¨é¡¹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"> *   @UniqueId:      è¿›ç¨‹ PID æˆ–çº¿ç¨‹ TIDï¼ˆCID å€¼ï¼Œå¥æŸ„å€¼ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"> *   æˆåŠŸï¼šè¿”å›å¯¹åº”å¯¹è±¡æŒ‡é’ˆï¼ˆå¦‚ EPROCESS æˆ– ETHREADï¼‰</span></span><br><span class="line"><span class="comment"> *   å¤±è´¥ï¼šè¿”å› NULL</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼š</span></span><br><span class="line"><span class="comment"> *   - ä½¿ç”¨ __fastcall è°ƒç”¨æ¨¡æ‹Ÿ __thiscallï¼ˆECX = PspCidTableï¼‰</span></span><br><span class="line"><span class="comment"> *   - ç¬¬äºŒå‚æ•°ä¸ºå ä½ï¼ˆEDXï¼‰</span></span><br><span class="line"><span class="comment"> *   - å†…éƒ¨åŠ¨æ€å®šä½å…³é”®ç»“æ„ä¸å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PVOID</span><br><span class="line"><span class="title function_">QueryCidHandleEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE UniqueId</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€å¥æŸ„è¡¨åœ°å€ï¼ˆPspCidTableï¼‰</span></span><br><span class="line">    PHANDLE_TABLE cidTable = (PHANDLE_TABLE)GetPspCidTable();</span><br><span class="line">    <span class="keyword">if</span> (!cidTable) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] è·å– PspCidTable å¤±è´¥\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šä¹‰ fastcall å‡½æ•°æŒ‡é’ˆï¼ˆç¬¬ 2 å‚æ•° dummy ç”¨äºå ä½ï¼‰</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="title function_">PVOID</span> <span class="params">(__fastcall *EXP_LOOKUP_HANDLE_TABLE_ENTRY)</span><span class="params">(</span></span><br><span class="line"><span class="params">        PHANDLE_TABLE HandleTable,   <span class="comment">// å®é™…ä¸º thisï¼ˆECXï¼‰</span></span></span><br><span class="line"><span class="params">        PVOID Dummy,                 <span class="comment">// å ä½ç”¨äºå¡«å…… EDX</span></span></span><br><span class="line"><span class="params">        HANDLE Handle                <span class="comment">// è¦æŸ¥è¯¢çš„å¥æŸ„</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å‡½æ•°åœ°å€</span></span><br><span class="line">    EXP_LOOKUP_HANDLE_TABLE_ENTRY fnLookup =</span><br><span class="line">        (EXP_LOOKUP_HANDLE_TABLE_ENTRY)GetExpLookupHandleTableEntry();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fnLookup) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] è·å– ExpLookupHandleTableEntry å¤±è´¥\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢ï¼ˆä¼ å…¥ dummy å‚æ•°ä¸º 0ï¼‰</span></span><br><span class="line">    PVOID object = fnLookup(cidTable, <span class="literal">NULL</span>, UniqueId);</span><br><span class="line">    <span class="keyword">if</span> (!object) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æœªæ‰¾åˆ°å¥æŸ„é¡¹ï¼ˆHandle = %pï¼‰\n&quot;</span>, UniqueId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] æˆåŠŸæŸ¥è¯¢ CID å¯¹è±¡åœ°å€ = %p ï¼ˆHandle = %pï¼‰\n&quot;</span>, object, UniqueId);</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="è¿›ç¨‹ä¿æŠ¤"><a href="#è¿›ç¨‹ä¿æŠ¤" class="headerlink" title="è¿›ç¨‹ä¿æŠ¤"></a>è¿›ç¨‹ä¿æŠ¤</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>PsLookupProcessByProcessId</code> å’Œ <code>PsLookupThreadByThreadId</code> æ ¹æ®è¿›ç¨‹ ID å’Œçº¿ç¨‹ ID åœ¨å…¨å±€å¥æŸ„è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„è¿›ç¨‹å¯¹è±¡å’Œçº¿ç¨‹å¯¹è±¡ã€‚</p>
<p>å¦å¤–å¾ˆå¤š API ä¾‹å¦‚ <code>NtOpenProcess</code> å†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡ <code>PsLookupProcessByProcessId</code> ç­‰ API   æŸ¥è¯¢å…¨å±€å¥æŸ„è¡¨æ¥æ‰¾åˆ°è¿›ç¨‹çš„ã€‚</p>
<p>å› æ­¤å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿ<strong>å°†è‡ªèº«è¿›ç¨‹åœ¨å…¨å±€å¥æŸ„è¡¨ä¸­å¯¹åº”çš„å¥æŸ„è¡¨é¡¹æ¸…ç©º</strong>ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®©å¾ˆå¤šæŸ¥æ‰¾è¿›ç¨‹çš„ API æ— æ³•å®šä½åˆ°è‡ªèº«è¿›ç¨‹ä»è€Œè¾¾åˆ°è¿›ç¨‹ä¿æŠ¤çš„ç›®çš„ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¸…é™¤å¯¹è±¡æŒ‡é’ˆï¼ˆéšè—è¿›ç¨‹ï¼‰</span></span><br><span class="line">PVOID oldObject = InterlockedExchangePointer(&amp;entry-&gt;Object, <span class="literal">NULL</span>);</span><br><span class="line">DbgPrint(<span class="string">&quot;[+] æˆåŠŸéšè—è¿›ç¨‹ï¼ŒPID=%pï¼ŒåŸå¯¹è±¡åœ°å€=%p\n&quot;</span>, pid, oldObject);</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>PsLookupProcessByProcessId</code> å®é™…ä¸Šæ˜¯æ ¹æ®è¿›ç¨‹ ID æŸ¥è¯¢å‡ºå¯¹åº”çš„å…¨å±€å¥æŸ„è¡¨é¡¹ï¼Œå› æ­¤å¦‚æœå°†å…¨å±€å¥æŸ„è¡¨é¡¹ç½®ç©ºï¼Œåˆ™ä¼šå¯¼è‡´åç»­å‡ºç°å†…å­˜è®¿é—®é”™è¯¯ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CidEntry = ExMapHandleToPointer(PspCidTable, ProcessId);</span><br><span class="line"> <span class="keyword">if</span> (CidEntry != <span class="literal">NULL</span>) &#123;</span><br><span class="line">     lProcess = (PEPROCESS)CidEntry-&gt;Object;</span><br><span class="line">     <span class="keyword">if</span> (lProcess-&gt;Pcb.Header.Type == ProcessObject &amp;&amp; <span class="comment">// ğŸ‘ˆ CidEntry-&gt;Object = NULL å¯¼è‡´å†…å­˜è®¿é—®é”™è¯¯</span></span><br></pre></td></tr></table></figure></div>

<p><strong>ä½†æ˜¯å®é™…ä¸Šè¿™ç§äº‹æƒ…å¹¶æ²¡æœ‰å‘ç”Ÿ</strong>ï¼Œè¿™æ˜¯å› ä¸º<strong>æˆ‘ä»¬æ¸…ç©ºå…¨å±€å¥æŸ„è¡¨é¡¹å®é™…ä¸Šä¼šå¯¹å¥æŸ„è¡¨é¡¹åŠ é”</strong>ï¼Œè¿™å°±å¯¼è‡´ <code>ExMapHandleToPointer</code> è°ƒç”¨çš„ <code>ExpLockHandleTableEntry</code> å‡½æ•°åŠ é”å¤±è´¥è¿”å› <code>FALSE</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  å°†æŒ‡å®šå¥æŸ„è¡¨é¡¹è®¾ç½®ä¸ºåŠ é”çŠ¶æ€</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">BOOLEAN</span><br><span class="line">FORCEINLINE</span><br><span class="line"><span class="title function_">ExpLockHandleTableEntry</span> <span class="params">(</span></span><br><span class="line"><span class="params">    PHANDLE_TABLE HandleTable,</span></span><br><span class="line"><span class="params">    PHANDLE_TABLE_ENTRY HandleTableEntry</span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    LONG_PTR NewValue;</span><br><span class="line">    LONG_PTR CurrentValue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (TRUE)</span><br><span class="line">    &#123;</span><br><span class="line">        CurrentValue = ReadForWriteAccess((<span class="keyword">volatile</span> LONG_PTR *)&amp;HandleTableEntry-&gt;Object);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// å¦‚æœæœ€ä½ä½ä¸º 1ï¼Œè¡¨ç¤ºè¯¥è¡¨é¡¹å°šæœªåŠ é”ï¼Œå¯ä»¥å°è¯•åŠ é”</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (CurrentValue &amp; EXHANDLE_TABLE_ENTRY_LOCK_BIT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="comment">// è‹¥è¡¨é¡¹å€¼ä¸º 0ï¼Œåˆ™è¯¥é¡¹æœªä½¿ç”¨ï¼Œè¿”å›å¤±è´¥</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (CurrentValue == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> FALSE;  <span class="comment">// ğŸ‘ˆ ä»è¿™é‡Œè¿”å›</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿›è€Œå¯¼è‡´ <code>ExMapHandleToPointer</code> è¿”å› NULL å¯¼è‡´è¿›ç¨‹æŸ¥è¯¢å¤±è´¥ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥å¥æŸ„é¡¹æ˜¯å¦å­˜åœ¨ï¼Œä¸”èƒ½å¦æˆåŠŸåŠ é”ï¼ˆé˜²æ­¢å¹¶å‘è®¿é—®ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> ((HandleTableEntry == <span class="literal">NULL</span>) ||</span><br><span class="line">    !ExpLockHandleTableEntry(HandleTable, HandleTableEntry)) &#123;  <span class="comment">// ğŸ‘ˆ ExpLockHandleTableEntry è¿”å› FALSE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>ç„¶è€Œè¿™ç§æ–¹æ³•ä¼šå¯¼è‡´è¢«ä¿æŠ¤è¿›ç¨‹é€€å‡ºæ—¶è“å±ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ <code>PspProcessDelete</code> å‡½æ•°ä¸­ <code>ExDestroyHandle</code> æŸ¥è¯¢ä¸åˆ°æˆ‘ä»¬éšè—çš„è¿›ç¨‹ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Process-&gt;UniqueProcessId) &#123;  <span class="comment">// ğŸ‘ˆ Process-&gt;UniqueProcessId = 0 å¯ä»¥é¿å…è“å±</span></span><br><span class="line">    <span class="keyword">if</span> (!(ExDestroyHandle (PspCidTable, Process-&gt;UniqueProcessId, <span class="literal">NULL</span>))) &#123;</span><br><span class="line">        KeBugCheck (CID_HANDLE_DELETION);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦å°† <code>Process-&gt;UniqueProcessId</code> ç½® 0 å³å¯ã€‚å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * GetEprocessUniqueProcessIdOffset - è·å– _EPROCESS.UniqueProcessId å­—æ®µåç§»ï¼ˆç¼“å­˜ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æœ¬å‡½æ•°é€šè¿‡åˆ†æ PsGetProcessId å‡½æ•°ä¸­çš„æ±‡ç¼–ä»£ç ï¼Œæå–è®¿é—® `UniqueProcessId` æˆå‘˜çš„æŒ‡ä»¤åç§»ï¼ˆdisp32ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment"> * å¹¶å°†å…¶ç¼“å­˜ä»¥æå‡æ•ˆç‡ã€‚åŒ¹é…å­—èŠ‚ç å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     8B 45 08              mov     eax, [ebp+arg_0]</span></span><br><span class="line"><span class="comment"> *     8B 80 XX XX XX XX     mov     eax, [eax+UniqueProcessId]</span></span><br><span class="line"><span class="comment"> *     5D                    pop     ebp</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åŒ¹é…å­—ç¬¦ä¸²ï¼ˆ* è¡¨ç¤º 1 å­—èŠ‚é€šé…ï¼‰ï¼š&quot;8B45*8B80****5D&quot;</span></span><br><span class="line"><span class="comment"> * åç§»è®¾ç½®ä¸º Offset = -5ï¼ŒæŒ‡å‘ç¬¬äºŒæ¡ mov æŒ‡ä»¤çš„ disp32 ä½ç½®ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿”å›å€¼ï¼š</span></span><br><span class="line"><span class="comment"> *   æˆåŠŸï¼šè¿”å› UniqueProcessId åç§»ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰</span></span><br><span class="line"><span class="comment"> *   å¤±è´¥ï¼šè¿”å› -1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">LONG</span><br><span class="line"><span class="title function_">GetEprocessUniqueProcessIdOffset</span><span class="params">(</span></span><br><span class="line"><span class="params">    VOID</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> LONG g_UniquePidOffset = <span class="number">-2</span>;  <span class="comment">// -2 è¡¨ç¤ºæœªåˆå§‹åŒ–ï¼Œ-1 è¡¨ç¤ºå¤±è´¥ï¼Œ&gt;=0 ä¸ºåˆæ³•åç§»</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_UniquePidOffset != <span class="number">-2</span>)</span><br><span class="line">        <span class="keyword">return</span> g_UniquePidOffset;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– PsGetProcessId å‡½æ•°åœ°å€</span></span><br><span class="line">    UNICODE_STRING uName = RTL_CONSTANT_STRING(<span class="string">L&quot;PsGetProcessId&quot;</span>);</span><br><span class="line">    PVOID func = MmGetSystemRoutineAddress(&amp;uName);</span><br><span class="line">    <span class="keyword">if</span> (!func) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•è·å– PsGetProcessId åœ°å€\n&quot;</span>);</span><br><span class="line">        g_UniquePidOffset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç‰¹å¾ç </span></span><br><span class="line">    SIGNATURE_PATTERN sig = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!InitSignaturePattern(&amp;sig, <span class="string">&quot;8B45*8B80****5D&quot;</span>, <span class="number">-5</span>)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] InitSignaturePattern å¤±è´¥\n&quot;</span>);</span><br><span class="line">        g_UniquePidOffset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ PsGetProcessId å‡½æ•°ä½“å†…æœç´¢ç‰¹å¾ç </span></span><br><span class="line">    PUCHAR base = (PUCHAR)func;</span><br><span class="line">    SIZE_T range = <span class="number">0x40</span>;</span><br><span class="line">    PUCHAR match = FindMultiplePatternsInRange(base, range, &amp;sig, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!match) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æœªæ‰¾åˆ° UniqueProcessId åç§»åŒ¹é…ç‰¹å¾\n&quot;</span>);</span><br><span class="line">        g_UniquePidOffset = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå–åç§»å­—æ®µï¼ˆdisp32ï¼‰</span></span><br><span class="line">    g_UniquePidOffset = *(LONG*)match;</span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] _EPROCESS.UniqueProcessId åç§» = 0x%X\n&quot;</span>, g_UniquePidOffset);</span><br><span class="line">    <span class="keyword">return</span> g_UniquePidOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProtectProcess - éšè—æŒ‡å®š PID å¯¹åº”çš„è¿›ç¨‹å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"> *   @pid - ç›®æ ‡è¿›ç¨‹çš„ PIDï¼ˆå¥æŸ„å½¢å¼ï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> *   - æ¸…é™¤å…¨å±€å¥æŸ„è¡¨ä¸­æŒ‡å®š PID çš„å¯¹è±¡æŒ‡é’ˆï¼›</span></span><br><span class="line"><span class="comment"> *   - æ¸…é›¶å¯¹åº”è¿›ç¨‹å¯¹è±¡ä¸­çš„ UniqueProcessId å­—æ®µï¼Œé¿å… ExDestroyHandle è“å±ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">ProtectProcess</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE pid</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    DbgPrint(<span class="string">&quot;[*] å°è¯•éšè— PID = %p çš„è¿›ç¨‹å¯¹è±¡\n&quot;</span>, pid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢è¯¥ PID å¯¹åº”çš„å¥æŸ„è¡¨é¡¹</span></span><br><span class="line">    PHANDLE_TABLE_ENTRY entry = (PHANDLE_TABLE_ENTRY)QueryCidHandleEntry(pid);</span><br><span class="line">    <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æŸ¥è¯¢ CID è¡¨å¤±è´¥ï¼ŒPID=%p\n&quot;</span>, pid);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸå­æ¸…é™¤è¯¥å¥æŸ„è¡¨é¡¹ä¸­çš„å¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line">    PVOID oldObject = InterlockedExchangePointer(&amp;entry-&gt;Object, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!oldObject) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æŒ‡å®š PID çš„å¥æŸ„è¡¨é¡¹å¯¹è±¡å·²ä¸ºç©º\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] å·²æ¸…ç©ºå¥æŸ„è¡¨é¡¹ï¼ŒPID=%pï¼ŒåŸå¯¹è±¡åœ°å€=%p\n&quot;</span>, pid, oldObject);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– _EPROCESS.UniqueProcessId åç§»ï¼ˆé™æ€ç¼“å­˜ï¼‰</span></span><br><span class="line">    LONG offset = GetEprocessUniqueProcessIdOffset();</span><br><span class="line">    <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] è·å– UniqueProcessId åç§»å¤±è´¥ï¼Œæ— æ³•æ¸…é›¶ PID å­—æ®µ\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤ EPROCESS å¯¹è±¡ä¸­çš„ UniqueProcessId å­—æ®µï¼Œé˜²æ­¢è“å±</span></span><br><span class="line">    *(PHANDLE)((PUCHAR)oldObject + offset) = <span class="literal">NULL</span>;</span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] æˆåŠŸæ¸…é™¤ EPROCESS.UniqueProcessIdï¼ŒPID=%p\n&quot;</span>, pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿™ä¸ªæ–¹æ³•åœ¨è™šæ‹Ÿæœºä¸­ä¾ç„¶ä¼šé€ æˆè“å±ï¼Œè¿™æ˜¯ç”±è™šæ‹Ÿæœºçš„é©±åŠ¨ <code>vm3dmp.sys</code> æ³¨å†Œçš„è¿›ç¨‹é€€å‡ºå›è°ƒé€ æˆçš„ã€‚</p>

    </div>
  </div>

<h1 id="ç§æœ‰å¥æŸ„è¡¨"><a href="#ç§æœ‰å¥æŸ„è¡¨" class="headerlink" title="ç§æœ‰å¥æŸ„è¡¨"></a>ç§æœ‰å¥æŸ„è¡¨</h1><p><code>EPROCESS</code> çš„ <code>ObjectTable</code> æŒ‡é’ˆæŒ‡å‘æ”¹è¿›ç¨‹çš„ç§æœ‰å¥æŸ„è¡¨ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ä¸å…¨å±€å¥æŸ„è¡¨ä¸åŒçš„æ˜¯ï¼Œ<strong>ç§æœ‰å¥æŸ„è¡¨</strong>ä¸­çš„å¥æŸ„è¡¨é¡¹æŒ‡å‘çš„å¯¹è±¡æ˜¯åŒ…å« <code>OBJECT_HEADER</code> çš„ï¼Œæˆ‘ä»¬éœ€è¦åŠ ä¸Š <code>sizeof(_OBJECT_HEADER)</code> åç§»æ‰èƒ½æ‰¾åˆ°å¥æŸ„è¡¨é¡¹å®é™…å¯¹åº”çš„å¯¹è±¡ã€‚</p>

    </div>
  </div>

<h2 id="è·å–å¯¹è±¡ç±»å‹"><a href="#è·å–å¯¹è±¡ç±»å‹" class="headerlink" title="è·å–å¯¹è±¡ç±»å‹"></a>è·å–å¯¹è±¡ç±»å‹</h2><p>ç§æœ‰å¥æŸ„è¡¨ä¸­å­˜å‚¨çš„æ˜¯è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰å¥æŸ„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨éå†å…¶ä¸­çš„å¥æŸ„è¡¨é¡¹æ—¶éœ€è¦æ ¹æ®å¥æŸ„è¡¨é¡¹æŒ‡å‘çš„ <code>OBJECT_HEADER</code> æ¥ç¡®å®šå¯¹è±¡çš„ç±»å‹ã€‚ <code>OBJECT_HEADER</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x20 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_HEADER</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LONG PointerCount;                                           <span class="comment">// 0x00: å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼ˆåŒ…æ‹¬å†…æ ¸å’Œéå¥æŸ„å¼•ç”¨ï¼‰ï¼Œä¸º 0 æ—¶è¡¨ç¤ºå¯¹è±¡å¯å›æ”¶</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        LONG HandleCount;                                        <span class="comment">// 0x04: é€šè¿‡å¥æŸ„å¼•ç”¨è¯¥å¯¹è±¡çš„æ¬¡æ•°ï¼Œä»…å½“å¯¹è±¡å…·æœ‰å¥æŸ„æ—¶æœ‰æ•ˆ</span></span><br><span class="line">        VOID* NextToFree;                                        <span class="comment">// 0x04: å¦‚æœå¯¹è±¡å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œè¯¥å­—æ®µç”¨äºå¯¹è±¡æ± ä¸­çš„é“¾è¡¨æŒ‡é’ˆ</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">Lock</span>;</span>                                   <span class="comment">// 0x08: ç”¨äºåŒæ­¥å¯¹å¯¹è±¡å¤´çš„å¹¶å‘è®¿é—®ï¼ˆå¦‚å±æ€§ã€æ ‡å¿—çš„ä¿®æ”¹ï¼‰</span></span><br><span class="line">    UCHAR TypeIndex;                                             <span class="comment">// 0x0C: ğŸ“Œå¯¹è±¡ç±»å‹ç´¢å¼•ï¼ˆæŒ‡å‘å†…æ ¸çš„å¯¹è±¡ç±»å‹è¡¨ï¼‰ï¼Œå¦‚è¿›ç¨‹ã€çº¿ç¨‹ã€äº‹ä»¶ç­‰</span></span><br><span class="line">    UCHAR TraceFlags;                                            <span class="comment">// 0x0D: è·Ÿè¸ªç›¸å…³æ ‡å¿—ä½ï¼ˆå¦‚æ˜¯å¦å¯ç”¨å¯¹è±¡åˆ›å»º/åˆ é™¤è®°å½•ï¼‰</span></span><br><span class="line">    UCHAR InfoMask;                                              <span class="comment">// 0x0E: æŒ‡ç¤ºå“ªäº›æ‰©å±•ä¿¡æ¯å­—æ®µï¼ˆå¦‚åç§°ã€å®‰å…¨æè¿°ç¬¦ç­‰ï¼‰å·²å­˜åœ¨çš„æ©ç </span></span><br><span class="line">    UCHAR Flags;                                                 <span class="comment">// 0x0F: å¯¹è±¡æ ‡å¿—ï¼Œå¦‚ Permanentã€KernelOnlyAccessã€DefaultSecurityQuota ç­‰</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_CREATE_INFORMATION</span>* <span class="title">ObjectCreateInfo</span>;</span>     <span class="comment">// 0x10: å¯¹è±¡åˆ›å»ºæ—¶ä¼ å…¥çš„å‚æ•°ç»“æ„æŒ‡é’ˆï¼Œä»…åœ¨åˆ›å»ºé˜¶æ®µæœ‰æ•ˆ</span></span><br><span class="line">        VOID* QuotaBlockCharged;                                 <span class="comment">// 0x10: æŒ‡å‘è¢«æ”¶å–é…é¢çš„å—ï¼ˆå¦‚è¿›ç¨‹ï¼‰ï¼Œç”¨äºèµ„æºç»Ÿè®¡ä¸é™åˆ¶</span></span><br><span class="line">    &#125;;</span><br><span class="line">    VOID* SecurityDescriptor;                                    <span class="comment">// 0x14: æŒ‡å‘å®‰å…¨æè¿°ç¬¦çš„æŒ‡é’ˆï¼Œæè¿°è¯¥å¯¹è±¡çš„è®¿é—®æ§åˆ¶ä¿¡æ¯ï¼ˆACLï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">QUAD</span> <span class="title">Body</span>;</span>                                           <span class="comment">// 0x18: å¯¹è±¡çš„å®é™…æ•°æ®å†…å®¹ï¼ˆæ­£æ–‡ä½“ï¼‰ï¼Œç±»å‹ç”± TypeIndex å†³å®š</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>OBJECT_HEADER</code> ä¸­çš„ <code>Body</code> åªæ˜¯ä¸ªå ä½çš„æˆå‘˜ï¼Œç”¨æ¥è¡¨ç¤ºå¯¹è±¡æœ¬ä½“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œ <code>OBJECT_HEADER</code> çš„å®é™…å¤§å°ä¸º 0x18ã€‚è¿™ä¹ˆå®šä¹‰çš„å¥½å¤„æ˜¯æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ <code>CONTAINING_RECORD</code> ä»å¯¹è±¡æŒ‡é’ˆæ‰¾åˆ° <code>OBJECT_HEADER</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ CONTAINING_RECORD å®ä» Body åç§»å› _OBJECT_HEADER çš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="comment">// ç›¸å½“äºï¼šHeader = (POBJECT_HEADER)((PUCHAR)Object - offsetof(OBJECT_HEADER, Body));</span></span><br><span class="line">POBJECT_HEADER Header = CONTAINING_RECORD(Object, OBJECT_HEADER, Body);</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>å…¶ä¸­çš„ <code>TypeIndex</code> å­—æ®µè¡¨ç¤ºçš„æ˜¯å¯¹è±¡çš„ç±»å‹ç´¢å¼•ï¼Œè¿™é‡Œçš„ç´¢å¼•æ˜¯åœ¨ <code>OBJECT_TYPE</code> æŒ‡é’ˆæ•°ç»„ <code>ObTypeIndexTable</code> ä¸­çš„ç´¢å¼•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>OBJECT_TYPE</code> çš„ <code>Name</code> ç¡®å®šå¯¹è±¡çš„å…·ä½“ç±»å‹ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 0x88 bytes (sizeof)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TypeList</span>;</span>               <span class="comment">// 0x00: é“¾å…¥å…¨å±€å¯¹è±¡ç±»å‹é“¾è¡¨ä¸­çš„é“¾æ¥ï¼Œç”¨äºéå†ç³»ç»Ÿä¸­æ‰€æœ‰å¯¹è±¡ç±»å‹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">Name</span>;</span>               <span class="comment">// 0x08: ğŸ“Œå¯¹è±¡ç±»å‹åç§°ï¼ˆå¦‚ &quot;Process&quot;ã€&quot;Thread&quot;ã€&quot;Event&quot; ç­‰ï¼‰</span></span><br><span class="line">    VOID* DefaultObject;                       <span class="comment">// 0x10: æŒ‡å‘é»˜è®¤å¯¹è±¡å®ä¾‹çš„æŒ‡é’ˆï¼ˆå¦‚é»˜è®¤å‘½åç©ºé—´ã€æ¨¡æ¿å¯¹è±¡ç­‰ï¼‰</span></span><br><span class="line">    UCHAR Index;                               <span class="comment">// 0x14: å¯¹è±¡ç±»å‹åœ¨å†…æ ¸ç±»å‹æ•°ç»„ä¸­çš„ç´¢å¼•ï¼ˆä¸å¯¹è±¡å¤´ä¸­çš„ TypeIndex å¯¹åº”ï¼‰</span></span><br><span class="line">    ULONG TotalNumberOfObjects;                <span class="comment">// 0x18: å½“å‰ç³»ç»Ÿä¸­æ­¤ç±»å‹çš„å¯¹è±¡æ€»æ•°ï¼ˆåŒ…æ‹¬æœªè¢«å¼•ç”¨çš„ï¼‰</span></span><br><span class="line">    ULONG TotalNumberOfHandles;                <span class="comment">// 0x1C: å½“å‰æ´»åŠ¨çš„å¥æŸ„æ•°é‡ï¼ˆå³ç”¨æˆ·æ­£åœ¨ä½¿ç”¨çš„è¯¥ç±»å‹å¯¹è±¡æ€»æ•°ï¼‰</span></span><br><span class="line">    ULONG HighWaterNumberOfObjects;            <span class="comment">// 0x20: ç³»ç»Ÿå†å²ä¸Šæ›¾ç»åŒæ—¶å­˜åœ¨çš„æœ€å¤§è¯¥ç±»å‹å¯¹è±¡æ•°é‡ï¼ˆå¯¹è±¡å³°å€¼ï¼‰</span></span><br><span class="line">    ULONG HighWaterNumberOfHandles;            <span class="comment">// 0x24: å†å²ä¸ŠåŒæ—¶å­˜åœ¨çš„æœ€å¤§è¯¥ç±»å‹å¥æŸ„æ•°ï¼ˆå¥æŸ„å³°å€¼ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">OBJECT_TYPE_INITIALIZER</span> <span class="title">TypeInfo</span>;</span>  <span class="comment">// 0x28: åŒ…å«è¯¥ç±»å‹çš„è¡Œä¸ºå®šä¹‰ã€æƒé™æ§åˆ¶ã€å›è°ƒå‡½æ•°ç­‰åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">TypeLock</span>;</span>             <span class="comment">// 0x78: ä¿æŠ¤è¯¥å¯¹è±¡ç±»å‹å…ƒæ•°æ®è®¿é—®çš„è‡ªæ—‹é”ï¼ˆå¦‚è®¡æ•°å’Œå›è°ƒåˆ—è¡¨ï¼‰</span></span><br><span class="line">    ULONG Key;                                 <span class="comment">// 0x7C: ç±»å‹å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè°ƒè¯•æˆ–æŸ¥æ‰¾ç”¨é€”ï¼ˆç”±å†…æ ¸åˆ†é…ï¼‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">CallbackList</span>;</span>           <span class="comment">// 0x80: å¯¹è±¡å›è°ƒé“¾è¡¨ï¼ˆç”¨äºæ³¨å†Œç±»å‹ç›¸å…³çš„é€šçŸ¥ä¸æ“ä½œé’©å­ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶è€Œ <code>ObTypeIndexTable</code> åœ¨å†…æ ¸ä¸­å¹¶ä¸å¯¼å‡ºï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›å†…æ ¸å‡½æ•°ä¾‹å¦‚ <code>ObGetObjectType</code> å‡½æ•°æ¥å®šä½ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ ¹æ®å¯¹è±¡æŒ‡é’ˆè¿”å›å…¶å¯¹åº”çš„å¯¹è±¡ç±»å‹ï¼ˆPOBJECT_TYPEï¼‰</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">POBJECT_TYPE</span><br><span class="line"><span class="title function_">ObGetObjectType</span> <span class="params">(</span></span><br><span class="line"><span class="params">    IN PVOID Object                             <span class="comment">// [in] å¯¹è±¡æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    POBJECT_HEADER Header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ CONTAINING_RECORD è¿˜åŸ Header èµ·å§‹åœ°å€</span></span><br><span class="line">    Header = CONTAINING_RECORD(Object, OBJECT_HEADER, Body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®å¯¹è±¡å¤´ä¸­çš„ TypeIndex ä» ObTypeIndexTable ä¸­ç´¢å¼•å¯¹åº”çš„ OBJECT_TYPE ç»“æ„</span></span><br><span class="line">    <span class="keyword">return</span> ObTypeIndexTable[Header-&gt;TypeIndex];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä» Windows 10 64 ä½å¼€å§‹ï¼Œ<code>OBJECT_HEADER</code> ä¸­çš„ <code>TypeIndex</code> è¢«åŠ å¯†äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨ <code>ObGetObjectType</code> å‡½æ•°æ¥è·å–å¯¹è±¡å¯¹åº”çš„ <code>OBJECT_TYPE</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POBJECT_TYPE</span><br><span class="line"><span class="title function_">ObGetObjectType</span> <span class="params">(</span></span><br><span class="line"><span class="params">    IN PVOID Object                    <span class="comment">// æŒ‡å‘å¯¹è±¡æ­£æ–‡çš„æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">    )</span></span><br><span class="line">&#123;</span><br><span class="line">    POBJECT_HEADER Header;</span><br><span class="line">    UCHAR EncryptedTypeIndex;</span><br><span class="line">    UCHAR DecodedIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ CONTAINING_RECORD è¿˜åŸ Header èµ·å§‹åœ°å€</span></span><br><span class="line">    Header = CONTAINING_RECORD(Object, OBJECT_HEADER, Body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æå–åŠ å¯†åçš„ TypeIndex</span></span><br><span class="line">    EncryptedTypeIndex = Header-&gt;TypeIndex;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£å¯† TypeIndexï¼ˆä½¿ç”¨ ObHeaderCookie ä¸ header åœ°å€æ‰°åŠ¨ï¼‰</span></span><br><span class="line">    DecodedIndex = ObHeaderCookie</span><br><span class="line">                 ^ EncryptedTypeIndex</span><br><span class="line">                 ^ (UCHAR)(((ULONG_PTR)Header &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›å¯¹åº”çš„ OBJECT_TYPE æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">return</span> ObTypeIndexTable[DecodedIndex];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–å¦‚æœæ˜¯åˆ¤æ–­è¿›ç¨‹ç±»å‹çš„å¥æŸ„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ Windows å¯¼å‡ºçš„ <code>PsProcessType</code> è¿›è¡Œåˆ¤æ–­ã€‚</p>
<h2 id="å¥æŸ„é˜²é™æƒ"><a href="#å¥æŸ„é˜²é™æƒ" class="headerlink" title="å¥æŸ„é˜²é™æƒ"></a>å¥æŸ„é˜²é™æƒ</h2><p>å¥æŸ„é™æƒæ˜¯ä¿æŠ¤è¿›ç¨‹çš„ä¸€ä¸ªå¸¸è§æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ€è·¯æ˜¯<strong>æ¯éš”ä¸€æ®µæ—¶é—´å°±æ‰«æä¸€éæ‰€æœ‰è¿›ç¨‹çš„ç§æœ‰å¥æŸ„è¡¨ï¼Œä¸€æ—¦å‘ç°æœ‰å—ä¿æŠ¤è¿›ç¨‹çš„å¥æŸ„ï¼Œå°±ä¿®æ”¹è¯¥å¥æŸ„çš„æƒé™</strong>ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ç¤ºä¾‹ä»£ç æ²¡æœ‰å¤„ç†å—ä¿æŠ¤è¿›ç¨‹è‡ªèº«é€€å‡ºçš„æƒ…å†µï¼Œå…³é—­å—ä¿æŠ¤è¿›ç¨‹å¯èƒ½ä¼šå¯¼è‡´è“å±ã€‚</p>

    </div>
  </div>

<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> POBJECT_TYPE *PsProcessType;  <span class="comment">// ç¡®ä¿å¼•ç”¨æ­¤ç±»å‹ï¼Œç”¨äºæ£€æŸ¥å¯¹è±¡ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰æ§åˆ¶å®šæ—¶çº¿ç¨‹çš„äº‹ä»¶</span></span><br><span class="line">PKEVENT g_StopEvent = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HandleEnumCallback - å¥æŸ„æšä¸¾å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯¥å›è°ƒå‡½æ•°ä¼šåœ¨ `ExEnumHandleTable` éå†æ¯ä¸ªå¥æŸ„æ—¶è¢«è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> * å®ƒçš„åŠŸèƒ½æ˜¯æ£€æŸ¥æ¯ä¸ªå¥æŸ„æ˜¯å¦æŒ‡å‘æŒ‡å®šçš„è¿›ç¨‹ï¼Œå¹¶ç›´æ¥æ¸…é™¤å…¶æƒé™ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">BOOLEAN</span><br><span class="line"><span class="title function_">HandleEnumCallback</span><span class="params">(</span></span><br><span class="line"><span class="params">    HANDLE Handle,</span></span><br><span class="line"><span class="params">    PHANDLE_TABLE_ENTRY HandleEntry,</span></span><br><span class="line"><span class="params">    PVOID Context</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å–ä¸Šä¸‹æ–‡ä¸­çš„ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    PEPROCESS targetProcess = (PEPROCESS)Context;</span><br><span class="line">    PVOID rawObject = HandleEntry-&gt;Object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å®é™…å¯¹è±¡åœ°å€ï¼šrawObject æ˜¯æŒ‡å‘ OBJECT_HEADER çš„æŒ‡é’ˆ</span></span><br><span class="line">    POBJECT_HEADER header = (POBJECT_HEADER)((PUCHAR)rawObject &amp; ~<span class="number">7</span>);  <span class="comment">// æŒ‰ 8 å­—èŠ‚å¯¹é½</span></span><br><span class="line">    PEPROCESS actualObject = (PEPROCESS)((PUCHAR)header + <span class="number">0x18</span>);  <span class="comment">// OBJECT_HEADER åæ˜¯å¯¹è±¡å®é™…æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›´æ¥æ¯”è¾ƒå¯¹è±¡åœ°å€ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (actualObject == targetProcess) &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥ç§»é™¤ PROCESS_VM_READ å’Œ PROCESS_VM_WRITE æƒé™</span></span><br><span class="line">        HandleEntry-&gt;GrantedAccessBits &amp;= ~(PROCESS_VM_READ | PROCESS_VM_WRITE);</span><br><span class="line">        DbgPrint(<span class="string">&quot;[+] ç§»é™¤å¥æŸ„ 0x%p æƒé™ï¼Œæ¥è‡ªè¿›ç¨‹ PID=%p\n&quot;</span>, Handle, PsGetCurrentProcessId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> FALSE;  <span class="comment">// ç»§ç»­éå†</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProtectProcessHandle - éšè—æŒ‡å®š PID å¯¹åº”çš„è¿›ç¨‹å¥æŸ„å¹¶æ¸…é™¤æƒé™</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment"> *   @targetProcess - ç›®æ ‡è¿›ç¨‹å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åŠŸèƒ½ï¼š</span></span><br><span class="line"><span class="comment"> *   - æšä¸¾æ‰€æœ‰è¿›ç¨‹å¥æŸ„ï¼ŒæŸ¥æ‰¾æŒ‡å‘å—ä¿æŠ¤è¿›ç¨‹çš„å¥æŸ„ï¼›</span></span><br><span class="line"><span class="comment"> *   - æ¸…é™¤å¥æŸ„çš„ `PROCESS_VM_READ` å’Œ `PROCESS_VM_WRITE` æƒé™ï¼Œé˜²æ­¢å…¶ä»–è¿›ç¨‹è¯»å–æˆ–å†™å…¥ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">ProtectProcessHandle</span><span class="params">(</span></span><br><span class="line"><span class="params">    PEPROCESS targetProcess</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æšä¸¾æ‰€æœ‰è¿›ç¨‹å¥æŸ„</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG_PTR pid = <span class="number">4</span>; pid &lt; <span class="number">0x100000</span>; pid += <span class="number">4</span>) &#123;</span><br><span class="line">        PEPROCESS process = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(PsLookupProcessByProcessId((HANDLE)pid, &amp;process)))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–è¿›ç¨‹å¥æŸ„è¡¨ï¼Œ0xF4 åç§»</span></span><br><span class="line">        PHANDLE_TABLE handleTable = *(PHANDLE_TABLE*)((PUCHAR)process + <span class="number">0xF4</span>);</span><br><span class="line">        <span class="keyword">if</span> (handleTable) &#123;</span><br><span class="line">            ExEnumHandleTable(</span><br><span class="line">                handleTable,</span><br><span class="line">                HandleEnumCallback,</span><br><span class="line">                (PVOID)targetProcess,  <span class="comment">// ç›´æ¥ä¼ é€’ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">                <span class="literal">NULL</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObDereferenceObject(process);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ThreadFunction - å®šæ—¶çº¿ç¨‹å‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯¥å‡½æ•°å°†å®šæ—¶è°ƒç”¨ ProtectProcessHandleFromVmAccess æ¥ä¿æŠ¤æŒ‡å®šçš„è¿›ç¨‹ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">ThreadFunction</span><span class="params">(</span></span><br><span class="line"><span class="params">    PVOID StartContext</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PEPROCESS targetProcess = (PEPROCESS)StartContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ¥æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œåˆ™é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (KeWaitForSingleObject(g_StopEvent, Executive, KernelMode, FALSE, <span class="literal">NULL</span>) == STATUS_WAIT_0) &#123;</span><br><span class="line">            DbgPrint(<span class="string">&quot;[+] é©±åŠ¨åœæ­¢ï¼Œé€€å‡ºä¿æŠ¤çº¿ç¨‹\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®šæ—¶æ¯éš” 5 ç§’é’Ÿæ£€æŸ¥å¹¶ä¿æŠ¤è¿›ç¨‹å¥æŸ„</span></span><br><span class="line">        ProtectProcessHandle(targetProcess);</span><br><span class="line">        KeDelayExecutionThread(KernelMode, FALSE, &amp;((LARGE_INTEGER) &#123; <span class="number">-5</span> * <span class="number">1000</span> * <span class="number">1000</span> &#125;));  <span class="comment">// 5 ç§’</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * StartProtectingProcess - å¯åŠ¨ä¿æŠ¤è¿›ç¨‹çš„çº¿ç¨‹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é€šè¿‡å†…æ ¸çº¿ç¨‹å®šæ—¶æ‰§è¡Œå¥æŸ„ä¿æŠ¤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">StartProtectingProcess</span><span class="params">(</span></span><br><span class="line"><span class="params">    PEPROCESS targetProcess</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    PKEVENT event;</span><br><span class="line">    PETHREAD thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºäº‹ä»¶ï¼Œç”¨äºåœæ­¢å®šæ—¶çº¿ç¨‹</span></span><br><span class="line">    g_StopEvent = ExAllocatePool(NonPagedPool, <span class="keyword">sizeof</span>(KEVENT));  <span class="comment">// å»æ‰äº† WithTag</span></span><br><span class="line">    <span class="keyword">if</span> (g_StopEvent == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•åˆ›å»ºåœæ­¢äº‹ä»¶\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    KeInitializeEvent(g_StopEvent, NotificationEvent, FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºå®šæ—¶æ‰§è¡Œå¥æŸ„ä¿æŠ¤</span></span><br><span class="line">    PsCreateSystemThread(</span><br><span class="line">        &amp;thread,</span><br><span class="line">        THREAD_ALL_ACCESS,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        (PKSTART_ROUTINE)ThreadFunction,</span><br><span class="line">        (PVOID)targetProcess</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UnloadDriver - é©±åŠ¨å¸è½½æ—¶çš„æ¸…ç†å·¥ä½œ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åœæ­¢çº¿ç¨‹å¹¶æ¸…ç†èµ„æºã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID</span><br><span class="line"><span class="title function_">UnloadDriver</span><span class="params">(</span></span><br><span class="line"><span class="params">    PDRIVER_OBJECT DriverObject</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å‘é€åœæ­¢ä¿¡å·</span></span><br><span class="line">    <span class="keyword">if</span> (g_StopEvent) &#123;</span><br><span class="line">        KeSetEvent(g_StopEvent, <span class="number">0</span>, FALSE);</span><br><span class="line">        ExFreePool(g_StopEvent);  <span class="comment">// å»æ‰äº† WithTag</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] é©±åŠ¨å¸è½½\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS</span><br><span class="line"><span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    PDRIVER_OBJECT   DriverObject,</span></span><br><span class="line"><span class="params">    PUNICODE_STRING  RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(RegistryPath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºå¸è½½å‡½æ•°æ³¨å†Œ</span></span><br><span class="line">    DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¤ºä¾‹ä¿æŠ¤è¿›ç¨‹ PID ä¸º 1234</span></span><br><span class="line">    PEPROCESS targetProcess = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(PsLookupProcessByProcessId((HANDLE)<span class="number">1234</span>, &amp;targetProcess))) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•æ‰¾åˆ°è¿›ç¨‹\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ä¿æŠ¤è¿›ç¨‹</span></span><br><span class="line">    StartProtectingProcess(targetProcess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="å¥æŸ„è¡¨æ–­é“¾"><a href="#å¥æŸ„è¡¨æ–­é“¾" class="headerlink" title="å¥æŸ„è¡¨æ–­é“¾"></a>å¥æŸ„è¡¨æ–­é“¾</h3><p>é€šå¸¸è¿™ç§é™æƒæ‰‹æ®µæ˜¯é€šè¿‡éå†ç§æœ‰å¥æŸ„è¡¨é“¾è¡¨å®ç°çš„ï¼Œå³éå† <code>HANDLE_TABLE</code> çš„ <code>HandleTableList</code>ã€‚å¦‚æœæˆ‘ä»¬å°†è‡ªèº«è¿›ç¨‹çš„ç§æœ‰å¥æŸ„è¡¨ä»å¥æŸ„è¡¨é“¾è¡¨ä¸­æ–­é“¾åˆ™å¯ä»¥é¿å…å¥æŸ„è¢«é™æƒã€‚ä¸è¿‡è¿™ç§æ–¹æ³•ä¼šå¯¼è‡´è“å±ï¼Œå¥½åœ¨è“å±éœ€è¦å¾ˆé•¿ä¸€æ®µæ—¶é—´æ‰ä¼šè§¦å‘ã€‚</p>
<h3 id="ä¼ªé€ è¿›ç¨‹"><a href="#ä¼ªé€ è¿›ç¨‹" class="headerlink" title="ä¼ªé€ è¿›ç¨‹"></a>ä¼ªé€ è¿›ç¨‹</h3><p>å¦ä¸€ç§æ€è·¯æ˜¯åˆ›å»ºä¸€ä¸ªâ€å½±å­è¿›ç¨‹â€ï¼Œæ¬ºéª—ä¿æŠ¤æœºåˆ¶ï¼ŒåŒæ—¶ä¿æŒå¯¹ç›®æ ‡è¿›ç¨‹çš„å®Œå…¨è®¿é—®æƒé™ã€‚å…¶å¯¹æŠ—è¿‡ç¨‹å¯åˆ†ä¸ºä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š</p>
<ol>
<li><strong>åˆ›å»ºä¼ªé€ è¿›ç¨‹å¯¹è±¡</strong>ï¼šåˆ†é…å†…å­˜å¹¶å¤åˆ¶ç›®æ ‡è¿›ç¨‹çš„å®Œæ•´ <code>OBJECT_HEADER</code> å’Œ <code>EPROCESS</code> ç»“æ„ã€‚ä¿®æ”¹å…³é”®å­—æ®µï¼šä¾‹å¦‚å°† PID è®¾ä¸º 0ï¼Œæ¸…ç©ºè¿›ç¨‹åç§°ï¼Œè¿›ä¸€æ­¥å¯¹æŠ—ç§æœ‰å¥æŸ„è¡¨æ‰«æã€‚</li>
<li><strong>å¤åˆ¶é¡µè¡¨</strong>ï¼šå¤åˆ¶ç›®æ ‡è¿›ç¨‹çš„ <code>CR3</code> é¡µè¡¨åˆ°æ–°çš„ç‰©ç†å†…å­˜ï¼Œæ›´æ–°ä¼ªé€ è¿›ç¨‹å¯¹è±¡çš„ <code>CR3</code> æŒ‡å‘æ–°å¤åˆ¶çš„é¡µè¡¨</li>
<li><strong>é‡å®šå‘å¥æŸ„</strong>ï¼šéå†æ‰€æœ‰è¿›ç¨‹çš„å¥æŸ„è¡¨ï¼Œå°†æŒ‡å‘è¢«ä¿æŠ¤çš„ç›®æ ‡è¿›ç¨‹çš„å¥æŸ„é‡å®šå‘åˆ°ä¼ªé€ å¯¹è±¡ï¼Œä¿ç•™å¥æŸ„è¡¨é¡¹çš„ä½ 3 ä½æ ‡å¿—ä½å¹¶æ¢å¤å®Œæ•´è®¿é—®æƒé™ï¼ˆ<code>PROCESS_ALL_ACCESS</code>ï¼‰ã€‚</li>
</ol>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰å…³é”®åç§»é‡ï¼ˆæ ¹æ®Windowsç‰ˆæœ¬è°ƒæ•´ï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EPROCESS_UNIQUE_PROCESS_ID_OFFSET 0x140   <span class="comment">// UniqueProcessId åç§»</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EPROCESS_IMAGE_FILE_NAME_OFFSET   0x16C   <span class="comment">// ImageFileName åç§»</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EPROCESS_DIRECTORY_TABLE_BASE_OFFSET 0x18 <span class="comment">// DirectoryTableBase åç§»</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_HEADER_BODY_OFFSET         0x18    <span class="comment">// å¯¹è±¡å¤´åˆ°å¯¹è±¡ä½“çš„åç§»</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…¨å±€å˜é‡</span></span><br><span class="line">PEPROCESS g_targetProcess = <span class="literal">NULL</span>;        <span class="comment">// ç›®æ ‡è¿›ç¨‹çœŸå®EPROCESS</span></span><br><span class="line">PVOID g_fakeHeader = <span class="literal">NULL</span>;               <span class="comment">// ä¼ªé€ çš„OBJECT_HEADERï¼ˆåŒ…å«å®Œæ•´å¯¹è±¡å¤´ï¼‰</span></span><br><span class="line">PHYSICAL_ADDRESS g_fakeCr3 = &#123; <span class="number">0</span> &#125;;      <span class="comment">// ä¼ªé€ çš„CR3ç‰©ç†åœ°å€</span></span><br><span class="line">PVOID g_fakePageTable = <span class="literal">NULL</span>;            <span class="comment">// ä¼ªé€ çš„é¡µè¡¨å†…å­˜</span></span><br><span class="line">ULONG g_protectedPid = <span class="number">1234</span>;             <span class="comment">// å—ä¿æŠ¤è¿›ç¨‹PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é…ç‰©ç†å†…å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PVOID <span class="title function_">AllocatePhysicalMemory</span><span class="params">(SIZE_T size, PHYSICAL_ADDRESS* physicalAddress)</span></span><br><span class="line">&#123;</span><br><span class="line">    PVOID virtualAddress = MmAllocateContiguousMemory(</span><br><span class="line">        size, </span><br><span class="line">        &#123; MAXULONG_PTR &#125;     <span class="comment">// HighestAcceptableAddress</span></span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (virtualAddress) &#123;</span><br><span class="line">        *physicalAddress = MmGetPhysicalAddress(virtualAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> virtualAddress;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å½“å‰åˆ†é¡µæ¨¡å¼ä¸‹çš„é¡µè¡¨å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SIZE_T <span class="title function_">GetPageTableSize</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æ ‡å‡†é¡µè¡¨å¤§å°</span></span><br><span class="line">    SIZE_T tableSize = PAGE_SIZE;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å¯ç”¨PAE</span></span><br><span class="line">    <span class="keyword">if</span> (IsProcessorFeaturePresent(PF_PAE_ENABLED)) &#123;</span><br><span class="line">        <span class="comment">// PAEæ¨¡å¼ä¸‹CR3æŒ‡å‘PDPTï¼ˆ4ä¸ª8å­—èŠ‚æ¡ç›®ï¼‰</span></span><br><span class="line">        tableSize = <span class="number">32</span>; <span class="comment">// 4 * 8 bytes</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> tableSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤åˆ¶é¡µè¡¨å†…å®¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">NTSTATUS <span class="title function_">CopyPageTable</span><span class="params">(PHYSICAL_ADDRESS sourceCr3, PVOID* destination, PHYSICAL_ADDRESS* destCr3)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰åˆ†é¡µæ¨¡å¼ä¸‹çš„é¡µè¡¨å¤§å°</span></span><br><span class="line">    SIZE_T tableSize = GetPageTableSize();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é…æ–°é¡µè¡¨ï¼ˆç¡®ä¿åˆ†é…å®Œæ•´çš„é¡µé¢ï¼‰</span></span><br><span class="line">    PVOID newPageTable = AllocatePhysicalMemory(PAGE_SIZE, destCr3);</span><br><span class="line">    <span class="keyword">if</span> (!newPageTable) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ˜ å°„æºé¡µè¡¨åˆ°ç³»ç»Ÿç©ºé—´</span></span><br><span class="line">    SIZE_T mapSize = (sourceCr3.LowPart &amp; <span class="number">0xFFF</span>) + tableSize &gt; PAGE_SIZE ? </span><br><span class="line">                     PAGE_SIZE : tableSize;</span><br><span class="line">    </span><br><span class="line">    PVOID sourcePageTable = MmMapIoSpace(sourceCr3, mapSize, MmNonCached);</span><br><span class="line">    <span class="keyword">if</span> (!sourcePageTable) &#123;</span><br><span class="line">        MmFreeContiguousMemory(newPageTable);</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶é¡µè¡¨å†…å®¹</span></span><br><span class="line">    RtlCopyMemory(newPageTable, sourcePageTable, tableSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è§£é™¤æ˜ å°„</span></span><br><span class="line">    MmUnmapIoSpace(sourcePageTable, mapSize);</span><br><span class="line">    </span><br><span class="line">    *destination = newPageTable;</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ªé€ è¿›ç¨‹å¯¹è±¡ï¼ˆåŒ…å«å®Œæ•´OBJECT_HEADERï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">NTSTATUS <span class="title function_">CreateFakeProcessObject</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—ç›®æ ‡è¿›ç¨‹OBJECT_HEADERåœ°å€</span></span><br><span class="line">    POBJECT_HEADER targetHeader = (POBJECT_HEADER)((PUCHAR)g_targetProcess - OBJECT_HEADER_BODY_OFFSET);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ†é…ä¼ªé€ çš„OBJECT_HEADER</span></span><br><span class="line">    g_fakeHeader = ExAllocatePool(NonPagedPool, PAGE_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (!g_fakeHeader) &#123;</span><br><span class="line">        <span class="keyword">return</span> STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶å®Œæ•´OBJECT_HEADERå’ŒEPROCESSå†…å®¹</span></span><br><span class="line">    RtlCopyMemory(g_fakeHeader, targetHeader, PAGE_SIZE);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¡ç®—ä¼ªé€ çš„EPROCESSåœ°å€</span></span><br><span class="line">    PEPROCESS fakeProcess = (PEPROCESS)((PUCHAR)g_fakeHeader + OBJECT_HEADER_BODY_OFFSET);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿®æ”¹PIDä¸º0ï¼ˆæ— æ•ˆPIDï¼‰</span></span><br><span class="line">    *(HANDLE*)((PUCHAR)fakeProcess + EPROCESS_UNIQUE_PROCESS_ID_OFFSET) = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ¸…ç©ºè¿›ç¨‹åç§°</span></span><br><span class="line">    PUCHAR imageFileName = (PUCHAR)fakeProcess + EPROCESS_IMAGE_FILE_NAME_OFFSET;</span><br><span class="line">    RtlZeroMemory(imageFileName, <span class="number">15</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–åŸå§‹CR3ï¼ˆç›´æ¥ä»DirectoryTableBaseè¯»å–ç‰©ç†åœ°å€ï¼‰</span></span><br><span class="line">    PHYSICAL_ADDRESS originalCr3;</span><br><span class="line">    originalCr3.QuadPart = *(ULONG_PTR*)((PUCHAR)g_targetProcess + EPROCESS_DIRECTORY_TABLE_BASE_OFFSET);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤åˆ¶é¡µè¡¨</span></span><br><span class="line">    status = CopyPageTable(originalCr3, &amp;g_fakePageTable, &amp;g_fakeCr3);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        ExFreePool(g_fakeHeader);</span><br><span class="line">        g_fakeHeader = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®ä¼ªé€ çš„CR3</span></span><br><span class="line">    *(ULONG_PTR*)((PUCHAR)fakeProcess + EPROCESS_DIRECTORY_TABLE_BASE_OFFSET) = g_fakeCr3.QuadPart;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡å®šå‘æŒ‡å®šè¿›ç¨‹çš„å¥æŸ„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID <span class="title function_">RedirectProcessHandles</span><span class="params">(PEPROCESS process)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è·å–è¿›ç¨‹å¥æŸ„è¡¨ï¼ˆåç§»0xF4ï¼Œæ ¹æ®Windowsç‰ˆæœ¬è°ƒæ•´ï¼‰</span></span><br><span class="line">    PHANDLE_TABLE handleTable = *(PHANDLE_TABLE*)((PUCHAR)process + <span class="number">0xF4</span>);</span><br><span class="line">    <span class="keyword">if</span> (!handleTable) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æšä¸¾å¹¶é‡å®šå‘å¥æŸ„</span></span><br><span class="line">    ExEnumHandleTable(</span><br><span class="line">        handleTable,</span><br><span class="line">        [](HANDLE, PHANDLE_TABLE_ENTRY HandleEntry, PVOID) -&gt; BOOLEAN &#123;</span><br><span class="line">            PVOID object = HandleEntry-&gt;Object;</span><br><span class="line">            POBJECT_HEADER header = (POBJECT_HEADER)((ULONG_PTR)object &amp; ~<span class="number">7</span>);</span><br><span class="line">            PVOID body = (PUCHAR)header + OBJECT_HEADER_BODY_OFFSET;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ£€æŸ¥æ˜¯å¦æŒ‡å‘ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (body == g_targetProcess) &#123;</span><br><span class="line">                <span class="comment">// æ„é€ æ–°çš„å¥æŸ„å¯¹è±¡æŒ‡é’ˆï¼ˆä¿ç•™ä½3ä½æ ‡å¿—ï¼‰</span></span><br><span class="line">                ULONG_PTR fakeObject = (ULONG_PTR)g_fakeHeader;</span><br><span class="line">                fakeObject |= (ULONG_PTR)object &amp; <span class="number">7</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// é‡å®šå‘å¥æŸ„åˆ°ä¼ªé€ å¯¹è±¡</span></span><br><span class="line">                HandleEntry-&gt;Object = (PVOID)fakeObject;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// æ¢å¤å¿…è¦æƒé™ï¼ˆç¡®ä¿æ”»å‡»è€…è¿›ç¨‹å¯ä»¥è®¿é—®ï¼‰</span></span><br><span class="line">                HandleEntry-&gt;GrantedAccessBits |= PROCESS_ALL_ACCESS;</span><br><span class="line">                </span><br><span class="line">                DbgPrint(<span class="string">&quot;[+] é‡å®šå‘å¥æŸ„åˆ°ä¼ªé€ å¯¹è±¡ (PID=%d)\n&quot;</span>, </span><br><span class="line">                         PsGetProcessId(PsGetCurrentProcess()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> TRUE; <span class="comment">// ç»§ç»­æšä¸¾</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»…é‡å®šå‘ç‰¹å®šè¿›ç¨‹çš„å¥æŸ„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID <span class="title function_">RedirectSpecificProcessHandles</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// é‡å®šå‘æ‰€æœ‰éæ”»å‡»è€…è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span> (ULONG_PTR pid = <span class="number">4</span>; pid &lt; <span class="number">0x100000</span>; pid += <span class="number">4</span>) &#123;</span><br><span class="line">        PEPROCESS process = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(PsLookupProcessByProcessId((HANDLE)pid, &amp;process))) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        RedirectProcessHandles(process);</span><br><span class="line">        ObDereferenceObject(process);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¸…ç†èµ„æº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID <span class="title function_">CleanupFakeProcess</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_fakePageTable) &#123;</span><br><span class="line">        MmFreeContiguousMemory(g_fakePageTable);</span><br><span class="line">        g_fakePageTable = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (g_fakeHeader) &#123;</span><br><span class="line">        ExFreePool(g_fakeHeader);</span><br><span class="line">        g_fakeHeader = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é©±åŠ¨å¸è½½å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">VOID <span class="title function_">UnloadDriver</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(DriverObject);</span><br><span class="line">    CleanupFakeProcess();</span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] é©±åŠ¨å¸è½½å®Œæˆ\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é©±åŠ¨å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    UNREFERENCED_PARAMETER(RegistryPath);</span><br><span class="line">    DriverObject-&gt;DriverUnload = UnloadDriver;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç›®æ ‡è¿›ç¨‹</span></span><br><span class="line">    NTSTATUS status = PsLookupProcessByProcessId((HANDLE)g_protectedPid, &amp;g_targetProcess);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] æ— æ³•æ‰¾åˆ°ç›®æ ‡è¿›ç¨‹ (PID=%d)\n&quot;</span>, g_protectedPid);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¼ªé€ çš„è¿›ç¨‹å¯¹è±¡</span></span><br><span class="line">    status = CreateFakeProcessObject();</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(status)) &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;[-] åˆ›å»ºä¼ªé€ è¿›ç¨‹å¯¹è±¡å¤±è´¥: 0x%X\n&quot;</span>, status);</span><br><span class="line">        ObDereferenceObject(g_targetProcess);</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å®šå‘éæ”»å‡»è€…è¿›ç¨‹çš„å¥æŸ„</span></span><br><span class="line">    RedirectSpecificProcessHandles();</span><br><span class="line">    </span><br><span class="line">    DbgPrint(<span class="string">&quot;[+] è¿›ç¨‹ä¿æŠ¤å·²å¯ç”¨! çœŸå®è¿›ç¨‹: 0x%p, ä¼ªé€ å¯¹è±¡: 0x%p\n&quot;</span>, </span><br><span class="line">             g_targetProcess, g_fakeHeader);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>




		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> windows å¥æŸ„è¡¨</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2022-09-28 11:45:14</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-08-19 01:14:16
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2022/09/28/windows å¥æŸ„è¡¨/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/windows-kernel-reverse/">#windows kernel reverse</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2022/09/28/windows%20%E7%94%A8%E6%88%B7%E6%80%81%E9%80%86%E5%90%91%E5%BC%80%E5%8F%91/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">windows ç”¨æˆ·æ€é€†å‘å¼€å‘</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2022/09/28/windows%20%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">windows ä¿æŠ¤æ¨¡å¼</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">windows å¥æŸ„è¡¨</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E8%A1%A8%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="nav-text">å¥æŸ„è¡¨ç›¸å…³ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#EXHANDLE"><span class="nav-text">EXHANDLE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HANDLE-TABLE"><span class="nav-text">HANDLE_TABLE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HANDLE-TABLE-ENTRY"><span class="nav-text">HANDLE_TABLE_ENTRY</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E8%A1%A8%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">å¥æŸ„è¡¨ç›¸å…³ä»£ç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E6%9F%A5%E6%89%BE%E8%BF%87%E7%A8%8B"><span class="nav-text">å¥æŸ„æŸ¥æ‰¾è¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ExMapHandleToPointer"><span class="nav-text">ExMapHandleToPointer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ExpLookupHandleTableEntry"><span class="nav-text">ExpLookupHandleTableEntry</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E8%A1%A8%E9%81%8D%E5%8E%86"><span class="nav-text">å¥æŸ„è¡¨éå†</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%A5%E6%9F%84%E8%A1%A8"><span class="nav-text">å…¨å±€å¥æŸ„è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E8%A1%A8%E9%A1%B9%E6%B7%BB%E5%8A%A0"><span class="nav-text">å¥æŸ„è¡¨é¡¹æ·»åŠ </span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%A5%E6%9F%84%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-text">å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-PspCidTable"><span class="nav-text">è·å– PspCidTable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-ExpLookupHandleTableEntry"><span class="nav-text">è·å– ExpLookupHandleTableEntry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%8F%A5%E6%9F%84%E8%A1%A8%E6%9F%A5%E8%AF%A2%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="nav-text">å…¨å±€å¥æŸ„è¡¨æŸ¥è¯¢å‡½æ•°å®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E4%BF%9D%E6%8A%A4"><span class="nav-text">è¿›ç¨‹ä¿æŠ¤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%A7%81%E6%9C%89%E5%8F%A5%E6%9F%84%E8%A1%A8"><span class="nav-text">ç§æœ‰å¥æŸ„è¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="nav-text">è·å–å¯¹è±¡ç±»å‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E9%98%B2%E9%99%8D%E6%9D%83"><span class="nav-text">å¥æŸ„é˜²é™æƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%A5%E6%9F%84%E8%A1%A8%E6%96%AD%E9%93%BE"><span class="nav-text">å¥æŸ„è¡¨æ–­é“¾</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E9%80%A0%E8%BF%9B%E7%A8%8B"><span class="nav-text">ä¼ªé€ è¿›ç¨‹</span></a></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        51 posts in total
                    </span>
                    
                        <span>
                            949.7k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>