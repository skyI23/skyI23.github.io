<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    
    <!-- Completely eliminate flash of wrong theme -->
    <script>
        (function() {
            const THEME_KEY = "REDEFINE-THEME-STATUS";
            const DARK = "dark", LIGHT = "light";
            
            // Get preferred theme
            function getTheme() {
                try {
                    const saved = localStorage.getItem(THEME_KEY);
                    if (saved) {
                        const { isDark } = JSON.parse(saved);
                        return isDark ? DARK : LIGHT;
                    }
                } catch (e) {}
                
                return matchMedia("(prefers-color-scheme: dark)").matches ? DARK : LIGHT;
            }
            
            // Apply theme to document
            function applyTheme(theme) {
                const isDark = theme === DARK;
                const root = document.documentElement;
                
                // Set data attribute for CSS variables
                root.setAttribute("data-theme", theme);
                
                // Set classes for compatibility
                root.classList.add(theme);
                root.classList.remove(isDark ? LIGHT : DARK);
                root.style.colorScheme = theme;
            }
            
            // Initial application
            const theme = getTheme();
            applyTheme(theme);
            
            // Listen for system preference changes
            matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({ matches }) => {
                // Only update if using system preference (no localStorage entry)
                if (!localStorage.getItem(THEME_KEY)) {
                    applyTheme(matches ? DARK : LIGHT);
                }
            });
            
            // Set body classes once DOM is ready
            if (document.readyState !== "loading") {
                document.body.classList.add(theme + "-mode");
            } else {
                document.addEventListener("DOMContentLoaded", () => {
                    document.body.classList.add(theme + "-mode");
                    document.body.classList.remove((theme === DARK ? LIGHT : DARK) + "-mode");
                });
            }
        })();
    </script>
    
    <!-- Critical CSS to prevent flash -->
    <style>
        :root[data-theme="dark"] {
            --background-color: #202124;
            --background-color-transparent: rgba(32, 33, 36, 0.6);
            --second-background-color: #2d2e32;
            --third-background-color: #34353a;
            --third-background-color-transparent: rgba(32, 33, 36, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #ffffff;
            --second-text-color: #eeeeee;
            --third-text-color: #bebec6;
            --fourth-text-color: #999999;
            --default-text-color: #bebec6;
            --invert-text-color: #373D3F;
            --border-color: rgba(255, 255, 255, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(255, 255, 255, 0.08);
            --shadow-color-2: rgba(255, 255, 255, 0.05);
        }
        
        :root[data-theme="light"] {
            --background-color: #fff;
            --background-color-transparent: rgba(255, 255, 255, 0.6);
            --second-background-color: #f8f8f8;
            --third-background-color: #f2f2f2;
            --third-background-color-transparent: rgba(241, 241, 241, 0.6);
            --primary-color: #0066CC;
            --first-text-color: #16171a;
            --second-text-color: #2f3037;
            --third-text-color: #5e5e5e;
            --fourth-text-color: #eeeeee;
            --default-text-color: #373D3F;
            --invert-text-color: #bebec6;
            --border-color: rgba(0, 0, 0, 0.08);
            --selection-color: #0066CC;
            --shadow-color-1: rgba(0, 0, 0, 0.08);
            --shadow-color-2: rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
        
        /* Apply body classes as soon as DOM is ready */
        :root[data-theme="dark"] body {
            background-color: var(--background-color);
            color: var(--default-text-color);
        }
    </style>
    
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2025/11/13/java shiro/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
    
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/null" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/null">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/null">
    <!--- Page Info-->
    
    <title>
        
            Java Shiro | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/css/build/tailwind.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"delete_mask":false,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":5,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"pangu_js":false,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"side_tools":{"gear_rotation":true,"auto_expand":false},"open_graph":{"enable":false,"image":"/images/redefine-og.webp","description":"Hexo Theme Redefine, Redefine Your Hexo Journey."},"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["书有未曾经我读，事无不可对人言"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"11.4.1"}},"version":"2.8.5","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"分类":{"icon":"fa-solid fa-folder","path":"/categories/"},"标签":{"icon":"fa-solid fa-tags","path":"/tags/"},"书签":{"icon":"fa-solid fa-bookmark","path":"/bookmarks/"}},"search":{"enable":true,"preload":true}},"page_templates":{"bookmarks_column":3,"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/11/7 00:00:00"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>



<body>
	<div class="progress-bar-container">
	
	<span class="scroll-progress-bar"></span>
	

	
	<span class="pjax-progress-bar"></span>
	<!--        <span class="swup-progress-icon">-->
	<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
	<!--        </span>-->
	
</div>

<main class="page-container" id="swup">

	

	<div class="main-content-container flex flex-col justify-between min-h-dvh">
		<div class="main-content-header">
			<header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories/"
                                        >
                                    <i class="fa-solid fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/tags/"
                                        >
                                    <i class="fa-solid fa-tags fa-fw"></i>
                                    标签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/bookmarks/"
                                        >
                                    <i class="fa-solid fa-bookmark fa-fw"></i>
                                    书签
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories/"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-solid fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/tags/"
                        >
                            <span>
                                标签
                            </span>
                            
                                <i class="fa-solid fa-tags fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/bookmarks/"
                        >
                            <span>
                                书签
                            </span>
                            
                                <i class="fa-solid fa-bookmark fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">17</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">57</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


		</div>

		<div class="main-content-body transition-fade-up">
			

			<div class="main-content">
				<div class="post-page-container flex relative justify-between box-border w-full h-full">
	<div class="article-content-container">

		<div class="article-title relative w-full">
			
			<div class="w-full flex items-center pt-6 justify-start">
				<h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Java Shiro</h1>
			</div>
			
		</div>

		
		<div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
			<div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
				<img src="/images/icon.jpg">
			</div>
			<div class="info flex flex-col justify-between">
				<div class="author flex items-center">
					<span class="name text-default-text-color text-lg font-semibold">sky123</span>
					
				</div>
				<div class="meta-info">
					<div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2025-11-13 00:34:50</span>
        <span class="mobile">2025-11-13 00:34:50</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2025-11-10 01:28:46</span>
            <span class="mobile">2025-11-10 01:28:46</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/web/">web</a>&nbsp;
                        </li>
                    
                    
                
                    
                        
                            <li>></li>
                        
                        <li>
                            <a href="/categories/web/java-web/">java web</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java-web/">java web</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>24k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>108 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

				</div>
			</div>
		</div>
		

		


		<div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
			<p><strong>Apache Shiro</strong> 是一个通用的 Java 安全框架，负责四件事：<strong>身份认证（Authentication）</strong>、<strong>访问控制&#x2F;授权（Authorization）</strong>、<strong>会话管理（Session Management）</strong>、<strong>加解密（Cryptography）</strong>。</p>
<blockquote>
<ul>
<li><strong>Authentication 身份认证</strong>：确认“你是谁”。用到下面三个信息：<ul>
<li><strong>Subject</strong>：主体&#x2F;当事人。发起操作的人或程序线程。</li>
<li><strong>Principal</strong>：身份标识，要求<strong>唯一</strong>（如用户名&#x2F;手机号&#x2F;邮箱&#x2F;用户ID）。</li>
<li><strong>Credential</strong>：凭证，用来证明你是这个身份（如密码、TOTP、证书）。</li>
</ul>
</li>
<li><strong>Authorization 访问控制</strong>：确认“你能做什么”。三要素：<ul>
<li><strong>who</strong>（谁）→ user&#x2F;subject，当前操作人</li>
<li><strong>what</strong>（对什么）→ resource，被访问的资源（接口、菜单、记录等）</li>
<li><strong>how</strong>（怎么操作）→ permission（操作许可），通常也会通过 <strong>role（角色）</strong> 来打包一组权限<ul>
<li><strong>permission</strong>：最小粒度的操作许可（Shiro 常用<strong>通配权限</strong>模型）</li>
<li><strong>role</strong>：角色（权限的<strong>集合</strong>，如 <code>admin</code>、<code>editor</code>）</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>它既能用于 Web（拦截请求、登录、鉴权），也能用于非 Web 程序（命令行工具、后台任务），因为它不依赖 Servlet 容器自带的 Session。</p>
<h1 id="Shiro-关键组件"><a href="#Shiro-关键组件" class="headerlink" title="Shiro 关键组件"></a>Shiro 关键组件</h1><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2025/11/13/Java%20Shiro/images/ShiroArchitecture.png"
                      alt="Apache Shiro Architecture"
                ></p>
<h2 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h2><p>代表“当前主体”。你在业务代码里几乎只和它打交道：</p>
<ul>
<li><code>Subject.login(token)</code>：登录</li>
<li><code>Subject.isAuthenticated()</code>：是否已认证</li>
<li><code>Subject.hasRole(&quot;admin&quot;)</code> &#x2F; <code>checkRole(...)</code>：角色判断</li>
<li><code>Subject.isPermitted(&quot;doc:read:123&quot;)</code> &#x2F; <code>checkPermission(...)</code>：权限判断</li>
<li><code>Subject.getPrincipal()</code>：取出当前用户标识</li>
<li><code>Subject.getSession()</code>：拿会话（无论是否 Web）</li>
</ul>
<h2 id="SecurityManager（安全管理器）"><a href="#SecurityManager（安全管理器）" class="headerlink" title="SecurityManager（安全管理器）"></a>SecurityManager（安全管理器）</h2><p><strong>Shiro 的核心枢纽</strong>，把具体工作分派给下属模块：Authenticator &#x2F; Authorizer &#x2F; SessionManager &#x2F; …<br>在 Spring 环境中，它往往是一个单例 Bean（<code>DefaultSecurityManager</code> 或 <code>DefaultWebSecurityManager</code>）。</p>
<h3 id="Authenticator（认证器）"><a href="#Authenticator（认证器）" class="headerlink" title="Authenticator（认证器）"></a>Authenticator（认证器）</h3><p>负责调用<strong>一个或多个 Realm</strong> 完成认证。多 Realm 时可配置策略：</p>
<ul>
<li><code>AtLeastOneSuccessfulStrategy</code>（默认，有一个成功即可）</li>
<li><code>FirstSuccessfulStrategy</code>（第一个成功的为准）</li>
<li><code>AllSuccessfulStrategy</code>（全部成功才算通过）</li>
</ul>
<h3 id="Authorizer（授权器）"><a href="#Authorizer（授权器）" class="headerlink" title="Authorizer（授权器）"></a>Authorizer（授权器）</h3><p>根据角色&#x2F;权限判定是否允许访问。默认实现基于 <strong>WildcardPermission</strong> 处理你定义的通配权限字符串。</p>
<h3 id="Realm（数据源-认证-授权实现）"><a href="#Realm（数据源-认证-授权实现）" class="headerlink" title="Realm（数据源 + 认证&#x2F;授权实现）"></a>Realm（数据源 + 认证&#x2F;授权实现）</h3><p>Realm 是“桥”，把你的<strong>存储系统</strong>（数据库&#x2F;LDAP&#x2F;远程服务）里的用户、角色、权限数据提供给 Shiro。<br>典型做法：自定义一个 <code>AuthorizingRealm</code>，重写两件事：</p>
<ul>
<li><code>doGetAuthenticationInfo(token)</code>：根据用户名查出<strong>哈希后的密码 + 盐</strong>，返回 <code>AuthenticationInfo</code>。</li>
<li><code>doGetAuthorizationInfo(principals)</code>：查出该用户的角色与权限，封装 <code>AuthorizationInfo</code>。</li>
</ul>
<blockquote>
<p><strong>CredentialsMatcher</strong>：口令校验器。常用 <code>HashedCredentialsMatcher</code> 做 SHA-256&#x2F;SHA-512 + 盐 + 多轮迭代。若需 bcrypt&#x2F;argon2，可自定义或用社区扩展。</p>
</blockquote>
<h3 id="SessionManager-SessionDAO"><a href="#SessionManager-SessionDAO" class="headerlink" title="SessionManager &#x2F; SessionDAO"></a>SessionManager &#x2F; SessionDAO</h3><p>Shiro 自带一套<strong>与 Servlet 无关</strong>的会话管理：</p>
<ul>
<li><strong>SessionManager</strong>：控制会话生命周期&#x2F;超时。</li>
<li><strong>SessionDAO</strong>：会话存储抽象。可落到内存、数据库、Redis 等（需要相应实现，如社区常用 shiro-redis）。</li>
</ul>
<p>常见实现：</p>
<ul>
<li><code>DefaultWebSessionManager</code>：Web 环境下的原生 Shiro 会话（Cookie 名常见 <code>JSESSIONID</code> 或自定义）。</li>
<li><code>ServletContainerSessionManager</code>：直接复用容器会话。</li>
<li>可以添加 <code>SessionListener</code> 监听创建&#x2F;停用事件。</li>
</ul>
<h3 id="CacheManager（缓存）"><a href="#CacheManager（缓存）" class="headerlink" title="CacheManager（缓存）"></a>CacheManager（缓存）</h3><p>给<strong>授权信息&#x2F;会话</strong>等做缓存，减少数据库压力。常见：</p>
<ul>
<li>Ehcache、Caffeine、本地 Map 或 Redis 集成</li>
<li>典型用法：<strong>授权信息缓存</strong>（<code>AuthorizationInfo</code>）能明显减少“每次鉴权都查库”的开销</li>
</ul>
<h2 id="Cryptography（密码学工具）"><a href="#Cryptography（密码学工具）" class="headerlink" title="Cryptography（密码学工具）"></a>Cryptography（密码学工具）</h2><p>Shiro 提供常用组件：</p>
<ul>
<li><code>SimpleHash</code>、<code>DefaultPasswordService</code> 等散列&#x2F;密码服务</li>
<li><code>AesCipherService</code> 等对称加解密</li>
<li><code>SecureRandomNumberGenerator</code> 生成随机盐</li>
</ul>
<p>用途：<strong>安全存储密码、签发&#x2F;校验 RememberMe Cookie、对敏感数据做加解密</strong>。</p>
<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h2 id="数据源与-Realm"><a href="#数据源与-Realm" class="headerlink" title="数据源与 Realm"></a>数据源与 Realm</h2><p>Shiro 不关心你的用户存在哪（内存、JDBC、Redis、LDAP……），它只跟 Realm 打交道。Realm 就是 Shiro 的“<strong>数据源适配器</strong> + 认证&#x2F;授权规则执行者”。</p>
<ul>
<li>认证时：它替你<strong>去数据源查账号</strong>（DB&#x2F;Redis&#x2F;LDAP&#x2F;INI&#x2F;自写服务），拿回<strong>口令散列+盐</strong>、账户状态等，让 Shiro 比对登录口令。</li>
<li>授权时：它替你<strong>查角色&#x2F;权限</strong>并回传给 Shiro，用来 <code>hasRole()</code> &#x2F; <code>isPermitted()</code>。</li>
</ul>
<p>我们可以自定义Realm，最常见做法：自定义一个继承 <code>AuthorizingRealm</code> 的类，重写两个方法：</p>
<ul>
<li><code>doGetAuthenticationInfo(...)</code> → 登陆时调用；</li>
<li><code>doGetAuthorizationInfo(...)</code> → 首次做角色&#x2F;权限判断时调用并缓存。</li>
</ul>
<h3 id="“数据源”与实体"><a href="#“数据源”与实体" class="headerlink" title="“数据源”与实体"></a>“数据源”与实体</h3><p>首先先定义实体与“数据源”接口（可换成 JDBC&#x2F;ORM）：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String username;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String passwordHash; <span class="comment">// 存散列</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String salt;         <span class="comment">// 存随机盐</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> locked;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String u, String h, String s, <span class="type">boolean</span> locked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = u; <span class="built_in">this</span>.passwordHash = h; <span class="built_in">this</span>.salt = s; <span class="built_in">this</span>.locked = locked;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserService.java（演示：内存模拟，换成 JDBC 也行）</span></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 假装是数据库：用户名 -&gt; User</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, User&gt; table = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(User u)</span> &#123; table.put(u.username, u); &#125;</span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findByUsername</span><span class="params">(String u)</span> &#123; <span class="keyword">return</span> table.get(u); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角色、权限（真实项目你会从表里查）</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">rolesOf</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(username)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;op&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Collections.singletonList(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Set&lt;String&gt; <span class="title function_">permsOf</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span>.equals(username)) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;doc:read&quot;</span>, <span class="string">&quot;doc:write&quot;</span>, <span class="string">&quot;user:*&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Collections.singletonList(<span class="string">&quot;doc:read&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="自定义-Realm"><a href="#自定义-Realm" class="headerlink" title="自定义 Realm"></a>自定义 Realm</h3><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyRealm.java</span></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyRealm</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">        <span class="comment">// 配置口令校验（SHA-256 + 1024 次迭代，十六进制存储）</span></span><br><span class="line">        <span class="type">HashedCredentialsMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">        matcher.setHashIterations(<span class="number">1024</span>);</span><br><span class="line">        matcher.setStoredCredentialsHexEncoded(<span class="literal">true</span>);</span><br><span class="line">        setCredentialsMatcher(matcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 授权：给角色/权限</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) principals.getPrimaryPrincipal();</span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        info.setRoles(userService.rolesOf(username));</span><br><span class="line">        info.setStringPermissions(userService.permsOf(username));</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 认证：取出散列、盐、状态</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">up</span> <span class="operator">=</span> (UsernamePasswordToken) token;</span><br><span class="line">        <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> userService.findByUsername(up.getUsername());</span><br><span class="line">        <span class="keyword">if</span> (u == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>();</span><br><span class="line">        <span class="keyword">if</span> (u.locked) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LockedAccountException</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(</span><br><span class="line">                u.username,</span><br><span class="line">                u.passwordHash,</span><br><span class="line">                ByteSource.Util.bytes(u.salt),</span><br><span class="line">                getName()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Realm-使用"><a href="#Realm-使用" class="headerlink" title="Realm 使用"></a>Realm 使用</h3><p>我们可以通过下面的代码模拟 Shiro 的身份认证和访问控制过程：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// App.java</span></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.SecureRandomNumberGenerator;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.hash.SimpleHash;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.DefaultSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="comment">// 生成并“入库”（演示）</span></span><br><span class="line">    <span class="keyword">static</span> User <span class="title function_">createUser</span><span class="params">(String username, String plain)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">salt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecureRandomNumberGenerator</span>().nextBytes().toHex();</span><br><span class="line">        <span class="type">String</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleHash</span>(<span class="string">&quot;SHA-256&quot;</span>, plain, ByteSource.Util.bytes(salt), <span class="number">1024</span>).toHex();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(username, hash, salt, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// “建库”</span></span><br><span class="line">        <span class="type">UserService</span> <span class="variable">repo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserService</span>();</span><br><span class="line">        repo.save(createUser(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">        repo.save(createUser(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;hello&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 安装 SecurityManager</span></span><br><span class="line">        <span class="type">MyRealm</span> <span class="variable">realm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRealm</span>(repo);</span><br><span class="line">        <span class="type">DefaultSecurityManager</span> <span class="variable">sm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSecurityManager</span>(realm);</span><br><span class="line">        SecurityUtils.setSecurityManager(sm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 登录</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">            System.out.println(<span class="string">&quot;Login OK? &quot;</span> + subject.isAuthenticated()); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 访问控制</span></span><br><span class="line">            System.out.println(<span class="string">&quot;hasRole(admin)? &quot;</span> + subject.hasRole(<span class="string">&quot;admin&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;isPermitted(doc:write)? &quot;</span> + subject.isPermitted(<span class="string">&quot;doc:write&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 必要时强校验（失败抛异常）</span></span><br><span class="line">            subject.checkRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            subject.checkPermission(<span class="string">&quot;doc:read&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownAccountException | IncorrectCredentialsException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户名或口令错误&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LockedAccountException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;账户被锁定&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;其他认证失败: &quot;</span> + e.getClass().getSimpleName());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            subject.logout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><h3 id="使用自定义-Realm"><a href="#使用自定义-Realm" class="headerlink" title="使用自定义 Realm"></a>使用自定义 Realm</h3><p>Shiro 的认证核心是三件事：<code>Subject</code>（当前用户）、<code>SecurityManager</code>（安全总管）、<code>Realm</code>（拿你的用户&#x2F;密码&#x2F;角色&#x2F;权限数据）。基本流程是：</p>
<ol>
<li><p><strong>提供 Realm</strong>（你实现或内置），它负责“查出正确答案”（口令散列&#x2F;盐、账户状态）。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MyRealm</span> <span class="variable">realm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRealm</span>(repo);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>准备 SecurityManager</strong> → 绑定到 <code>SecurityUtils</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DefaultSecurityManager</span> <span class="variable">sm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSecurityManager</span>(realm);</span><br><span class="line">SecurityUtils.setSecurityManager(sm);</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><code>SecurityUtils</code> 里获取 <code>Subject</code> → <code>subject.login(new UsernamePasswordToken(u,p))</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"><span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">subject.login(token);</span><br></pre></td></tr></table></figure></div></li>
</ol>
<h3 id="使用内置-Realm"><a href="#使用内置-Realm" class="headerlink" title="使用内置 Realm"></a>使用内置 Realm</h3><p>不用自定义 Realm 时，可直接用 <code>IniRealm</code>：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.config.IniSecurityManagerFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.Factory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> <span class="title class_">IniSecurityManagerFactory</span>(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> factory.getInstance();</span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token); <span class="comment">// 成功：无返回；失败：抛异常</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Login Success: &quot;</span> + subject.isAuthenticated());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Login Failure: &quot;</span> + e.getClass().getSimpleName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>resources/shiro.ini</code> 中存放明文口令：</p>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">admin</span> = password123, adminRole</span><br><span class="line"><span class="attr">alice</span> = alicePwd, userRole</span><br><span class="line"><span class="attr">bob</span>   = secret, userRole</span><br><span class="line"></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="attr">adminRole</span> = *</span><br><span class="line"><span class="attr">userRole</span>  = doc:read,doc:write</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p>读取 <code>shiro.ini</code> 文件。如果其中有 <code>[users]</code> 段，<code>IniSecurityManagerFactory</code> 会创建一个 <strong>IniRealm</strong>（<code>org.apache.shiro.realm.text.IniRealm</code>），把 <code>[users]</code> 列表里的账号密码加载进内存；这就是“认证的数据来源”。</p>
</blockquote>
<h3 id="认证过程分析"><a href="#认证过程分析" class="headerlink" title="认证过程分析"></a>认证过程分析</h3><p>认证过程调用栈如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">at MyRealm.doGetAuthenticationInfo(MyRealm.java:34)</span><br><span class="line">at org.apache.shiro.realm.AuthenticatingRealm.getAuthenticationInfo(AuthenticatingRealm.java:568)</span><br><span class="line">at org.apache.shiro.authc.pam.ModularRealmAuthenticator.doSingleRealmAuthentication(ModularRealmAuthenticator.java:180)</span><br><span class="line">at org.apache.shiro.authc.pam.ModularRealmAuthenticator.doAuthenticate(ModularRealmAuthenticator.java:267)</span><br><span class="line">at org.apache.shiro.authc.AbstractAuthenticator.authenticate(AbstractAuthenticator.java:198)</span><br><span class="line">at org.apache.shiro.mgt.AuthenticatingSecurityManager.authenticate(AuthenticatingSecurityManager.java:106)</span><br><span class="line">at org.apache.shiro.mgt.DefaultSecurityManager.login(DefaultSecurityManager.java:270)</span><br><span class="line">at org.apache.shiro.subject.support.DelegatingSubject.login(DelegatingSubject.java:256)</span><br></pre></td></tr></table></figure></div>

<p><code>org.apache.shiro.authc.pam.ModularRealmAuthenticator#doAuthenticate</code> 判断是单个数据源还是多个数据源。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    assertRealmsConfigured();</span><br><span class="line">    Collection&lt;Realm&gt; realms = getRealms();</span><br><span class="line">    <span class="keyword">if</span> (realms.size() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> doSingleRealmAuthentication(realms.iterator().next(), authenticationToken);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> doMultiRealmAuthentication(realms, authenticationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>无论是哪一种，最后都会调用 <code>org.apache.shiro.realm.AuthenticatingRealm#getAuthenticationInfo</code> 进行认证。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现流程说明：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;首先尝试从缓存中获取与给定 &#123;<span class="doctag">@link</span> AuthenticationToken&#125; 对应的</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@link</span> AuthenticationInfo&#125;。如果命中，将直接使用该信息进行凭据匹配，</span></span><br><span class="line"><span class="comment"> *       从而避免访问后端数据源。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;若缓存未命中，则委托调用</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@link</span> #doGetAuthenticationInfo(org.apache.shiro.authc.AuthenticationToken)&#125;</span></span><br><span class="line"><span class="comment"> *       执行实际查找；若启用了认证信息缓存且允许缓存，则会调用</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@link</span> #cacheAuthenticationInfoIfPossible(org.apache.shiro.authc.AuthenticationToken, org.apache.shiro.authc.AuthenticationInfo)&#125;</span></span><br><span class="line"><span class="comment"> *       将查到的结果写入缓存，以便后续复用。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;如果无论缓存还是查找都未得到 AuthenticationInfo，则返回 &#123;<span class="doctag">@code</span> null&#125;，</span></span><br><span class="line"><span class="comment"> *       表示找不到该账户。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;一旦获得 AuthenticationInfo（无论来自缓存还是查找），将使用</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@link</span> #getCredentialsMatcher() credentialsMatcher&#125; 对提交的</span></span><br><span class="line"><span class="comment"> *       AuthenticationToken 中的凭据与期望凭据进行匹配校验。也就是说，</span></span><br><span class="line"><span class="comment"> *       每次认证尝试都会进行凭据校验。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token 提交的账户标识与凭据（例如用户名/口令等）。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 与给定 &#123;<span class="doctag">@code</span> token&#125; 对应的 AuthenticationInfo；若未找到则返回 &#123;<span class="doctag">@code</span> null&#125;。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> AuthenticationException 当认证失败（例如凭据不匹配、账户状态异常等）时抛出。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> AuthenticationInfo <span class="title function_">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) 优先从认证信息缓存中获取（例如 Ehcache/Redis 等实现）</span></span><br><span class="line">    <span class="type">AuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> getCachedAuthenticationInfo(token);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 2) 缓存未命中：执行实际的数据源查找（由具体 Realm 的 doGetAuthenticationInfo 实现）</span></span><br><span class="line">        info = doGetAuthenticationInfo(token);</span><br><span class="line">        log.debug(<span class="string">&quot;Looked up AuthenticationInfo [&#123;&#125;] from doGetAuthenticationInfo&quot;</span>, info);</span><br><span class="line">        <span class="keyword">if</span> (token != <span class="literal">null</span> &amp;&amp; info != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 3) 若启用并允许缓存，则将查到的认证信息写入缓存，便于后续快速命中</span></span><br><span class="line">            cacheAuthenticationInfoIfPossible(token, info);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 缓存命中：直接复用缓存的认证信息进行后续凭据匹配</span></span><br><span class="line">        log.debug(<span class="string">&quot;Using cached authentication info [&#123;&#125;] to perform credentials matching.&quot;</span>, info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 4) 无论来源（缓存/查找），只要拿到了 AuthenticationInfo，就执行凭据匹配校验</span></span><br><span class="line">        <span class="comment">//    实际匹配逻辑由 CredentialsMatcher（如 HashedCredentialsMatcher）完成</span></span><br><span class="line">        assertCredentialsMatch(token, info);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 未找到账户：返回 null（上层通常会据此抛 UnknownAccountException 等）</span></span><br><span class="line">        log.debug(<span class="string">&quot;No AuthenticationInfo found for submitted AuthenticationToken [&#123;&#125;].  Returning null.&quot;</span>, token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>doGetAuthenticationInfo</code> 返回的 <code>SimpleAuthenticationInfo</code> 中存储着根据用户登录信息查询到的经过哈希的凭据。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构造函数：接收账户的“主身份（primary principal）”、其对应的已散列凭据（hashed credentials），</span></span><br><span class="line"><span class="comment"> * 用于散列的盐（salt），以及与该身份关联的 Realm 名称。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 这是一个便捷构造器：会基于传入的 &#123;<span class="doctag">@code</span> principal&#125; 与 &#123;<span class="doctag">@code</span> realmName&#125;</span></span><br><span class="line"><span class="comment"> * 自动构造 &#123;<span class="doctag">@link</span> PrincipalCollection&#125; 实例。</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 注意：</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;&#123;<span class="doctag">@code</span> hashedCredentials&#125; 必须是“已散列后的凭据”（非明文），常见为十六进制或 Base64 编码的散列值；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;&#123;<span class="doctag">@code</span> credentialsSalt&#125; 为散列时使用的盐值（&#123;<span class="doctag">@link</span> ByteSource&#125;），应与注册/入库时使用的盐一致；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;与 &#123;<span class="doctag">@link</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher HashedCredentialsMatcher&#125;</span></span><br><span class="line"><span class="comment"> *       配合使用时，需确保算法、迭代次数、编码方式与存储策略一致。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> principal         与指定 Realm 关联的“主身份”对象（例如用户名、用户ID等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> hashedCredentials 用于校验该身份的“已散列凭据”（非明文；通常为 hex 或 Base64 字符串，也可为字节数组）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> credentialsSalt   计算 &#123;<span class="doctag">@code</span> hashedCredentials&#125; 时使用的盐（&#123;<span class="doctag">@link</span> ByteSource&#125;）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> realmName         该 principal 与凭据来源的 Realm 名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SimpleAuthenticationInfo</span><span class="params">(Object principal,</span></span><br><span class="line"><span class="params">                                Object hashedCredentials,</span></span><br><span class="line"><span class="params">                                ByteSource credentialsSalt,</span></span><br><span class="line"><span class="params">                                String realmName)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.principals = <span class="keyword">new</span> <span class="title class_">SimplePrincipalCollection</span>(principal, realmName);</span><br><span class="line">    <span class="built_in">this</span>.credentials = hashedCredentials;</span><br><span class="line">    <span class="built_in">this</span>.credentialsSalt = credentialsSalt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>assertCredentialsMatch</code> 完成用户登录信息 <code>AuthenticationToken</code> 与根据用户信息查询到的 <code>AuthenticationInfo</code> 直接的比较。实际上是调用 <code>CredentialsMatcher#doCredentialsMatch</code> 进行比较的，比较时会将用户登录信息哈希计算后再跟 <code>AuthenticationInfo</code> 中的经过哈希的凭据比较。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 断言提交的 &#123;<span class="doctag">@code</span> AuthenticationToken&#125; 中的凭据与账户已存储的</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@code</span> AuthenticationInfo&#125; 中的凭据相匹配；若不匹配则抛出 &#123;<span class="doctag">@link</span> AuthenticationException&#125;。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;实现要点：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;通过 &#123;<span class="doctag">@link</span> #getCredentialsMatcher()&#125; 获取当前配置的 &#123;<span class="doctag">@link</span> CredentialsMatcher&#125;；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;若已配置匹配器，则调用其 &#123;<span class="doctag">@link</span> CredentialsMatcher#doCredentialsMatch(AuthenticationToken, AuthenticationInfo)&#125;</span></span><br><span class="line"><span class="comment"> *       对提交凭据与存储凭据进行比对；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;比对失败时抛出 &#123;<span class="doctag">@link</span> IncorrectCredentialsException&#125;；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;若未配置任何匹配器，则抛出 &#123;<span class="doctag">@link</span> AuthenticationException&#125;，提示必须配置</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@code</span> CredentialsMatcher&#125;（若希望跳过校验，可使用 &#123;<span class="doctag">@link</span> AllowAllCredentialsMatcher&#125;）。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> token 提交的认证令牌（包含主体标识与原始凭据，如密码）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> info  与该 &#123;<span class="doctag">@code</span> token&#125; 对应的账户认证信息（通常包含散列后凭据与盐等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> AuthenticationException 当未配置匹配器或凭据不匹配时抛出；</span></span><br><span class="line"><span class="comment"> *                                 其中不匹配场景具体为 &#123;<span class="doctag">@link</span> IncorrectCredentialsException&#125;。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">assertCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="comment">// 取出当前配置的凭据匹配器（例如 HashedCredentialsMatcher）</span></span><br><span class="line">    <span class="type">CredentialsMatcher</span> <span class="variable">cm</span> <span class="operator">=</span> getCredentialsMatcher();</span><br><span class="line">    <span class="keyword">if</span> (cm != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用匹配器比对提交凭据与账户已存储凭据</span></span><br><span class="line">        <span class="keyword">if</span> (!cm.doCredentialsMatch(token, info)) &#123;</span><br><span class="line">            <span class="comment">// 比对失败 —— 抛出“凭据不正确”异常</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;Submitted credentials for token [&quot;</span> + token + <span class="string">&quot;] did not match the expected credentials.&quot;</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncorrectCredentialsException</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 未配置匹配器 —— 无法进行凭据校验，直接抛出异常并给出配置建议</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationException</span>(</span><br><span class="line">            <span class="string">&quot;A CredentialsMatcher must be configured in order to verify credentials during authentication. &quot;</span> +</span><br><span class="line">            <span class="string">&quot;If you do not wish for credentials to be examined, you can configure an &quot;</span> +</span><br><span class="line">            AllowAllCredentialsMatcher.class.getName() + <span class="string">&quot; instance.&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h2><p>Shiro 的授权核心是<strong>用户（Subject）→ 角色（Role）→ 权限（Permission）</strong>。</p>
<ul>
<li><strong>用户（Subject）</strong>当前正在与系统交互的用户主体。</li>
</ul>
<ul>
<li><strong>角色（Role）</strong> 更像“身份标签”，例如：<code>admin</code>、<code>user</code>、<code>manager</code> 等。</li>
<li><strong>权限（Permission）</strong> 是具体的“能做什么”操作，Shiro 推荐使用 <strong>WildcardPermission</strong> 表达。</li>
</ul>
<blockquote>
<p><strong>WildcardPermission</strong> 表达式规则为：<code>资源:动作:实例</code>，用逗号 <code>,</code> 表示并集，用 <code>*</code> 表示通配符。</p>
<p>例如：</p>
<ul>
<li><code>&quot;doc:read,write:*&quot;</code> 表示对所有文档实例都有读和写权限；</li>
<li><code>&quot;user:*&quot;</code> 表示对用户资源的所有操作权限。</li>
</ul>
</blockquote>
<h3 id="程序式授权（API-方式）"><a href="#程序式授权（API-方式）" class="headerlink" title="程序式授权（API 方式）"></a>程序式授权（API 方式）</h3><p>在现有的 <code>App.java</code> 中登录成功后，可以通过如下 API 实现访问控制：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 角色判断</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isAdmin</span> <span class="operator">=</span> subject.hasRole(<span class="string">&quot;admin&quot;</span>);              <span class="comment">// 单个</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">hasAll</span>  <span class="operator">=</span> subject.hasAllRoles(Arrays.asList(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;op&quot;</span>)); <span class="comment">// AND</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">any</span>     <span class="operator">=</span> subject.hasRole(<span class="string">&quot;admin&quot;</span>) || subject.hasRole(<span class="string">&quot;op&quot;</span>); <span class="comment">// OR（手写）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 权限判断（WildcardPermission 字符串）</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">canRead</span>  <span class="operator">=</span> subject.isPermitted(<span class="string">&quot;doc:read&quot;</span>);            <span class="comment">// 资源:动作</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">canWrite</span> <span class="operator">=</span> subject.isPermitted(<span class="string">&quot;doc:write&quot;</span>);           <span class="comment">// 资源:动作</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">canEditOwnDoc</span> <span class="operator">=</span> subject.isPermitted(<span class="string">&quot;doc:write:123&quot;</span>);  <span class="comment">// 到实例级</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制校验（不满足直接抛 AuthorizationException）</span></span><br><span class="line">subject.checkRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">subject.checkPermissions(<span class="string">&quot;doc:read&quot;</span>, <span class="string">&quot;doc:write&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>WildcardPermission 扩展规则</strong>：</p>
<ul>
<li><code>&quot;doc:read,write:123&quot;</code> 等同于同时具有 <code>doc:read:123</code> 和 <code>doc:write:123</code> 两个权限。</li>
<li>使用 <code>*</code> 表示“全部”资源或动作，例 <code>&quot;doc:*:*&quot;</code> 表示所有文档的全部权限。</li>
</ul>
</blockquote>
<h3 id="注解式授权（方法-控制器上）"><a href="#注解式授权（方法-控制器上）" class="headerlink" title="注解式授权（方法&#x2F;控制器上）"></a>注解式授权（方法&#x2F;控制器上）</h3><p>Shiro 提供一系列注解（<code>@RequiresAuthentication</code>, <code>@RequiresRoles</code>, <code>@RequiresPermissions</code> 等），配合 AOP，可直接在方法或控制器入口处声明权限：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiresAuthentication</span>                      <span class="comment">// 必须已登录（当前会话有效）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocumentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 角色 OR 权限 AND（默认语义）</span></span><br><span class="line">    <span class="meta">@RequiresRoles(value = &#123;&quot;admin&quot;, &quot;op&quot;&#125;, logical = Logical.OR)</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(&quot;doc:write&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDoc</span><span class="params">(String id, String content)</span> &#123;</span><br><span class="line">        <span class="comment">// 更新文档逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 权限 OR 判断（至少具备一种即可）</span></span><br><span class="line">    <span class="meta">@RequiresPermissions(value = &#123;&quot;doc:read&quot;, &quot;doc:preview&quot;&#125;, logical = Logical.OR)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">view</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="comment">// 查看文档逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<ul>
<li>在 Spring Boot 项目中，使用 <code>shiro-spring-boot-web-starter</code> 时，上述注解默认已启用，无需额外配置。</li>
<li>Jakarta EE 环境可引入 <code>shiro-jakarta-ee</code> 模块，使上述注解支持 CDI&#x2F;EJB。</li>
<li>注解中的 <code>@RequiresRoles</code> 和 <code>@RequiresPermissions</code> 默认采用 AND 语义；若需要 OR 语义，必须明确设置 <code>logical = Logical.OR</code>。</li>
</ul>
<h3 id="URL-级拦截（Filter-Chain）"><a href="#URL-级拦截（Filter-Chain）" class="headerlink" title="URL 级拦截（Filter Chain）"></a>URL 级拦截（Filter Chain）</h3><p>Web 应用可通过 <code>[urls]</code> 配置段（INI 文件）或 Java&#x2F;Spring 配置（如 <code>ShiroFilterChainDefinition</code> Bean）来定义 URL 与权限规则之间的关系：</p>
<h4 id="shiro-ini-配置示例"><a href="#shiro-ini-配置示例" class="headerlink" title="shiro.ini 配置示例"></a>shiro.ini 配置示例</h4><div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[urls]</span></span><br><span class="line"><span class="comment"># 静态资源与公开页面无需登录</span></span><br><span class="line">/assets/**     = anon</span><br><span class="line">/<span class="attr">login</span>         = anon</span><br><span class="line">/<span class="attr">logout</span>        = logout</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接口授权规则</span></span><br><span class="line">/api/docs/**   = authc, perms<span class="section">[&quot;doc:read&quot;]</span></span><br><span class="line">/api/admin/**  = authc, roles<span class="section">[admin]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有其他资源必须登录</span></span><br><span class="line">/**            = authc</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>URL 匹配规则说明：</strong></p>
<ul>
<li><p>URL 匹配采用“先声明先匹配（First Match Wins）”原则，更具体的规则应写在前面。</p>
</li>
<li><p>Shiro 内置的常用过滤器：</p>
<ul>
<li><code>anon</code>：匿名访问</li>
<li><code>authc</code>：认证后可访问（需要登录）</li>
<li><code>user</code>：登录或记住我后可访问</li>
<li><code>roles[...]</code>：需要特定角色（多个角色默认 AND 语义）</li>
<li><code>perms[...]</code>：需要特定权限（多个权限默认 AND 语义）</li>
<li><code>logout</code>：登出处理</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="Spring-Boot-下的配置"><a href="#Spring-Boot-下的配置" class="headerlink" title="Spring Boot 下的配置"></a>Spring Boot 下的配置</h4><p>在 Spring Boot 环境中，定义如下 Java 配置：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  ShiroFilterChainDefinition <span class="title function_">shiroFilterChainDefinition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">chain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultShiroFilterChainDefinition</span>();</span><br><span class="line">    chain.addPathDefinition(<span class="string">&quot;/assets/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    chain.addPathDefinition(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;logout&quot;</span>);</span><br><span class="line">    chain.addPathDefinition(<span class="string">&quot;/api/docs/**&quot;</span>, <span class="string">&quot;authc, perms[\&quot;doc:read\&quot;]&quot;</span>);</span><br><span class="line">    chain.addPathDefinition(<span class="string">&quot;/api/admin/**&quot;</span>, <span class="string">&quot;authc, roles[admin]&quot;</span>);</span><br><span class="line">    chain.addPathDefinition(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<ul>
<li>在使用 <code>shiro-spring-boot-web-starter</code> 的场景中，必须至少提供一个 <code>ShiroFilterChainDefinition</code> Bean 来定义 URL 拦截规则。</li>
<li>此 Bean 可与其他 Shiro 组件（如 Realm、SessionManager、SecurityManager）共同定义在同一个 <code>ShiroConfig</code> 类中。</li>
</ul>
</blockquote>
<h2 id="集成到-Java-Web-项目"><a href="#集成到-Java-Web-项目" class="headerlink" title="集成到 Java Web 项目"></a>集成到 Java Web 项目</h2><p><strong>“纯 Servlet 模式的 Shiro”和“Spring 集成下的 Shiro”</strong>在“入口、装配方式、配置来源、生命周期”上有明显差异，但<strong>核心机制（过滤器链 + 路径匹配 + SecurityManager）是同一套</strong>。</p>
<p>不管是 Servlet 还是 Spring，Shiro 都是：<strong>请求 → 按 URL 匹配链 → 顺序执行链上过滤器 → 交还原始链</strong>。URL 特定链、链内参数（如 <code>roles[admin]</code>）、以及“顺序即语义”这些原则完全一致。</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>纯 Servlet（web.xml&#x2F;INI）</th>
<th>Spring 集成（XML&#x2F;JavaConfig&#x2F;Boot）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>主入口（Master Filter）</strong></td>
<td>在 <code>web.xml</code> 里直接声明 <code>org.apache.shiro.web.servlet.ShiroFilter</code>（或更早的 <code>IniShiroFilter</code>）；通常配合 <code>EnvironmentLoaderListener</code> 启动 Shiro WebEnvironment。</td>
<td>在 <code>web.xml</code> 里用 <strong><code>DelegatingFilterProxy</code></strong> 映射到 Spring 容器中的 <strong><code>shiroFilter</code> Bean</strong>；真正的 Filter 由 <strong><code>ShiroFilterFactoryBean</code></strong> 组装返回。可选 <code>targetFilterLifecycle</code> 参数。</td>
</tr>
<tr>
<td><strong>配置来源</strong></td>
<td>多用 <code>shiro.ini</code>：<code>[main]</code> 里声明过滤器&#x2F;Realm&#x2F;安全管理器等，<code>[urls]</code> 里写 <strong>URL → 链定义</strong>。也可自定义 <code>WebEnvironment</code>。</td>
<td>用 Spring Bean 配置：<code>ShiroFilterFactoryBean</code> 接收 <code>securityManager</code>、<code>filters</code>（自定义 Filter Bean）和 <code>filterChainDefinitionMap</code>（<strong>URL → 链</strong>）。Spring Boot 用 starter 自动装配，仍然走这条链路。</td>
</tr>
<tr>
<td><strong>过滤器链的构建</strong></td>
<td>INI 由 <code>Ini*</code> 工厂读取并构造 <code>FilterChainResolver/Manager</code>；路径规则与链定义在 INI 中。</td>
<td><code>ShiroFilterFactoryBean#createInstance()</code> 内部创建 <code>DefaultFilterChainManager</code>：注册内置 + 自定义过滤器、应用全局属性、解析 <code>filterChainDefinitionMap</code> 逐条 <code>createChain(...)</code>。</td>
</tr>
<tr>
<td><strong>全局过滤器（global filters）</strong></td>
<td>自 <strong>1.6+</strong> 支持全局过滤器，默认包含 <code>invalidRequest</code>；会作用于<strong>所有路径</strong>（包括未配置的路径）。可在 INI 或环境中定制&#x2F;关闭。</td>
<td>同样支持；在 Spring 集成里，<code>ShiroFilterFactoryBean</code> 会把全局过滤器名称下发到 <code>FilterChainManager</code>，创建链时会<strong>先追加全局过滤器</strong>再追加该 URL 的链。</td>
</tr>
<tr>
<td><strong>生命周期与初始化</strong></td>
<td>容器直接管理 <code>Filter#init/destroy</code>；<code>EnvironmentLoaderListener</code> 初始化并放置 <code>WebEnvironment</code>（含 <code>SecurityManager</code>）到 <code>ServletContext</code>。</td>
<td><code>ShiroFilterFactoryBean</code> 负责<strong>装配</strong>但默认**不在此处调用自定义过滤器的 <code>init()</code>**（交给 Spring 生命周期）；主 Filter 以 Bean 形式被 <code>DelegatingFilterProxy</code> 代理。</td>
</tr>
<tr>
<td><strong>注解&#x2F;AOP</strong></td>
<td>可用，但需自己选择 AOP 技术（AspectJ&#x2F;Guice 等）。</td>
<td>与 Spring 配合天然顺手，启用 Shiro 的 Spring 拦截器&#x2F;Advisor 即可。</td>
</tr>
</tbody></table>
<h3 id="集成到-Servlet-容器"><a href="#集成到-Servlet-容器" class="headerlink" title="集成到 Servlet 容器"></a>集成到 Servlet 容器</h3><h4 id="web-xml-接入"><a href="#web-xml-接入" class="headerlink" title="web.xml 接入"></a><code>web.xml</code> 接入</h4><p>把 Shiro 的环境监听器与过滤器挂上去。放在 <code>WEB-INF/web.xml</code>：</p>
<div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="attr">version</span>=<span class="string">&quot;3.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 1) 加载 Shiro WebEnvironment（默认会找 classpath:/shiro.ini 或 /WEB-INF/shiro.ini） --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 可选：指定 ini 配置位置（多个以逗号分隔），不写则走默认查找规则 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>shiroConfigLocations<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:shiro.ini, /WEB-INF/shiro.ini<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 2) 所有请求交给 ShiroFilter 做 URL 级访问控制 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>INCLUDE<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>顺序要点：</strong>ShiroFilter 要在你应用里其他“需要被保护”的 Servlet&#x2F;Filter 前执行（通常放最前）。<br><strong>Jetty</strong> 与 <strong>Tomcat</strong> 一致，因为它们都遵守 <code>web.xml</code> 规范。</p>
<h4 id="shiro-ini-配置"><a href="#shiro-ini-配置" class="headerlink" title="shiro.ini 配置"></a><code>shiro.ini</code> 配置</h4><ul>
<li><code>[main]</code> 里放“对象图”和全局组件；</li>
<li><code>[urls]</code> 里放 URL 过滤链；</li>
<li>（可选的）<code>[users]/[roles]</code> 仅用于 <code>IniRealm</code> 快速演示。</li>
</ul>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="comment"># =========== Realm ===========</span></span><br><span class="line"><span class="comment"># 方案A：临时演示用（把用户/角色写在下面 [users]/[roles]）</span></span><br><span class="line"><span class="attr">iniRealm</span> = org.apache.shiro.realm.text.IniRealm</span><br><span class="line"><span class="comment"># 方案B：换成你的自定义 Realm（推荐生产）</span></span><br><span class="line"><span class="comment"># myRealm = com.example.security.MyRealm</span></span><br><span class="line"><span class="comment"># securityManager.realms = $myRealm</span></span><br><span class="line"><span class="attr">securityManager.realms</span> = <span class="variable">$iniRealm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== 缓存（可选） ===========</span></span><br><span class="line"><span class="attr">cacheManager</span> = org.apache.shiro.cache.ehcache.EhCacheManager</span><br><span class="line"><span class="attr">cacheManager.cacheManagerConfigFile</span> = classpath:ehcache-shiro.xml</span><br><span class="line"><span class="attr">securityManager.cacheManager</span> = <span class="variable">$cacheManager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== 会话管理 ===========</span></span><br><span class="line"><span class="comment"># 默认用 Shiro “原生”会话（非容器 HttpSession），可配置 Cookie/过期等</span></span><br><span class="line"><span class="attr">sessionManager</span> = org.apache.shiro.web.session.mgt.DefaultWebSessionManager</span><br><span class="line"><span class="comment"># 禁止 URL 追加 jsessionid，避免泄露</span></span><br><span class="line"><span class="attr">sessionManager.sessionIdUrlRewritingEnabled</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 使用 Cookie 传递会话标识</span></span><br><span class="line"><span class="attr">sessionIdCookie</span> = org.apache.shiro.web.servlet.SimpleCookie</span><br><span class="line"><span class="attr">sessionIdCookie.name</span> = JSESSIONID</span><br><span class="line"><span class="attr">sessionIdCookie.httpOnly</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">sessionIdCookie.path</span> = /</span><br><span class="line"><span class="attr">sessionManager.sessionIdCookie</span> = <span class="variable">$sessionIdCookie</span></span><br><span class="line"><span class="attr">securityManager.sessionManager</span> = <span class="variable">$sessionManager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如需直接复用容器 HttpSession（Tomcat/Jetty 自带会话），改为：</span></span><br><span class="line"><span class="comment"># servletSessionManager = org.apache.shiro.web.session.mgt.ServletContainerSessionManager</span></span><br><span class="line"><span class="comment"># securityManager.sessionManager = $servletSessionManager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== RememberMe（可选） ===========</span></span><br><span class="line"><span class="attr">rememberMeCookie</span> = org.apache.shiro.web.servlet.SimpleCookie</span><br><span class="line"><span class="attr">rememberMeCookie.name</span> = rememberMe</span><br><span class="line"><span class="attr">rememberMeCookie.httpOnly</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">rememberMeCookie.maxAge</span> = <span class="number">2592000</span>  <span class="comment"># 30 天</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rememberMeManager</span> = org.apache.shiro.web.mgt.CookieRememberMeManager</span><br><span class="line"><span class="attr">rememberMeManager.cookie</span> = <span class="variable">$rememberMeCookie</span></span><br><span class="line"><span class="comment"># 强烈建议：自定义密钥（在 Java 配置里设置 byte[] 更稳妥；ini 难写字节）</span></span><br><span class="line"><span class="comment"># rememberMeManager.cipherKey = &lt;自定义字节数组&gt; </span></span><br><span class="line"><span class="attr">securityManager.rememberMeManager</span> = <span class="variable">$rememberMeManager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== 常用内置过滤器属性 ===========</span></span><br><span class="line"><span class="attr">authc</span> = org.apache.shiro.web.filter.authc.FormAuthenticationFilter</span><br><span class="line"><span class="attr">authc.loginUrl</span> = /login</span><br><span class="line"><span class="comment"># 登录成功后默认跳转，可在代码里覆盖</span></span><br><span class="line"><span class="comment"># authc.successUrl = / </span></span><br><span class="line"><span class="attr">logout.redirectUrl</span> = /login</span><br><span class="line"></span><br><span class="line"><span class="comment"># 未授权时跳转/返回（配合前后端分离场景你可以自定义 JSON 版 Filter，见下文）</span></span><br><span class="line"><span class="attr">perms.unauthorizedUrl</span> = /<span class="number">403</span></span><br><span class="line"><span class="attr">roles.unauthorizedUrl</span> = /<span class="number">403</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =========== URL 过滤链 ===========</span></span><br><span class="line"><span class="section">[urls]</span></span><br><span class="line">/assets/**   = anon</span><br><span class="line">/<span class="attr">login</span>       = anon</span><br><span class="line">/<span class="attr">logout</span>      = logout</span><br><span class="line"></span><br><span class="line">/api/docs/** = authc, perms<span class="section">[&quot;doc:read&quot;]</span></span><br><span class="line">/api/admin/**= authc, roles<span class="section">[admin]</span></span><br><span class="line"></span><br><span class="line">/**          = authc</span><br><span class="line"></span><br><span class="line"><span class="comment"># （可选）内联的用户与角色，仅配合 iniRealm 快速试验</span></span><br><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">admin</span> = password123, admin</span><br><span class="line"><span class="attr">alice</span> = alicePwd, user</span><br><span class="line"></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="attr">admin</span> = *</span><br><span class="line"><span class="attr">user</span>  = doc:read</span><br></pre></td></tr></table></figure></div>

<h4 id="Servlet-中使用-Subject"><a href="#Servlet-中使用-Subject" class="headerlink" title="Servlet 中使用 Subject"></a>Servlet 中使用 Subject</h4><p>ShiroFilter 已经把当前请求与 <code>Subject</code> 绑定好，<strong>任意位置</strong>都可：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"></span><br><span class="line"><span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line"><span class="type">Object</span> <span class="variable">principal</span> <span class="operator">=</span> subject.getPrincipal();        <span class="comment">// 登录身份</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">isAdmin</span>  <span class="operator">=</span> subject.hasRole(<span class="string">&quot;admin&quot;</span>);      <span class="comment">// 角色判定</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">canRead</span>  <span class="operator">=</span> subject.isPermitted(<span class="string">&quot;doc:read&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<p>例如下面这段代码是自定义登录（自己处理表单 POST）：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">u</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">p</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">  <span class="type">Subject</span> <span class="variable">s</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    s.login(<span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(u, p));     <span class="comment">// 成功后 Shiro 建立会话</span></span><br><span class="line">    resp.sendRedirect(req.getContextPath() + <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">    resp.sendError(<span class="number">401</span>, <span class="string">&quot;login failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>除了在代码中自己实现登录逻辑，我们还可以<strong>把“登录这件事”完全交给 Shiro 自带的表单认证过滤器（<code>FormAuthenticationFilter</code>，简称 <code>authc</code>）来做</strong>：</p>
<div class="code-container" data-rel="Ini"><figure class="iseeu highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">authc</span> = org.apache.shiro.web.filter.authc.FormAuthenticationFilter</span><br><span class="line"><span class="attr">authc.loginUrl</span> = /login            <span class="comment"># 登录页路径（GET 会放行到你的页面/控制器）</span></span><br><span class="line"><span class="attr">authc.successUrl</span> = /               <span class="comment"># 没有 SavedRequest 时的登录成功跳转</span></span><br><span class="line"><span class="attr">authc.usernameParam</span> = username     <span class="comment"># 表单字段名可改</span></span><br><span class="line"><span class="attr">authc.passwordParam</span> = password</span><br><span class="line"><span class="attr">authc.rememberMeParam</span> = rememberMe</span><br><span class="line"></span><br><span class="line"><span class="section">[urls]</span></span><br><span class="line">/assets/** = anon</span><br><span class="line">/<span class="attr">logout</span>    = logout</span><br><span class="line">/<span class="attr">login</span>     = authc                 <span class="comment"># 关键：让 /login 由表单过滤器处理</span></span><br><span class="line">/**        = authc                 <span class="comment"># 其他都需要登录</span></span><br></pre></td></tr></table></figure></div>

<ul>
<li><p><code>authc</code> 就是 <code>FormAuthenticationFilter</code> 的别名。</p>
</li>
<li><p>在 <code>[urls]</code> 里写 <code>/login = authc</code> 后，所有访问 <code>/login</code> 的请求都会先经过这个过滤器。</p>
<ul>
<li><p><strong>GET &#x2F;login</strong>：过滤器判断“这是登录页访问”，<strong>放行</strong>给你的视图&#x2F;控制器去渲染页面（不拦）。</p>
</li>
<li><p><strong>POST &#x2F;login</strong>：过滤器从表单里取 <code>username</code> &#x2F; <code>password</code>（字段名可改），<strong>自动执行 <code>subject.login(...)</code></strong> 完成认证。</p>
<ul>
<li>成功：自动重定向到<strong>原先想去的地址</strong>（SavedRequest），如果没有，则跳到你配置的 <code>successUrl</code>（或默认根路径）。</li>
<li>失败：把异常类名放到 <code>request</code> 属性 <code>shiroLoginFailure</code>，并回到 <code>loginUrl</code>（让你在页面上提示错误）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>对应前端提交的 form 表单应该是下面这个形式：</p>
<div class="code-container" data-rel="Html"><figure class="iseeu highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/login&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;rememberMe&quot;</span>&gt;</span> Remember me<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>Login<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h3 id="集成到-Spring-项目"><a href="#集成到-Spring-项目" class="headerlink" title="集成到 Spring 项目"></a>集成到 Spring 项目</h3><p>简单示例：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ShiroDemo/</span><br><span class="line">├─ pom.xml</span><br><span class="line">├─ src/</span><br><span class="line">│  └─ main/</span><br><span class="line">│     ├─ java/</span><br><span class="line">│     │  └─ com/example/shirodemo/</span><br><span class="line">│     │     ├─ ShiroDemoApplication.java   # Spring Boot 启动类</span><br><span class="line">│     │     ├─ ShiroConfig.java            # Shiro 过滤器注册 + URL 过滤链（核心）</span><br><span class="line">│     │     ├─ DenyFilter.java             # 自定义拦截过滤器：固定 401</span><br><span class="line">│     │     └─ PingController.java         # 两个演示端点：/open/ping 与 /secure/ping</span><br><span class="line">│     └─ resources/</span><br><span class="line">│        └─ application.yml                # 应用配置（端口等）</span><br><span class="line">└─ README.txt</span><br></pre></td></tr></table></figure></div>

<p>效果：</p>
<div class="code-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:8080/open/ping   <span class="comment"># 200 &quot;open ok&quot;</span></span><br><span class="line">curl http://localhost:8080/secure/ping <span class="comment"># 401 &quot;Blocked by Shiro URL filter&quot;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="pom"><a href="#pom" class="headerlink" title="pom"></a>pom</h4><div class="code-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ShiroDemo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.7.18<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shiro.version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">shiro.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Shiro (JDK8, javax) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;shiro.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>ShiroDemo<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span><span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span><span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<h4 id="JavaConfig"><a href="#JavaConfig" class="headerlink" title="JavaConfig"></a>JavaConfig</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.shirodemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.DelegatingFilterProxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Shiro configured for URL filtering only: no login, no realms. */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// No realms: we do not authenticate in this lab.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean(name = &quot;deny&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DenyFilter <span class="title function_">denyFilter</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DenyFilter</span>(); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Main Shiro filter factory; bean name must be &#x27;shiroFilter&#x27;. */</span></span><br><span class="line">  <span class="meta">@Bean(name = &quot;shiroFilter&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager, DenyFilter deny)</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register custom filters</span></span><br><span class="line">    Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    filters.put(<span class="string">&quot;deny&quot;</span>, deny);</span><br><span class="line">    bean.setFilters(filters);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL chain — edit to test patterns and order</span></span><br><span class="line">    Map&lt;String, String&gt; chain = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    chain.put(<span class="string">&quot;/open/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);    <span class="comment">// allow</span></span><br><span class="line">    chain.put(<span class="string">&quot;/secure/**&quot;</span>, <span class="string">&quot;deny&quot;</span>);  <span class="comment">// always block (401)</span></span><br><span class="line">    chain.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);         <span class="comment">// fallback allow</span></span><br><span class="line">    bean.setFilterChainDefinitionMap(chain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Bridge Boot&#x27;s filter pipeline to the Shiro filter bean. */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> FilterRegistrationBean&lt;DelegatingFilterProxy&gt; <span class="title function_">shiroFilterRegistration</span><span class="params">()</span> &#123;</span><br><span class="line">    FilterRegistrationBean&lt;DelegatingFilterProxy&gt; reg = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">    <span class="type">DelegatingFilterProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegatingFilterProxy</span>(<span class="string">&quot;shiroFilter&quot;</span>);</span><br><span class="line">    proxy.setTargetFilterLifecycle(<span class="literal">true</span>);</span><br><span class="line">    reg.setFilter(proxy);</span><br><span class="line">    reg.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">    reg.setName(<span class="string">&quot;shiroFilter&quot;</span>);</span><br><span class="line">    reg.setOrder(Ordered.HIGHEST_PRECEDENCE + <span class="number">10</span>); <span class="comment">// early but after encoding/cors if any</span></span><br><span class="line">    <span class="keyword">return</span> reg;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>SecurityManager</code> 是 Shiro 最为核心的安全管理器，我们可以在其中设置 <code>Realm</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityManager <span class="title function_">securityManager</span><span class="params">(UserAuthorizingRealm userRealm)</span> &#123;</span><br><span class="line">    <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">    securityManager.setRealm(userRealm);</span><br><span class="line">    securityManager.setRememberMeManager(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.shirodemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.AccessControlFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Always deny and return 401 (no login involved). */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DenyFilter</span> <span class="keyword">extends</span> <span class="title class_">AccessControlFilter</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">r</span> <span class="operator">=</span> (HttpServletResponse) response;</span><br><span class="line">    r.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">    r.setContentType(<span class="string">&quot;text/plain;charset=UTF-8&quot;</span>);</span><br><span class="line">    r.getWriter().write(<span class="string">&quot;Blocked by Shiro URL filter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.shirodemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PingController</span> &#123;</span><br><span class="line">  <span class="meta">@GetMapping(&quot;/open/ping&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">open</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;open ok&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/secure/ping&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">secure</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;secure ok (should be blocked by Shiro)&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.shirodemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroDemoApplication</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    SpringApplication.run(ShiroDemoApplication.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>application.yml</code> 配置监听端口：</p>
<div class="code-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure></div>

<h4 id="控制器中使用"><a href="#控制器中使用" class="headerlink" title="控制器中使用"></a>控制器中使用</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresPermissions;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.annotation.RequiresRoles;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ApiController</span> &#123;</span><br><span class="line">  <span class="meta">@RequiresPermissions(&quot;doc:read&quot;)</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/docs/&#123;id&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">read</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> &#123; <span class="keyword">return</span> <span class="string">&quot;doc &quot;</span> + id; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequiresRoles(&quot;admin&quot;)</span></span><br><span class="line">  <span class="meta">@DeleteMapping(&quot;/admin/docs/&#123;id&#125;&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">del</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> &#123; <span class="keyword">return</span> <span class="string">&quot;deleted &quot;</span> + id; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageController</span> &#123;</span><br><span class="line">  <span class="meta">@GetMapping(&quot;/&quot;)</span> <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>; &#125; <span class="comment">// templates/index.html</span></span><br><span class="line">  <span class="meta">@GetMapping(&quot;/403&quot;)</span> <span class="keyword">public</span> String <span class="title function_">e403</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;403&quot;</span>; &#125; <span class="comment">// templates/403.html</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h1 id="Shiro-权限绕过"><a href="#Shiro-权限绕过" class="headerlink" title="Shiro 权限绕过"></a>Shiro 权限绕过</h1><p><a class="link"   target="_blank" rel="noopener" href="https://southsea.st/Study-Unauthorized-Shiro/" >https://southsea.st/Study-Unauthorized-Shiro/<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></p>
<table>
<thead>
<tr>
<th>CVE编号</th>
<th>漏洞说明</th>
<th>漏洞版本</th>
</tr>
</thead>
<tbody><tr>
<td>CVE-2016-6802</td>
<td>Context Path 路径标准化导致绕过</td>
<td>shrio &lt;1.3.2</td>
</tr>
<tr>
<td>CVE-2020-1957</td>
<td>Spring 与 Shiro 对于 “&#x2F;“ 和 “;” 处理差异导致绕过</td>
<td>Shiro &lt;&#x3D; 1.5.1</td>
</tr>
<tr>
<td>CVE-2020-11989</td>
<td>Shiro 二次解码导致的绕过以及 ContextPath 使用 “;” 的绕过</td>
<td>shiro &lt; 1.5.3</td>
</tr>
<tr>
<td>CVE-2020-13933</td>
<td>由于 Shiro 与 Spring 处理路径时 URL 解码和路径标准化顺序不一致 导致的使用 “%3b” 的绕过</td>
<td>shiro &lt; 1.6.0</td>
</tr>
<tr>
<td>CVE-2020-17510</td>
<td>由于 Shiro 与 Spring 处理路径时 URL 解码和路径标准化顺序不一致 导致的使用 “%2e” 的绕过</td>
<td>Shiro &lt; 1.7.0</td>
</tr>
<tr>
<td>CVE-2020-17523</td>
<td>Shiro 匹配鉴权路径时会对分隔的 token 进行 trim 操作 导致的使用 “%20” 的绕过</td>
<td>Shiro &lt;1.7.1</td>
</tr>
</tbody></table>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><h3 id="Servlet-路径规范"><a href="#Servlet-路径规范" class="headerlink" title="Servlet 路径规范"></a>Servlet 路径规范</h3><blockquote>
<p><strong>RequestURL &#x3D; scheme:&#x2F;&#x2F;host:port + RequestURI</strong><br><strong>RequestURI &#x3D; contextPath + servletPath + pathInfo</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>方法</th>
<th>定义</th>
<th>典型返回</th>
</tr>
</thead>
<tbody><tr>
<td><code>getContextPath()</code></td>
<td>Web 应用的<strong>上下文路径</strong>（以 <code>/</code> 开头），如果应用部署在<strong>根上下文</strong>，则返回<strong>空字符串</strong><code>&quot;&quot;</code>（不是 <code>/</code>）。</td>
<td><code>&quot;/demo&quot;</code> 或 <code>&quot;&quot;</code></td>
</tr>
<tr>
<td><code>getServletPath()</code></td>
<td><strong>匹配到当前 Servlet 映射的那一段路径</strong>（不含 host、端口、contextPath，也不含 pathInfo）。取决于映射类型：路径前缀 <code>/admin/*</code>、精确 <code>/admin/test</code>、扩展 <code>*.do</code>、默认 <code>/</code>。</td>
<td>例：<code>&quot;/admin&quot;</code>、<code>&quot;/admin/test&quot;</code>、<code>&quot;/login.do&quot;</code>、或 <code>&quot;&quot;</code>（映射 <code>/</code> 时）</td>
</tr>
<tr>
<td><code>getPathInfo()</code></td>
<td><strong>位于 servletPath 之后</strong>、在查询串之前的<strong>“额外路径”</strong>；如果没有额外部分，则返回 **<code>null</code>**。</td>
<td>例：<code>&quot;/test&quot;</code>、<code>null</code></td>
</tr>
<tr>
<td><code>getRequestURI()</code></td>
<td><strong>去掉协议&#x2F;主机&#x2F;端口</strong>后的完整请求路径（<strong>包含</strong> contextPath、servletPath、pathInfo），不含查询串。</td>
<td>例：<code>&quot;/demo/admin/test&quot;</code></td>
</tr>
<tr>
<td><code>getRequestURL()</code></td>
<td>完整 URL（协议 + 主机 + 端口 + <strong>RequestURI</strong>），不含查询串。返回值类型是 <code>StringBuffer</code>。</td>
<td>例：<code>&quot;http://localhost:9090/demo/admin/test&quot;</code></td>
</tr>
<tr>
<td><code>getQueryString()</code></td>
<td><code>?</code> 后面的查询参数字符串；没有则 <code>null</code>。</td>
<td>例：<code>&quot;q=1&amp;x=y&quot;</code> 或 <code>null</code></td>
</tr>
</tbody></table>

  <div class="note-large blue">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>提示</p>

    </div>
    <div class="notel-content markdown-body">
      <ul>
<li><code>getPathInfo()</code> 只有在<strong>前缀匹配</strong>（<code>/foo/*</code>）或<strong>默认匹配</strong>（<code>/</code>）且<strong>请求路径还有多出的那一截</strong>时才会返回非 <code>null</code>。</li>
<li><strong>精确匹配</strong>（<code>/foo</code>）和<strong>后缀匹配</strong>（<code>*.do</code>、<code>*.action</code>）下，<code>getPathInfo()</code> 一律返回 <code>null</code>。</li>
<li>对于前缀匹配，如果请求恰好是 <code>/foo</code>（无多余部分）则是 <code>null</code>；若是 <code>/foo/</code>（尾部多一个 <code>/</code>），在 Tomcat 等实现里常见返回 <code>&quot;/&quot;</code>。</li>
<li>Servlet 规范要求容器在提取 pathInfo 前对 URL 做规范化（canonicalize）。Tomcat 的 <code>HttpServletRequest</code> 文档也明确了这点。</li>
</ul>

    </div>
  </div>

<p><strong>示例：</strong>非根上下文 + 路径前缀映射</p>
<ul>
<li><strong>部署</strong>：应用上下文 <code>/demo</code></li>
<li><strong>Servlet 映射</strong>：<code>/admin/*</code></li>
<li><strong>请求</strong>：<code>http://localhost:9090/demo/admin/test?x=1</code></li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回</th>
</tr>
</thead>
<tbody><tr>
<td><code>getContextPath()</code></td>
<td><code>&quot;/demo&quot;</code></td>
</tr>
<tr>
<td><code>getServletPath()</code></td>
<td><code>&quot;/admin&quot;</code></td>
</tr>
<tr>
<td><code>getPathInfo()</code></td>
<td><code>&quot;/test&quot;</code></td>
</tr>
<tr>
<td><code>getRequestURI()</code></td>
<td><code>&quot;/demo/admin/test&quot;</code></td>
</tr>
<tr>
<td><code>getRequestURL()</code></td>
<td><code>&quot;http://localhost:9090/demo/admin/test&quot;</code></td>
</tr>
<tr>
<td><code>getQueryString()</code></td>
<td><code>&quot;x=1&quot;</code></td>
</tr>
</tbody></table>
<h3 id="Tomcat-的路径处理"><a href="#Tomcat-的路径处理" class="headerlink" title="Tomcat 的路径处理"></a>Tomcat 的路径处理</h3><p>Tomcat 的路径处理的核心逻辑位于 <code>org.apache.catalina.connector.CoyoteAdapter#postParseRequest</code> 函数，调用栈如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.catalina.connector.CoyoteAdapter.postParseRequest(CoyoteAdapter.java:567)</span><br><span class="line">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:341)</span><br><span class="line">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:617)</span><br><span class="line">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)</span><br><span class="line">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:934)</span><br><span class="line">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1690)</span><br><span class="line">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)</span><br><span class="line">at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)</span><br><span class="line">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure></div>

<p>其中核心处理逻辑如下（主要走的是 <code>undecodedURI.getType() == MessageBytes.T_BYTES</code> 分支）：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从请求对象中取得“已解码URI”的承载容器（MessageBytes 可在字节/字符之间切换）</span></span><br><span class="line"><span class="type">MessageBytes</span> <span class="variable">decodedURI</span> <span class="operator">=</span> req.decodedURI();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤 CONNECT 方法（常用于代理隧道）。此处不支持，直接返回 501 Not Implemented</span></span><br><span class="line"><span class="keyword">if</span> (req.method().equals(<span class="string">&quot;CONNECT&quot;</span>)) &#123;</span><br><span class="line">    response.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, sm.getString(<span class="string">&quot;coyoteAdapter.connect&quot;</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 非 CONNECT 请求才会处理具体的路径 URI</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 undecodedURI 以“字节数组”形式存在，意味着是未解码、未规范化的原始 URI</span></span><br><span class="line">    <span class="keyword">if</span> (undecodedURI.getType() == MessageBytes.T_BYTES) &#123;</span><br><span class="line">        <span class="comment">// 将原始 URI 复制到 decodedURI，后续在该容器上完成解码和规范化</span></span><br><span class="line">        decodedURI.duplicate(undecodedURI);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析并剔除路径参数（例如 /path;jsessionid=xxx 之类的分号参数）</span></span><br><span class="line">        parsePathParameters(req, request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// —— URI 解码流程 ——</span></span><br><span class="line">        <span class="comment">// 对 URL 执行 %xx 百分号解码（按字节级进行）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 第二个参数决定如何处理已编码的斜杠 %2F（由 connector 配置策略决定）</span></span><br><span class="line">            req.getURLDecoder().convert(decodedURI.getByteChunk(),</span><br><span class="line">                    connector.getEncodedSolidusHandlingInternal());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="comment">// 解码异常（如非法转义序列），返回 400，并附带错误信息</span></span><br><span class="line">            response.sendError(<span class="number">400</span>, sm.getString(<span class="string">&quot;coyoteAdapter.invalidURIWithMessage&quot;</span>, ioe.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// —— 规范化流程 ——</span></span><br><span class="line">        <span class="comment">// 对路径进行规范化（去除 /./、/../、重复斜杠等；非法则返回 400）</span></span><br><span class="line">        <span class="keyword">if</span> (normalize(req.decodedURI())) &#123;</span><br><span class="line">            <span class="comment">// 将字节级 URI 按请求字符集转换为字符（例如 UTF-8 字节 -&gt; Java char）</span></span><br><span class="line">            convertURI(decodedURI, request);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符转换后再次检查是否仍保持规范化（防止编码转换产生绕过）</span></span><br><span class="line">            <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</span><br><span class="line">                response.sendError(<span class="number">400</span>, <span class="string">&quot;Invalid URI&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 初次规范化失败，直接返回 400</span></span><br><span class="line">            response.sendError(<span class="number">400</span>, sm.getString(<span class="string">&quot;coyoteAdapter.invalidURI&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 若 URI 已是 chars 或 String，说明使用了内存协议处理器传递，</span></span><br><span class="line"><span class="comment">         * 默认约定：</span></span><br><span class="line"><span class="comment">         * - req.requestURI()：原始（未解码、未规范化）的 URI</span></span><br><span class="line"><span class="comment">         * - req.decodedURI()：对 requestURI 进行了解码且已规范化的结果</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 将 URI 表示切换为字符形式，后续以 CharChunk 操作</span></span><br><span class="line">        decodedURI.toChars();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除所有路径参数（以分号 ; 分隔的部分）</span></span><br><span class="line">        <span class="comment">// 按规范，真正需要的参数应通过 request 对象设置，而不是放在 URL 里</span></span><br><span class="line">        <span class="type">CharChunk</span> <span class="variable">uriCC</span> <span class="operator">=</span> decodedURI.getCharChunk();</span><br><span class="line">        <span class="type">int</span> <span class="variable">semicolon</span> <span class="operator">=</span> uriCC.indexOf(<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (semicolon &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 截断到分号前，去除 ; 及其后面的路径参数段</span></span><br><span class="line">            decodedURI.setChars(uriCC.getBuffer(), uriCC.getStart(), semicolon);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="解析路径参数"><a href="#解析路径参数" class="headerlink" title="解析路径参数"></a>解析路径参数</h4><div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从请求路径中提取形如 /path;name=value;name2=value2/... 的“路径参数”（path params）。</span></span><br><span class="line"><span class="comment"> * 实际上主要关心的是 JSESSIONID 这类参数，其他的可以忽略。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> req     Coyote 层的请求对象（底层协议解析）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request Servlet 层的请求对象（高层语义）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parsePathParameters</span><span class="params">(org.apache.coyote.Request req, Request request)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保使用“字节视图”处理（默认如此，因此通常是 NO-OP）</span></span><br><span class="line">    req.decodedURI().toBytes();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">uriBC</span> <span class="operator">=</span> req.decodedURI().getByteChunk();</span><br><span class="line">    <span class="comment">// 约定 URL 第一字符必须是 &#x27;/&#x27;，所以从位置 1 开始找分号。</span></span><br><span class="line">    <span class="comment">// 若第一个字符就是 &#x27;;&#x27;，规范化阶段会判定 URI 非法。</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">semicolon</span> <span class="operator">=</span> uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 性能优化：没有 &#x27;;&#x27; 直接返回，说明没有路径参数</span></span><br><span class="line">    <span class="keyword">if</span> (semicolon == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 显式指定用于把字节切片解码成字符串的编码（某些平台默认编码会异常，比如 z/OS）</span></span><br><span class="line">    <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> connector.getURICharset();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;uriBC&quot;</span>, uriBC.toString()));</span><br><span class="line">        log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;semicolon&quot;</span>, String.valueOf(semicolon)));</span><br><span class="line">        log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;enc&quot;</span>, charset.name()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 逐个剥离分号参数</span></span><br><span class="line">    <span class="keyword">while</span> (semicolon &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 记录当前有效范围</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriBC.getStart();</span><br><span class="line">        <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriBC.getEnd();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数起点在分号后</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pathParamStart</span> <span class="operator">=</span> semicolon + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数终点为下一个 &#x27;;&#x27; 或 &#x27;/&#x27;（遇到 &#x27;/&#x27; 说明本段路径结束）</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">pathParamEnd</span> <span class="operator">=</span></span><br><span class="line">                ByteChunk.findBytes(uriBC.getBuffer(), start + pathParamStart, end, <span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;/&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">pv</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 保存 &quot;name=value&quot; 文本</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pathParamEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 中间有分隔符（; 或 /）：把 [pathParamStart, pathParamEnd) 视作一个路径参数</span></span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="literal">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> <span class="title class_">String</span>(uriBC.getBuffer(), start + pathParamStart, pathParamEnd - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将该路径参数从 URI 中移除：把从 pathParamEnd 开始的后续字节整体左移到 semicolon 位置</span></span><br><span class="line">            <span class="type">byte</span>[] buf = uriBC.getBuffer();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; end - start - pathParamEnd; i++) &#123;</span><br><span class="line">                buf[start + semicolon + i] = buf[start + i + pathParamEnd];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 更新 ByteChunk 的有效范围：长度减少 (pathParamEnd - semicolon)</span></span><br><span class="line">            uriBC.setBytes(buf, start, end - start - pathParamEnd + semicolon);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 没有再遇到 &#x27;;&#x27; 或 &#x27;/&#x27;，说明这是末尾的最后一个参数（形如 &quot;;name=value&quot; 在末尾）</span></span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="literal">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> <span class="title class_">String</span>(uriBC.getBuffer(), start + pathParamStart, (end - start) - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 直接把有效区间截断到 semicolon（去掉末尾整个参数片段）</span></span><br><span class="line">            uriBC.setEnd(start + semicolon);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">            log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;pathParamStart&quot;</span>, String.valueOf(pathParamStart)));</span><br><span class="line">            log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;pathParamEnd&quot;</span>, String.valueOf(pathParamEnd)));</span><br><span class="line">            log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;pv&quot;</span>, pv));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解析 &quot;name=value&quot; 并写入 request 的“路径参数”表</span></span><br><span class="line">        <span class="keyword">if</span> (pv != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">equals</span> <span class="operator">=</span> pv.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (equals &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> pv.substring(<span class="number">0</span>, equals);</span><br><span class="line">                <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> pv.substring(equals + <span class="number">1</span>);</span><br><span class="line">                request.addPathParameter(name, value); <span class="comment">// 例如 name=jsessionid</span></span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;equals&quot;</span>, String.valueOf(equals)));</span><br><span class="line">                    log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;name&quot;</span>, name));</span><br><span class="line">                    log.trace(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;value&quot;</span>, value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没有 &#x27;=&#x27;（只写了 &quot;;foo&quot;），则按规范忽略之</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 继续寻找下一个 &#x27;;&#x27;</span></span><br><span class="line">        <span class="comment">// 注意：此时 ByteChunk 已被“左移+收缩”，这里从上一个 semicolon 位置继续搜，</span></span><br><span class="line">        <span class="comment">// 能覆盖连串 &quot;;a=b;c=d&quot; 的情况，不会跳漏，也不会死循环。</span></span><br><span class="line">        semicolon = uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, semicolon);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这段代码的主要逻辑是：</p>
<ul>
<li><strong>定位分号参数</strong>：从第 1 个字符后开始找 <code>;</code>（第 0 位应是 <code>/</code>）。没有就直接返回。</li>
<li>**按段取出 <code>name=value</code>**：每遇到一个 <code>;</code>，把后面到下一个 <code>;</code> 或下一个 <code>/</code> 之间的字节当作一个“路径参数”片段（典型是 <code>jsessionid</code>）。</li>
<li><strong>写入请求的路径参数表</strong>：如果是 <code>name=value</code> 形式，就存入 <code>request.addPathParameter(name, value)</code>，供后续（比如 URL 会话跟踪）使用。</li>
<li><strong>原地删掉分号参数</strong>：通过把后续字节<strong>左移</strong>，从 <code>req.decodedURI()</code> 的字节缓冲里把这段 <code>;name=value</code> 真正移除；如果这是最后一个参数，就把缓冲区<strong>截断</strong>到分号处。</li>
<li><strong>继续扫描</strong>：在“已左移”的缓冲上，从当前分号位置继续找下一个 <code>;</code>，直到没有为止。</li>
</ul>
<blockquote>
<p><strong>“路径参数”（path parameters）就是写在 URL 路径“段(segment)”里的分号分隔的键值对</strong>，长这样：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/books;lang=zh;edition=2/chapter;id=3</span><br><span class="line">          ^^^^^^^^^^^^        ^^^^^</span><br><span class="line">          这些都是路径参数（也叫 matrix 参数）</span><br></pre></td></tr></table></figure></div>

<p>它跟 <code>?</code> 后面的<strong>查询参数</strong>不一样：路径参数属于<strong>某个路径段本身</strong>；查询参数作用于<strong>整条 URL</strong>。</p>
<p><strong>早期标准 RFC 2396（已被废弃）</strong>明确给了语法：一个路径段可以跟随若干个以分号 <code>;</code> 引入的参数（<code>segment = *pchar *( &quot;;&quot; param )</code>），并举例说明“每个路径段都可以包含以 <code>;</code> 表示的一串参数”。这正是“路径参数&#x2F;矩阵参数”的来源。</p>
<p><strong>现行标准 RFC 3986</strong>取消了“路径参数”这个专门语法，但保留了<strong>分号 <code>;</code> 是保留字符(sub-delim)<strong>并允许出现在路径字符集中（<code>pchar</code> 包含 <code>sub-delims</code>，而 <code>sub-delims</code> 里有 <code>;</code>）。因此，</strong>语法层面依然允许 <code>;</code> 出现在路径段里</strong>，至于把它当“参数”来用，属于上层协议&#x2F;框架的约定。</p>
<p><strong>Servlet 规范（4.0 及以后）</strong>：当浏览器不收 cookie 时，容器可以用<strong>URL 重写</strong>把会话 ID 放进<strong>路径参数</strong>里，名字必须是 **<code>jsessionid</code>**，例如 <code>http://www.example.com/catalog/index.html;jsessionid=1234</code>。这也是 Tomcat 在你看到的 <code>parsePathParameters()</code> 里要把 <code>;jsessionid=...</code> 剥离并记录到 <code>request</code> 的原因。</p>
</blockquote>
<p>Tomcat 支持通过 URL 路径中的 <code>;jsessionid=...</code> 传递会话 ID（当 Cookie 不可用时）。这一步把它取出并记录，并把 <code>;...</code> 从真实路径里去掉，避免影响后续的<strong>百分号解码</strong>、<strong>规范化</strong>（处理 <code>.</code>&#x2F;<code>..</code>）和<strong>请求映射</strong>（Host&#x2F;Context&#x2F;Wrapper 匹配）。</p>
<p>例如：</p>
<ul>
<li><p>输入路径：<code>/app;jsessionid=ABC/dir;v=1/file;c=d?x=1</code></p>
<ul>
<li><strong>输出路径（用于后续映射）</strong>：<code>/app/dir/file</code></li>
<li><strong>路径参数表</strong>：<code>&#123; jsessionid: &quot;ABC&quot;, v: &quot;1&quot;, c: &quot;d&quot; &#125;</code></li>
<li><strong>查询串</strong> <code>?x=1</code> 不受影响（它本就不在这段逻辑处理范围内）。</li>
</ul>
</li>
<li><p>输入路径：<code>/foo/bar</code>（没有分号）→ 原样返回，零拷贝。</p>
</li>
</ul>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content markdown-body">
      <p>注意这是在<strong>百分号解码（%xx）之前</strong>做的：只识别<strong>字面量</strong> <code>;</code>。如果有人用 <code>%3B</code>（编码后的分号），这里不会当分号参数看待；后面解码成 <code>;</code> 时，它就只是普通字符了（不会再被当作路径参数）。</p>

    </div>
  </div>

<h4 id="URI-解码"><a href="#URI-解码" class="headerlink" title="URI 解码"></a>URI 解码</h4><p>解析路径参数之后会进行 URI 解码操作。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// —— URI 解码流程 ——</span></span><br><span class="line"><span class="comment">// 对 URL 执行 %xx 百分号解码（按字节级进行）</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 第二个参数决定如何处理已编码的斜杠 %2F（由 connector 配置策略决定）</span></span><br><span class="line">    req.getURLDecoder().convert(decodedURI.getByteChunk(),</span><br><span class="line">            connector.getEncodedSolidusHandlingInternal());</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    <span class="comment">// 解码异常（如非法转义序列），返回 400，并附带错误信息</span></span><br><span class="line">    response.sendError(<span class="number">400</span>, sm.getString(<span class="string">&quot;coyoteAdapter.invalidURIWithMessage&quot;</span>, ioe.getMessage()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<blockquote>
<p><strong>因为在 Servlet&#x2F;Java EE 的语义里，“谁来把原始请求行变成可用的 <em>应用路径</em>”属于应用容器的职责**。Tomcat 既是 HTTP 端点（Coyote 连接器），又是 Servlet 容器（Catalina）。无论前面有没有 Nginx&#x2F;Apache 反代，</strong>Tomcat 都必须自己做一次“可控、可配置、可审计”的 URI 解码与规范化**，以保证映射、安全校验、会话跟踪等行为一致可靠。</p>
<ul>
<li>不同前端（Apache httpd &#x2F; Nginx &#x2F; F5 &#x2F; CDN）对 <strong><code>%xx</code> 解码、编码斜杠 <code>%2F</code>、反斜杠 <code>\</code>、重复斜杠</strong> 等处理差异很大，甚至能配置成<strong>提前解码</strong>、<strong>部分解码</strong>或<strong>不解码</strong>。</li>
<li>如果把这事完全交给前端，Tomcat 收到的请求就可能在不同环境下行为不同 → <strong>应用不可移植</strong>、<strong>安全审计困难</strong>。</li>
</ul>
<p>Tomcat 在你看到的代码里做了三件关键安全动作（都绕不开自己解码）：</p>
<ol>
<li><p><strong>按自己的策略解码</strong>：<br><code>req.getURLDecoder().convert(..., encodedSolidusHandling)</code></p>
<ul>
<li>明确控制 <code>%2F</code>（编码的 <code>/</code>）是<strong>解码</strong>、<strong>拒绝</strong>还是<strong>透传</strong>；</li>
<li>拒绝非法 <code>%xx</code>、NUL 字节等。</li>
</ul>
</li>
<li><p><strong>路径规范化</strong>：<br>统一处理 <code>//</code>、<code>/./</code>、<code>/../</code>、反斜杠 <code>\</code> → <strong>防目录穿越与旁路</strong>。</p>
</li>
<li><p><strong>解码后再二次校验</strong>：<br><code>convertURI(...)</code> 把字节转字符后 **再 <code>checkNormalize()</code>**，防止“先解码后出现新危险片段”的绕过（典型 <strong>双重编码</strong> 技巧：<code>..%2f</code>、<code>%2e%2e%2f</code> 等）。</p>
</li>
</ol>
<p>若完全信任前端，最常见坑就是<strong>双重解码</strong>：前端解一次、容器再解一次，<code>/%252e%252e/</code> → <code>/%2e%2e/</code> → <code>/../</code>，把原本被挡住的路径“洗”成可穿越的形式。</p>
</blockquote>
<p>实际进行解码操作的 <code>org.apache.tomcat.util.buf.UDecoder#convert</code> 函数的具体过程如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * URL 解码（就地修改源缓冲）。按 RFC 7230，假定源字节集为 US-ASCII 的超集。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mb  待解码的字节切片（ByteChunk）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> encodedSolidusHandling  遇到 &quot;%2F&quot;（编码斜杠）时的处理策略：</span></span><br><span class="line"><span class="comment"> *        - DECODE：解码为 &#x27;/&#x27;（允许）</span></span><br><span class="line"><span class="comment"> *        - REJECT：直接拒绝抛错（更安全，防目录穿越类绕过）</span></span><br><span class="line"><span class="comment"> *        - PASS_THROUGH：不解码，原样保留为 &quot;%2F&quot;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 非法的 %xx 序列（不足两位、非十六进制等）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">convert</span><span class="params">(ByteChunk mb, EncodedSolidusHandling encodedSolidusHandling)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 路径解码场景：query=false（与查询串不同，路径中 &#x27;+&#x27; 不是空格）</span></span><br><span class="line">    convert(mb, <span class="literal">false</span>, encodedSolidusHandling);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">convert</span><span class="params">(ByteChunk mb, <span class="type">boolean</span> query, EncodedSolidusHandling encodedSolidusHandling)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> mb.getOffset();     <span class="comment">// 起始偏移（有效数据的起点）</span></span><br><span class="line">    <span class="type">byte</span>[] buff = mb.getBytes();    <span class="comment">// 底层字节数组（将被就地修改）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> mb.getEnd();          <span class="comment">// 有效数据的结束下标（开区间）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先各找一次 &#x27;%&#x27; 和（可选）&#x27;+&#x27; 的位置，若均不存在则无需处理</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> ByteChunk.findByte(buff, start, end, (<span class="type">byte</span>) <span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">idx2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (query) &#123;</span><br><span class="line">        <span class="comment">// 仅在查询串模式下，&#x27;+&#x27; 代表空格</span></span><br><span class="line">        idx2 = ByteChunk.findByte(buff, start, (idx &gt;= <span class="number">0</span> ? idx : end), (<span class="type">byte</span>) <span class="string">&#x27;+&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span> &amp;&amp; idx2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// 没有需要解码的字符</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取首个出现位置（&#x27;%&#x27; 或 &#x27;+&#x27; 的较小者）</span></span><br><span class="line">    <span class="keyword">if</span> ((idx2 &gt;= <span class="number">0</span> &amp;&amp; idx2 &lt; idx) || idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        idx = idx2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 就地解码：j 指向“读位置”，idx 指向“写位置”（可能小于 j，实现压缩）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> idx; j &lt; end; j++, idx++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (buff[j] == <span class="string">&#x27;+&#x27;</span> &amp;&amp; query) &#123;</span><br><span class="line">            <span class="comment">// 查询串：&#x27;+&#x27; =&gt; 空格</span></span><br><span class="line">            buff[idx] = (<span class="type">byte</span>) <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (buff[j] != <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// 普通字节：原样搬移</span></span><br><span class="line">            buff[idx] = buff[j];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 命中 &#x27;%&#x27;，需要读取紧随其后的两位十六进制</span></span><br><span class="line">            <span class="keyword">if</span> (j + <span class="number">2</span> &gt;= end) &#123;</span><br><span class="line">                <span class="keyword">throw</span> EXCEPTION_EOF; <span class="comment">// 不足两位，%xx 结尾非法</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b1</span> <span class="operator">=</span> buff[j + <span class="number">1</span>];</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b2</span> <span class="operator">=</span> buff[j + <span class="number">2</span>];</span><br><span class="line">            <span class="keyword">if</span> (!isHexDigit(b1) || !isHexDigit(b2)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> EXCEPTION_NOT_HEX_DIGIT; <span class="comment">// 非十六进制字符</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            j += <span class="number">2</span>;                  <span class="comment">// 前进越过两位十六进制</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> x2c(b1, b2);   <span class="comment">// 将两位十六进制转成一个字节值</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (res == <span class="string">&#x27;/&#x27;</span>) &#123;        <span class="comment">// 特判：编码斜杠 %2F</span></span><br><span class="line">                <span class="keyword">switch</span> (encodedSolidusHandling) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DECODE: &#123;</span><br><span class="line">                        <span class="comment">// 正常解码为 &#x27;/&#x27;</span></span><br><span class="line">                        buff[idx] = (<span class="type">byte</span>) res;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> REJECT: &#123;</span><br><span class="line">                        <span class="comment">// 直接拒绝（更安全，常用于路径解码防绕过）</span></span><br><span class="line">                        <span class="keyword">throw</span> EXCEPTION_SLASH;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> PASS_THROUGH: &#123;</span><br><span class="line">                        <span class="comment">// 原样保留 &quot;%2F&quot;：把 &#x27;%&#x27;,&#x27;b1&#x27;,&#x27;b2&#x27; 三字节写回输出</span></span><br><span class="line">                        buff[idx++] = buff[j - <span class="number">2</span>]; <span class="comment">// &#x27;%&#x27;</span></span><br><span class="line">                        buff[idx++] = buff[j - <span class="number">1</span>]; <span class="comment">// b1</span></span><br><span class="line">                        buff[idx]   = buff[j];     <span class="comment">// b2</span></span><br><span class="line">                        <span class="comment">// 注意：本轮末尾 for 循环的 idx++ 还会再执行一次</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 常规 %xx 解码</span></span><br><span class="line">                buff[idx] = (<span class="type">byte</span>) res;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写回新的“有效长度”，实现对 %xx 的压缩与（可选的）&#x27;+&#x27;-&gt;&#x27; &#x27; 替换</span></span><br><span class="line">    mb.setEnd(idx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="规范化"><a href="#规范化" class="headerlink" title="规范化"></a>规范化</h4><p>规范化阶段主要是<strong>把“已经做过一次 %xx 解码”的字节级路径，在原地规范成唯一、可比对、可映射且安全的形态</strong>，主要目的是挡住目录穿越&#x2F;混淆，给后续“路径→应用”映射一个稳定输入。该阶段的核心函数是 <code>normalize</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规范化 URL 路径，处理反斜杠 &quot;\&quot;、连续斜杠 &quot;//&quot;、当前目录 &quot;/./&quot;、父目录 &quot;/../&quot; 等。</span></span><br><span class="line"><span class="comment"> * 返回 false 表示出现越过根目录的情况或包含空字节（\0）；否则返回 true。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">normalize</span><span class="params">(MessageBytes uriMB)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">uriBC</span> <span class="operator">=</span> uriMB.getByteChunk();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] b = uriBC.getBytes();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriBC.getStart();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriBC.getEnd();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 空 URL 不合法</span></span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL 必须以 &#x27;/&#x27; 开头（或以 &#x27;\&#x27; 开头，稍后会被替换）</span></span><br><span class="line">    <span class="keyword">if</span> (b[start] != (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span> &amp;&amp; b[start] != (<span class="type">byte</span>) <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一遍扫描：将 &#x27;\&#x27; 统一替换为 &#x27;/&#x27;（若 ALLOW_BACKSLASH=false 则直接拒绝）</span></span><br><span class="line">    <span class="comment">// 同时检查是否包含 NUL 字节</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; end; pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ALLOW_BACKSLASH) &#123;</span><br><span class="line">                b[pos] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 不允许 Windows 风格分隔符</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 拒绝含 NUL 的路径</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 折叠重复斜杠：将多重 &quot;//&quot; 压缩为单个 &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; (end - <span class="number">1</span>); pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> ((pos + <span class="number">1</span> &lt; end) &amp;&amp; (b[pos + <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>)) &#123;</span><br><span class="line">                <span class="comment">// copyBytes(dst=pos, src=pos+1, len=end-pos-1) =&gt; 左移一字节</span></span><br><span class="line">                copyBytes(b, pos, pos + <span class="number">1</span>, end - pos - <span class="number">1</span>);</span><br><span class="line">                end--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若以 &quot;/.&quot; 或 &quot;/..&quot; 结尾，则在末尾补一个 &quot;/&quot;，方便下方用统一的 &quot;/./&quot;、&quot;/../&quot; 规则处理</span></span><br><span class="line">    <span class="comment">// 备注：这里假设缓冲区末尾有可写空间（Tomcat 的 ByteChunk 留有余量）</span></span><br><span class="line">    <span class="keyword">if</span> (((end - start) &gt;= <span class="number">2</span>) &amp;&amp; (b[end - <span class="number">1</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) || ((b[end - <span class="number">2</span>] == (<span class="type">byte</span>) <span class="string">&#x27;.&#x27;</span>) &amp;&amp; (b[end - <span class="number">3</span>] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>))) &#123;</span><br><span class="line">            b[end] = (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">            end++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uriBC.setEnd(end);</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析并移除所有 &quot;/./&quot; 片段（当前目录）</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/./&quot;</span>, <span class="number">0</span>, <span class="number">3</span>, index); <span class="comment">// 在 ByteChunk 内查找，从 index 处开始</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 把 &quot;/./&quot; 压缩为 &quot;/&quot;：拷贝起点在 &quot;/./&quot; 后的两个字节处</span></span><br><span class="line">        copyBytes(b, start + index, start + index + <span class="number">2</span>, end - start - index - <span class="number">2</span>);</span><br><span class="line">        end = end - <span class="number">2</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">        <span class="comment">// 继续从当前位置往后找</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析并折叠所有 &quot;/../&quot;（父目录）</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        index = uriBC.indexOf(<span class="string">&quot;/../&quot;</span>, <span class="number">0</span>, <span class="number">4</span>, index);</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若出现在最前面（形如 &quot;/../xxx&quot;），等价需要越过根目录，直接拒绝</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 回溯找到上一个 &#x27;/&#x27; 的位置 index2（即前一段目录的起点）</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index2</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (pos = start + index - <span class="number">1</span>; (pos &gt;= <span class="number">0</span>) &amp;&amp; (index2 &lt; <span class="number">0</span>); pos--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (b[pos] == (<span class="type">byte</span>) <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                index2 = pos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将 &quot;/前一段/../&quot; 整体删除：把 &quot;/../&quot; 之后的内容向左搬到 index2</span></span><br><span class="line">        copyBytes(b, start + index2, start + index + <span class="number">3</span>, end - start - index - <span class="number">3</span>);</span><br><span class="line">        end = end + index2 - index - <span class="number">3</span>;</span><br><span class="line">        uriBC.setEnd(end);</span><br><span class="line">        <span class="comment">// 继续从折叠后的上一个斜杠处往后处理（可能还会连锁触发）</span></span><br><span class="line">        index = index2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>具体逻辑为：</p>
<ol>
<li><p><strong>入口校验</strong></p>
<ul>
<li>必须以 <code>/</code>（或 <code>\</code>）开头；空路径直接拒绝。</li>
<li>拒绝包含 <code>NUL</code>（<code>\0</code>）字节。</li>
</ul>
</li>
<li><p><strong>统一分隔符</strong></p>
<ul>
<li><p>视 <code>ALLOW_BACKSLASH</code> 配置：</p>
<ul>
<li><code>true</code>：把 <code>\</code> 全部改成 <code>/</code>；</li>
<li><code>false</code>：出现 <code>\</code> 直接判为非法。</li>
</ul>
</li>
<li><p>折叠连续斜杠：<code>//…</code> 压成 <code>/…</code>。</p>
</li>
</ul>
</li>
<li><p><strong>补尾统一化</strong></p>
<ul>
<li>若以 <code>/.</code> 或 <code>/..</code> 结尾，先在末尾补一个 <code>/</code>，便于下一步用同一规则处理（把 “结尾的点段”也变成标准的 <code>&quot;/./&quot;</code> 或 <code>&quot;/../&quot;</code> 形态）。</li>
</ul>
</li>
<li><p><strong>消去当前目录段</strong></p>
<ul>
<li>循环查找并把所有 <code>&quot;/./&quot;</code> 压成 <code>&quot;/&quot;</code>。</li>
</ul>
</li>
<li><p><strong>折叠父目录段</strong></p>
<ul>
<li>循环处理每个 <code>&quot;/../&quot;</code>：回溯到它前一个 <code>/</code>，把 <code>&quot;/前一段/../&quot;</code> 整体删掉。</li>
<li>若要越过根（<code>index==0</code>），<strong>返回 false</strong>（拒绝）。</li>
</ul>
</li>
</ol>
<h4 id="字符转换"><a href="#字符转换" class="headerlink" title="字符转换"></a>字符转换</h4><p>这一步把前面“已经按容器规则做过一次 <code>%xx</code> 解码 + 规范化”的<strong>字节级路径</strong>，转换成<strong>字符级路径</strong>（考虑 <code>URIEncoding</code>），为后续 <strong>checkNormalize()</strong> 二次校验、映射、过滤器&#x2F;Servlet API 提供标准的 <code>char</code> 视图。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将 URI 从“字节视图”转换为“字符视图”（bytes -&gt; chars）。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uri     包含 URI 的 MessageBytes（此前已是字节视图并做过一次 %xx 解码与规范化）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request Servlet 层 Request，用于缓存/复用转换器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 发送错误响应时可能抛出（正常情况下不会抛，因为下面已拦截并发 400）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">convertURI</span><span class="params">(MessageBytes uri, Request request)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出字节切片（ByteChunk），以及其长度（有效字节数）</span></span><br><span class="line">    <span class="type">ByteChunk</span> <span class="variable">bc</span> <span class="operator">=</span> uri.getByteChunk();</span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bc.getLength();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 准备字符切片（CharChunk）作输出缓冲：初始容量 = 字节长度，上限 = -1（不限）</span></span><br><span class="line">    <span class="comment">// 对于 UTF-8 等多字节编码，字符数不会超过字节数，因此以字节长度作为初始容量是充足的上界。</span></span><br><span class="line">    <span class="type">CharChunk</span> <span class="variable">cc</span> <span class="operator">=</span> uri.getCharChunk();</span><br><span class="line">    cc.allocate(length, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 Connector 拿到 URI 的字符集配置（通常由 server.xml 的 URIEncoding 等决定）</span></span><br><span class="line">    <span class="type">Charset</span> <span class="variable">charset</span> <span class="operator">=</span> connector.getURICharset();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿一个“字节-&gt;字符”转换器（B2CConverter）：</span></span><br><span class="line">    <span class="comment">// - 优先复用挂在 request 上的实例，避免重复创建（减少对象 churn）</span></span><br><span class="line">    <span class="comment">// - recycle() 会重置内部状态（解码器、错误替换旗标等）</span></span><br><span class="line">    <span class="type">B2CConverter</span> <span class="variable">conv</span> <span class="operator">=</span> request.getURIConverter();</span><br><span class="line">    <span class="keyword">if</span> (conv == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 第二个参数 true：表示遇到无效字节时“用替代字符替换”，而不是抛异常</span></span><br><span class="line">        conv = <span class="keyword">new</span> <span class="title class_">B2CConverter</span>(charset, <span class="literal">true</span>);</span><br><span class="line">        request.setURIConverter(conv);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        conv.recycle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行字节 -&gt; 字符转换</span></span><br><span class="line">        <span class="comment">// 第三个参数 true：表明这是输入的“结束”（endOfInput），便于解码器 flush 悬挂状态</span></span><br><span class="line">        conv.convert(bc, cc, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 MessageBytes 切换到“字符视图”：后续 API（如 getRequestURI()/mapping）都以 char 为准</span></span><br><span class="line">        uri.setChars(cc.getBuffer(), cc.getStart(), cc.getLength());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// 理论上不会到这里：B2CConverter 设置了“替换无效字符”策略而非抛异常</span></span><br><span class="line">        <span class="comment">// 若仍异常，直接回 400 Bad Request（字符层转换失败）</span></span><br><span class="line">        request.getResponse().sendError(HttpServletResponse.SC_BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="规范化检查"><a href="#规范化检查" class="headerlink" title="规范化检查"></a>规范化检查</h4><p>这是<strong>解码后的二次校验</strong>，不做修改、只做判定；一旦返回 <code>false</code>，上层应当拒绝请求或报 400，防止通过“字符解码后再出现的 <code>..</code>&#x2F;反斜杠&#x2F;重复斜杠”等变体造成绕过。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * （字符层）检查 URI 是否保持已规范化状态。</span></span><br><span class="line"><span class="comment"> * 需要在“字节→字符”解码之后调用；若仍包含 &#x27;\&#x27;, NUL, &quot;//&quot;, &quot;/./&quot;, &quot;/../&quot; 或以 &quot;/.&quot;、&quot;/..&quot; 结尾，则判为未规范化。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uriMB  待检查的 URI（此时应为字符视图）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>       若发现任何未规范化片段返回 false，否则 true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkNormalize</span><span class="params">(MessageBytes uriMB)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得字符视图与基本边界</span></span><br><span class="line">    <span class="type">CharChunk</span> <span class="variable">uriCC</span> <span class="operator">=</span> uriMB.getCharChunk();</span><br><span class="line">    <span class="type">char</span>[] c = uriCC.getChars();</span><br><span class="line">    <span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> uriCC.getStart();</span><br><span class="line">    <span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> uriCC.getEnd();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) 禁止出现反斜杠 &#x27;\&#x27; 与 NUL 字符（\0）</span></span><br><span class="line">    <span class="comment">//    说明：即使字节层已处理，这里再次在字符层兜底检查。</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; end; pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c[pos] == <span class="string">&#x27;\\&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (c[pos] == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 禁止出现连续斜杠 &quot;//&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (pos = start; pos &lt; (end - <span class="number">1</span>); pos++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (c[pos] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (c[pos + <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 禁止以 &quot;/.&quot; 或 &quot;/..&quot; 结尾</span></span><br><span class="line">    <span class="comment">//    由于结尾无法被通用的 &quot;/./&quot;、&quot;/../&quot; 规则再折叠，因此直接判为未规范化。</span></span><br><span class="line">    <span class="keyword">if</span> (((end - start) &gt;= <span class="number">2</span>) &amp;&amp; (c[end - <span class="number">1</span>] == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((c[end - <span class="number">2</span>] == <span class="string">&#x27;/&#x27;</span>) || ((c[end - <span class="number">2</span>] == <span class="string">&#x27;.&#x27;</span>) &amp;&amp; (c[end - <span class="number">3</span>] == <span class="string">&#x27;/&#x27;</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 禁止包含 &quot;/./&quot;（当前目录片段）</span></span><br><span class="line">    <span class="keyword">if</span> (uriCC.indexOf(<span class="string">&quot;/./&quot;</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) 禁止包含 &quot;/../&quot;（父目录片段）</span></span><br><span class="line">    <span class="keyword">if</span> (uriCC.indexOf(<span class="string">&quot;/../&quot;</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 都没命中，视为已规范化</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="请求映射"><a href="#请求映射" class="headerlink" title="请求映射"></a>请求映射</h3><p>完成 URL 解析处理之后会执行映射将请求的 URI 映射到对应的处理方法或者请求的资源上。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行映射：serverName + decodedURI → 填充 request.getMappingData()</span></span><br><span class="line"><span class="comment">// 未指定 version 时默认命中该 webapp 的最新版本</span></span><br><span class="line">connector.getService().getMapper().map(serverName, decodedURI, version, request.getMappingData());</span><br></pre></td></tr></table></figure></div>

<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p>这个过程是通过 <code>org.apache.catalina.mapper.Mapper#map</code> 函数实现的，该函数实际调用 <code>internalMap</code> 函数实现。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将“主机名 + URI”映射到容器对象（Host/Context/Wrapper 等），并把结果写进 mappingData。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> host        虚拟主机名（MessageBytes，可是字节或字符视图）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> uri         已规范化后的 URI（MessageBytes）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> version     并行部署时的 Web 应用版本（可为 null，表示“取最新”）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mappingData 映射结果写入到这里（含 host/context/wrapper/redirectPath 等）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 当内部需要写入的缓冲区不足（例如 CharChunk 空间不够）时抛出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(MessageBytes host, MessageBytes uri, String version, MappingData mappingData)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若请求中未提供 host（例如 HTTP/1.0 或某些非标准场景），尝试使用默认主机名</span></span><br><span class="line">    <span class="keyword">if</span> (host.isNull()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">defaultHostName</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultHostName;</span><br><span class="line">        <span class="keyword">if</span> (defaultHostName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 没有默认主机名可用，直接返回（mappingData 不会被填充）</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 把 host 的字符视图清空为长度 0（指向一个空的 char 数组）</span></span><br><span class="line">        host.setChars(MessageBytes.EMPTY_CHAR_ARRAY, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 追加默认主机名，后续映射将以它为准</span></span><br><span class="line">        host.getCharChunk().append(defaultHostName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// internalMap 以“字符视图”工作；确保 host 和 uri 都转为 CharChunk</span></span><br><span class="line">    host.toChars();</span><br><span class="line">    uri.toChars();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 真正的映射实现：根据 host/uri/version 计算并填充 mappingData</span></span><br><span class="line">    internalMap(host.getCharChunk(), uri.getCharChunk(), version, mappingData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="internalMap"><a href="#internalMap" class="headerlink" title="internalMap"></a>internalMap</h4><p><code>internalMap</code> 函数<strong>把“主机名 + URI”路由到具体应用与 Servlet</strong>。先定 Host，再找最匹配的 Context（应用），再选版本（并行部署时），最后交给 <code>internalMapWrapper</code> 做到具体 Servlet 的匹配。</p>
<ol>
<li><p><strong>防御性检查</strong></p>
<ul>
<li>如果 <code>mappingData.host</code> 已经被填过，直接 <code>AssertionError</code>（避免重复&#x2F;错用导致结果不一致）。</li>
</ul>
</li>
<li><p><strong>Host 映射</strong></p>
<ul>
<li>先对 <code>host</code> 做<strong>不区分大小写的精确匹配</strong>。</li>
<li>不命中时，尝试<strong>通配主机</strong>：把第一个 <code>.</code> 之前的 label 暂时“切掉”（如 <code>a.example.com</code>→<code>example.com</code>）再匹配。</li>
<li>还不行就落到 <code>defaultHost</code>；如果也没有，<strong>返回</strong>（无法继续）。</li>
</ul>
</li>
<li><p><strong>URI 空检查与准备</strong></p>
<ul>
<li>没有 URI 就没法做 Context&#x2F;Wrapper 映射，<strong>返回</strong>。</li>
<li><code>uri.setLimit(-1)</code>：取消 <code>CharChunk</code> 限制，方便后面<strong>临时截断</strong>路径做查找。</li>
</ul>
</li>
<li><p><strong>Context（应用）映射：最长前缀匹配</strong></p>
<ul>
<li>在该 Host 下的 <code>contexts</code> 列表里，找与 <code>uri</code> <strong>前缀匹配</strong>最长的 <code>context.name</code>。</li>
<li>实现细节：用 <code>find()</code> 定位候选；若未命中，就按 <code>/</code> <strong>逐级回退</strong>（<code>nthSlash</code> &#x2F; <code>lastSlash</code>）并<strong>临时缩短</strong> <code>uri</code> 再找。</li>
<li>如果最终没找到，且 <code>contexts[0].name</code> 是空串 <code>&quot;&quot;</code>（ROOT 应用），就用 ROOT；否则<strong>返回</strong>。</li>
<li>命中后写出 <code>mappingData.contextPath</code>。</li>
</ul>
</li>
<li><p><strong>Context 版本选择（并行部署）</strong></p>
<ul>
<li>一个 Context 可能有多个版本（<code>context.versions</code>）。</li>
<li>若有多个版本，把所有版本对象塞到 <code>mappingData.contexts</code>（供上层按会话再决策）。</li>
<li>若 <code>version</code> 参数非空，尝试<strong>精确命中</strong>该版本；否则取<strong>“最新版本”</strong>（数组最后一个）。</li>
<li>写出 <code>mappingData.context</code> 与 <code>contextSlashCount</code>（后续做 Servlet 匹配用）。</li>
</ul>
</li>
<li><p><strong>Wrapper（Servlet）映射</strong></p>
<ul>
<li>如果目标版本 <strong>未暂停</strong>（没在 warm-up&#x2F;注册中），调用 <code>internalMapWrapper(contextVersion, uri, mappingData)</code>，按规范顺序（精确→前缀→扩展→欢迎→默认）匹配到具体 Servlet。</li>
</ul>
</li>
</ol>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据“主机名 + URI”执行映射（Host → Context → Wrapper），把结果写进 mappingData。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 当在处理 URI 时需要调整缓冲而空间不足等</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span> <span class="comment">// contextPath</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalMap</span><span class="params">(CharChunk host, CharChunk uri, String version, MappingData mappingData)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mappingData.host != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 按理说这里开始映射时 host 应该还没被填充；</span></span><br><span class="line">        <span class="comment">// 若已非空，说明上层重复/错误调用，直接断言失败以避免产生不一致结果。</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 1) 虚拟主机映射（Host） ==========</span></span><br><span class="line">    MappedHost[] hosts = <span class="built_in">this</span>.hosts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先用完整 host 做一次不区分大小写的精确匹配（host 名字大小写不敏感）</span></span><br><span class="line">    <span class="type">MappedHost</span> <span class="variable">mappedHost</span> <span class="operator">=</span> exactFindIgnoreCase(hosts, host);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mappedHost == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 备注：Mapper 内部表示通配主机（如 *.example.com）时，不带前导 &#x27;*&#x27;</span></span><br><span class="line">        <span class="comment">// 这里的“捷径”是：截掉第一段（第一个 &#x27;.&#x27; 之前的 label），</span></span><br><span class="line">        <span class="comment">// 用剩余部分（如 &quot;example.com&quot;）再尝试一次匹配，以命中通配主机。</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">firstDot</span> <span class="operator">=</span> host.indexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (firstDot &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> host.getOffset();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                host.setOffset(firstDot + offset);               <span class="comment">// 临时把起点右移到 &#x27;.&#x27; 之后</span></span><br><span class="line">                mappedHost = exactFindIgnoreCase(hosts, host);   <span class="comment">// 再试一次（可能命中通配 host 映射）</span></span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                host.setOffset(offset);                          <span class="comment">// 无论如何都恢复 offset</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mappedHost == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 仍未命中：落到默认主机（defaultHost）</span></span><br><span class="line">            mappedHost = defaultHost;</span><br><span class="line">            <span class="keyword">if</span> (mappedHost == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 没有默认主机则无法继续映射</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 记录命中的 Host 到输出</span></span><br><span class="line">    mappingData.host = mappedHost.object;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 2) 没有 URI 就无法继续 Context/Wrapper 映射 ==========</span></span><br><span class="line">    <span class="keyword">if</span> (uri.isNull()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消 CharChunk 的扫描限制（-1 表示不限制），方便后续在同一缓冲内做临时截断/探索</span></span><br><span class="line">    uri.setLimit(-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 3) Context（应用）映射 ==========</span></span><br><span class="line">    <span class="type">ContextList</span> <span class="variable">contextList</span> <span class="operator">=</span> mappedHost.contextList;</span><br><span class="line">    MappedContext[] contexts = contextList.contexts;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find(contexts, uri) 通常是按“前缀”在已排序的 context 列表里找潜在位置（高效二分/近似）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> find(contexts, uri);</span><br><span class="line">    <span class="keyword">if</span> (pos == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 找不到任何候选上下文（比如 host 下没有部署 ROOT）</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">lastSlash</span> <span class="operator">=</span> -<span class="number">1</span>;             <span class="comment">// 记录上一次用于回退的 &#x27;/&#x27; 位置</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">uriEnd</span> <span class="operator">=</span> uri.getEnd();      <span class="comment">// 先保存原始 URI 的 end，便于后面恢复</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">MappedContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从当前位置向上回退（按斜杠逐级回退）尝试匹配最长的 contextPath</span></span><br><span class="line">    <span class="keyword">while</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        context = contexts[pos];</span><br><span class="line">        <span class="keyword">if</span> (uri.startsWith(context.name)) &#123;                <span class="comment">// 以 context.name 为前缀？</span></span><br><span class="line">            length = context.name.length();</span><br><span class="line">            <span class="keyword">if</span> (uri.getLength() == length) &#123;               <span class="comment">// 完全相等：命中</span></span><br><span class="line">                found = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uri.startsWithIgnoreCase(<span class="string">&quot;/&quot;</span>, length)) &#123;</span><br><span class="line">                <span class="comment">// 前缀后紧跟 &#x27;/&#x27;：也视为命中（例如 /app 与 /app/...）</span></span><br><span class="line">                found = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未命中：根据“嵌套深度”计算/更新应回退到的下一个 &#x27;/&#x27;，并临时截断 URI 再找</span></span><br><span class="line">        <span class="keyword">if</span> (lastSlash == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 第一次回退：找第 (nesting+1) 个 &#x27;/&#x27;（避免过度逐字回退）</span></span><br><span class="line">            lastSlash = nthSlash(uri, contextList.nesting + <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 之后每次回退一个 &#x27;/&#x27;</span></span><br><span class="line">            lastSlash = lastSlash(uri);</span><br><span class="line">        &#125;</span><br><span class="line">        uri.setEnd(lastSlash);                              <span class="comment">// 临时缩短 URI 再次 find()</span></span><br><span class="line">        pos = find(contexts, uri);</span><br><span class="line">    &#125;</span><br><span class="line">    uri.setEnd(uriEnd);                                     <span class="comment">// 恢复 URI 的 end（不影响后续使用）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若还没找到，且第 0 个 context 是空串 &quot;&quot;（即 ROOT 应用），则落到 ROOT</span></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="keyword">if</span> (contexts[<span class="number">0</span>].name.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            context = contexts[<span class="number">0</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            context = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (context == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;                                            <span class="comment">// 没有可用的 Context，结束</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出 contextPath（如 &quot;/app&quot; 或 &quot;&quot;）</span></span><br><span class="line">    mappingData.contextPath.setString(context.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 4) Context 版本选择（并行部署支持） ==========</span></span><br><span class="line">    <span class="type">ContextVersion</span> <span class="variable">contextVersion</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    ContextVersion[] contextVersions = context.versions;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">versionCount</span> <span class="operator">=</span> contextVersions.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (versionCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 把所有版本对应的 Context 对象放到 mappingData.contexts，供上层二次决策（按会话所属版本）</span></span><br><span class="line">        Context[] contextObjects = <span class="keyword">new</span> <span class="title class_">Context</span>[contextVersions.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; contextObjects.length; i++) &#123;</span><br><span class="line">            contextObjects[i] = contextVersions[i].object;</span><br><span class="line">        &#125;</span><br><span class="line">        mappingData.contexts = contextObjects;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若上层传入了明确的 version，尝试精确命中</span></span><br><span class="line">        <span class="keyword">if</span> (version != <span class="literal">null</span>) &#123;</span><br><span class="line">            contextVersion = exactFind(contextVersions, version);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (contextVersion == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 默认返回“最新版本”（versions 数组保证至少一个元素，且按版本时间顺序排列）</span></span><br><span class="line">        contextVersion = contextVersions[versionCount - <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写出最终命中的 Context 与其斜杠数量（用于后续 wrapper 映射的路径切分）</span></span><br><span class="line">    mappingData.context = contextVersion.object;</span><br><span class="line">    mappingData.contextSlashCount = contextVersion.slashCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 5) Wrapper（具体 Servlet）映射 ==========</span></span><br><span class="line">    <span class="keyword">if</span> (!contextVersion.isPaused()) &#123;</span><br><span class="line">        <span class="comment">// 若该版本未处于暂停（启动尚未完成等），则继续进行精细到 Servlet 的映射</span></span><br><span class="line">        internalMapWrapper(contextVersion, uri, mappingData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="internalMapWrapper"><a href="#internalMapWrapper" class="headerlink" title="internalMapWrapper"></a>internalMapWrapper</h4><p><code>internalMapWrapper</code> 把“context 内的相对路径”按 Servlet 规范的优先级，精确地路由到某个具体 Servlet（wrapper），必要时生成重定向或落到默认 Servlet。</p>
<p>具体过程为：</p>
<ol>
<li><p><strong>定位 servletPath</strong><br>从 <code>path</code> 里剥掉 <code>contextPath</code>（用 <code>setOffset(servletPath)</code>），后续匹配都基于 servletPath。</p>
</li>
<li><p><strong>规则 1：精确匹配（Exact）</strong><br>在 <code>exactWrappers</code> 里找与 servletPath 完全相等的 <code>url-pattern</code>。</p>
</li>
<li><p><strong>规则 2：前缀匹配（Wildcard，如 <code>/foo/*</code>）</strong><br>若命中且是 <strong>JSP 通配</strong>，再看原始路径是否以 <code>/</code> 结尾：</p>
<ul>
<li>以 <code>/</code> 结尾：<strong>清空当前匹配</strong>，转去走“欢迎页”逻辑（Bug 27664）。</li>
<li>否则：确定 <code>wrapperPath</code>，清空 <code>pathInfo</code>（Bug 27704）。</li>
</ul>
</li>
<li><p><strong>Context 根重定向</strong><br>若仍未命中、且 servletPath 为空、且开启了 <em>context root redirect</em>，把路径重定向到 <code>/</code> 并返回。</p>
</li>
<li><p><strong>规则 3：扩展名匹配（Extension，如 <code>*.jsp</code>&#x2F;<code>*.do</code>）</strong><br>在 <code>extensionWrappers</code> 里按后缀匹配（允许作为欢迎资源的一部分）。</p>
</li>
<li><p><strong>规则 4：欢迎资源（Welcome files）</strong><br>仅当还没匹配到且需要检查欢迎页时（JSP 通配触发或路径以 <code>/</code> 结尾）：<br>逐个把 <code>index.html</code> &#x2F; <code>index.jsp</code> &#x2F; <code>index.do</code>… 拼到路径末尾，依次尝试：</p>
<ul>
<li><strong>4a 精确匹配</strong></li>
<li><strong>4b 前缀匹配</strong></li>
<li><strong>4c 物理文件存在</strong>时，再试扩展匹配；若仍无匹配且有 <code>defaultWrapper</code>，就用它处理并设置 <code>requestPath</code>&#x2F;<code>wrapperPath</code>。<br>做完后把 <code>path</code> 的 offset&#x2F;end 复原。</li>
</ul>
</li>
<li><p><strong>欢迎文件处理·第二轮（无物理文件场景）</strong><br>若还没命中，再按欢迎名做一轮<strong>仅扩展匹配</strong>（比如 <code>index.jsf</code>&#x2F;<code>index.do</code> 这类“没有真实文件”的映射）。</p>
</li>
<li><p><strong>规则 7：默认 Servlet（DefaultServlet）兜底</strong><br>若仍未命中且不在 JSP 欢迎模式：</p>
<ul>
<li>有 <code>defaultWrapper</code> 就用之，并设置 <code>requestPath</code>&#x2F;<code>wrapperPath</code>、<code>matchType=DEFAULT</code>。</li>
<li><strong>目录重定向</strong>：若资源存在且是目录且路径不以 <code>/</code> 结尾、并开启 <em>directory redirect</em>，则拼上 <code>/</code> 设置 <code>redirectPath</code>；否则直接记录路径给默认 Servlet 处理。</li>
</ul>
</li>
<li><p><strong>收尾</strong><br>无论匹配到什么，最后都会把 <code>path</code> 的 offset&#x2F;end <strong>恢复</strong>，避免影响后续处理。</p>
</li>
</ol>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wrapper（具体 Servlet）映射。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 规则顺序基本遵循 Servlet 规范：</span></span><br><span class="line"><span class="comment"> *  1) 精确匹配（Exact）</span></span><br><span class="line"><span class="comment"> *  2) 前缀匹配（Wildcard / 前缀模式）</span></span><br><span class="line"><span class="comment"> *     - 特殊：JSP 通配 &amp; 末尾是 &#x27;/&#x27; 时，强制走欢迎页检查（Bug 27664）</span></span><br><span class="line"><span class="comment"> *  3) 扩展名匹配（Extension）</span></span><br><span class="line"><span class="comment"> *  4) 欢迎资源（Welcome files）</span></span><br><span class="line"><span class="comment"> *     4a) 精确</span></span><br><span class="line"><span class="comment"> *     4b) 前缀</span></span><br><span class="line"><span class="comment"> *     4c) 物理文件存在时按扩展或默认 servlet</span></span><br><span class="line"><span class="comment"> *     —— 然后再做一次“无物理文件”的扩展欢迎匹配（index.jsf/index.do 等）</span></span><br><span class="line"><span class="comment"> *  7) 默认 servlet（DefaultServlet）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException 缓冲区空间不足等导致无法回写映射结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">internalMapWrapper</span><span class="params">(ContextVersion contextVersion, CharChunk path, MappingData mappingData)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">pathOffset</span> <span class="operator">=</span> path.getOffset();       <span class="comment">// 原始偏移（包含 contextPath 的路径起点）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">pathEnd</span> <span class="operator">=</span> path.getEnd();             <span class="comment">// 原始结尾</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">noServletPath</span> <span class="operator">=</span> <span class="literal">false</span>;           <span class="comment">// 是否不存在 servletPath（仅有 contextPath）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// contextVersion.path 为 contextPath（如 &quot;/app&quot; 或 &quot;&quot;）</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> contextVersion.path.length();</span><br><span class="line">    <span class="keyword">if</span> (length == (pathEnd - pathOffset)) &#123;  <span class="comment">// 路径长度 == contextPath 长度 =&gt; 没有 servletPath</span></span><br><span class="line">        noServletPath = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">servletPath</span> <span class="operator">=</span> pathOffset + length;   <span class="comment">// servletPath 起始位置</span></span><br><span class="line">    path.setOffset(servletPath);             <span class="comment">// 之后的匹配均基于 servletPath 片段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规则 1 —— 精确匹配（/foo/bar 完全等于某个 url-pattern）</span></span><br><span class="line">    MappedWrapper[] exactWrappers = contextVersion.exactWrappers;</span><br><span class="line">    internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规则 2 —— 前缀匹配（通配，形如 /foo/*）</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">checkJspWelcomeFiles</span> <span class="operator">=</span> <span class="literal">false</span>;    <span class="comment">// 是否需要按“JSP 通配 + 目录尾斜杠”的欢迎页逻辑</span></span><br><span class="line">    MappedWrapper[] wildcardWrappers = contextVersion.wildcardWrappers;</span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting, path, mappingData);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命中前缀匹配，且是 JSP 通配</span></span><br><span class="line">        <span class="keyword">if</span> (mappingData.wrapper != <span class="literal">null</span> &amp;&amp; mappingData.jspWildCard) &#123;</span><br><span class="line">            <span class="type">char</span>[] buf = path.getBuffer();</span><br><span class="line">            <span class="keyword">if</span> (buf[pathEnd - <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * 末尾是 &#x27;/&#x27; 且是 JSP 通配命中：强制改走“欢迎文件”逻辑。</span></span><br><span class="line"><span class="comment">                 * 例如 jsp-property-group 的 url-pattern 为 *.jsp，目录请求应尝试欢迎 JSP。</span></span><br><span class="line"><span class="comment">                 * （Bug 27664）</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                mappingData.wrapper = <span class="literal">null</span>;  <span class="comment">// 先清空，转到欢迎文件流程</span></span><br><span class="line">                checkJspWelcomeFiles = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Bug 27704：非目录结尾，直接确定 wrapperPath，清理 pathInfo</span></span><br><span class="line">                mappingData.wrapperPath.setChars(buf, path.getStart(), path.getLength());</span><br><span class="line">                mappingData.pathInfo.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Context 根路径且启用了“root redirect”：将空 servletPath 重定向到 &quot;/&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span> &amp;&amp; noServletPath &amp;&amp;</span><br><span class="line">            contextVersion.object.getMapperContextRootRedirectEnabled()) &#123;</span><br><span class="line">        path.append(<span class="string">&#x27;/&#x27;</span>);                                              <span class="comment">// path 末尾临时加 &#x27;/&#x27;</span></span><br><span class="line">        pathEnd = path.getEnd();</span><br><span class="line">        mappingData.redirectPath.setChars(path.getBuffer(), pathOffset, pathEnd - pathOffset);</span><br><span class="line">        path.setEnd(pathEnd - <span class="number">1</span>);                                      <span class="comment">// 复原 path 结尾</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规则 3 —— 扩展名匹配（*.jsp、*.do 等）</span></span><br><span class="line">    MappedWrapper[] extensionWrappers = contextVersion.extensionWrappers;</span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span> &amp;&amp; !checkJspWelcomeFiles) &#123;</span><br><span class="line">        <span class="comment">// 第一次扩展匹配：正常玩法（允许作为欢迎资源检查的一部分）</span></span><br><span class="line">        internalMapExtensionWrapper(extensionWrappers, path, mappingData, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规则 4 —— 欢迎资源（servlet 侧的欢迎文件处理）</span></span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">checkWelcomeFiles</span> <span class="operator">=</span> checkJspWelcomeFiles;</span><br><span class="line">        <span class="keyword">if</span> (!checkWelcomeFiles) &#123;</span><br><span class="line">            <span class="type">char</span>[] buf = path.getBuffer();</span><br><span class="line">            checkWelcomeFiles = (buf[pathEnd - <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>);             <span class="comment">// 目录请求需要检查欢迎文件</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (checkWelcomeFiles) &#123;</span><br><span class="line">            <span class="comment">// 遍历所有欢迎资源名（如 &quot;index.html&quot;, &quot;index.jsp&quot;, &quot;index.do&quot;...）</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; (i &lt; contextVersion.welcomeResources.length) &amp;&amp; (mappingData.wrapper == <span class="literal">null</span>); i++) &#123;</span><br><span class="line">                path.setOffset(pathOffset);</span><br><span class="line">                path.setEnd(pathEnd);</span><br><span class="line">                path.append(contextVersion.welcomeResources[i], <span class="number">0</span>, contextVersion.welcomeResources[i].length());</span><br><span class="line">                path.setOffset(servletPath);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4a：欢迎文件的“精确匹配”</span></span><br><span class="line">                internalMapExactWrapper(exactWrappers, path, mappingData);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4b：欢迎文件的“前缀匹配”</span></span><br><span class="line">                <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">                    internalMapWildcardWrapper(wildcardWrappers, contextVersion.nesting, path, mappingData);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 4c：若有物理文件存在（真实资源），再尝试按扩展或默认 servlet 处理</span></span><br><span class="line">                <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span> &amp;&amp; contextVersion.resources != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">pathStr</span> <span class="operator">=</span> path.toString();</span><br><span class="line">                    <span class="type">WebResource</span> <span class="variable">file</span> <span class="operator">=</span> contextVersion.resources.getResource(pathStr);</span><br><span class="line">                    <span class="keyword">if</span> (file != <span class="literal">null</span> &amp;&amp; file.isFile()) &#123;</span><br><span class="line">                        <span class="comment">// 物理存在：再做一次扩展匹配（允许）</span></span><br><span class="line">                        internalMapExtensionWrapper(extensionWrappers, path, mappingData, <span class="literal">true</span>);</span><br><span class="line">                        <span class="comment">// 仍无匹配，退回默认 servlet（defaultWrapper）</span></span><br><span class="line">                        <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span> &amp;&amp; contextVersion.defaultWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">                            mappingData.wrapper = contextVersion.defaultWrapper.object;</span><br><span class="line">                            mappingData.requestPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">                            mappingData.wrapperPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">                            mappingData.requestPath.setString(pathStr);</span><br><span class="line">                            mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 欢迎文件检查完，恢复 path 游标</span></span><br><span class="line">            path.setOffset(servletPath);</span><br><span class="line">            path.setEnd(pathEnd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 欢迎文件处理（第二轮）：</span></span><br><span class="line"><span class="comment">     * 上面做过“有物理文件”的情况；现在处理“只有扩展映射、可能没有物理文件”的情况，</span></span><br><span class="line"><span class="comment">     * 例如 index.jsf、index.do 等（精简版的规则 4）。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">checkWelcomeFiles</span> <span class="operator">=</span> checkJspWelcomeFiles;</span><br><span class="line">        <span class="keyword">if</span> (!checkWelcomeFiles) &#123;</span><br><span class="line">            <span class="type">char</span>[] buf = path.getBuffer();</span><br><span class="line">            checkWelcomeFiles = (buf[pathEnd - <span class="number">1</span>] == <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (checkWelcomeFiles) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; (i &lt; contextVersion.welcomeResources.length) &amp;&amp; (mappingData.wrapper == <span class="literal">null</span>); i++) &#123;</span><br><span class="line">                path.setOffset(pathOffset);</span><br><span class="line">                path.setEnd(pathEnd);</span><br><span class="line">                path.append(contextVersion.welcomeResources[i], <span class="number">0</span>, contextVersion.welcomeResources[i].length());</span><br><span class="line">                path.setOffset(servletPath);</span><br><span class="line">                <span class="comment">// 第二轮扩展匹配：不要求物理存在（allowWelcomeResource = false）</span></span><br><span class="line">                internalMapExtensionWrapper(extensionWrappers, path, mappingData, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path.setOffset(servletPath);</span><br><span class="line">            path.setEnd(pathEnd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规则 7 —— 默认 servlet（最后兜底）</span></span><br><span class="line">    <span class="keyword">if</span> (mappingData.wrapper == <span class="literal">null</span> &amp;&amp; !checkJspWelcomeFiles) &#123;</span><br><span class="line">        <span class="keyword">if</span> (contextVersion.defaultWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">            mappingData.wrapper = contextVersion.defaultWrapper.object;</span><br><span class="line">            mappingData.requestPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">            mappingData.wrapperPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">            mappingData.matchType = ApplicationMappingMatch.DEFAULT;   <span class="comment">// 标记匹配类型：默认</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 目录重定向：若目标是个目录且未以 &#x27;/&#x27; 结尾，按配置重定向到“带 /”的地址</span></span><br><span class="line">        <span class="type">char</span>[] buf = path.getBuffer();</span><br><span class="line">        <span class="keyword">if</span> (contextVersion.resources != <span class="literal">null</span> &amp;&amp; buf[pathEnd - <span class="number">1</span>] != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">pathStr</span> <span class="operator">=</span> path.toString();</span><br><span class="line">            <span class="comment">// 优先检查是否需要目录重定向（BZ 62968：先判断可节省一次 getResource()）</span></span><br><span class="line">            <span class="keyword">if</span> (contextVersion.object.getMapperDirectoryRedirectEnabled()) &#123;</span><br><span class="line">                WebResource file;</span><br><span class="line">                <span class="keyword">if</span> (pathStr.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                    file = contextVersion.resources.getResource(<span class="string">&quot;/&quot;</span>);  <span class="comment">// context 根特殊处理</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    file = contextVersion.resources.getResource(pathStr);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (file != <span class="literal">null</span> &amp;&amp; file.isDirectory()) &#123;</span><br><span class="line">                    <span class="comment">// 注意：此处会改写 path，不要在此后再做其他处理</span></span><br><span class="line">                    path.setOffset(pathOffset);</span><br><span class="line">                    path.append(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                    mappingData.redirectPath.setChars(path.getBuffer(), path.getStart(), path.getLength());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 非目录：直接按默认 servlet 记录 requestPath 与 wrapperPath</span></span><br><span class="line">                    mappingData.requestPath.setString(pathStr);</span><br><span class="line">                    mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 未启用目录重定向：同样记录路径，交由默认 servlet 处理</span></span><br><span class="line">                mappingData.requestPath.setString(pathStr);</span><br><span class="line">                mappingData.wrapperPath.setString(pathStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 恢复原始 path 边界</span></span><br><span class="line">    path.setOffset(pathOffset);</span><br><span class="line">    path.setEnd(pathEnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="Shiro-解析流程"><a href="#Shiro-解析流程" class="headerlink" title="Shiro 解析流程"></a>Shiro 解析流程</h3><p>这里以 Spring 为例。</p>
<h4 id="初始化流程"><a href="#初始化流程" class="headerlink" title="初始化流程"></a>初始化流程</h4><p><code>org.apache.shiro.spring.web.ShiroFilterFactoryBean</code> 实现了 <code>FactoryBean</code> 接口，那么 Spring 在初始化的时候必然会调用 <code>ShiroFilterFactoryBean</code> 的 <code>getObject()</code> 获取实例，而 <code>ShiroFilterFactoryBean</code> 也在此时做了一系列初始化操作。</p>
<p>在 <code>getObject()</code> 中会调用 <code>createInstance()</code> 方法。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AbstractShiroFilter <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">        instance = createInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>createInstance</code> 实现如下：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该实现会做以下事情：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;确保必须的 &#123;<span class="doctag">@link</span> #setSecurityManager(org.apache.shiro.mgt.SecurityManager) securityManager&#125;</span></span><br><span class="line"><span class="comment"> *       属性已被设置；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;&#123;<span class="doctag">@link</span> #createFilterChainManager() 创建&#125; 一个 &#123;<span class="doctag">@link</span> FilterChainManager&#125; 实例，</span></span><br><span class="line"><span class="comment"> *       该实例基于当前配置的 &#123;<span class="doctag">@link</span> #setFilters(java.util.Map) filters&#125;</span></span><br><span class="line"><span class="comment"> *       和 &#123;<span class="doctag">@link</span> #setFilterChainDefinitionMap(java.util.Map) 过滤链定义&#125;；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;用一个合适的</span></span><br><span class="line"><span class="comment"> *       &#123;<span class="doctag">@link</span> org.apache.shiro.web.filter.mgt.FilterChainResolver FilterChainResolver&#125;</span></span><br><span class="line"><span class="comment"> *       包裹上面的 FilterChainManager，因为 Shiro 的 Filter 实现并不知道“FilterChainManager”这个概念；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;把 &#123;<span class="doctag">@code</span> SecurityManager&#125; 和 &#123;<span class="doctag">@code</span> FilterChainResolver&#125; 注入到一个新的 Shiro Filter 实例上，</span></span><br><span class="line"><span class="comment"> *       并返回该 Filter 实例。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 一个新的 Shiro Filter，反映了当前配置的各个过滤器和 URL 过滤链定义。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 如果创建 AbstractShiroFilter 实例时出现问题会抛出异常。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> AbstractShiroFilter <span class="title function_">createInstance</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志：开始创建 Shiro Filter 实例</span></span><br><span class="line">    log.debug(<span class="string">&quot;Creating Shiro Filter instance.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) 取出 SecurityManager，并进行必备性与类型检查</span></span><br><span class="line">    <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (securityManager == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 未设置 SecurityManager 是致命配置错误：直接抛出 Spring 的初始化异常</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;SecurityManager property must be set.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInitializationException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(securityManager <span class="keyword">instanceof</span> WebSecurityManager)) &#123;</span><br><span class="line">        <span class="comment">// Web 场景要求使用 WebSecurityManager（例如 DefaultWebSecurityManager）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;The security manager does not implement the WebSecurityManager interface.&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInitializationException</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 基于 filters 与 filterChainDefinitionMap 构建 FilterChainManager</span></span><br><span class="line">    <span class="comment">//    它持有“过滤器实例集合”和“URL-&gt;过滤器链”的映射</span></span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> createFilterChainManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 暴露 FilterChainManager：用 FilterChainResolver 包起来</span></span><br><span class="line">    <span class="comment">//    AbstractShiroFilter 只认识 Resolver，不直接依赖 Manager</span></span><br><span class="line">    <span class="type">PathMatchingFilterChainResolver</span> <span class="variable">chainResolver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PathMatchingFilterChainResolver</span>();</span><br><span class="line">    chainResolver.setFilterChainManager(manager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 组装最终可用的 Shiro Filter：</span></span><br><span class="line">    <span class="comment">//    - 传入 WebSecurityManager（已检查类型）</span></span><br><span class="line">    <span class="comment">//    - 传入 FilterChainResolver（里面封装了 FilterChainManager）</span></span><br><span class="line">    <span class="comment">//    - 传入（可选的）ShiroFilter 配置（如 loginUrl、successUrl 等）</span></span><br><span class="line">    <span class="comment">//    这里用的是一个具体可实例化的 SpringShiroFilter（AbstractShiroFilter 的实现）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringShiroFilter</span>(</span><br><span class="line">            (WebSecurityManager) securityManager,</span><br><span class="line">            chainResolver,</span><br><span class="line">            getShiroFilterConfiguration()</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里面首先获取了我们在 <code>ShiroConfig</code> 中注入好参数的 <code>SecurityManager</code>。然后创建了一个 <code>FilterChainManager</code>，这个类看名字就知道是用来管理和操作过滤器执行链的，我们来看它的创建方法 <code>createFilterChainManager</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建并返回一个 &#123;<span class="doctag">@link</span> FilterChainManager&#125;：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;创建默认的过滤器管理器（内含 Shiro 内置过滤器，如 anon/authc/roles/perms/logout 等）；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;对“默认过滤器”与“自定义过滤器”应用全局属性（如 loginUrl/successUrl/unauthorizedUrl 等，前提是过滤器支持）；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;注册调用方传入的自定义过滤器（不在此处调用 init，交给 Spring 生命周期去做）；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;设置“全局过滤器”（globalFilters）：这些会附加到每一条 URL 过滤链上；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;根据 filterChainDefinitionMap（URL → 链定义字符串）逐条创建过滤链；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;最后创建兜底默认链 &quot;/**&quot;（用于匹配遗漏路径）。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> FilterChainManager <span class="title function_">createFilterChainManager</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) 创建默认的链管理器（会预置一组内置过滤器）</span></span><br><span class="line">    <span class="type">DefaultFilterChainManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFilterChainManager</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 对“默认过滤器集合”应用全局属性（如果该过滤器支持的话）</span></span><br><span class="line">    Map&lt;String, Filter&gt; defaultFilters = manager.getFilters();</span><br><span class="line">    <span class="keyword">for</span> (Filter filter : defaultFilters.values()) &#123;</span><br><span class="line">        applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 注册调用方配置/注入的“自定义过滤器”</span></span><br><span class="line">    Map&lt;String, Filter&gt; filters = getFilters();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Filter&gt; entry : filters.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 同样为自定义过滤器应用全局属性（若支持）</span></span><br><span class="line">            applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果过滤器可命名（实现了 Nameable），设置其逻辑名</span></span><br><span class="line">            <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Nameable) &#123;</span><br><span class="line">                ((Nameable) filter).setName(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 这里第三个参数传 false：表示“不在这里调用 init()”</span></span><br><span class="line">            <span class="comment">// 由 Spring 自己完成初始化（如 @PostConstruct / InitializingBean / init-method）</span></span><br><span class="line">            manager.addFilter(name, filter, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 设置“全局过滤器”（会附加到所有链上）</span></span><br><span class="line">    manager.setGlobalFilters(<span class="built_in">this</span>.globalFilters);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) 按 URL → 链定义（如 &quot;/admin/** = authc, roles[admin]&quot;）建立具体过滤链</span></span><br><span class="line">    Map&lt;String, String&gt; chains = getFilterChainDefinitionMap();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(chains)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : chains.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            <span class="type">String</span> <span class="variable">chainDefinition</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            manager.createChain(url, chainDefinition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) 创建兜底默认链，用于匹配遗漏的路径（此处假定 ANT 风格路径匹配）</span></span><br><span class="line">    manager.createDefaultChain(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>第一步 new 了一个 <code>DefaultFilterChainManager</code>，在它的构造方法中将 <code>filters</code> 和 <code>filterChains</code> 两个成员变量都初始化为一个能保持插入顺序的 <code>LinkedHashMap</code> 了，之后再调用 <code>addDefaultFilters</code> 添加Shiro内置的一些过滤器。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DefaultFilterChainManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, Filter&gt;();</span><br><span class="line">    <span class="built_in">this</span>.filterChains = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, NamedFilterList&gt;();</span><br><span class="line">    <span class="built_in">this</span>.globalFilterNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    addDefaultFilters(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addDefaultFilters</span><span class="params">(<span class="type">boolean</span> init)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (DefaultFilter defaultFilter : DefaultFilter.values()) &#123;</span><br><span class="line">        addFilter(defaultFilter.name(), defaultFilter.newInstance(), init, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>applyGlobalPropertiesIfNecessary</code> 方法遍历了每一个默认的过滤器并设置一些必要的全局属性。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyGlobalPropertiesIfNecessary</span><span class="params">(Filter filter)</span> &#123;</span><br><span class="line">    applyLoginUrlIfNecessary(filter);</span><br><span class="line">    applySuccessUrlIfNecessary(filter);</span><br><span class="line">    applyUnauthorizedUrlIfNecessary(filter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> OncePerRequestFilter) &#123;</span><br><span class="line">        ((OncePerRequestFilter) filter).setFilterOncePerRequest(filterConfiguration.isFilterOncePerRequest());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在这个方法中调用了三个方法，三个方法逻辑是一样的，分别是设置 <code>loginUrl</code>、<code>successUrl</code> 和 <code>unauthorizedUrl</code>，我们就看第一个 <code>applyLoginUrlIfNecessary</code>。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_LOGIN_URL</span> <span class="operator">=</span> <span class="string">&quot;/login.jsp&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">applyLoginUrlIfNecessary</span><span class="params">(Filter filter)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">loginUrl</span> <span class="operator">=</span> getLoginUrl();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(loginUrl) &amp;&amp; (filter <span class="keyword">instanceof</span> AccessControlFilter)) &#123;</span><br><span class="line">        <span class="type">AccessControlFilter</span> <span class="variable">acFilter</span> <span class="operator">=</span> (AccessControlFilter) filter;</span><br><span class="line">        <span class="comment">//only apply the login url if they haven&#x27;t explicitly configured one already:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">existingLoginUrl</span> <span class="operator">=</span> acFilter.getLoginUrl();</span><br><span class="line">        <span class="keyword">if</span> (AccessControlFilter.DEFAULT_LOGIN_URL.equals(existingLoginUrl)) &#123;</span><br><span class="line">            acFilter.setLoginUrl(loginUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>看方法名就知道是要设置 <code>loginUrl</code>，如果我们配置了 <code>loginUrl</code>，那么会将 <code>AccessControlFilter</code> 中默认的 <code>loginUrl</code> 替换为我们设置的值，默认的 <code>loginUrl</code> 为 <code>/login.jsp</code>。后面两个方法道理一样，都是将我们设置的参数替换进去，只不过第三个认证失败跳转 URL 的默认值为 null。</p>
<p>这里的 <code>getLoginUrl();</code> 是我们 shiroFilter Bean 中 <code>setLoginUrl</code> 的值。</p>
<p>执行回到 <code>createFilterChainManager</code> 代码中，<code>Map&lt;String, Filter&gt; filters = getFilters;</code> 这里是获取我们自定义的过滤器，默认是为空的，如果我们配置了自定义的过滤器，那么会将其添加到 <code>filters</code> 中。至此 <code>filters</code> 中包含着 Shiro 内置的过滤器和我们配置的所有过滤器。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3) 注册调用方配置/注入的“自定义过滤器”</span></span><br><span class="line">Map&lt;String, Filter&gt; filters = getFilters();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!CollectionUtils.isEmpty(filters)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Filter&gt; entry : filters.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同样为自定义过滤器应用全局属性（若支持）</span></span><br><span class="line">        applyGlobalPropertiesIfNecessary(filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果过滤器可命名（实现了 Nameable），设置其逻辑名</span></span><br><span class="line">        <span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Nameable) &#123;</span><br><span class="line">            ((Nameable) filter).setName(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里第三个参数传 false：表示“不在这里调用 init()”</span></span><br><span class="line">        <span class="comment">// 由 Spring 自己完成初始化（如 @PostConstruct / InitializingBean / init-method）</span></span><br><span class="line">        manager.addFilter(name, filter, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>下一步，遍历 <code>filterChainDefinitionMap</code>，这个 <code>filterChainDefinitionMap</code> 就是我们在 <code>ShiroConfig</code> 中注入进去的拦截规则配置。这里是根据我们配置的过滤器规则创建过滤器执行链。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4) 设置「全局过滤器」：这些会附加到每一条链上（无论 URL 是什么）</span></span><br><span class="line">manager.setGlobalFilters(<span class="built_in">this</span>.globalFilters);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 根据 URL-&gt;链定义 的映射，逐条构建过滤链</span></span><br><span class="line"><span class="comment">//    例如：&quot;/api/admin/**&quot; -&gt; &quot;authc, roles[admin]&quot; 会被解析并注册到管理器</span></span><br><span class="line">Map&lt;String, String&gt; chains = getFilterChainDefinitionMap();</span><br><span class="line"><span class="keyword">if</span> (!CollectionUtils.isEmpty(chains)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : chains.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> <span class="variable">chainDefinition</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        manager.createChain(url, chainDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6) 创建默认链：兜底匹配任何路径（避免有路径未被前面的规则覆盖）</span></span><br><span class="line"><span class="comment">//    注意：此处假设使用的是 ANT 风格的路径匹配（/** 为多段匹配）</span></span><br><span class="line">manager.createDefaultChain(<span class="string">&quot;/**&quot;</span>); <span class="comment">// TODO 这里假定 ANT 路径匹配；在此场景下通常是 OK 的</span></span><br></pre></td></tr></table></figure></div>

<p><code>org.apache.shiro.web.filter.mgt.DefaultFilterChainManager#createChain</code> 的 <code>chainName</code> 是我们配置的过滤路径，<code>chainDefinition</code> 是该路径对应的过滤器，通常我们都是一对一的配置，比如：<code>filterMap.put(&quot;/login&quot;, &quot;anon&quot;);</code>，但看到这个方法我们知道了一个过滤路径其实是可以通过传入 <code>[&quot;filter1&quot;,&quot;filter2&quot;...]</code> 配置多个过滤器的。在这里会根据我们配置的过滤路径和过滤器映射关系一步步配置过滤器执行链。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据给定的 URL 链名与“链定义字符串”创建一条过滤链。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;流程概述：</span></span><br><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;参数合法性校验（链名与链定义均不能为空）；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;优先把「全局过滤器」追加到该链上；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;解析链定义字符串（逗号分隔，支持形如 roles[admin,user] 的带参数写法）；&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *   &lt;li&gt;逐个把解析出的过滤器及其可选配置添加到该链上。&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 示例：</span></span><br><span class="line"><span class="comment"> *   chainName:  &quot;/api/admin/**&quot;</span></span><br><span class="line"><span class="comment"> *   chainDef :  &quot;authc, roles[admin,user], perms[file:edit]&quot;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createChain</span><span class="params">(String chainName, String chainDefinition)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) 基本校验：链名不能为空</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(chainName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;chainName cannot be null or empty.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 链定义字符串也不能为空</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(chainDefinition)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;chainDefinition cannot be null or empty.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调试日志：展示将要创建的链名、全局过滤器列表与原始链定义</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Creating chain [&quot;</span> + chainName + <span class="string">&quot;] with global filters &quot;</span> + globalFilterNames</span><br><span class="line">                + <span class="string">&quot; and from String definition [&quot;</span> + chainDefinition + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 先把「全局过滤器」加到这条链上（这些过滤器会应用到所有链）</span></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(globalFilterNames)) &#123;</span><br><span class="line">        globalFilterNames.stream().forEach(filterName -&gt; addToChain(chainName, filterName));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 解析链定义字符串，按逗号切分为“过滤器 token”</span></span><br><span class="line">    <span class="comment">//    例如：&quot;authc, roles[admin,user], perms[file:edit]&quot;</span></span><br><span class="line">    <span class="comment">//    =&gt; [&quot;authc&quot;, &quot;roles[admin,user]&quot;, &quot;perms[file:edit]&quot;]</span></span><br><span class="line">    String[] filterTokens = splitChainDefinition(chainDefinition);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 逐个 token 处理：</span></span><br><span class="line">    <span class="comment">//    - 拆出过滤器名与可选的配置（[] 中内容）</span></span><br><span class="line">    <span class="comment">//    - 追加到指定链上</span></span><br><span class="line">    <span class="keyword">for</span> (String token : filterTokens) &#123;</span><br><span class="line">        <span class="comment">// nameConfigPair[0] = 过滤器名，如 &quot;roles&quot;</span></span><br><span class="line">        <span class="comment">// nameConfigPair[1] = 过滤器配置，如 &quot;admin,user&quot;（可能为 null）</span></span><br><span class="line">        String[] nameConfigPair = toNameConfigPair(token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把解析出的过滤器及其参数加到该链</span></span><br><span class="line">        addToChain(chainName, nameConfigPair[<span class="number">0</span>], nameConfigPair[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>addToChain</code> 先从 <code>filters</code> 中根据 <code>filterName</code> 获取对应过滤器，然后 <code>ensureChain</code> 会先从 <code>filterChains</code> 根据 <code>chainName</code> 获取 <code>NamedFilterList</code>，获取不到就创建一个并添加到 <code>filterChains</code> 然后返回。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向指定的过滤链（chainName 对应的 URL 模式）追加一个过滤器。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chainName  链名/URL 模式（如 &quot;/api/admin/**&quot;）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filterName 过滤器逻辑名（如 &quot;authc&quot;、&quot;roles&quot;、&quot;perms&quot;、自定义 &quot;deny&quot; 等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chainSpecificFilterConfig 该过滤器在此链上的专属配置（如 roles[admin,user] 中的 &quot;admin,user&quot;）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addToChain</span><span class="params">(String chainName, String filterName, String chainSpecificFilterConfig)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) 基本校验：链名不能为空</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(chainName)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;chainName cannot be null or empty.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) 按名称拿到已注册的过滤器实例（来自 Filter 池/注册表）</span></span><br><span class="line">    <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> getFilter(filterName);</span><br><span class="line">    <span class="keyword">if</span> (filter == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果拿不到，说明这个过滤器还没通过 addFilter(...) 注册到管理器</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;There is no filter with name &#x27;&quot;</span> + filterName +</span><br><span class="line">                <span class="string">&quot;&#x27; to apply to chain [&quot;</span> + chainName + <span class="string">&quot;] in the pool of available Filters.  Ensure a &quot;</span> +</span><br><span class="line">                <span class="string">&quot;filter with that name/path has first been registered with the addFilter method(s).&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) 应用“链级”配置：</span></span><br><span class="line">    <span class="comment">//    某些过滤器支持基于 URL 链的独立配置，比如：</span></span><br><span class="line">    <span class="comment">//      roles[admin,user] --&gt; 针对该链的 roles 过滤器需要 &quot;admin,user&quot;</span></span><br><span class="line">    <span class="comment">//      perms[file:edit]  --&gt; 针对该链的 perms 过滤器需要 &quot;file:edit&quot;</span></span><br><span class="line">    <span class="comment">//    通常内部会调用 PathConfigProcessor#processPathConfig(chainName, config) 之类的方法</span></span><br><span class="line">    applyChainConfig(chainName, filter, chainSpecificFilterConfig);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 确保链对象存在（没有则创建），然后把过滤器按顺序追加进去</span></span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">chain</span> <span class="operator">=</span> ensureChain(chainName);</span><br><span class="line">    chain.add(filter); <span class="comment">// 追加顺序 = 执行顺序（越早追加，越先执行）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因为过滤路径和过滤器是一对多的关系，所以 <code>ensureChain</code> 返回的 <code>NamedFilterList</code> 其实就是一个有着 <code>name</code> 属性的 <code>List&lt;Filter&gt;</code>，这个 <code>name</code> 保存的就是过滤路径，<code>List</code> 保存着我们配置的过滤器。获取到 <code>NamedFilterList</code> 后在将过滤器加入其中，这样过滤路径和过滤器映射关系就初始化好了。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleNamedFilterList</span> <span class="keyword">implements</span> <span class="title class_">NamedFilterList</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Filter&gt; backingList;</span><br><span class="line">    <span class="comment">// [...]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> NamedFilterList <span class="title function_">ensureChain</span><span class="params">(String chainName)</span> &#123;</span><br><span class="line">    <span class="type">NamedFilterList</span> <span class="variable">chain</span> <span class="operator">=</span> getChain(chainName);</span><br><span class="line">    <span class="keyword">if</span> (chain == <span class="literal">null</span>) &#123;</span><br><span class="line">        chain = <span class="keyword">new</span> <span class="title class_">SimpleNamedFilterList</span>(chainName);</span><br><span class="line">        <span class="built_in">this</span>.filterChains.put(chainName, chain);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>至此，<code>createInstance</code> 中的 <code>createFilterChainManager</code> 才算执行完成，它返回了一个 <code>FilterChainManager</code> 实例。之后再将这个 <code>FilterChainManager</code> 注入 <code>PathMatchingFilterChainResolver</code> 中，它是一个过滤器执行链解析器。</p>
<h4 id="过滤实现"><a href="#过滤实现" class="headerlink" title="过滤实现"></a>过滤实现</h4><p><code>org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver</code>中的方法不多，最为重要的是这个 <code>getChain</code> 方法。</p>
<blockquote>
<p><code>getChain</code> 方法做的事就是：<strong>按你配置的 URL 模式（保持配置顺序）找出“第一个匹配当前请求路径”的那条过滤器链，基于它创建一个“代理 FilterChain”，让这条链里的 Shiro 过滤器先执行，最后再回到容器原始链。</strong>如果<strong>一个都匹配不上</strong>，它就返回 <code>null</code>，意味着<strong>不包裹</strong>原始链（等同于这次请求不走任何 Shiro 链）。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">请求到达 Servlet 容器</span><br><span class="line">   ↓</span><br><span class="line">（容器链中的）Shiro 主过滤器（ShiroFilter / SpringShiroFilter）</span><br><span class="line">   ↓  调用 resolver.getChain(request, response, originalChain)</span><br><span class="line">[1] 取到 FilterChainManager（它掌握了“URL → 过滤器链”的映射）</span><br><span class="line">[2] 如果一个链都没配置（hasChains=false），直接返回 null</span><br><span class="line">[3] 取当前请求在应用内的路径（去掉 contextPath），如 &quot;/api/user/1&quot;</span><br><span class="line">[4] 依配置顺序遍历每个“路径模式”（如 &quot;/static/**&quot;、&quot;/api/**&quot;、&quot;/**&quot;）</span><br><span class="line">      ├─ 先用原路径匹配</span><br><span class="line">      ├─ 不匹配再尝试“去掉末尾 /”的两边重试（解决 &quot;/docs&quot; vs &quot;/docs/&quot;）</span><br><span class="line">      └─ 一旦匹配：</span><br><span class="line">           → 调用 manager.proxy(originalChain, 该路径模式)</span><br><span class="line">           → 返回一个“代理 FilterChain”（先跑 Shiro 链，再跑原生链）</span><br><span class="line">[5] 全部不匹配 → 返回 null</span><br><span class="line">   ↓</span><br><span class="line">主过滤器拿到返回值：</span><br><span class="line">   ├─ 若是代理链：执行“Shiro 过滤器链 → 原生链”</span><br><span class="line">   └─ 若是 null：直接走原生链（这次请求不走任何 Shiro 过滤器）</span><br></pre></td></tr></table></figure></div>

<p><strong>要点</strong></p>
<ul>
<li><strong>“第一个匹配生效”</strong>：配置顺序很重要，因为底层用的是 <code>LinkedHashMap</code> 保存链定义。</li>
<li>模式匹配默认是 <strong>Ant 风格</strong>：<code>?</code> 匹配单字符、<code>*</code> 匹配一段、<code>**</code> 跨多段路径。</li>
<li>末尾斜杠的<strong>双重尝试</strong>：既用原样路径比一次，也在<strong>去掉路径末尾 <code>/</code></strong> 后再比一次，尽量兼容 <code>/x</code> 和 <code>/x/</code>。</li>
</ul>
</blockquote>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据请求的 URI 获取对应的过滤链。</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;该方法的作用是匹配请求 URI 与配置的 URL 路径模式（如 `/api/**`）并返回合适的过滤链。</span></span><br><span class="line"><span class="comment"> * 它会首先检查路径模式是否匹配，如果匹配则返回对应的过滤链。</span></span><br><span class="line"><span class="comment"> * 如果没有找到匹配的路径模式，则返回 null。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request      当前请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response     当前响应</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> originalChain 原始过滤链（会根据需要被代理）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回匹配的过滤链，或如果没有匹配的链则返回 null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> FilterChain <span class="title function_">getChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain originalChain)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前 FilterChainManager（用于管理所有的过滤器链）</span></span><br><span class="line">    <span class="type">FilterChainManager</span> <span class="variable">filterChainManager</span> <span class="operator">=</span> getFilterChainManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有配置任何过滤链，直接返回 null</span></span><br><span class="line">    <span class="keyword">if</span> (!filterChainManager.hasChains()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取当前请求的 URI</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> getPathWithinApplication(request);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 去掉路径结尾的斜杠（/）</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">requestURINoTrailingSlash</span> <span class="operator">=</span> removeTrailingSlash(requestURI);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里的 &#x27;chain names&#x27; 实际上是用户配置的路径模式（例如：/api/**）。我们利用这些路径模式来寻找对应的过滤链</span></span><br><span class="line">    <span class="keyword">for</span> (String pathPattern : filterChainManager.getChainNames()) &#123;</span><br><span class="line">        <span class="comment">// 如果请求的 URI 与某个路径模式匹配，则获取对应的过滤链</span></span><br><span class="line">        <span class="keyword">if</span> (pathMatches(pathPattern, requestURI)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                log.trace(<span class="string">&quot;路径模式 [&#123;&#125;] 与请求 URI [&#123;&#125;] 匹配，使用对应的过滤链...&quot;</span>, pathPattern, Encode.forHtml(requestURI));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 返回一个代理的过滤链，代理会用当前匹配到的路径模式来包装原始的过滤链</span></span><br><span class="line">            <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果路径模式没有匹配，尝试去掉路径末尾的斜杠再匹配一次</span></span><br><span class="line">            <span class="comment">// 这个逻辑处理了 URL 中带有和不带斜杠的路径匹配问题</span></span><br><span class="line">            pathPattern = removeTrailingSlash(pathPattern);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 再次检查去掉斜杠后的路径是否匹配</span></span><br><span class="line">            <span class="keyword">if</span> (pathMatches(pathPattern, requestURINoTrailingSlash)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">                    log.trace(<span class="string">&quot;路径模式 [&#123;&#125;] 与请求 URI [&#123;&#125;] 匹配，使用对应的过滤链...&quot;</span>, pathPattern, Encode.forHtml(requestURINoTrailingSlash));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 同样返回一个代理的过滤链</span></span><br><span class="line">                <span class="keyword">return</span> filterChainManager.proxy(originalChain, pathPattern);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有找到匹配的路径模式，返回 null</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>ServletRequest/ServletResponse</code> 这俩形参就是<strong>这次请求的对象</strong>，Shiro 需要从中取出“应用内路径”（例如把 <code>/app/admin/u</code> 变成 <code>/admin/u</code>）去做匹配。</p>
<p>这一步发生在 <strong>Shiro 的主过滤器内部</strong>，不是 Tomcat 直接调用 <code>getChain</code>。准确说：<strong>Tomcat → 你的过滤器列表 →（到 Shiro 主过滤器）→ Shiro 内部再调用 <code>getChain</code> 来决定走哪条链</strong>。</p>
<p><code>filterChainManager.getChainNames()</code> 返回的是你配置的 <strong>URL 模式列表</strong>（比如 <code>/admin/**</code>、<code>/api/**</code>、<code>/**</code>）。这些规则在内部用 <strong><code>LinkedHashMap</code></strong> 存着，因此<strong>遍历顺序 &#x3D; 你的定义顺序</strong>。<strong>先匹配到谁就用谁（FIRST MATCH WINS）</strong>。</p>
<p>👉 所以如果你把 <code>/**</code> 写在最上面，它会<strong>截胡所有请求</strong>，后面的规则永远匹配不到。</p>
<p>这个 <code>getChain</code> 是一个请求到达 Tomcat 时，Tomcat 以责任链的形式调用了一系列 <code>Filter</code>，<code>OncePerRequestFilter</code> 就是众多 <code>Filter</code> 中的一个。它所实现的 <code>doFilter</code> 方法调用了自身的抽象方法 <code>doFilterInternal</code>，这个方法在它的子类 <code>AbstractShiroFilter</code> 中被实现了。</p>
<p><code>AbstractShiroFilter</code> 继承了 <strong>Shiro 自己的</strong> <code>OncePerRequestFilter</code>（注意：不是 Spring 的那个重名类），它保证一次请求只执行一次主逻辑。<code>doFilter</code> 里会调它的 <code>doFilterInternal</code>，而 <code>doFilterInternal</code> 再去问 <code>getChain</code> 要不要包一条 Shiro 代理链。</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tomcat 调用过滤器链</span><br><span class="line">   └─ ...（其他 Filter）</span><br><span class="line">   └─ DelegatingFilterProxy(&quot;shiroFilter&quot;)</span><br><span class="line">       └─ SpringShiroFilter (AbstractShiroFilter)</span><br><span class="line">           └─ 调用 resolver.getChain(request, response, originalChain)</span><br><span class="line">               ├─ 命中某个 URL 规则 → 返回“代理链”（先跑该规则绑定的 Shiro 过滤器们，再回到原始链）</span><br><span class="line">               └─ 未命中 → 返回 null（本次不跑 Shiro 过滤器，直接走原始链）</span><br></pre></td></tr></table></figure></div>

<p>整个调用栈如下：</p>
<div class="code-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">at org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver.getChain(PathMatchingFilterChainResolver.java:98)</span><br><span class="line">at org.apache.shiro.web.servlet.AbstractShiroFilter.getExecutionChain(AbstractShiroFilter.java:424)</span><br><span class="line">at org.apache.shiro.web.servlet.AbstractShiroFilter.executeChain(AbstractShiroFilter.java:457)</span><br><span class="line">at org.apache.shiro.web.servlet.AbstractShiroFilter$1.call(AbstractShiroFilter.java:373)</span><br><span class="line">at org.apache.shiro.subject.support.SubjectCallable.doCall(SubjectCallable.java:90)</span><br><span class="line">at org.apache.shiro.subject.support.SubjectCallable.call(SubjectCallable.java:83)</span><br><span class="line">at org.apache.shiro.subject.support.DelegatingSubject.execute(DelegatingSubject.java:387)</span><br><span class="line">at org.apache.shiro.web.servlet.AbstractShiroFilter.doFilterInternal(AbstractShiroFilter.java:370)</span><br><span class="line">at org.apache.shiro.web.servlet.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:154)</span><br><span class="line">at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:354)</span><br><span class="line">at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:267)</span><br><span class="line">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:178)</span><br></pre></td></tr></table></figure></div>

<p><code>PathMatchingFilterChainResolver#getChain</code> 就是被在 <code>doFilterInternal</code> 中被一步步调用的调用的。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * doFilterInternal：为一次经过 Shiro 的请求完成“准备 → 执行 → 清理”的完整流程。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 执行顺序：</span></span><br><span class="line"><span class="comment"> * 1) prepareServletRequest(...)：准备本次要交给 Shiro 处理的请求对象（可能包装/设置属性）</span></span><br><span class="line"><span class="comment"> * 2) prepareServletResponse(...)：准备响应对象（可能包装/设置属性）</span></span><br><span class="line"><span class="comment"> * 3) createSubject(...)：基于请求/响应创建 Subject（含会话/登录身份/权限等上下文）</span></span><br><span class="line"><span class="comment"> * 4) 使用 Subject.execute(Runnable/Callable) 在“已绑定 Subject 的线程上下文”中执行：</span></span><br><span class="line"><span class="comment"> *    - updateSessionLastAccessTime(...)：更新会话最后访问时间（影响会话超时）</span></span><br><span class="line"><span class="comment"> *    - executeChain(...)：执行匹配到的 Shiro 过滤器链（跑完再回到容器原始链）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 之所以用 Subject.execute(...)（第 4 步），是为了保证在当前线程内正确完成</span></span><br><span class="line"><span class="comment"> * Subject 的绑定与恢复（ThreadLocal 语义），从而确保例如 SecurityUtils.getSubject()</span></span><br><span class="line"><span class="comment"> * 能拿到同一个 Subject，并在执行结束后正确清理线程状态。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> servletRequest  进入过滤器的请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> servletResponse 进入过滤器的响应</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> chain           容器提供的原始 FilterChain</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException         I/O 错误</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ServletException    其他非 I/O 异常（会被统一包装为 ServletException 抛出）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(ServletRequest servletRequest,</span></span><br><span class="line"><span class="params">                                ServletResponse servletResponse,</span></span><br><span class="line"><span class="params">                                <span class="keyword">final</span> FilterChain chain)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>; <span class="comment">// 用于在统一出口处按规范抛出异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1) 准备/包装请求与响应，使其符合 Shiro 的处理预期</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> prepareServletRequest(servletRequest, servletResponse, chain);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> prepareServletResponse(request, servletResponse, chain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) 基于本次请求/响应创建 Subject，并与当前线程绑定</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> createSubject(request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) 在 Subject 上下文中执行业务逻辑，保证线程绑定/恢复正确</span></span><br><span class="line">        <span class="comment">//noinspection unchecked</span></span><br><span class="line">        subject.execute(<span class="keyword">new</span> <span class="title class_">Callable</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 3.1 刷新会话的最后访问时间（用于会话超时控制）</span></span><br><span class="line">                updateSessionLastAccessTime(request, response);</span><br><span class="line">                <span class="comment">// 3.2 执行匹配到的 Shiro 过滤器链，跑完后回到原始容器链</span></span><br><span class="line">                executeChain(request, response, chain);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException ex) &#123;</span><br><span class="line">        <span class="comment">// Subject.execute(...) 可能把真实异常包成 ExecutionException，这里取根因</span></span><br><span class="line">        t = ex.getCause();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        <span class="comment">// 兜底：捕获其他未声明异常</span></span><br><span class="line">        t = throwable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) 统一异常处理：尽量还原为容器期望的两类，否则包装为 ServletException</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ServletException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (ServletException) t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (IOException) t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Filtered request failed.&quot;</span>, t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里 <code>executeChain</code> 先调用 <code>getExecutionChain</code> 获取过滤器，然后调用过滤器的 <code>doFilter</code> 方法。</p>
<p><code>getExecutionChain</code> 通过 <code>getFilterChainResolver</code> 方法就拿到了前面提到的过滤器执行链解析器 <code>PathMatchingFilterChainResolver</code>，然后再调用它的 <code>getChain</code> 匹配获取过滤器，最终过滤器在 <code>executeChain</code> 中被执行。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行本次请求所需的过滤器链。</span></span><br><span class="line"><span class="comment"> * 1) 先用 getExecutionChain(...) 计算“应该执行哪条链”（可能是原始容器链，也可能是 Shiro 代理链）</span></span><br><span class="line"><span class="comment"> * 2) 然后调用 chain.doFilter(request, response) 真正开始执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// 计算出要执行的“最终链”</span></span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> getExecutionChain(request, response, origChain);</span><br><span class="line">    <span class="comment">// 执行（如果是代理链，会先跑 Shiro 的过滤器，再回到原始容器链）</span></span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算“最终要执行的过滤器链”：</span></span><br><span class="line"><span class="comment"> * - 如果没有配置 FilterChainResolver，直接返回容器给的原始链（等于不走 Shiro）</span></span><br><span class="line"><span class="comment"> * - 如果有 resolver，就让它根据本次请求路径匹配一条链：</span></span><br><span class="line"><span class="comment"> *   * 命中：返回一个“代理链”（把本 URL 对应的 Shiro 过滤器们挂到前面）</span></span><br><span class="line"><span class="comment"> *   * 未命中：仍然使用原始链</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> FilterChain <span class="title function_">getExecutionChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">chain</span> <span class="operator">=</span> origChain;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析器：负责“根据请求路径找链”</span></span><br><span class="line">    <span class="type">FilterChainResolver</span> <span class="variable">resolver</span> <span class="operator">=</span> getFilterChainResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;未配置 FilterChainResolver，直接使用原始 FilterChain。&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> origChain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 尝试解析出一条“为当前请求配置好的链”（通常是 ProxiedFilterChain）</span></span><br><span class="line">    <span class="type">FilterChain</span> <span class="variable">resolved</span> <span class="operator">=</span> resolver.getChain(request, response, origChain);</span><br><span class="line">    <span class="keyword">if</span> (resolved != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;已为当前请求解析到配置的 FilterChain（使用代理链）。&quot;</span>);</span><br><span class="line">        chain = resolved; <span class="comment">// 用代理链替换原始链</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;当前请求未匹配到任何配置的 FilterChain，继续使用原始链。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里用枚举列出了所有 Shiro 内置过滤器的实例。</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DefaultFilter</span> &#123;</span><br><span class="line">    anon(AnonymousFilter.class),</span><br><span class="line">    authc(FormAuthenticationFilter.class),</span><br><span class="line">    authcBasic(BasicHttpAuthenticationFilter.class),</span><br><span class="line">    authcBearer(BearerHttpAuthenticationFilter.class),</span><br><span class="line">    logout(LogoutFilter.class),</span><br><span class="line">    noSessionCreation(NoSessionCreationFilter.class),</span><br><span class="line">    perms(PermissionsAuthorizationFilter.class),</span><br><span class="line">    port(PortFilter.class),</span><br><span class="line">    rest(HttpMethodPermissionFilter.class),</span><br><span class="line">    roles(RolesAuthorizationFilter.class),</span><br><span class="line">    ssl(SslFilter.class),</span><br><span class="line">    user(UserFilter.class),</span><br><span class="line">    invalidRequest(InvalidRequestFilter.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<table>
<thead>
<tr>
<th>Filter 名称</th>
<th>对应类</th>
</tr>
</thead>
<tbody><tr>
<td>anon</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/AnonymousFilter.html" >org.apache.shiro.web.filter.authc.AnonymousFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>authc</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html" >org.apache.shiro.web.filter.authc.FormAuthenticationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>authcBasic</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BasicHttpAuthenticationFilter.html" >org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>authcBearer</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/BearerHttpAuthenticationFilter.html" >org.apache.shiro.web.filter.authc.BearerHttpAuthenticationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>invalidRequest</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html" >org.apache.shiro.web.filter.InvalidRequestFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>logout</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/LogoutFilter.html" >org.apache.shiro.web.filter.authc.LogoutFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>noSessionCreation</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/session/NoSessionCreationFilter.html" >org.apache.shiro.web.filter.session.NoSessionCreationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>perms</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PermissionsAuthorizationFilter.html" >org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>port</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/PortFilter.html" >org.apache.shiro.web.filter.authz.PortFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>rest</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/HttpMethodPermissionFilter.html" >org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>roles</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/RolesAuthorizationFilter.html" >org.apache.shiro.web.filter.authz.RolesAuthorizationFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>ssl</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authz/SslFilter.html" >org.apache.shiro.web.filter.authz.SslFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
<tr>
<td>user</td>
<td><a class="link"   target="_blank" rel="noopener" href="https://shiro.apache.org/static/current/apidocs/org/apache/shiro/web/filter/authc/UserFilter.html" >org.apache.shiro.web.filter.authc.UserFilter<i class="fa-solid fa-arrow-up-right ml-[0.2em] font-light align-text-top text-[0.7em] link-icon"></i></a></td>
</tr>
</tbody></table>
<ul>
<li><strong>anon</strong>（<code>AnonymousFilter</code>）：直接放行，不做任何安全检查；常用于静态资源、公开页。写法：<code>/public/** = anon</code>。</li>
<li><strong>authc</strong>（<code>FormAuthenticationFilter</code>）：要求用户已登录，否则按 <code>loginUrl</code> 走表单登录流程（默认参数名 <code>username</code>&#x2F;<code>password</code>&#x2F;<code>rememberMe</code> 可改）。写法：<code>/account/** = authc</code>。</li>
<li><strong>authcBasic</strong>（<code>BasicHttpAuthenticationFilter</code>）：HTTP Basic 认证，用于接口&#x2F;工具；会返回 401 并带 <code>WWW-Authenticate</code>。务必配合 HTTPS。写法：<code>/api/** = authcBasic</code>。</li>
<li><strong>authcBearer</strong>（<code>BearerHttpAuthenticationFilter</code>）：HTTP Bearer 令牌（<code>Authorization: Bearer ...</code>），更适合无状态 API；自 Shiro <strong>1.5</strong> 起提供。写法：<code>/api/** = noSessionCreation, authcBearer</code>。</li>
<li><strong>invalidRequest</strong>（<code>InvalidRequestFilter</code>）：拦截“可疑”URL（分号、反斜杠、非 ASCII 等）；<strong>自 1.6 起默认作为全局过滤器</strong>，会套到所有路径。若中文&#x2F;分号被 400 拦截，可按需调 <code>blockNonAscii/blockSemicolon</code>。</li>
<li><strong>logout</strong>（<code>LogoutFilter</code>）：执行 <code>Subject.logout()</code> 并重定向到配置的 <code>redirectUrl</code>；浏览器预取下建议用 <strong>POST</strong> 触发。写法：<code>/logout = logout</code>。</li>
<li><strong>noSessionCreation</strong>（<code>NoSessionCreationFilter</code>）：禁止在该请求中<strong>创建新会话</strong>（适合真正的无状态 API）；要放在链前面。</li>
<li><strong>perms</strong>（<code>PermissionsAuthorizationFilter</code>）：要求拥有<strong>给定全部权限</strong>；写法：<code>/doc/** = perms[doc:read]</code>。</li>
<li><strong>roles</strong>（<code>RolesAuthorizationFilter</code>）：要求拥有<strong>给定全部角色</strong>；写法：<code>/admin/** = roles[admin,ops]</code>（AND 语义）。</li>
<li><strong>rest</strong>（<code>HttpMethodPermissionFilter</code>）：把 HTTP 方法映射成动词并拼成权限名（如 GET→read、POST→create）；写法：<code>/users/** = rest[user]</code>。</li>
<li><strong>port</strong>（<code>PortFilter</code>）：要求特定端口，不符则重定向到该端口。写法：<code>/secure/** = port[8443]</code>。</li>
<li><strong>ssl</strong>（<code>SslFilter</code>）：要求 HTTPS（<code>isSecure()</code> 且端口匹配），并支持开启 <strong>HSTS</strong>。写法：<code>/secure/** = ssl</code>。</li>
<li><strong>user</strong>（<code>UserFilter</code>）：“已知身份”即可放行（登录中或 <strong>rememberMe</strong> 恢复的主体都算），比 <code>authc</code> <strong>宽</strong>。写法：<code>/profile/** = user</code>。</li>
</ul>
<h2 id="CVE-2010-3863"><a href="#CVE-2010-3863" class="headerlink" title="CVE-2010-3863"></a>CVE-2010-3863</h2><h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><ul>
<li><strong>影响</strong>：Shiro &lt; 1.1.0（JSecurity 0.9.x 也受影响）。</li>
<li><strong>根因</strong>：<strong>在与 <code>shiro.ini</code> 的规则比对前未做路径</strong>规范化，攻击者可用如 <code>/./account/index.jsp</code> 这类“非规范”路径逃逸规则。</li>
</ul>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>还是以前面 Spring 的示例项目为例：</p>
<div class="code-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;shiroFilter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">shiroFilterFactoryBean</span><span class="params">(SecurityManager securityManager, DenyFilter deny)</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    bean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register custom filters</span></span><br><span class="line">    Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    filters.put(<span class="string">&quot;deny&quot;</span>, deny);</span><br><span class="line">    bean.setFilters(filters);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// URL chain — edit to test patterns and order</span></span><br><span class="line">    Map&lt;String, String&gt; chain = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    chain.put(<span class="string">&quot;/open/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);    <span class="comment">// allow</span></span><br><span class="line">    chain.put(<span class="string">&quot;/secure/**&quot;</span>, <span class="string">&quot;deny&quot;</span>);  <span class="comment">// always block (401)</span></span><br><span class="line">    chain.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);         <span class="comment">// fallback allow</span></span><br><span class="line">    bean.setFilterChainDefinitionMap(chain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="Shiro-处理部分"><a href="#Shiro-处理部分" class="headerlink" title="Shiro 处理部分"></a>Shiro 处理部分</h4><h4 id="Tomcat-处理部分"><a href="#Tomcat-处理部分" class="headerlink" title="Tomcat 处理部分"></a>Tomcat 处理部分</h4><h2 id="CVE-2016-6802"><a href="#CVE-2016-6802" class="headerlink" title="CVE-2016-6802"></a>CVE-2016-6802</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.3.2。</li>
<li><strong>场景</strong>：Web 应用部署在<strong>非根上下文</strong>（<code>/app</code>）时，Shiro 的路径解析与 Servlet 容器存在偏差，导致<strong>绕过预期 Filter</strong>。</li>
</ul>
<h2 id="CVE-2020-1957"><a href="#CVE-2020-1957" class="headerlink" title="CVE-2020-1957"></a>CVE-2020-1957</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.5.2。</li>
<li><strong>场景</strong>：Shiro 的<strong>路径匹配</strong>与 Spring 的<strong>动态控制器路由</strong>在<strong>编码&#x2F;规范化</strong>环节（以及包含&#x2F;转发）上存在差异，特制请求可<strong>绕过认证</strong>。</li>
</ul>
<h2 id="CVE-2020-11989"><a href="#CVE-2020-11989" class="headerlink" title="CVE-2020-11989"></a>CVE-2020-11989</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.5.3。</li>
<li><strong>说明</strong>：同 CVE-2020-1957 场景的进一步修复，仍与 Spring 动态控制器的路径匹配&#x2F;规范化差异相关。</li>
</ul>
<h2 id="CVE-2020-13933"><a href="#CVE-2020-13933" class="headerlink" title="CVE-2020-13933"></a>CVE-2020-13933</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.6.0。</li>
<li><strong>说明</strong>：利用<strong>分号</strong>（<code>；</code> 矩阵参数）或畸形路径导致的匹配差异，使 Shiro 的链路选择与实际路由不一致。</li>
</ul>
<h2 id="CVE-2020-17510"><a href="#CVE-2020-17510" class="headerlink" title="CVE-2020-17510"></a>CVE-2020-17510</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.7.0（Shiro 1.7.0 同时“默认禁用会话路径重写”，并增加了反斜杠规范化的系统属性）。</li>
</ul>
<h2 id="CVE-2020-17523"><a href="#CVE-2020-17523" class="headerlink" title="CVE-2020-17523"></a>CVE-2020-17523</h2><p><strong>影响</strong>：Shiro &lt; 1.7.1。</p>
<h2 id="CVE-2021-41303"><a href="#CVE-2021-41303" class="headerlink" title="CVE-2021-41303"></a>CVE-2021-41303</h2><p><strong>影响</strong>：Shiro &lt; 1.8.0，Spring Boot 场景特制请求可绕过认证。</p>
<p><strong>根因</strong>：Spring Boot 与 Shiro 对 URL <strong>解析&#x2F;匹配方式</strong>不同，特制请求可能穿透 Shiro 的保护。</p>
<h2 id="CVE-2022-32532"><a href="#CVE-2022-32532" class="headerlink" title="CVE-2022-32532"></a>CVE-2022-32532</h2><ul>
<li><strong>影响</strong>：Shiro &lt; 1.9.1。</li>
<li><strong>根因</strong>：当使用 <code>RegExPatternMatcher</code>，且正则包含点号 <code>.</code>，在<strong>某些 Servlet 容器</strong>上可能被绕过（容器对路径&#x2F;点号的处理差异叠加误配置）。</li>
</ul>
<h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><p>[4]: </p>

		</div>

		
		<div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
			<div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Java Shiro</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2025-11-13 00:34:50</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2025-11-10 01:28:46
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2025/11/13/Java Shiro/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

		</div>
		

		
		<ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
			
			<li class="tag-item mx-0.5">
				<a href="/tags/java-web/">#java web</a>&nbsp;
			</li>
			
		</ul>
		

		

		
		<div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
			
			
			<div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
				<a class="next" rel="next" href="/2025/10/30/qemu%20%E9%80%83%E9%80%B8/">
					<span class="title flex justify-center items-center">
						<span class="post-nav-title-item truncate max-w-48">qemu 逃逸</span>
						<span class="post-nav-item">Next posts</span>
					</span>
					<span class="right arrow-icon flex justify-center items-center">
						<i class="fa-solid fa-chevron-right"></i>
					</span>
				</a>
			</div>
			
		</div>
		


		
		<div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
			<div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

		</div>
		
	</div>

	
	<div class="toc-content-container">
		<div class="post-toc-wrap">
	<div class="post-toc">
		<div class="toc-title">On this page</div>
		<div class="page-title">Java Shiro</div>
		<ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro-%E5%85%B3%E9%94%AE%E7%BB%84%E4%BB%B6"><span class="nav-text">Shiro 关键组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Subject"><span class="nav-text">Subject</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SecurityManager%EF%BC%88%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%89"><span class="nav-text">SecurityManager（安全管理器）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Authenticator%EF%BC%88%E8%AE%A4%E8%AF%81%E5%99%A8%EF%BC%89"><span class="nav-text">Authenticator（认证器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Authorizer%EF%BC%88%E6%8E%88%E6%9D%83%E5%99%A8%EF%BC%89"><span class="nav-text">Authorizer（授权器）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Realm%EF%BC%88%E6%95%B0%E6%8D%AE%E6%BA%90-%E8%AE%A4%E8%AF%81-%E6%8E%88%E6%9D%83%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="nav-text">Realm（数据源 + 认证&#x2F;授权实现）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SessionManager-SessionDAO"><span class="nav-text">SessionManager &#x2F; SessionDAO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CacheManager%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89"><span class="nav-text">CacheManager（缓存）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cryptography%EF%BC%88%E5%AF%86%E7%A0%81%E5%AD%A6%E5%B7%A5%E5%85%B7%EF%BC%89"><span class="nav-text">Cryptography（密码学工具）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-text">基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8E-Realm"><span class="nav-text">数据源与 Realm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%9C%E6%95%B0%E6%8D%AE%E6%BA%90%E2%80%9D%E4%B8%8E%E5%AE%9E%E4%BD%93"><span class="nav-text">“数据源”与实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Realm"><span class="nav-text">自定义 Realm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Realm-%E4%BD%BF%E7%94%A8"><span class="nav-text">Realm 使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="nav-text">身份认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89-Realm"><span class="nav-text">使用自定义 Realm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%86%85%E7%BD%AE-Realm"><span class="nav-text">使用内置 Realm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">认证过程分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F%E5%BC%8F%E6%8E%88%E6%9D%83%EF%BC%88API-%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-text">程序式授权（API 方式）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E8%A7%A3%E5%BC%8F%E6%8E%88%E6%9D%83%EF%BC%88%E6%96%B9%E6%B3%95-%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%8A%EF%BC%89"><span class="nav-text">注解式授权（方法&#x2F;控制器上）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URL-%E7%BA%A7%E6%8B%A6%E6%88%AA%EF%BC%88Filter-Chain%EF%BC%89"><span class="nav-text">URL 级拦截（Filter Chain）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-ini-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-text">shiro.ini 配置示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Spring-Boot-%E4%B8%8B%E7%9A%84%E9%85%8D%E7%BD%AE"><span class="nav-text">Spring Boot 下的配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E5%88%B0-Java-Web-%E9%A1%B9%E7%9B%AE"><span class="nav-text">集成到 Java Web 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E5%88%B0-Servlet-%E5%AE%B9%E5%99%A8"><span class="nav-text">集成到 Servlet 容器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#web-xml-%E6%8E%A5%E5%85%A5"><span class="nav-text">web.xml 接入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shiro-ini-%E9%85%8D%E7%BD%AE"><span class="nav-text">shiro.ini 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Servlet-%E4%B8%AD%E4%BD%BF%E7%94%A8-Subject"><span class="nav-text">Servlet 中使用 Subject</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E6%88%90%E5%88%B0-Spring-%E9%A1%B9%E7%9B%AE"><span class="nav-text">集成到 Spring 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pom"><span class="nav-text">pom</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JavaConfig"><span class="nav-text">JavaConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filter"><span class="nav-text">Filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Controller"><span class="nav-text">Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Application"><span class="nav-text">Application</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="nav-text">控制器中使用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro-%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87"><span class="nav-text">Shiro 权限绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Servlet-%E8%B7%AF%E5%BE%84%E8%A7%84%E8%8C%83"><span class="nav-text">Servlet 路径规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat-%E7%9A%84%E8%B7%AF%E5%BE%84%E5%A4%84%E7%90%86"><span class="nav-text">Tomcat 的路径处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90%E8%B7%AF%E5%BE%84%E5%8F%82%E6%95%B0"><span class="nav-text">解析路径参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URI-%E8%A7%A3%E7%A0%81"><span class="nav-text">URI 解码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E8%8C%83%E5%8C%96"><span class="nav-text">规范化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E8%BD%AC%E6%8D%A2"><span class="nav-text">字符转换</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%84%E8%8C%83%E5%8C%96%E6%A3%80%E6%9F%A5"><span class="nav-text">规范化检查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84"><span class="nav-text">请求映射</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#map"><span class="nav-text">map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#internalMap"><span class="nav-text">internalMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#internalMapWrapper"><span class="nav-text">internalMapWrapper</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shiro-%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-text">Shiro 解析流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="nav-text">初始化流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%AE%9E%E7%8E%B0"><span class="nav-text">过滤实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2010-3863"><span class="nav-text">CVE-2010-3863</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shiro-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="nav-text">Shiro 处理部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tomcat-%E5%A4%84%E7%90%86%E9%83%A8%E5%88%86"><span class="nav-text">Tomcat 处理部分</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2016-6802"><span class="nav-text">CVE-2016-6802</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-1957"><span class="nav-text">CVE-2020-1957</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-11989"><span class="nav-text">CVE-2020-11989</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-13933"><span class="nav-text">CVE-2020-13933</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-17510"><span class="nav-text">CVE-2020-17510</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-17523"><span class="nav-text">CVE-2020-17523</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2021-41303"><span class="nav-text">CVE-2021-41303</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2022-32532"><span class="nav-text">CVE-2022-32532</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">反序列化</span></a></li></ol>

	</div>
</div>
	</div>
	
</div>
			</div>

			
		</div>

		<div class="main-content-footer">
			<footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2025&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        57 posts in total
                    </span>
                    
                        <span>
                            1173.9k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.8.5</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
		</div>
	</div>

	
	<div class="post-tools">
		<div class="post-tools-container">
	<ul class="article-tools-list">
		<!-- TOC aside toggle -->
		
		<li class="right-bottom-tools page-aside-toggle">
			<i class="fa-regular fa-outdent"></i>
		</li>
		

		<!-- go comment -->
		
		<li class="go-comment">
			<i class="fa-regular fa-comments"></i>
		</li>
		
	</ul>
</div>
	</div>
	

	<div class="right-side-tools-container">
		<div class="side-tools-container">
	<ul class="hidden-tools-list">
		<li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-plus"></i>
		</li>

		<li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
			<i class="fa-regular fa-magnifying-glass-minus"></i>
		</li>

		<li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
			<i class="fa-regular fa-moon"></i>
		</li>

		<!-- rss -->
		

		

		<li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
			<i class="fa-regular fa-arrow-down"></i>
		</li>
	</ul>

	<ul class="visible-tools-list">
		<li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
			<i class="fa-regular fa-cog fa-spin"></i>
		</li>
		
		<li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
			<i class="arrow-up fas fa-arrow-up"></i>
			<span class="percent"></span>
		</li>
		
		
	</ul>
</div>
	</div>

	<div class="image-viewer-container">
	<img src="">
</div>

	
	<div class="search-pop-overlay">
	<div class="popup search-popup">
		<div class="search-header">
			<span class="search-input-field-pre">
				<i class="fa-solid fa-keyboard"></i>
			</span>
			<div class="search-input-container">
				<input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
			</div>
			<span class="popup-btn-close">
				<i class="fa-solid fa-times"></i>
			</span>
		</div>
		<div id="search-result">
			<div id="no-result">
				<i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
			</div>
		</div>
	</div>
</div>
	

</main>



<script src="/js/build/libs/Swup.min.js"></script>

<script src="/js/build/libs/SwupSlideTheme.min.js"></script>

<script src="/js/build/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/build/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/build/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/build/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>




	
<script src="/js/build/tools/imageViewer.js" type="module"></script>

<script src="/js/build/utils.js" type="module"></script>

<script src="/js/build/main.js" type="module"></script>

<script src="/js/build/layouts/navbarShrink.js" type="module"></script>

<script src="/js/build/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/build/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/build/layouts/categoryList.js" type="module"></script>



    
<script src="/js/build/tools/localSearch.js" type="module"></script>




    
<script src="/js/build/tools/codeBlock.js" type="module"></script>




    
<script src="/js/build/layouts/lazyload.js" type="module"></script>




    
<script src="/js/build/tools/runtime.js"></script>

    
<script src="/js/build/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/build/libs/Typed.min.js"></script>

  
<script src="/js/build/plugins/typed.js" type="module"></script>




    
        
<script src="/js/build/libs/mermaid.min.js"></script>

    
    
<script src="/js/build/plugins/mermaid.js"></script>






    
<script src="/js/build/libs/anime.min.js"></script>





    
<script src="/js/build/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/build/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/build/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/build/layouts/essays.js" type="module" data-swup-reload-script=""></script>





    
<script src="/js/build/layouts/bookmarkNav.js" type="module"></script>


	
</body>

</html>